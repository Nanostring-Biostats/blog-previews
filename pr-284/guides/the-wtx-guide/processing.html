<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Evelyn Metzger">

<title>4&nbsp; Normalization, Reduction, and Clustering – A Guide to Whole Transcriptome CosMx&lt;sup&gt;®&lt;/sup&gt; SMI Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./spatial-domains.html" rel="next">
<link href="./quality-processing.html" rel="prev">
<link href="./assets/rocket.svg" rel="icon" type="image/svg+xml">
<script src="site_libs/cookie-consent/cookie-consent.js"></script>
<link href="site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-707d8167ce6003fca903bfe2be84ab7f.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-00066ec49057a78057bb708cd7ecd022.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-cb8585788486bab3a0512e4422583b7d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-00066ec49057a78057bb708cd7ecd022.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/live-runtime/live-runtime.js" type="module"></script>
<link href="site_libs/quarto-contrib/live-runtime/live-runtime.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-29W4MW0Y2W"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-29W4MW0Y2W', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<script type="module" src="site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">


</head>

<body class="nav-sidebar floating nav-fixed slimcontent quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">A Guide to Whole Transcriptome CosMx<sup>®</sup> SMI Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./../../index.html"> <i class="bi bi-house-door" role="img" aria-label="Back to main website">
</i> 
<span class="menu-text">Back to Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./quality-processing.html">Processing Data</a></li><li class="breadcrumb-item"><a href="./processing.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Normalization, Reduction, and Clustering</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./quality-processing.html">Processing Data</a></li><li class="breadcrumb-item"><a href="./processing.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Normalization, Reduction, and Clustering</span></a></li></ol></nav>
      <div class="quarto-title-block"><div><h1 class="title"><span id="sec-preprocessing" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Normalization, Reduction, and Clustering</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
            <p class="subtitle lead">Pre-processing – From Counts to Clusters</p>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliations</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Evelyn Metzger <a href="https://orcid.org/0000-0002-4074-9003" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Bruker Spatial Biology
            </p>
          <p class="affiliation">
              Github: <a href="https://github.com/eveilyeverafter" target="_blank">eveilyeverafter</a>
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./how-to-use.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to Use This Book</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link"><i class="bi bi-rocket-takeoff-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-ingestion.html" class="sidebar-item-text sidebar-link"><i class="bi bi-hdd-network-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Wrangling</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Processing Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quality-processing.html" class="sidebar-item-text sidebar-link"><i class="bi bi-clipboard2-data-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Quality Processing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./processing.html" class="sidebar-item-text sidebar-link active"><i class="bi bi-rulers" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Normalization, Reduction, and Clustering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spatial-domains.html" class="sidebar-item-text sidebar-link"><i class="bi bi-diagram-3-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Domains</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cell-typing.html" class="sidebar-item-text sidebar-link"><i class="bi bi-layout-wtf" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Cell Typing</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Tertiary Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pathways.html" class="sidebar-item-text sidebar-link"><i class="bi bi-grid-1x2-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Pathways</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Conclusion</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conclusion.html" class="sidebar-item-text sidebar-link"><i class="bi bi-check-square-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Additonal Resources</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#two-pre-processing-workflows" id="toc-two-pre-processing-workflows" class="nav-link active" data-scroll-target="#two-pre-processing-workflows"><span class="header-section-number">4.1</span> Two pre-processing workflows</a></li>
  <li><a href="#visualizations" id="toc-visualizations" class="nav-link" data-scroll-target="#visualizations"><span class="header-section-number">4.2</span> Visualizations</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">4.4</span> Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">






<div class="cell">
<details class="code-fold">
<summary>R code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-1"><pre class="sourceCode r code-annotation-code code-with-copy"><code class="sourceCode r"><span id="annotated-cell-1-1"><a href="#annotated-cell-1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./preamble.R"</span>)</span>
<span id="annotated-cell-1-2"><a href="#annotated-cell-1-2" aria-hidden="true" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">source_python</span>(<span class="st">"./preamble.py"</span>)</span>
<span id="annotated-cell-1-3"><a href="#annotated-cell-1-3" aria-hidden="true" tabindex="-1"></a>analysis_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"analysis_results"</span>)</span>
<span id="annotated-cell-1-4"><a href="#annotated-cell-1-4" aria-hidden="true" tabindex="-1"></a>input_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"input_files"</span>)</span>
<span id="annotated-cell-1-5"><a href="#annotated-cell-1-5" aria-hidden="true" tabindex="-1"></a>output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"output_files"</span>)</span>
<span id="annotated-cell-1-6"><a href="#annotated-cell-1-6" aria-hidden="true" tabindex="-1"></a>analysis_asset_dir <span class="ot">&lt;-</span> <span class="st">"./assets/analysis_results"</span></span>
<span id="annotated-cell-1-7"><a href="#annotated-cell-1-7" aria-hidden="true" tabindex="-1"></a>qc_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="st">"qc"</span>)</span>
<span id="annotated-cell-1-8"><a href="#annotated-cell-1-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(qc_dir)){</span>
<span id="annotated-cell-1-9"><a href="#annotated-cell-1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(qc_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="annotated-cell-1-10"><a href="#annotated-cell-1-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-1-11"><a href="#annotated-cell-1-11" aria-hidden="true" tabindex="-1"></a>pp_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="st">"processing"</span>)</span>
<span id="annotated-cell-1-12"><a href="#annotated-cell-1-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(pp_dir)){</span>
<span id="annotated-cell-1-13"><a href="#annotated-cell-1-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(pp_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="annotated-cell-1-14"><a href="#annotated-cell-1-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-1-15"><a href="#annotated-cell-1-15" aria-hidden="true" tabindex="-1"></a>results_list_file <span class="ot">=</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"results_list.rds"</span>)</span>
<span id="annotated-cell-1-16"><a href="#annotated-cell-1-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(results_list_file)){</span>
<span id="annotated-cell-1-17"><a href="#annotated-cell-1-17" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="annotated-cell-1-18"><a href="#annotated-cell-1-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(results_list, results_list_file)</span>
<span id="annotated-cell-1-19"><a href="#annotated-cell-1-19" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="annotated-cell-1-20"><a href="#annotated-cell-1-20" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(results_list_file)  </span>
<span id="annotated-cell-1-21"><a href="#annotated-cell-1-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-1-22"><a href="#annotated-cell-1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./helpers.R"</span>) <span class="co"># contains the plotDots function</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Our quality control steps in <a href="quality-processing.html" class="quarto-xref"><span>Chapter 3</span></a> identified the analyzable cells, but these their raw counts need further processing to reveal biological patterns. This chapter covers the essential pre-processing steps to make the data interpretable.</p>
<p>First, normalization adjusts counts to account for technical factors like cell area (<em>i.e.</em>, larger cells typically have more counts), enabling fair comparisons between cells. Second, dimensionality reduction (using PCA and UMAP) helps reduce the total number of dimensions in the data (almost 19,000) to a manageable representation that captures key biological variation and allows visualization. Finally, clustering leverages this reduced space to group cells with similar expression profiles, which can be a foundation for downstream analyses like cell typing.</p>
<p>By the end of this chapter, we will have transformed the filtered count matrix into a clustered, low-dimensional dataset and classified cells into groups which, taken together, form our foundation for biological interpretation and spatial analysis. I often get asked “What is the best parameter combination for CosMx data?” and I hope by the end of this chapter you’re able to understand how parameter adjustments impact many of these processing steps.</p>
<p>Let’s begin by loading the data.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> ad.read_h5ad(os.path.join(r.analysis_dir, <span class="st">"anndata-1-qc-filtered.h5ad"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="two-pre-processing-workflows" class="level2 page-columns page-full" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="two-pre-processing-workflows"><span class="header-section-number">4.1</span> Two pre-processing workflows</h2>
<p>There are two different pre-processing workflows that I use. The first one is borrowed from spatially-unaware scRNA-seq. The main advantage of this approach is that it is fast, the normalization matrix can remain sparse, the values are easy to understand (<em>e.g.,</em> counts of gene X per 10,000 or some transformation of such), and often times for WTX data provides the basis for good clustering of cells in downstream UMAP. Moreover, Scanpy and Seurat each have built-in methods for these steps which make it relatively low friction. However, there are cases were this standard (“legacy”) workflow provides unexpected results. One reason is that total counts-based normalization might have unstable variance<span class="citation" data-cites="Hafemeister2019"><sup><a href="references.html#ref-Hafemeister2019" role="doc-biblioref">1</a></sup></span> such that high-expressing housekeeping genes might have high variance and disproportionately effect downstream dimensional reduction and clustering.</p>
<p>The second, newer workflow that I have been using is based on normalization using Pearson Residuals (PR). The approach itself is not new and scanpy has a built-in method for it (<em>i.e.</em>, <code>scanpy.experimental.pp.normalize_pearson_residuals</code>). Until recently the main disadvantage for using PR is that it doesn’t scale well to large number of cells that are typical in CosMx SMI<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> and it creates a large, dense normalization matrix that can make analysis and read/writing slower. Fortunately, in many cases I do not need to compute and store such a dense matrix. For example, Dan McGuire recently created the R package <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca">scPearsonPCA</a> that can estimate the Principle Components (PCs) of the PR normalized data without needing to convert and use very dense matrices (which we will show below). While this workflow involves converting data between python and R, I generally find the clusters that are derived from such data are comparable to the standard workflow or superior and so I recommend this workflow overall.</p>
<p>In this chapter, I’ll run both the standard and recommended workflows on the colon cancer dataset to provide code for both approaches. I will also do a deep-dive on the choice of UMAP parameters. This particular dataset is a case where the results are more-or-less comparable and I’ll pick the PR data to use throughout the rest of the colon analysis.</p>
<p>Let’s begin. Both options begin the same way: computing the highly variable genes (HVGs). I have found that the <code>pearson_residulas</code> method to detect HVGs (not to be confused with PR normalization) provides stable results for a variety of CosMx SMI WTX experiments.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-3"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-3-1"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">"counts"</span>] <span class="op">=</span> adata.X.copy()</span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1">1</button><span id="annotated-cell-3-3" class="code-annotation-target"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a>sc.experimental.pp.highly_variable_genes(</span>
<span id="annotated-cell-3-4"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a>    adata,</span>
<span id="annotated-cell-3-5"><a href="#annotated-cell-3-5" aria-hidden="true" tabindex="-1"></a>    flavor<span class="op">=</span><span class="st">'pearson_residuals'</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2">2</button><span id="annotated-cell-3-6" class="code-annotation-target"><a href="#annotated-cell-3-6" aria-hidden="true" tabindex="-1"></a>    n_top_genes<span class="op">=</span><span class="dv">4000</span>,</span>
<span id="annotated-cell-3-7"><a href="#annotated-cell-3-7" aria-hidden="true" tabindex="-1"></a>    layer<span class="op">=</span><span class="st">'counts'</span></span>
<span id="annotated-cell-3-8"><a href="#annotated-cell-3-8" aria-hidden="true" tabindex="-1"></a>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="3" data-code-annotation="1">the pearson_residuals ‘flavor’ implement in this function is not the same as the pearson residuals <em>normalization method</em> (see below).</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="6" data-code-annotation="2">generally 3000-5000 is a good starting point here.</span>
</dd>
</dl>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<div class="otherapproachesbox" title="Alternative Approach">
<div class="otherapproachesbox-header">
<div class="otherapproachesbox-icon">

</div>
<p>Alternative Approach</p>
</div>
<div class="otherapproachesbox-body">
<p>The pre-processing workflow presented here can be considered a good overall starting point towards understanding the structure of the data. As such I have omitted more complex workflows and tasks such as integrating morphology-based and/or protein-based PCs into the analysis. For a more involved workflow, see our upcoming WTX paper.</p>
</div>
</div>
</div></div><p>The tabs below show both of these workflows. In each workflow, I set the umap parameters to be identical (40 PCs, 15 nearest neighbors, spread = 2 and minimum distance = 0.02). While these are fixed here, see the box <code>Choosing UMAP Parameters</code> below to see how these parameters effect the UMAP visual and the Leiden cluster assignments.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Total Counts Workflow</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Pearson Residuals Workflow</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<blockquote class="blockquote">
<p>Workflow: Total counts-based normalization &gt; log transformation &gt; PCA</p>
</blockquote>
<p>The procedure below adapts a standard <code>scanpy</code> <a href="https://scanpy.readthedocs.io/en/stable/tutorials/basics/clustering.html#normalization">pipeline</a>. We’ll first normalize each cell the median total counts and then log tranform the data. With this approach I find that scaling the log1p data tends to generate more distinct and biologically relevant clusters so I add that step. Thus, we’ll focus our analysis on the most variable genes found in the dataset. After subsetting down to only these 4000 HVGs, we’ll scale each gene, run PCA, and put these HVG-derivied PCs into the full annData object. On this dataset (466820 cells), this whole process took about a minute.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>sc.pp.normalize_total(adata)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sc.pp.log1p(adata) <span class="co"># -&gt; adata.X</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">'TC'</span>] <span class="op">=</span> adata.X.copy()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset to HVGs and get PCs</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>adata_hvg <span class="op">=</span> adata[:, adata.var.highly_variable].copy()</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>sc.pp.scale(adata_hvg) <span class="co"># -&gt; adata.X</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>sc.tl.pca(adata_hvg, svd_solver<span class="op">=</span><span class="st">'auto'</span>) </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'X_pca_TC'</span>] <span class="op">=</span> adata_hvg.obsm[<span class="st">'X_pca'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Run UMAP and Leiden with the top 40 PCs.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata, n_neighbors<span class="op">=</span><span class="dv">15</span>, n_pcs<span class="op">=</span><span class="dv">40</span>, metric <span class="op">=</span> <span class="st">'cosine'</span>,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  use_rep<span class="op">=</span><span class="st">'X_pca_TC'</span>, key_added<span class="op">=</span><span class="st">'neighbors_TC'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>UMAP <span class="op">=</span> sc.tl.umap(adata, min_dist<span class="op">=</span><span class="fl">0.02</span>, spread<span class="op">=</span><span class="dv">2</span>, neighbors_key<span class="op">=</span><span class="st">'neighbors_TC'</span>, copy<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'umap_TC'</span>] <span class="op">=</span> UMAP.obsm[<span class="st">'X_umap'</span>]</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>adata.uns[<span class="st">'umap_TC_params'</span>] <span class="op">=</span> UMAP.uns[<span class="st">'umap'</span>]</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata, resolution<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  key_added<span class="op">=</span><span class="st">'leiden_tc'</span>, flavor<span class="op">=</span><span class="st">'igraph'</span>, </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  n_iterations<span class="op">=</span><span class="dv">2</span>, neighbors_key<span class="op">=</span><span class="st">'neighbors_TC'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<blockquote class="blockquote">
<p>Workflow: Py to R &gt; scPearsonPCA</p>
</blockquote>
<p>The <code>scPearsonPCA</code> package estimates the PCs of the PR data without computing and storing a dense normalized matrix. Since it is written in R, we’ll add it to this workflow via <code>reticulate</code> after converting a few objects.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>total_counts_per_cell <span class="op">=</span> adata.layers[<span class="st">'counts'</span>].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>total_counts_per_cell <span class="op">=</span> np.asarray(total_counts_per_cell).flatten()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>total_counts_per_target <span class="op">=</span> adata.layers[<span class="st">'counts'</span>].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>total_counts_per_target <span class="op">=</span> np.asarray(total_counts_per_target).flatten()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>target_frequencies <span class="op">=</span> total_counts_per_target <span class="op">/</span> total_counts_per_target.<span class="bu">sum</span>()</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>adata_hvg <span class="op">=</span> adata[:, adata.var.highly_variable].copy()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>hvgs_counts <span class="op">=</span> adata_hvg.layers[<span class="st">'counts'</span>].copy().astype(np.int64)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Convert relevant data to R.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>R Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>hvgs_counts <span class="ot">&lt;-</span> py<span class="sc">$</span>hvgs_counts</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(hvgs_counts) <span class="ot">&lt;-</span> py<span class="sc">$</span>adata_hvg<span class="sc">$</span>obs_names<span class="sc">$</span><span class="fu">to_list</span>()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(hvgs_counts) <span class="ot">&lt;-</span> py<span class="sc">$</span>adata_hvg<span class="sc">$</span>var_names<span class="sc">$</span><span class="fu">to_list</span>()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the approach we use below expects a sparse matrix with genes (rows) by cells (columns)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>t_hvgs_counts <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">t</span>(hvgs_counts)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>t_hvgs_counts <span class="ot">&lt;-</span> <span class="fu">as</span>(t_hvgs_counts, <span class="st">"CsparseMatrix"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Install the scPearsonPCA package (and remotes), if needed.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>R Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"Nanostring-Biostats/CosMx-Analysis-Scratch-Space"</span>,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">subdir =</span> <span class="st">"_code/scPearsonPCA"</span>, <span class="at">ref =</span> <span class="st">"Main"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Run Seurat-style PCA using scPearsonPCA.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>R Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scPearsonPCA)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>total_counts_per_cell <span class="ot">&lt;-</span> py<span class="sc">$</span>total_counts_per_cell</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>target_frequencies <span class="ot">&lt;-</span> py<span class="sc">$</span>target_frequencies</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(target_frequencies) <span class="ot">&lt;-</span> py<span class="sc">$</span>adata<span class="sc">$</span>var_names<span class="sc">$</span><span class="fu">to_list</span>()</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>pcaobj <span class="ot">&lt;-</span> <span class="fu">sparse_quasipoisson_pca_seurat</span>(</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">x =</span> t_hvgs_counts,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">totalcounts =</span> total_counts_per_cell,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">grate =</span> target_frequencies[<span class="fu">rownames</span>(t_hvgs_counts)],</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">scale.max =</span> <span class="dv">10</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">do.scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">do.center =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">ncores =</span> <span class="dv">5</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">&lt;-</span> pcaobj<span class="sc">$</span>reduction.data<span class="sc">@</span>cell.embeddings</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Add these PCs to the annData object in Python. Run UMAP and Leiden with the top 40 PCs.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">"X_pca_pr"</span>] <span class="op">=</span> r.pca</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata, n_neighbors<span class="op">=</span><span class="dv">15</span>, n_pcs<span class="op">=</span><span class="dv">40</span>, metric <span class="op">=</span> <span class="st">'cosine'</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  use_rep<span class="op">=</span><span class="st">'X_pca_pr'</span>, key_added<span class="op">=</span><span class="st">'neighbors_pr'</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>UMAP <span class="op">=</span> sc.tl.umap(adata, min_dist<span class="op">=</span><span class="fl">0.02</span>, spread<span class="op">=</span><span class="dv">2</span>, neighbors_key<span class="op">=</span><span class="st">'neighbors_pr'</span>, copy<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'umap_pr'</span>] <span class="op">=</span> UMAP.obsm[<span class="st">'X_umap'</span>]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>adata.uns[<span class="st">'umap_pr_params'</span>] <span class="op">=</span> UMAP.uns[<span class="st">'umap'</span>]</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata, resolution<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  key_added<span class="op">=</span><span class="st">'leiden_pr'</span>, flavor<span class="op">=</span><span class="st">'igraph'</span>, </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  n_iterations<span class="op">=</span><span class="dv">2</span>, neighbors_key<span class="op">=</span><span class="st">'neighbors_pr'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div>
</div>
</div>
<p>Save the annData object.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>adata.write_h5ad(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  os.path.join(r.analysis_dir, <span class="st">"anndata-2-leiden.h5ad"</span>),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  compression<span class="op">=</span>hdf5plugin.FILTERS[<span class="st">"zstd"</span>],</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  compression_opts<span class="op">=</span>hdf5plugin.Zstd(clevel<span class="op">=</span><span class="dv">5</span>).filter_options</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="visualizations" class="level2 page-columns page-full" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="visualizations"><span class="header-section-number">4.2</span> Visualizations</h2>
<p>Now that we have the UMAP embeddings and the Leiden cluster assignments in the annData object, we can plot the results of the two methods and compare. The easiest way to plot the Leiden clusters in UMAP space is with scnapy’s built-in method, <a href="https://scanpy.readthedocs.io/en/stable/generated/scanpy.tl.umap.html"><code>sc.pl.umap</code></a>; however, since we have non-typical <code>obsm</code> keys, we’ll use the more generic <a href="https://scanpy.readthedocs.io/en/latest/api/generated/scanpy.pl.embedding.html"><code>sc.pl.embedding</code></a> method.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>sc.settings.figdir <span class="op">=</span> r.pp_dir</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>save_dir <span class="op">=</span> r.pp_dir</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'log10_nCount_RNA'</span>] <span class="op">=</span> np.log10(adata.obs[<span class="st">'nCount_RNA'</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'qcflag'</span>] <span class="op">=</span> adata.obs[<span class="st">'qcflag'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>fig, ((ax1, ax2), (ax3, ax4), (ax5, ax6)) <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_TC'</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'leiden_tc'</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Total Counts (leiden_tc)'</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                palette<span class="op">=</span>sc.pl.palettes.default_20,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax1,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_pr'</span>,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'leiden_pr'</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Pearson Residuals (leiden_pr)'</span>,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>                palette<span class="op">=</span>sc.pl.palettes.default_20,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax2,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_TC'</span>,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'log10_nCount_RNA'</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Total Counts (log10_nCount_RNA)'</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax3,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_pr'</span>,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'log10_nCount_RNA'</span>,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Pearson Residuals (log10_nCount_RNA)'</span>,</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax4,</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_TC'</span>,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'qcflag'</span>,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Total Counts (FOV QC Flag)'</span>,</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>                palette<span class="op">=</span>sc.pl.palettes.default_20,</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax5,</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_pr'</span>,</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'qcflag'</span>,</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Pearson Residuals (FOV QC Flag)'</span>,</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>                palette<span class="op">=</span>sc.pl.palettes.default_20,</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax6,</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"umap_umap_compare.png"</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>save_path <span class="op">=</span> os.path.join(save_dir, filename)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>plt.savefig(save_path)          </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-umap-leiden-simple" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-umap-leiden-simple-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/preprocessing/umap_umap_compare.png" class="img-fluid figure-img" width="750">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-umap-leiden-simple-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.1: UMAP with Leiden clusters from total counts normalization (left) and scPearsonPCA PCs (right). Note that a given cluster label in one plot is not the same as that label in the other plot. Top: Leiden clusters. Middle: cells colored by their total counts. Bottom: cells colored by their QC flag (0 = no flag; 32 = FOV flag; no other flaggeed cells were processed).
</figcaption>
</figure>
</div>
</div>
</div>
<p>Both normalization methods demonstrate effective cluster separation (<a href="#fig-umap-leiden-simple" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>). When evaluating these visualizations, it is important to watch for artifacts, particularly sub-clustering driven primarily by total transcript counts, which can signal suboptimal normalization. Additionally, because we retained cells flagged by FOV QC (flag 32), we must verify that these cells do not aggregate into spurious “satellite” clusters which could indicate technical artifacts rather than biological signal. In this dataset, while FOV QC-flagged cells are present in the upper right cluster (Leiden 5 in the total counts workflow and Leiden 11 in the Pearson Residuals workflow), they do not form a distinct artifactual group. Instead, they appear integrated with the dominant cell population, suggesting their distribution is driven by the biology of that region – a hypothesis we will elucidate further in <span class="quarto-unresolved-ref">?sec-celltyping</span>.</p>
<p>We can compare which combination of Leiden clusters a given cell was assigned to:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>crosstab <span class="op">=</span> pd.crosstab(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    adata.obs[<span class="st">'leiden_tc'</span>],</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    adata.obs[<span class="st">'leiden_pr'</span>]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>crosstab_norm <span class="op">=</span> crosstab.div(crosstab.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>sns.heatmap(</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    crosstab_norm,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    annot<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    fmt<span class="op">=</span><span class="st">".2f"</span>, cmap<span class="op">=</span><span class="st">"viridis"</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    linewidths<span class="op">=</span><span class="fl">.5</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Leiden clusters derived from TC or PR workflows"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Total Counts (leiden_tc)"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Pearson Residuals (leiden_pr)"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"leiden_compare_crosstab.png"</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>save_path <span class="op">=</span> os.path.join(save_dir, filename)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>plt.savefig(save_path)     </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-umap-leiden-compare" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-umap-leiden-compare-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/preprocessing/leiden_compare_crosstab.png" class="img-fluid figure-img" width="600">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-umap-leiden-compare-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.2: Proportion of cells classified with the pure scanpy-based approach compared to the scPearsonPCA-based appraoch.
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-umap-leiden-compare" class="quarto-xref">Figure&nbsp;<span>4.2</span></a> shows a relationship between the clusters derived from our two normalization approaches. Most (15 of 16) Leiden clusters with the total counts approach have more than 85% of cells that are found in a single Leiden cluster for the Pearson Residuals method (e.g., 95% of tc_3 cells mapped to pr_1). One cluster in the total counts approach (tc_1) “split” amongst PR clusters (primarily clusters pr_5, pr_6, and pr_8).</p>
<p>So which is <em>better</em>? With this particular dataset the two approaches are comparable. For the majority of my CosMx SMI WTX analyses I have found the Pearson Residual-based normalization to provide more meaningful biological clusters consistently across datasets so that might be a good overall recommendation – especially if you are working within the R ecosystem. If you are looking for a quick analysis, then the total counts-based approach may work in many cases.</p>
<div class="column-body-outset">
<div class="noteworthybox callout-collapsible" title="Choosing UMAP Parameters" data-collapse="true">
<div class="noteworthybox-header" aria-expanded="false" data-bs-toggle="collapse" data-bs-target="#custom-box-body-1">
<div class="noteworthybox-icon">

</div>
<p>Choosing UMAP Parameters</p>
<div class="callout-tools">
<a class="callout-collapse-toggle"></a>
</div>
</div>
<div id="custom-box-body-1" class="noteworthybox-body collapse">
<section id="choosing-umap-parameters" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="choosing-umap-parameters"><span class="header-section-number">4.3</span> Choosing UMAP Parameters</h2>
<p>UMAP helps visualize how groups of cells relate to each other in high-dimensional space. While there isn’t one “correct” UMAP layout, some embeddings are more effective than others at revealing underlying biological structure. We have seen in this chapter how having choice in normalization alone (via PCA) can alter the shape of a UMAP plot even when all other parameters are identical (<a href="#fig-umap-leiden-simple" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>).</p>
<p>This section explores how commonly adjusted parameters and inputs other than the choice of normalization influence the resulting UMAP visualization, aiming to build intuition for how to tune these parameters effectively in your dataset.</p>
<p>Let’s systematically vary five key factors:</p>
<ul>
<li><strong>The quality filtering applied to the input cells.</strong> Using only high-quality cells often leads to clearer, tighter clusters representing core biological populations. If filtering was too stringent then entire cell populations might be unrepresented.</li>
<li><strong>The number of Principal Components (PCs) used.</strong> Using a lower number will concetrate on the strongest axes of variation at the cost of reducing any distinction between cell subtypes if that distinction is found in higher PCs. Choosing a higher number of PCs can potentially resolve finer subtypes but also risks incorporating noise, which might slightly blur cluster boundaries or create small, potentially spurious groupings.</li>
<li><strong>The number of nearest neighbors (n_neighbors).</strong> Lower <code>n_neighbors</code> tends to emphasize local cluster separation while higher <code>n_neigbhors</code> tends to form broader clusters.</li>
<li><strong>The distance metric (metric).</strong> Defines the rule for calculating “closeness” between cells. Euclidean measures straight-line distance while cosine measures the angle between gene expression profiles. Since changing this alters which cells are considered “neighbors,” the parameter can have large impacts on the global shape. Euclidean is the default many packages but cosine often provides more biologically meaningful clusters for CosMx SMI data.</li>
<li><strong>The minimum distance parameter (min_dist).</strong> Controls how tightly packed points are within a cluster. Higher values tend to make more diffuse clusters.</li>
<li><strong>The spread parameter (spread).</strong> Controls the separation between clusters. Lower <code>spread</code> tends to bring clusters closer together.</li>
</ul>
<p>This list isn’t exhaustive, but varying these while keeping others constant will illustrate their core effects. To make this exploration computationally feasible, we will use a representative subsample of 50,000 cells from our quality-flagged dataset. And to make visualization smooth, we’ll only plot at most 500 cells.</p>
<p>Click the radio buttons below to see what effect these parameter have on the UMAP visualization. Some of these changes are gradual while some dramatically alter the shape and configuration of the UMAP embeddings. You’ll note that filtering out the poor quality cells doesn’t merely remove the cells from the UMAP; instead, the inclusion of poorer-quality data can effect the entire UMAP topology. I have also included the Leiden clusters for these cells. The number of PCs and the number of neighbors effect Leiden cluster cell assignment while <code>spread</code> and <code>min_dist</code> do not.</p>
<p>Encouragingly, in this dataset there doesn’t appear to be any UMAP clusters that appear to be made up of cells that were flagged in our FOV QC analysis (<a href="quality-processing.html#sec-fov-qc" class="quarto-xref"><span>Section 3.1</span></a>). If this <em>was</em> the case, it would suggest that we would want to remove the cells in the effected FOVs.</p>
<div class="columns">
<div class="column" style="width:40%;">
<div class="cell" data-edit="false" data-define="qc_flags_data">
<div>
<div id="webr-1" class="exercise-cell">

</div>
<script type="webr-1-contents">
eyJhdHRyIjp7ImRlZmluZSI6WyJxY19mbGFnc19kYXRhIl0sImVjaG8iOmZhbHNlLCJlZGl0IjpmYWxzZSwiZXZhbCI6dHJ1ZX0sImNvZGUiOiJcbiMgVGhpcyBibG9jayBmZXRjaGVzIHRoZSBRQ1xuIyBmbGFnIGNvZGVzIGZvciB0aGUgY2VsbCBpZHMgKG51bWVyaWMpIHNvIHRoYXQgaXQgY2FuIGJlIG1lcmdlZCBpbiB0aGUgcGxvdHNcbiMgYW5kIHRhYmxlcy5cblxucWNfZmxhZ3NfZmlsZSA8LSBcImFzc2V0cy9pbnRlcmFjdGl2ZXMvdW1hcF9leHBsb3JlX3FjX2ZsYWdzLnBhcnF1ZXRcIlxucWNfZmxhZ3NfZGF0YSA8LSBkYXRhLmZyYW1lKGNlbGxfaWQgPSBjaGFyYWN0ZXIoKSwgcWNmbGFnID0gaW50ZWdlcigpKVxuXG5jb24gPC0gdHJ5Q2F0Y2goeyBkYkNvbm5lY3QoZHVja2RiKCkpIH0sIGVycm9yID0gZnVuY3Rpb24oZSkgeyBwcmludChlKTsgTlVMTCB9KVxuXG5pZiAoIWlzLm51bGwoY29uKSkge1xuICBpZiAoZmlsZS5leGlzdHMocWNfZmxhZ3NfZmlsZSkpIHtcbiAgICAjIHByaW50KFwiTG9hZGluZyBRQyBmbGFncyBkYXRhLi4uXCIpXG4gICAgcWNfZmxhZ3NfZGF0YSA8LSB0cnlDYXRjaCh7XG4gICAgICBkYkdldFF1ZXJ5KGNvbiwgcGFzdGUwKFwiU0VMRUNUICogRlJPTSAnXCIsIHFjX2ZsYWdzX2ZpbGUsIFwiJ1wiKSlcbiAgICB9LCBlcnJvciA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICMgcHJpbnQoXCJFcnJvciByZWFkaW5nIFFDIGZsYWdzIHBhcnF1ZXQ6XCIpXG4gICAgICBwcmludChlKVxuICAgICAgcWNfZmxhZ3NfZGF0YSAjIFJldHVybiBkZWZhdWx0IGVtcHR5XG4gICAgfSlcbiAgICAjIHByaW50KHBhc3RlKFwiTG9hZGVkXCIsIG5yb3cocWNfZmxhZ3NfZGF0YSksIFwiUUMgZmxhZyBlbnRyaWVzLlwiKSlcbiAgfSBlbHNlIHtcbiAgICBwcmludChwYXN0ZShcIlFDIGZsYWdzIGZpbGUgbm90IGZvdW5kOlwiLCBxY19mbGFnc19maWxlKSlcbiAgfVxuICBkYkRpc2Nvbm5lY3QoY29uLCBzaHV0ZG93biA9IFRSVUUpXG59In0=
</script>
</div>
</div>
<div class="cell" data-eval="true">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb12" data-startfrom="802" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 801;"><span id="cb12-802"><a href="#cb12-802" aria-hidden="true" tabindex="-1"></a>viewof qc_level <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="st">"no QC filter"</span><span class="op">,</span> <span class="st">"include FOV QC cells"</span><span class="op">,</span> <span class="st">"filter all flags"</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"QC Level"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">"include FOV QC cells"</span>})</span>
<span id="cb12-803"><a href="#cb12-803" aria-hidden="true" tabindex="-1"></a>viewof n_pcs <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">50</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"PCs"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">30</span>})</span>
<span id="cb12-804"><a href="#cb12-804" aria-hidden="true" tabindex="-1"></a>viewof n_neighbors <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="dv">15</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">50</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"Neighbors"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">30</span>})</span>
<span id="cb12-805"><a href="#cb12-805" aria-hidden="true" tabindex="-1"></a>viewof metric <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="st">"euclidean"</span><span class="op">,</span> <span class="st">"cosine"</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"Metric"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">"cosine"</span>})</span>
<span id="cb12-806"><a href="#cb12-806" aria-hidden="true" tabindex="-1"></a>viewof mdist <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="fl">0.01</span><span class="op">,</span> <span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.5</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"Min. distance"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="fl">0.2</span>})</span>
<span id="cb12-807"><a href="#cb12-807" aria-hidden="true" tabindex="-1"></a>viewof spread <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="fl">0.5</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">2.0</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"Spread"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="fl">2.0</span>})</span>
<span id="cb12-808"><a href="#cb12-808" aria-hidden="true" tabindex="-1"></a>viewof colorby <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="st">"QC"</span><span class="op">,</span> <span class="st">"Leiden"</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"Color by"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">"QC"</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-7" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell" data-edit="false" data-input="[&quot;qc_level&quot;,&quot;n_pcs&quot;,&quot;n_neighbors&quot;,&quot;metric&quot;,&quot;mdist&quot;,&quot;spread&quot;,&quot;colorby&quot;]" data-define="query_data">
<div>
<div id="webr-2" class="exercise-cell">

</div>
<script type="webr-2-contents">
eyJhdHRyIjp7ImRlZmluZSI6WyJxdWVyeV9kYXRhIl0sImVjaG8iOmZhbHNlLCJlZGl0IjpmYWxzZSwiZXZhbCI6dHJ1ZSwiaW5wdXQiOlsicWNfbGV2ZWwiLCJuX3BjcyIsIm5fbmVpZ2hib3JzIiwibWV0cmljIiwibWRpc3QiLCJzcHJlYWQiLCJjb2xvcmJ5Il19LCJjb2RlIjoiXG5cbiMgY29ubmVjdGlvbiB0byBhbiBpbi1tZW1vcnkgRHVja0RCIGRhdGFiYXNlLlxuY29uIDwtIGRiQ29ubmVjdChkdWNrZGIoKSlcblxuIyBidWlsZCB0aGUgU1FMIHF1ZXJ5XG5xdWVyeSA8LSBwYXN0ZTAoXG4gIFwiU0VMRUNUICogRlJPTSAnYXNzZXRzL2ludGVyYWN0aXZlcy91bWFwX2V4cGxvcmUucGFycXVldCcgV0hFUkUgcWMgPSAnXCIsXG4gIHFjX2xldmVsLFxuICBcIicgQU5EIG5fcGNzID0gJ1wiLFxuICBuX3BjcyxcbiAgXCInIEFORCBuX25laWdoYm9ycyA9ICdcIixcbiAgbl9uZWlnaGJvcnMsXG4gIFwiJyBBTkQgbWV0cmljID0gJ1wiLCBcbiAgbWV0cmljLFxuICBcIicgQU5EIG1pbl9kaXN0ID0gJ1wiLFxuICBtZGlzdCxcbiAgXCInIEFORCBzcHJlYWQgPSAnXCIsXG4gIHNwcmVhZCwgXCInXCJcbilcblxucXVlcnlfZGF0YSA8LSB0cnlDYXRjaCh7XG4gICAgZGJHZXRRdWVyeShjb24sIHF1ZXJ5KVxuICB9LCBlcnJvciA9IGZ1bmN0aW9uKGUpIHtcbiAgICBwcmludChcIi0tLSBTUUwgUXVlcnkgRXJyb3IgLS0tXCIpXG4gICAgcHJpbnQoXCJRdWVyeSB0aGF0IGZhaWxlZDpcIilcbiAgICBwcmludChxdWVyeSlcbiAgICBwcmludChcIkVycm9yIG1lc3NhZ2U6XCIpXG4gICAgcHJpbnQoZSlcblxuICAgIGRhdGEuZnJhbWUoXG4gICAgICBjZWxsX2lkID0gY2hhcmFjdGVyKCksIFxuICAgICAgdW1hcF8xID0gbnVtZXJpYygpLCBcbiAgICAgIHVtYXBfMiA9IG51bWVyaWMoKVxuICAgICkgXG4gIH0pXG5cblxuZGJEaXNjb25uZWN0KGNvbiwgc2h1dGRvd24gPSBUUlVFKSJ9
</script>
</div>
</div>
<!-- static QC flag legend and defs -->
<div class="cell hidden" data-eval="true">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb13" data-startfrom="875" data-source-offset="-35"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 874;"><span id="cb13-875"><a href="#cb13-875" aria-hidden="true" tabindex="-1"></a>qcMasks <span class="op">=</span> ({</span>
<span id="cb13-876"><a href="#cb13-876" aria-hidden="true" tabindex="-1"></a>  <span class="dt">LOW_COUNTS</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">0</span><span class="op">,</span> </span>
<span id="cb13-877"><a href="#cb13-877" aria-hidden="true" tabindex="-1"></a>  <span class="dt">HIGH_COUNTS</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">1</span><span class="op">,</span> </span>
<span id="cb13-878"><a href="#cb13-878" aria-hidden="true" tabindex="-1"></a>  <span class="dt">LOW_FEAT</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb13-879"><a href="#cb13-879" aria-hidden="true" tabindex="-1"></a>  <span class="dt">HIGH_FEAT</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">3</span><span class="op">,</span> </span>
<span id="cb13-880"><a href="#cb13-880" aria-hidden="true" tabindex="-1"></a>  <span class="dt">LOW_SPLIT</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">4</span><span class="op">,</span> </span>
<span id="cb13-881"><a href="#cb13-881" aria-hidden="true" tabindex="-1"></a>  <span class="dt">FOV_QC</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">5</span><span class="op">,</span> </span>
<span id="cb13-882"><a href="#cb13-882" aria-hidden="true" tabindex="-1"></a>  <span class="dt">LOW_SBR</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">6</span></span>
<span id="cb13-883"><a href="#cb13-883" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb13-884"><a href="#cb13-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-885"><a href="#cb13-885" aria-hidden="true" tabindex="-1"></a>flagNames <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(qcMasks)<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> qcMasks[a] <span class="op">-</span> qcMasks[b])<span class="op">;</span></span>
<span id="cb13-886"><a href="#cb13-886" aria-hidden="true" tabindex="-1"></a>qcFlagMap <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(qc_flags_data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> [d<span class="op">.</span><span class="at">cell_id</span><span class="op">,</span> d<span class="op">.</span><span class="at">qcflag</span>]))<span class="op">;</span></span>
<span id="cb13-887"><a href="#cb13-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-888"><a href="#cb13-888" aria-hidden="true" tabindex="-1"></a>flagColors <span class="op">=</span> {</span>
<span id="cb13-889"><a href="#cb13-889" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> uniqueFlagsInData <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">new</span> <span class="bu">Set</span>(qc_flags_data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">qcflag</span>)))<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">-</span> b)<span class="op">;</span></span>
<span id="cb13-890"><a href="#cb13-890" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> uniqueFlagsWithZero <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">new</span> <span class="bu">Set</span>([<span class="dv">0</span><span class="op">,</span> <span class="op">...</span>uniqueFlagsInData]))<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span>b)<span class="kw">=&gt;</span> a<span class="op">-</span>b)<span class="op">;</span></span>
<span id="cb13-891"><a href="#cb13-891" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> colors <span class="op">=</span> d3<span class="op">.</span><span class="at">schemeTableau10</span><span class="op">;</span></span>
<span id="cb13-892"><a href="#cb13-892" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> map <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb13-893"><a href="#cb13-893" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> colorIndex <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-894"><a href="#cb13-894" aria-hidden="true" tabindex="-1"></a>  uniqueFlagsWithZero<span class="op">.</span><span class="fu">forEach</span>(flagValue <span class="kw">=&gt;</span> {</span>
<span id="cb13-895"><a href="#cb13-895" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (flagValue <span class="op">===</span> <span class="dv">0</span>) { map[flagValue] <span class="op">=</span> <span class="st">"black"</span><span class="op">;</span> }</span>
<span id="cb13-896"><a href="#cb13-896" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> { map[flagValue] <span class="op">=</span> colors[colorIndex<span class="op">++</span> <span class="op">%</span> colors<span class="op">.</span><span class="at">length</span>]<span class="op">;</span> }</span>
<span id="cb13-897"><a href="#cb13-897" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb13-898"><a href="#cb13-898" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> map<span class="op">;</span></span>
<span id="cb13-899"><a href="#cb13-899" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-900"><a href="#cb13-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-901"><a href="#cb13-901" aria-hidden="true" tabindex="-1"></a>qcColorScale <span class="op">=</span> (flagValue) <span class="kw">=&gt;</span> flagColors[flagValue <span class="op">??</span> <span class="dv">0</span>]<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-2-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-2-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-2-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-2-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-2-5" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="columns">
<div class="column" style="width:70%;">
<!-- QC legend -->
<div class="cell" data-eval="true">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb14" data-startfrom="912" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 911;"><span id="cb14-912"><a href="#cb14-912" aria-hidden="true" tabindex="-1"></a>qcFlagLegend <span class="op">=</span> {</span>
<span id="cb14-913"><a href="#cb14-913" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb14-914"><a href="#cb14-914" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> uniqueFlagsWithZero <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(flagColors)<span class="op">.</span><span class="fu">map</span>(<span class="bu">Number</span>)<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span>b)<span class="kw">=&gt;</span> a<span class="op">-</span>b)<span class="op">;</span></span>
<span id="cb14-915"><a href="#cb14-915" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tableRows <span class="op">=</span> uniqueFlagsWithZero<span class="op">.</span><span class="fu">map</span>(flagValue <span class="kw">=&gt;</span> {</span>
<span id="cb14-916"><a href="#cb14-916" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> flagColor <span class="op">=</span> flagColors[flagValue]<span class="op">;</span> <span class="co">// Use static map</span></span>
<span id="cb14-917"><a href="#cb14-917" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> circles <span class="op">=</span> flagNames<span class="op">.</span><span class="fu">map</span>(name <span class="kw">=&gt;</span> {</span>
<span id="cb14-918"><a href="#cb14-918" aria-hidden="true" tabindex="-1"></a>         <span class="kw">const</span> mask <span class="op">=</span> qcMasks[name]<span class="op">;</span></span>
<span id="cb14-919"><a href="#cb14-919" aria-hidden="true" tabindex="-1"></a>         <span class="kw">const</span> isSet <span class="op">=</span> (flagValue <span class="op">&amp;</span> mask) <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-920"><a href="#cb14-920" aria-hidden="true" tabindex="-1"></a>         <span class="kw">const</span> circleFill <span class="op">=</span> isSet <span class="op">?</span> flagColor <span class="op">:</span> <span class="st">"#e0e0e0"</span><span class="op">;</span></span>
<span id="cb14-921"><a href="#cb14-921" aria-hidden="true" tabindex="-1"></a>         <span class="kw">const</span> circleSvg <span class="op">=</span> <span class="vs">`&lt;svg width="15" height="15"&gt;&lt;circle cx="7.5" cy="7.5" r="6" fill="</span><span class="sc">${</span>circleFill<span class="sc">}</span><span class="vs">" stroke="</span><span class="sc">${</span>isSet <span class="op">?</span> <span class="st">'black'</span> <span class="op">:</span> <span class="st">'#ccc'</span><span class="sc">}</span><span class="vs">" stroke-width="1"&gt;&lt;/circle&gt;&lt;/svg&gt;`</span><span class="op">;</span></span>
<span id="cb14-922"><a href="#cb14-922" aria-hidden="true" tabindex="-1"></a>         <span class="cf">return</span> <span class="vs">`&lt;td style="text-align: center;"&gt;</span><span class="sc">${</span>circleSvg<span class="sc">}</span><span class="vs">&lt;/td&gt;`</span><span class="op">;</span></span>
<span id="cb14-923"><a href="#cb14-923" aria-hidden="true" tabindex="-1"></a>      })<span class="op">.</span><span class="fu">join</span>(<span class="st">''</span>)<span class="op">;</span></span>
<span id="cb14-924"><a href="#cb14-924" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> rowHeader <span class="op">=</span> <span class="vs">`&lt;th scope="row" style="text-align: right; padding-right: 10px; white-space: nowrap;"&gt;</span></span>
<span id="cb14-925"><a href="#cb14-925" aria-hidden="true" tabindex="-1"></a><span class="vs">                           &lt;span style="display: inline-block; width: 12px; height: 12px; background-color: </span><span class="sc">${</span>flagColor<span class="sc">}</span><span class="vs">; border: 1px solid #555; margin-right: 5px; vertical-align: middle;"&gt;&lt;/span&gt;</span></span>
<span id="cb14-926"><a href="#cb14-926" aria-hidden="true" tabindex="-1"></a><span class="vs">                           </span><span class="sc">${</span>flagValue <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">'Passed'</span> <span class="op">:</span> flagValue<span class="sc">}</span></span>
<span id="cb14-927"><a href="#cb14-927" aria-hidden="true" tabindex="-1"></a><span class="vs">                         &lt;/th&gt;`</span><span class="op">;</span></span>
<span id="cb14-928"><a href="#cb14-928" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="vs">`&lt;tr&gt;</span><span class="sc">${</span>rowHeader<span class="sc">}${</span>circles<span class="sc">}</span><span class="vs">&lt;/tr&gt;`</span><span class="op">;</span></span>
<span id="cb14-929"><a href="#cb14-929" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">join</span>(<span class="st">''</span>)<span class="op">;</span></span>
<span id="cb14-930"><a href="#cb14-930" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> headerCells <span class="op">=</span> flagNames<span class="op">.</span><span class="fu">map</span>(name <span class="kw">=&gt;</span></span>
<span id="cb14-931"><a href="#cb14-931" aria-hidden="true" tabindex="-1"></a>      <span class="vs">`&lt;th style="height: 100px; text-align: center; vertical-align: bottom; padding-bottom: 5px; font-size: 0.8em; white-space: nowrap;"&gt;</span></span>
<span id="cb14-932"><a href="#cb14-932" aria-hidden="true" tabindex="-1"></a><span class="vs">         &lt;span style="writing-mode: vertical-lr; transform: rotate(180deg);"&gt;</span><span class="sc">${</span>name<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/_/g</span><span class="op">,</span> <span class="st">' '</span>)<span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb14-933"><a href="#cb14-933" aria-hidden="true" tabindex="-1"></a><span class="vs">       &lt;/th&gt;`</span></span>
<span id="cb14-934"><a href="#cb14-934" aria-hidden="true" tabindex="-1"></a>    )<span class="op">.</span><span class="fu">join</span>(<span class="st">''</span>)<span class="op">;</span></span>
<span id="cb14-935"><a href="#cb14-935" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tableHeader <span class="op">=</span> <span class="vs">`&lt;thead&gt;&lt;tr&gt;&lt;th style="vertical-align: bottom;"&gt;Flag Value&lt;/th&gt;</span><span class="sc">${</span>headerCells<span class="sc">}</span><span class="vs">&lt;/tr&gt;&lt;/thead&gt;`</span><span class="op">;</span></span>
<span id="cb14-936"><a href="#cb14-936" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;table style="border-collapse: collapse; margin-top: 10px; font-size: 0.9em; table-layout: fixed;"&gt;</span></span>
<span id="cb14-937"><a href="#cb14-937" aria-hidden="true" tabindex="-1"></a><span class="vs">                   </span><span class="sc">${</span>tableHeader<span class="sc">}</span><span class="vs">&lt;tbody&gt;</span><span class="sc">${</span>tableRows<span class="sc">}</span><span class="vs">&lt;/tbody&gt;</span></span>
<span id="cb14-938"><a href="#cb14-938" aria-hidden="true" tabindex="-1"></a><span class="vs">                 &lt;/table&gt;`</span><span class="op">;</span></span>
<span id="cb14-939"><a href="#cb14-939" aria-hidden="true" tabindex="-1"></a>   } <span class="cf">catch</span> (error) {</span>
<span id="cb14-940"><a href="#cb14-940" aria-hidden="true" tabindex="-1"></a>     <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error generating QC Legend:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb14-941"><a href="#cb14-941" aria-hidden="true" tabindex="-1"></a>     <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Error generating QC Legend&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb14-942"><a href="#cb14-942" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb14-943"><a href="#cb14-943" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-3" data-nodetype="declaration">

</div>
</div>
</div>
</div><div class="column" style="width:3%;">
<!-- empty column to create gap -->
</div><div class="column" style="width:27%;">
<div class="cell" data-eval="true">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb15" data-startfrom="960" data-source-offset="-1"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 959;"><span id="cb15-960"><a href="#cb15-960" aria-hidden="true" tabindex="-1"></a>leidenScaleAndLegend <span class="op">=</span> {</span>
<span id="cb15-961"><a href="#cb15-961" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> scale<span class="op">,</span> legend<span class="op">;</span></span>
<span id="cb15-962"><a href="#cb15-962" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> { <span class="co">// Add try...catch</span></span>
<span id="cb15-963"><a href="#cb15-963" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if query_data is ready and has 'leiden'</span></span>
<span id="cb15-964"><a href="#cb15-964" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>query_data <span class="op">||</span> query_data<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span> <span class="op">||</span> <span class="op">!</span>query_data[<span class="dv">0</span>]<span class="op">.</span><span class="fu">hasOwnProperty</span>(<span class="st">'leiden'</span>)) {</span>
<span id="cb15-965"><a href="#cb15-965" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">"Leiden data (query_data) not ready for legend/scale."</span>)<span class="op">;</span></span>
<span id="cb15-966"><a href="#cb15-966" aria-hidden="true" tabindex="-1"></a>        scale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleOrdinal</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="st">"0"</span>])<span class="op">.</span><span class="fu">range</span>([<span class="st">"grey"</span>])<span class="op">;</span> <span class="co">// Placeholder scale</span></span>
<span id="cb15-967"><a href="#cb15-967" aria-hidden="true" tabindex="-1"></a>        legend <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;&lt;ul style="list-style: none; padding-left: 0; margin-top: 10px; font-size: 0.9em;"&gt;</span></span>
<span id="cb15-968"><a href="#cb15-968" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;li style="margin-bottom: 2px;"&gt;&lt;span style="display: inline-block; width: 12px; height: 12px; background-color: grey; border: 1px solid #555; margin-right: 5px; vertical-align: middle;"&gt;&lt;/span&gt; Cluster 0&lt;/li&gt;</span></span>
<span id="cb15-969"><a href="#cb15-969" aria-hidden="true" tabindex="-1"></a><span class="vs">                      &lt;/ul&gt;(Loading...)&lt;/div&gt;`</span><span class="op">;</span> <span class="co">// placeholder</span></span>
<span id="cb15-970"><a href="#cb15-970" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb15-971"><a href="#cb15-971" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> uniqueClusters <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">new</span> <span class="bu">Set</span>(query_data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">leiden</span>)))<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">-</span> b)<span class="op">;</span></span>
<span id="cb15-972"><a href="#cb15-972" aria-hidden="true" tabindex="-1"></a>        scale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleOrdinal</span>(d3<span class="op">.</span><span class="at">schemeTableau10</span>)<span class="op">.</span><span class="fu">domain</span>(uniqueClusters)<span class="op">;</span></span>
<span id="cb15-973"><a href="#cb15-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-974"><a href="#cb15-974" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> legendItems <span class="op">=</span> uniqueClusters<span class="op">.</span><span class="fu">map</span>(cluster <span class="kw">=&gt;</span> {</span>
<span id="cb15-975"><a href="#cb15-975" aria-hidden="true" tabindex="-1"></a>           <span class="kw">const</span> color <span class="op">=</span> <span class="fu">scale</span>(cluster)<span class="op">;</span></span>
<span id="cb15-976"><a href="#cb15-976" aria-hidden="true" tabindex="-1"></a>           <span class="kw">const</span> clusterLabel <span class="op">=</span> <span class="bu">String</span>(cluster)<span class="op">;</span></span>
<span id="cb15-977"><a href="#cb15-977" aria-hidden="true" tabindex="-1"></a>           <span class="cf">return</span> <span class="vs">`&lt;li style="margin-bottom: 2px;"&gt;&lt;span style="display: inline-block; width: 12px; height: 12px; background-color: </span><span class="sc">${</span>color<span class="sc">}</span><span class="vs">; border: 1px solid #555; margin-right: 5px; vertical-align: middle;"&gt;&lt;/span&gt; Cluster </span><span class="sc">${</span>clusterLabel<span class="sc">}</span><span class="vs">&lt;/li&gt;`</span><span class="op">;</span></span>
<span id="cb15-978"><a href="#cb15-978" aria-hidden="true" tabindex="-1"></a>        })<span class="op">.</span><span class="fu">join</span>(<span class="st">''</span>)<span class="op">;</span></span>
<span id="cb15-979"><a href="#cb15-979" aria-hidden="true" tabindex="-1"></a>        legend <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;ul style="list-style: none; padding-left: 0; margin-top: 10px; font-size: 0.9em;"&gt;</span><span class="sc">${</span>legendItems<span class="sc">}</span><span class="vs">&lt;/ul&gt;`</span><span class="op">;</span></span>
<span id="cb15-980"><a href="#cb15-980" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-981"><a href="#cb15-981" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span>(error) {</span>
<span id="cb15-982"><a href="#cb15-982" aria-hidden="true" tabindex="-1"></a>     <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error generating Leiden Legend:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb15-983"><a href="#cb15-983" aria-hidden="true" tabindex="-1"></a>     scale <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="st">'grey'</span><span class="op">;</span></span>
<span id="cb15-984"><a href="#cb15-984" aria-hidden="true" tabindex="-1"></a>     legend <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Error generating Leiden Legend&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb15-985"><a href="#cb15-985" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-986"><a href="#cb15-986" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> { scale<span class="op">,</span> legend }<span class="op">;</span></span>
<span id="cb15-987"><a href="#cb15-987" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-988"><a href="#cb15-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-989"><a href="#cb15-989" aria-hidden="true" tabindex="-1"></a>leidenColorScale <span class="op">=</span> leidenScaleAndLegend<span class="op">.</span><span class="at">scale</span></span>
<span id="cb15-990"><a href="#cb15-990" aria-hidden="true" tabindex="-1"></a>leidenLegendHtml <span class="op">=</span> leidenScaleAndLegend<span class="op">.</span><span class="at">legend</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-3" data-nodetype="declaration">

</div>
</div>
</div>
</div>
</div>
</div>
</div><div class="column" style="width:5%;">

</div><div class="column" style="width:55%;">
<div class="cell hidden" data-eval="true" data-message="false">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb16" data-startfrom="1012" data-source-offset="-1"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1011;"><span id="cb16-1012"><a href="#cb16-1012" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3@7"</span>)</span>
<span id="cb16-1013"><a href="#cb16-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1014"><a href="#cb16-1014" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb16-1015"><a href="#cb16-1015" aria-hidden="true" tabindex="-1"></a>height <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb16-1016"><a href="#cb16-1016" aria-hidden="true" tabindex="-1"></a>marginTop <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb16-1017"><a href="#cb16-1017" aria-hidden="true" tabindex="-1"></a>marginRight <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb16-1018"><a href="#cb16-1018" aria-hidden="true" tabindex="-1"></a>marginBottom <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb16-1019"><a href="#cb16-1019" aria-hidden="true" tabindex="-1"></a>marginLeft <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb16-1020"><a href="#cb16-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1021"><a href="#cb16-1021" aria-hidden="true" tabindex="-1"></a>xScale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>])<span class="op">.</span><span class="fu">range</span>([marginLeft<span class="op">,</span> width <span class="op">-</span> marginRight])</span>
<span id="cb16-1022"><a href="#cb16-1022" aria-hidden="true" tabindex="-1"></a>yScale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>])<span class="op">.</span><span class="fu">range</span>([height <span class="op">-</span> marginBottom<span class="op">,</span> marginTop])</span>
<span id="cb16-1023"><a href="#cb16-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1024"><a href="#cb16-1024" aria-hidden="true" tabindex="-1"></a>svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)</span>
<span id="cb16-1025"><a href="#cb16-1025" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width)</span>
<span id="cb16-1026"><a href="#cb16-1026" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> height)</span>
<span id="cb16-1027"><a href="#cb16-1027" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"viewBox"</span><span class="op">,</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> width<span class="op">,</span> height])</span>
<span id="cb16-1028"><a href="#cb16-1028" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"style"</span><span class="op">,</span> <span class="st">"max-width: 100%; height: auto;"</span>)<span class="op">;</span></span>
<span id="cb16-1029"><a href="#cb16-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1030"><a href="#cb16-1030" aria-hidden="true" tabindex="-1"></a>xAxis <span class="op">=</span> d3<span class="op">.</span><span class="fu">axisBottom</span>(xScale)</span>
<span id="cb16-1031"><a href="#cb16-1031" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">ticks</span>(width <span class="op">/</span> <span class="dv">80</span>)</span>
<span id="cb16-1032"><a href="#cb16-1032" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">tickSizeOuter</span>(<span class="dv">0</span>)</span>
<span id="cb16-1033"><a href="#cb16-1033" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">tickSizeInner</span>(<span class="op">-</span>(height <span class="op">-</span> marginTop <span class="op">-</span> marginBottom))<span class="op">;</span></span>
<span id="cb16-1034"><a href="#cb16-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1035"><a href="#cb16-1035" aria-hidden="true" tabindex="-1"></a>yAxis <span class="op">=</span> d3<span class="op">.</span><span class="fu">axisLeft</span>(yScale)</span>
<span id="cb16-1036"><a href="#cb16-1036" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">ticks</span>(height <span class="op">/</span> <span class="dv">40</span>)</span>
<span id="cb16-1037"><a href="#cb16-1037" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">tickSizeOuter</span>(<span class="dv">0</span>)</span>
<span id="cb16-1038"><a href="#cb16-1038" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">tickSizeInner</span>(<span class="op">-</span>(width <span class="op">-</span> marginLeft <span class="op">-</span> marginRight))<span class="op">;</span></span>
<span id="cb16-1039"><a href="#cb16-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1040"><a href="#cb16-1040" aria-hidden="true" tabindex="-1"></a>gx <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb16-1041"><a href="#cb16-1041" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span> <span class="st">"x-axis"</span>)</span>
<span id="cb16-1042"><a href="#cb16-1042" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(0,</span><span class="sc">${</span>height <span class="op">-</span> marginBottom<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb16-1043"><a href="#cb16-1043" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(xAxis)<span class="op">;</span></span>
<span id="cb16-1044"><a href="#cb16-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1045"><a href="#cb16-1045" aria-hidden="true" tabindex="-1"></a>gy <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb16-1046"><a href="#cb16-1046" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span> <span class="st">"y-axis"</span>)</span>
<span id="cb16-1047"><a href="#cb16-1047" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>marginLeft<span class="sc">}</span><span class="vs">,0)`</span>)</span>
<span id="cb16-1048"><a href="#cb16-1048" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(yAxis)<span class="op">;</span></span>
<span id="cb16-1049"><a href="#cb16-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-1050"><a href="#cb16-1050" aria-hidden="true" tabindex="-1"></a>svg<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".tick line"</span>)</span>
<span id="cb16-1051"><a href="#cb16-1051" aria-hidden="true" tabindex="-1"></a>   <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-7" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-8" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-9" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-10" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-11" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-12" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-13" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-14" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-15" data-nodetype="expression">

</div>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb17" data-startfrom="1053" data-source-offset="-1040"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1052;"><span id="cb17-1053"><a href="#cb17-1053" aria-hidden="true" tabindex="-1"></a>svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb17-1054"><a href="#cb17-1054" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> width <span class="op">-</span> marginRight)</span>
<span id="cb17-1055"><a href="#cb17-1055" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> height <span class="op">-</span> marginBottom <span class="op">-</span> <span class="dv">4</span>)</span>
<span id="cb17-1056"><a href="#cb17-1056" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"currentColor"</span>)</span>
<span id="cb17-1057"><a href="#cb17-1057" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"end"</span>)</span>
<span id="cb17-1058"><a href="#cb17-1058" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>(<span class="st">"UMAP 1 →"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-16" data-nodetype="expression">

</div>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb18" data-startfrom="1060" data-source-offset="-1227"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1059;"><span id="cb18-1060"><a href="#cb18-1060" aria-hidden="true" tabindex="-1"></a>svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb18-1061"><a href="#cb18-1061" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> marginLeft <span class="op">+</span> <span class="dv">4</span>)</span>
<span id="cb18-1062"><a href="#cb18-1062" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> marginTop)</span>
<span id="cb18-1063"><a href="#cb18-1063" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"currentColor"</span>)</span>
<span id="cb18-1064"><a href="#cb18-1064" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"start"</span>)</span>
<span id="cb18-1065"><a href="#cb18-1065" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dominant-baseline"</span><span class="op">,</span> <span class="st">"hanging"</span>)</span>
<span id="cb18-1066"><a href="#cb18-1066" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>(<span class="st">"↑ UMAP 2"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-17" data-nodetype="expression">

</div>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb19" data-startfrom="1067" data-source-offset="-1436"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1066;"><span id="cb19-1067"><a href="#cb19-1067" aria-hidden="true" tabindex="-1"></a><span class="op">-</span></span>
<span id="cb19-1068"><a href="#cb19-1068" aria-hidden="true" tabindex="-1"></a>svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"clipPath"</span>)</span>
<span id="cb19-1069"><a href="#cb19-1069" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"clip"</span>)</span>
<span id="cb19-1070"><a href="#cb19-1070" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">append</span>(<span class="st">"rect"</span>)</span>
<span id="cb19-1071"><a href="#cb19-1071" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> marginLeft)</span>
<span id="cb19-1072"><a href="#cb19-1072" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> marginTop)</span>
<span id="cb19-1073"><a href="#cb19-1073" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width <span class="op">-</span> marginLeft <span class="op">-</span> marginRight)</span>
<span id="cb19-1074"><a href="#cb19-1074" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> height <span class="op">-</span> marginTop <span class="op">-</span> marginBottom)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-18" data-nodetype="expression">

</div>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb20" data-startfrom="1076" data-source-offset="-1666"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1075;"><span id="cb20-1076"><a href="#cb20-1076" aria-hidden="true" tabindex="-1"></a>pointGroup <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb20-1077"><a href="#cb20-1077" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"black"</span>)</span>
<span id="cb20-1078"><a href="#cb20-1078" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"clip-path"</span><span class="op">,</span> <span class="st">"url(#clip)"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-5-19" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell" data-eval="true" data-message="false">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code hidden" id="cb21" data-startfrom="1084" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1083;"><span id="cb21-1084"><a href="#cb21-1084" aria-hidden="true" tabindex="-1"></a>{ <span class="co">// Reactive block</span></span>
<span id="cb21-1085"><a href="#cb21-1085" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> updateVisualization <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb21-1086"><a href="#cb21-1086" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> duration <span class="op">=</span> <span class="dv">750</span><span class="op">;</span></span>
<span id="cb21-1087"><a href="#cb21-1087" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-1088"><a href="#cb21-1088" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> currentScale <span class="op">=</span> colorby <span class="op">===</span> <span class="st">"QC"</span> <span class="op">?</span> qcColorScale <span class="op">:</span> leidenColorScale<span class="op">;</span></span>
<span id="cb21-1089"><a href="#cb21-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1090"><a href="#cb21-1090" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>currentScale) { </span>
<span id="cb21-1091"><a href="#cb21-1091" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Scale missing"</span>)<span class="op">;</span> </span>
<span id="cb21-1092"><a href="#cb21-1092" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span> </span>
<span id="cb21-1093"><a href="#cb21-1093" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-1094"><a href="#cb21-1094" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-1095"><a href="#cb21-1095" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>query_data <span class="op">||</span> query_data<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb21-1096"><a href="#cb21-1096" aria-hidden="true" tabindex="-1"></a>       <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">"No data available for plotting."</span>)<span class="op">;</span></span>
<span id="cb21-1097"><a href="#cb21-1097" aria-hidden="true" tabindex="-1"></a>       pointGroup<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"circle"</span>)<span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"opacity"</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb21-1098"><a href="#cb21-1098" aria-hidden="true" tabindex="-1"></a>       <span class="cf">return</span><span class="op">;</span> </span>
<span id="cb21-1099"><a href="#cb21-1099" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-1100"><a href="#cb21-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1101"><a href="#cb21-1101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> xExtent <span class="op">=</span> d3<span class="op">.</span><span class="fu">extent</span>(query_data<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">umap_1</span>)<span class="op">;</span></span>
<span id="cb21-1102"><a href="#cb21-1102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> yExtent <span class="op">=</span> d3<span class="op">.</span><span class="fu">extent</span>(query_data<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">umap_2</span>)<span class="op">;</span></span>
<span id="cb21-1103"><a href="#cb21-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1104"><a href="#cb21-1104" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> xPad <span class="op">=</span> (xExtent[<span class="dv">1</span>] <span class="op">-</span> xExtent[<span class="dv">0</span>]) <span class="op">*</span> <span class="fl">0.05</span><span class="op">;</span></span>
<span id="cb21-1105"><a href="#cb21-1105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> yPad <span class="op">=</span> (yExtent[<span class="dv">1</span>] <span class="op">-</span> yExtent[<span class="dv">0</span>]) <span class="op">*</span> <span class="fl">0.05</span><span class="op">;</span></span>
<span id="cb21-1106"><a href="#cb21-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1107"><a href="#cb21-1107" aria-hidden="true" tabindex="-1"></a>    xScale<span class="op">.</span><span class="fu">domain</span>([xExtent[<span class="dv">0</span>] <span class="op">-</span> xPad <span class="op">||</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> xExtent[<span class="dv">1</span>] <span class="op">+</span> xPad <span class="op">||</span> <span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb21-1108"><a href="#cb21-1108" aria-hidden="true" tabindex="-1"></a>    yScale<span class="op">.</span><span class="fu">domain</span>([yExtent[<span class="dv">0</span>] <span class="op">-</span> yPad <span class="op">||</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> yExtent[<span class="dv">1</span>] <span class="op">+</span> yPad <span class="op">||</span> <span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb21-1109"><a href="#cb21-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1110"><a href="#cb21-1110" aria-hidden="true" tabindex="-1"></a>    svg<span class="op">.</span><span class="fu">select</span>(<span class="st">".x-axis"</span>)</span>
<span id="cb21-1111"><a href="#cb21-1111" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)</span>
<span id="cb21-1112"><a href="#cb21-1112" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">call</span>(xAxis)</span>
<span id="cb21-1113"><a href="#cb21-1113" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"start"</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb21-1114"><a href="#cb21-1114" aria-hidden="true" tabindex="-1"></a>         svg<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".x-axis .tick line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb21-1115"><a href="#cb21-1115" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb21-1116"><a href="#cb21-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1117"><a href="#cb21-1117" aria-hidden="true" tabindex="-1"></a>    svg<span class="op">.</span><span class="fu">select</span>(<span class="st">".y-axis"</span>)</span>
<span id="cb21-1118"><a href="#cb21-1118" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)</span>
<span id="cb21-1119"><a href="#cb21-1119" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">call</span>(yAxis)</span>
<span id="cb21-1120"><a href="#cb21-1120" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"start"</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb21-1121"><a href="#cb21-1121" aria-hidden="true" tabindex="-1"></a>         svg<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".y-axis .tick line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb21-1122"><a href="#cb21-1122" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb21-1123"><a href="#cb21-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1124"><a href="#cb21-1124" aria-hidden="true" tabindex="-1"></a>    pointGroup<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"circle"</span>)</span>
<span id="cb21-1125"><a href="#cb21-1125" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">data</span>(query_data<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">cell_id</span>)</span>
<span id="cb21-1126"><a href="#cb21-1126" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">join</span>(</span>
<span id="cb21-1127"><a href="#cb21-1127" aria-hidden="true" tabindex="-1"></a>        enter <span class="kw">=&gt;</span> enter<span class="op">.</span><span class="fu">append</span>(<span class="st">"circle"</span>)</span>
<span id="cb21-1128"><a href="#cb21-1128" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cx"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">xScale</span>(d<span class="op">.</span><span class="at">umap_1</span>)) </span>
<span id="cb21-1129"><a href="#cb21-1129" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cy"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">yScale</span>(d<span class="op">.</span><span class="at">umap_2</span>))</span>
<span id="cb21-1130"><a href="#cb21-1130" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"r"</span><span class="op">,</span> <span class="fl">2.5</span>)</span>
<span id="cb21-1131"><a href="#cb21-1131" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> d <span class="kw">=&gt;</span> {</span>
<span id="cb21-1132"><a href="#cb21-1132" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> {</span>
<span id="cb21-1133"><a href="#cb21-1133" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">const</span> valueToColor <span class="op">=</span> colorby <span class="op">===</span> <span class="st">"QC"</span> <span class="op">?</span> qcFlagMap<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">cell_id</span>) <span class="op">:</span> d<span class="op">.</span><span class="at">leiden</span><span class="op">;</span></span>
<span id="cb21-1134"><a href="#cb21-1134" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="fu">currentScale</span>(valueToColor) <span class="op">||</span> <span class="st">'grey'</span><span class="op">;</span></span>
<span id="cb21-1135"><a href="#cb21-1135" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">catch</span>(e) { <span class="cf">return</span> <span class="st">'grey'</span><span class="op">;</span> }</span>
<span id="cb21-1136"><a href="#cb21-1136" aria-hidden="true" tabindex="-1"></a>            }) </span>
<span id="cb21-1137"><a href="#cb21-1137" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"opacity"</span><span class="op">,</span> <span class="dv">0</span>)</span>
<span id="cb21-1138"><a href="#cb21-1138" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">call</span>(enter <span class="kw">=&gt;</span> enter<span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"opacity"</span><span class="op">,</span> <span class="fl">0.8</span>))<span class="op">,</span></span>
<span id="cb21-1139"><a href="#cb21-1139" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-1140"><a href="#cb21-1140" aria-hidden="true" tabindex="-1"></a>        update <span class="kw">=&gt;</span> update</span>
<span id="cb21-1141"><a href="#cb21-1141" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">call</span>(update <span class="kw">=&gt;</span> update<span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)</span>
<span id="cb21-1142"><a href="#cb21-1142" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cx"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">xScale</span>(d<span class="op">.</span><span class="at">umap_1</span>))</span>
<span id="cb21-1143"><a href="#cb21-1143" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cy"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">yScale</span>(d<span class="op">.</span><span class="at">umap_2</span>))</span>
<span id="cb21-1144"><a href="#cb21-1144" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> d <span class="kw">=&gt;</span> { </span>
<span id="cb21-1145"><a href="#cb21-1145" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span> {</span>
<span id="cb21-1146"><a href="#cb21-1146" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">const</span> valueToColor <span class="op">=</span> colorby <span class="op">===</span> <span class="st">"QC"</span> <span class="op">?</span> qcFlagMap<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">cell_id</span>) <span class="op">:</span> d<span class="op">.</span><span class="at">leiden</span><span class="op">;</span></span>
<span id="cb21-1147"><a href="#cb21-1147" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="fu">currentScale</span>(valueToColor) <span class="op">||</span> <span class="st">'grey'</span><span class="op">;</span></span>
<span id="cb21-1148"><a href="#cb21-1148" aria-hidden="true" tabindex="-1"></a>                    } <span class="cf">catch</span>(e) { <span class="cf">return</span> <span class="st">'grey'</span><span class="op">;</span> }</span>
<span id="cb21-1149"><a href="#cb21-1149" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb21-1150"><a href="#cb21-1150" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">attr</span>(<span class="st">"opacity"</span><span class="op">,</span> <span class="fl">0.8</span>)</span>
<span id="cb21-1151"><a href="#cb21-1151" aria-hidden="true" tabindex="-1"></a>             )<span class="op">,</span></span>
<span id="cb21-1152"><a href="#cb21-1152" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-1153"><a href="#cb21-1153" aria-hidden="true" tabindex="-1"></a>        exit <span class="kw">=&gt;</span> exit</span>
<span id="cb21-1154"><a href="#cb21-1154" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">call</span>(exit <span class="kw">=&gt;</span> exit<span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"opacity"</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">remove</span>())</span>
<span id="cb21-1155"><a href="#cb21-1155" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb21-1156"><a href="#cb21-1156" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb21-1157"><a href="#cb21-1157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-1158"><a href="#cb21-1158" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> { </span>
<span id="cb21-1159"><a href="#cb21-1159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateVisualization</span>()<span class="op">;</span></span>
<span id="cb21-1160"><a href="#cb21-1160" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span>(error) {</span>
<span id="cb21-1161"><a href="#cb21-1161" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error during D3 updateVisualization:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb21-1162"><a href="#cb21-1162" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-1163"><a href="#cb21-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1164"><a href="#cb21-1164" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span> </span>
<span id="cb21-1165"><a href="#cb21-1165" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-6" data-nodetype="expression">

</div>
</div>
</div>
<p>In the dot plot on the bottom left provides a QC flag legend. For example, QC flag ‘5’ represents cells that were flagged for having low counts and low features whereas QC flag ‘96’ represents cells that wee flagged for FOV QC as wells as low SBR.</p>
</div>
</div>
<p>If you want to further explore this subset, you can examine the <code>query_data</code> and <code>qc_flags_data</code> dataframes below.</p>
<div class="cell" data-autorun="true" data-input="[&quot;query_data&quot;,&quot;qc_flags_data&quot;]">
<div>
<div id="webr-3" class="exercise-cell">

</div>
<script type="webr-3-contents">
eyJhdHRyIjp7ImF1dG9ydW4iOnRydWUsImVkaXQiOnRydWUsImV2YWwiOnRydWUsImlucHV0IjpbInF1ZXJ5X2RhdGEiLCJxY19mbGFnc19kYXRhIl19LCJjb2RlIjoiXG5oZWFkKHF1ZXJ5X2RhdGEpXG5oZWFkKHFjX2ZsYWdzX2RhdGEpIn0=
</script>
</div>
</div>
</section>
</div>
</div>
</div>
<p>For the remainder of this chapter, I will focus on the PR-based method.</p>
<p>I find it’s helpful to:</p>
<ol type="1">
<li>Have more control of the plotting aesthetics and label multiple sub-clusters of a given Leiden cluster for clarity and</li>
<li>isolate the Leiden clusters and visualize them in both UMAP space and physical (XY) space to see if there are regions in the tissue that might provide clues about the cell types.</li>
</ol>
<p>Instead of the default <code>plotDots</code> colors, let’s define our own.</p>
<div class="cell">
<details class="code-fold">
<summary>R Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define colors semi-manually instead of using the default colors</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>column <span class="ot">&lt;-</span> <span class="st">'leiden_pr'</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>column_levels <span class="ot">&lt;-</span> <span class="fu">levels</span>(py<span class="sc">$</span>adata<span class="sc">$</span>obs[[column]])</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>n_levels <span class="ot">&lt;-</span> <span class="fu">length</span>(column_levels)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(n_levels<span class="sc">&lt;</span><span class="dv">27</span>){</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  colors_use <span class="ot">&lt;-</span> pals<span class="sc">::</span><span class="fu">alphabet</span>(n_levels)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(n <span class="sc">&lt;</span> <span class="dv">53</span>){</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  colors_use <span class="ot">&lt;-</span> <span class="fu">c</span>(pals<span class="sc">::</span><span class="fu">alphabet</span>(<span class="dv">26</span>), pals<span class="sc">::</span><span class="fu">alphabet2</span>(n_levels<span class="dv">-26</span>))</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"consider fewer groups"</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(colors_use) <span class="ot">&lt;-</span> column_levels</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># saving colors for later</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>results_list[[<span class="st">'leiden_global_names'</span>]] <span class="ot">&lt;-</span> <span class="fu">names</span>(colors_use)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>results_list[[<span class="st">'leiden_global_colors'</span>]] <span class="ot">&lt;-</span> <span class="fu">as.character</span>(colors_use)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(results_list, results_list_file)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Plot the cells in XY space and UMAP space and color based on <code>leiden_pr</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>R Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-8"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1">1</button><span id="annotated-cell-8-1" class="code-annotation-target"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a>group_prefix <span class="ot">&lt;-</span> <span class="st">"leiden"</span></span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-3"><a href="#annotated-cell-8-3" aria-hidden="true" tabindex="-1"></a>pp_assets_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_asset_dir, <span class="st">"preprocessing"</span>)</span>
<span id="annotated-cell-8-4"><a href="#annotated-cell-8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># XY (global only)</span></span>
<span id="annotated-cell-8-6"><a href="#annotated-cell-8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDots</span>(py<span class="sc">$</span>adata, <span class="at">color_by=</span><span class="st">'leiden_pr'</span>,</span>
<span id="annotated-cell-8-7"><a href="#annotated-cell-8-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot_global =</span> <span class="cn">TRUE</span>,</span>
<span id="annotated-cell-8-8"><a href="#annotated-cell-8-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">facet_by_group =</span> <span class="cn">FALSE</span>,</span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_plot_parameters =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-10"><a href="#annotated-cell-8-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_point_params =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-11"><a href="#annotated-cell-8-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size=</span><span class="fl">0.001</span></span>
<span id="annotated-cell-8-12"><a href="#annotated-cell-8-12" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="annotated-cell-8-13"><a href="#annotated-cell-8-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">scale_bar_params =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-14"><a href="#annotated-cell-8-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">location =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">0</span>),</span>
<span id="annotated-cell-8-15"><a href="#annotated-cell-8-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">width =</span> <span class="dv">2</span>,</span>
<span id="annotated-cell-8-16"><a href="#annotated-cell-8-16" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n =</span> <span class="dv">3</span>,</span>
<span id="annotated-cell-8-17"><a href="#annotated-cell-8-17" aria-hidden="true" tabindex="-1"></a>                    <span class="at">height =</span> <span class="fl">0.1</span>,</span>
<span id="annotated-cell-8-18"><a href="#annotated-cell-8-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">scale_colors =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"grey30"</span>),</span>
<span id="annotated-cell-8-19"><a href="#annotated-cell-8-19" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label_nudge_y =</span> <span class="sc">-</span><span class="fl">0.3</span></span>
<span id="annotated-cell-8-20"><a href="#annotated-cell-8-20" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="annotated-cell-8-21"><a href="#annotated-cell-8-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">directory =</span> pp_assets_dir,</span>
<span id="annotated-cell-8-22"><a href="#annotated-cell-8-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fileType =</span> <span class="st">"png"</span>,</span>
<span id="annotated-cell-8-23"><a href="#annotated-cell-8-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dpi =</span> <span class="dv">200</span>,</span>
<span id="annotated-cell-8-24"><a href="#annotated-cell-8-24" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> <span class="dv">8</span>, </span>
<span id="annotated-cell-8-25"><a href="#annotated-cell-8-25" aria-hidden="true" tabindex="-1"></a>                  <span class="at">height =</span> <span class="dv">8</span>,</span>
<span id="annotated-cell-8-26"><a href="#annotated-cell-8-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prefix=</span>group_prefix</span>
<span id="annotated-cell-8-27"><a href="#annotated-cell-8-27" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="annotated-cell-8-28"><a href="#annotated-cell-8-28" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_ggplot_layers =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-29"><a href="#annotated-cell-8-29" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_bw</span>(),</span>
<span id="annotated-cell-8-30"><a href="#annotated-cell-8-30" aria-hidden="true" tabindex="-1"></a>                <span class="fu">xlab</span>(<span class="st">"X (mm)"</span>),</span>
<span id="annotated-cell-8-31"><a href="#annotated-cell-8-31" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ylab</span>(<span class="st">"Y (mm)"</span>), </span>
<span id="annotated-cell-8-32"><a href="#annotated-cell-8-32" aria-hidden="true" tabindex="-1"></a>                <span class="fu">coord_fixed</span>(),</span>
<span id="annotated-cell-8-33"><a href="#annotated-cell-8-33" aria-hidden="true" tabindex="-1"></a>                <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors_use),</span>
<span id="annotated-cell-8-34"><a href="#annotated-cell-8-34" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.4</span>)),</span>
<span id="annotated-cell-8-35"><a href="#annotated-cell-8-35" aria-hidden="true" tabindex="-1"></a>                <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(</span>
<span id="annotated-cell-8-36"><a href="#annotated-cell-8-36" aria-hidden="true" tabindex="-1"></a>                  <span class="at">title=</span><span class="st">"Leiden (PR)"</span>,</span>
<span id="annotated-cell-8-37"><a href="#annotated-cell-8-37" aria-hidden="true" tabindex="-1"></a>                  <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">3</span>) ) )</span>
<span id="annotated-cell-8-38"><a href="#annotated-cell-8-38" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="annotated-cell-8-39"><a href="#annotated-cell-8-39" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="annotated-cell-8-40"><a href="#annotated-cell-8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-41"><a href="#annotated-cell-8-41" aria-hidden="true" tabindex="-1"></a><span class="co"># XY (facets only)</span></span>
<span id="annotated-cell-8-42"><a href="#annotated-cell-8-42" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDots</span>(py<span class="sc">$</span>adata, <span class="at">color_by=</span><span class="st">'leiden_pr'</span>,</span>
<span id="annotated-cell-8-43"><a href="#annotated-cell-8-43" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot_global =</span> <span class="cn">FALSE</span>,</span>
<span id="annotated-cell-8-44"><a href="#annotated-cell-8-44" aria-hidden="true" tabindex="-1"></a>              <span class="at">facet_by_group =</span> <span class="cn">TRUE</span>,</span>
<span id="annotated-cell-8-45"><a href="#annotated-cell-8-45" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_plot_parameters =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-46"><a href="#annotated-cell-8-46" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_point_params =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-47"><a href="#annotated-cell-8-47" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size=</span><span class="fl">0.001</span></span>
<span id="annotated-cell-8-48"><a href="#annotated-cell-8-48" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="annotated-cell-8-49"><a href="#annotated-cell-8-49" aria-hidden="true" tabindex="-1"></a>                  <span class="at">scale_bar_params =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-50"><a href="#annotated-cell-8-50" aria-hidden="true" tabindex="-1"></a>                    <span class="at">location =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">0</span>),</span>
<span id="annotated-cell-8-51"><a href="#annotated-cell-8-51" aria-hidden="true" tabindex="-1"></a>                    <span class="at">width =</span> <span class="dv">2</span>,</span>
<span id="annotated-cell-8-52"><a href="#annotated-cell-8-52" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n =</span> <span class="dv">3</span>,</span>
<span id="annotated-cell-8-53"><a href="#annotated-cell-8-53" aria-hidden="true" tabindex="-1"></a>                    <span class="at">height =</span> <span class="fl">0.1</span>,</span>
<span id="annotated-cell-8-54"><a href="#annotated-cell-8-54" aria-hidden="true" tabindex="-1"></a>                    <span class="at">scale_colors =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"grey30"</span>),</span>
<span id="annotated-cell-8-55"><a href="#annotated-cell-8-55" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label_nudge_y =</span> <span class="sc">-</span><span class="fl">0.3</span></span>
<span id="annotated-cell-8-56"><a href="#annotated-cell-8-56" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="annotated-cell-8-57"><a href="#annotated-cell-8-57" aria-hidden="true" tabindex="-1"></a>                  <span class="at">directory =</span> pp_assets_dir,</span>
<span id="annotated-cell-8-58"><a href="#annotated-cell-8-58" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fileType =</span> <span class="st">"png"</span>,</span>
<span id="annotated-cell-8-59"><a href="#annotated-cell-8-59" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dpi =</span> <span class="dv">100</span>,</span>
<span id="annotated-cell-8-60"><a href="#annotated-cell-8-60" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> <span class="dv">5</span>,</span>
<span id="annotated-cell-8-61"><a href="#annotated-cell-8-61" aria-hidden="true" tabindex="-1"></a>                  <span class="at">height =</span> <span class="dv">5</span>,</span>
<span id="annotated-cell-8-62"><a href="#annotated-cell-8-62" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prefix=</span>group_prefix</span>
<span id="annotated-cell-8-63"><a href="#annotated-cell-8-63" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="annotated-cell-8-64"><a href="#annotated-cell-8-64" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_ggplot_layers =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-65"><a href="#annotated-cell-8-65" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_bw</span>(),</span>
<span id="annotated-cell-8-66"><a href="#annotated-cell-8-66" aria-hidden="true" tabindex="-1"></a>                <span class="fu">xlab</span>(<span class="st">"X (mm)"</span>),</span>
<span id="annotated-cell-8-67"><a href="#annotated-cell-8-67" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ylab</span>(<span class="st">"Y (mm)"</span>), </span>
<span id="annotated-cell-8-68"><a href="#annotated-cell-8-68" aria-hidden="true" tabindex="-1"></a>                <span class="fu">coord_fixed</span>(),</span>
<span id="annotated-cell-8-69"><a href="#annotated-cell-8-69" aria-hidden="true" tabindex="-1"></a>                <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors_use),</span>
<span id="annotated-cell-8-70"><a href="#annotated-cell-8-70" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.4</span>)),</span>
<span id="annotated-cell-8-71"><a href="#annotated-cell-8-71" aria-hidden="true" tabindex="-1"></a>                <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(</span>
<span id="annotated-cell-8-72"><a href="#annotated-cell-8-72" aria-hidden="true" tabindex="-1"></a>                  <span class="at">title=</span><span class="st">"Leiden (PR)"</span>,</span>
<span id="annotated-cell-8-73"><a href="#annotated-cell-8-73" aria-hidden="true" tabindex="-1"></a>                  <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">3</span>) ) )</span>
<span id="annotated-cell-8-74"><a href="#annotated-cell-8-74" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="annotated-cell-8-75"><a href="#annotated-cell-8-75" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="annotated-cell-8-76"><a href="#annotated-cell-8-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-77"><a href="#annotated-cell-8-77" aria-hidden="true" tabindex="-1"></a><span class="co"># UMAP (global only)</span></span>
<span id="annotated-cell-8-78"><a href="#annotated-cell-8-78" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDots</span>(py<span class="sc">$</span>adata, </span>
<span id="annotated-cell-8-79"><a href="#annotated-cell-8-79" aria-hidden="true" tabindex="-1"></a>              <span class="at">obsm_key =</span> <span class="st">"umap_pr"</span>,</span>
<span id="annotated-cell-8-80"><a href="#annotated-cell-8-80" aria-hidden="true" tabindex="-1"></a>              <span class="at">color_by=</span><span class="st">'leiden_pr'</span>,</span>
<span id="annotated-cell-8-81"><a href="#annotated-cell-8-81" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot_global =</span> <span class="cn">TRUE</span>,</span>
<span id="annotated-cell-8-82"><a href="#annotated-cell-8-82" aria-hidden="true" tabindex="-1"></a>              <span class="at">facet_by_group =</span> <span class="cn">FALSE</span>,</span>
<span id="annotated-cell-8-83"><a href="#annotated-cell-8-83" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_plot_parameters =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-84"><a href="#annotated-cell-8-84" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_point_params =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-85"><a href="#annotated-cell-8-85" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size=</span><span class="fl">0.001</span>, <span class="at">alpha=</span><span class="fl">0.1</span></span>
<span id="annotated-cell-8-86"><a href="#annotated-cell-8-86" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="annotated-cell-8-87"><a href="#annotated-cell-8-87" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_label_params =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-88"><a href="#annotated-cell-8-88" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> <span class="dv">4</span></span>
<span id="annotated-cell-8-89"><a href="#annotated-cell-8-89" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="annotated-cell-8-90"><a href="#annotated-cell-8-90" aria-hidden="true" tabindex="-1"></a>                  <span class="at">labels_on_plot =</span> <span class="fu">data.frame</span>(),</span>
<span id="annotated-cell-8-91"><a href="#annotated-cell-8-91" aria-hidden="true" tabindex="-1"></a>                  <span class="at">directory =</span> pp_assets_dir,</span>
<span id="annotated-cell-8-92"><a href="#annotated-cell-8-92" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fileType =</span> <span class="st">"png"</span>,</span>
<span id="annotated-cell-8-93"><a href="#annotated-cell-8-93" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dpi =</span> <span class="dv">200</span>,</span>
<span id="annotated-cell-8-94"><a href="#annotated-cell-8-94" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> <span class="dv">8</span>,</span>
<span id="annotated-cell-8-95"><a href="#annotated-cell-8-95" aria-hidden="true" tabindex="-1"></a>                  <span class="at">height =</span> <span class="dv">8</span>,</span>
<span id="annotated-cell-8-96"><a href="#annotated-cell-8-96" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prefix=</span>group_prefix</span>
<span id="annotated-cell-8-97"><a href="#annotated-cell-8-97" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="annotated-cell-8-98"><a href="#annotated-cell-8-98" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_ggplot_layers =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-99"><a href="#annotated-cell-8-99" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_bw</span>(),</span>
<span id="annotated-cell-8-100"><a href="#annotated-cell-8-100" aria-hidden="true" tabindex="-1"></a>                <span class="fu">xlab</span>(<span class="st">"UMAP 1"</span>),</span>
<span id="annotated-cell-8-101"><a href="#annotated-cell-8-101" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ylab</span>(<span class="st">"UMAP 2"</span>), </span>
<span id="annotated-cell-8-102"><a href="#annotated-cell-8-102" aria-hidden="true" tabindex="-1"></a>                <span class="fu">coord_fixed</span>(),</span>
<span id="annotated-cell-8-103"><a href="#annotated-cell-8-103" aria-hidden="true" tabindex="-1"></a>                <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors_use),</span>
<span id="annotated-cell-8-104"><a href="#annotated-cell-8-104" aria-hidden="true" tabindex="-1"></a>                <span class="co"># guides(color = guide_legend(</span></span>
<span id="annotated-cell-8-105"><a href="#annotated-cell-8-105" aria-hidden="true" tabindex="-1"></a>                <span class="co">#   title="Cell Type",</span></span>
<span id="annotated-cell-8-106"><a href="#annotated-cell-8-106" aria-hidden="true" tabindex="-1"></a>                <span class="co">#   override.aes = list(size = 3) ) ), </span></span>
<span id="annotated-cell-8-107"><a href="#annotated-cell-8-107" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="annotated-cell-8-108"><a href="#annotated-cell-8-108" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="annotated-cell-8-109"><a href="#annotated-cell-8-109" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-8-110"><a href="#annotated-cell-8-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-111"><a href="#annotated-cell-8-111" aria-hidden="true" tabindex="-1"></a><span class="co"># UMAP (facets only)</span></span>
<span id="annotated-cell-8-112"><a href="#annotated-cell-8-112" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDots</span>(py<span class="sc">$</span>adata, </span>
<span id="annotated-cell-8-113"><a href="#annotated-cell-8-113" aria-hidden="true" tabindex="-1"></a>              <span class="at">obsm_key =</span> <span class="st">"umap_pr"</span>,</span>
<span id="annotated-cell-8-114"><a href="#annotated-cell-8-114" aria-hidden="true" tabindex="-1"></a>              <span class="at">color_by=</span><span class="st">'leiden_pr'</span>,</span>
<span id="annotated-cell-8-115"><a href="#annotated-cell-8-115" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot_global =</span> <span class="cn">FALSE</span>,</span>
<span id="annotated-cell-8-116"><a href="#annotated-cell-8-116" aria-hidden="true" tabindex="-1"></a>              <span class="at">facet_by_group =</span> <span class="cn">TRUE</span>,</span>
<span id="annotated-cell-8-117"><a href="#annotated-cell-8-117" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_plot_parameters =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-118"><a href="#annotated-cell-8-118" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_point_params =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-119"><a href="#annotated-cell-8-119" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size=</span><span class="fl">0.001</span>, <span class="at">alpha=</span><span class="fl">0.1</span></span>
<span id="annotated-cell-8-120"><a href="#annotated-cell-8-120" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="annotated-cell-8-121"><a href="#annotated-cell-8-121" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_label_params =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-122"><a href="#annotated-cell-8-122" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> <span class="dv">2</span></span>
<span id="annotated-cell-8-123"><a href="#annotated-cell-8-123" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="annotated-cell-8-124"><a href="#annotated-cell-8-124" aria-hidden="true" tabindex="-1"></a>                  <span class="at">labels_on_plot =</span> <span class="fu">data.frame</span>(),</span>
<span id="annotated-cell-8-125"><a href="#annotated-cell-8-125" aria-hidden="true" tabindex="-1"></a>                  <span class="at">directory =</span> pp_assets_dir,</span>
<span id="annotated-cell-8-126"><a href="#annotated-cell-8-126" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fileType =</span> <span class="st">"png"</span>,</span>
<span id="annotated-cell-8-127"><a href="#annotated-cell-8-127" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dpi =</span> <span class="dv">100</span>,</span>
<span id="annotated-cell-8-128"><a href="#annotated-cell-8-128" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> <span class="dv">5</span>,</span>
<span id="annotated-cell-8-129"><a href="#annotated-cell-8-129" aria-hidden="true" tabindex="-1"></a>                  <span class="at">height =</span> <span class="dv">5</span>,</span>
<span id="annotated-cell-8-130"><a href="#annotated-cell-8-130" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prefix=</span>group_prefix</span>
<span id="annotated-cell-8-131"><a href="#annotated-cell-8-131" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="annotated-cell-8-132"><a href="#annotated-cell-8-132" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_ggplot_layers =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-8-133"><a href="#annotated-cell-8-133" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_bw</span>(),</span>
<span id="annotated-cell-8-134"><a href="#annotated-cell-8-134" aria-hidden="true" tabindex="-1"></a>                <span class="fu">xlab</span>(<span class="st">"UMAP 1"</span>),</span>
<span id="annotated-cell-8-135"><a href="#annotated-cell-8-135" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ylab</span>(<span class="st">"UMAP 2"</span>), </span>
<span id="annotated-cell-8-136"><a href="#annotated-cell-8-136" aria-hidden="true" tabindex="-1"></a>                <span class="fu">coord_fixed</span>(),</span>
<span id="annotated-cell-8-137"><a href="#annotated-cell-8-137" aria-hidden="true" tabindex="-1"></a>                <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors_use),</span>
<span id="annotated-cell-8-138"><a href="#annotated-cell-8-138" aria-hidden="true" tabindex="-1"></a>                <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(</span>
<span id="annotated-cell-8-139"><a href="#annotated-cell-8-139" aria-hidden="true" tabindex="-1"></a>                  <span class="at">title=</span><span class="st">"Cell Type"</span>,</span>
<span id="annotated-cell-8-140"><a href="#annotated-cell-8-140" aria-hidden="true" tabindex="-1"></a>                  <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">3</span>) ) )</span>
<span id="annotated-cell-8-141"><a href="#annotated-cell-8-141" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="annotated-cell-8-142"><a href="#annotated-cell-8-142" aria-hidden="true" tabindex="-1"></a>            )</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="1" data-code-annotation="1">in the plotting below, we will use this name to parse out files.</span>
</dd>
</dl>
</div>
</div>
<p>Here are the overall (global) plots.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true" href="">Leiden - UMAP</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false" href="">Leiden - XY</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-umap-leiden" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-umap-leiden-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-umap-leiden-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.3: UMAP with Leiden (PR-based) cells.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-xy-celltype-broad" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-xy-celltype-broad-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-xy-celltype-broad-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.4: XY with Leiden (PR-based) cells.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Here are the individual plots<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> we created organized by Leiden cluster. From these pairs of plots one can quickly see how some Leiden clusters are spatially restricted. For example, Leiden 0 consists of cells in the top part of the tissue (<em>i.e.</em>, the non-tumoral epithelium). Similarly, cluster 12 occupies the left-most region of the tissue.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true" href="">0</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false" href="">1</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false" href="">2</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-4" role="tab" aria-controls="tabset-3-4" aria-selected="false" href="">3</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-5" role="tab" aria-controls="tabset-3-5" aria-selected="false" href="">4</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-6" role="tab" aria-controls="tabset-3-6" aria-selected="false" href="">5</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-7" role="tab" aria-controls="tabset-3-7" aria-selected="false" href="">6</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-8" role="tab" aria-controls="tabset-3-8" aria-selected="false" href="">7</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-9-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-9" role="tab" aria-controls="tabset-3-9" aria-selected="false" href="">8</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-10-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-10" role="tab" aria-controls="tabset-3-10" aria-selected="false" href="">9</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-11-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-11" role="tab" aria-controls="tabset-3-11" aria-selected="false" href="">10</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-12-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-12" role="tab" aria-controls="tabset-3-12" aria-selected="false" href="">11</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-13-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-13" role="tab" aria-controls="tabset-3-13" aria-selected="false" href="">12</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-14-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-14" role="tab" aria-controls="tabset-3-14" aria-selected="false" href="">13</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-15-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-15" role="tab" aria-controls="tabset-3-15" aria-selected="false" href="">14</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-16-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-16" role="tab" aria-controls="tabset-3-16" aria-selected="false" href="">15</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_0.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_0.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_1.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_1.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_2.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_2.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-4-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_3.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_3.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-5-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_4.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_4.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-6-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_5.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_5.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-7-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_6.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_6.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-8-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_7.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_7.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-9" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-9-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_8.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_8.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-10" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-10-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_9.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_9.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-11" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-11-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_10.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_10.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-12" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-12-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_11.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_11.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-13" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-13-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_12.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_12.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-14" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-14-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_13.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_13.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-15" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-15-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_14.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_14.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-16" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-16-tab">
<div class="{columns}">
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__spatial__S0__facet_15.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column" style="width:10%;">

</div>
<div class="column" style="width:40%;">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="./assets/analysis_results/preprocessing/leiden__umap_pr__S0__facet_15.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="conclusion" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">4.4</span> Conclusion</h2>
<p>And with that, we’ve navigated the essential pre-processing steps. Starting with our quality-controlled cell data, we applied normalization to account for technical variations, identified the most informative genes, and used PCA to reduce the data’s dimensionality. Building upon this foundation, we generated UMAP embeddings for visualization and performed Leiden clustering to partition the cells into distinct groups based on their expression profiles.</p>
<p>The interactive exploration highlighted a critical point: parameters matter. Choices made during normalization, dimensionality reduction, and clustering significantly influence the final UMAP layout and cluster assignments. There isn’t a single “correct” set of parameters, but understanding their effects allows you to tailor the analysis to best reveal the biological structures relevant to your specific questions.</p>
<p>The resulting AnnData object, now enriched with normalized data layers, PCA coordinates, UMAP embeddings, and Leiden cluster labels, is primed for the next crucial phase: assigning biological meaning to these patterns. In the following chapters we will delve into grouping cells based on their spatial domain and their cell types.</p>


<!-- -->

<script type="webr-data">
eyJvcHRpb25zIjp7ImJhc2VVcmwiOiJodHRwczovL3dlYnIuci13YXNtLm9yZy92MC41LjQvIn0sInBhY2thZ2VzIjp7InBrZ3MiOlsiZXZhbHVhdGUiLCJrbml0ciIsImh0bWx0b29scyIsImRwbHlyIiwiZHVja2RiIl0sInJlcG9zIjpbImh0dHBzOi8vci1saWIuci11bml2ZXJzZS5kZXYiXX0sInJlbmRlcl9kZiI6ImRlZmF1bHQifQ==
</script>
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W3siY2VsbE5hbWUiOiJ3ZWJyLXdpZGdldC0zIiwiaW5saW5lIjpmYWxzZSwibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoie1xuICAvLyBXYWl0IGZvciBvdXRwdXQgdG8gYmUgd3JpdHRlbiB0byB0aGUgRE9NLCB0aGVuIHRyaWdnZXIgd2lkZ2V0IHJlbmRlcmluZ1xuICBhd2FpdCBfd2Vicl92YWx1ZV8zO1xuICBpZiAod2luZG93LkhUTUxXaWRnZXRzKSB7XG4gICAgd2luZG93LkhUTUxXaWRnZXRzLnN0YXRpY1JlbmRlcigpO1xuICB9XG4gIGlmICh3aW5kb3cuUGFnZWRUYWJsZURvYykge1xuICAgIHdpbmRvdy5QYWdlZFRhYmxlRG9jLmluaXRBbGwoKTtcbiAgfVxufVxuIn0seyJjZWxsTmFtZSI6IndlYnItMyIsImlubGluZSI6ZmFsc2UsIm1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJzb3VyY2UiOiJ2aWV3b2YgX3dlYnJfZWRpdG9yXzMgPSB7XG4gIGNvbnN0IHsgV2ViUkV4ZXJjaXNlRWRpdG9yLCBiNjREZWNvZGUgfSA9IHdpbmRvdy5fZXhlcmNpc2Vfb2pzX3J1bnRpbWU7XG4gIGNvbnN0IHNjcmlwdENvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwid2Vici0zLWNvbnRlbnRzXFxcIl1gKS50ZXh0Q29udGVudDtcbiAgY29uc3QgYmxvY2sgPSBKU09OLnBhcnNlKGI2NERlY29kZShzY3JpcHRDb250ZW50KSk7XG5cbiAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBpZDogYHdlYnItMy1jb250ZW50c2AgfSwgYmxvY2suYXR0cik7XG4gIGNvbnN0IGVkaXRvciA9IG5ldyBXZWJSRXhlcmNpc2VFZGl0b3Iod2ViUk9qcy53ZWJSUHJvbWlzZSwgYmxvY2suY29kZSwgb3B0aW9ucyk7XG5cbiAgcmV0dXJuIGVkaXRvci5jb250YWluZXI7XG59XG5fd2Vicl92YWx1ZV8zID0gd2ViUk9qcy5wcm9jZXNzKF93ZWJyX2VkaXRvcl8zLCB7cXVlcnlfZGF0YSwgcWNfZmxhZ3NfZGF0YX0pO1xuIn0seyJjZWxsTmFtZSI6IndlYnItd2lkZ2V0LTIiLCJpbmxpbmUiOmZhbHNlLCJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJ7XG4gIC8vIFdhaXQgZm9yIG91dHB1dCB0byBiZSB3cml0dGVuIHRvIHRoZSBET00sIHRoZW4gdHJpZ2dlciB3aWRnZXQgcmVuZGVyaW5nXG4gIGF3YWl0IF93ZWJyX3ZhbHVlXzI7XG4gIGlmICh3aW5kb3cuSFRNTFdpZGdldHMpIHtcbiAgICB3aW5kb3cuSFRNTFdpZGdldHMuc3RhdGljUmVuZGVyKCk7XG4gIH1cbiAgaWYgKHdpbmRvdy5QYWdlZFRhYmxlRG9jKSB7XG4gICAgd2luZG93LlBhZ2VkVGFibGVEb2MuaW5pdEFsbCgpO1xuICB9XG59XG4ifSx7ImNlbGxOYW1lIjoid2Vici0yIiwiaW5saW5lIjpmYWxzZSwibWV0aG9kTmFtZSI6ImludGVycHJldCIsInNvdXJjZSI6Il93ZWJyX3ZhbHVlXzIgPSB7XG4gIGNvbnN0IHsgaGlnaGxpZ2h0UiwgYjY0RGVjb2RlIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuICBjb25zdCBzY3JpcHRDb250ZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihgc2NyaXB0W3R5cGU9XFxcIndlYnItMi1jb250ZW50c1xcXCJdYCkudGV4dENvbnRlbnQ7XG4gIGNvbnN0IGJsb2NrID0gSlNPTi5wYXJzZShiNjREZWNvZGUoc2NyaXB0Q29udGVudCkpO1xuXG4gIC8vIERlZmF1bHQgZXZhbHVhdGlvbiBjb25maWd1cmF0aW9uXG4gIGNvbnN0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHtcbiAgICBpZDogXCJ3ZWJyLTItY29udGVudHNcIixcbiAgICBlY2hvOiB0cnVlLFxuICAgIG91dHB1dDogdHJ1ZVxuICB9LCBibG9jay5hdHRyKTtcblxuICAvLyBFdmFsdWF0ZSB0aGUgcHJvdmlkZWQgUiBjb2RlXG4gIGNvbnN0IHJlc3VsdCA9IHdlYlJPanMucHJvY2Vzcyh7Y29kZTogYmxvY2suY29kZSwgb3B0aW9uc30sIHtxY19sZXZlbCwgbl9wY3MsIG5fbmVpZ2hib3JzLCBtZXRyaWMsIG1kaXN0LCBzcHJlYWQsIGNvbG9yYnl9KTtcblxuICAvLyBFYXJseSB5aWVsZCB3aGlsZSB3ZSB3YWl0IGZvciB0aGUgZmlyc3QgZXZhbHVhdGlvbiBhbmQgcmVuZGVyXG4gIGlmIChvcHRpb25zLm91dHB1dCAmJiAhKFwiMlwiIGluIHdlYlJPanMucmVuZGVyZWRPanMpKSB7XG4gICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICBjb25zdCBzcGlubmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcblxuICAgIGlmIChvcHRpb25zLmVjaG8pIHtcbiAgICAgIC8vIFNob3cgb3V0cHV0IGFzIGhpZ2hsaWdodGVkIHNvdXJjZVxuICAgICAgY29uc3QgcHJlRWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJwcmVcIik7XG4gICAgICBjb250YWluZXIuY2xhc3NOYW1lID0gXCJzb3VyY2VDb2RlXCI7XG4gICAgICBwcmVFbGVtLmNsYXNzTmFtZSA9IFwic291cmNlQ29kZSByXCI7XG4gICAgICBwcmVFbGVtLmFwcGVuZENoaWxkKGhpZ2hsaWdodFIoYmxvY2suY29kZSkpO1xuICAgICAgc3Bpbm5lci5jbGFzc05hbWUgPSBcInNwaW5uZXItZ3JvdyBzcGlubmVyLWdyb3ctc20gbS0yIHBvc2l0aW9uLWFic29sdXRlIHRvcC0wIGVuZC0wXCI7XG4gICAgICBwcmVFbGVtLmFwcGVuZENoaWxkKHNwaW5uZXIpO1xuICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHByZUVsZW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBzcGlubmVyLmNsYXNzTmFtZSA9IFwic3Bpbm5lci1ib3JkZXIgc3Bpbm5lci1ib3JkZXItc21cIjtcbiAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChzcGlubmVyKTtcbiAgICB9XG5cbiAgICB5aWVsZCBjb250YWluZXI7XG4gIH1cblxuICB3ZWJST2pzLnJlbmRlcmVkT2pzW1wiMlwiXSA9IHRydWU7XG4gIHlpZWxkIGF3YWl0IHJlc3VsdDtcbn1cbiJ9LHsiY2VsbE5hbWUiOiJ3ZWJyLXdpZGdldC0xIiwiaW5saW5lIjpmYWxzZSwibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoie1xuICAvLyBXYWl0IGZvciBvdXRwdXQgdG8gYmUgd3JpdHRlbiB0byB0aGUgRE9NLCB0aGVuIHRyaWdnZXIgd2lkZ2V0IHJlbmRlcmluZ1xuICBhd2FpdCBfd2Vicl92YWx1ZV8xO1xuICBpZiAod2luZG93LkhUTUxXaWRnZXRzKSB7XG4gICAgd2luZG93LkhUTUxXaWRnZXRzLnN0YXRpY1JlbmRlcigpO1xuICB9XG4gIGlmICh3aW5kb3cuUGFnZWRUYWJsZURvYykge1xuICAgIHdpbmRvdy5QYWdlZFRhYmxlRG9jLmluaXRBbGwoKTtcbiAgfVxufVxuIn0seyJjZWxsTmFtZSI6IndlYnItMSIsImlubGluZSI6ZmFsc2UsIm1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJzb3VyY2UiOiJfd2Vicl92YWx1ZV8xID0ge1xuICBjb25zdCB7IGhpZ2hsaWdodFIsIGI2NERlY29kZSB9ID0gd2luZG93Ll9leGVyY2lzZV9vanNfcnVudGltZTtcbiAgY29uc3Qgc2NyaXB0Q29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYHNjcmlwdFt0eXBlPVxcXCJ3ZWJyLTEtY29udGVudHNcXFwiXWApLnRleHRDb250ZW50O1xuICBjb25zdCBibG9jayA9IEpTT04ucGFyc2UoYjY0RGVjb2RlKHNjcmlwdENvbnRlbnQpKTtcblxuICAvLyBEZWZhdWx0IGV2YWx1YXRpb24gY29uZmlndXJhdGlvblxuICBjb25zdCBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7XG4gICAgaWQ6IFwid2Vici0xLWNvbnRlbnRzXCIsXG4gICAgZWNobzogdHJ1ZSxcbiAgICBvdXRwdXQ6IHRydWVcbiAgfSwgYmxvY2suYXR0cik7XG5cbiAgLy8gRXZhbHVhdGUgdGhlIHByb3ZpZGVkIFIgY29kZVxuICBjb25zdCByZXN1bHQgPSB3ZWJST2pzLnByb2Nlc3Moe2NvZGU6IGJsb2NrLmNvZGUsIG9wdGlvbnN9LCB7fSk7XG5cbiAgLy8gRWFybHkgeWllbGQgd2hpbGUgd2Ugd2FpdCBmb3IgdGhlIGZpcnN0IGV2YWx1YXRpb24gYW5kIHJlbmRlclxuICBpZiAob3B0aW9ucy5vdXRwdXQgJiYgIShcIjFcIiBpbiB3ZWJST2pzLnJlbmRlcmVkT2pzKSkge1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgY29uc3Qgc3Bpbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG5cbiAgICBpZiAob3B0aW9ucy5lY2hvKSB7XG4gICAgICAvLyBTaG93IG91dHB1dCBhcyBoaWdobGlnaHRlZCBzb3VyY2VcbiAgICAgIGNvbnN0IHByZUVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwicHJlXCIpO1xuICAgICAgY29udGFpbmVyLmNsYXNzTmFtZSA9IFwic291cmNlQ29kZVwiO1xuICAgICAgcHJlRWxlbS5jbGFzc05hbWUgPSBcInNvdXJjZUNvZGUgclwiO1xuICAgICAgcHJlRWxlbS5hcHBlbmRDaGlsZChoaWdobGlnaHRSKGJsb2NrLmNvZGUpKTtcbiAgICAgIHNwaW5uZXIuY2xhc3NOYW1lID0gXCJzcGlubmVyLWdyb3cgc3Bpbm5lci1ncm93LXNtIG0tMiBwb3NpdGlvbi1hYnNvbHV0ZSB0b3AtMCBlbmQtMFwiO1xuICAgICAgcHJlRWxlbS5hcHBlbmRDaGlsZChzcGlubmVyKTtcbiAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChwcmVFbGVtKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3Bpbm5lci5jbGFzc05hbWUgPSBcInNwaW5uZXItYm9yZGVyIHNwaW5uZXItYm9yZGVyLXNtXCI7XG4gICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoc3Bpbm5lcik7XG4gICAgfVxuXG4gICAgeWllbGQgY29udGFpbmVyO1xuICB9XG5cbiAgd2ViUk9qcy5yZW5kZXJlZE9qc1tcIjFcIl0gPSB0cnVlO1xuICB5aWVsZCBhd2FpdCByZXN1bHQ7XG59XG4ifSx7ImNlbGxOYW1lIjoid2Vici1wcmVsdWRlIiwiaW5saW5lIjpmYWxzZSwibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoid2ViUk9qcyA9IHtcbiAgY29uc3QgeyBXZWJSLCBDaGFubmVsVHlwZSB9ID0gd2luZG93Ll9leGVyY2lzZV9vanNfcnVudGltZS5XZWJSO1xuICBjb25zdCB7XG4gICAgV2ViUkV2YWx1YXRvcixcbiAgICBXZWJSRW52aXJvbm1lbnRNYW5hZ2VyLFxuICAgIHNldHVwUixcbiAgICBiNjREZWNvZGUsXG4gICAgY29sbGFwc2VQYXRoXG4gIH0gPSB3aW5kb3cuX2V4ZXJjaXNlX29qc19ydW50aW1lO1xuXG4gIGNvbnN0IHN0YXR1c0NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZXhlcmNpc2UtbG9hZGluZy1zdGF0dXNcIik7XG4gIGNvbnN0IGluZGljYXRvckNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZXhlcmNpc2UtbG9hZGluZy1pbmRpY2F0b3JcIik7XG4gIGluZGljYXRvckNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKFwiZC1ub25lXCIpO1xuXG4gIGxldCBzdGF0dXNUZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKVxuICBzdGF0dXNUZXh0LmNsYXNzTGlzdCA9IFwiZXhlcmNpc2UtbG9hZGluZy1kZXRhaWxzXCI7XG4gIHN0YXR1c1RleHQgPSBzdGF0dXNDb250YWluZXIuYXBwZW5kQ2hpbGQoc3RhdHVzVGV4dCk7XG4gIHN0YXR1c1RleHQudGV4dENvbnRlbnQgPSBgSW5pdGlhbGlzZWA7XG5cbiAgLy8gSG9pc3QgaW5kaWNhdG9yIG91dCBmcm9tIGZpbmFsIHNsaWRlIHdoZW4gcnVubmluZyB1bmRlciByZXZlYWxcbiAgY29uc3QgcmV2ZWFsU3RhdHVzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5yZXZlYWwgLmV4ZXJjaXNlLWxvYWRpbmctaW5kaWNhdG9yXCIpO1xuICBpZiAocmV2ZWFsU3RhdHVzKSB7XG4gICAgcmV2ZWFsU3RhdHVzLnJlbW92ZSgpO1xuICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucmV2ZWFsID4gLnNsaWRlc1wiKS5hcHBlbmRDaGlsZChyZXZlYWxTdGF0dXMpO1xuICB9XG5cbiAgLy8gTWFrZSBhbnkgcmV2ZWFsIHNsaWRlcyB3aXRoIGxpdmUgY2VsbHMgc2Nyb2xsYWJsZVxuICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLnJldmVhbCAuZXhlcmNpc2UtY2VsbFwiKS5mb3JFYWNoKChlbCkgPT4ge1xuICAgIGVsLmNsb3Nlc3QoJ3NlY3Rpb24uc2xpZGUnKS5jbGFzc0xpc3QuYWRkKFwic2Nyb2xsYWJsZVwiKTtcbiAgfSlcblxuICAvLyB3ZWJSIHN1cHBsZW1lbnRhbCBkYXRhIGFuZCBvcHRpb25zXG4gIGNvbnN0IGRhdGFDb250ZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihgc2NyaXB0W3R5cGU9XFxcIndlYnItZGF0YVxcXCJdYCkudGV4dENvbnRlbnQ7XG4gIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGI2NERlY29kZShkYXRhQ29udGVudCkpO1xuXG4gIC8vIEdyYWIgbGlzdCBvZiByZXNvdXJjZXMgdG8gYmUgZG93bmxvYWRlZFxuICBjb25zdCBmaWxlc0NvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBzY3JpcHRbdHlwZT1cXFwidmZzLWZpbGVcXFwiXWApLnRleHRDb250ZW50O1xuICBjb25zdCBmaWxlcyA9IEpTT04ucGFyc2UoYjY0RGVjb2RlKGZpbGVzQ29udGVudCkpO1xuXG4gIC8vIFVzZSBQb3N0TWVzc2FnZSBjaGFubmVsIGZvciBhc3luYyBjb21tdW5pY2F0aW9uXG4gIC8vIFdlIGRvIG5vdCBleHBlY3QgdG8gdGFrZSBuZXN0ZWQgcHJvbXB0IGlucHV0IGluIFF1YXJ0byBMaXZlIGNlbGxzXG4gIGRhdGEub3B0aW9ucy5jaGFubmVsVHlwZSA9IENoYW5uZWxUeXBlLlBvc3RNZXNzYWdlO1xuXG4gIC8vIEluaXRpYWxpc2Ugd2ViUiBhbmQgc2V0dXAgZm9yIFIgY29kZSBldmFsdWF0aW9uXG4gIGxldCB3ZWJSUHJvbWlzZSA9IChhc3luYyAod2ViUikgPT4ge1xuICAgIHN0YXR1c1RleHQudGV4dENvbnRlbnQgPSBgRG93bmxvYWRpbmcgd2ViUmA7XG4gICAgYXdhaXQgd2ViUi5pbml0KCk7XG5cbiAgICAvLyBJbnN0YWxsIHByb3ZpZGVkIGxpc3Qgb2YgcGFja2FnZXNcbiAgICAvLyBFbnN1cmUgd2ViUiBkZWZhdWx0IHJlcG8gaXMgaW5jbHVkZWRcbiAgICBkYXRhLnBhY2thZ2VzLnJlcG9zLnB1c2goXCJodHRwczovL3JlcG8uci13YXNtLm9yZ1wiKVxuICAgIGF3YWl0IGRhdGEucGFja2FnZXMucGtncy5tYXAoKHBrZykgPT4gKCkgPT4ge1xuICAgICAgc3RhdHVzVGV4dC50ZXh0Q29udGVudCA9IGBEb3dubG9hZGluZyBwYWNrYWdlOiAke3BrZ31gO1xuICAgICAgcmV0dXJuIHdlYlIuZXZhbFJWb2lkKGBcbiAgICAgICAgd2Vicjo6aW5zdGFsbChwa2csIHJlcG9zID0gcmVwb3MpXG4gICAgICAgIGxpYnJhcnkocGtnLCBjaGFyYWN0ZXIub25seSA9IFRSVUUpXG4gICAgICBgLCB7IGVudjoge1xuICAgICAgICBwa2c6IHBrZyxcbiAgICAgICAgcmVwb3M6IGRhdGEucGFja2FnZXMucmVwb3MsXG4gICAgICB9fSk7XG4gICAgfSkucmVkdWNlKChjdXIsIG5leHQpID0+IGN1ci50aGVuKG5leHQpLCBQcm9taXNlLnJlc29sdmUoKSk7XG5cbiAgICAvLyBEb3dubG9hZCBhbmQgaW5zdGFsbCByZXNvdXJjZXNcbiAgICBhd2FpdCBmaWxlcy5tYXAoKGZpbGUpID0+IGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG5hbWUgPSBmaWxlLnN1YnN0cmluZyhmaWxlLmxhc3RJbmRleE9mKCcvJykgKyAxKTtcbiAgICAgIHN0YXR1c1RleHQudGV4dENvbnRlbnQgPSBgRG93bmxvYWRpbmcgcmVzb3VyY2U6ICR7bmFtZX1gO1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChmaWxlKTtcbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW4ndCBkb3dubG9hZCBcXGAke2ZpbGV9XFxgLiBFcnJvciAke3Jlc3BvbnNlLnN0YXR1c306IFwiJHtyZXNwb25zZS5zdGF0dXNUZXh0fVwiLmApO1xuICAgICAgfVxuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmFycmF5QnVmZmVyKCk7XG5cbiAgICAgIC8vIFN0b3JlIFVSTHMgaW4gdGhlIGN3ZCB3aXRob3V0IGFueSBzdWJkaXJlY3Rvcnkgc3RydWN0dXJlXG4gICAgICBpZiAoZmlsZS5pbmNsdWRlcyhcIjovL1wiKSkge1xuICAgICAgICBmaWxlID0gbmFtZTtcbiAgICAgIH1cblxuICAgICAgLy8gQ29sbGFwc2UgaGlnaGVyIGRpcmVjdG9yeSBzdHJ1Y3R1cmVcbiAgICAgIGZpbGUgPSBjb2xsYXBzZVBhdGgoZmlsZSk7XG5cbiAgICAgIC8vIENyZWF0ZSBkaXJlY3RvcnkgdHJlZSwgaWdub3JpbmcgXCJkaXJlY3RvcnkgZXhpc3RzXCIgVkZTIGVycm9yc1xuICAgICAgY29uc3QgcGFydHMgPSBmaWxlLnNwbGl0KCcvJykuc2xpY2UoMCwgLTEpO1xuICAgICAgbGV0IHBhdGggPSAnJztcbiAgICAgIHdoaWxlIChwYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHBhdGggKz0gcGFydHMuc2hpZnQoKSArICcvJztcbiAgICAgICAgY29uc3QgYW5hbHlzaXMgPSBhd2FpdCB3ZWJSLkZTLmFuYWx5emVQYXRoKHBhdGgpO1xuICAgICAgICBpZiAoIWFuYWx5c2lzLmV4aXN0cykge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB3ZWJSLkZTLm1rZGlyKHBhdGgpO1xuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZXN5c3RlbSBFcnJvcjogXCIke2UubWVzc2FnZX1cIi5gKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gV3JpdGUgdGhpcyBmaWxlIHRvIHRoZSBWRlNcbiAgICAgIHJldHVybiBhd2FpdCB3ZWJSLkZTLndyaXRlRmlsZShmaWxlLCBuZXcgVWludDhBcnJheShkYXRhKSk7XG4gICAgfSkucmVkdWNlKChjdXIsIG5leHQpID0+IGN1ci50aGVuKG5leHQpLCBQcm9taXNlLnJlc29sdmUoKSk7XG5cbiAgICBzdGF0dXNUZXh0LnRleHRDb250ZW50ID0gYEluc3RhbGxpbmcgd2ViUiBzaGltc2A7XG4gICAgYXdhaXQgd2ViUi5ldmFsUlZvaWQoYHdlYnI6OnNoaW1faW5zdGFsbCgpYCk7XG5cbiAgICBzdGF0dXNUZXh0LnRleHRDb250ZW50ID0gYFdlYlIgZW52aXJvbm1lbnQgc2V0dXBgO1xuICAgIGF3YWl0IHNldHVwUih3ZWJSLCBkYXRhKTtcblxuICAgIHN0YXR1c1RleHQucmVtb3ZlKCk7XG4gICAgaWYgKHN0YXR1c0NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPT0gMCkge1xuICAgICAgc3RhdHVzQ29udGFpbmVyLnBhcmVudE5vZGUucmVtb3ZlKCk7XG4gICAgfVxuICAgIHJldHVybiB3ZWJSO1xuICB9KShuZXcgV2ViUihkYXRhLm9wdGlvbnMpKTtcblxuICAvLyBLZWVwIHRyYWNrIG9mIGluaXRpYWwgT0pTIGJsb2NrIHJlbmRlclxuICBjb25zdCByZW5kZXJlZE9qcyA9IHt9O1xuXG4gIGNvbnN0IHByb2Nlc3MgPSBhc3luYyAoY29udGV4dCwgaW5wdXRzKSA9PiB7XG4gICAgY29uc3Qgd2ViUiA9IGF3YWl0IHdlYlJQcm9taXNlO1xuICAgIGNvbnN0IGV2YWx1YXRvciA9IG5ldyBXZWJSRXZhbHVhdG9yKHdlYlIsIGNvbnRleHQpXG4gICAgYXdhaXQgZXZhbHVhdG9yLnByb2Nlc3MoaW5wdXRzKTtcbiAgICByZXR1cm4gZXZhbHVhdG9yLmNvbnRhaW5lcjtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgcHJvY2VzcyxcbiAgICB3ZWJSUHJvbWlzZSxcbiAgICByZW5kZXJlZE9qcyxcbiAgfTtcbn1cbiJ9XX0=
</script>
<div id="exercise-loading-indicator" class="exercise-loading-indicator d-none d-flex align-items-center gap-2">
<div id="exercise-loading-status" class="d-flex gap-2">

</div>
<div class="spinner-grow spinner-grow-sm">

</div>
</div>
<script type="vfs-file">
WyJhc3NldHMvaW50ZXJhY3RpdmVzL3VtYXBfZXhwbG9yZS5wYXJxdWV0IiwiYXNzZXRzL2ludGVyYWN0aXZlcy91bWFwX2V4cGxvcmVfcWNfZmxhZ3MucGFycXVldCJd
</script>
<div id="refs" class="references csl-bib-body" data-entry-spacing="0" data-line-spacing="2" role="list" style="display: none">
<div id="ref-Hafemeister2019" class="csl-entry" role="listitem">
<div class="csl-left-margin">1. </div><div class="csl-right-inline">Hafemeister, C. &amp; Satija, R. Normalization and variance stabilization of single-cell <span class="nocase">RNA-seq</span> data using regularized negative binomial regression. <em>Genome Biol.</em> <strong>20</strong>, 296 (2019).</div>
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>when I tried using the <code>sc.experimental.pp.normalize_pearson_residuals</code> method on this dataset, the OS crashed (&gt;200 GBs of RAM).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>To see how to generate this type of output, click the <code>&lt;/&gt;</code> icon on the top right of this chapter and then click <code>view source</code>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W3sibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InZpZXdvZiBxY19sZXZlbCA9IElucHV0cy5yYWRpbyhbXCJubyBRQyBmaWx0ZXJcIiwgXCJpbmNsdWRlIEZPViBRQyBjZWxsc1wiLCBcImZpbHRlciBhbGwgZmxhZ3NcIl0sIHtsYWJlbDogXCJRQyBMZXZlbFwiLCB2YWx1ZTogXCJpbmNsdWRlIEZPViBRQyBjZWxsc1wifSlcbnZpZXdvZiBuX3BjcyA9IElucHV0cy5yYWRpbyhbMTAsIDIwLCAzMCwgNDAsIDUwXSwge2xhYmVsOiBcIlBDc1wiLCB2YWx1ZTogMzB9KVxudmlld29mIG5fbmVpZ2hib3JzID0gSW5wdXRzLnJhZGlvKFsxNSwgMzAsIDUwXSwge2xhYmVsOiBcIk5laWdoYm9yc1wiLCB2YWx1ZTogMzB9KVxudmlld29mIG1ldHJpYyA9IElucHV0cy5yYWRpbyhbXCJldWNsaWRlYW5cIiwgXCJjb3NpbmVcIl0sIHtsYWJlbDogXCJNZXRyaWNcIiwgdmFsdWU6IFwiY29zaW5lXCJ9KVxudmlld29mIG1kaXN0ID0gSW5wdXRzLnJhZGlvKFswLjAxLCAwLjA1LCAwLjIsIDAuNV0sIHtsYWJlbDogXCJNaW4uIGRpc3RhbmNlXCIsIHZhbHVlOiAwLjJ9KVxudmlld29mIHNwcmVhZCA9IElucHV0cy5yYWRpbyhbMC41LCAxLjAsIDIuMF0sIHtsYWJlbDogXCJTcHJlYWRcIiwgdmFsdWU6IDIuMH0pXG52aWV3b2YgY29sb3JieSA9IElucHV0cy5yYWRpbyhbXCJRQ1wiLCBcIkxlaWRlblwiXSwge2xhYmVsOiBcIkNvbG9yIGJ5XCIsIHZhbHVlOiBcIlFDXCJ9KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0yIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG4vLyBEZWZpbmUgdGhlIG1lYW5pbmcgb2YgZWFjaCBiaXRcbnFjTWFza3MgPSAoe1xuICBMT1dfQ09VTlRTOiAxIDw8IDAsIFxuICBISUdIX0NPVU5UUzogMSA8PCAxLCBcbiAgTE9XX0ZFQVQ6IDEgPDwgMixcbiAgSElHSF9GRUFUOiAxIDw8IDMsIFxuICBMT1dfU1BMSVQ6IDEgPDwgNCwgXG4gIEZPVl9RQzogMSA8PCA1LCBcbiAgTE9XX1NCUjogMSA8PCA2XG59KVxuXG5mbGFnTmFtZXMgPSBPYmplY3Qua2V5cyhxY01hc2tzKS5zb3J0KChhLCBiKSA9PiBxY01hc2tzW2FdIC0gcWNNYXNrc1tiXSk7XG5xY0ZsYWdNYXAgPSBuZXcgTWFwKHFjX2ZsYWdzX2RhdGEubWFwKGQgPT4gW2QuY2VsbF9pZCwgZC5xY2ZsYWddKSk7XG5cbmZsYWdDb2xvcnMgPSB7XG4gIGNvbnN0IHVuaXF1ZUZsYWdzSW5EYXRhID0gQXJyYXkuZnJvbShuZXcgU2V0KHFjX2ZsYWdzX2RhdGEubWFwKGQgPT4gZC5xY2ZsYWcpKSkuc29ydCgoYSwgYikgPT4gYSAtIGIpO1xuICBjb25zdCB1bmlxdWVGbGFnc1dpdGhaZXJvID0gQXJyYXkuZnJvbShuZXcgU2V0KFswLCAuLi51bmlxdWVGbGFnc0luRGF0YV0pKS5zb3J0KChhLGIpPT4gYS1iKTtcbiAgY29uc3QgY29sb3JzID0gZDMuc2NoZW1lVGFibGVhdTEwO1xuICBjb25zdCBtYXAgPSB7fTtcbiAgbGV0IGNvbG9ySW5kZXggPSAwO1xuICB1bmlxdWVGbGFnc1dpdGhaZXJvLmZvckVhY2goZmxhZ1ZhbHVlID0+IHtcbiAgICBpZiAoZmxhZ1ZhbHVlID09PSAwKSB7IG1hcFtmbGFnVmFsdWVdID0gXCJibGFja1wiOyB9XG4gICAgZWxzZSB7IG1hcFtmbGFnVmFsdWVdID0gY29sb3JzW2NvbG9ySW5kZXgrKyAlIGNvbG9ycy5sZW5ndGhdOyB9XG4gIH0pO1xuICByZXR1cm4gbWFwO1xufVxuXG5xY0NvbG9yU2NhbGUgPSAoZmxhZ1ZhbHVlKSA9PiBmbGFnQ29sb3JzW2ZsYWdWYWx1ZSA/PyAwXTtcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxucWNGbGFnTGVnZW5kID0ge1xuICB0cnkge1xuICAgIGNvbnN0IHVuaXF1ZUZsYWdzV2l0aFplcm8gPSBPYmplY3Qua2V5cyhmbGFnQ29sb3JzKS5tYXAoTnVtYmVyKS5zb3J0KChhLGIpPT4gYS1iKTtcbiAgICBjb25zdCB0YWJsZVJvd3MgPSB1bmlxdWVGbGFnc1dpdGhaZXJvLm1hcChmbGFnVmFsdWUgPT4ge1xuICAgICAgY29uc3QgZmxhZ0NvbG9yID0gZmxhZ0NvbG9yc1tmbGFnVmFsdWVdOyAvLyBVc2Ugc3RhdGljIG1hcFxuICAgICAgY29uc3QgY2lyY2xlcyA9IGZsYWdOYW1lcy5tYXAobmFtZSA9PiB7XG4gICAgICAgICBjb25zdCBtYXNrID0gcWNNYXNrc1tuYW1lXTtcbiAgICAgICAgIGNvbnN0IGlzU2V0ID0gKGZsYWdWYWx1ZSAmIG1hc2spID4gMDtcbiAgICAgICAgIGNvbnN0IGNpcmNsZUZpbGwgPSBpc1NldCA/IGZsYWdDb2xvciA6IFwiI2UwZTBlMFwiO1xuICAgICAgICAgY29uc3QgY2lyY2xlU3ZnID0gYDxzdmcgd2lkdGg9XCIxNVwiIGhlaWdodD1cIjE1XCI+PGNpcmNsZSBjeD1cIjcuNVwiIGN5PVwiNy41XCIgcj1cIjZcIiBmaWxsPVwiJHtjaXJjbGVGaWxsfVwiIHN0cm9rZT1cIiR7aXNTZXQgPyAnYmxhY2snIDogJyNjY2MnfVwiIHN0cm9rZS13aWR0aD1cIjFcIj48L2NpcmNsZT48L3N2Zz5gO1xuICAgICAgICAgcmV0dXJuIGA8dGQgc3R5bGU9XCJ0ZXh0LWFsaWduOiBjZW50ZXI7XCI+JHtjaXJjbGVTdmd9PC90ZD5gO1xuICAgICAgfSkuam9pbignJyk7XG4gICAgICBjb25zdCByb3dIZWFkZXIgPSBgPHRoIHNjb3BlPVwicm93XCIgc3R5bGU9XCJ0ZXh0LWFsaWduOiByaWdodDsgcGFkZGluZy1yaWdodDogMTBweDsgd2hpdGUtc3BhY2U6IG5vd3JhcDtcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIHN0eWxlPVwiZGlzcGxheTogaW5saW5lLWJsb2NrOyB3aWR0aDogMTJweDsgaGVpZ2h0OiAxMnB4OyBiYWNrZ3JvdW5kLWNvbG9yOiAke2ZsYWdDb2xvcn07IGJvcmRlcjogMXB4IHNvbGlkICM1NTU7IG1hcmdpbi1yaWdodDogNXB4OyB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlO1wiPjwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICR7ZmxhZ1ZhbHVlID09PSAwID8gJ1Bhc3NlZCcgOiBmbGFnVmFsdWV9XG4gICAgICAgICAgICAgICAgICAgICAgICAgPC90aD5gO1xuICAgICAgcmV0dXJuIGA8dHI+JHtyb3dIZWFkZXJ9JHtjaXJjbGVzfTwvdHI+YDtcbiAgICB9KS5qb2luKCcnKTtcbiAgICBjb25zdCBoZWFkZXJDZWxscyA9IGZsYWdOYW1lcy5tYXAobmFtZSA9PlxuICAgICAgYDx0aCBzdHlsZT1cImhlaWdodDogMTAwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsgdmVydGljYWwtYWxpZ246IGJvdHRvbTsgcGFkZGluZy1ib3R0b206IDVweDsgZm9udC1zaXplOiAwLjhlbTsgd2hpdGUtc3BhY2U6IG5vd3JhcDtcIj5cbiAgICAgICAgIDxzcGFuIHN0eWxlPVwid3JpdGluZy1tb2RlOiB2ZXJ0aWNhbC1scjsgdHJhbnNmb3JtOiByb3RhdGUoMTgwZGVnKTtcIj4ke25hbWUucmVwbGFjZSgvXy9nLCAnICcpfTwvc3Bhbj5cbiAgICAgICA8L3RoPmBcbiAgICApLmpvaW4oJycpO1xuICAgIGNvbnN0IHRhYmxlSGVhZGVyID0gYDx0aGVhZD48dHI+PHRoIHN0eWxlPVwidmVydGljYWwtYWxpZ246IGJvdHRvbTtcIj5GbGFnIFZhbHVlPC90aD4ke2hlYWRlckNlbGxzfTwvdHI+PC90aGVhZD5gO1xuICAgIHJldHVybiBodG1sYDx0YWJsZSBzdHlsZT1cImJvcmRlci1jb2xsYXBzZTogY29sbGFwc2U7IG1hcmdpbi10b3A6IDEwcHg7IGZvbnQtc2l6ZTogMC45ZW07IHRhYmxlLWxheW91dDogZml4ZWQ7XCI+XG4gICAgICAgICAgICAgICAgICAgJHt0YWJsZUhlYWRlcn08dGJvZHk+JHt0YWJsZVJvd3N9PC90Ym9keT5cbiAgICAgICAgICAgICAgICAgPC90YWJsZT5gO1xuICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGdlbmVyYXRpbmcgUUMgTGVnZW5kOlwiLCBlcnJvcik7XG4gICAgIHJldHVybiBodG1sYDxkaXY+RXJyb3IgZ2VuZXJhdGluZyBRQyBMZWdlbmQ8L2Rpdj5gO1xuICAgfVxufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC00IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5sZWlkZW5TY2FsZUFuZExlZ2VuZCA9IHtcbiAgbGV0IHNjYWxlLCBsZWdlbmQ7XG4gIHRyeSB7IC8vIEFkZCB0cnkuLi5jYXRjaFxuICAgIC8vIENoZWNrIGlmIHF1ZXJ5X2RhdGEgaXMgcmVhZHkgYW5kIGhhcyAnbGVpZGVuJ1xuICAgIGlmICghcXVlcnlfZGF0YSB8fCBxdWVyeV9kYXRhLmxlbmd0aCA9PT0gMCB8fCAhcXVlcnlfZGF0YVswXS5oYXNPd25Qcm9wZXJ0eSgnbGVpZGVuJykpIHtcbiAgICAgICAgY29uc29sZS53YXJuKFwiTGVpZGVuIGRhdGEgKHF1ZXJ5X2RhdGEpIG5vdCByZWFkeSBmb3IgbGVnZW5kL3NjYWxlLlwiKTtcbiAgICAgICAgc2NhbGUgPSBkMy5zY2FsZU9yZGluYWwoKS5kb21haW4oW1wiMFwiXSkucmFuZ2UoW1wiZ3JleVwiXSk7IC8vIFBsYWNlaG9sZGVyIHNjYWxlXG4gICAgICAgIGxlZ2VuZCA9IGh0bWxgPGRpdj48dWwgc3R5bGU9XCJsaXN0LXN0eWxlOiBub25lOyBwYWRkaW5nLWxlZnQ6IDA7IG1hcmdpbi10b3A6IDEwcHg7IGZvbnQtc2l6ZTogMC45ZW07XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8bGkgc3R5bGU9XCJtYXJnaW4tYm90dG9tOiAycHg7XCI+PHNwYW4gc3R5bGU9XCJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IHdpZHRoOiAxMnB4OyBoZWlnaHQ6IDEycHg7IGJhY2tncm91bmQtY29sb3I6IGdyZXk7IGJvcmRlcjogMXB4IHNvbGlkICM1NTU7IG1hcmdpbi1yaWdodDogNXB4OyB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlO1wiPjwvc3Bhbj4gQ2x1c3RlciAwPC9saT5cbiAgICAgICAgICAgICAgICAgICAgICA8L3VsPihMb2FkaW5nLi4uKTwvZGl2PmA7IC8vIHBsYWNlaG9sZGVyXG4gICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgdW5pcXVlQ2x1c3RlcnMgPSBBcnJheS5mcm9tKG5ldyBTZXQocXVlcnlfZGF0YS5tYXAoZCA9PiBkLmxlaWRlbikpKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7XG4gICAgICAgIHNjYWxlID0gZDMuc2NhbGVPcmRpbmFsKGQzLnNjaGVtZVRhYmxlYXUxMCkuZG9tYWluKHVuaXF1ZUNsdXN0ZXJzKTtcblxuICAgICAgICBjb25zdCBsZWdlbmRJdGVtcyA9IHVuaXF1ZUNsdXN0ZXJzLm1hcChjbHVzdGVyID0+IHtcbiAgICAgICAgICAgY29uc3QgY29sb3IgPSBzY2FsZShjbHVzdGVyKTtcbiAgICAgICAgICAgY29uc3QgY2x1c3RlckxhYmVsID0gU3RyaW5nKGNsdXN0ZXIpO1xuICAgICAgICAgICByZXR1cm4gYDxsaSBzdHlsZT1cIm1hcmdpbi1ib3R0b206IDJweDtcIj48c3BhbiBzdHlsZT1cImRpc3BsYXk6IGlubGluZS1ibG9jazsgd2lkdGg6IDEycHg7IGhlaWdodDogMTJweDsgYmFja2dyb3VuZC1jb2xvcjogJHtjb2xvcn07IGJvcmRlcjogMXB4IHNvbGlkICM1NTU7IG1hcmdpbi1yaWdodDogNXB4OyB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlO1wiPjwvc3Bhbj4gQ2x1c3RlciAke2NsdXN0ZXJMYWJlbH08L2xpPmA7XG4gICAgICAgIH0pLmpvaW4oJycpO1xuICAgICAgICBsZWdlbmQgPSBodG1sYDx1bCBzdHlsZT1cImxpc3Qtc3R5bGU6IG5vbmU7IHBhZGRpbmctbGVmdDogMDsgbWFyZ2luLXRvcDogMTBweDsgZm9udC1zaXplOiAwLjllbTtcIj4ke2xlZ2VuZEl0ZW1zfTwvdWw+YDtcbiAgICB9XG4gIH0gY2F0Y2goZXJyb3IpIHtcbiAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGdlbmVyYXRpbmcgTGVpZGVuIExlZ2VuZDpcIiwgZXJyb3IpO1xuICAgICBzY2FsZSA9ICgpID0+ICdncmV5JztcbiAgICAgbGVnZW5kID0gaHRtbGA8ZGl2PkVycm9yIGdlbmVyYXRpbmcgTGVpZGVuIExlZ2VuZDwvZGl2PmA7XG4gIH1cbiAgcmV0dXJuIHsgc2NhbGUsIGxlZ2VuZCB9O1xufVxuXG5sZWlkZW5Db2xvclNjYWxlID0gbGVpZGVuU2NhbGVBbmRMZWdlbmQuc2NhbGVcbmxlaWRlbkxlZ2VuZEh0bWwgPSBsZWlkZW5TY2FsZUFuZExlZ2VuZC5sZWdlbmRcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxuZDMgPSByZXF1aXJlKFwiZDNAN1wiKVxuXG53aWR0aCA9IDUwMFxuaGVpZ2h0ID0gNTAwXG5tYXJnaW5Ub3AgPSAyMFxubWFyZ2luUmlnaHQgPSAyMFxubWFyZ2luQm90dG9tID0gMzBcbm1hcmdpbkxlZnQgPSA0MFxuXG54U2NhbGUgPSBkMy5zY2FsZUxpbmVhcigpLmRvbWFpbihbMCwgMV0pLnJhbmdlKFttYXJnaW5MZWZ0LCB3aWR0aCAtIG1hcmdpblJpZ2h0XSlcbnlTY2FsZSA9IGQzLnNjYWxlTGluZWFyKCkuZG9tYWluKFswLCAxXSkucmFuZ2UoW2hlaWdodCAtIG1hcmdpbkJvdHRvbSwgbWFyZ2luVG9wXSlcblxuc3ZnID0gZDMuY3JlYXRlKFwic3ZnXCIpXG4gICAgLmF0dHIoXCJ3aWR0aFwiLCB3aWR0aClcbiAgICAuYXR0cihcImhlaWdodFwiLCBoZWlnaHQpXG4gICAgLmF0dHIoXCJ2aWV3Qm94XCIsIFswLCAwLCB3aWR0aCwgaGVpZ2h0XSlcbiAgICAuYXR0cihcInN0eWxlXCIsIFwibWF4LXdpZHRoOiAxMDAlOyBoZWlnaHQ6IGF1dG87XCIpO1xuXG54QXhpcyA9IGQzLmF4aXNCb3R0b20oeFNjYWxlKVxuICAgIC50aWNrcyh3aWR0aCAvIDgwKVxuICAgIC50aWNrU2l6ZU91dGVyKDApXG4gICAgLnRpY2tTaXplSW5uZXIoLShoZWlnaHQgLSBtYXJnaW5Ub3AgLSBtYXJnaW5Cb3R0b20pKTtcblxueUF4aXMgPSBkMy5heGlzTGVmdCh5U2NhbGUpXG4gICAgLnRpY2tzKGhlaWdodCAvIDQwKVxuICAgIC50aWNrU2l6ZU91dGVyKDApXG4gICAgLnRpY2tTaXplSW5uZXIoLSh3aWR0aCAtIG1hcmdpbkxlZnQgLSBtYXJnaW5SaWdodCkpO1xuXG5neCA9IHN2Zy5hcHBlbmQoXCJnXCIpXG4gICAgLmF0dHIoXCJjbGFzc1wiLCBcIngtYXhpc1wiKVxuICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIGB0cmFuc2xhdGUoMCwke2hlaWdodCAtIG1hcmdpbkJvdHRvbX0pYClcbiAgICAuY2FsbCh4QXhpcyk7XG5cbmd5ID0gc3ZnLmFwcGVuZChcImdcIilcbiAgICAuYXR0cihcImNsYXNzXCIsIFwieS1heGlzXCIpXG4gICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgYHRyYW5zbGF0ZSgke21hcmdpbkxlZnR9LDApYClcbiAgICAuY2FsbCh5QXhpcyk7XG5cbnN2Zy5zZWxlY3RBbGwoXCIudGljayBsaW5lXCIpXG4gICAuYXR0cihcInN0cm9rZS1vcGFjaXR5XCIsIDAuMSk7XG5cbnN2Zy5hcHBlbmQoXCJ0ZXh0XCIpXG4gICAgLmF0dHIoXCJ4XCIsIHdpZHRoIC0gbWFyZ2luUmlnaHQpXG4gICAgLmF0dHIoXCJ5XCIsIGhlaWdodCAtIG1hcmdpbkJvdHRvbSAtIDQpXG4gICAgLmF0dHIoXCJmaWxsXCIsIFwiY3VycmVudENvbG9yXCIpXG4gICAgLmF0dHIoXCJ0ZXh0LWFuY2hvclwiLCBcImVuZFwiKVxuICAgIC50ZXh0KFwiVU1BUCAxIOKGklwiKTtcblxuc3ZnLmFwcGVuZChcInRleHRcIilcbiAgICAuYXR0cihcInhcIiwgbWFyZ2luTGVmdCArIDQpXG4gICAgLmF0dHIoXCJ5XCIsIG1hcmdpblRvcClcbiAgICAuYXR0cihcImZpbGxcIiwgXCJjdXJyZW50Q29sb3JcIilcbiAgICAuYXR0cihcInRleHQtYW5jaG9yXCIsIFwic3RhcnRcIilcbiAgICAuYXR0cihcImRvbWluYW50LWJhc2VsaW5lXCIsIFwiaGFuZ2luZ1wiKVxuICAgIC50ZXh0KFwi4oaRIFVNQVAgMlwiKTtcbi1cbnN2Zy5hcHBlbmQoXCJjbGlwUGF0aFwiKVxuICAgIC5hdHRyKFwiaWRcIiwgXCJjbGlwXCIpXG4gIC5hcHBlbmQoXCJyZWN0XCIpXG4gICAgLmF0dHIoXCJ4XCIsIG1hcmdpbkxlZnQpXG4gICAgLmF0dHIoXCJ5XCIsIG1hcmdpblRvcClcbiAgICAuYXR0cihcIndpZHRoXCIsIHdpZHRoIC0gbWFyZ2luTGVmdCAtIG1hcmdpblJpZ2h0KVxuICAgIC5hdHRyKFwiaGVpZ2h0XCIsIGhlaWdodCAtIG1hcmdpblRvcCAtIG1hcmdpbkJvdHRvbSk7XG5cbnBvaW50R3JvdXAgPSBzdmcuYXBwZW5kKFwiZ1wiKVxuICAgIC5hdHRyKFwiZmlsbFwiLCBcImJsYWNrXCIpXG4gICAgLmF0dHIoXCJjbGlwLXBhdGhcIiwgXCJ1cmwoI2NsaXApXCIpO1xuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC02IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG57IC8vIFJlYWN0aXZlIGJsb2NrXG4gIGNvbnN0IHVwZGF0ZVZpc3VhbGl6YXRpb24gPSAoKSA9PiB7XG4gICAgY29uc3QgZHVyYXRpb24gPSA3NTA7XG4gICAgXG4gICAgY29uc3QgY3VycmVudFNjYWxlID0gY29sb3JieSA9PT0gXCJRQ1wiID8gcWNDb2xvclNjYWxlIDogbGVpZGVuQ29sb3JTY2FsZTtcblxuICAgIGlmICghY3VycmVudFNjYWxlKSB7IFxuICAgICAgICBjb25zb2xlLmVycm9yKFwiU2NhbGUgbWlzc2luZ1wiKTsgXG4gICAgICAgIHJldHVybjsgXG4gICAgfVxuICAgIFxuICAgIGlmICghcXVlcnlfZGF0YSB8fCBxdWVyeV9kYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgIGNvbnNvbGUud2FybihcIk5vIGRhdGEgYXZhaWxhYmxlIGZvciBwbG90dGluZy5cIik7XG4gICAgICAgcG9pbnRHcm91cC5zZWxlY3RBbGwoXCJjaXJjbGVcIikudHJhbnNpdGlvbigpLmR1cmF0aW9uKGR1cmF0aW9uKS5hdHRyKFwib3BhY2l0eVwiLCAwKS5yZW1vdmUoKTtcbiAgICAgICByZXR1cm47IFxuICAgIH1cblxuICAgIGNvbnN0IHhFeHRlbnQgPSBkMy5leHRlbnQocXVlcnlfZGF0YSwgZCA9PiBkLnVtYXBfMSk7XG4gICAgY29uc3QgeUV4dGVudCA9IGQzLmV4dGVudChxdWVyeV9kYXRhLCBkID0+IGQudW1hcF8yKTtcblxuICAgIGNvbnN0IHhQYWQgPSAoeEV4dGVudFsxXSAtIHhFeHRlbnRbMF0pICogMC4wNTtcbiAgICBjb25zdCB5UGFkID0gKHlFeHRlbnRbMV0gLSB5RXh0ZW50WzBdKSAqIDAuMDU7XG5cbiAgICB4U2NhbGUuZG9tYWluKFt4RXh0ZW50WzBdIC0geFBhZCB8fCAtMSwgeEV4dGVudFsxXSArIHhQYWQgfHwgMV0pO1xuICAgIHlTY2FsZS5kb21haW4oW3lFeHRlbnRbMF0gLSB5UGFkIHx8IC0xLCB5RXh0ZW50WzFdICsgeVBhZCB8fCAxXSk7XG5cbiAgICBzdmcuc2VsZWN0KFwiLngtYXhpc1wiKVxuICAgICAgLnRyYW5zaXRpb24oKS5kdXJhdGlvbihkdXJhdGlvbilcbiAgICAgIC5jYWxsKHhBeGlzKVxuICAgICAgLm9uKFwic3RhcnRcIiwgKCkgPT4ge1xuICAgICAgICAgc3ZnLnNlbGVjdEFsbChcIi54LWF4aXMgLnRpY2sgbGluZVwiKS5hdHRyKFwic3Ryb2tlLW9wYWNpdHlcIiwgMC4xKTtcbiAgICAgIH0pO1xuXG4gICAgc3ZnLnNlbGVjdChcIi55LWF4aXNcIilcbiAgICAgIC50cmFuc2l0aW9uKCkuZHVyYXRpb24oZHVyYXRpb24pXG4gICAgICAuY2FsbCh5QXhpcylcbiAgICAgIC5vbihcInN0YXJ0XCIsICgpID0+IHtcbiAgICAgICAgIHN2Zy5zZWxlY3RBbGwoXCIueS1heGlzIC50aWNrIGxpbmVcIikuYXR0cihcInN0cm9rZS1vcGFjaXR5XCIsIDAuMSk7XG4gICAgICB9KTtcblxuICAgIHBvaW50R3JvdXAuc2VsZWN0QWxsKFwiY2lyY2xlXCIpXG4gICAgICAuZGF0YShxdWVyeV9kYXRhLCBkID0+IGQuY2VsbF9pZClcbiAgICAgIC5qb2luKFxuICAgICAgICBlbnRlciA9PiBlbnRlci5hcHBlbmQoXCJjaXJjbGVcIilcbiAgICAgICAgICAgIC5hdHRyKFwiY3hcIiwgZCA9PiB4U2NhbGUoZC51bWFwXzEpKSBcbiAgICAgICAgICAgIC5hdHRyKFwiY3lcIiwgZCA9PiB5U2NhbGUoZC51bWFwXzIpKVxuICAgICAgICAgICAgLmF0dHIoXCJyXCIsIDIuNSlcbiAgICAgICAgICAgIC5hdHRyKFwiZmlsbFwiLCBkID0+IHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZVRvQ29sb3IgPSBjb2xvcmJ5ID09PSBcIlFDXCIgPyBxY0ZsYWdNYXAuZ2V0KGQuY2VsbF9pZCkgOiBkLmxlaWRlbjtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRTY2FsZSh2YWx1ZVRvQ29sb3IpIHx8ICdncmV5JztcbiAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsgcmV0dXJuICdncmV5JzsgfVxuICAgICAgICAgICAgfSkgXG4gICAgICAgICAgICAuYXR0cihcIm9wYWNpdHlcIiwgMClcbiAgICAgICAgICAgIC5jYWxsKGVudGVyID0+IGVudGVyLnRyYW5zaXRpb24oKS5kdXJhdGlvbihkdXJhdGlvbikuYXR0cihcIm9wYWNpdHlcIiwgMC44KSksXG4gICAgICAgIFxuICAgICAgICB1cGRhdGUgPT4gdXBkYXRlXG4gICAgICAgICAgICAuY2FsbCh1cGRhdGUgPT4gdXBkYXRlLnRyYW5zaXRpb24oKS5kdXJhdGlvbihkdXJhdGlvbilcbiAgICAgICAgICAgICAgICAuYXR0cihcImN4XCIsIGQgPT4geFNjYWxlKGQudW1hcF8xKSlcbiAgICAgICAgICAgICAgICAuYXR0cihcImN5XCIsIGQgPT4geVNjYWxlKGQudW1hcF8yKSlcbiAgICAgICAgICAgICAgICAuYXR0cihcImZpbGxcIiwgZCA9PiB7IFxuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWVUb0NvbG9yID0gY29sb3JieSA9PT0gXCJRQ1wiID8gcWNGbGFnTWFwLmdldChkLmNlbGxfaWQpIDogZC5sZWlkZW47XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFNjYWxlKHZhbHVlVG9Db2xvcikgfHwgJ2dyZXknO1xuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsgcmV0dXJuICdncmV5JzsgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmF0dHIoXCJvcGFjaXR5XCIsIDAuOClcbiAgICAgICAgICAgICApLFxuICAgICAgICBcbiAgICAgICAgZXhpdCA9PiBleGl0XG4gICAgICAgICAgICAuY2FsbChleGl0ID0+IGV4aXQudHJhbnNpdGlvbigpLmR1cmF0aW9uKGR1cmF0aW9uKS5hdHRyKFwib3BhY2l0eVwiLCAwKS5yZW1vdmUoKSlcbiAgICAgICk7XG4gIH07XG4gIFxuICB0cnkgeyBcbiAgICB1cGRhdGVWaXN1YWxpemF0aW9uKCk7XG4gIH0gY2F0Y2goZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgZHVyaW5nIEQzIHVwZGF0ZVZpc3VhbGl6YXRpb246XCIsIGVycm9yKTtcbiAgfVxuXG4gIHJldHVybiBzdmcubm9kZSgpOyBcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgncWNfbGV2ZWwnKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnbl9wY3MnKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnbl9uZWlnaGJvcnMnKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnbWV0cmljJykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ21kaXN0JykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ3NwcmVhZCcpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdjb2xvcmJ5JykifV19
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../..";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/nanostring-biostats\.github\.io\/CosMx-Analysis-Scratch-Space\/the-wtx-guide");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./quality-processing.html" class="pagination-link" aria-label="Quality Processing">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Quality Processing</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./spatial-domains.html" class="pagination-link" aria-label="Spatial Domains">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Domains</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> Pre-processing – From Counts to Clusters</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> </span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">- name: Evelyn Metzger</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">  orcid: 0000-0002-4074-9003</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">  affiliations: </span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - ref: bsb</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - ref: eveilyeverafter</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: true</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: auto</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">  message: true</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="an">self-contained:</span><span class="co"> false</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="an">code-fold:</span><span class="co"> false</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="an">code-annotations:</span><span class="co"> hover</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="an">prefer-html:</span><span class="co"> true</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> live-html</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="an">webr:</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="co">  packages:</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="co">    - dplyr</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co">    - duckdb</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co">  repos:</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="co">    - https://r-lib.r-universe.dev</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="an">resources:</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="co">  - assets/interactives/umap_explore.parquet</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="co">  - assets/interactives/umap_explore_qc_flags.parquet</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>{{&lt; include ./_extensions/r-wasm/live/_knitr.qmd &gt;}}</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="fu"># Normalization, Reduction, and Clustering {#sec-preprocessing}</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: Preamble</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R code"</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./preamble.R"</span>)</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">source_python</span>(<span class="st">"./preamble.py"</span>)</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>analysis_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"analysis_results"</span>)</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>input_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"input_files"</span>)</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"output_files"</span>)</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>analysis_asset_dir <span class="ot">&lt;-</span> <span class="st">"./assets/analysis_results"</span> <span class="co"># &lt;1&gt;</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>qc_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="st">"qc"</span>)</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(qc_dir)){</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(qc_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>pp_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="st">"processing"</span>)</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(pp_dir)){</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(pp_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>results_list_file <span class="ot">=</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"results_list.rds"</span>)</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(results_list_file)){</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(results_list, results_list_file)</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(results_list_file)  </span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./helpers.R"</span>) <span class="co"># contains the plotDots function</span></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>Our quality control steps in @sec-quality-processing identified the analyzable</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>cells, but these their raw counts need further processing to reveal biological</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>patterns. This chapter covers the essential pre-processing steps to make the</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>data interpretable.</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>First, normalization adjusts counts to account for technical factors like cell</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>area (_i.e._, larger cells typically have more counts), enabling fair comparisons</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>between cells. Second, dimensionality reduction (using PCA and UMAP) helps</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>reduce the total number of dimensions in the data (almost 19,000) to a</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>manageable representation that captures key biological variation and allows</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>visualization. Finally, clustering leverages this reduced space to group cells</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>with similar expression profiles, which can be a foundation for downstream</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>analyses like cell typing.</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>By the end of this chapter, we will have transformed the filtered count matrix</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>into a clustered, low-dimensional dataset and classified cells into groups which,</span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>taken together, form our foundation for</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>biological interpretation and spatial analysis. I often get asked "What is the</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>best parameter combination for CosMx data?" and I hope by the end of this chapter</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>you're able to understand how parameter adjustments impact many of these processing</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>steps.</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>Let's begin by loading the data.</span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-anndata</span></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: true</span></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> ad.read_h5ad(os.path.join(r.analysis_dir, <span class="st">"anndata-1-qc-filtered.h5ad"</span>))</span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a><span class="fu">## Two pre-processing workflows</span></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a>There are two different pre-processing workflows that I use. The first one</span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a>is borrowed from spatially-unaware scRNA-seq. The</span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a>main advantage of this approach is that it is fast, the normalization matrix can</span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a>remain sparse, the values are easy to understand (_e.g.,_ counts of gene X per 10,000 or </span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a>some transformation of such), and often times for WTX data provides the basis for good clustering</span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a>of cells in downstream UMAP. Moreover, Scanpy and Seurat each have built-in methods </span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a>for these steps which make it relatively low friction. However, there are cases were</span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a>this standard ("legacy") workflow provides unexpected results. One reason is that total</span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a>counts-based normalization might have unstable variance @Hafemeister2019 such that</span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>high-expressing housekeeping genes might have high variance and disproportionately </span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>effect downstream dimensional reduction and clustering. </span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a>The second, newer</span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a>workflow that I have been using is based on normalization using Pearson Residuals (PR).</span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>The approach itself is not new and scanpy has a built-in method for it </span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>(_i.e._, <span class="in">`scanpy.experimental.pp.normalize_pearson_residuals`</span>).</span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>Until recently the main disadvantage for using PR</span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a>is that it doesn't scale well to large number of cells that are typical in CosMx SMI<span class="ot">[^1]</span></span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>and it creates a large, dense normalization matrix that can make analysis and read/writing</span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a>slower. Fortunately, in many cases I do not need to compute and store such a dense</span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a>matrix. For example, Dan McGuire recently created the R package </span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">scPearsonPCA</span><span class="co">](https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca)</span></span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a>that can estimate the Principle Components (PCs) of the PR normalized data </span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a>without needing to convert and use very dense matrices (which we will show below).</span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a>While this workflow involves converting data between python and R, I generally</span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a>find the clusters that are derived from such data are comparable to the standard</span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>workflow or superior and so I recommend this workflow overall.</span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a>In this chapter, I'll run both the standard and recommended workflows on the colon</span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a>cancer dataset to provide code for both approaches. I will also do a deep-dive</span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a>on the choice of UMAP parameters.</span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a>This particular dataset is a case where the results are more-or-less</span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a>comparable and I'll pick the PR data to use throughout the rest of the colon</span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a>analysis.</span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a>Let's begin. Both options begin the same way: computing the highly variable genes (HVGs). </span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a>I have found that the <span class="in">`pearson_residulas`</span> method to </span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a>detect HVGs (not to be confused with PR normalization) provides stable results for a variety of CosMx</span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a>SMI WTX experiments. </span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: RNA-preprocessing</span></span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-162"><a href="#cb23-162" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">"counts"</span>] <span class="op">=</span> adata.X.copy()</span>
<span id="cb23-163"><a href="#cb23-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a>sc.experimental.pp.highly_variable_genes( <span class="co"># &lt;1&gt;</span></span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a>    adata,</span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a>    flavor<span class="op">=</span><span class="st">'pearson_residuals'</span>,</span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a>    n_top_genes<span class="op">=</span><span class="dv">4000</span>, <span class="co"># &lt;2&gt;</span></span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a>    layer<span class="op">=</span><span class="st">'counts'</span></span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-170"><a href="#cb23-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-171"><a href="#cb23-171" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>the pearson_residuals 'flavor' implement in this function is not the same as the</span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a>pearson residuals _normalization method_ (see below).</span>
<span id="cb23-173"><a href="#cb23-173" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>generally 3000-5000 is a good starting point here.</span>
<span id="cb23-174"><a href="#cb23-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-175"><a href="#cb23-175" aria-hidden="true" tabindex="-1"></a>::: {.column-margin}</span>
<span id="cb23-176"><a href="#cb23-176" aria-hidden="true" tabindex="-1"></a>::: {.otherapproachesbox title="Alternative Approach"}</span>
<span id="cb23-177"><a href="#cb23-177" aria-hidden="true" tabindex="-1"></a>The pre-processing workflow presented here can be considered a good overall</span>
<span id="cb23-178"><a href="#cb23-178" aria-hidden="true" tabindex="-1"></a>starting point towards understanding the structure of the data. </span>
<span id="cb23-179"><a href="#cb23-179" aria-hidden="true" tabindex="-1"></a>As such I have omitted more complex workflows and tasks such </span>
<span id="cb23-180"><a href="#cb23-180" aria-hidden="true" tabindex="-1"></a>as integrating morphology-based and/or protein-based PCs into the analysis. For</span>
<span id="cb23-181"><a href="#cb23-181" aria-hidden="true" tabindex="-1"></a>a more involved workflow, see our upcoming WTX paper.</span>
<span id="cb23-182"><a href="#cb23-182" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-183"><a href="#cb23-183" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-184"><a href="#cb23-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-185"><a href="#cb23-185" aria-hidden="true" tabindex="-1"></a>The tabs below show both of these workflows. In each workflow, I set the umap</span>
<span id="cb23-186"><a href="#cb23-186" aria-hidden="true" tabindex="-1"></a>parameters to be identical (40 PCs, 15 nearest neighbors, spread = 2 and minimum</span>
<span id="cb23-187"><a href="#cb23-187" aria-hidden="true" tabindex="-1"></a>distance = 0.02). While these are fixed here, see the box <span class="in">`Choosing UMAP Parameters`</span> </span>
<span id="cb23-188"><a href="#cb23-188" aria-hidden="true" tabindex="-1"></a>below to see how these </span>
<span id="cb23-189"><a href="#cb23-189" aria-hidden="true" tabindex="-1"></a>parameters effect the UMAP visual and the Leiden cluster assignments.</span>
<span id="cb23-190"><a href="#cb23-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-191"><a href="#cb23-191" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb23-192"><a href="#cb23-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-193"><a href="#cb23-193" aria-hidden="true" tabindex="-1"></a><span class="fu">### Total Counts Workflow {#sec-tc-workflow}</span></span>
<span id="cb23-194"><a href="#cb23-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-195"><a href="#cb23-195" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Workflow: Total counts-based normalization &gt; log transformation &gt; PCA</span></span>
<span id="cb23-196"><a href="#cb23-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-197"><a href="#cb23-197" aria-hidden="true" tabindex="-1"></a>The procedure below adapts a standard <span class="in">`scanpy`</span> <span class="co">[</span><span class="ot">pipeline</span><span class="co">](https://scanpy.readthedocs.io/en/stable/tutorials/basics/clustering.html#normalization)</span>.</span>
<span id="cb23-198"><a href="#cb23-198" aria-hidden="true" tabindex="-1"></a>We'll first normalize each</span>
<span id="cb23-199"><a href="#cb23-199" aria-hidden="true" tabindex="-1"></a>cell the median total counts</span>
<span id="cb23-200"><a href="#cb23-200" aria-hidden="true" tabindex="-1"></a>and then log tranform the data. </span>
<span id="cb23-201"><a href="#cb23-201" aria-hidden="true" tabindex="-1"></a>With this approach I find that scaling the log1p data tends to generate more distinct</span>
<span id="cb23-202"><a href="#cb23-202" aria-hidden="true" tabindex="-1"></a>and biologically relevant clusters so I add that step.</span>
<span id="cb23-203"><a href="#cb23-203" aria-hidden="true" tabindex="-1"></a>Thus, we'll focus our analysis on the most variable</span>
<span id="cb23-204"><a href="#cb23-204" aria-hidden="true" tabindex="-1"></a>genes found in the dataset. After subsetting down to only these 4000 HVGs, we'll scale</span>
<span id="cb23-205"><a href="#cb23-205" aria-hidden="true" tabindex="-1"></a>each gene, run PCA, and put these HVG-derivied PCs into the full annData object.</span>
<span id="cb23-206"><a href="#cb23-206" aria-hidden="true" tabindex="-1"></a>On this dataset (<span class="in">`r results_list$n_cells_after_qc`</span> cells), this whole process took</span>
<span id="cb23-207"><a href="#cb23-207" aria-hidden="true" tabindex="-1"></a>about a minute. </span>
<span id="cb23-208"><a href="#cb23-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-211"><a href="#cb23-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-212"><a href="#cb23-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: TC-1</span></span>
<span id="cb23-213"><a href="#cb23-213" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-214"><a href="#cb23-214" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb23-215"><a href="#cb23-215" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-216"><a href="#cb23-216" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-217"><a href="#cb23-217" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb23-218"><a href="#cb23-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-219"><a href="#cb23-219" aria-hidden="true" tabindex="-1"></a>sc.pp.normalize_total(adata)</span>
<span id="cb23-220"><a href="#cb23-220" aria-hidden="true" tabindex="-1"></a>sc.pp.log1p(adata) <span class="co"># -&gt; adata.X</span></span>
<span id="cb23-221"><a href="#cb23-221" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">'TC'</span>] <span class="op">=</span> adata.X.copy()</span>
<span id="cb23-222"><a href="#cb23-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-223"><a href="#cb23-223" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset to HVGs and get PCs</span></span>
<span id="cb23-224"><a href="#cb23-224" aria-hidden="true" tabindex="-1"></a>adata_hvg <span class="op">=</span> adata[:, adata.var.highly_variable].copy()</span>
<span id="cb23-225"><a href="#cb23-225" aria-hidden="true" tabindex="-1"></a>sc.pp.scale(adata_hvg) <span class="co"># -&gt; adata.X</span></span>
<span id="cb23-226"><a href="#cb23-226" aria-hidden="true" tabindex="-1"></a>sc.tl.pca(adata_hvg, svd_solver<span class="op">=</span><span class="st">'auto'</span>) </span>
<span id="cb23-227"><a href="#cb23-227" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'X_pca_TC'</span>] <span class="op">=</span> adata_hvg.obsm[<span class="st">'X_pca'</span>]</span>
<span id="cb23-228"><a href="#cb23-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-229"><a href="#cb23-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-230"><a href="#cb23-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-231"><a href="#cb23-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-232"><a href="#cb23-232" aria-hidden="true" tabindex="-1"></a>Run UMAP and Leiden with the top 40 PCs.</span>
<span id="cb23-233"><a href="#cb23-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-236"><a href="#cb23-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-237"><a href="#cb23-237" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: TC-2</span></span>
<span id="cb23-238"><a href="#cb23-238" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-239"><a href="#cb23-239" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb23-240"><a href="#cb23-240" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-241"><a href="#cb23-241" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-242"><a href="#cb23-242" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb23-243"><a href="#cb23-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-244"><a href="#cb23-244" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata, n_neighbors<span class="op">=</span><span class="dv">15</span>, n_pcs<span class="op">=</span><span class="dv">40</span>, metric <span class="op">=</span> <span class="st">'cosine'</span>,</span>
<span id="cb23-245"><a href="#cb23-245" aria-hidden="true" tabindex="-1"></a>  use_rep<span class="op">=</span><span class="st">'X_pca_TC'</span>, key_added<span class="op">=</span><span class="st">'neighbors_TC'</span>)</span>
<span id="cb23-246"><a href="#cb23-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-247"><a href="#cb23-247" aria-hidden="true" tabindex="-1"></a>UMAP <span class="op">=</span> sc.tl.umap(adata, min_dist<span class="op">=</span><span class="fl">0.02</span>, spread<span class="op">=</span><span class="dv">2</span>, neighbors_key<span class="op">=</span><span class="st">'neighbors_TC'</span>, copy<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-248"><a href="#cb23-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-249"><a href="#cb23-249" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'umap_TC'</span>] <span class="op">=</span> UMAP.obsm[<span class="st">'X_umap'</span>]</span>
<span id="cb23-250"><a href="#cb23-250" aria-hidden="true" tabindex="-1"></a>adata.uns[<span class="st">'umap_TC_params'</span>] <span class="op">=</span> UMAP.uns[<span class="st">'umap'</span>]</span>
<span id="cb23-251"><a href="#cb23-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-252"><a href="#cb23-252" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata, resolution<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb23-253"><a href="#cb23-253" aria-hidden="true" tabindex="-1"></a>  key_added<span class="op">=</span><span class="st">'leiden_tc'</span>, flavor<span class="op">=</span><span class="st">'igraph'</span>, </span>
<span id="cb23-254"><a href="#cb23-254" aria-hidden="true" tabindex="-1"></a>  n_iterations<span class="op">=</span><span class="dv">2</span>, neighbors_key<span class="op">=</span><span class="st">'neighbors_TC'</span>)</span>
<span id="cb23-255"><a href="#cb23-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-256"><a href="#cb23-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-257"><a href="#cb23-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-258"><a href="#cb23-258" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pearson Residuals Workflow</span></span>
<span id="cb23-259"><a href="#cb23-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-260"><a href="#cb23-260" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Workflow: Py to R &gt; scPearsonPCA</span></span>
<span id="cb23-261"><a href="#cb23-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-262"><a href="#cb23-262" aria-hidden="true" tabindex="-1"></a>The <span class="in">`scPearsonPCA`</span> package estimates the PCs of the PR data without computing</span>
<span id="cb23-263"><a href="#cb23-263" aria-hidden="true" tabindex="-1"></a>and storing a dense normalized matrix. </span>
<span id="cb23-264"><a href="#cb23-264" aria-hidden="true" tabindex="-1"></a>Since it is written in R, we'll add it to this workflow</span>
<span id="cb23-265"><a href="#cb23-265" aria-hidden="true" tabindex="-1"></a>via <span class="in">`reticulate`</span> after converting a few objects.</span>
<span id="cb23-266"><a href="#cb23-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-267"><a href="#cb23-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-270"><a href="#cb23-270" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-271"><a href="#cb23-271" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: PR-1</span></span>
<span id="cb23-272"><a href="#cb23-272" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-273"><a href="#cb23-273" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb23-274"><a href="#cb23-274" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-275"><a href="#cb23-275" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-276"><a href="#cb23-276" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb23-277"><a href="#cb23-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-278"><a href="#cb23-278" aria-hidden="true" tabindex="-1"></a>total_counts_per_cell <span class="op">=</span> adata.layers[<span class="st">'counts'</span>].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-279"><a href="#cb23-279" aria-hidden="true" tabindex="-1"></a>total_counts_per_cell <span class="op">=</span> np.asarray(total_counts_per_cell).flatten()</span>
<span id="cb23-280"><a href="#cb23-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-281"><a href="#cb23-281" aria-hidden="true" tabindex="-1"></a>total_counts_per_target <span class="op">=</span> adata.layers[<span class="st">'counts'</span>].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-282"><a href="#cb23-282" aria-hidden="true" tabindex="-1"></a>total_counts_per_target <span class="op">=</span> np.asarray(total_counts_per_target).flatten()</span>
<span id="cb23-283"><a href="#cb23-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-284"><a href="#cb23-284" aria-hidden="true" tabindex="-1"></a>target_frequencies <span class="op">=</span> total_counts_per_target <span class="op">/</span> total_counts_per_target.<span class="bu">sum</span>()</span>
<span id="cb23-285"><a href="#cb23-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-286"><a href="#cb23-286" aria-hidden="true" tabindex="-1"></a>adata_hvg <span class="op">=</span> adata[:, adata.var.highly_variable].copy()</span>
<span id="cb23-287"><a href="#cb23-287" aria-hidden="true" tabindex="-1"></a>hvgs_counts <span class="op">=</span> adata_hvg.layers[<span class="st">'counts'</span>].copy().astype(np.int64)</span>
<span id="cb23-288"><a href="#cb23-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-289"><a href="#cb23-289" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-290"><a href="#cb23-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-291"><a href="#cb23-291" aria-hidden="true" tabindex="-1"></a>Convert relevant data to R. </span>
<span id="cb23-292"><a href="#cb23-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-295"><a href="#cb23-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-296"><a href="#cb23-296" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: PR-2</span></span>
<span id="cb23-297"><a href="#cb23-297" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-298"><a href="#cb23-298" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb23-299"><a href="#cb23-299" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: true</span></span>
<span id="cb23-300"><a href="#cb23-300" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-301"><a href="#cb23-301" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb23-302"><a href="#cb23-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-303"><a href="#cb23-303" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb23-304"><a href="#cb23-304" aria-hidden="true" tabindex="-1"></a>hvgs_counts <span class="ot">&lt;-</span> py<span class="sc">$</span>hvgs_counts</span>
<span id="cb23-305"><a href="#cb23-305" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(hvgs_counts) <span class="ot">&lt;-</span> py<span class="sc">$</span>adata_hvg<span class="sc">$</span>obs_names<span class="sc">$</span><span class="fu">to_list</span>()</span>
<span id="cb23-306"><a href="#cb23-306" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(hvgs_counts) <span class="ot">&lt;-</span> py<span class="sc">$</span>adata_hvg<span class="sc">$</span>var_names<span class="sc">$</span><span class="fu">to_list</span>()</span>
<span id="cb23-307"><a href="#cb23-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-308"><a href="#cb23-308" aria-hidden="true" tabindex="-1"></a><span class="co"># the approach we use below expects a sparse matrix with genes (rows) by cells (columns)</span></span>
<span id="cb23-309"><a href="#cb23-309" aria-hidden="true" tabindex="-1"></a>t_hvgs_counts <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">t</span>(hvgs_counts)</span>
<span id="cb23-310"><a href="#cb23-310" aria-hidden="true" tabindex="-1"></a>t_hvgs_counts <span class="ot">&lt;-</span> <span class="fu">as</span>(t_hvgs_counts, <span class="st">"CsparseMatrix"</span>)</span>
<span id="cb23-311"><a href="#cb23-311" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-312"><a href="#cb23-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-313"><a href="#cb23-313" aria-hidden="true" tabindex="-1"></a>Install the scPearsonPCA package (and remotes), if needed.</span>
<span id="cb23-314"><a href="#cb23-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-317"><a href="#cb23-317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-318"><a href="#cb23-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: PR-3</span></span>
<span id="cb23-319"><a href="#cb23-319" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-320"><a href="#cb23-320" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb23-321"><a href="#cb23-321" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: true</span></span>
<span id="cb23-322"><a href="#cb23-322" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-323"><a href="#cb23-323" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb23-324"><a href="#cb23-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-325"><a href="#cb23-325" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"Nanostring-Biostats/CosMx-Analysis-Scratch-Space"</span>,</span>
<span id="cb23-326"><a href="#cb23-326" aria-hidden="true" tabindex="-1"></a>                         <span class="at">subdir =</span> <span class="st">"_code/scPearsonPCA"</span>, <span class="at">ref =</span> <span class="st">"Main"</span>)</span>
<span id="cb23-327"><a href="#cb23-327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-328"><a href="#cb23-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-329"><a href="#cb23-329" aria-hidden="true" tabindex="-1"></a>Run Seurat-style PCA using scPearsonPCA.</span>
<span id="cb23-330"><a href="#cb23-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-333"><a href="#cb23-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-334"><a href="#cb23-334" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: PR-4</span></span>
<span id="cb23-335"><a href="#cb23-335" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-336"><a href="#cb23-336" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb23-337"><a href="#cb23-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: true</span></span>
<span id="cb23-338"><a href="#cb23-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-339"><a href="#cb23-339" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb23-340"><a href="#cb23-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-341"><a href="#cb23-341" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scPearsonPCA)</span>
<span id="cb23-342"><a href="#cb23-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-343"><a href="#cb23-343" aria-hidden="true" tabindex="-1"></a>total_counts_per_cell <span class="ot">&lt;-</span> py<span class="sc">$</span>total_counts_per_cell</span>
<span id="cb23-344"><a href="#cb23-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-345"><a href="#cb23-345" aria-hidden="true" tabindex="-1"></a>target_frequencies <span class="ot">&lt;-</span> py<span class="sc">$</span>target_frequencies</span>
<span id="cb23-346"><a href="#cb23-346" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(target_frequencies) <span class="ot">&lt;-</span> py<span class="sc">$</span>adata<span class="sc">$</span>var_names<span class="sc">$</span><span class="fu">to_list</span>()</span>
<span id="cb23-347"><a href="#cb23-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-348"><a href="#cb23-348" aria-hidden="true" tabindex="-1"></a>pcaobj <span class="ot">&lt;-</span> <span class="fu">sparse_quasipoisson_pca_seurat</span>(</span>
<span id="cb23-349"><a href="#cb23-349" aria-hidden="true" tabindex="-1"></a>              <span class="at">x =</span> t_hvgs_counts,</span>
<span id="cb23-350"><a href="#cb23-350" aria-hidden="true" tabindex="-1"></a>              <span class="at">totalcounts =</span> total_counts_per_cell,</span>
<span id="cb23-351"><a href="#cb23-351" aria-hidden="true" tabindex="-1"></a>              <span class="at">grate =</span> target_frequencies[<span class="fu">rownames</span>(t_hvgs_counts)],</span>
<span id="cb23-352"><a href="#cb23-352" aria-hidden="true" tabindex="-1"></a>              <span class="at">scale.max =</span> <span class="dv">10</span>,</span>
<span id="cb23-353"><a href="#cb23-353" aria-hidden="true" tabindex="-1"></a>              <span class="at">do.scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-354"><a href="#cb23-354" aria-hidden="true" tabindex="-1"></a>              <span class="at">do.center =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-355"><a href="#cb23-355" aria-hidden="true" tabindex="-1"></a>              <span class="at">ncores =</span> <span class="dv">5</span></span>
<span id="cb23-356"><a href="#cb23-356" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb23-357"><a href="#cb23-357" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">&lt;-</span> pcaobj<span class="sc">$</span>reduction.data<span class="sc">@</span>cell.embeddings</span>
<span id="cb23-358"><a href="#cb23-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-359"><a href="#cb23-359" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-360"><a href="#cb23-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-361"><a href="#cb23-361" aria-hidden="true" tabindex="-1"></a>Add these PCs to the annData object in Python. Run UMAP and Leiden with the top 40 PCs.</span>
<span id="cb23-362"><a href="#cb23-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-365"><a href="#cb23-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-366"><a href="#cb23-366" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: PR-6</span></span>
<span id="cb23-367"><a href="#cb23-367" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-368"><a href="#cb23-368" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb23-369"><a href="#cb23-369" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-370"><a href="#cb23-370" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-371"><a href="#cb23-371" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb23-372"><a href="#cb23-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-373"><a href="#cb23-373" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">"X_pca_pr"</span>] <span class="op">=</span> r.pca</span>
<span id="cb23-374"><a href="#cb23-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-375"><a href="#cb23-375" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata, n_neighbors<span class="op">=</span><span class="dv">15</span>, n_pcs<span class="op">=</span><span class="dv">40</span>, metric <span class="op">=</span> <span class="st">'cosine'</span>,</span>
<span id="cb23-376"><a href="#cb23-376" aria-hidden="true" tabindex="-1"></a>  use_rep<span class="op">=</span><span class="st">'X_pca_pr'</span>, key_added<span class="op">=</span><span class="st">'neighbors_pr'</span>)</span>
<span id="cb23-377"><a href="#cb23-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-378"><a href="#cb23-378" aria-hidden="true" tabindex="-1"></a>UMAP <span class="op">=</span> sc.tl.umap(adata, min_dist<span class="op">=</span><span class="fl">0.02</span>, spread<span class="op">=</span><span class="dv">2</span>, neighbors_key<span class="op">=</span><span class="st">'neighbors_pr'</span>, copy<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-379"><a href="#cb23-379" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'umap_pr'</span>] <span class="op">=</span> UMAP.obsm[<span class="st">'X_umap'</span>]</span>
<span id="cb23-380"><a href="#cb23-380" aria-hidden="true" tabindex="-1"></a>adata.uns[<span class="st">'umap_pr_params'</span>] <span class="op">=</span> UMAP.uns[<span class="st">'umap'</span>]</span>
<span id="cb23-381"><a href="#cb23-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-382"><a href="#cb23-382" aria-hidden="true" tabindex="-1"></a>sc.tl.leiden(adata, resolution<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb23-383"><a href="#cb23-383" aria-hidden="true" tabindex="-1"></a>  key_added<span class="op">=</span><span class="st">'leiden_pr'</span>, flavor<span class="op">=</span><span class="st">'igraph'</span>, </span>
<span id="cb23-384"><a href="#cb23-384" aria-hidden="true" tabindex="-1"></a>  n_iterations<span class="op">=</span><span class="dv">2</span>, neighbors_key<span class="op">=</span><span class="st">'neighbors_pr'</span>)</span>
<span id="cb23-385"><a href="#cb23-385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-386"><a href="#cb23-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-387"><a href="#cb23-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-388"><a href="#cb23-388" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-389"><a href="#cb23-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-390"><a href="#cb23-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-391"><a href="#cb23-391" aria-hidden="true" tabindex="-1"></a>Save the annData object.</span>
<span id="cb23-392"><a href="#cb23-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-395"><a href="#cb23-395" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-396"><a href="#cb23-396" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: save-anndata</span></span>
<span id="cb23-397"><a href="#cb23-397" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-398"><a href="#cb23-398" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb23-399"><a href="#cb23-399" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-400"><a href="#cb23-400" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-401"><a href="#cb23-401" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb23-402"><a href="#cb23-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-403"><a href="#cb23-403" aria-hidden="true" tabindex="-1"></a>adata.write_h5ad(</span>
<span id="cb23-404"><a href="#cb23-404" aria-hidden="true" tabindex="-1"></a>  os.path.join(r.analysis_dir, <span class="st">"anndata-2-leiden.h5ad"</span>),</span>
<span id="cb23-405"><a href="#cb23-405" aria-hidden="true" tabindex="-1"></a>  compression<span class="op">=</span>hdf5plugin.FILTERS[<span class="st">"zstd"</span>],</span>
<span id="cb23-406"><a href="#cb23-406" aria-hidden="true" tabindex="-1"></a>  compression_opts<span class="op">=</span>hdf5plugin.Zstd(clevel<span class="op">=</span><span class="dv">5</span>).filter_options</span>
<span id="cb23-407"><a href="#cb23-407" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-408"><a href="#cb23-408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-409"><a href="#cb23-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-410"><a href="#cb23-410" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visualizations</span></span>
<span id="cb23-411"><a href="#cb23-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-412"><a href="#cb23-412" aria-hidden="true" tabindex="-1"></a>Now that we have the UMAP embeddings and the Leiden cluster assignments in the</span>
<span id="cb23-413"><a href="#cb23-413" aria-hidden="true" tabindex="-1"></a>annData object, we can plot the results of the two methods and compare.</span>
<span id="cb23-414"><a href="#cb23-414" aria-hidden="true" tabindex="-1"></a>The easiest way to plot the Leiden clusters in UMAP space is with scnapy's built-in</span>
<span id="cb23-415"><a href="#cb23-415" aria-hidden="true" tabindex="-1"></a>method, <span class="co">[</span><span class="ot">`sc.pl.umap`</span><span class="co">](https://scanpy.readthedocs.io/en/stable/generated/scanpy.tl.umap.html)</span>; however, since we have non-typical <span class="in">`obsm`</span> keys, we'll use the</span>
<span id="cb23-416"><a href="#cb23-416" aria-hidden="true" tabindex="-1"></a>more generic <span class="co">[</span><span class="ot">`sc.pl.embedding`</span><span class="co">](https://scanpy.readthedocs.io/en/latest/api/generated/scanpy.pl.embedding.html)</span> method.</span>
<span id="cb23-417"><a href="#cb23-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-420"><a href="#cb23-420" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-421"><a href="#cb23-421" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: make-umap-figs</span></span>
<span id="cb23-422"><a href="#cb23-422" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb23-423"><a href="#cb23-423" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb23-424"><a href="#cb23-424" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-425"><a href="#cb23-425" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-426"><a href="#cb23-426" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb23-427"><a href="#cb23-427" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-428"><a href="#cb23-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-429"><a href="#cb23-429" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb23-430"><a href="#cb23-430" aria-hidden="true" tabindex="-1"></a>sc.settings.figdir <span class="op">=</span> r.pp_dir</span>
<span id="cb23-431"><a href="#cb23-431" aria-hidden="true" tabindex="-1"></a>save_dir <span class="op">=</span> r.pp_dir</span>
<span id="cb23-432"><a href="#cb23-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-433"><a href="#cb23-433" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'log10_nCount_RNA'</span>] <span class="op">=</span> np.log10(adata.obs[<span class="st">'nCount_RNA'</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb23-434"><a href="#cb23-434" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'qcflag'</span>] <span class="op">=</span> adata.obs[<span class="st">'qcflag'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb23-435"><a href="#cb23-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-436"><a href="#cb23-436" aria-hidden="true" tabindex="-1"></a>fig, ((ax1, ax2), (ax3, ax4), (ax5, ax6)) <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb23-437"><a href="#cb23-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-438"><a href="#cb23-438" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb23-439"><a href="#cb23-439" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_TC'</span>,</span>
<span id="cb23-440"><a href="#cb23-440" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'leiden_tc'</span>,</span>
<span id="cb23-441"><a href="#cb23-441" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Total Counts (leiden_tc)'</span>,</span>
<span id="cb23-442"><a href="#cb23-442" aria-hidden="true" tabindex="-1"></a>                palette<span class="op">=</span>sc.pl.palettes.default_20,</span>
<span id="cb23-443"><a href="#cb23-443" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax1,</span>
<span id="cb23-444"><a href="#cb23-444" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-445"><a href="#cb23-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-446"><a href="#cb23-446" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb23-447"><a href="#cb23-447" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_pr'</span>,</span>
<span id="cb23-448"><a href="#cb23-448" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'leiden_pr'</span>,</span>
<span id="cb23-449"><a href="#cb23-449" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Pearson Residuals (leiden_pr)'</span>,</span>
<span id="cb23-450"><a href="#cb23-450" aria-hidden="true" tabindex="-1"></a>                palette<span class="op">=</span>sc.pl.palettes.default_20,</span>
<span id="cb23-451"><a href="#cb23-451" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax2,</span>
<span id="cb23-452"><a href="#cb23-452" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-453"><a href="#cb23-453" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb23-454"><a href="#cb23-454" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb23-455"><a href="#cb23-455" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_TC'</span>,</span>
<span id="cb23-456"><a href="#cb23-456" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'log10_nCount_RNA'</span>,</span>
<span id="cb23-457"><a href="#cb23-457" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Total Counts (log10_nCount_RNA)'</span>,</span>
<span id="cb23-458"><a href="#cb23-458" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax3,</span>
<span id="cb23-459"><a href="#cb23-459" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-460"><a href="#cb23-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-461"><a href="#cb23-461" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb23-462"><a href="#cb23-462" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_pr'</span>,</span>
<span id="cb23-463"><a href="#cb23-463" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'log10_nCount_RNA'</span>,</span>
<span id="cb23-464"><a href="#cb23-464" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Pearson Residuals (log10_nCount_RNA)'</span>,</span>
<span id="cb23-465"><a href="#cb23-465" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax4,</span>
<span id="cb23-466"><a href="#cb23-466" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-467"><a href="#cb23-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-468"><a href="#cb23-468" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb23-469"><a href="#cb23-469" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_TC'</span>,</span>
<span id="cb23-470"><a href="#cb23-470" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'qcflag'</span>,</span>
<span id="cb23-471"><a href="#cb23-471" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Total Counts (FOV QC Flag)'</span>,</span>
<span id="cb23-472"><a href="#cb23-472" aria-hidden="true" tabindex="-1"></a>                palette<span class="op">=</span>sc.pl.palettes.default_20,</span>
<span id="cb23-473"><a href="#cb23-473" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax5,</span>
<span id="cb23-474"><a href="#cb23-474" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-475"><a href="#cb23-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-476"><a href="#cb23-476" aria-hidden="true" tabindex="-1"></a>sc.pl.embedding(adata,</span>
<span id="cb23-477"><a href="#cb23-477" aria-hidden="true" tabindex="-1"></a>                basis<span class="op">=</span><span class="st">'umap_pr'</span>,</span>
<span id="cb23-478"><a href="#cb23-478" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'qcflag'</span>,</span>
<span id="cb23-479"><a href="#cb23-479" aria-hidden="true" tabindex="-1"></a>                title<span class="op">=</span><span class="st">'Pearson Residuals (FOV QC Flag)'</span>,</span>
<span id="cb23-480"><a href="#cb23-480" aria-hidden="true" tabindex="-1"></a>                palette<span class="op">=</span>sc.pl.palettes.default_20,</span>
<span id="cb23-481"><a href="#cb23-481" aria-hidden="true" tabindex="-1"></a>                ax<span class="op">=</span>ax6,</span>
<span id="cb23-482"><a href="#cb23-482" aria-hidden="true" tabindex="-1"></a>                show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-483"><a href="#cb23-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-484"><a href="#cb23-484" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb23-485"><a href="#cb23-485" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"umap_umap_compare.png"</span></span>
<span id="cb23-486"><a href="#cb23-486" aria-hidden="true" tabindex="-1"></a>save_path <span class="op">=</span> os.path.join(save_dir, filename)</span>
<span id="cb23-487"><a href="#cb23-487" aria-hidden="true" tabindex="-1"></a>plt.savefig(save_path)          </span>
<span id="cb23-488"><a href="#cb23-488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-489"><a href="#cb23-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-492"><a href="#cb23-492" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-493"><a href="#cb23-493" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-umap-leiden-simple</span></span>
<span id="cb23-494"><a href="#cb23-494" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-495"><a href="#cb23-495" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-496"><a href="#cb23-496" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb23-497"><a href="#cb23-497" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 8</span></span>
<span id="cb23-498"><a href="#cb23-498" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 12</span></span>
<span id="cb23-499"><a href="#cb23-499" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "UMAP with Leiden clusters from total counts normalization (left) and scPearsonPCA PCs (right). Note that a given cluster label in one plot is not the same as that label in the other plot. Top: Leiden clusters. Middle: cells colored by their total counts. Bottom: cells colored by their QC flag (0 = no flag; 32 = FOV flag; no other flaggeed cells were processed)."</span></span>
<span id="cb23-500"><a href="#cb23-500" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-501"><a href="#cb23-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-502"><a href="#cb23-502" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(<span class="fu">file.path</span>(analysis_asset_dir, <span class="st">"preprocessing"</span>), <span class="st">"umap_umap_compare.png"</span>, pp_dir, <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb23-503"><a href="#cb23-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-504"><a href="#cb23-504" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-505"><a href="#cb23-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-506"><a href="#cb23-506" aria-hidden="true" tabindex="-1"></a>Both normalization methods demonstrate effective cluster separation</span>
<span id="cb23-507"><a href="#cb23-507" aria-hidden="true" tabindex="-1"></a>(@fig-umap-leiden-simple). When evaluating these visualizations, it is important</span>
<span id="cb23-508"><a href="#cb23-508" aria-hidden="true" tabindex="-1"></a>to watch for artifacts, particularly sub-clustering driven primarily by total</span>
<span id="cb23-509"><a href="#cb23-509" aria-hidden="true" tabindex="-1"></a>transcript counts, which can signal suboptimal normalization. Additionally,</span>
<span id="cb23-510"><a href="#cb23-510" aria-hidden="true" tabindex="-1"></a>because we retained cells flagged by FOV QC (flag 32), we must verify that these</span>
<span id="cb23-511"><a href="#cb23-511" aria-hidden="true" tabindex="-1"></a>cells do not aggregate into spurious "satellite" clusters which could</span>
<span id="cb23-512"><a href="#cb23-512" aria-hidden="true" tabindex="-1"></a>indicate technical artifacts rather than biological signal. In this dataset,</span>
<span id="cb23-513"><a href="#cb23-513" aria-hidden="true" tabindex="-1"></a>while FOV QC-flagged cells are present in the upper right cluster (Leiden 5 in</span>
<span id="cb23-514"><a href="#cb23-514" aria-hidden="true" tabindex="-1"></a>the total counts workflow and Leiden 11 in the Pearson Residuals workflow), they</span>
<span id="cb23-515"><a href="#cb23-515" aria-hidden="true" tabindex="-1"></a>do not form a distinct artifactual group. Instead, they appear integrated with</span>
<span id="cb23-516"><a href="#cb23-516" aria-hidden="true" tabindex="-1"></a>the dominant cell population, suggesting their distribution is driven by the</span>
<span id="cb23-517"><a href="#cb23-517" aria-hidden="true" tabindex="-1"></a>biology of that region -- a hypothesis we will elucidate further in</span>
<span id="cb23-518"><a href="#cb23-518" aria-hidden="true" tabindex="-1"></a>@sec-celltyping.</span>
<span id="cb23-519"><a href="#cb23-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-520"><a href="#cb23-520" aria-hidden="true" tabindex="-1"></a>We can compare which combination of Leiden clusters a given cell was assigned to:</span>
<span id="cb23-521"><a href="#cb23-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-524"><a href="#cb23-524" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-525"><a href="#cb23-525" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb23-526"><a href="#cb23-526" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-527"><a href="#cb23-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-528"><a href="#cb23-528" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb23-529"><a href="#cb23-529" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb23-530"><a href="#cb23-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-531"><a href="#cb23-531" aria-hidden="true" tabindex="-1"></a>crosstab <span class="op">=</span> pd.crosstab(</span>
<span id="cb23-532"><a href="#cb23-532" aria-hidden="true" tabindex="-1"></a>    adata.obs[<span class="st">'leiden_tc'</span>],</span>
<span id="cb23-533"><a href="#cb23-533" aria-hidden="true" tabindex="-1"></a>    adata.obs[<span class="st">'leiden_pr'</span>]</span>
<span id="cb23-534"><a href="#cb23-534" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-535"><a href="#cb23-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-536"><a href="#cb23-536" aria-hidden="true" tabindex="-1"></a>crosstab_norm <span class="op">=</span> crosstab.div(crosstab.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-537"><a href="#cb23-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-538"><a href="#cb23-538" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb23-539"><a href="#cb23-539" aria-hidden="true" tabindex="-1"></a>sns.heatmap(</span>
<span id="cb23-540"><a href="#cb23-540" aria-hidden="true" tabindex="-1"></a>    crosstab_norm,</span>
<span id="cb23-541"><a href="#cb23-541" aria-hidden="true" tabindex="-1"></a>    annot<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-542"><a href="#cb23-542" aria-hidden="true" tabindex="-1"></a>    fmt<span class="op">=</span><span class="st">".2f"</span>, cmap<span class="op">=</span><span class="st">"viridis"</span>,</span>
<span id="cb23-543"><a href="#cb23-543" aria-hidden="true" tabindex="-1"></a>    linewidths<span class="op">=</span><span class="fl">.5</span></span>
<span id="cb23-544"><a href="#cb23-544" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-545"><a href="#cb23-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-546"><a href="#cb23-546" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Comparison of Leiden clusters derived from TC or PR workflows"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb23-547"><a href="#cb23-547" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Total Counts (leiden_tc)"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb23-548"><a href="#cb23-548" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Pearson Residuals (leiden_pr)"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb23-549"><a href="#cb23-549" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"leiden_compare_crosstab.png"</span></span>
<span id="cb23-550"><a href="#cb23-550" aria-hidden="true" tabindex="-1"></a>save_path <span class="op">=</span> os.path.join(save_dir, filename)</span>
<span id="cb23-551"><a href="#cb23-551" aria-hidden="true" tabindex="-1"></a>plt.savefig(save_path)     </span>
<span id="cb23-552"><a href="#cb23-552" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-553"><a href="#cb23-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-554"><a href="#cb23-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-557"><a href="#cb23-557" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-558"><a href="#cb23-558" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-umap-leiden-compare</span></span>
<span id="cb23-559"><a href="#cb23-559" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-560"><a href="#cb23-560" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-561"><a href="#cb23-561" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb23-562"><a href="#cb23-562" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 12</span></span>
<span id="cb23-563"><a href="#cb23-563" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 12</span></span>
<span id="cb23-564"><a href="#cb23-564" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Proportion of cells classified with the pure scanpy-based approach compared to the scPearsonPCA-based appraoch."</span></span>
<span id="cb23-565"><a href="#cb23-565" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-566"><a href="#cb23-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-567"><a href="#cb23-567" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(<span class="fu">file.path</span>(analysis_asset_dir, <span class="st">"preprocessing"</span>), <span class="st">"leiden_compare_crosstab.png"</span>, pp_dir, <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb23-568"><a href="#cb23-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-569"><a href="#cb23-569" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-570"><a href="#cb23-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-571"><a href="#cb23-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-572"><a href="#cb23-572" aria-hidden="true" tabindex="-1"></a>@fig-umap-leiden-compare shows a relationship between the clusters derived</span>
<span id="cb23-573"><a href="#cb23-573" aria-hidden="true" tabindex="-1"></a>from our two normalization approaches.</span>
<span id="cb23-574"><a href="#cb23-574" aria-hidden="true" tabindex="-1"></a>Most (15 of 16) Leiden clusters with the total counts</span>
<span id="cb23-575"><a href="#cb23-575" aria-hidden="true" tabindex="-1"></a>approach have more than 85% of cells that are found in a single Leiden cluster</span>
<span id="cb23-576"><a href="#cb23-576" aria-hidden="true" tabindex="-1"></a>for the Pearson Residuals method (e.g., 95% of tc_3 cells mapped to pr_1). One</span>
<span id="cb23-577"><a href="#cb23-577" aria-hidden="true" tabindex="-1"></a>cluster in the total counts approach (tc_1) "split" amongst PR clusters (primarily</span>
<span id="cb23-578"><a href="#cb23-578" aria-hidden="true" tabindex="-1"></a>clusters pr_5, pr_6, and pr_8).</span>
<span id="cb23-579"><a href="#cb23-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-580"><a href="#cb23-580" aria-hidden="true" tabindex="-1"></a>So which is _better_? With this particular dataset the two approaches are comparable. </span>
<span id="cb23-581"><a href="#cb23-581" aria-hidden="true" tabindex="-1"></a>For the majority of my CosMx SMI WTX analyses I have found the Pearson </span>
<span id="cb23-582"><a href="#cb23-582" aria-hidden="true" tabindex="-1"></a>Residual-based normalization to provide more meaningful biological clusters </span>
<span id="cb23-583"><a href="#cb23-583" aria-hidden="true" tabindex="-1"></a>consistently across datasets so </span>
<span id="cb23-584"><a href="#cb23-584" aria-hidden="true" tabindex="-1"></a>that might be a good overall recommendation -- especially if you are working within</span>
<span id="cb23-585"><a href="#cb23-585" aria-hidden="true" tabindex="-1"></a>the R ecosystem. If you are looking for a quick analysis, then the total counts-based</span>
<span id="cb23-586"><a href="#cb23-586" aria-hidden="true" tabindex="-1"></a>approach may work in many cases. </span>
<span id="cb23-587"><a href="#cb23-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-588"><a href="#cb23-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-589"><a href="#cb23-589" aria-hidden="true" tabindex="-1"></a>:::{.column-body-outset}</span>
<span id="cb23-590"><a href="#cb23-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-591"><a href="#cb23-591" aria-hidden="true" tabindex="-1"></a>:::{.noteworthybox title="Choosing UMAP Parameters" collapse="true"}</span>
<span id="cb23-592"><a href="#cb23-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-593"><a href="#cb23-593" aria-hidden="true" tabindex="-1"></a><span class="fu">## Choosing UMAP Parameters</span></span>
<span id="cb23-594"><a href="#cb23-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-595"><a href="#cb23-595" aria-hidden="true" tabindex="-1"></a>UMAP helps visualize how groups of cells relate to each other in</span>
<span id="cb23-596"><a href="#cb23-596" aria-hidden="true" tabindex="-1"></a>high-dimensional space. While there isn't one "correct" UMAP layout, some</span>
<span id="cb23-597"><a href="#cb23-597" aria-hidden="true" tabindex="-1"></a>embeddings are more effective than others at revealing underlying biological</span>
<span id="cb23-598"><a href="#cb23-598" aria-hidden="true" tabindex="-1"></a>structure. We have seen in this chapter how having choice in normalization </span>
<span id="cb23-599"><a href="#cb23-599" aria-hidden="true" tabindex="-1"></a>alone (via PCA) can alter the shape of a UMAP plot even when all other parameters</span>
<span id="cb23-600"><a href="#cb23-600" aria-hidden="true" tabindex="-1"></a>are identical (@fig-umap-leiden-simple). </span>
<span id="cb23-601"><a href="#cb23-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-602"><a href="#cb23-602" aria-hidden="true" tabindex="-1"></a>This section explores how commonly adjusted parameters and inputs other than</span>
<span id="cb23-603"><a href="#cb23-603" aria-hidden="true" tabindex="-1"></a>the choice of normalization influence the</span>
<span id="cb23-604"><a href="#cb23-604" aria-hidden="true" tabindex="-1"></a>resulting UMAP visualization, aiming to build intuition for how to tune these</span>
<span id="cb23-605"><a href="#cb23-605" aria-hidden="true" tabindex="-1"></a>parameters effectively in your dataset.</span>
<span id="cb23-606"><a href="#cb23-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-607"><a href="#cb23-607" aria-hidden="true" tabindex="-1"></a>Let's systematically vary five key factors:</span>
<span id="cb23-608"><a href="#cb23-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-609"><a href="#cb23-609" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The quality filtering applied to the input cells.** Using only high-quality </span>
<span id="cb23-610"><a href="#cb23-610" aria-hidden="true" tabindex="-1"></a>cells often leads to clearer, tighter clusters representing core biological populations.</span>
<span id="cb23-611"><a href="#cb23-611" aria-hidden="true" tabindex="-1"></a>If filtering was too stringent then entire cell populations might be unrepresented. </span>
<span id="cb23-612"><a href="#cb23-612" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The number of Principal Components (PCs) used.** Using a lower number will concetrate</span>
<span id="cb23-613"><a href="#cb23-613" aria-hidden="true" tabindex="-1"></a>on the strongest axes of variation at the cost of reducing any distinction between</span>
<span id="cb23-614"><a href="#cb23-614" aria-hidden="true" tabindex="-1"></a>cell subtypes if that distinction is found in higher PCs. Choosing a higher number</span>
<span id="cb23-615"><a href="#cb23-615" aria-hidden="true" tabindex="-1"></a>of PCs can potentially resolve finer subtypes but also risks incorporating noise, </span>
<span id="cb23-616"><a href="#cb23-616" aria-hidden="true" tabindex="-1"></a>which might slightly blur cluster boundaries or create small, potentially spurious groupings.</span>
<span id="cb23-617"><a href="#cb23-617" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The number of nearest neighbors (n_neighbors).** Lower <span class="in">`n_neighbors`</span> tends to</span>
<span id="cb23-618"><a href="#cb23-618" aria-hidden="true" tabindex="-1"></a>emphasize local cluster separation while higher <span class="in">`n_neigbhors`</span> tends to form broader</span>
<span id="cb23-619"><a href="#cb23-619" aria-hidden="true" tabindex="-1"></a>clusters.</span>
<span id="cb23-620"><a href="#cb23-620" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The distance metric (metric).** Defines the rule for calculating "closeness" </span>
<span id="cb23-621"><a href="#cb23-621" aria-hidden="true" tabindex="-1"></a>between cells. Euclidean measures straight-line distance while cosine measures </span>
<span id="cb23-622"><a href="#cb23-622" aria-hidden="true" tabindex="-1"></a>the angle between gene expression profiles. Since changing this alters </span>
<span id="cb23-623"><a href="#cb23-623" aria-hidden="true" tabindex="-1"></a>which cells are considered "neighbors," the parameter can have large impacts on</span>
<span id="cb23-624"><a href="#cb23-624" aria-hidden="true" tabindex="-1"></a>the global shape. Euclidean is the default many packages but cosine often provides</span>
<span id="cb23-625"><a href="#cb23-625" aria-hidden="true" tabindex="-1"></a>more biologically meaningful clusters for CosMx SMI data.</span>
<span id="cb23-626"><a href="#cb23-626" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The minimum distance parameter (min_dist).** Controls how tightly packed points</span>
<span id="cb23-627"><a href="#cb23-627" aria-hidden="true" tabindex="-1"></a>are within a cluster. Higher values tend to make more diffuse clusters.</span>
<span id="cb23-628"><a href="#cb23-628" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The spread parameter (spread).** Controls the separation between clusters. Lower</span>
<span id="cb23-629"><a href="#cb23-629" aria-hidden="true" tabindex="-1"></a><span class="in">`spread`</span> tends to bring clusters closer together. </span>
<span id="cb23-630"><a href="#cb23-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-631"><a href="#cb23-631" aria-hidden="true" tabindex="-1"></a>This list isn't exhaustive, but varying these while keeping others constant will</span>
<span id="cb23-632"><a href="#cb23-632" aria-hidden="true" tabindex="-1"></a>illustrate their core effects. To make this exploration computationally</span>
<span id="cb23-633"><a href="#cb23-633" aria-hidden="true" tabindex="-1"></a>feasible, we will use a representative subsample of 50,000 cells from our</span>
<span id="cb23-634"><a href="#cb23-634" aria-hidden="true" tabindex="-1"></a>quality-flagged dataset. And to make visualization smooth, we'll only plot at most</span>
<span id="cb23-635"><a href="#cb23-635" aria-hidden="true" tabindex="-1"></a>500 cells.</span>
<span id="cb23-636"><a href="#cb23-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-637"><a href="#cb23-637" aria-hidden="true" tabindex="-1"></a>Click the radio buttons below to see what effect these parameter have on the UMAP</span>
<span id="cb23-638"><a href="#cb23-638" aria-hidden="true" tabindex="-1"></a>visualization. Some of these changes are gradual while some dramatically alter</span>
<span id="cb23-639"><a href="#cb23-639" aria-hidden="true" tabindex="-1"></a>the shape and configuration of the UMAP embeddings. You'll note that filtering out</span>
<span id="cb23-640"><a href="#cb23-640" aria-hidden="true" tabindex="-1"></a>the poor quality cells doesn't merely remove the cells from the UMAP; instead, </span>
<span id="cb23-641"><a href="#cb23-641" aria-hidden="true" tabindex="-1"></a>the inclusion of poorer-quality data can effect the entire UMAP topology. I have </span>
<span id="cb23-642"><a href="#cb23-642" aria-hidden="true" tabindex="-1"></a>also included the Leiden clusters for these cells. The number of PCs and the</span>
<span id="cb23-643"><a href="#cb23-643" aria-hidden="true" tabindex="-1"></a>number of neighbors effect Leiden cluster cell assignment while <span class="in">`spread`</span> and</span>
<span id="cb23-644"><a href="#cb23-644" aria-hidden="true" tabindex="-1"></a><span class="in">`min_dist`</span> do not.</span>
<span id="cb23-645"><a href="#cb23-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-646"><a href="#cb23-646" aria-hidden="true" tabindex="-1"></a>Encouragingly, in this dataset there doesn't appear to be any UMAP clusters that</span>
<span id="cb23-647"><a href="#cb23-647" aria-hidden="true" tabindex="-1"></a>appear to be made up of cells that were flagged in our FOV QC analysis (@sec-fov-qc). If this </span>
<span id="cb23-648"><a href="#cb23-648" aria-hidden="true" tabindex="-1"></a>_was_ the case, it would suggest that we would want to remove the cells in the</span>
<span id="cb23-649"><a href="#cb23-649" aria-hidden="true" tabindex="-1"></a>effected FOVs.</span>
<span id="cb23-650"><a href="#cb23-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-653"><a href="#cb23-653" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-654"><a href="#cb23-654" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-655"><a href="#cb23-655" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb23-656"><a href="#cb23-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-657"><a href="#cb23-657" aria-hidden="true" tabindex="-1"></a><span class="co"># This section is for the example only -- not part of a regular analysis</span></span>
<span id="cb23-658"><a href="#cb23-658" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb23-659"><a href="#cb23-659" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb23-660"><a href="#cb23-660" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb23-661"><a href="#cb23-661" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow <span class="im">as</span> pa</span>
<span id="cb23-662"><a href="#cb23-662" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.parquet <span class="im">as</span> pq</span>
<span id="cb23-663"><a href="#cb23-663" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scanpy <span class="im">as</span> sc</span>
<span id="cb23-664"><a href="#cb23-664" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-665"><a href="#cb23-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-666"><a href="#cb23-666" aria-hidden="true" tabindex="-1"></a>bdata <span class="op">=</span> sc.read_h5ad(os.path.join(r.analysis_dir, <span class="st">"anndata-1-qc-flagged.h5ad"</span>))</span>
<span id="cb23-667"><a href="#cb23-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-668"><a href="#cb23-668" aria-hidden="true" tabindex="-1"></a>n_subsample <span class="op">=</span> <span class="dv">50000</span></span>
<span id="cb23-669"><a href="#cb23-669" aria-hidden="true" tabindex="-1"></a>random_seed <span class="op">=</span> <span class="dv">98103</span></span>
<span id="cb23-670"><a href="#cb23-670" aria-hidden="true" tabindex="-1"></a>sc.pp.subsample(bdata, n_obs<span class="op">=</span>n_subsample, random_state<span class="op">=</span>random_seed)</span>
<span id="cb23-671"><a href="#cb23-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-672"><a href="#cb23-672" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Parameters</span></span>
<span id="cb23-673"><a href="#cb23-673" aria-hidden="true" tabindex="-1"></a>qc_levels <span class="op">=</span> {</span>
<span id="cb23-674"><a href="#cb23-674" aria-hidden="true" tabindex="-1"></a>    <span class="st">"no QC filter"</span>: <span class="va">None</span>,</span>
<span id="cb23-675"><a href="#cb23-675" aria-hidden="true" tabindex="-1"></a>    <span class="st">"include FOV QC cells"</span>: [<span class="dv">0</span>, <span class="dv">32</span>],</span>
<span id="cb23-676"><a href="#cb23-676" aria-hidden="true" tabindex="-1"></a>    <span class="st">"filter all flags"</span>: [<span class="dv">0</span>]</span>
<span id="cb23-677"><a href="#cb23-677" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-678"><a href="#cb23-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-679"><a href="#cb23-679" aria-hidden="true" tabindex="-1"></a><span class="co"># Graph Parameters (affect the topology/connections)</span></span>
<span id="cb23-680"><a href="#cb23-680" aria-hidden="true" tabindex="-1"></a>graph_params <span class="op">=</span> <span class="bu">list</span>(itertools.product(</span>
<span id="cb23-681"><a href="#cb23-681" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>],       <span class="co"># n_pcs</span></span>
<span id="cb23-682"><a href="#cb23-682" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">15</span>, <span class="dv">30</span>, <span class="dv">50</span>],               <span class="co"># n_neighbors</span></span>
<span id="cb23-683"><a href="#cb23-683" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'euclidean'</span>, <span class="st">'cosine'</span>]     <span class="co"># metric</span></span>
<span id="cb23-684"><a href="#cb23-684" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb23-685"><a href="#cb23-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-686"><a href="#cb23-686" aria-hidden="true" tabindex="-1"></a><span class="co"># Layout Parameters (affect only the visualization)</span></span>
<span id="cb23-687"><a href="#cb23-687" aria-hidden="true" tabindex="-1"></a>layout_params <span class="op">=</span> <span class="bu">list</span>(itertools.product(</span>
<span id="cb23-688"><a href="#cb23-688" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span>],     <span class="co"># min_dist</span></span>
<span id="cb23-689"><a href="#cb23-689" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">2.0</span>]             <span class="co"># spread</span></span>
<span id="cb23-690"><a href="#cb23-690" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb23-691"><a href="#cb23-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-692"><a href="#cb23-692" aria-hidden="true" tabindex="-1"></a>all_embeddings_list <span class="op">=</span> []</span>
<span id="cb23-693"><a href="#cb23-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-694"><a href="#cb23-694" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> qc_level, qc_flags <span class="kw">in</span> qc_levels.items():</span>
<span id="cb23-695"><a href="#cb23-695" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"--- Starting QC Level: </span><span class="sc">{</span>qc_level<span class="sc">}</span><span class="ss"> ---"</span>)</span>
<span id="cb23-696"><a href="#cb23-696" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-697"><a href="#cb23-697" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create base object for this QC level</span></span>
<span id="cb23-698"><a href="#cb23-698" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> qc_level <span class="op">!=</span> <span class="st">"no QC filter"</span>:</span>
<span id="cb23-699"><a href="#cb23-699" aria-hidden="true" tabindex="-1"></a>        adata_qc <span class="op">=</span> bdata[bdata.obs[<span class="st">'qcflag'</span>].isin(qc_flags), :].copy()</span>
<span id="cb23-700"><a href="#cb23-700" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb23-701"><a href="#cb23-701" aria-hidden="true" tabindex="-1"></a>        adata_qc <span class="op">=</span> bdata.copy()</span>
<span id="cb23-702"><a href="#cb23-702" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-703"><a href="#cb23-703" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocessing</span></span>
<span id="cb23-704"><a href="#cb23-704" aria-hidden="true" tabindex="-1"></a>    adata_qc.layers[<span class="st">"counts"</span>] <span class="op">=</span> adata_qc.X.copy()</span>
<span id="cb23-705"><a href="#cb23-705" aria-hidden="true" tabindex="-1"></a>    sc.pp.normalize_total(adata_qc)</span>
<span id="cb23-706"><a href="#cb23-706" aria-hidden="true" tabindex="-1"></a>    sc.pp.log1p(adata_qc)</span>
<span id="cb23-707"><a href="#cb23-707" aria-hidden="true" tabindex="-1"></a>    sc.experimental.pp.highly_variable_genes(</span>
<span id="cb23-708"><a href="#cb23-708" aria-hidden="true" tabindex="-1"></a>        adata_qc, flavor<span class="op">=</span><span class="st">'pearson_residuals'</span>, n_top_genes<span class="op">=</span><span class="dv">4000</span>, layer<span class="op">=</span><span class="st">'counts'</span></span>
<span id="cb23-709"><a href="#cb23-709" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-710"><a href="#cb23-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-711"><a href="#cb23-711" aria-hidden="true" tabindex="-1"></a>    adata_qc <span class="op">=</span> adata_qc[:, adata_qc.var.highly_variable].copy()</span>
<span id="cb23-712"><a href="#cb23-712" aria-hidden="true" tabindex="-1"></a>    sc.pp.scale(adata_qc)</span>
<span id="cb23-713"><a href="#cb23-713" aria-hidden="true" tabindex="-1"></a>    sc.tl.pca(adata_qc, svd_solver<span class="op">=</span><span class="st">'auto'</span>) </span>
<span id="cb23-714"><a href="#cb23-714" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-715"><a href="#cb23-715" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n_pcs, n_neighbors, metric <span class="kw">in</span> graph_params:</span>
<span id="cb23-716"><a href="#cb23-716" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"----- Starting graph_params: </span><span class="sc">{</span>n_pcs<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>n_neighbors<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss"> ---"</span>)</span>
<span id="cb23-717"><a href="#cb23-717" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-718"><a href="#cb23-718" aria-hidden="true" tabindex="-1"></a>        adata_graph <span class="op">=</span> adata_qc.copy()</span>
<span id="cb23-719"><a href="#cb23-719" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-720"><a href="#cb23-720" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb23-721"><a href="#cb23-721" aria-hidden="true" tabindex="-1"></a>            sc.pp.neighbors(</span>
<span id="cb23-722"><a href="#cb23-722" aria-hidden="true" tabindex="-1"></a>                adata_graph, </span>
<span id="cb23-723"><a href="#cb23-723" aria-hidden="true" tabindex="-1"></a>                n_pcs<span class="op">=</span>n_pcs, </span>
<span id="cb23-724"><a href="#cb23-724" aria-hidden="true" tabindex="-1"></a>                n_neighbors<span class="op">=</span>n_neighbors, </span>
<span id="cb23-725"><a href="#cb23-725" aria-hidden="true" tabindex="-1"></a>                use_rep<span class="op">=</span><span class="st">'X_pca'</span>, </span>
<span id="cb23-726"><a href="#cb23-726" aria-hidden="true" tabindex="-1"></a>                metric<span class="op">=</span>metric,</span>
<span id="cb23-727"><a href="#cb23-727" aria-hidden="true" tabindex="-1"></a>                random_state<span class="op">=</span>random_seed</span>
<span id="cb23-728"><a href="#cb23-728" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-729"><a href="#cb23-729" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-730"><a href="#cb23-730" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> min_dist, spread <span class="kw">in</span> layout_params:</span>
<span id="cb23-731"><a href="#cb23-731" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb23-732"><a href="#cb23-732" aria-hidden="true" tabindex="-1"></a>                param_string <span class="op">=</span> <span class="ss">f"qc_</span><span class="sc">{</span>qc_level<span class="sc">}</span><span class="ss">_pcs_</span><span class="sc">{</span>n_pcs<span class="sc">}</span><span class="ss">_nn_</span><span class="sc">{</span>n_neighbors<span class="sc">}</span><span class="ss">_met_</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">_md_</span><span class="sc">{</span>min_dist<span class="sc">}</span><span class="ss">_sp_</span><span class="sc">{</span>spread<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb23-733"><a href="#cb23-733" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Running: </span><span class="sc">{</span>param_string<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-734"><a href="#cb23-734" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb23-735"><a href="#cb23-735" aria-hidden="true" tabindex="-1"></a>                sc.tl.umap(adata_graph, min_dist<span class="op">=</span>min_dist, spread<span class="op">=</span>spread, random_state<span class="op">=</span>random_seed)</span>
<span id="cb23-736"><a href="#cb23-736" aria-hidden="true" tabindex="-1"></a>                sc.tl.leiden(adata_graph, resolution<span class="op">=</span><span class="fl">0.5</span>, key_added<span class="op">=</span><span class="st">'leiden'</span>, flavor<span class="op">=</span><span class="st">'igraph'</span>, n_iterations<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb23-737"><a href="#cb23-737" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb23-738"><a href="#cb23-738" aria-hidden="true" tabindex="-1"></a>                embedding_df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb23-739"><a href="#cb23-739" aria-hidden="true" tabindex="-1"></a>                    adata_graph.obsm[<span class="st">'X_umap'</span>], </span>
<span id="cb23-740"><a href="#cb23-740" aria-hidden="true" tabindex="-1"></a>                    index<span class="op">=</span>adata_graph.obs.index, </span>
<span id="cb23-741"><a href="#cb23-741" aria-hidden="true" tabindex="-1"></a>                    columns<span class="op">=</span>[<span class="st">'umap_1'</span>, <span class="st">'umap_2'</span>]</span>
<span id="cb23-742"><a href="#cb23-742" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb23-743"><a href="#cb23-743" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb23-744"><a href="#cb23-744" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add metadata</span></span>
<span id="cb23-745"><a href="#cb23-745" aria-hidden="true" tabindex="-1"></a>                embedding_df[<span class="st">'leiden'</span>] <span class="op">=</span> adata_graph.obs[<span class="st">'leiden'</span>]</span>
<span id="cb23-746"><a href="#cb23-746" aria-hidden="true" tabindex="-1"></a>                embedding_df[<span class="st">'qc'</span>] <span class="op">=</span> qc_level</span>
<span id="cb23-747"><a href="#cb23-747" aria-hidden="true" tabindex="-1"></a>                embedding_df[<span class="st">'n_pcs'</span>] <span class="op">=</span> n_pcs</span>
<span id="cb23-748"><a href="#cb23-748" aria-hidden="true" tabindex="-1"></a>                embedding_df[<span class="st">'n_neighbors'</span>] <span class="op">=</span> n_neighbors</span>
<span id="cb23-749"><a href="#cb23-749" aria-hidden="true" tabindex="-1"></a>                embedding_df[<span class="st">'metric'</span>] <span class="op">=</span> metric</span>
<span id="cb23-750"><a href="#cb23-750" aria-hidden="true" tabindex="-1"></a>                embedding_df[<span class="st">'min_dist'</span>] <span class="op">=</span> min_dist</span>
<span id="cb23-751"><a href="#cb23-751" aria-hidden="true" tabindex="-1"></a>                embedding_df[<span class="st">'spread'</span>] <span class="op">=</span> spread</span>
<span id="cb23-752"><a href="#cb23-752" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb23-753"><a href="#cb23-753" aria-hidden="true" tabindex="-1"></a>                embedding_df <span class="op">=</span> embedding_df.reset_index().rename(columns<span class="op">=</span>{<span class="st">'index'</span>: <span class="st">'cell_id'</span>})</span>
<span id="cb23-754"><a href="#cb23-754" aria-hidden="true" tabindex="-1"></a>                all_embeddings_list.append(embedding_df)</span>
<span id="cb23-755"><a href="#cb23-755" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb23-756"><a href="#cb23-756" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-757"><a href="#cb23-757" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"!!! Error params (</span><span class="sc">{</span>n_pcs<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>n_neighbors<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-758"><a href="#cb23-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-759"><a href="#cb23-759" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.concat(all_embeddings_list, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-760"><a href="#cb23-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-761"><a href="#cb23-761" aria-hidden="true" tabindex="-1"></a>n_subsubsample <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb23-762"><a href="#cb23-762" aria-hidden="true" tabindex="-1"></a>random_seed <span class="op">=</span> <span class="dv">98103</span></span>
<span id="cb23-763"><a href="#cb23-763" aria-hidden="true" tabindex="-1"></a>umap_output_file <span class="op">=</span> <span class="ss">f"./assets/interactives/umap_explore</span><span class="sc">{</span><span class="bu">str</span>(n_subsubsample)<span class="sc">}</span><span class="ss">.parquet"</span></span>
<span id="cb23-764"><a href="#cb23-764" aria-hidden="true" tabindex="-1"></a>qc_flags_output_file <span class="op">=</span> <span class="ss">f"./assets/interactives/umap_explore_qc_flags</span><span class="sc">{</span><span class="bu">str</span>(n_subsubsample)<span class="sc">}</span><span class="ss">.parquet"</span></span>
<span id="cb23-765"><a href="#cb23-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-766"><a href="#cb23-766" aria-hidden="true" tabindex="-1"></a>np.random.seed(random_seed)</span>
<span id="cb23-767"><a href="#cb23-767" aria-hidden="true" tabindex="-1"></a>unique_cell_ids <span class="op">=</span> df[<span class="st">'cell_id'</span>].unique()</span>
<span id="cb23-768"><a href="#cb23-768" aria-hidden="true" tabindex="-1"></a>cell_ids_pick <span class="op">=</span> np.random.choice(</span>
<span id="cb23-769"><a href="#cb23-769" aria-hidden="true" tabindex="-1"></a>    unique_cell_ids, </span>
<span id="cb23-770"><a href="#cb23-770" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span>n_subsubsample, </span>
<span id="cb23-771"><a href="#cb23-771" aria-hidden="true" tabindex="-1"></a>    replace<span class="op">=</span><span class="va">False</span></span>
<span id="cb23-772"><a href="#cb23-772" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-773"><a href="#cb23-773" aria-hidden="true" tabindex="-1"></a>cell_ids_pick_set <span class="op">=</span> <span class="bu">set</span>(cell_ids_pick)</span>
<span id="cb23-774"><a href="#cb23-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-775"><a href="#cb23-775" aria-hidden="true" tabindex="-1"></a>df_filtered <span class="op">=</span> df[df[<span class="st">'cell_id'</span>].isin(cell_ids_pick_set)].copy()</span>
<span id="cb23-776"><a href="#cb23-776" aria-hidden="true" tabindex="-1"></a>pq.write_table(pa.Table.from_pandas(df_filtered), umap_output_file)</span>
<span id="cb23-777"><a href="#cb23-777" aria-hidden="true" tabindex="-1"></a>pq.write_table(pa.Table.from_pandas(df_filtered), <span class="st">"./assets/interactives/umap_explore.parquet"</span>)</span>
<span id="cb23-778"><a href="#cb23-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-779"><a href="#cb23-779" aria-hidden="true" tabindex="-1"></a>bmeta <span class="op">=</span> bdata.obs.loc[bdata.obs.index.isin(cell_ids_pick_set), [<span class="st">'cell_ID'</span>, <span class="st">'qcflag'</span>]].copy()</span>
<span id="cb23-780"><a href="#cb23-780" aria-hidden="true" tabindex="-1"></a>bmeta[<span class="st">'cell_id'</span>] <span class="op">=</span> bmeta.index</span>
<span id="cb23-781"><a href="#cb23-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-782"><a href="#cb23-782" aria-hidden="true" tabindex="-1"></a>bmeta_filtered <span class="op">=</span> bmeta.loc[bmeta[<span class="st">'qcflag'</span>] <span class="op">!=</span> <span class="dv">0</span>, [<span class="st">'cell_id'</span>, <span class="st">'qcflag'</span>]].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-783"><a href="#cb23-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-784"><a href="#cb23-784" aria-hidden="true" tabindex="-1"></a>pq.write_table(pa.Table.from_pandas(bmeta_filtered), qc_flags_output_file)</span>
<span id="cb23-785"><a href="#cb23-785" aria-hidden="true" tabindex="-1"></a>pq.write_table(pa.Table.from_pandas(bmeta_filtered), <span class="st">"./assets/interactives/umap_explore_qc_flags.parquet"</span>)</span>
<span id="cb23-786"><a href="#cb23-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-787"><a href="#cb23-787" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-788"><a href="#cb23-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-789"><a href="#cb23-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-790"><a href="#cb23-790" aria-hidden="true" tabindex="-1"></a>:::: {.columns}</span>
<span id="cb23-791"><a href="#cb23-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-792"><a href="#cb23-792" aria-hidden="true" tabindex="-1"></a>::: {.column width="40%"}</span>
<span id="cb23-793"><a href="#cb23-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-794"><a href="#cb23-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-797"><a href="#cb23-797" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr}</span></span>
<span id="cb23-798"><a href="#cb23-798" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb23-799"><a href="#cb23-799" aria-hidden="true" tabindex="-1"></a><span class="in">#| eval: true</span></span>
<span id="cb23-800"><a href="#cb23-800" aria-hidden="true" tabindex="-1"></a><span class="in">#| edit: false</span></span>
<span id="cb23-801"><a href="#cb23-801" aria-hidden="true" tabindex="-1"></a><span class="in">#| define:</span></span>
<span id="cb23-802"><a href="#cb23-802" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - qc_flags_data</span></span>
<span id="cb23-803"><a href="#cb23-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-804"><a href="#cb23-804" aria-hidden="true" tabindex="-1"></a><span class="in"># This block fetches the QC</span></span>
<span id="cb23-805"><a href="#cb23-805" aria-hidden="true" tabindex="-1"></a><span class="in"># flag codes for the cell ids (numeric) so that it can be merged in the plots</span></span>
<span id="cb23-806"><a href="#cb23-806" aria-hidden="true" tabindex="-1"></a><span class="in"># and tables.</span></span>
<span id="cb23-807"><a href="#cb23-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-808"><a href="#cb23-808" aria-hidden="true" tabindex="-1"></a><span class="in">qc_flags_file &lt;- "assets/interactives/umap_explore_qc_flags.parquet"</span></span>
<span id="cb23-809"><a href="#cb23-809" aria-hidden="true" tabindex="-1"></a><span class="in">qc_flags_data &lt;- data.frame(cell_id = character(), qcflag = integer())</span></span>
<span id="cb23-810"><a href="#cb23-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-811"><a href="#cb23-811" aria-hidden="true" tabindex="-1"></a><span class="in">con &lt;- tryCatch({ dbConnect(duckdb()) }, error = function(e) { print(e); NULL })</span></span>
<span id="cb23-812"><a href="#cb23-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-813"><a href="#cb23-813" aria-hidden="true" tabindex="-1"></a><span class="in">if (!is.null(con)) {</span></span>
<span id="cb23-814"><a href="#cb23-814" aria-hidden="true" tabindex="-1"></a><span class="in">  if (file.exists(qc_flags_file)) {</span></span>
<span id="cb23-815"><a href="#cb23-815" aria-hidden="true" tabindex="-1"></a><span class="in">    # print("Loading QC flags data...")</span></span>
<span id="cb23-816"><a href="#cb23-816" aria-hidden="true" tabindex="-1"></a><span class="in">    qc_flags_data &lt;- tryCatch({</span></span>
<span id="cb23-817"><a href="#cb23-817" aria-hidden="true" tabindex="-1"></a><span class="in">      dbGetQuery(con, paste0("SELECT * FROM '", qc_flags_file, "'"))</span></span>
<span id="cb23-818"><a href="#cb23-818" aria-hidden="true" tabindex="-1"></a><span class="in">    }, error = function(e) {</span></span>
<span id="cb23-819"><a href="#cb23-819" aria-hidden="true" tabindex="-1"></a><span class="in">      # print("Error reading QC flags parquet:")</span></span>
<span id="cb23-820"><a href="#cb23-820" aria-hidden="true" tabindex="-1"></a><span class="in">      print(e)</span></span>
<span id="cb23-821"><a href="#cb23-821" aria-hidden="true" tabindex="-1"></a><span class="in">      qc_flags_data # Return default empty</span></span>
<span id="cb23-822"><a href="#cb23-822" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb23-823"><a href="#cb23-823" aria-hidden="true" tabindex="-1"></a><span class="in">    # print(paste("Loaded", nrow(qc_flags_data), "QC flag entries."))</span></span>
<span id="cb23-824"><a href="#cb23-824" aria-hidden="true" tabindex="-1"></a><span class="in">  } else {</span></span>
<span id="cb23-825"><a href="#cb23-825" aria-hidden="true" tabindex="-1"></a><span class="in">    print(paste("QC flags file not found:", qc_flags_file))</span></span>
<span id="cb23-826"><a href="#cb23-826" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb23-827"><a href="#cb23-827" aria-hidden="true" tabindex="-1"></a><span class="in">  dbDisconnect(con, shutdown = TRUE)</span></span>
<span id="cb23-828"><a href="#cb23-828" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb23-829"><a href="#cb23-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-830"><a href="#cb23-830" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-831"><a href="#cb23-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-832"><a href="#cb23-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-835"><a href="#cb23-835" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb23-836"><a href="#cb23-836" aria-hidden="true" tabindex="-1"></a><span class="co">//| eval: true</span></span>
<span id="cb23-837"><a href="#cb23-837" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb23-838"><a href="#cb23-838" aria-hidden="true" tabindex="-1"></a>viewof qc_level <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="st">"no QC filter"</span><span class="op">,</span> <span class="st">"include FOV QC cells"</span><span class="op">,</span> <span class="st">"filter all flags"</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"QC Level"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">"include FOV QC cells"</span>})</span>
<span id="cb23-839"><a href="#cb23-839" aria-hidden="true" tabindex="-1"></a>viewof n_pcs <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">50</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"PCs"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">30</span>})</span>
<span id="cb23-840"><a href="#cb23-840" aria-hidden="true" tabindex="-1"></a>viewof n_neighbors <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="dv">15</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">50</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"Neighbors"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">30</span>})</span>
<span id="cb23-841"><a href="#cb23-841" aria-hidden="true" tabindex="-1"></a>viewof metric <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="st">"euclidean"</span><span class="op">,</span> <span class="st">"cosine"</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"Metric"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">"cosine"</span>})</span>
<span id="cb23-842"><a href="#cb23-842" aria-hidden="true" tabindex="-1"></a>viewof mdist <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="fl">0.01</span><span class="op">,</span> <span class="fl">0.05</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.5</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"Min. distance"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="fl">0.2</span>})</span>
<span id="cb23-843"><a href="#cb23-843" aria-hidden="true" tabindex="-1"></a>viewof spread <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="fl">0.5</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="fl">2.0</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"Spread"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="fl">2.0</span>})</span>
<span id="cb23-844"><a href="#cb23-844" aria-hidden="true" tabindex="-1"></a>viewof colorby <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">radio</span>([<span class="st">"QC"</span><span class="op">,</span> <span class="st">"Leiden"</span>]<span class="op">,</span> {<span class="dt">label</span><span class="op">:</span> <span class="st">"Color by"</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">"QC"</span>})</span>
<span id="cb23-845"><a href="#cb23-845" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-846"><a href="#cb23-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-847"><a href="#cb23-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-850"><a href="#cb23-850" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr}</span></span>
<span id="cb23-851"><a href="#cb23-851" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb23-852"><a href="#cb23-852" aria-hidden="true" tabindex="-1"></a><span class="in">#| eval: true</span></span>
<span id="cb23-853"><a href="#cb23-853" aria-hidden="true" tabindex="-1"></a><span class="in">#| edit: false</span></span>
<span id="cb23-854"><a href="#cb23-854" aria-hidden="true" tabindex="-1"></a><span class="in">#| input:</span></span>
<span id="cb23-855"><a href="#cb23-855" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - qc_level</span></span>
<span id="cb23-856"><a href="#cb23-856" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - n_pcs</span></span>
<span id="cb23-857"><a href="#cb23-857" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - n_neighbors</span></span>
<span id="cb23-858"><a href="#cb23-858" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - metric</span></span>
<span id="cb23-859"><a href="#cb23-859" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - mdist</span></span>
<span id="cb23-860"><a href="#cb23-860" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - spread</span></span>
<span id="cb23-861"><a href="#cb23-861" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - colorby</span></span>
<span id="cb23-862"><a href="#cb23-862" aria-hidden="true" tabindex="-1"></a><span class="in">#| define:</span></span>
<span id="cb23-863"><a href="#cb23-863" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - query_data</span></span>
<span id="cb23-864"><a href="#cb23-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-865"><a href="#cb23-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-866"><a href="#cb23-866" aria-hidden="true" tabindex="-1"></a><span class="in"># connection to an in-memory DuckDB database.</span></span>
<span id="cb23-867"><a href="#cb23-867" aria-hidden="true" tabindex="-1"></a><span class="in">con &lt;- dbConnect(duckdb())</span></span>
<span id="cb23-868"><a href="#cb23-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-869"><a href="#cb23-869" aria-hidden="true" tabindex="-1"></a><span class="in"># build the SQL query</span></span>
<span id="cb23-870"><a href="#cb23-870" aria-hidden="true" tabindex="-1"></a><span class="in">query &lt;- paste0(</span></span>
<span id="cb23-871"><a href="#cb23-871" aria-hidden="true" tabindex="-1"></a><span class="in">  "SELECT * FROM 'assets/interactives/umap_explore.parquet' WHERE qc = '",</span></span>
<span id="cb23-872"><a href="#cb23-872" aria-hidden="true" tabindex="-1"></a><span class="in">  qc_level,</span></span>
<span id="cb23-873"><a href="#cb23-873" aria-hidden="true" tabindex="-1"></a><span class="in">  "' AND n_pcs = '",</span></span>
<span id="cb23-874"><a href="#cb23-874" aria-hidden="true" tabindex="-1"></a><span class="in">  n_pcs,</span></span>
<span id="cb23-875"><a href="#cb23-875" aria-hidden="true" tabindex="-1"></a><span class="in">  "' AND n_neighbors = '",</span></span>
<span id="cb23-876"><a href="#cb23-876" aria-hidden="true" tabindex="-1"></a><span class="in">  n_neighbors,</span></span>
<span id="cb23-877"><a href="#cb23-877" aria-hidden="true" tabindex="-1"></a><span class="in">  "' AND metric = '", </span></span>
<span id="cb23-878"><a href="#cb23-878" aria-hidden="true" tabindex="-1"></a><span class="in">  metric,</span></span>
<span id="cb23-879"><a href="#cb23-879" aria-hidden="true" tabindex="-1"></a><span class="in">  "' AND min_dist = '",</span></span>
<span id="cb23-880"><a href="#cb23-880" aria-hidden="true" tabindex="-1"></a><span class="in">  mdist,</span></span>
<span id="cb23-881"><a href="#cb23-881" aria-hidden="true" tabindex="-1"></a><span class="in">  "' AND spread = '",</span></span>
<span id="cb23-882"><a href="#cb23-882" aria-hidden="true" tabindex="-1"></a><span class="in">  spread, "'"</span></span>
<span id="cb23-883"><a href="#cb23-883" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb23-884"><a href="#cb23-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-885"><a href="#cb23-885" aria-hidden="true" tabindex="-1"></a><span class="in">query_data &lt;- tryCatch({</span></span>
<span id="cb23-886"><a href="#cb23-886" aria-hidden="true" tabindex="-1"></a><span class="in">    dbGetQuery(con, query)</span></span>
<span id="cb23-887"><a href="#cb23-887" aria-hidden="true" tabindex="-1"></a><span class="in">  }, error = function(e) {</span></span>
<span id="cb23-888"><a href="#cb23-888" aria-hidden="true" tabindex="-1"></a><span class="in">    print("--- SQL Query Error ---")</span></span>
<span id="cb23-889"><a href="#cb23-889" aria-hidden="true" tabindex="-1"></a><span class="in">    print("Query that failed:")</span></span>
<span id="cb23-890"><a href="#cb23-890" aria-hidden="true" tabindex="-1"></a><span class="in">    print(query)</span></span>
<span id="cb23-891"><a href="#cb23-891" aria-hidden="true" tabindex="-1"></a><span class="in">    print("Error message:")</span></span>
<span id="cb23-892"><a href="#cb23-892" aria-hidden="true" tabindex="-1"></a><span class="in">    print(e)</span></span>
<span id="cb23-893"><a href="#cb23-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-894"><a href="#cb23-894" aria-hidden="true" tabindex="-1"></a><span class="in">    data.frame(</span></span>
<span id="cb23-895"><a href="#cb23-895" aria-hidden="true" tabindex="-1"></a><span class="in">      cell_id = character(), </span></span>
<span id="cb23-896"><a href="#cb23-896" aria-hidden="true" tabindex="-1"></a><span class="in">      umap_1 = numeric(), </span></span>
<span id="cb23-897"><a href="#cb23-897" aria-hidden="true" tabindex="-1"></a><span class="in">      umap_2 = numeric()</span></span>
<span id="cb23-898"><a href="#cb23-898" aria-hidden="true" tabindex="-1"></a><span class="in">    ) </span></span>
<span id="cb23-899"><a href="#cb23-899" aria-hidden="true" tabindex="-1"></a><span class="in">  })</span></span>
<span id="cb23-900"><a href="#cb23-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-901"><a href="#cb23-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-902"><a href="#cb23-902" aria-hidden="true" tabindex="-1"></a><span class="in">dbDisconnect(con, shutdown = TRUE)</span></span>
<span id="cb23-903"><a href="#cb23-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-904"><a href="#cb23-904" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-905"><a href="#cb23-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-906"><a href="#cb23-906" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- static QC flag legend and defs --&gt;</span></span>
<span id="cb23-909"><a href="#cb23-909" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb23-910"><a href="#cb23-910" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb23-911"><a href="#cb23-911" aria-hidden="true" tabindex="-1"></a><span class="co">//| eval: true</span></span>
<span id="cb23-912"><a href="#cb23-912" aria-hidden="true" tabindex="-1"></a><span class="co">//| output: false</span></span>
<span id="cb23-913"><a href="#cb23-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-914"><a href="#cb23-914" aria-hidden="true" tabindex="-1"></a><span class="co">// Define the meaning of each bit</span></span>
<span id="cb23-915"><a href="#cb23-915" aria-hidden="true" tabindex="-1"></a>qcMasks <span class="op">=</span> ({</span>
<span id="cb23-916"><a href="#cb23-916" aria-hidden="true" tabindex="-1"></a>  <span class="dt">LOW_COUNTS</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">0</span><span class="op">,</span> </span>
<span id="cb23-917"><a href="#cb23-917" aria-hidden="true" tabindex="-1"></a>  <span class="dt">HIGH_COUNTS</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">1</span><span class="op">,</span> </span>
<span id="cb23-918"><a href="#cb23-918" aria-hidden="true" tabindex="-1"></a>  <span class="dt">LOW_FEAT</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb23-919"><a href="#cb23-919" aria-hidden="true" tabindex="-1"></a>  <span class="dt">HIGH_FEAT</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">3</span><span class="op">,</span> </span>
<span id="cb23-920"><a href="#cb23-920" aria-hidden="true" tabindex="-1"></a>  <span class="dt">LOW_SPLIT</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">4</span><span class="op">,</span> </span>
<span id="cb23-921"><a href="#cb23-921" aria-hidden="true" tabindex="-1"></a>  <span class="dt">FOV_QC</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">5</span><span class="op">,</span> </span>
<span id="cb23-922"><a href="#cb23-922" aria-hidden="true" tabindex="-1"></a>  <span class="dt">LOW_SBR</span><span class="op">:</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">6</span></span>
<span id="cb23-923"><a href="#cb23-923" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-924"><a href="#cb23-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-925"><a href="#cb23-925" aria-hidden="true" tabindex="-1"></a>flagNames <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(qcMasks)<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> qcMasks[a] <span class="op">-</span> qcMasks[b])<span class="op">;</span></span>
<span id="cb23-926"><a href="#cb23-926" aria-hidden="true" tabindex="-1"></a>qcFlagMap <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(qc_flags_data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> [d<span class="op">.</span><span class="at">cell_id</span><span class="op">,</span> d<span class="op">.</span><span class="at">qcflag</span>]))<span class="op">;</span></span>
<span id="cb23-927"><a href="#cb23-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-928"><a href="#cb23-928" aria-hidden="true" tabindex="-1"></a>flagColors <span class="op">=</span> {</span>
<span id="cb23-929"><a href="#cb23-929" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> uniqueFlagsInData <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">new</span> <span class="bu">Set</span>(qc_flags_data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">qcflag</span>)))<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">-</span> b)<span class="op">;</span></span>
<span id="cb23-930"><a href="#cb23-930" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> uniqueFlagsWithZero <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">new</span> <span class="bu">Set</span>([<span class="dv">0</span><span class="op">,</span> <span class="op">...</span>uniqueFlagsInData]))<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span>b)<span class="kw">=&gt;</span> a<span class="op">-</span>b)<span class="op">;</span></span>
<span id="cb23-931"><a href="#cb23-931" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> colors <span class="op">=</span> d3<span class="op">.</span><span class="at">schemeTableau10</span><span class="op">;</span></span>
<span id="cb23-932"><a href="#cb23-932" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> map <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb23-933"><a href="#cb23-933" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> colorIndex <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb23-934"><a href="#cb23-934" aria-hidden="true" tabindex="-1"></a>  uniqueFlagsWithZero<span class="op">.</span><span class="fu">forEach</span>(flagValue <span class="kw">=&gt;</span> {</span>
<span id="cb23-935"><a href="#cb23-935" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (flagValue <span class="op">===</span> <span class="dv">0</span>) { map[flagValue] <span class="op">=</span> <span class="st">"black"</span><span class="op">;</span> }</span>
<span id="cb23-936"><a href="#cb23-936" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> { map[flagValue] <span class="op">=</span> colors[colorIndex<span class="op">++</span> <span class="op">%</span> colors<span class="op">.</span><span class="at">length</span>]<span class="op">;</span> }</span>
<span id="cb23-937"><a href="#cb23-937" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb23-938"><a href="#cb23-938" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> map<span class="op">;</span></span>
<span id="cb23-939"><a href="#cb23-939" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-940"><a href="#cb23-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-941"><a href="#cb23-941" aria-hidden="true" tabindex="-1"></a>qcColorScale <span class="op">=</span> (flagValue) <span class="kw">=&gt;</span> flagColors[flagValue <span class="op">??</span> <span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb23-942"><a href="#cb23-942" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-943"><a href="#cb23-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-944"><a href="#cb23-944" aria-hidden="true" tabindex="-1"></a>::: {.columns}</span>
<span id="cb23-945"><a href="#cb23-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-946"><a href="#cb23-946" aria-hidden="true" tabindex="-1"></a>::: {.column width="70%"}</span>
<span id="cb23-947"><a href="#cb23-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-948"><a href="#cb23-948" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- QC legend --&gt;</span></span>
<span id="cb23-951"><a href="#cb23-951" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb23-952"><a href="#cb23-952" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb23-953"><a href="#cb23-953" aria-hidden="true" tabindex="-1"></a><span class="co">//| eval: true</span></span>
<span id="cb23-954"><a href="#cb23-954" aria-hidden="true" tabindex="-1"></a><span class="co">//| output: true</span></span>
<span id="cb23-955"><a href="#cb23-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-956"><a href="#cb23-956" aria-hidden="true" tabindex="-1"></a>qcFlagLegend <span class="op">=</span> {</span>
<span id="cb23-957"><a href="#cb23-957" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb23-958"><a href="#cb23-958" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> uniqueFlagsWithZero <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(flagColors)<span class="op">.</span><span class="fu">map</span>(<span class="bu">Number</span>)<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span>b)<span class="kw">=&gt;</span> a<span class="op">-</span>b)<span class="op">;</span></span>
<span id="cb23-959"><a href="#cb23-959" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tableRows <span class="op">=</span> uniqueFlagsWithZero<span class="op">.</span><span class="fu">map</span>(flagValue <span class="kw">=&gt;</span> {</span>
<span id="cb23-960"><a href="#cb23-960" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> flagColor <span class="op">=</span> flagColors[flagValue]<span class="op">;</span> <span class="co">// Use static map</span></span>
<span id="cb23-961"><a href="#cb23-961" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> circles <span class="op">=</span> flagNames<span class="op">.</span><span class="fu">map</span>(name <span class="kw">=&gt;</span> {</span>
<span id="cb23-962"><a href="#cb23-962" aria-hidden="true" tabindex="-1"></a>         <span class="kw">const</span> mask <span class="op">=</span> qcMasks[name]<span class="op">;</span></span>
<span id="cb23-963"><a href="#cb23-963" aria-hidden="true" tabindex="-1"></a>         <span class="kw">const</span> isSet <span class="op">=</span> (flagValue <span class="op">&amp;</span> mask) <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb23-964"><a href="#cb23-964" aria-hidden="true" tabindex="-1"></a>         <span class="kw">const</span> circleFill <span class="op">=</span> isSet <span class="op">?</span> flagColor <span class="op">:</span> <span class="st">"#e0e0e0"</span><span class="op">;</span></span>
<span id="cb23-965"><a href="#cb23-965" aria-hidden="true" tabindex="-1"></a>         <span class="kw">const</span> circleSvg <span class="op">=</span> <span class="vs">`&lt;svg width="15" height="15"&gt;&lt;circle cx="7.5" cy="7.5" r="6" fill="</span><span class="sc">${</span>circleFill<span class="sc">}</span><span class="vs">" stroke="</span><span class="sc">${</span>isSet <span class="op">?</span> <span class="st">'black'</span> <span class="op">:</span> <span class="st">'#ccc'</span><span class="sc">}</span><span class="vs">" stroke-width="1"&gt;&lt;/circle&gt;&lt;/svg&gt;`</span><span class="op">;</span></span>
<span id="cb23-966"><a href="#cb23-966" aria-hidden="true" tabindex="-1"></a>         <span class="cf">return</span> <span class="vs">`&lt;td style="text-align: center;"&gt;</span><span class="sc">${</span>circleSvg<span class="sc">}</span><span class="vs">&lt;/td&gt;`</span><span class="op">;</span></span>
<span id="cb23-967"><a href="#cb23-967" aria-hidden="true" tabindex="-1"></a>      })<span class="op">.</span><span class="fu">join</span>(<span class="st">''</span>)<span class="op">;</span></span>
<span id="cb23-968"><a href="#cb23-968" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> rowHeader <span class="op">=</span> <span class="vs">`&lt;th scope="row" style="text-align: right; padding-right: 10px; white-space: nowrap;"&gt;</span></span>
<span id="cb23-969"><a href="#cb23-969" aria-hidden="true" tabindex="-1"></a><span class="vs">                           &lt;span style="display: inline-block; width: 12px; height: 12px; background-color: </span><span class="sc">${</span>flagColor<span class="sc">}</span><span class="vs">; border: 1px solid #555; margin-right: 5px; vertical-align: middle;"&gt;&lt;/span&gt;</span></span>
<span id="cb23-970"><a href="#cb23-970" aria-hidden="true" tabindex="-1"></a><span class="vs">                           </span><span class="sc">${</span>flagValue <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">'Passed'</span> <span class="op">:</span> flagValue<span class="sc">}</span></span>
<span id="cb23-971"><a href="#cb23-971" aria-hidden="true" tabindex="-1"></a><span class="vs">                         &lt;/th&gt;`</span><span class="op">;</span></span>
<span id="cb23-972"><a href="#cb23-972" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="vs">`&lt;tr&gt;</span><span class="sc">${</span>rowHeader<span class="sc">}${</span>circles<span class="sc">}</span><span class="vs">&lt;/tr&gt;`</span><span class="op">;</span></span>
<span id="cb23-973"><a href="#cb23-973" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">join</span>(<span class="st">''</span>)<span class="op">;</span></span>
<span id="cb23-974"><a href="#cb23-974" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> headerCells <span class="op">=</span> flagNames<span class="op">.</span><span class="fu">map</span>(name <span class="kw">=&gt;</span></span>
<span id="cb23-975"><a href="#cb23-975" aria-hidden="true" tabindex="-1"></a>      <span class="vs">`&lt;th style="height: 100px; text-align: center; vertical-align: bottom; padding-bottom: 5px; font-size: 0.8em; white-space: nowrap;"&gt;</span></span>
<span id="cb23-976"><a href="#cb23-976" aria-hidden="true" tabindex="-1"></a><span class="vs">         &lt;span style="writing-mode: vertical-lr; transform: rotate(180deg);"&gt;</span><span class="sc">${</span>name<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/_/g</span><span class="op">,</span> <span class="st">' '</span>)<span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb23-977"><a href="#cb23-977" aria-hidden="true" tabindex="-1"></a><span class="vs">       &lt;/th&gt;`</span></span>
<span id="cb23-978"><a href="#cb23-978" aria-hidden="true" tabindex="-1"></a>    )<span class="op">.</span><span class="fu">join</span>(<span class="st">''</span>)<span class="op">;</span></span>
<span id="cb23-979"><a href="#cb23-979" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tableHeader <span class="op">=</span> <span class="vs">`&lt;thead&gt;&lt;tr&gt;&lt;th style="vertical-align: bottom;"&gt;Flag Value&lt;/th&gt;</span><span class="sc">${</span>headerCells<span class="sc">}</span><span class="vs">&lt;/tr&gt;&lt;/thead&gt;`</span><span class="op">;</span></span>
<span id="cb23-980"><a href="#cb23-980" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;table style="border-collapse: collapse; margin-top: 10px; font-size: 0.9em; table-layout: fixed;"&gt;</span></span>
<span id="cb23-981"><a href="#cb23-981" aria-hidden="true" tabindex="-1"></a><span class="vs">                   </span><span class="sc">${</span>tableHeader<span class="sc">}</span><span class="vs">&lt;tbody&gt;</span><span class="sc">${</span>tableRows<span class="sc">}</span><span class="vs">&lt;/tbody&gt;</span></span>
<span id="cb23-982"><a href="#cb23-982" aria-hidden="true" tabindex="-1"></a><span class="vs">                 &lt;/table&gt;`</span><span class="op">;</span></span>
<span id="cb23-983"><a href="#cb23-983" aria-hidden="true" tabindex="-1"></a>   } <span class="cf">catch</span> (error) {</span>
<span id="cb23-984"><a href="#cb23-984" aria-hidden="true" tabindex="-1"></a>     <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error generating QC Legend:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb23-985"><a href="#cb23-985" aria-hidden="true" tabindex="-1"></a>     <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Error generating QC Legend&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb23-986"><a href="#cb23-986" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb23-987"><a href="#cb23-987" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-988"><a href="#cb23-988" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-989"><a href="#cb23-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-990"><a href="#cb23-990" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-991"><a href="#cb23-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-992"><a href="#cb23-992" aria-hidden="true" tabindex="-1"></a>::: {.column width="3%"}</span>
<span id="cb23-993"><a href="#cb23-993" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- empty column to create gap --&gt;</span></span>
<span id="cb23-994"><a href="#cb23-994" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-995"><a href="#cb23-995" aria-hidden="true" tabindex="-1"></a>::: {.column width="27%"}</span>
<span id="cb23-996"><a href="#cb23-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-999"><a href="#cb23-999" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb23-1000"><a href="#cb23-1000" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb23-1001"><a href="#cb23-1001" aria-hidden="true" tabindex="-1"></a><span class="co">//| eval: true</span></span>
<span id="cb23-1002"><a href="#cb23-1002" aria-hidden="true" tabindex="-1"></a><span class="co">//| output: true</span></span>
<span id="cb23-1003"><a href="#cb23-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1004"><a href="#cb23-1004" aria-hidden="true" tabindex="-1"></a>leidenScaleAndLegend <span class="op">=</span> {</span>
<span id="cb23-1005"><a href="#cb23-1005" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> scale<span class="op">,</span> legend<span class="op">;</span></span>
<span id="cb23-1006"><a href="#cb23-1006" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> { <span class="co">// Add try...catch</span></span>
<span id="cb23-1007"><a href="#cb23-1007" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if query_data is ready and has 'leiden'</span></span>
<span id="cb23-1008"><a href="#cb23-1008" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>query_data <span class="op">||</span> query_data<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span> <span class="op">||</span> <span class="op">!</span>query_data[<span class="dv">0</span>]<span class="op">.</span><span class="fu">hasOwnProperty</span>(<span class="st">'leiden'</span>)) {</span>
<span id="cb23-1009"><a href="#cb23-1009" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">"Leiden data (query_data) not ready for legend/scale."</span>)<span class="op">;</span></span>
<span id="cb23-1010"><a href="#cb23-1010" aria-hidden="true" tabindex="-1"></a>        scale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleOrdinal</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="st">"0"</span>])<span class="op">.</span><span class="fu">range</span>([<span class="st">"grey"</span>])<span class="op">;</span> <span class="co">// Placeholder scale</span></span>
<span id="cb23-1011"><a href="#cb23-1011" aria-hidden="true" tabindex="-1"></a>        legend <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;&lt;ul style="list-style: none; padding-left: 0; margin-top: 10px; font-size: 0.9em;"&gt;</span></span>
<span id="cb23-1012"><a href="#cb23-1012" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;li style="margin-bottom: 2px;"&gt;&lt;span style="display: inline-block; width: 12px; height: 12px; background-color: grey; border: 1px solid #555; margin-right: 5px; vertical-align: middle;"&gt;&lt;/span&gt; Cluster 0&lt;/li&gt;</span></span>
<span id="cb23-1013"><a href="#cb23-1013" aria-hidden="true" tabindex="-1"></a><span class="vs">                      &lt;/ul&gt;(Loading...)&lt;/div&gt;`</span><span class="op">;</span> <span class="co">// placeholder</span></span>
<span id="cb23-1014"><a href="#cb23-1014" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb23-1015"><a href="#cb23-1015" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> uniqueClusters <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">new</span> <span class="bu">Set</span>(query_data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">leiden</span>)))<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> a <span class="op">-</span> b)<span class="op">;</span></span>
<span id="cb23-1016"><a href="#cb23-1016" aria-hidden="true" tabindex="-1"></a>        scale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleOrdinal</span>(d3<span class="op">.</span><span class="at">schemeTableau10</span>)<span class="op">.</span><span class="fu">domain</span>(uniqueClusters)<span class="op">;</span></span>
<span id="cb23-1017"><a href="#cb23-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1018"><a href="#cb23-1018" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> legendItems <span class="op">=</span> uniqueClusters<span class="op">.</span><span class="fu">map</span>(cluster <span class="kw">=&gt;</span> {</span>
<span id="cb23-1019"><a href="#cb23-1019" aria-hidden="true" tabindex="-1"></a>           <span class="kw">const</span> color <span class="op">=</span> <span class="fu">scale</span>(cluster)<span class="op">;</span></span>
<span id="cb23-1020"><a href="#cb23-1020" aria-hidden="true" tabindex="-1"></a>           <span class="kw">const</span> clusterLabel <span class="op">=</span> <span class="bu">String</span>(cluster)<span class="op">;</span></span>
<span id="cb23-1021"><a href="#cb23-1021" aria-hidden="true" tabindex="-1"></a>           <span class="cf">return</span> <span class="vs">`&lt;li style="margin-bottom: 2px;"&gt;&lt;span style="display: inline-block; width: 12px; height: 12px; background-color: </span><span class="sc">${</span>color<span class="sc">}</span><span class="vs">; border: 1px solid #555; margin-right: 5px; vertical-align: middle;"&gt;&lt;/span&gt; Cluster </span><span class="sc">${</span>clusterLabel<span class="sc">}</span><span class="vs">&lt;/li&gt;`</span><span class="op">;</span></span>
<span id="cb23-1022"><a href="#cb23-1022" aria-hidden="true" tabindex="-1"></a>        })<span class="op">.</span><span class="fu">join</span>(<span class="st">''</span>)<span class="op">;</span></span>
<span id="cb23-1023"><a href="#cb23-1023" aria-hidden="true" tabindex="-1"></a>        legend <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;ul style="list-style: none; padding-left: 0; margin-top: 10px; font-size: 0.9em;"&gt;</span><span class="sc">${</span>legendItems<span class="sc">}</span><span class="vs">&lt;/ul&gt;`</span><span class="op">;</span></span>
<span id="cb23-1024"><a href="#cb23-1024" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-1025"><a href="#cb23-1025" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span>(error) {</span>
<span id="cb23-1026"><a href="#cb23-1026" aria-hidden="true" tabindex="-1"></a>     <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error generating Leiden Legend:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb23-1027"><a href="#cb23-1027" aria-hidden="true" tabindex="-1"></a>     scale <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="st">'grey'</span><span class="op">;</span></span>
<span id="cb23-1028"><a href="#cb23-1028" aria-hidden="true" tabindex="-1"></a>     legend <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Error generating Leiden Legend&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb23-1029"><a href="#cb23-1029" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-1030"><a href="#cb23-1030" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> { scale<span class="op">,</span> legend }<span class="op">;</span></span>
<span id="cb23-1031"><a href="#cb23-1031" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-1032"><a href="#cb23-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1033"><a href="#cb23-1033" aria-hidden="true" tabindex="-1"></a>leidenColorScale <span class="op">=</span> leidenScaleAndLegend<span class="op">.</span><span class="at">scale</span></span>
<span id="cb23-1034"><a href="#cb23-1034" aria-hidden="true" tabindex="-1"></a>leidenLegendHtml <span class="op">=</span> leidenScaleAndLegend<span class="op">.</span><span class="at">legend</span></span>
<span id="cb23-1035"><a href="#cb23-1035" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1036"><a href="#cb23-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1037"><a href="#cb23-1037" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-1038"><a href="#cb23-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1039"><a href="#cb23-1039" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-1040"><a href="#cb23-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1041"><a href="#cb23-1041" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-1042"><a href="#cb23-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1043"><a href="#cb23-1043" aria-hidden="true" tabindex="-1"></a>::: {.column width="5%"}</span>
<span id="cb23-1044"><a href="#cb23-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1045"><a href="#cb23-1045" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-1046"><a href="#cb23-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1047"><a href="#cb23-1047" aria-hidden="true" tabindex="-1"></a>::: {.column width="55%"}</span>
<span id="cb23-1048"><a href="#cb23-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1049"><a href="#cb23-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1052"><a href="#cb23-1052" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb23-1053"><a href="#cb23-1053" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb23-1054"><a href="#cb23-1054" aria-hidden="true" tabindex="-1"></a><span class="co">//| eval: true</span></span>
<span id="cb23-1055"><a href="#cb23-1055" aria-hidden="true" tabindex="-1"></a><span class="co">//| message: false</span></span>
<span id="cb23-1056"><a href="#cb23-1056" aria-hidden="true" tabindex="-1"></a><span class="co">//| output: false</span></span>
<span id="cb23-1057"><a href="#cb23-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1058"><a href="#cb23-1058" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3@7"</span>)</span>
<span id="cb23-1059"><a href="#cb23-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1060"><a href="#cb23-1060" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb23-1061"><a href="#cb23-1061" aria-hidden="true" tabindex="-1"></a>height <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb23-1062"><a href="#cb23-1062" aria-hidden="true" tabindex="-1"></a>marginTop <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb23-1063"><a href="#cb23-1063" aria-hidden="true" tabindex="-1"></a>marginRight <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb23-1064"><a href="#cb23-1064" aria-hidden="true" tabindex="-1"></a>marginBottom <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb23-1065"><a href="#cb23-1065" aria-hidden="true" tabindex="-1"></a>marginLeft <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb23-1066"><a href="#cb23-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1067"><a href="#cb23-1067" aria-hidden="true" tabindex="-1"></a>xScale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>])<span class="op">.</span><span class="fu">range</span>([marginLeft<span class="op">,</span> width <span class="op">-</span> marginRight])</span>
<span id="cb23-1068"><a href="#cb23-1068" aria-hidden="true" tabindex="-1"></a>yScale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>])<span class="op">.</span><span class="fu">range</span>([height <span class="op">-</span> marginBottom<span class="op">,</span> marginTop])</span>
<span id="cb23-1069"><a href="#cb23-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1070"><a href="#cb23-1070" aria-hidden="true" tabindex="-1"></a>svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)</span>
<span id="cb23-1071"><a href="#cb23-1071" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width)</span>
<span id="cb23-1072"><a href="#cb23-1072" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> height)</span>
<span id="cb23-1073"><a href="#cb23-1073" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"viewBox"</span><span class="op">,</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> width<span class="op">,</span> height])</span>
<span id="cb23-1074"><a href="#cb23-1074" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"style"</span><span class="op">,</span> <span class="st">"max-width: 100%; height: auto;"</span>)<span class="op">;</span></span>
<span id="cb23-1075"><a href="#cb23-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1076"><a href="#cb23-1076" aria-hidden="true" tabindex="-1"></a>xAxis <span class="op">=</span> d3<span class="op">.</span><span class="fu">axisBottom</span>(xScale)</span>
<span id="cb23-1077"><a href="#cb23-1077" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">ticks</span>(width <span class="op">/</span> <span class="dv">80</span>)</span>
<span id="cb23-1078"><a href="#cb23-1078" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">tickSizeOuter</span>(<span class="dv">0</span>)</span>
<span id="cb23-1079"><a href="#cb23-1079" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">tickSizeInner</span>(<span class="op">-</span>(height <span class="op">-</span> marginTop <span class="op">-</span> marginBottom))<span class="op">;</span></span>
<span id="cb23-1080"><a href="#cb23-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1081"><a href="#cb23-1081" aria-hidden="true" tabindex="-1"></a>yAxis <span class="op">=</span> d3<span class="op">.</span><span class="fu">axisLeft</span>(yScale)</span>
<span id="cb23-1082"><a href="#cb23-1082" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">ticks</span>(height <span class="op">/</span> <span class="dv">40</span>)</span>
<span id="cb23-1083"><a href="#cb23-1083" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">tickSizeOuter</span>(<span class="dv">0</span>)</span>
<span id="cb23-1084"><a href="#cb23-1084" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">tickSizeInner</span>(<span class="op">-</span>(width <span class="op">-</span> marginLeft <span class="op">-</span> marginRight))<span class="op">;</span></span>
<span id="cb23-1085"><a href="#cb23-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1086"><a href="#cb23-1086" aria-hidden="true" tabindex="-1"></a>gx <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb23-1087"><a href="#cb23-1087" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span> <span class="st">"x-axis"</span>)</span>
<span id="cb23-1088"><a href="#cb23-1088" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(0,</span><span class="sc">${</span>height <span class="op">-</span> marginBottom<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb23-1089"><a href="#cb23-1089" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(xAxis)<span class="op">;</span></span>
<span id="cb23-1090"><a href="#cb23-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1091"><a href="#cb23-1091" aria-hidden="true" tabindex="-1"></a>gy <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb23-1092"><a href="#cb23-1092" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span> <span class="st">"y-axis"</span>)</span>
<span id="cb23-1093"><a href="#cb23-1093" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>marginLeft<span class="sc">}</span><span class="vs">,0)`</span>)</span>
<span id="cb23-1094"><a href="#cb23-1094" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(yAxis)<span class="op">;</span></span>
<span id="cb23-1095"><a href="#cb23-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1096"><a href="#cb23-1096" aria-hidden="true" tabindex="-1"></a>svg<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".tick line"</span>)</span>
<span id="cb23-1097"><a href="#cb23-1097" aria-hidden="true" tabindex="-1"></a>   <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb23-1098"><a href="#cb23-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1099"><a href="#cb23-1099" aria-hidden="true" tabindex="-1"></a>svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb23-1100"><a href="#cb23-1100" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> width <span class="op">-</span> marginRight)</span>
<span id="cb23-1101"><a href="#cb23-1101" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> height <span class="op">-</span> marginBottom <span class="op">-</span> <span class="dv">4</span>)</span>
<span id="cb23-1102"><a href="#cb23-1102" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"currentColor"</span>)</span>
<span id="cb23-1103"><a href="#cb23-1103" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"end"</span>)</span>
<span id="cb23-1104"><a href="#cb23-1104" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>(<span class="st">"UMAP 1 →"</span>)<span class="op">;</span></span>
<span id="cb23-1105"><a href="#cb23-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1106"><a href="#cb23-1106" aria-hidden="true" tabindex="-1"></a>svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb23-1107"><a href="#cb23-1107" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> marginLeft <span class="op">+</span> <span class="dv">4</span>)</span>
<span id="cb23-1108"><a href="#cb23-1108" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> marginTop)</span>
<span id="cb23-1109"><a href="#cb23-1109" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"currentColor"</span>)</span>
<span id="cb23-1110"><a href="#cb23-1110" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"start"</span>)</span>
<span id="cb23-1111"><a href="#cb23-1111" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dominant-baseline"</span><span class="op">,</span> <span class="st">"hanging"</span>)</span>
<span id="cb23-1112"><a href="#cb23-1112" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>(<span class="st">"↑ UMAP 2"</span>)<span class="op">;</span></span>
<span id="cb23-1113"><a href="#cb23-1113" aria-hidden="true" tabindex="-1"></a><span class="op">-</span></span>
<span id="cb23-1114"><a href="#cb23-1114" aria-hidden="true" tabindex="-1"></a>svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"clipPath"</span>)</span>
<span id="cb23-1115"><a href="#cb23-1115" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"clip"</span>)</span>
<span id="cb23-1116"><a href="#cb23-1116" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">append</span>(<span class="st">"rect"</span>)</span>
<span id="cb23-1117"><a href="#cb23-1117" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> marginLeft)</span>
<span id="cb23-1118"><a href="#cb23-1118" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> marginTop)</span>
<span id="cb23-1119"><a href="#cb23-1119" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width <span class="op">-</span> marginLeft <span class="op">-</span> marginRight)</span>
<span id="cb23-1120"><a href="#cb23-1120" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> height <span class="op">-</span> marginTop <span class="op">-</span> marginBottom)<span class="op">;</span></span>
<span id="cb23-1121"><a href="#cb23-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1122"><a href="#cb23-1122" aria-hidden="true" tabindex="-1"></a>pointGroup <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb23-1123"><a href="#cb23-1123" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"black"</span>)</span>
<span id="cb23-1124"><a href="#cb23-1124" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"clip-path"</span><span class="op">,</span> <span class="st">"url(#clip)"</span>)<span class="op">;</span></span>
<span id="cb23-1125"><a href="#cb23-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1126"><a href="#cb23-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1129"><a href="#cb23-1129" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb23-1130"><a href="#cb23-1130" aria-hidden="true" tabindex="-1"></a><span class="co">//| echo: false</span></span>
<span id="cb23-1131"><a href="#cb23-1131" aria-hidden="true" tabindex="-1"></a><span class="co">//| eval: true</span></span>
<span id="cb23-1132"><a href="#cb23-1132" aria-hidden="true" tabindex="-1"></a><span class="co">//| message: false</span></span>
<span id="cb23-1133"><a href="#cb23-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1134"><a href="#cb23-1134" aria-hidden="true" tabindex="-1"></a>{ <span class="co">// Reactive block</span></span>
<span id="cb23-1135"><a href="#cb23-1135" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> updateVisualization <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb23-1136"><a href="#cb23-1136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> duration <span class="op">=</span> <span class="dv">750</span><span class="op">;</span></span>
<span id="cb23-1137"><a href="#cb23-1137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1138"><a href="#cb23-1138" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> currentScale <span class="op">=</span> colorby <span class="op">===</span> <span class="st">"QC"</span> <span class="op">?</span> qcColorScale <span class="op">:</span> leidenColorScale<span class="op">;</span></span>
<span id="cb23-1139"><a href="#cb23-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1140"><a href="#cb23-1140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>currentScale) { </span>
<span id="cb23-1141"><a href="#cb23-1141" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Scale missing"</span>)<span class="op">;</span> </span>
<span id="cb23-1142"><a href="#cb23-1142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span> </span>
<span id="cb23-1143"><a href="#cb23-1143" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-1144"><a href="#cb23-1144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1145"><a href="#cb23-1145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>query_data <span class="op">||</span> query_data<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb23-1146"><a href="#cb23-1146" aria-hidden="true" tabindex="-1"></a>       <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">"No data available for plotting."</span>)<span class="op">;</span></span>
<span id="cb23-1147"><a href="#cb23-1147" aria-hidden="true" tabindex="-1"></a>       pointGroup<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"circle"</span>)<span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"opacity"</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb23-1148"><a href="#cb23-1148" aria-hidden="true" tabindex="-1"></a>       <span class="cf">return</span><span class="op">;</span> </span>
<span id="cb23-1149"><a href="#cb23-1149" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-1150"><a href="#cb23-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1151"><a href="#cb23-1151" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> xExtent <span class="op">=</span> d3<span class="op">.</span><span class="fu">extent</span>(query_data<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">umap_1</span>)<span class="op">;</span></span>
<span id="cb23-1152"><a href="#cb23-1152" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> yExtent <span class="op">=</span> d3<span class="op">.</span><span class="fu">extent</span>(query_data<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">umap_2</span>)<span class="op">;</span></span>
<span id="cb23-1153"><a href="#cb23-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1154"><a href="#cb23-1154" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> xPad <span class="op">=</span> (xExtent[<span class="dv">1</span>] <span class="op">-</span> xExtent[<span class="dv">0</span>]) <span class="op">*</span> <span class="fl">0.05</span><span class="op">;</span></span>
<span id="cb23-1155"><a href="#cb23-1155" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> yPad <span class="op">=</span> (yExtent[<span class="dv">1</span>] <span class="op">-</span> yExtent[<span class="dv">0</span>]) <span class="op">*</span> <span class="fl">0.05</span><span class="op">;</span></span>
<span id="cb23-1156"><a href="#cb23-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1157"><a href="#cb23-1157" aria-hidden="true" tabindex="-1"></a>    xScale<span class="op">.</span><span class="fu">domain</span>([xExtent[<span class="dv">0</span>] <span class="op">-</span> xPad <span class="op">||</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> xExtent[<span class="dv">1</span>] <span class="op">+</span> xPad <span class="op">||</span> <span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb23-1158"><a href="#cb23-1158" aria-hidden="true" tabindex="-1"></a>    yScale<span class="op">.</span><span class="fu">domain</span>([yExtent[<span class="dv">0</span>] <span class="op">-</span> yPad <span class="op">||</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> yExtent[<span class="dv">1</span>] <span class="op">+</span> yPad <span class="op">||</span> <span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb23-1159"><a href="#cb23-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1160"><a href="#cb23-1160" aria-hidden="true" tabindex="-1"></a>    svg<span class="op">.</span><span class="fu">select</span>(<span class="st">".x-axis"</span>)</span>
<span id="cb23-1161"><a href="#cb23-1161" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)</span>
<span id="cb23-1162"><a href="#cb23-1162" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">call</span>(xAxis)</span>
<span id="cb23-1163"><a href="#cb23-1163" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"start"</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb23-1164"><a href="#cb23-1164" aria-hidden="true" tabindex="-1"></a>         svg<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".x-axis .tick line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb23-1165"><a href="#cb23-1165" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb23-1166"><a href="#cb23-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1167"><a href="#cb23-1167" aria-hidden="true" tabindex="-1"></a>    svg<span class="op">.</span><span class="fu">select</span>(<span class="st">".y-axis"</span>)</span>
<span id="cb23-1168"><a href="#cb23-1168" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)</span>
<span id="cb23-1169"><a href="#cb23-1169" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">call</span>(yAxis)</span>
<span id="cb23-1170"><a href="#cb23-1170" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"start"</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb23-1171"><a href="#cb23-1171" aria-hidden="true" tabindex="-1"></a>         svg<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".y-axis .tick line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb23-1172"><a href="#cb23-1172" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb23-1173"><a href="#cb23-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1174"><a href="#cb23-1174" aria-hidden="true" tabindex="-1"></a>    pointGroup<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"circle"</span>)</span>
<span id="cb23-1175"><a href="#cb23-1175" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">data</span>(query_data<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">cell_id</span>)</span>
<span id="cb23-1176"><a href="#cb23-1176" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">join</span>(</span>
<span id="cb23-1177"><a href="#cb23-1177" aria-hidden="true" tabindex="-1"></a>        enter <span class="kw">=&gt;</span> enter<span class="op">.</span><span class="fu">append</span>(<span class="st">"circle"</span>)</span>
<span id="cb23-1178"><a href="#cb23-1178" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cx"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">xScale</span>(d<span class="op">.</span><span class="at">umap_1</span>)) </span>
<span id="cb23-1179"><a href="#cb23-1179" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cy"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">yScale</span>(d<span class="op">.</span><span class="at">umap_2</span>))</span>
<span id="cb23-1180"><a href="#cb23-1180" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"r"</span><span class="op">,</span> <span class="fl">2.5</span>)</span>
<span id="cb23-1181"><a href="#cb23-1181" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> d <span class="kw">=&gt;</span> {</span>
<span id="cb23-1182"><a href="#cb23-1182" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> {</span>
<span id="cb23-1183"><a href="#cb23-1183" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">const</span> valueToColor <span class="op">=</span> colorby <span class="op">===</span> <span class="st">"QC"</span> <span class="op">?</span> qcFlagMap<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">cell_id</span>) <span class="op">:</span> d<span class="op">.</span><span class="at">leiden</span><span class="op">;</span></span>
<span id="cb23-1184"><a href="#cb23-1184" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="fu">currentScale</span>(valueToColor) <span class="op">||</span> <span class="st">'grey'</span><span class="op">;</span></span>
<span id="cb23-1185"><a href="#cb23-1185" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">catch</span>(e) { <span class="cf">return</span> <span class="st">'grey'</span><span class="op">;</span> }</span>
<span id="cb23-1186"><a href="#cb23-1186" aria-hidden="true" tabindex="-1"></a>            }) </span>
<span id="cb23-1187"><a href="#cb23-1187" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"opacity"</span><span class="op">,</span> <span class="dv">0</span>)</span>
<span id="cb23-1188"><a href="#cb23-1188" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">call</span>(enter <span class="kw">=&gt;</span> enter<span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"opacity"</span><span class="op">,</span> <span class="fl">0.8</span>))<span class="op">,</span></span>
<span id="cb23-1189"><a href="#cb23-1189" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1190"><a href="#cb23-1190" aria-hidden="true" tabindex="-1"></a>        update <span class="kw">=&gt;</span> update</span>
<span id="cb23-1191"><a href="#cb23-1191" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">call</span>(update <span class="kw">=&gt;</span> update<span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)</span>
<span id="cb23-1192"><a href="#cb23-1192" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cx"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">xScale</span>(d<span class="op">.</span><span class="at">umap_1</span>))</span>
<span id="cb23-1193"><a href="#cb23-1193" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cy"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">yScale</span>(d<span class="op">.</span><span class="at">umap_2</span>))</span>
<span id="cb23-1194"><a href="#cb23-1194" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> d <span class="kw">=&gt;</span> { </span>
<span id="cb23-1195"><a href="#cb23-1195" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span> {</span>
<span id="cb23-1196"><a href="#cb23-1196" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">const</span> valueToColor <span class="op">=</span> colorby <span class="op">===</span> <span class="st">"QC"</span> <span class="op">?</span> qcFlagMap<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">cell_id</span>) <span class="op">:</span> d<span class="op">.</span><span class="at">leiden</span><span class="op">;</span></span>
<span id="cb23-1197"><a href="#cb23-1197" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="fu">currentScale</span>(valueToColor) <span class="op">||</span> <span class="st">'grey'</span><span class="op">;</span></span>
<span id="cb23-1198"><a href="#cb23-1198" aria-hidden="true" tabindex="-1"></a>                    } <span class="cf">catch</span>(e) { <span class="cf">return</span> <span class="st">'grey'</span><span class="op">;</span> }</span>
<span id="cb23-1199"><a href="#cb23-1199" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb23-1200"><a href="#cb23-1200" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">attr</span>(<span class="st">"opacity"</span><span class="op">,</span> <span class="fl">0.8</span>)</span>
<span id="cb23-1201"><a href="#cb23-1201" aria-hidden="true" tabindex="-1"></a>             )<span class="op">,</span></span>
<span id="cb23-1202"><a href="#cb23-1202" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1203"><a href="#cb23-1203" aria-hidden="true" tabindex="-1"></a>        exit <span class="kw">=&gt;</span> exit</span>
<span id="cb23-1204"><a href="#cb23-1204" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">call</span>(exit <span class="kw">=&gt;</span> exit<span class="op">.</span><span class="fu">transition</span>()<span class="op">.</span><span class="fu">duration</span>(duration)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"opacity"</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">remove</span>())</span>
<span id="cb23-1205"><a href="#cb23-1205" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb23-1206"><a href="#cb23-1206" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb23-1207"><a href="#cb23-1207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-1208"><a href="#cb23-1208" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> { </span>
<span id="cb23-1209"><a href="#cb23-1209" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateVisualization</span>()<span class="op">;</span></span>
<span id="cb23-1210"><a href="#cb23-1210" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span>(error) {</span>
<span id="cb23-1211"><a href="#cb23-1211" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error during D3 updateVisualization:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb23-1212"><a href="#cb23-1212" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-1213"><a href="#cb23-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1214"><a href="#cb23-1214" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span> </span>
<span id="cb23-1215"><a href="#cb23-1215" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-1216"><a href="#cb23-1216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1217"><a href="#cb23-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1218"><a href="#cb23-1218" aria-hidden="true" tabindex="-1"></a>In the dot plot on the bottom left provides a QC flag legend. For example, QC flag '5' represents cells that were flagged for having low counts and low features whereas QC flag '96' represents cells that wee flagged for FOV QC as wells as low SBR.</span>
<span id="cb23-1219"><a href="#cb23-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1220"><a href="#cb23-1220" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-1221"><a href="#cb23-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1222"><a href="#cb23-1222" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb23-1223"><a href="#cb23-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1224"><a href="#cb23-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1225"><a href="#cb23-1225" aria-hidden="true" tabindex="-1"></a>If you want to further explore this subset, you can examine the <span class="in">`query_data`</span></span>
<span id="cb23-1226"><a href="#cb23-1226" aria-hidden="true" tabindex="-1"></a>and <span class="in">`qc_flags_data`</span> dataframes below.</span>
<span id="cb23-1227"><a href="#cb23-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1230"><a href="#cb23-1230" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr}</span></span>
<span id="cb23-1231"><a href="#cb23-1231" aria-hidden="true" tabindex="-1"></a><span class="in">#| autorun: true</span></span>
<span id="cb23-1232"><a href="#cb23-1232" aria-hidden="true" tabindex="-1"></a><span class="in">#| input:</span></span>
<span id="cb23-1233"><a href="#cb23-1233" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - query_data</span></span>
<span id="cb23-1234"><a href="#cb23-1234" aria-hidden="true" tabindex="-1"></a><span class="in">#|   - qc_flags_data</span></span>
<span id="cb23-1235"><a href="#cb23-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1236"><a href="#cb23-1236" aria-hidden="true" tabindex="-1"></a><span class="in">head(query_data)</span></span>
<span id="cb23-1237"><a href="#cb23-1237" aria-hidden="true" tabindex="-1"></a><span class="in">head(qc_flags_data)</span></span>
<span id="cb23-1238"><a href="#cb23-1238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1239"><a href="#cb23-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1240"><a href="#cb23-1240" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-1241"><a href="#cb23-1241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1242"><a href="#cb23-1242" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-1243"><a href="#cb23-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1244"><a href="#cb23-1244" aria-hidden="true" tabindex="-1"></a>For the remainder of this chapter, I will focus on the PR-based </span>
<span id="cb23-1245"><a href="#cb23-1245" aria-hidden="true" tabindex="-1"></a>method.</span>
<span id="cb23-1246"><a href="#cb23-1246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1247"><a href="#cb23-1247" aria-hidden="true" tabindex="-1"></a>I find it's helpful to:</span>
<span id="cb23-1248"><a href="#cb23-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1249"><a href="#cb23-1249" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Have more control of the plotting aesthetics and label multiple sub-clusters</span>
<span id="cb23-1250"><a href="#cb23-1250" aria-hidden="true" tabindex="-1"></a>of a given Leiden cluster for clarity and</span>
<span id="cb23-1251"><a href="#cb23-1251" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>isolate the Leiden clusters and visualize them in both</span>
<span id="cb23-1252"><a href="#cb23-1252" aria-hidden="true" tabindex="-1"></a>UMAP space and physical (XY) space to see if there are regions in the tissue that</span>
<span id="cb23-1253"><a href="#cb23-1253" aria-hidden="true" tabindex="-1"></a>might provide clues about the cell types.</span>
<span id="cb23-1254"><a href="#cb23-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1255"><a href="#cb23-1255" aria-hidden="true" tabindex="-1"></a>Instead of the default <span class="in">`plotDots`</span> colors, let's define our own. </span>
<span id="cb23-1256"><a href="#cb23-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1259"><a href="#cb23-1259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-1260"><a href="#cb23-1260" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: V-1</span></span>
<span id="cb23-1261"><a href="#cb23-1261" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1262"><a href="#cb23-1262" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb23-1263"><a href="#cb23-1263" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb23-1264"><a href="#cb23-1264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1265"><a href="#cb23-1265" aria-hidden="true" tabindex="-1"></a><span class="co"># define colors semi-manually instead of using the default colors</span></span>
<span id="cb23-1266"><a href="#cb23-1266" aria-hidden="true" tabindex="-1"></a>column <span class="ot">&lt;-</span> <span class="st">'leiden_pr'</span></span>
<span id="cb23-1267"><a href="#cb23-1267" aria-hidden="true" tabindex="-1"></a>column_levels <span class="ot">&lt;-</span> <span class="fu">levels</span>(py<span class="sc">$</span>adata<span class="sc">$</span>obs[[column]])</span>
<span id="cb23-1268"><a href="#cb23-1268" aria-hidden="true" tabindex="-1"></a>n_levels <span class="ot">&lt;-</span> <span class="fu">length</span>(column_levels)</span>
<span id="cb23-1269"><a href="#cb23-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1270"><a href="#cb23-1270" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(n_levels<span class="sc">&lt;</span><span class="dv">27</span>){</span>
<span id="cb23-1271"><a href="#cb23-1271" aria-hidden="true" tabindex="-1"></a>  colors_use <span class="ot">&lt;-</span> pals<span class="sc">::</span><span class="fu">alphabet</span>(n_levels)</span>
<span id="cb23-1272"><a href="#cb23-1272" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(n <span class="sc">&lt;</span> <span class="dv">53</span>){</span>
<span id="cb23-1273"><a href="#cb23-1273" aria-hidden="true" tabindex="-1"></a>  colors_use <span class="ot">&lt;-</span> <span class="fu">c</span>(pals<span class="sc">::</span><span class="fu">alphabet</span>(<span class="dv">26</span>), pals<span class="sc">::</span><span class="fu">alphabet2</span>(n_levels<span class="dv">-26</span>))</span>
<span id="cb23-1274"><a href="#cb23-1274" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb23-1275"><a href="#cb23-1275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"consider fewer groups"</span>)</span>
<span id="cb23-1276"><a href="#cb23-1276" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-1277"><a href="#cb23-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1278"><a href="#cb23-1278" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(colors_use) <span class="ot">&lt;-</span> column_levels</span>
<span id="cb23-1279"><a href="#cb23-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1280"><a href="#cb23-1280" aria-hidden="true" tabindex="-1"></a><span class="co"># saving colors for later</span></span>
<span id="cb23-1281"><a href="#cb23-1281" aria-hidden="true" tabindex="-1"></a>results_list[[<span class="st">'leiden_global_names'</span>]] <span class="ot">&lt;-</span> <span class="fu">names</span>(colors_use)</span>
<span id="cb23-1282"><a href="#cb23-1282" aria-hidden="true" tabindex="-1"></a>results_list[[<span class="st">'leiden_global_colors'</span>]] <span class="ot">&lt;-</span> <span class="fu">as.character</span>(colors_use)</span>
<span id="cb23-1283"><a href="#cb23-1283" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(results_list, results_list_file)</span>
<span id="cb23-1284"><a href="#cb23-1284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1285"><a href="#cb23-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1286"><a href="#cb23-1286" aria-hidden="true" tabindex="-1"></a>Plot the cells in XY space and UMAP space and color based on <span class="in">`leiden_pr`</span>. </span>
<span id="cb23-1287"><a href="#cb23-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1290"><a href="#cb23-1290" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-1291"><a href="#cb23-1291" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: V-2</span></span>
<span id="cb23-1292"><a href="#cb23-1292" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1293"><a href="#cb23-1293" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb23-1294"><a href="#cb23-1294" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb23-1295"><a href="#cb23-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1296"><a href="#cb23-1296" aria-hidden="true" tabindex="-1"></a>group_prefix <span class="ot">&lt;-</span> <span class="st">"leiden"</span> <span class="co"># &lt;1&gt;</span></span>
<span id="cb23-1297"><a href="#cb23-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1298"><a href="#cb23-1298" aria-hidden="true" tabindex="-1"></a>pp_assets_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_asset_dir, <span class="st">"preprocessing"</span>)</span>
<span id="cb23-1299"><a href="#cb23-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1300"><a href="#cb23-1300" aria-hidden="true" tabindex="-1"></a><span class="co"># XY (global only)</span></span>
<span id="cb23-1301"><a href="#cb23-1301" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDots</span>(py<span class="sc">$</span>adata, <span class="at">color_by=</span><span class="st">'leiden_pr'</span>,</span>
<span id="cb23-1302"><a href="#cb23-1302" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot_global =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-1303"><a href="#cb23-1303" aria-hidden="true" tabindex="-1"></a>              <span class="at">facet_by_group =</span> <span class="cn">FALSE</span>,</span>
<span id="cb23-1304"><a href="#cb23-1304" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_plot_parameters =</span> <span class="fu">list</span>(</span>
<span id="cb23-1305"><a href="#cb23-1305" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_point_params =</span> <span class="fu">list</span>(</span>
<span id="cb23-1306"><a href="#cb23-1306" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size=</span><span class="fl">0.001</span></span>
<span id="cb23-1307"><a href="#cb23-1307" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb23-1308"><a href="#cb23-1308" aria-hidden="true" tabindex="-1"></a>                  <span class="at">scale_bar_params =</span> <span class="fu">list</span>(</span>
<span id="cb23-1309"><a href="#cb23-1309" aria-hidden="true" tabindex="-1"></a>                    <span class="at">location =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">0</span>),</span>
<span id="cb23-1310"><a href="#cb23-1310" aria-hidden="true" tabindex="-1"></a>                    <span class="at">width =</span> <span class="dv">2</span>,</span>
<span id="cb23-1311"><a href="#cb23-1311" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n =</span> <span class="dv">3</span>,</span>
<span id="cb23-1312"><a href="#cb23-1312" aria-hidden="true" tabindex="-1"></a>                    <span class="at">height =</span> <span class="fl">0.1</span>,</span>
<span id="cb23-1313"><a href="#cb23-1313" aria-hidden="true" tabindex="-1"></a>                    <span class="at">scale_colors =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"grey30"</span>),</span>
<span id="cb23-1314"><a href="#cb23-1314" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label_nudge_y =</span> <span class="sc">-</span><span class="fl">0.3</span></span>
<span id="cb23-1315"><a href="#cb23-1315" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb23-1316"><a href="#cb23-1316" aria-hidden="true" tabindex="-1"></a>                  <span class="at">directory =</span> pp_assets_dir,</span>
<span id="cb23-1317"><a href="#cb23-1317" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fileType =</span> <span class="st">"png"</span>,</span>
<span id="cb23-1318"><a href="#cb23-1318" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dpi =</span> <span class="dv">200</span>,</span>
<span id="cb23-1319"><a href="#cb23-1319" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> <span class="dv">8</span>, </span>
<span id="cb23-1320"><a href="#cb23-1320" aria-hidden="true" tabindex="-1"></a>                  <span class="at">height =</span> <span class="dv">8</span>,</span>
<span id="cb23-1321"><a href="#cb23-1321" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prefix=</span>group_prefix</span>
<span id="cb23-1322"><a href="#cb23-1322" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb23-1323"><a href="#cb23-1323" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_ggplot_layers =</span> <span class="fu">list</span>(</span>
<span id="cb23-1324"><a href="#cb23-1324" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_bw</span>(),</span>
<span id="cb23-1325"><a href="#cb23-1325" aria-hidden="true" tabindex="-1"></a>                <span class="fu">xlab</span>(<span class="st">"X (mm)"</span>),</span>
<span id="cb23-1326"><a href="#cb23-1326" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ylab</span>(<span class="st">"Y (mm)"</span>), </span>
<span id="cb23-1327"><a href="#cb23-1327" aria-hidden="true" tabindex="-1"></a>                <span class="fu">coord_fixed</span>(),</span>
<span id="cb23-1328"><a href="#cb23-1328" aria-hidden="true" tabindex="-1"></a>                <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors_use),</span>
<span id="cb23-1329"><a href="#cb23-1329" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.4</span>)),</span>
<span id="cb23-1330"><a href="#cb23-1330" aria-hidden="true" tabindex="-1"></a>                <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb23-1331"><a href="#cb23-1331" aria-hidden="true" tabindex="-1"></a>                  <span class="at">title=</span><span class="st">"Leiden (PR)"</span>,</span>
<span id="cb23-1332"><a href="#cb23-1332" aria-hidden="true" tabindex="-1"></a>                  <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">3</span>) ) )</span>
<span id="cb23-1333"><a href="#cb23-1333" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb23-1334"><a href="#cb23-1334" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb23-1335"><a href="#cb23-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1336"><a href="#cb23-1336" aria-hidden="true" tabindex="-1"></a><span class="co"># XY (facets only)</span></span>
<span id="cb23-1337"><a href="#cb23-1337" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDots</span>(py<span class="sc">$</span>adata, <span class="at">color_by=</span><span class="st">'leiden_pr'</span>,</span>
<span id="cb23-1338"><a href="#cb23-1338" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot_global =</span> <span class="cn">FALSE</span>,</span>
<span id="cb23-1339"><a href="#cb23-1339" aria-hidden="true" tabindex="-1"></a>              <span class="at">facet_by_group =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-1340"><a href="#cb23-1340" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_plot_parameters =</span> <span class="fu">list</span>(</span>
<span id="cb23-1341"><a href="#cb23-1341" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_point_params =</span> <span class="fu">list</span>(</span>
<span id="cb23-1342"><a href="#cb23-1342" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size=</span><span class="fl">0.001</span></span>
<span id="cb23-1343"><a href="#cb23-1343" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb23-1344"><a href="#cb23-1344" aria-hidden="true" tabindex="-1"></a>                  <span class="at">scale_bar_params =</span> <span class="fu">list</span>(</span>
<span id="cb23-1345"><a href="#cb23-1345" aria-hidden="true" tabindex="-1"></a>                    <span class="at">location =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">0</span>),</span>
<span id="cb23-1346"><a href="#cb23-1346" aria-hidden="true" tabindex="-1"></a>                    <span class="at">width =</span> <span class="dv">2</span>,</span>
<span id="cb23-1347"><a href="#cb23-1347" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n =</span> <span class="dv">3</span>,</span>
<span id="cb23-1348"><a href="#cb23-1348" aria-hidden="true" tabindex="-1"></a>                    <span class="at">height =</span> <span class="fl">0.1</span>,</span>
<span id="cb23-1349"><a href="#cb23-1349" aria-hidden="true" tabindex="-1"></a>                    <span class="at">scale_colors =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"grey30"</span>),</span>
<span id="cb23-1350"><a href="#cb23-1350" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label_nudge_y =</span> <span class="sc">-</span><span class="fl">0.3</span></span>
<span id="cb23-1351"><a href="#cb23-1351" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb23-1352"><a href="#cb23-1352" aria-hidden="true" tabindex="-1"></a>                  <span class="at">directory =</span> pp_assets_dir,</span>
<span id="cb23-1353"><a href="#cb23-1353" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fileType =</span> <span class="st">"png"</span>,</span>
<span id="cb23-1354"><a href="#cb23-1354" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dpi =</span> <span class="dv">100</span>,</span>
<span id="cb23-1355"><a href="#cb23-1355" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> <span class="dv">5</span>,</span>
<span id="cb23-1356"><a href="#cb23-1356" aria-hidden="true" tabindex="-1"></a>                  <span class="at">height =</span> <span class="dv">5</span>,</span>
<span id="cb23-1357"><a href="#cb23-1357" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prefix=</span>group_prefix</span>
<span id="cb23-1358"><a href="#cb23-1358" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb23-1359"><a href="#cb23-1359" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_ggplot_layers =</span> <span class="fu">list</span>(</span>
<span id="cb23-1360"><a href="#cb23-1360" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_bw</span>(),</span>
<span id="cb23-1361"><a href="#cb23-1361" aria-hidden="true" tabindex="-1"></a>                <span class="fu">xlab</span>(<span class="st">"X (mm)"</span>),</span>
<span id="cb23-1362"><a href="#cb23-1362" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ylab</span>(<span class="st">"Y (mm)"</span>), </span>
<span id="cb23-1363"><a href="#cb23-1363" aria-hidden="true" tabindex="-1"></a>                <span class="fu">coord_fixed</span>(),</span>
<span id="cb23-1364"><a href="#cb23-1364" aria-hidden="true" tabindex="-1"></a>                <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors_use),</span>
<span id="cb23-1365"><a href="#cb23-1365" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.4</span>)),</span>
<span id="cb23-1366"><a href="#cb23-1366" aria-hidden="true" tabindex="-1"></a>                <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb23-1367"><a href="#cb23-1367" aria-hidden="true" tabindex="-1"></a>                  <span class="at">title=</span><span class="st">"Leiden (PR)"</span>,</span>
<span id="cb23-1368"><a href="#cb23-1368" aria-hidden="true" tabindex="-1"></a>                  <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">3</span>) ) )</span>
<span id="cb23-1369"><a href="#cb23-1369" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb23-1370"><a href="#cb23-1370" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb23-1371"><a href="#cb23-1371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1372"><a href="#cb23-1372" aria-hidden="true" tabindex="-1"></a><span class="co"># UMAP (global only)</span></span>
<span id="cb23-1373"><a href="#cb23-1373" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDots</span>(py<span class="sc">$</span>adata, </span>
<span id="cb23-1374"><a href="#cb23-1374" aria-hidden="true" tabindex="-1"></a>              <span class="at">obsm_key =</span> <span class="st">"umap_pr"</span>,</span>
<span id="cb23-1375"><a href="#cb23-1375" aria-hidden="true" tabindex="-1"></a>              <span class="at">color_by=</span><span class="st">'leiden_pr'</span>,</span>
<span id="cb23-1376"><a href="#cb23-1376" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot_global =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-1377"><a href="#cb23-1377" aria-hidden="true" tabindex="-1"></a>              <span class="at">facet_by_group =</span> <span class="cn">FALSE</span>,</span>
<span id="cb23-1378"><a href="#cb23-1378" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_plot_parameters =</span> <span class="fu">list</span>(</span>
<span id="cb23-1379"><a href="#cb23-1379" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_point_params =</span> <span class="fu">list</span>(</span>
<span id="cb23-1380"><a href="#cb23-1380" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size=</span><span class="fl">0.001</span>, <span class="at">alpha=</span><span class="fl">0.1</span></span>
<span id="cb23-1381"><a href="#cb23-1381" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb23-1382"><a href="#cb23-1382" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_label_params =</span> <span class="fu">list</span>(</span>
<span id="cb23-1383"><a href="#cb23-1383" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> <span class="dv">4</span></span>
<span id="cb23-1384"><a href="#cb23-1384" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb23-1385"><a href="#cb23-1385" aria-hidden="true" tabindex="-1"></a>                  <span class="at">labels_on_plot =</span> <span class="fu">data.frame</span>(),</span>
<span id="cb23-1386"><a href="#cb23-1386" aria-hidden="true" tabindex="-1"></a>                  <span class="at">directory =</span> pp_assets_dir,</span>
<span id="cb23-1387"><a href="#cb23-1387" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fileType =</span> <span class="st">"png"</span>,</span>
<span id="cb23-1388"><a href="#cb23-1388" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dpi =</span> <span class="dv">200</span>,</span>
<span id="cb23-1389"><a href="#cb23-1389" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> <span class="dv">8</span>,</span>
<span id="cb23-1390"><a href="#cb23-1390" aria-hidden="true" tabindex="-1"></a>                  <span class="at">height =</span> <span class="dv">8</span>,</span>
<span id="cb23-1391"><a href="#cb23-1391" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prefix=</span>group_prefix</span>
<span id="cb23-1392"><a href="#cb23-1392" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb23-1393"><a href="#cb23-1393" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_ggplot_layers =</span> <span class="fu">list</span>(</span>
<span id="cb23-1394"><a href="#cb23-1394" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_bw</span>(),</span>
<span id="cb23-1395"><a href="#cb23-1395" aria-hidden="true" tabindex="-1"></a>                <span class="fu">xlab</span>(<span class="st">"UMAP 1"</span>),</span>
<span id="cb23-1396"><a href="#cb23-1396" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ylab</span>(<span class="st">"UMAP 2"</span>), </span>
<span id="cb23-1397"><a href="#cb23-1397" aria-hidden="true" tabindex="-1"></a>                <span class="fu">coord_fixed</span>(),</span>
<span id="cb23-1398"><a href="#cb23-1398" aria-hidden="true" tabindex="-1"></a>                <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors_use),</span>
<span id="cb23-1399"><a href="#cb23-1399" aria-hidden="true" tabindex="-1"></a>                <span class="co"># guides(color = guide_legend(</span></span>
<span id="cb23-1400"><a href="#cb23-1400" aria-hidden="true" tabindex="-1"></a>                <span class="co">#   title="Cell Type",</span></span>
<span id="cb23-1401"><a href="#cb23-1401" aria-hidden="true" tabindex="-1"></a>                <span class="co">#   override.aes = list(size = 3) ) ), </span></span>
<span id="cb23-1402"><a href="#cb23-1402" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb23-1403"><a href="#cb23-1403" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb23-1404"><a href="#cb23-1404" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-1405"><a href="#cb23-1405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1406"><a href="#cb23-1406" aria-hidden="true" tabindex="-1"></a><span class="co"># UMAP (facets only)</span></span>
<span id="cb23-1407"><a href="#cb23-1407" aria-hidden="true" tabindex="-1"></a><span class="fu">plotDots</span>(py<span class="sc">$</span>adata, </span>
<span id="cb23-1408"><a href="#cb23-1408" aria-hidden="true" tabindex="-1"></a>              <span class="at">obsm_key =</span> <span class="st">"umap_pr"</span>,</span>
<span id="cb23-1409"><a href="#cb23-1409" aria-hidden="true" tabindex="-1"></a>              <span class="at">color_by=</span><span class="st">'leiden_pr'</span>,</span>
<span id="cb23-1410"><a href="#cb23-1410" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot_global =</span> <span class="cn">FALSE</span>,</span>
<span id="cb23-1411"><a href="#cb23-1411" aria-hidden="true" tabindex="-1"></a>              <span class="at">facet_by_group =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-1412"><a href="#cb23-1412" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_plot_parameters =</span> <span class="fu">list</span>(</span>
<span id="cb23-1413"><a href="#cb23-1413" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_point_params =</span> <span class="fu">list</span>(</span>
<span id="cb23-1414"><a href="#cb23-1414" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size=</span><span class="fl">0.001</span>, <span class="at">alpha=</span><span class="fl">0.1</span></span>
<span id="cb23-1415"><a href="#cb23-1415" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb23-1416"><a href="#cb23-1416" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_label_params =</span> <span class="fu">list</span>(</span>
<span id="cb23-1417"><a href="#cb23-1417" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> <span class="dv">2</span></span>
<span id="cb23-1418"><a href="#cb23-1418" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb23-1419"><a href="#cb23-1419" aria-hidden="true" tabindex="-1"></a>                  <span class="at">labels_on_plot =</span> <span class="fu">data.frame</span>(),</span>
<span id="cb23-1420"><a href="#cb23-1420" aria-hidden="true" tabindex="-1"></a>                  <span class="at">directory =</span> pp_assets_dir,</span>
<span id="cb23-1421"><a href="#cb23-1421" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fileType =</span> <span class="st">"png"</span>,</span>
<span id="cb23-1422"><a href="#cb23-1422" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dpi =</span> <span class="dv">100</span>,</span>
<span id="cb23-1423"><a href="#cb23-1423" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> <span class="dv">5</span>,</span>
<span id="cb23-1424"><a href="#cb23-1424" aria-hidden="true" tabindex="-1"></a>                  <span class="at">height =</span> <span class="dv">5</span>,</span>
<span id="cb23-1425"><a href="#cb23-1425" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prefix=</span>group_prefix</span>
<span id="cb23-1426"><a href="#cb23-1426" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb23-1427"><a href="#cb23-1427" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_ggplot_layers =</span> <span class="fu">list</span>(</span>
<span id="cb23-1428"><a href="#cb23-1428" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_bw</span>(),</span>
<span id="cb23-1429"><a href="#cb23-1429" aria-hidden="true" tabindex="-1"></a>                <span class="fu">xlab</span>(<span class="st">"UMAP 1"</span>),</span>
<span id="cb23-1430"><a href="#cb23-1430" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ylab</span>(<span class="st">"UMAP 2"</span>), </span>
<span id="cb23-1431"><a href="#cb23-1431" aria-hidden="true" tabindex="-1"></a>                <span class="fu">coord_fixed</span>(),</span>
<span id="cb23-1432"><a href="#cb23-1432" aria-hidden="true" tabindex="-1"></a>                <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors_use),</span>
<span id="cb23-1433"><a href="#cb23-1433" aria-hidden="true" tabindex="-1"></a>                <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(</span>
<span id="cb23-1434"><a href="#cb23-1434" aria-hidden="true" tabindex="-1"></a>                  <span class="at">title=</span><span class="st">"Cell Type"</span>,</span>
<span id="cb23-1435"><a href="#cb23-1435" aria-hidden="true" tabindex="-1"></a>                  <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">3</span>) ) )</span>
<span id="cb23-1436"><a href="#cb23-1436" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb23-1437"><a href="#cb23-1437" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-1438"><a href="#cb23-1438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1439"><a href="#cb23-1439" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>in the plotting below, we will use this name to parse out files.</span>
<span id="cb23-1440"><a href="#cb23-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1441"><a href="#cb23-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1442"><a href="#cb23-1442" aria-hidden="true" tabindex="-1"></a>Here are the overall (global) plots.</span>
<span id="cb23-1443"><a href="#cb23-1443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1444"><a href="#cb23-1444" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb23-1445"><a href="#cb23-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1446"><a href="#cb23-1446" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Leiden - UMAP</span></span>
<span id="cb23-1447"><a href="#cb23-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1450"><a href="#cb23-1450" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-1451"><a href="#cb23-1451" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-umap-leiden</span></span>
<span id="cb23-1452"><a href="#cb23-1452" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-1453"><a href="#cb23-1453" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-1454"><a href="#cb23-1454" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb23-1455"><a href="#cb23-1455" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 6</span></span>
<span id="cb23-1456"><a href="#cb23-1456" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 5</span></span>
<span id="cb23-1457"><a href="#cb23-1457" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "UMAP with Leiden (PR-based) cells."</span></span>
<span id="cb23-1458"><a href="#cb23-1458" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-1459"><a href="#cb23-1459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1460"><a href="#cb23-1460" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="fu">file.path</span>(analysis_asset_dir, <span class="st">"preprocessing"</span>, <span class="st">"leiden__umap_pr__S0__plot.png"</span>))</span>
<span id="cb23-1461"><a href="#cb23-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1462"><a href="#cb23-1462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1463"><a href="#cb23-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1464"><a href="#cb23-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1465"><a href="#cb23-1465" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Leiden - XY</span></span>
<span id="cb23-1466"><a href="#cb23-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1469"><a href="#cb23-1469" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-1470"><a href="#cb23-1470" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-xy-celltype-broad</span></span>
<span id="cb23-1471"><a href="#cb23-1471" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-1472"><a href="#cb23-1472" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb23-1473"><a href="#cb23-1473" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb23-1474"><a href="#cb23-1474" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 6</span></span>
<span id="cb23-1475"><a href="#cb23-1475" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 5</span></span>
<span id="cb23-1476"><a href="#cb23-1476" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "XY with Leiden (PR-based) cells."</span></span>
<span id="cb23-1477"><a href="#cb23-1477" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-1478"><a href="#cb23-1478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1479"><a href="#cb23-1479" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="fu">file.path</span>(analysis_asset_dir, <span class="st">"preprocessing"</span>, <span class="st">"leiden__spatial__S0__plot.png"</span>))</span>
<span id="cb23-1480"><a href="#cb23-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1481"><a href="#cb23-1481" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1482"><a href="#cb23-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1483"><a href="#cb23-1483" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-1484"><a href="#cb23-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1485"><a href="#cb23-1485" aria-hidden="true" tabindex="-1"></a>Here are the individual plots<span class="ot">[^2]</span> we created organized by Leiden cluster. From these</span>
<span id="cb23-1486"><a href="#cb23-1486" aria-hidden="true" tabindex="-1"></a>pairs of plots one can quickly see how some Leiden clusters are spatially restricted.</span>
<span id="cb23-1487"><a href="#cb23-1487" aria-hidden="true" tabindex="-1"></a>For example, Leiden 0 consists of cells in the top part of the tissue (_i.e._,</span>
<span id="cb23-1488"><a href="#cb23-1488" aria-hidden="true" tabindex="-1"></a>the non-tumoral epithelium). Similarly, cluster 12 occupies the left-most region</span>
<span id="cb23-1489"><a href="#cb23-1489" aria-hidden="true" tabindex="-1"></a>of the tissue.</span>
<span id="cb23-1490"><a href="#cb23-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1491"><a href="#cb23-1491" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb23-1492"><a href="#cb23-1492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1495"><a href="#cb23-1495" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-1496"><a href="#cb23-1496" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: asis</span></span>
<span id="cb23-1497"><a href="#cb23-1497" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-1498"><a href="#cb23-1498" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb23-1499"><a href="#cb23-1499" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb23-1500"><a href="#cb23-1500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1501"><a href="#cb23-1501" aria-hidden="true" tabindex="-1"></a>fig_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_asset_dir, <span class="st">"preprocessing"</span>)</span>
<span id="cb23-1502"><a href="#cb23-1502" aria-hidden="true" tabindex="-1"></a>group_prefix <span class="ot">&lt;-</span> <span class="st">"leiden"</span></span>
<span id="cb23-1503"><a href="#cb23-1503" aria-hidden="true" tabindex="-1"></a>slide_id <span class="ot">&lt;-</span> <span class="st">"S0"</span></span>
<span id="cb23-1504"><a href="#cb23-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1505"><a href="#cb23-1505" aria-hidden="true" tabindex="-1"></a>xy_files <span class="ot">&lt;-</span> <span class="fu">Sys.glob</span>(<span class="fu">file.path</span>(fig_dir, </span>
<span id="cb23-1506"><a href="#cb23-1506" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">paste0</span>(group_prefix, </span>
<span id="cb23-1507"><a href="#cb23-1507" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"__spatial__"</span>, slide_id, <span class="st">"__facet_*png"</span>)))</span>
<span id="cb23-1508"><a href="#cb23-1508" aria-hidden="true" tabindex="-1"></a>org_order <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">".png"</span>, <span class="st">""</span>, <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">strsplit</span>(xy_files, <span class="at">split=</span><span class="st">"_facet_"</span>), <span class="st">"[["</span>, <span class="dv">2</span>L))))</span>
<span id="cb23-1509"><a href="#cb23-1509" aria-hidden="true" tabindex="-1"></a>xy_files <span class="ot">&lt;-</span> xy_files[<span class="fu">match</span>(<span class="fu">sort</span>(org_order), org_order)]</span>
<span id="cb23-1510"><a href="#cb23-1510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1511"><a href="#cb23-1511" aria-hidden="true" tabindex="-1"></a>umap_files <span class="ot">&lt;-</span> <span class="fu">Sys.glob</span>(<span class="fu">file.path</span>(fig_dir, </span>
<span id="cb23-1512"><a href="#cb23-1512" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">paste0</span>(group_prefix, </span>
<span id="cb23-1513"><a href="#cb23-1513" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"__umap_pr__"</span>, slide_id, <span class="st">"__facet_*png"</span>)))</span>
<span id="cb23-1514"><a href="#cb23-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1515"><a href="#cb23-1515" aria-hidden="true" tabindex="-1"></a>org_order <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">".png"</span>, <span class="st">""</span>, <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">strsplit</span>(umap_files, <span class="at">split=</span><span class="st">"_facet_"</span>), <span class="st">"[["</span>, <span class="dv">2</span>L))))</span>
<span id="cb23-1516"><a href="#cb23-1516" aria-hidden="true" tabindex="-1"></a>umap_files <span class="ot">&lt;-</span> umap_files[<span class="fu">match</span>(<span class="fu">sort</span>(org_order), org_order)]</span>
<span id="cb23-1517"><a href="#cb23-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1518"><a href="#cb23-1518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1519"><a href="#cb23-1519" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map2_chr</span>(xy_files, umap_files, \(current_xy_file, current_umap_file){</span>
<span id="cb23-1520"><a href="#cb23-1520" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">knit_child</span>(<span class="at">text =</span> <span class="fu">c</span>(</span>
<span id="cb23-1521"><a href="#cb23-1521" aria-hidden="true" tabindex="-1"></a>      <span class="st">"### `r gsub('.png', '', strsplit(current_umap_file, split='__facet_')[[1]][2])`"</span>,</span>
<span id="cb23-1522"><a href="#cb23-1522" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb23-1523"><a href="#cb23-1523" aria-hidden="true" tabindex="-1"></a>      <span class="st">":::{columns}"</span>,</span>
<span id="cb23-1524"><a href="#cb23-1524" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb23-1525"><a href="#cb23-1525" aria-hidden="true" tabindex="-1"></a>      <span class="st">"::: {.column width='40%'}"</span>,</span>
<span id="cb23-1526"><a href="#cb23-1526" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb23-1527"><a href="#cb23-1527" aria-hidden="true" tabindex="-1"></a>      <span class="st">"```{r eval=TRUE}"</span>,</span>
<span id="cb23-1528"><a href="#cb23-1528" aria-hidden="true" tabindex="-1"></a>      <span class="st">"#| echo: false"</span>,</span>
<span id="cb23-1529"><a href="#cb23-1529" aria-hidden="true" tabindex="-1"></a>      <span class="st">"knitr::include_graphics(current_xy_file)"</span>,</span>
<span id="cb23-1530"><a href="#cb23-1530" aria-hidden="true" tabindex="-1"></a>      <span class="st">"```"</span>,</span>
<span id="cb23-1531"><a href="#cb23-1531" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb23-1532"><a href="#cb23-1532" aria-hidden="true" tabindex="-1"></a>      <span class="st">":::"</span>,</span>
<span id="cb23-1533"><a href="#cb23-1533" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb23-1534"><a href="#cb23-1534" aria-hidden="true" tabindex="-1"></a>      <span class="st">"::: {.column width='10%'}"</span>,</span>
<span id="cb23-1535"><a href="#cb23-1535" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb23-1536"><a href="#cb23-1536" aria-hidden="true" tabindex="-1"></a>      <span class="st">":::"</span>,</span>
<span id="cb23-1537"><a href="#cb23-1537" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb23-1538"><a href="#cb23-1538" aria-hidden="true" tabindex="-1"></a>      <span class="st">"::: {.column width='40%'}"</span>,</span>
<span id="cb23-1539"><a href="#cb23-1539" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb23-1540"><a href="#cb23-1540" aria-hidden="true" tabindex="-1"></a>      <span class="st">"```{r eval=TRUE}"</span>,</span>
<span id="cb23-1541"><a href="#cb23-1541" aria-hidden="true" tabindex="-1"></a>      <span class="st">"#| echo: false"</span>,</span>
<span id="cb23-1542"><a href="#cb23-1542" aria-hidden="true" tabindex="-1"></a>      <span class="st">"knitr::include_graphics(current_umap_file)"</span>,</span>
<span id="cb23-1543"><a href="#cb23-1543" aria-hidden="true" tabindex="-1"></a>      <span class="st">"```"</span>,</span>
<span id="cb23-1544"><a href="#cb23-1544" aria-hidden="true" tabindex="-1"></a>      <span class="st">":::"</span>,</span>
<span id="cb23-1545"><a href="#cb23-1545" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb23-1546"><a href="#cb23-1546" aria-hidden="true" tabindex="-1"></a>      <span class="st">":::"</span>,</span>
<span id="cb23-1547"><a href="#cb23-1547" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb23-1548"><a href="#cb23-1548" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb23-1549"><a href="#cb23-1549" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span></span>
<span id="cb23-1550"><a href="#cb23-1550" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">envir =</span> <span class="fu">environment</span>(), <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-1551"><a href="#cb23-1551" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-1552"><a href="#cb23-1552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1553"><a href="#cb23-1553" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(res, <span class="at">sep =</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb23-1554"><a href="#cb23-1554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1555"><a href="#cb23-1555" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1556"><a href="#cb23-1556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1557"><a href="#cb23-1557" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-1558"><a href="#cb23-1558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1559"><a href="#cb23-1559" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb23-1560"><a href="#cb23-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1561"><a href="#cb23-1561" aria-hidden="true" tabindex="-1"></a>And with that, we've navigated the essential pre-processing steps. Starting with</span>
<span id="cb23-1562"><a href="#cb23-1562" aria-hidden="true" tabindex="-1"></a>our quality-controlled cell data, we applied normalization to account for</span>
<span id="cb23-1563"><a href="#cb23-1563" aria-hidden="true" tabindex="-1"></a>technical variations, identified the most informative genes, and used PCA to</span>
<span id="cb23-1564"><a href="#cb23-1564" aria-hidden="true" tabindex="-1"></a>reduce the data's dimensionality. Building upon this foundation, we generated</span>
<span id="cb23-1565"><a href="#cb23-1565" aria-hidden="true" tabindex="-1"></a>UMAP embeddings for visualization and performed Leiden clustering to partition</span>
<span id="cb23-1566"><a href="#cb23-1566" aria-hidden="true" tabindex="-1"></a>the cells into distinct groups based on their expression profiles. </span>
<span id="cb23-1567"><a href="#cb23-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1568"><a href="#cb23-1568" aria-hidden="true" tabindex="-1"></a>The interactive exploration highlighted a critical point: parameters matter.</span>
<span id="cb23-1569"><a href="#cb23-1569" aria-hidden="true" tabindex="-1"></a>Choices made during normalization, dimensionality reduction, and clustering</span>
<span id="cb23-1570"><a href="#cb23-1570" aria-hidden="true" tabindex="-1"></a>significantly influence the final UMAP layout and cluster assignments. There</span>
<span id="cb23-1571"><a href="#cb23-1571" aria-hidden="true" tabindex="-1"></a>isn't a single "correct" set of parameters, but understanding their effects</span>
<span id="cb23-1572"><a href="#cb23-1572" aria-hidden="true" tabindex="-1"></a>allows you to tailor the analysis to best reveal the biological structures</span>
<span id="cb23-1573"><a href="#cb23-1573" aria-hidden="true" tabindex="-1"></a>relevant to your specific questions.</span>
<span id="cb23-1574"><a href="#cb23-1574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1575"><a href="#cb23-1575" aria-hidden="true" tabindex="-1"></a>The resulting AnnData object, now enriched with normalized data layers, PCA</span>
<span id="cb23-1576"><a href="#cb23-1576" aria-hidden="true" tabindex="-1"></a>coordinates, UMAP embeddings, and Leiden cluster labels, is primed for the next</span>
<span id="cb23-1577"><a href="#cb23-1577" aria-hidden="true" tabindex="-1"></a>crucial phase: assigning biological meaning to these patterns. In the following</span>
<span id="cb23-1578"><a href="#cb23-1578" aria-hidden="true" tabindex="-1"></a>chapters we will delve into grouping cells based on their spatial domain and their</span>
<span id="cb23-1579"><a href="#cb23-1579" aria-hidden="true" tabindex="-1"></a>cell types.</span>
<span id="cb23-1580"><a href="#cb23-1580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1581"><a href="#cb23-1581" aria-hidden="true" tabindex="-1"></a><span class="ot">[^1]: </span>when I tried using the <span class="in">`sc.experimental.pp.normalize_pearson_residuals`</span> method</span>
<span id="cb23-1582"><a href="#cb23-1582" aria-hidden="true" tabindex="-1"></a>on this dataset, the OS crashed (&gt;200 GBs of RAM).</span>
<span id="cb23-1583"><a href="#cb23-1583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1584"><a href="#cb23-1584" aria-hidden="true" tabindex="-1"></a><span class="ot">[^2]: </span>To see how to generate this type of output, </span>
<span id="cb23-1585"><a href="#cb23-1585" aria-hidden="true" tabindex="-1"></a>click the <span class="in">`&lt;/&gt;`</span> icon on the top right of this chapter and then click <span class="in">`view source`</span>.</span>
<span id="cb23-1586"><a href="#cb23-1586" aria-hidden="true" tabindex="-1"></a></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.min.js"></script>

<script>
window.addEventListener('load', function() {
  // Initialize Tippy.js ONLY on links with the .link-preview class
  tippy('.link-preview', {
    content(reference) {
      const iframe = document.createElement('iframe');
      iframe.src = reference.href;
      iframe.width = "400px";
      iframe.height = "300px";
      iframe.style.border = "1px solid #ddd";
      iframe.style.borderRadius = "4px";
      return iframe;
    },
    allowHTML: true,
    interactive: true,
    placement: 'auto',
    arrow: true,
    animation: 'fade',
    delay: [300, 200],
    maxWidth: 420
  });
});
</script>




</body></html>