<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Evelyn Metzger">
<meta name="author" content="Claire Williams">

<title>7&nbsp; Pathways – A Guide to Whole Transcriptome CosMx&lt;sup&gt;®&lt;/sup&gt; SMI Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./conclusion.html" rel="next">
<link href="./cell-typing.html" rel="prev">
<link href="./assets/rocket.svg" rel="icon" type="image/svg+xml">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-707d8167ce6003fca903bfe2be84ab7f.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-00066ec49057a78057bb708cd7ecd022.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-cb8585788486bab3a0512e4422583b7d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-00066ec49057a78057bb708cd7ecd022.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/live-runtime/live-runtime.js" type="module"></script>
<link href="site_libs/quarto-contrib/live-runtime/live-runtime.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="module" src="site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">A Guide to Whole Transcriptome CosMx<sup>®</sup> SMI Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./../../index.html"> <i class="bi bi-house-door" role="img" aria-label="Back to main website">
</i> 
<span class="menu-text">Back to Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./pathways.html">Tertiary Analysis</a></li><li class="breadcrumb-item"><a href="./pathways.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Pathways</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./pathways.html">Tertiary Analysis</a></li><li class="breadcrumb-item"><a href="./pathways.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Pathways</span></a></li></ol></nav>
      <div class="quarto-title-block"><div><h1 class="title"><span id="sec-pathways" class="quarto-section-identifier"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Pathways</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-heading">Affiliations</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Evelyn Metzger <a href="https://orcid.org/0000-0002-4074-9003" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Bruker Spatial Biology
            </p>
          <p class="affiliation">
              Github: <a href="https://github.com/eveilyeverafter" target="_blank">eveilyeverafter</a>
            </p>
        </div>
      <div class="quarto-title-meta-contents">
      <p class="author">Claire Williams <a href="https://orcid.org/0000-0001-5467-149X" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Bruker Spatial Biology
            </p>
          <p class="affiliation">
              Github: <a href="https://github.com/crwilliams11" target="_blank">crwilliams11</a>
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./how-to-use.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to Use This Book</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link"><i class="bi bi-rocket-takeoff-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-ingestion.html" class="sidebar-item-text sidebar-link"><i class="bi bi-hdd-network-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Wrangling</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Processing Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quality-processing.html" class="sidebar-item-text sidebar-link"><i class="bi bi-clipboard2-data-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Quality Processing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./processing.html" class="sidebar-item-text sidebar-link"><i class="bi bi-rulers" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Normalization, Reduction, and Clustering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spatial-domains.html" class="sidebar-item-text sidebar-link"><i class="bi bi-diagram-3-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Domains</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cell-typing.html" class="sidebar-item-text sidebar-link"><i class="bi bi-layout-wtf" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Cell Typing</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Tertiary Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pathways.html" class="sidebar-item-text sidebar-link active"><i class="bi bi-grid-1x2-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Pathways</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Conclusion</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./conclusion.html" class="sidebar-item-text sidebar-link"><i class="bi bi-check-square-fill" role="img">
</i> 
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Additonal Resources</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">7.1</span> Introduction</a></li>
  <li><a href="#processing" id="toc-processing" class="nav-link" data-scroll-target="#processing"><span class="header-section-number">7.2</span> Processing</a></li>
  <li><a href="#smoothing-expression" id="toc-smoothing-expression" class="nav-link" data-scroll-target="#smoothing-expression"><span class="header-section-number">7.3</span> Smoothing Expression</a></li>
  <li><a href="#sec-path-enrichment" id="toc-sec-path-enrichment" class="nav-link" data-scroll-target="#sec-path-enrichment"><span class="header-section-number">7.4</span> Pathway Enrichment</a></li>
  <li><a href="#visualizing-pathway-enrichment" id="toc-visualizing-pathway-enrichment" class="nav-link" data-scroll-target="#visualizing-pathway-enrichment"><span class="header-section-number">7.5</span> Visualizing Pathway Enrichment</a>
  <ul>
  <li><a href="#sec-local-path-plots" id="toc-sec-local-path-plots" class="nav-link" data-scroll-target="#sec-local-path-plots"><span class="header-section-number">7.5.1</span> Local: spatial visualizations</a></li>
  <li><a href="#global-per-cell-type" id="toc-global-per-cell-type" class="nav-link" data-scroll-target="#global-per-cell-type"><span class="header-section-number">7.5.2</span> Global: Per Cell Type</a></li>
  <li><a href="#global-per-domain" id="toc-global-per-domain" class="nav-link" data-scroll-target="#global-per-domain"><span class="header-section-number">7.5.3</span> Global: Per Domain</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">7.6</span> Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">






<div class="cell">
<details class="code-fold">
<summary>R code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-1"><pre class="sourceCode r code-annotation-code code-with-copy"><code class="sourceCode r"><span id="annotated-cell-1-1"><a href="#annotated-cell-1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./preamble.R"</span>)</span>
<span id="annotated-cell-1-2"><a href="#annotated-cell-1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="annotated-cell-1-3"><a href="#annotated-cell-1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="annotated-cell-1-4"><a href="#annotated-cell-1-4" aria-hidden="true" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">source_python</span>(<span class="st">"./preamble.py"</span>)</span>
<span id="annotated-cell-1-5"><a href="#annotated-cell-1-5" aria-hidden="true" tabindex="-1"></a>analysis_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"analysis_results"</span>)</span>
<span id="annotated-cell-1-6"><a href="#annotated-cell-1-6" aria-hidden="true" tabindex="-1"></a>input_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"input_files"</span>)</span>
<span id="annotated-cell-1-7"><a href="#annotated-cell-1-7" aria-hidden="true" tabindex="-1"></a>output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"output_files"</span>)</span>
<span id="annotated-cell-1-8"><a href="#annotated-cell-1-8" aria-hidden="true" tabindex="-1"></a>analysis_asset_dir <span class="ot">&lt;-</span> <span class="st">"./assets/analysis_results"</span></span>
<span id="annotated-cell-1-9"><a href="#annotated-cell-1-9" aria-hidden="true" tabindex="-1"></a>ct_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="st">"ct"</span>)</span>
<span id="annotated-cell-1-10"><a href="#annotated-cell-1-10" aria-hidden="true" tabindex="-1"></a>pw_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="st">"pathways"</span>)</span>
<span id="annotated-cell-1-11"><a href="#annotated-cell-1-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(pw_dir)){</span>
<span id="annotated-cell-1-12"><a href="#annotated-cell-1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(pw_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="annotated-cell-1-13"><a href="#annotated-cell-1-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-1-14"><a href="#annotated-cell-1-14" aria-hidden="true" tabindex="-1"></a>results_list_file <span class="ot">=</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"results_list.rds"</span>)</span>
<span id="annotated-cell-1-15"><a href="#annotated-cell-1-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(results_list_file)){</span>
<span id="annotated-cell-1-16"><a href="#annotated-cell-1-16" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="annotated-cell-1-17"><a href="#annotated-cell-1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(results_list, results_list_file)</span>
<span id="annotated-cell-1-18"><a href="#annotated-cell-1-18" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="annotated-cell-1-19"><a href="#annotated-cell-1-19" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(results_list_file)  </span>
<span id="annotated-cell-1-20"><a href="#annotated-cell-1-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-1-21"><a href="#annotated-cell-1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># results_list$run_explainer &lt;- TRUE </span></span>
<span id="annotated-cell-1-22"><a href="#annotated-cell-1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./helpers.R"</span>)</span>
<span id="annotated-cell-1-23"><a href="#annotated-cell-1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ComplexHeatmap)</span>
<span id="annotated-cell-1-24"><a href="#annotated-cell-1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(circlize)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="introduction" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">7.1</span> Introduction</h2>
<p>In the previous chapters, we defined “who” is in the tissue (cell types) and where they are located (spatial domains). The next logical step is to ask: “what are they doing?”. This is a particularly exciting and open-ended question. Since we have access to the whole transcriptome, we can measure biological activity with unparalleled precision and down to the subcellular level, if desired.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>Pathway analysis allows us to move beyond simple identity markers to infer the active biological processes driving the tissue’s organization. For example, identifying a cell as a “fibroblast” tells us its lineage, but pathway analysis tells us if that fibroblast is actively building scar tissue (TGF-<span class="math inline">\(\beta\)</span> signaling) or recruiting immune cells (NF-<span class="math inline">\(\kappa\)</span>B signaling).</p>
<p>While we can measure thousands of pathways from any number of databases, in this primer we’ll keep things tractable and estimate the activity of 14 cancer-relevant signaling pathways using the PROGENy<span class="citation" data-cites="progeny"><sup><a href="references.html#ref-progeny" role="doc-biblioref">1</a></sup></span> database (see below).</p>
<p>Here is our approach:</p>
<ol type="1">
<li>Smoothing: We will apply nearest neighbor smoothing to borrow information from similar cells, overcoming the sparsity of single-cell data.</li>
<li>Scoring: We will calculate an activity score for each pathway in every single cell using the python package decoupler<span class="citation" data-cites="decoupler"><sup><a href="references.html#ref-decoupler" role="doc-biblioref">2</a></sup></span>.</li>
<li>Inference: We will aggregate these scores by cell type and spatial domain to interpret signaling landscapes that define dominant biological programs and their spatial context within the tissue.</li>
</ol>
<p>This workflow will allow us to answer questions like:</p>
<ul>
<li>Is the tumor driving angiogenesis, or is the stroma?</li>
<li>Which immune cells are actively inflamed versus suppressed?</li>
<li>Does the “Desmoplastic Stroma” domain have a distinct signaling signature?</li>
</ul>
</section>
<section id="processing" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="processing"><span class="header-section-number">7.2</span> Processing</h2>
<p>Read the annData object.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-2"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-2-1"><a href="#annotated-cell-2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'adata'</span> <span class="kw">not</span> <span class="kw">in</span> <span class="bu">dir</span>():</span>
<span id="annotated-cell-2-2"><a href="#annotated-cell-2-2" aria-hidden="true" tabindex="-1"></a>  filename <span class="op">=</span> os.path.join(r.analysis_dir, <span class="st">"anndata-7-domain_annotations.h5ad"</span>)</span>
<span id="annotated-cell-2-3"><a href="#annotated-cell-2-3" aria-hidden="true" tabindex="-1"></a>  adata <span class="op">=</span> ad.read_h5ad(filename)</span>
<span id="annotated-cell-2-4"><a href="#annotated-cell-2-4" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="1">1</button><span id="annotated-cell-2-5" class="code-annotation-target"><a href="#annotated-cell-2-5" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'spatial'</span>][:,<span class="dv">1</span>] <span class="op">*=</span> <span class="op">-</span><span class="dv">1</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-2" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="5" data-code-annotation="1">flipping the y-axis so that the tissue is in the same orientation as the rest of the analysis.</span>
</dd>
</dl>
</div>
</div>
<p>We’ll use the PROGENy (Pathway RespOnsive GENes)<span class="citation" data-cites="progeny"><sup><a href="references.html#ref-progeny" role="doc-biblioref">1</a></sup></span> database available within decoupler<span class="citation" data-cites="decoupler"><sup><a href="references.html#ref-decoupler" role="doc-biblioref">2</a></sup></span> to estimate the single cell enrichment scores of each of the 14 cancer-relevant pathways and their significant values. PROGENy is a resource that estimates pathway activity by analyzing the downstream genes known to change in response to perturbation experiments across a wide variety of human cancer cell lines. I find that it is useful in a wide range of cancer samples but it might not be ideal for, say, transplant or viral infection samples.</p>
<p>The code below adapts <a href="https://decoupler.readthedocs.io/en/latest/notebooks/scell/rna_pstime.html#progeny-pathway-genes" target="_blank">decoupler’s tutorial</a> which uses the <a href="https://decoupler.readthedocs.io/en/latest/api/generated/decoupler.mt.ulm.html" target="_blank">univarte linear model method (ulm) function</a>. PROGENy can provide a high-level overview of the tissue’s molecular functions distilled down to a handful of pathways – which is relatively quick. For non-cancer systems, or if greater resolution is desired, other databases can be used with the <code>ulm</code> approach. If you are interested in exploring other databases within decoupler, run <code>decoupler.op.show_resources()</code>.</p>
<p>Here’s a description of those pathways from decoupler’s website.</p>
<pre><code>- Androgen: involved in the growth and development of the male reproductive organs.
- EGFR: regulates growth, survival, migration, apoptosis, proliferation, and differentiation in mammalian cells
- Estrogen: promotes the growth and development of the female reproductive organs.
- Hypoxia: promotes angiogenesis and metabolic reprogramming when O2 levels are low.
- JAK-STAT: involved in immunity, cell division, cell death, and tumor formation.
- MAPK: integrates external signals and promotes cell growth and proliferation.
- NFkB: regulates immune response, cytokine production and cell survival.
- p53: regulates cell cycle, apoptosis, DNA repair and tumor suppression.
- PI3K: promotes growth and proliferation.
- TGFb: involved in development, homeostasis, and repair of most tissues.
- TNFa: mediates haematopoiesis, immune surveillance, tumour regression and protection from infection.
- Trail: induces apoptosis.
- VEGF: mediates angiogenesis, vascular permeability, and cell migration.
- WNT: regulates organ morphogenesis during development and tissue repair.</code></pre>
<p>Let’s load the PROGENy dataset.</p>
<div class="cell">
<details class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> decoupler <span class="im">as</span> dc</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>progeny <span class="op">=</span> dc.op.progeny(organism<span class="op">=</span><span class="st">'human'</span>, top<span class="op">=</span><span class="dv">500</span>, license<span class="op">=</span><span class="st">"commercial"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>progeny_genes <span class="op">=</span> progeny[<span class="st">'target'</span>].unique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>results_list[<span class="st">'n_progeny_genes'</span>] <span class="ot">=</span> <span class="fu">length</span>(py<span class="sc">$</span>progeny_genes)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(results_list, results_list_file)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>For the analysis below we’ll need normalized data. As we saw in <a href="processing.html" class="quarto-xref"><span>Chapter 4</span></a>, we bypassed the creation of the dense Pearson Residuals normalization matrix and used the PCs instead for nearest neighbors calculations, Leiden, <em>etc</em>. The main reason for this was computational tractability (&gt;400,000 cells by <em>ca</em>. 19,000 targets). That issue is still present here. There are only 5276 genes in the pathway database that we chose and so we do not necessarily need to normalized the entire matrix. Scanpy has a method for Pearson Residuals normalization (<code>sc.experimental.pp.normalize_pearson_residuals</code>) but there’s a catch: ideally we would <em>not</em> run Pearson Normalization on a subset of features. Instead, we would like the non-truncated transcript totals to factor into the normalization procedure. We can achieve this by creating a custom code.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Get valid genes</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># these are the ones that are in BOTH the progeny dataset and in the anndata, adata</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>valid_genes <span class="op">=</span> [g <span class="cf">for</span> g <span class="kw">in</span> progeny_genes <span class="cf">if</span> g <span class="kw">in</span> adata.var_names]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Get GLOBAL Stats (before subsetting)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>counts_layer <span class="op">=</span> adata.layers[<span class="st">'counts'</span>] <span class="cf">if</span> <span class="st">'counts'</span> <span class="kw">in</span> adata.layers <span class="cf">else</span> adata.X</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>global_cell_sums <span class="op">=</span> np.array(counts_layer.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)).flatten() <span class="co"># or just from nCount_RNA</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>total_count <span class="op">=</span> global_cell_sums.<span class="bu">sum</span>() <span class="co"># i.e., sum(obs$nCount_RNA)</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Get GENE Stats (Just for the subset is all that's necessary)</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>gene_indices <span class="op">=</span> [adata.var_names.get_loc(g) <span class="cf">for</span> g <span class="kw">in</span> valid_genes]</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>subset_gene_sums <span class="op">=</span> np.array(counts_layer.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)).flatten()[gene_indices]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Create the Subset</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>adata_sub <span class="op">=</span> adata[:, valid_genes].copy()</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure we are using raw counts for the calculation</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'counts'</span> <span class="kw">in</span> adata_sub.layers:</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    adata_sub.X <span class="op">=</span> adata_sub.layers[<span class="st">'counts'</span>].copy()</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Expected counts based on global depth (from the full dataset)</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> np.outer(global_cell_sums, subset_gene_sums) <span class="op">/</span> total_count</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Pearson Residuals: (Observed - Expected) / StdDev</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>observed <span class="op">=</span> adata_sub.X.toarray()</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>residuals <span class="op">=</span> (observed <span class="op">-</span> mu) <span class="op">/</span> np.sqrt(mu <span class="op">+</span> mu<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> theta)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Clip outliers (similar to what scanpy does)</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>clip_val <span class="op">=</span> np.sqrt(adata_sub.shape[<span class="dv">0</span>])</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>residuals <span class="op">=</span> np.clip(residuals, <span class="op">-</span>clip_val, clip_val)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Save results</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>adata_sub.X <span class="op">=</span> residuals</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> adata</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata_sub </span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gc</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> adata_sub, mu, observed, residuals, global_cell_sums, subset_gene_sums</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>gc.collect()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>At this point the anndata object has many components that are not needed. Let’s reduce the size of this object to reduce the memory footprint.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-7"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-7-1"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up obsm</span></span>
<span id="annotated-cell-7-2"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a>obsm_delete <span class="op">=</span> [<span class="st">'X_pca_TC'</span>, <span class="st">'counts_neg'</span>, <span class="st">'counts_sys'</span>, <span class="st">'umap_TC'</span>]</span>
<span id="annotated-cell-7-3"><a href="#annotated-cell-7-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> obsm_delete:</span>
<span id="annotated-cell-7-4"><a href="#annotated-cell-7-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="kw">in</span> adata.obsm:</span>
<span id="annotated-cell-7-5"><a href="#annotated-cell-7-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> adata.obsm[x]</span>
<span id="annotated-cell-7-6"><a href="#annotated-cell-7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-7"><a href="#annotated-cell-7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up obsp</span></span>
<span id="annotated-cell-7-8"><a href="#annotated-cell-7-8" aria-hidden="true" tabindex="-1"></a>obsp_delete <span class="op">=</span> [<span class="st">'neighbors_TC_connectivities'</span>, <span class="st">'neighbors_TC_distances'</span>]</span>
<span id="annotated-cell-7-9"><a href="#annotated-cell-7-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> obsp_delete:</span>
<span id="annotated-cell-7-10"><a href="#annotated-cell-7-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="kw">in</span> adata.obsp:</span>
<span id="annotated-cell-7-11"><a href="#annotated-cell-7-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> adata.obsp[x]</span>
<span id="annotated-cell-7-12"><a href="#annotated-cell-7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-13"><a href="#annotated-cell-7-13" aria-hidden="true" tabindex="-1"></a>gc.collect()</span>
<span id="annotated-cell-7-14"><a href="#annotated-cell-7-14" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="1">1</button><span id="annotated-cell-7-15" class="code-annotation-target"><a href="#annotated-cell-7-15" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">'pr_norm'</span>] <span class="op">=</span> adata.X.astype(<span class="st">'float32'</span>).copy()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="15" data-code-annotation="1">Convert from float 64 bit to float 32 bit Optional step for systems with less RAM.</span>
</dd>
</dl>
</div>
</div>
</section>
<section id="smoothing-expression" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="smoothing-expression"><span class="header-section-number">7.3</span> Smoothing Expression</h2>
<p>One attribute of all spatial single cell datasets relative to non-spatial method is sparsity. Even for technologies with high-sensitivity detection, individual cells may lack the detection of every transcript required to precisely score pathways. To overcome this, tools like decoupler and liana<span class="citation" data-cites="Dimitrov2022"><sup><a href="references.html#ref-Dimitrov2022" role="doc-biblioref">3</a></sup></span> <span class="citation" data-cites="Dimitrov2024"><sup><a href="references.html#ref-Dimitrov2024" role="doc-biblioref">4</a></sup></span> utilize <em>smoothing</em> – a process of borrowing information from neighboring cells to impute missing values and stabilize pathway scores. However, the term “neighbor” here can be ambiguous. Many of the existing tutorials for these tools were developed with spot-based technologies (like Visium) in mind where <em>spatial smoothing</em> is used because spots are already multi-cellular mixtures. For single-cell resolution data like CosMx SMI, the choice of using spatial smoothing depends on the types of biological questions you have <a href="#tbl-smoothing-choices" class="quarto-xref">Table&nbsp;<span>7.1</span></a>. For pathway analysis, we recommend smoothing based on nearest expression neighbors (NN). Check back later when we release a chapter on ligand-receptor analysis for an example of spatial smoothing.</p>
<div id="tbl-smoothing-choices" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-smoothing-choices-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7.1: Two types of smoothing and when to use them.
</figcaption>
<div aria-describedby="tbl-smoothing-choices-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">Nearest Expression Neighbors (NN)</th>
<th style="text-align: left;">Spatial Neighbors (SN)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Definition</strong></td>
<td style="text-align: left;">Averages signal from cells with similar gene expression profiles (<em>e.g.</em>, neighbors in PCA space).</td>
<td style="text-align: left;">Averages signal from cells physically touching or near the target cell (XY space).</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Primary Benefit</strong></td>
<td style="text-align: left;"><strong>Preserves Cell Identity.</strong> A T cell is smoothed with other T cells, maintaining lineage-specific signals.</td>
<td style="text-align: left;"><strong>Visualizes Zones.</strong> Highlights continuous tissue gradients and regional (<em>i.e.</em>, multiple domain) behaviors. <strong>Analyzing Larger Spatial Patterns</strong> When examining zonal, regional (<em>e.g.</em>, hypoxia), or other larger effects, cells are responding by an interaction of their lineage and their spatial position. Spatial smoothing in this scenario can aid in quantifying the metabolic spatial neighborhood by denoising cells with sparse data. <strong>Ligand Receptor Analysis.</strong> While we might not want to spatially smooth a CD4 T cell with, say, a Tumor cell, for certain analyses, this computational approach can be effective in analyzing <a href="https://liana-py.readthedocs.io/en/latest/notebooks/bivariate.html#bivariate-ligand-receptor-relationships">ligand-receptor relationships</a>. Essentially, if we borrow the receptor expression of nearby cells, we can then test if that receptor is correlated with the focal cells’ corresponding ligand receptor expression.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Drawback</strong></td>
<td style="text-align: left;">May erode any cell type by specific local/regional interaction effect.</td>
<td style="text-align: left;"><strong>Signal Bleeding</strong> Can artificially blend high-expression markers (e.g., <em>PTPRC</em>) into neighboring negative cells (e.g., Tumor). <strong>Tuning</strong> The degree (<em>e.g.</em>, radius, Gaussian kernel) that is used for spatial smoothing is a tuning parameter that, ideally, should align the observational scale with the functional scale.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Best Use Case</strong></td>
<td style="text-align: left;">Lineage-specific pathways (e.g., TCR signaling, Cell Cycle, B cell activation).</td>
<td style="text-align: left;">Environmental gradients that occur at regional levels not captured by expression-based domain assignments (e.g., Hypoxia, Nutrient Deprivation, pH levels).</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Example</strong></td>
<td style="text-align: left;">See <a href="#sec-path-enrichment" class="quarto-xref"><span>Section 7.4</span></a> below</td>
<td style="text-align: left;">See upcoming ligand-receptor chapter (expected early 2026)</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>Let’s apply nearest neighbor smoothing. Recall in <a href="processing.html" class="quarto-xref"><span>Chapter 4</span></a> we created a neighbor graph based on pearson residuals PC values derived using the scPearsonPCA package. This produced the <code>neighbors_pr_connectivities</code> connectivity matrix in <code>obsp</code>. We’ll use this to smooth our cells’ expression.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">'nn_smooth'</span>] <span class="op">=</span> adata.obsp[<span class="st">'neighbors_pr_connectivities'</span>] <span class="op">@</span> adata.layers[<span class="st">'pr_norm'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="sec-path-enrichment" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="sec-path-enrichment"><span class="header-section-number">7.4</span> Pathway Enrichment</h2>
<p>Run the univariate linear model from <code>decoupler</code> using the PROGENy database with this smoothed expression matrix to generate pathway scores. Save the results.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>dc.mt.ulm(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  data<span class="op">=</span>adata, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  net<span class="op">=</span>progeny, </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  verbose<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  layer<span class="op">=</span><span class="ss">f'nn_smooth'</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  bsize<span class="op">=</span><span class="dv">80000</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> os.path.join(r.analysis_dir, <span class="st">"anndata-8-pathways-nn.h5ad"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>adata.write_h5ad(</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  filename,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  compression<span class="op">=</span>hdf5plugin.FILTERS[<span class="st">"zstd"</span>],</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  compression_opts<span class="op">=</span>hdf5plugin.Zstd(clevel<span class="op">=</span><span class="dv">5</span>).filter_options</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="visualizing-pathway-enrichment" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="visualizing-pathway-enrichment"><span class="header-section-number">7.5</span> Visualizing Pathway Enrichment</h2>
<p>We’ll visualize the pathways “locally” on the tissue as well as “globally” by creating heatmaps per cell type and domain.</p>
<section id="sec-local-path-plots" class="level3" data-number="7.5.1">
<h3 data-number="7.5.1" class="anchored" data-anchor-id="sec-local-path-plots"><span class="header-section-number">7.5.1</span> Local: spatial visualizations</h3>
<p>The local plots provide fine-resolution maps of pathway scores on the tissue. The simplest way to do this is to use scanpy’s <code>pl.spatial</code> method. If you want greater flexibility in the plotting aesthetics, we can use the <code>plotDots</code> function in R that we have used throughout this book. Below we’ll show code and results for both approaches.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true" href="">Using Scanpy’s built-in spatial plotting function</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false" href="">Using <code>plotDots</code> in R</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<p>We can convert the scores themselves into a new annData object and then use scanpy’s functions to plot the individual pathways (features).</p>
<div class="cell">
<details class="code-fold">
<summary>Python Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>sc.settings.figdir <span class="op">=</span> r.pw_dir</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>sc.settings.set_figure_params(dpi_save<span class="op">=</span><span class="dv">200</span>, frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>nn_pwdata <span class="op">=</span> dc.pp.get_obsm(adata<span class="op">=</span>adata, key<span class="op">=</span><span class="ss">f'score_ulm'</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>nn_pwdata.obsm[<span class="ss">f'padj_ulm'</span>] <span class="op">=</span> adata.obsm[<span class="ss">f'padj_ulm'</span>]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> nn_pwdata.var_names:</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  sc.pl.spatial(</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>      nn_pwdata,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>      color<span class="op">=</span>[x],</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>      cmap<span class="op">=</span><span class="st">'RdBu_r'</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>      vcenter<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>      size<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>      spot_size<span class="op">=</span><span class="fl">0.01</span>, show<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>      save<span class="op">=</span><span class="st">"_nn_pathway_Scanpy_"</span> <span class="op">+</span> <span class="bu">str</span>(x) <span class="op">+</span> <span class="st">"_xy.png"</span>,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>      alpha_img<span class="op">=</span><span class="dv">1</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Path: Androgen</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Path: EGFR</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">Path: Estrogen</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false" href="">Path: Hypoxia</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false" href="">Path: JAK-STAT</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" role="tab" aria-controls="tabset-1-6" aria-selected="false" href="">Path: MAPK</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-7" role="tab" aria-controls="tabset-1-7" aria-selected="false" href="">Path: NFkB</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-8" role="tab" aria-controls="tabset-1-8" aria-selected="false" href="">Path: PI3K</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-9-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-9" role="tab" aria-controls="tabset-1-9" aria-selected="false" href="">Path: TGFb</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-10-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-10" role="tab" aria-controls="tabset-1-10" aria-selected="false" href="">Path: TNFa</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-11-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-11" role="tab" aria-controls="tabset-1-11" aria-selected="false" href="">Path: Trail</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-12-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-12" role="tab" aria-controls="tabset-1-12" aria-selected="false" href="">Path: VEGF</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-13-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-13" role="tab" aria-controls="tabset-1-13" aria-selected="false" href="">Path: WNT</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-14-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-14" role="tab" aria-controls="tabset-1-14" aria-selected="false" href="">Path: p53</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-Androgen-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-Androgen-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_Androgen_xy.png" class="img-fluid figure-img" width="356">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-Androgen-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.1: Local Androgen pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-EGFR-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-EGFR-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_EGFR_xy.png" class="img-fluid figure-img" width="356">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-EGFR-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.2: Local EGFR pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-Estrogen-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-Estrogen-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_Estrogen_xy.png" class="img-fluid figure-img" width="374">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-Estrogen-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.3: Local Estrogen pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-Hypoxia-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-Hypoxia-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_Hypoxia_xy.png" class="img-fluid figure-img" width="356">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-Hypoxia-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.4: Local Hypoxia pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-JAK-STAT-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-JAK-STAT-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_JAK-STAT_xy.png" class="img-fluid figure-img" width="356">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-JAK-STAT-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.5: Local JAK-STAT pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-6-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-MAPK-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-MAPK-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_MAPK_xy.png" class="img-fluid figure-img" width="356">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-MAPK-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.6: Local MAPK pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-7-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-NFkB-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-NFkB-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_NFkB_xy.png" class="img-fluid figure-img" width="352">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-NFkB-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.7: Local NFkB pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-8-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-PI3K-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-PI3K-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_PI3K_xy.png" class="img-fluid figure-img" width="386">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-PI3K-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.8: Local PI3K pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-9" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-9-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-TGFb-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-TGFb-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_TGFb_xy.png" class="img-fluid figure-img" width="368">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-TGFb-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.9: Local TGFb pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-10" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-10-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-TNFa-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-TNFa-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_TNFa_xy.png" class="img-fluid figure-img" width="352">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-TNFa-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.10: Local TNFa pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-11" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-11-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-Trail-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-Trail-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_Trail_xy.png" class="img-fluid figure-img" width="356">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-Trail-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.11: Local Trail pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-12" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-12-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-VEGF-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-VEGF-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_VEGF_xy.png" class="img-fluid figure-img" width="356">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-VEGF-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.12: Local VEGF pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-13" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-13-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-WNT-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-WNT-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_WNT_xy.png" class="img-fluid figure-img" width="356">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-WNT-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.13: Local WNT pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-14" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-14-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-p53-scanpy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-p53-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/show_nn_pathway_Scanpy_p53_xy.png" class="img-fluid figure-img" width="368">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-p53-scanpy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.14: Local p53 pathway scores plotted with sc.pl.spatial.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<p>This block runs the <code>plotDots</code> function that we have used in previous chapters on the objects that we create in the previous subsection, <code>nn_pwdata</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>R Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-13"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="1">1</button><span id="annotated-cell-13-1" class="code-annotation-target"><a href="#annotated-cell-13-1" aria-hidden="true" tabindex="-1"></a>py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>obsm[<span class="st">'spatial'</span>][,<span class="dv">2</span>] <span class="ot">&lt;-</span> py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>obsm[<span class="st">'spatial'</span>][,<span class="dv">2</span>] <span class="sc">*</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="annotated-cell-13-2"><a href="#annotated-cell-13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-3"><a href="#annotated-cell-13-3" aria-hidden="true" tabindex="-1"></a>features <span class="ot">&lt;-</span> py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>var_names<span class="sc">$</span><span class="fu">to_list</span>()</span>
<span id="annotated-cell-13-4"><a href="#annotated-cell-13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-5"><a href="#annotated-cell-13-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(feature <span class="cf">in</span> features){</span>
<span id="annotated-cell-13-6"><a href="#annotated-cell-13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plotDots</span>(py<span class="sc">$</span>nn_pwdata, <span class="at">color_by=</span>feature,</span>
<span id="annotated-cell-13-7"><a href="#annotated-cell-13-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot_global =</span> <span class="cn">TRUE</span>,</span>
<span id="annotated-cell-13-8"><a href="#annotated-cell-13-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">facet_by_group =</span> <span class="cn">FALSE</span>,</span>
<span id="annotated-cell-13-9"><a href="#annotated-cell-13-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_plot_parameters =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-13-10"><a href="#annotated-cell-13-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_point_params =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-13-11"><a href="#annotated-cell-13-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size=</span><span class="fl">0.001</span></span>
<span id="annotated-cell-13-12"><a href="#annotated-cell-13-12" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="annotated-cell-13-13"><a href="#annotated-cell-13-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">scale_bar_params =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-13-14"><a href="#annotated-cell-13-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">location =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">0</span>),</span>
<span id="annotated-cell-13-15"><a href="#annotated-cell-13-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">width =</span> <span class="dv">2</span>,</span>
<span id="annotated-cell-13-16"><a href="#annotated-cell-13-16" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n =</span> <span class="dv">3</span>,</span>
<span id="annotated-cell-13-17"><a href="#annotated-cell-13-17" aria-hidden="true" tabindex="-1"></a>                    <span class="at">height =</span> <span class="fl">0.1</span>,</span>
<span id="annotated-cell-13-18"><a href="#annotated-cell-13-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">scale_colors =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"grey30"</span>),</span>
<span id="annotated-cell-13-19"><a href="#annotated-cell-13-19" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label_nudge_y =</span> <span class="sc">-</span><span class="fl">0.3</span></span>
<span id="annotated-cell-13-20"><a href="#annotated-cell-13-20" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="annotated-cell-13-21"><a href="#annotated-cell-13-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">directory =</span> pw_dir,</span>
<span id="annotated-cell-13-22"><a href="#annotated-cell-13-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fileType =</span> <span class="st">"png"</span>,</span>
<span id="annotated-cell-13-23"><a href="#annotated-cell-13-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dpi =</span> <span class="dv">200</span>,</span>
<span id="annotated-cell-13-24"><a href="#annotated-cell-13-24" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> <span class="dv">8</span>, </span>
<span id="annotated-cell-13-25"><a href="#annotated-cell-13-25" aria-hidden="true" tabindex="-1"></a>                  <span class="at">height =</span> <span class="dv">8</span>,</span>
<span id="annotated-cell-13-26"><a href="#annotated-cell-13-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prefix=</span><span class="fu">paste0</span>(<span class="st">"plotDots_"</span>, feature)</span>
<span id="annotated-cell-13-27"><a href="#annotated-cell-13-27" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="annotated-cell-13-28"><a href="#annotated-cell-13-28" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_ggplot_layers =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-13-29"><a href="#annotated-cell-13-29" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_bw</span>(), </span>
<span id="annotated-cell-13-30"><a href="#annotated-cell-13-30" aria-hidden="true" tabindex="-1"></a>                <span class="fu">scale_color_gradient2</span>(<span class="at">low =</span> <span class="st">"darkblue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"darkred"</span>, <span class="at">midpoint =</span> <span class="dv">0</span>),</span>
<span id="annotated-cell-13-31"><a href="#annotated-cell-13-31" aria-hidden="true" tabindex="-1"></a>                <span class="fu">xlab</span>(<span class="st">"X (mm)"</span>),</span>
<span id="annotated-cell-13-32"><a href="#annotated-cell-13-32" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ylab</span>(<span class="st">"Y (mm)"</span>), </span>
<span id="annotated-cell-13-33"><a href="#annotated-cell-13-33" aria-hidden="true" tabindex="-1"></a>                <span class="fu">coord_fixed</span>(),</span>
<span id="annotated-cell-13-34"><a href="#annotated-cell-13-34" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.4</span>))</span>
<span id="annotated-cell-13-35"><a href="#annotated-cell-13-35" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="annotated-cell-13-36"><a href="#annotated-cell-13-36" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="annotated-cell-13-37"><a href="#annotated-cell-13-37" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-13" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="1" data-code-annotation="1">Flipping the y-axis back.</span>
</dd>
</dl>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true" href="">Path: Androgen</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false" href="">Path: EGFR</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false" href="">Path: Estrogen</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-4" role="tab" aria-controls="tabset-2-4" aria-selected="false" href="">Path: Hypoxia</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-5" role="tab" aria-controls="tabset-2-5" aria-selected="false" href="">Path: JAK-STAT</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-6" role="tab" aria-controls="tabset-2-6" aria-selected="false" href="">Path: MAPK</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-7" role="tab" aria-controls="tabset-2-7" aria-selected="false" href="">Path: NFkB</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-8" role="tab" aria-controls="tabset-2-8" aria-selected="false" href="">Path: PI3K</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-9-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-9" role="tab" aria-controls="tabset-2-9" aria-selected="false" href="">Path: TGFb</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-10-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-10" role="tab" aria-controls="tabset-2-10" aria-selected="false" href="">Path: TNFa</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-11-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-11" role="tab" aria-controls="tabset-2-11" aria-selected="false" href="">Path: Trail</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-12-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-12" role="tab" aria-controls="tabset-2-12" aria-selected="false" href="">Path: VEGF</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-13-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-13" role="tab" aria-controls="tabset-2-13" aria-selected="false" href="">Path: WNT</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-14-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-14" role="tab" aria-controls="tabset-2-14" aria-selected="false" href="">Path: p53</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-Androgen" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-Androgen-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_Androgen__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-Androgen-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.15: Local Androgen pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-EGFR" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-EGFR-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_EGFR__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-EGFR-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.16: Local EGFR pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-Estrogen" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-Estrogen-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_Estrogen__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-Estrogen-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.17: Local Estrogen pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-4-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-Hypoxia" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-Hypoxia-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_Hypoxia__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-Hypoxia-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.18: Local Hypoxia pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-5-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-JAK-STAT" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-JAK-STAT-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_JAK-STAT__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-JAK-STAT-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.19: Local JAK-STAT pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-6-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-MAPK" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-MAPK-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_MAPK__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-MAPK-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.20: Local MAPK pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-7-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-NFkB" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-NFkB-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_NFkB__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-NFkB-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.21: Local NFkB pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-8-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-PI3K" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-PI3K-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_PI3K__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-PI3K-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.22: Local PI3K pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-9" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-9-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-TGFb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-TGFb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_TGFb__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-TGFb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.23: Local TGFb pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-10" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-10-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-TNFa" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-TNFa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_TNFa__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-TNFa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.24: Local TNFa pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-11" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-11-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-Trail" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-Trail-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_Trail__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-Trail-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.25: Local Trail pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-12" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-12-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-VEGF" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-VEGF-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_VEGF__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-VEGF-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.26: Local VEGF pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-13" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-13-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-WNT" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-WNT-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_WNT__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-WNT-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.27: Local WNT pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-14" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-14-tab">
<div class="cell">
<div class="cell-output-display">
<div id="fig-Path-p53" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Path-p53-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/plotDots_p53__spatial__S0__plot.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Path-p53-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.28: Local p53 pathway scores plotted with the plotDots function.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="global-per-cell-type" class="level3" data-number="7.5.2">
<h3 data-number="7.5.2" class="anchored" data-anchor-id="global-per-cell-type"><span class="header-section-number">7.5.2</span> Global: Per Cell Type</h3>
<p>In addition to plotting the local pathway scores in space with scanpy or <code>plotDots</code>, we can visualize the results summarized across each cell type or each domain. These next two subsections do just that. We’ll use the plotting functionality within the <code>complexHeatmap</code> R package. It can be helpful to plot the average enrichment as well as the Z-scores. The former helps with us understand the overall sense of what is being enriched whereas the latter helps to compare a particular effect size relative to other cell types.</p>
<div class="cell">
<details class="code-fold">
<summary>R Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-10"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-10-1"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>obs <span class="sc">%&gt;%</span> <span class="fu">select</span>(cell_ID, celltype_broad, celltype_fine)</span>
<span id="annotated-cell-10-2"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a>expr <span class="ot">&lt;-</span> py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>X</span>
<span id="annotated-cell-10-3"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(expr) <span class="ot">&lt;-</span> py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>var_names<span class="sc">$</span><span class="fu">to_list</span>()</span>
<span id="annotated-cell-10-4"><a href="#annotated-cell-10-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(df, expr)</span>
<span id="annotated-cell-10-5"><a href="#annotated-cell-10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-6"><a href="#annotated-cell-10-6" aria-hidden="true" tabindex="-1"></a>pathway_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(df), <span class="fu">c</span>(<span class="st">"cell_ID"</span>, <span class="st">"celltype_broad"</span>, <span class="st">"celltype_fine"</span>))</span>
<span id="annotated-cell-10-7"><a href="#annotated-cell-10-7" aria-hidden="true" tabindex="-1"></a>min_obs <span class="ot">=</span> <span class="dv">50</span></span>
<span id="annotated-cell-10-8"><a href="#annotated-cell-10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-9"><a href="#annotated-cell-10-9" aria-hidden="true" tabindex="-1"></a>mean_enrich_by_ct <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-10-10"><a href="#annotated-cell-10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(celltype_broad, celltype_fine) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-10-11"><a href="#annotated-cell-10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="annotated-cell-10-12"><a href="#annotated-cell-10-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="annotated-cell-10-13"><a href="#annotated-cell-10-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">all_of</span>(pathway_cols), mean, <span class="at">.names =</span> <span class="st">"{.col}_mean"</span>),</span>
<span id="annotated-cell-10-14"><a href="#annotated-cell-10-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="annotated-cell-10-15"><a href="#annotated-cell-10-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="annotated-cell-10-16"><a href="#annotated-cell-10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;=</span> min_obs) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-10-17"><a href="#annotated-cell-10-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(celltype_broad, celltype_fine)</span>
<span id="annotated-cell-10-18"><a href="#annotated-cell-10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-19"><a href="#annotated-cell-10-19" aria-hidden="true" tabindex="-1"></a>scaled_enrich_by_ct <span class="ot">&lt;-</span> mean_enrich_by_ct <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-10-20"><a href="#annotated-cell-10-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>), <span class="sc">~</span><span class="fu">as.numeric</span>(<span class="fu">scale</span>(.)))) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-10-21"><a href="#annotated-cell-10-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(celltype_broad, celltype_fine)</span>
<span id="annotated-cell-10-22"><a href="#annotated-cell-10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-23"><a href="#annotated-cell-10-23" aria-hidden="true" tabindex="-1"></a>celltype_broad_colors <span class="ot">&lt;-</span> results_list[[<span class="st">'celltype_broad_colors'</span>]]</span>
<span id="annotated-cell-10-24"><a href="#annotated-cell-10-24" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(celltype_broad_colors) <span class="ot">&lt;-</span> results_list[[<span class="st">'celltype_broad_names'</span>]]</span>
<span id="annotated-cell-10-25"><a href="#annotated-cell-10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-26"><a href="#annotated-cell-10-26" aria-hidden="true" tabindex="-1"></a>celltype_fine_colors <span class="ot">&lt;-</span> results_list[[<span class="st">'celltype_fine_colors'</span>]]</span>
<span id="annotated-cell-10-27"><a href="#annotated-cell-10-27" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(celltype_fine_colors) <span class="ot">&lt;-</span> results_list[[<span class="st">'celltype_fine_names'</span>]]</span>
<span id="annotated-cell-10-28"><a href="#annotated-cell-10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-29"><a href="#annotated-cell-10-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Shared Row Annotation</span></span>
<span id="annotated-cell-10-30"><a href="#annotated-cell-10-30" aria-hidden="true" tabindex="-1"></a>row_ha <span class="ot">&lt;-</span> <span class="fu">HeatmapAnnotation</span>(</span>
<span id="annotated-cell-10-31"><a href="#annotated-cell-10-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Cell Group"</span> <span class="ot">=</span> scaled_enrich_by_ct<span class="sc">$</span>celltype_broad,</span>
<span id="annotated-cell-10-32"><a href="#annotated-cell-10-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Cell Type"</span> <span class="ot">=</span> scaled_enrich_by_ct<span class="sc">$</span>celltype_fine,</span>
<span id="annotated-cell-10-33"><a href="#annotated-cell-10-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">list</span>(</span>
<span id="annotated-cell-10-34"><a href="#annotated-cell-10-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cell Group"</span> <span class="ot">=</span> celltype_broad_colors,</span>
<span id="annotated-cell-10-35"><a href="#annotated-cell-10-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cell Type"</span> <span class="ot">=</span> celltype_fine_colors</span>
<span id="annotated-cell-10-36"><a href="#annotated-cell-10-36" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="annotated-cell-10-37"><a href="#annotated-cell-10-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_legend =</span> <span class="fu">c</span>(<span class="st">"Cell Group"</span> <span class="ot">=</span> <span class="cn">FALSE</span>, <span class="st">"Cell Type"</span> <span class="ot">=</span> <span class="cn">FALSE</span>),</span>
<span id="annotated-cell-10-38"><a href="#annotated-cell-10-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">which =</span> <span class="st">"row"</span></span>
<span id="annotated-cell-10-39"><a href="#annotated-cell-10-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-10-40"><a href="#annotated-cell-10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-41"><a href="#annotated-cell-10-41" aria-hidden="true" tabindex="-1"></a>zscore_col_fun <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="fu">c</span>(<span class="st">"#2166AC"</span>, <span class="st">"white"</span>, <span class="st">"#B2182B"</span>))</span>
<span id="annotated-cell-10-42"><a href="#annotated-cell-10-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-43"><a href="#annotated-cell-10-43" aria-hidden="true" tabindex="-1"></a>heatmap_matrix_z <span class="ot">&lt;-</span> scaled_enrich_by_ct <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-10-44"><a href="#annotated-cell-10-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>)) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-10-45"><a href="#annotated-cell-10-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="annotated-cell-10-46"><a href="#annotated-cell-10-46" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(heatmap_matrix_z) <span class="ot">&lt;-</span> scaled_enrich_by_ct<span class="sc">$</span>celltype_fine</span>
<span id="annotated-cell-10-47"><a href="#annotated-cell-10-47" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(heatmap_matrix_z) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_mean"</span>, <span class="st">""</span>, <span class="fu">colnames</span>(heatmap_matrix_z))</span>
<span id="annotated-cell-10-48"><a href="#annotated-cell-10-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-49"><a href="#annotated-cell-10-49" aria-hidden="true" tabindex="-1"></a>ht_z <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(</span>
<span id="annotated-cell-10-50"><a href="#annotated-cell-10-50" aria-hidden="true" tabindex="-1"></a>  heatmap_matrix_z,</span>
<span id="annotated-cell-10-51"><a href="#annotated-cell-10-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"Pathway Z-score</span><span class="sc">\n</span><span class="st">(Relative)"</span>,</span>
<span id="annotated-cell-10-52"><a href="#annotated-cell-10-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> zscore_col_fun,</span>
<span id="annotated-cell-10-53"><a href="#annotated-cell-10-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-10-54"><a href="#annotated-cell-10-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">left_annotation =</span> row_ha,</span>
<span id="annotated-cell-10-55"><a href="#annotated-cell-10-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-56"><a href="#annotated-cell-10-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_row_names =</span> <span class="cn">TRUE</span>,</span>
<span id="annotated-cell-10-57"><a href="#annotated-cell-10-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">6</span>),</span>
<span id="annotated-cell-10-58"><a href="#annotated-cell-10-58" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1">1</button><span id="annotated-cell-10-59" class="code-annotation-target"><a href="#annotated-cell-10-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_columns =</span> <span class="cn">FALSE</span>,</span>
<span id="annotated-cell-10-60"><a href="#annotated-cell-10-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">column_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">7</span>),</span>
<span id="annotated-cell-10-61"><a href="#annotated-cell-10-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_split =</span> scaled_enrich_by_ct<span class="sc">$</span>celltype_broad, </span>
<span id="annotated-cell-10-62"><a href="#annotated-cell-10-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_row_slices =</span> <span class="cn">TRUE</span>,</span>
<span id="annotated-cell-10-63"><a href="#annotated-cell-10-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_rows =</span> <span class="cn">FALSE</span>,</span>
<span id="annotated-cell-10-64"><a href="#annotated-cell-10-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_rot =</span> <span class="dv">0</span>,</span>
<span id="annotated-cell-10-65"><a href="#annotated-cell-10-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">10</span>)</span>
<span id="annotated-cell-10-66"><a href="#annotated-cell-10-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-10-67"><a href="#annotated-cell-10-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-68"><a href="#annotated-cell-10-68" aria-hidden="true" tabindex="-1"></a>svglite<span class="sc">::</span><span class="fu">svglite</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_cell_type_zscore.svg"</span>), <span class="at">width =</span> <span class="fl">3.5</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="annotated-cell-10-69"><a href="#annotated-cell-10-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(</span>
<span id="annotated-cell-10-70"><a href="#annotated-cell-10-70" aria-hidden="true" tabindex="-1"></a>    ht_z, </span>
<span id="annotated-cell-10-71"><a href="#annotated-cell-10-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, </span>
<span id="annotated-cell-10-72"><a href="#annotated-cell-10-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>,</span>
<span id="annotated-cell-10-73"><a href="#annotated-cell-10-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">merge_legend =</span> <span class="cn">TRUE</span></span>
<span id="annotated-cell-10-74"><a href="#annotated-cell-10-74" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="annotated-cell-10-75"><a href="#annotated-cell-10-75" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="annotated-cell-10-76"><a href="#annotated-cell-10-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-77"><a href="#annotated-cell-10-77" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_cell_type_zscore.png"</span>), </span>
<span id="annotated-cell-10-78"><a href="#annotated-cell-10-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">width=</span><span class="dv">4</span>, <span class="at">height=</span><span class="dv">8</span>, <span class="at">res=</span><span class="dv">350</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">type =</span> <span class="st">'cairo'</span>)</span>
<span id="annotated-cell-10-79"><a href="#annotated-cell-10-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(</span>
<span id="annotated-cell-10-80"><a href="#annotated-cell-10-80" aria-hidden="true" tabindex="-1"></a>    ht_z, </span>
<span id="annotated-cell-10-81"><a href="#annotated-cell-10-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, </span>
<span id="annotated-cell-10-82"><a href="#annotated-cell-10-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>,</span>
<span id="annotated-cell-10-83"><a href="#annotated-cell-10-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">merge_legend =</span> <span class="cn">TRUE</span></span>
<span id="annotated-cell-10-84"><a href="#annotated-cell-10-84" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="annotated-cell-10-85"><a href="#annotated-cell-10-85" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="annotated-cell-10-86"><a href="#annotated-cell-10-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-87"><a href="#annotated-cell-10-87" aria-hidden="true" tabindex="-1"></a>heatmap_matrix_mean <span class="ot">&lt;-</span> mean_enrich_by_ct <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-10-88"><a href="#annotated-cell-10-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>)) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-10-89"><a href="#annotated-cell-10-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="annotated-cell-10-90"><a href="#annotated-cell-10-90" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(heatmap_matrix_mean) <span class="ot">&lt;-</span> mean_enrich_by_ct<span class="sc">$</span>celltype_fine</span>
<span id="annotated-cell-10-91"><a href="#annotated-cell-10-91" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(heatmap_matrix_mean) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_mean"</span>, <span class="st">""</span>, <span class="fu">colnames</span>(heatmap_matrix_mean))</span>
<span id="annotated-cell-10-92"><a href="#annotated-cell-10-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-93"><a href="#annotated-cell-10-93" aria-hidden="true" tabindex="-1"></a>quantile_limit <span class="ot">&lt;-</span> <span class="fl">0.95</span></span>
<span id="annotated-cell-10-94"><a href="#annotated-cell-10-94" aria-hidden="true" tabindex="-1"></a>limit <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(<span class="fu">abs</span>(<span class="fu">as.vector</span>(heatmap_matrix_mean)), quantile_limit, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="annotated-cell-10-95"><a href="#annotated-cell-10-95" aria-hidden="true" tabindex="-1"></a>mean_col_fun <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="fu">c</span>(<span class="sc">-</span>limit, <span class="dv">0</span>, limit), <span class="fu">c</span>(<span class="st">"#2166AC"</span>, <span class="st">"white"</span>, <span class="st">"#B2182B"</span>))</span>
<span id="annotated-cell-10-96"><a href="#annotated-cell-10-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-97"><a href="#annotated-cell-10-97" aria-hidden="true" tabindex="-1"></a>ht_mean <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(</span>
<span id="annotated-cell-10-98"><a href="#annotated-cell-10-98" aria-hidden="true" tabindex="-1"></a>  heatmap_matrix_mean,</span>
<span id="annotated-cell-10-99"><a href="#annotated-cell-10-99" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"PROGENy Score</span><span class="sc">\n</span><span class="st">(Mean)"</span>,</span>
<span id="annotated-cell-10-100"><a href="#annotated-cell-10-100" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> mean_col_fun,</span>
<span id="annotated-cell-10-101"><a href="#annotated-cell-10-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-10-102"><a href="#annotated-cell-10-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">left_annotation =</span> row_ha,</span>
<span id="annotated-cell-10-103"><a href="#annotated-cell-10-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-104"><a href="#annotated-cell-10-104" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_row_names =</span> <span class="cn">TRUE</span>,</span>
<span id="annotated-cell-10-105"><a href="#annotated-cell-10-105" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">6</span>),</span>
<span id="annotated-cell-10-106"><a href="#annotated-cell-10-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-107"><a href="#annotated-cell-10-107" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_columns =</span> <span class="cn">FALSE</span>, </span>
<span id="annotated-cell-10-108"><a href="#annotated-cell-10-108" aria-hidden="true" tabindex="-1"></a>  <span class="at">column_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">7</span>),</span>
<span id="annotated-cell-10-109"><a href="#annotated-cell-10-109" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_split =</span> mean_enrich_by_ct<span class="sc">$</span>celltype_broad, </span>
<span id="annotated-cell-10-110"><a href="#annotated-cell-10-110" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_row_slices =</span> <span class="cn">TRUE</span>,</span>
<span id="annotated-cell-10-111"><a href="#annotated-cell-10-111" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_rows =</span> <span class="cn">FALSE</span>,</span>
<span id="annotated-cell-10-112"><a href="#annotated-cell-10-112" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_rot =</span> <span class="dv">0</span>,</span>
<span id="annotated-cell-10-113"><a href="#annotated-cell-10-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">10</span>)</span>
<span id="annotated-cell-10-114"><a href="#annotated-cell-10-114" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-10-115"><a href="#annotated-cell-10-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-116"><a href="#annotated-cell-10-116" aria-hidden="true" tabindex="-1"></a>svglite<span class="sc">::</span><span class="fu">svglite</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_cell_type_mean.svg"</span>), <span class="at">width =</span> <span class="fl">3.5</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="annotated-cell-10-117"><a href="#annotated-cell-10-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(</span>
<span id="annotated-cell-10-118"><a href="#annotated-cell-10-118" aria-hidden="true" tabindex="-1"></a>    ht_mean, </span>
<span id="annotated-cell-10-119"><a href="#annotated-cell-10-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, </span>
<span id="annotated-cell-10-120"><a href="#annotated-cell-10-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>,</span>
<span id="annotated-cell-10-121"><a href="#annotated-cell-10-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">merge_legend =</span> <span class="cn">TRUE</span></span>
<span id="annotated-cell-10-122"><a href="#annotated-cell-10-122" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="annotated-cell-10-123"><a href="#annotated-cell-10-123" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="annotated-cell-10-124"><a href="#annotated-cell-10-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-125"><a href="#annotated-cell-10-125" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_cell_type_mean.png"</span>), </span>
<span id="annotated-cell-10-126"><a href="#annotated-cell-10-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">width=</span><span class="dv">4</span>, <span class="at">height=</span><span class="dv">8</span>, <span class="at">res=</span><span class="dv">350</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">type =</span> <span class="st">'cairo'</span>)</span>
<span id="annotated-cell-10-127"><a href="#annotated-cell-10-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(</span>
<span id="annotated-cell-10-128"><a href="#annotated-cell-10-128" aria-hidden="true" tabindex="-1"></a>    ht_mean, </span>
<span id="annotated-cell-10-129"><a href="#annotated-cell-10-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, </span>
<span id="annotated-cell-10-130"><a href="#annotated-cell-10-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>,</span>
<span id="annotated-cell-10-131"><a href="#annotated-cell-10-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">merge_legend =</span> <span class="cn">TRUE</span></span>
<span id="annotated-cell-10-132"><a href="#annotated-cell-10-132" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="annotated-cell-10-133"><a href="#annotated-cell-10-133" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="59" data-code-annotation="1">Set to FALSE to make it easier to compare the mean and the Z-score heatmaps. Set to TRUE to make it easier to group similar pathway signatures.</span>
</dd>
</dl>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true" href="">Mean</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false" href="">Z-score</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-heatmap-paths-by-celltypes-m" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-heatmap-paths-by-celltypes-m-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/heatmap_by_cell_type_mean.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-heatmap-paths-by-celltypes-m-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.29: Average pathway enrichment scores by cell type.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-heatmap-paths-by-celltypes-z" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-heatmap-paths-by-celltypes-z-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/heatmap_by_cell_type_zscore.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-heatmap-paths-by-celltypes-z-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.30: Average pathway enrichment scores (z-score) by cell type.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="global-per-domain" class="level3" data-number="7.5.3">
<h3 data-number="7.5.3" class="anchored" data-anchor-id="global-per-domain"><span class="header-section-number">7.5.3</span> Global: Per Domain</h3>
<p>This follows a similar procedure as above but summarized across spatial domains.</p>
<div class="cell">
<details class="code-fold">
<summary>R Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">merge</span>(df, py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>obs <span class="sc">%&gt;%</span> <span class="fu">select</span>(cell_ID, annotated_domain), <span class="at">by=</span><span class="st">"cell_ID"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">filter</span>(df, <span class="sc">!</span><span class="fu">is.na</span>(annotated_domain))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>min_obs <span class="ot">=</span> <span class="dv">50</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Mean Scores</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>mean_enrich_by_domain <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(annotated_domain) <span class="sc">%&gt;%</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">all_of</span>(pathway_cols), mean, <span class="at">.names =</span> <span class="st">"{.col}_mean"</span>),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;=</span> min_obs, <span class="sc">!</span><span class="fu">is.na</span>(annotated_domain)) <span class="sc">%&gt;%</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(annotated_domain)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Z-scores (Scale the means)</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>scaled_enrich_by_domain <span class="ot">&lt;-</span> mean_enrich_by_domain <span class="sc">%&gt;%</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>), <span class="sc">~</span><span class="fu">as.numeric</span>(<span class="fu">scale</span>(.)))) <span class="sc">%&gt;%</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(annotated_domain)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Colors</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>domain_colors_df  <span class="ot">&lt;-</span> results_list[[<span class="st">'domain_colors'</span>]]</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>domain_colors <span class="ot">&lt;-</span> domain_colors_df<span class="sc">$</span>domain_color</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(domain_colors) <span class="ot">&lt;-</span> domain_colors_df<span class="sc">$</span>domain_description</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Common Row Annotation</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>row_ha <span class="ot">&lt;-</span> <span class="fu">HeatmapAnnotation</span>(</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Spatial Domain"</span> <span class="ot">=</span> mean_enrich_by_domain<span class="sc">$</span>annotated_domain,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">list</span>(<span class="st">"Spatial Domain"</span> <span class="ot">=</span> domain_colors),</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_legend =</span> <span class="fu">c</span>(<span class="st">"Spatial Domain"</span> <span class="ot">=</span> <span class="cn">FALSE</span>),</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">which =</span> <span class="st">"row"</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Color Functions</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>zscore_col_fun <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="fu">c</span>(<span class="st">"#2166AC"</span>, <span class="st">"white"</span>, <span class="st">"#B2182B"</span>))</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Z-Score Heatmap</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>heatmap_matrix_z <span class="ot">&lt;-</span> scaled_enrich_by_domain <span class="sc">%&gt;%</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(heatmap_matrix_z) <span class="ot">&lt;-</span> scaled_enrich_by_domain<span class="sc">$</span>annotated_domain</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(heatmap_matrix_z) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_mean"</span>, <span class="st">""</span>, <span class="fu">colnames</span>(heatmap_matrix_z))</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>ht_z <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>  heatmap_matrix_z,</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"Pathway Z-score</span><span class="sc">\n</span><span class="st">(Relative)"</span>,</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> zscore_col_fun,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">left_annotation =</span> row_ha,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_row_names =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="fl">5.5</span>),</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_columns =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">column_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="fl">5.5</span>),</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_rot =</span> <span class="dv">0</span>,</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">8</span>)</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>svglite<span class="sc">::</span><span class="fu">svglite</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_domain_zscore.svg"</span>), <span class="at">width =</span> <span class="fl">3.5</span>, <span class="at">height =</span> <span class="dv">3</span>)</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(ht_z, <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">merge_legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_domain_zscore.png"</span>), <span class="at">width=</span><span class="fl">3.5</span>, <span class="at">height=</span><span class="fl">3.5</span>, <span class="at">res=</span><span class="dv">350</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">type =</span> <span class="st">'cairo'</span>)</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(ht_z, <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">merge_legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean Score Heatmap</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>heatmap_matrix_mean <span class="ot">&lt;-</span> mean_enrich_by_domain <span class="sc">%&gt;%</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(heatmap_matrix_mean) <span class="ot">&lt;-</span> mean_enrich_by_domain<span class="sc">$</span>annotated_domain</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(heatmap_matrix_mean) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_mean"</span>, <span class="st">""</span>, <span class="fu">colnames</span>(heatmap_matrix_mean))</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>quantile_limit <span class="ot">&lt;-</span> <span class="fl">0.95</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>limit <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(<span class="fu">abs</span>(<span class="fu">as.vector</span>(heatmap_matrix_mean)), quantile_limit, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>mean_col_fun <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="fu">c</span>(<span class="sc">-</span>limit, <span class="dv">0</span>, limit), <span class="fu">c</span>(<span class="st">"#2166AC"</span>, <span class="st">"white"</span>, <span class="st">"#B2182B"</span>))</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>ht_mean <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>  heatmap_matrix_mean,</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"PROGENy Score</span><span class="sc">\n</span><span class="st">(Mean)"</span>,</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> mean_col_fun,</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">left_annotation =</span> row_ha,</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_row_names =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="fl">5.5</span>),</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_columns =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">column_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="fl">5.5</span>),</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_rot =</span> <span class="dv">0</span>,</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">8</span>)</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>svglite<span class="sc">::</span><span class="fu">svglite</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_domain_mean.svg"</span>), <span class="at">width =</span> <span class="fl">3.5</span>, <span class="at">height =</span> <span class="dv">3</span>)</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(ht_mean, <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">merge_legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_domain_mean.png"</span>), <span class="at">width=</span><span class="fl">3.5</span>, <span class="at">height=</span><span class="fl">3.5</span>, <span class="at">res=</span><span class="dv">350</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">type =</span> <span class="st">'cairo'</span>)</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(ht_mean, <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">merge_legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true" href="">Mean</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false" href="">Z-score</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-heatmap-paths-by-domains-m" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-heatmap-paths-by-domains-m-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/heatmap_by_domain_mean.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-heatmap-paths-by-domains-m-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.31: Average pathway enrichment scores by spatial domain. Colors correspond to domains in <a href="cell-typing.html#fig-xy-domains" class="quarto-xref">Figure&nbsp;<span>6.8</span></a>. Note: columns were clustered and so will have a difference order than that found in <a href="#fig-heatmap-paths-by-domains-z" class="quarto-xref">Figure&nbsp;<span>7.32</span></a>.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-heatmap-paths-by-domains-z" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-heatmap-paths-by-domains-z-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/analysis_results/pathways/heatmap_by_domain_zscore.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-heatmap-paths-by-domains-z-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.32: Average pathway enrichment scores (z-score) by spatial domain. Colors correspond to domains in <a href="cell-typing.html#fig-xy-domains" class="quarto-xref">Figure&nbsp;<span>6.8</span></a>. Note: columns were clustered and so will have a difference order than that found in <a href="#fig-heatmap-paths-by-domains-m" class="quarto-xref">Figure&nbsp;<span>7.31</span></a>.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Examining and comparing the spatial plots in <a href="#sec-local-path-plots" class="quarto-xref"><span>Section 7.5.1</span></a> with the global heatmaps <a href="#fig-heatmap-paths-by-celltypes-m" class="quarto-xref">Figure&nbsp;<span>7.29</span></a>, <a href="#fig-heatmap-paths-by-celltypes-z" class="quarto-xref">Figure&nbsp;<span>7.30</span></a>, <a href="#fig-heatmap-paths-by-domains-m" class="quarto-xref">Figure&nbsp;<span>7.31</span></a>, and <a href="#fig-heatmap-paths-by-domains-z" class="quarto-xref">Figure&nbsp;<span>7.32</span></a> reveals several findings in this tissue.</p>
<p>For example:</p>
<ul>
<li><p>In the tumor cells we see little enrichment of the pro-apoptotic TRAIL pathway (mean = 0.0; Z-score = -1.1) but high EGFR enrichment (mean = 2.6; Z-score = 3.7), a pattern associated with increased cell invasion and metastasis<span class="citation" data-cites="Sasaki2013"><sup><a href="references.html#ref-Sasaki2013" role="doc-biblioref">5</a></sup></span>.</p></li>
<li><p>Tumor cells are likely a “CMS4” or mesenchymal colon cancer phenotype. The three signatures of this phenotype are ‘prominent transforming growth factor–β activation, stromal invasion and angiogenesis’<span class="citation" data-cites="Guinney2015"><sup><a href="references.html#ref-Guinney2015" role="doc-biblioref">6</a></sup></span>. Looking at growth regulation, tumor cells themsevles show little enrichment of TGF-<span class="math inline">\(\beta\)</span> (mean = -2.3; Z-score = -0.85); however, the CAFs show the highest levels in the dataset (mean = 7.0; Z-score = 3.9). This pattern mirrors the TGF-<span class="math inline">\(\beta\)</span> exclusion phenotype described in the literature, where stromal activation drives poor prognosis in colon cancer<span class="citation" data-cites="Calon2015"><sup><a href="references.html#ref-Calon2015" role="doc-biblioref">7</a></sup></span> <span class="citation" data-cites="Ma2024"><sup><a href="references.html#ref-Ma2024" role="doc-biblioref">8</a></sup></span>. For stromal invasion, we can see from the spatial plots both at the cell type-level <a href="cell-typing.html#fig-xy-celltype-broad" class="quarto-xref">Figure&nbsp;<span>6.4</span></a> and the domain-level (<a href="cell-typing.html#fig-xy-domains" class="quarto-xref">Figure&nbsp;<span>6.8</span></a>) that CAFs and tumors are found in interdigitated domains. And finally, we found a signature of angiogenesis in tumor cells and tumor and stromal domains with the enrichment of VEGF<span class="citation" data-cites="Duffy2004"><sup><a href="references.html#ref-Duffy2004" role="doc-biblioref">9</a></sup></span>.</p></li>
<li><p>There is a strong enrichment of TNF-<span class="math inline">\(\alpha\)</span> and NF-<span class="math inline">\(\kappa\)</span>B on the left side of the tissue that is still unresolved. The left side of the tissue is part of the “Heterogeneous” spatial domain that is found throughout (<a href="spatial-domains.html" class="quarto-xref"><span>Chapter 5</span></a>) that contains a high proportion of undetermined cell types (<a href="cell-typing.html#fig-contingency-table" class="quarto-xref">Figure&nbsp;<span>6.7</span></a>). Perhaps a follow up analysis would include isolating the cells within this “sub-domain” to understand which cells might be driving the reduction of apoptosis and preventing an effective immune response. This could be done with lasso selecting the region (see our <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-rois/cosmx-rois.html" target="_blank">blog post on lasso selecting with napari</a>).</p></li>
</ul>
</section>
</section>
<section id="summary" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="summary"><span class="header-section-number">7.6</span> Summary</h2>
<p>In this chapter, we showed a simple nearest-neighbor smoothing technique and scored pathways using one of the available databases (PROGENy; for others see <code>decoupler.op.show_resources()</code>). Then we showed a few ways to pivot the data and visualize the local scores or global aggregates these scores across cell types and spatial domains to guide our inference.</p>


<!-- -->

<script type="ojs-module-contents">
eyJjb250ZW50cyI6W119
</script>
<div id="exercise-loading-indicator" class="exercise-loading-indicator d-none d-flex align-items-center gap-2">
<div id="exercise-loading-status" class="d-flex gap-2">

</div>
<div class="spinner-grow spinner-grow-sm">

</div>
</div>
<script type="vfs-file">
WyJhc3NldHMvTFIuc3ZnIl0=
</script>
<div id="refs" class="references csl-bib-body" data-entry-spacing="0" data-line-spacing="2" role="list" style="display: none">
<div id="ref-progeny" class="csl-entry" role="listitem">
<div class="csl-left-margin">1. </div><div class="csl-right-inline">Schubert, M. <em>et al.</em> Perturbation-response genes reveal signaling footprints in cancer gene expression. <em>Nature communications</em> <strong>9</strong>, (2018).</div>
</div>
<div id="ref-decoupler" class="csl-entry" role="listitem">
<div class="csl-left-margin">2. </div><div class="csl-right-inline">Badia-i-Mompel, P. <em>et al.</em> decoupleR: Ensemble of computational methods to infer biological activities from omics data. <em>Bioinformatics Advances</em> https://doi.org/<a href="https://doi.org/10.1093/bioadv/vbac016">https://doi.org/10.1093/bioadv/vbac016</a> (2022) doi:<a href="https://doi.org/10.1093/bioadv/vbac016">https://doi.org/10.1093/bioadv/vbac016</a>.</div>
</div>
<div id="ref-Dimitrov2022" class="csl-entry" role="listitem">
<div class="csl-left-margin">3. </div><div class="csl-right-inline">Dimitrov, D. <em>et al.</em> Comparison of methods and resources for cell-cell communication inference from single-cell <span>RNA-Seq</span> data. <em>Nat. Commun.</em> <strong>13</strong>, 3224 (2022).</div>
</div>
<div id="ref-Dimitrov2024" class="csl-entry" role="listitem">
<div class="csl-left-margin">4. </div><div class="csl-right-inline">Dimitrov, D. <em>et al.</em> <span>LIANA+</span> provides an all-in-one framework for cell-cell communication inference. <em>Nat. Cell Biol.</em> <strong>26</strong>, 1613–1622 (2024).</div>
</div>
<div id="ref-Sasaki2013" class="csl-entry" role="listitem">
<div class="csl-left-margin">5. </div><div class="csl-right-inline">Sasaki, T., Hiroki, K. &amp; Yamashita, Y. The role of epidermal growth factor receptor in cancer metastasis and microenvironment. <em>Biomed Res. Int.</em> <strong>2013</strong>, 546318 (2013).</div>
</div>
<div id="ref-Guinney2015" class="csl-entry" role="listitem">
<div class="csl-left-margin">6. </div><div class="csl-right-inline">Guinney, J. <em>et al.</em> The consensus molecular subtypes of colorectal cancer. <em>Nat. Med.</em> <strong>21</strong>, 1350–1356 (2015).</div>
</div>
<div id="ref-Calon2015" class="csl-entry" role="listitem">
<div class="csl-left-margin">7. </div><div class="csl-right-inline">Calon, A. <em>et al.</em> Stromal gene expression defines poor-prognosis subtypes in colorectal cancer. <em>Nat. Genet.</em> <strong>47</strong>, 320–329 (2015).</div>
</div>
<div id="ref-Ma2024" class="csl-entry" role="listitem">
<div class="csl-left-margin">8. </div><div class="csl-right-inline">Ma, M. <em>et al.</em> <a href="https://doi.org/10.1007/s10495-024-02063-z">Prognostic implications and therapeutic opportunities related to CAF subtypes in CMS4 colorectal cancer: Insights from single-cell and bulk transcriptomics</a>. <em>Apoptosis</em> <strong>30</strong>, 826–841 (2025).</div>
</div>
<div id="ref-Duffy2004" class="csl-entry" role="listitem">
<div class="csl-left-margin">9. </div><div class="csl-right-inline">Duffy, A. M., Bouchier-Hayes, D. J. &amp; Harmey, J. H. Vascular endothelial growth factor (<span>VEGF</span>) and its role in non-endothelial cells: Autocrine signalling by <span>VEGF</span>. in <em><span>VEGF</span> and cancer</em> 133–144 (Springer US, Boston, MA, 2004).</div>
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>To keep this primer clear and tractable, we’ll focus on a smaller pathway database at the single-cell level.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W119
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../..";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/nanostring-biostats\.github\.io\/CosMx-Analysis-Scratch-Space\/the-wtx-guide");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./cell-typing.html" class="pagination-link" aria-label="Cell Typing">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Cell Typing</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./conclusion.html" class="pagination-link" aria-label="Conclusion">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Conclusion</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">- name: Evelyn Metzger</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">  orcid: 0000-0002-4074-9003</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">  affiliations: </span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">  - ref: bsb</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - ref: eveilyeverafter</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">- name: Claire Williams</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">  orcid: 0000-0001-5467-149X</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">  affiliations:</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - ref: bsb</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - ref: crwilliams11</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: false</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: auto</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">  message: true</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="an">self-contained:</span><span class="co"> false</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="an">code-fold:</span><span class="co"> false</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="an">code-annotations:</span><span class="co"> hover</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="an">prefer-html:</span><span class="co"> true</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> live-html</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>{{&lt; include ./_extensions/r-wasm/live/_knitr.qmd &gt;}}</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="fu"># Pathways {#sec-pathways}</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: Preamble</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R code"</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./preamble.R"</span>)</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">source_python</span>(<span class="st">"./preamble.py"</span>)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>analysis_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"analysis_results"</span>)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>input_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"input_files"</span>)</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"output_files"</span>)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>analysis_asset_dir <span class="ot">&lt;-</span> <span class="st">"./assets/analysis_results"</span> <span class="co"># &lt;1&gt;</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>ct_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="st">"ct"</span>)</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>pw_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="st">"pathways"</span>)</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(pw_dir)){</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(pw_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>results_list_file <span class="ot">=</span> <span class="fu">file.path</span>(analysis_dir, <span class="st">"results_list.rds"</span>)</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(results_list_file)){</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(results_list, results_list_file)</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(results_list_file)  </span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a><span class="co"># results_list$run_explainer &lt;- TRUE </span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./helpers.R"</span>)</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ComplexHeatmap)</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(circlize)</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>In the previous chapters, we defined "who" is in the tissue (cell</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>types) and where they are located (spatial domains). The next logical step is to</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>ask: "what are they doing?". This is a particularly exciting and open-ended question. </span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>Since we have access to the whole transcriptome, we can measure biological activity</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>with unparalleled precision and down to the subcellular level, if desired.<span class="ot">[^1]</span> </span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a><span class="ot">[^1]: </span>To keep this primer clear and tractable, we'll focus on a smaller pathway database</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>at the single-cell level.</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>Pathway analysis allows us to move beyond simple</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>identity markers to infer the active biological processes driving the tissue's</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>organization. For example, identifying a cell as a "fibroblast" tells us its</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>lineage, but pathway analysis tells us if that fibroblast is actively building</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>scar tissue (TGF-$\beta$ signaling) or recruiting immune cells (NF-$\kappa$B</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>signaling).</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>While we can measure thousands of pathways from any number of databases, in this</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>primer we'll keep things tractable and estimate the activity of 14 cancer-relevant</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>signaling pathways using the PROGENy @progeny database (see below).</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>Here is our approach: </span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Smoothing: We will apply nearest neighbor smoothing to borrow</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>information from similar cells, overcoming the sparsity of single-cell data.</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Scoring: We will calculate an activity score for each</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>pathway in every single cell using the python package decoupler @decoupler.</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Inference: We will aggregate these scores by cell type and spatial domain to </span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>interpret signaling landscapes that define dominant biological programs and </span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>their spatial context within the tissue.</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>This workflow will allow us to answer questions like:</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Is the tumor driving angiogenesis, or is the stroma?</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Which immune cells are actively inflamed versus suppressed?</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Does the "Desmoplastic Stroma" domain have a distinct signaling signature?</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a><span class="fu">## Processing</span></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>Read the annData object.</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'adata'</span> <span class="kw">not</span> <span class="kw">in</span> <span class="bu">dir</span>():</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>  filename <span class="op">=</span> os.path.join(r.analysis_dir, <span class="st">"anndata-7-domain_annotations.h5ad"</span>)</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>  adata <span class="op">=</span> ad.read_h5ad(filename)</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">'spatial'</span>][:,<span class="dv">1</span>] <span class="op">*=</span> <span class="op">-</span><span class="dv">1</span> <span class="co"># &lt;1&gt;</span></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>flipping the y-axis so that the tissue is in the same orientation as the</span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>rest of the analysis.</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>We'll use the PROGENy (Pathway RespOnsive GENes) @progeny database available within decoupler @decoupler to estimate </span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>the single cell enrichment</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>scores of each of the 14 cancer-relevant pathways and their significant values.</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>PROGENy is a resource that estimates pathway activity by analyzing the downstream</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>genes known to change in response to perturbation experiments across a wide variety</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>of human cancer cell lines. I find that it is useful in a wide range of cancer samples</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>but it might not be ideal for, say, transplant or viral infection samples.</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>The code below adapts <span class="co">[</span><span class="ot">decoupler's tutorial</span><span class="co">](https://decoupler.readthedocs.io/en/latest/notebooks/scell/rna_pstime.html#progeny-pathway-genes)</span>{target="_blank"} which uses the <span class="co">[</span><span class="ot">univarte linear model method (ulm) function</span><span class="co">](https://decoupler.readthedocs.io/en/latest/api/generated/decoupler.mt.ulm.html)</span>{target="_blank"}. </span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>PROGENy can provide a high-level overview of the tissue's</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>molecular functions distilled down to a handful of pathways -- which is relatively</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>quick. For non-cancer systems, or if greater resolution is desired, other databases</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>can be used with the <span class="in">`ulm`</span> approach. If you are interested in exploring other </span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>databases within decoupler, run <span class="in">`decoupler.op.show_resources()`</span>.</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>Here's a description of those pathways from decoupler's website. </span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a><span class="in">- Androgen: involved in the growth and development of the male reproductive organs.</span></span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a><span class="in">- EGFR: regulates growth, survival, migration, apoptosis, proliferation, and differentiation in mammalian cells</span></span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a><span class="in">- Estrogen: promotes the growth and development of the female reproductive organs.</span></span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a><span class="in">- Hypoxia: promotes angiogenesis and metabolic reprogramming when O2 levels are low.</span></span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a><span class="in">- JAK-STAT: involved in immunity, cell division, cell death, and tumor formation.</span></span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a><span class="in">- MAPK: integrates external signals and promotes cell growth and proliferation.</span></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a><span class="in">- NFkB: regulates immune response, cytokine production and cell survival.</span></span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a><span class="in">- p53: regulates cell cycle, apoptosis, DNA repair and tumor suppression.</span></span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a><span class="in">- PI3K: promotes growth and proliferation.</span></span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a><span class="in">- TGFb: involved in development, homeostasis, and repair of most tissues.</span></span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a><span class="in">- TNFa: mediates haematopoiesis, immune surveillance, tumour regression and protection from infection.</span></span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a><span class="in">- Trail: induces apoptosis.</span></span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a><span class="in">- VEGF: mediates angiogenesis, vascular permeability, and cell migration.</span></span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a><span class="in">- WNT: regulates organ morphogenesis during development and tissue repair.</span></span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>Let's load the PROGENy dataset.</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-progeny</span></span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> decoupler <span class="im">as</span> dc</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>progeny <span class="op">=</span> dc.op.progeny(organism<span class="op">=</span><span class="st">'human'</span>, top<span class="op">=</span><span class="dv">500</span>, license<span class="op">=</span><span class="st">"commercial"</span>)</span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>progeny_genes <span class="op">=</span> progeny[<span class="st">'target'</span>].unique()</span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>results_list[<span class="st">'n_progeny_genes'</span>] <span class="ot">=</span> <span class="fu">length</span>(py<span class="sc">$</span>progeny_genes)</span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(results_list, results_list_file)</span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>For the analysis below we'll need normalized data. As we saw in @sec-preprocessing,</span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>we bypassed the creation of the dense Pearson Residuals normalization matrix</span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>and used the PCs instead for nearest neighbors calculations, Leiden, _etc_. </span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>The main reason for this was computational tractability (&gt;400,000 cells by _ca_. 19,000 targets). </span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>That issue is still present here. There are only <span class="in">`r as.numeric(results_list['n_progeny_genes'])`</span> genes</span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>in the pathway database that we chose and so we do not necessarily need to normalized</span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>the entire matrix. Scanpy has a method for Pearson Residuals normalization </span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>(<span class="in">`sc.experimental.pp.normalize_pearson_residuals`</span>) but there's a catch: ideally we</span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>would _not_ run Pearson Normalization on a subset of features. Instead, we would like</span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>the non-truncated transcript totals to factor into the normalization procedure. </span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>We can achieve this by creating a custom code.</span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: normalize</span></span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Get valid genes</span></span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a><span class="co"># these are the ones that are in BOTH the progeny dataset and in the anndata, adata</span></span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a>valid_genes <span class="op">=</span> [g <span class="cf">for</span> g <span class="kw">in</span> progeny_genes <span class="cf">if</span> g <span class="kw">in</span> adata.var_names]</span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Get GLOBAL Stats (before subsetting)</span></span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a>counts_layer <span class="op">=</span> adata.layers[<span class="st">'counts'</span>] <span class="cf">if</span> <span class="st">'counts'</span> <span class="kw">in</span> adata.layers <span class="cf">else</span> adata.X</span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a>global_cell_sums <span class="op">=</span> np.array(counts_layer.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)).flatten() <span class="co"># or just from nCount_RNA</span></span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>total_count <span class="op">=</span> global_cell_sums.<span class="bu">sum</span>() <span class="co"># i.e., sum(obs$nCount_RNA)</span></span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Get GENE Stats (Just for the subset is all that's necessary)</span></span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a>gene_indices <span class="op">=</span> [adata.var_names.get_loc(g) <span class="cf">for</span> g <span class="kw">in</span> valid_genes]</span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a>subset_gene_sums <span class="op">=</span> np.array(counts_layer.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)).flatten()[gene_indices]</span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Create the Subset</span></span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a>adata_sub <span class="op">=</span> adata[:, valid_genes].copy()</span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure we are using raw counts for the calculation</span></span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'counts'</span> <span class="kw">in</span> adata_sub.layers:</span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a>    adata_sub.X <span class="op">=</span> adata_sub.layers[<span class="st">'counts'</span>].copy()</span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Expected counts based on global depth (from the full dataset)</span></span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> np.outer(global_cell_sums, subset_gene_sums) <span class="op">/</span> total_count</span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a><span class="co"># Pearson Residuals: (Observed - Expected) / StdDev</span></span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a>observed <span class="op">=</span> adata_sub.X.toarray()</span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a>residuals <span class="op">=</span> (observed <span class="op">-</span> mu) <span class="op">/</span> np.sqrt(mu <span class="op">+</span> mu<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> theta)</span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Clip outliers (similar to what scanpy does)</span></span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a>clip_val <span class="op">=</span> np.sqrt(adata_sub.shape[<span class="dv">0</span>])</span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true" tabindex="-1"></a>residuals <span class="op">=</span> np.clip(residuals, <span class="op">-</span>clip_val, clip_val)</span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Save results</span></span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true" tabindex="-1"></a>adata_sub.X <span class="op">=</span> residuals</span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> adata</span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata_sub </span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up</span></span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gc</span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> adata_sub, mu, observed, residuals, global_cell_sums, subset_gene_sums</span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true" tabindex="-1"></a>gc.collect()</span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true" tabindex="-1"></a>At this point the anndata object has many components that are not needed. </span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true" tabindex="-1"></a>Let's reduce the size of this object to reduce the memory footprint. </span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: trim</span></span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up obsm</span></span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true" tabindex="-1"></a>obsm_delete <span class="op">=</span> [<span class="st">'X_pca_TC'</span>, <span class="st">'counts_neg'</span>, <span class="st">'counts_sys'</span>, <span class="st">'umap_TC'</span>]</span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> obsm_delete:</span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="kw">in</span> adata.obsm:</span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> adata.obsm[x]</span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up obsp</span></span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true" tabindex="-1"></a>obsp_delete <span class="op">=</span> [<span class="st">'neighbors_TC_connectivities'</span>, <span class="st">'neighbors_TC_distances'</span>]</span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> obsp_delete:</span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="kw">in</span> adata.obsp:</span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> adata.obsp[x]</span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true" tabindex="-1"></a>gc.collect()</span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">'pr_norm'</span>] <span class="op">=</span> adata.X.astype(<span class="st">'float32'</span>).copy() <span class="co"># &lt;1&gt;</span></span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Convert from float 64 bit to float 32 bit Optional step for systems with less RAM.</span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true" tabindex="-1"></a><span class="fu">## Smoothing Expression</span></span>
<span id="cb9-285"><a href="#cb9-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-286"><a href="#cb9-286" aria-hidden="true" tabindex="-1"></a>One attribute of all spatial single cell datasets relative to non-spatial method</span>
<span id="cb9-287"><a href="#cb9-287" aria-hidden="true" tabindex="-1"></a>is sparsity. Even for technologies with high-sensitivity detection, individual cells</span>
<span id="cb9-288"><a href="#cb9-288" aria-hidden="true" tabindex="-1"></a>may lack the detection of every transcript required to precisely score pathways.</span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true" tabindex="-1"></a>To overcome this, tools like decoupler and liana @Dimitrov2022 @Dimitrov2024 utilize _smoothing_ -- a </span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a>process of borrowing information from neighboring cells to impute missing values</span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true" tabindex="-1"></a>and stabilize pathway scores. However, the term "neighbor" here can be ambiguous. </span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true" tabindex="-1"></a>Many of the existing tutorials for these tools were developed with spot-based</span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true" tabindex="-1"></a>technologies (like Visium) in mind where _spatial smoothing_ is used because spots</span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a>are already multi-cellular mixtures. For single-cell resolution data like CosMx</span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true" tabindex="-1"></a>SMI, the choice of using spatial smoothing depends on the types of biological </span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true" tabindex="-1"></a>questions you have @tbl-smoothing-choices. For pathway analysis, we recommend smoothing</span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true" tabindex="-1"></a>based on nearest expression neighbors (NN). Check back later when we release a</span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true" tabindex="-1"></a>chapter on ligand-receptor analysis for an example of spatial smoothing.</span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Feature <span class="pp">|</span> Nearest Expression Neighbors (NN) <span class="pp">|</span> Spatial Neighbors (SN) <span class="pp">|</span></span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true" tabindex="-1"></a><span class="pp">| :---</span> <span class="pp">| :---</span> <span class="pp">| :---</span> <span class="pp">|</span></span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Definition** <span class="pp">|</span> Averages signal from cells with similar gene expression profiles (_e.g._, neighbors in PCA space). <span class="pp">|</span> Averages signal from cells physically touching or near the target cell (XY space). <span class="pp">|</span></span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Primary Benefit** | **Preserves Cell Identity.** A T cell is smoothed with other T cells, maintaining lineage-specific signals. | **Visualizes Zones.** Highlights continuous tissue gradients and regional (_i.e._, multiple domain) behaviors. **Analyzing Larger Spatial Patterns** When examining zonal, regional (_e.g._, hypoxia), or other larger effects, cells are responding by an interaction of their lineage and their spatial position. Spatial smoothing in this scenario can aid in quantifying the metabolic spatial neighborhood by denoising cells with sparse data. **Ligand Receptor Analysis.** While we might not want to spatially smooth a CD4 T cell with, say, a Tumor cell, for certain analyses, this computational approach can be effective in analyzing <span class="co">[</span><span class="ot">ligand-receptor relationships</span><span class="co">](https://liana-py.readthedocs.io/en/latest/notebooks/bivariate.html#bivariate-ligand-receptor-relationships)</span>. Essentially, if we borrow the receptor expression of nearby cells, we can then test if that receptor is correlated with the focal cells' corresponding ligand receptor expression. <span class="pp">|</span></span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Drawback** | May erode any cell type by specific local/regional interaction effect. | **Signal Bleeding** Can artificially blend high-expression markers (e.g., *PTPRC*) into neighboring negative cells (e.g., Tumor). **Tuning** The degree (_e.g._, radius, Gaussian kernel) that is used for spatial smoothing is a tuning parameter that, ideally, should align the observational scale with the functional scale. <span class="pp">|</span></span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Best Use Case** <span class="pp">|</span> Lineage-specific pathways (e.g., TCR signaling, Cell Cycle, B cell activation). <span class="pp">|</span> Environmental gradients that occur at regional levels not captured by expression-based domain assignments (e.g., Hypoxia, Nutrient Deprivation, pH levels). <span class="pp">|</span></span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Example** <span class="pp">|</span> See @sec-path-enrichment below <span class="pp">|</span> See upcoming ligand-receptor chapter (expected early 2026) <span class="pp">|</span></span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true" tabindex="-1"></a>: Two types of smoothing and when to use them. {#tbl-smoothing-choices}</span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true" tabindex="-1"></a>Let's apply nearest neighbor smoothing.</span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true" tabindex="-1"></a>Recall in @sec-preprocessing we created a neighbor graph based on pearson residuals PC</span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true" tabindex="-1"></a>values derived using the scPearsonPCA package. This produced the <span class="in">`neighbors_pr_connectivities`</span></span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true" tabindex="-1"></a>connectivity matrix in <span class="in">`obsp`</span>. We'll use this to smooth our cells' expression. </span>
<span id="cb9-314"><a href="#cb9-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-317"><a href="#cb9-317" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-318"><a href="#cb9-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-319"><a href="#cb9-319" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb9-320"><a href="#cb9-320" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb9-321"><a href="#cb9-321" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb9-322"><a href="#cb9-322" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb9-323"><a href="#cb9-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-324"><a href="#cb9-324" aria-hidden="true" tabindex="-1"></a>adata.layers[<span class="st">'nn_smooth'</span>] <span class="op">=</span> adata.obsp[<span class="st">'neighbors_pr_connectivities'</span>] <span class="op">@</span> adata.layers[<span class="st">'pr_norm'</span>]</span>
<span id="cb9-325"><a href="#cb9-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-326"><a href="#cb9-326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-327"><a href="#cb9-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-328"><a href="#cb9-328" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pathway Enrichment {#sec-path-enrichment}</span></span>
<span id="cb9-329"><a href="#cb9-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-330"><a href="#cb9-330" aria-hidden="true" tabindex="-1"></a>Run the univariate linear model from <span class="in">`decoupler`</span> using </span>
<span id="cb9-331"><a href="#cb9-331" aria-hidden="true" tabindex="-1"></a>the PROGENy database with this smoothed expression matrix to generate pathway </span>
<span id="cb9-332"><a href="#cb9-332" aria-hidden="true" tabindex="-1"></a>scores. Save the results.</span>
<span id="cb9-333"><a href="#cb9-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-336"><a href="#cb9-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-337"><a href="#cb9-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: nn-run-ulm</span></span>
<span id="cb9-338"><a href="#cb9-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-339"><a href="#cb9-339" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb9-340"><a href="#cb9-340" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb9-341"><a href="#cb9-341" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb9-342"><a href="#cb9-342" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb9-343"><a href="#cb9-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-344"><a href="#cb9-344" aria-hidden="true" tabindex="-1"></a>dc.mt.ulm(</span>
<span id="cb9-345"><a href="#cb9-345" aria-hidden="true" tabindex="-1"></a>  data<span class="op">=</span>adata, </span>
<span id="cb9-346"><a href="#cb9-346" aria-hidden="true" tabindex="-1"></a>  net<span class="op">=</span>progeny, </span>
<span id="cb9-347"><a href="#cb9-347" aria-hidden="true" tabindex="-1"></a>  verbose<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb9-348"><a href="#cb9-348" aria-hidden="true" tabindex="-1"></a>  layer<span class="op">=</span><span class="ss">f'nn_smooth'</span>,</span>
<span id="cb9-349"><a href="#cb9-349" aria-hidden="true" tabindex="-1"></a>  bsize<span class="op">=</span><span class="dv">80000</span></span>
<span id="cb9-350"><a href="#cb9-350" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-351"><a href="#cb9-351" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-352"><a href="#cb9-352" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> os.path.join(r.analysis_dir, <span class="st">"anndata-8-pathways-nn.h5ad"</span>)</span>
<span id="cb9-353"><a href="#cb9-353" aria-hidden="true" tabindex="-1"></a>adata.write_h5ad(</span>
<span id="cb9-354"><a href="#cb9-354" aria-hidden="true" tabindex="-1"></a>  filename,</span>
<span id="cb9-355"><a href="#cb9-355" aria-hidden="true" tabindex="-1"></a>  compression<span class="op">=</span>hdf5plugin.FILTERS[<span class="st">"zstd"</span>],</span>
<span id="cb9-356"><a href="#cb9-356" aria-hidden="true" tabindex="-1"></a>  compression_opts<span class="op">=</span>hdf5plugin.Zstd(clevel<span class="op">=</span><span class="dv">5</span>).filter_options</span>
<span id="cb9-357"><a href="#cb9-357" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-358"><a href="#cb9-358" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-359"><a href="#cb9-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-360"><a href="#cb9-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-361"><a href="#cb9-361" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visualizing Pathway Enrichment</span></span>
<span id="cb9-362"><a href="#cb9-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-363"><a href="#cb9-363" aria-hidden="true" tabindex="-1"></a>We'll visualize the pathways "locally" on the tissue as well as "globally" by creating</span>
<span id="cb9-364"><a href="#cb9-364" aria-hidden="true" tabindex="-1"></a>heatmaps per cell type and domain.</span>
<span id="cb9-365"><a href="#cb9-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-366"><a href="#cb9-366" aria-hidden="true" tabindex="-1"></a><span class="fu">### Local: spatial visualizations {#sec-local-path-plots}</span></span>
<span id="cb9-367"><a href="#cb9-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-368"><a href="#cb9-368" aria-hidden="true" tabindex="-1"></a>The local plots provide fine-resolution maps of pathway scores on the tissue. </span>
<span id="cb9-369"><a href="#cb9-369" aria-hidden="true" tabindex="-1"></a>The simplest way to do this is to use scanpy's <span class="in">`pl.spatial`</span> method. If you want</span>
<span id="cb9-370"><a href="#cb9-370" aria-hidden="true" tabindex="-1"></a>greater flexibility in the plotting aesthetics, we can use the <span class="in">`plotDots`</span> function</span>
<span id="cb9-371"><a href="#cb9-371" aria-hidden="true" tabindex="-1"></a>in R that we have used throughout this book. Below we'll show code and results</span>
<span id="cb9-372"><a href="#cb9-372" aria-hidden="true" tabindex="-1"></a>for both approaches. </span>
<span id="cb9-373"><a href="#cb9-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-374"><a href="#cb9-374" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb9-375"><a href="#cb9-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-376"><a href="#cb9-376" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Using Scanpy's built-in spatial plotting function</span></span>
<span id="cb9-377"><a href="#cb9-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-378"><a href="#cb9-378" aria-hidden="true" tabindex="-1"></a>We can convert the scores themselves into a new annData object and then use</span>
<span id="cb9-379"><a href="#cb9-379" aria-hidden="true" tabindex="-1"></a>scanpy's functions to plot the individual pathways (features).</span>
<span id="cb9-380"><a href="#cb9-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-383"><a href="#cb9-383" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-384"><a href="#cb9-384" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: nn-scanp-basic-plots</span></span>
<span id="cb9-385"><a href="#cb9-385" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-386"><a href="#cb9-386" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Python Code"</span></span>
<span id="cb9-387"><a href="#cb9-387" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb9-388"><a href="#cb9-388" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb9-389"><a href="#cb9-389" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-390"><a href="#cb9-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-391"><a href="#cb9-391" aria-hidden="true" tabindex="-1"></a>sc.settings.figdir <span class="op">=</span> r.pw_dir</span>
<span id="cb9-392"><a href="#cb9-392" aria-hidden="true" tabindex="-1"></a>sc.settings.set_figure_params(dpi_save<span class="op">=</span><span class="dv">200</span>, frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-393"><a href="#cb9-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-394"><a href="#cb9-394" aria-hidden="true" tabindex="-1"></a>nn_pwdata <span class="op">=</span> dc.pp.get_obsm(adata<span class="op">=</span>adata, key<span class="op">=</span><span class="ss">f'score_ulm'</span>)</span>
<span id="cb9-395"><a href="#cb9-395" aria-hidden="true" tabindex="-1"></a>nn_pwdata.obsm[<span class="ss">f'padj_ulm'</span>] <span class="op">=</span> adata.obsm[<span class="ss">f'padj_ulm'</span>]</span>
<span id="cb9-396"><a href="#cb9-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-397"><a href="#cb9-397" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> nn_pwdata.var_names:</span>
<span id="cb9-398"><a href="#cb9-398" aria-hidden="true" tabindex="-1"></a>  sc.pl.spatial(</span>
<span id="cb9-399"><a href="#cb9-399" aria-hidden="true" tabindex="-1"></a>      nn_pwdata,</span>
<span id="cb9-400"><a href="#cb9-400" aria-hidden="true" tabindex="-1"></a>      color<span class="op">=</span>[x],</span>
<span id="cb9-401"><a href="#cb9-401" aria-hidden="true" tabindex="-1"></a>      cmap<span class="op">=</span><span class="st">'RdBu_r'</span>,</span>
<span id="cb9-402"><a href="#cb9-402" aria-hidden="true" tabindex="-1"></a>      vcenter<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb9-403"><a href="#cb9-403" aria-hidden="true" tabindex="-1"></a>      size<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb9-404"><a href="#cb9-404" aria-hidden="true" tabindex="-1"></a>      spot_size<span class="op">=</span><span class="fl">0.01</span>, show<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-405"><a href="#cb9-405" aria-hidden="true" tabindex="-1"></a>      save<span class="op">=</span><span class="st">"_nn_pathway_Scanpy_"</span> <span class="op">+</span> <span class="bu">str</span>(x) <span class="op">+</span> <span class="st">"_xy.png"</span>,</span>
<span id="cb9-406"><a href="#cb9-406" aria-hidden="true" tabindex="-1"></a>      alpha_img<span class="op">=</span><span class="dv">1</span></span>
<span id="cb9-407"><a href="#cb9-407" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-408"><a href="#cb9-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-409"><a href="#cb9-409" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-410"><a href="#cb9-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-411"><a href="#cb9-411" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb9-412"><a href="#cb9-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-415"><a href="#cb9-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-416"><a href="#cb9-416" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: asis</span></span>
<span id="cb9-417"><a href="#cb9-417" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb9-418"><a href="#cb9-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-419"><a href="#cb9-419" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">Sys.glob</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"show_nn_pathway_Scanpy_*.png"</span>))</span>
<span id="cb9-420"><a href="#cb9-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-421"><a href="#cb9-421" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_chr</span>(files, \(a_file) {</span>
<span id="cb9-422"><a href="#cb9-422" aria-hidden="true" tabindex="-1"></a>    path <span class="ot">=</span> <span class="fu">gsub</span>(<span class="st">'_xy.png'</span>, <span class="st">''</span>, <span class="fu">strsplit</span>(<span class="fu">basename</span>(a_file), <span class="at">split=</span><span class="st">'show_nn_pathway_Scanpy_'</span>)[[<span class="dv">1</span>]][<span class="dv">2</span>])</span>
<span id="cb9-423"><a href="#cb9-423" aria-hidden="true" tabindex="-1"></a>    label <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">'Path: '</span>, path)</span>
<span id="cb9-424"><a href="#cb9-424" aria-hidden="true" tabindex="-1"></a>    fig_label <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">'#| label: fig-'</span>, <span class="fu">gsub</span>(<span class="st">": "</span>, <span class="st">"-"</span>, label), <span class="st">'-scanpy'</span>)</span>
<span id="cb9-425"><a href="#cb9-425" aria-hidden="true" tabindex="-1"></a>    fig_cap <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">'#| fig-cap: </span><span class="sc">\"</span><span class="st">Local '</span>, path ,<span class="st">' pathway scores plotted with sc.pl.spatial.</span><span class="sc">\"</span><span class="st">'</span>)</span>
<span id="cb9-426"><a href="#cb9-426" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">knit_child</span>(<span class="at">text =</span> <span class="fu">c</span>(</span>
<span id="cb9-427"><a href="#cb9-427" aria-hidden="true" tabindex="-1"></a>      <span class="st">"##### `r paste0('Path: ', gsub('_xy.png', '', strsplit(basename(a_file), split='show_nn_pathway_Scanpy_')[[1]][2]))`"</span>,</span>
<span id="cb9-428"><a href="#cb9-428" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb9-429"><a href="#cb9-429" aria-hidden="true" tabindex="-1"></a>      <span class="st">"```{r eval=TRUE}"</span>,</span>
<span id="cb9-430"><a href="#cb9-430" aria-hidden="true" tabindex="-1"></a>      <span class="st">"#| echo: false"</span>,</span>
<span id="cb9-431"><a href="#cb9-431" aria-hidden="true" tabindex="-1"></a>      fig_label,</span>
<span id="cb9-432"><a href="#cb9-432" aria-hidden="true" tabindex="-1"></a>      fig_cap,</span>
<span id="cb9-433"><a href="#cb9-433" aria-hidden="true" tabindex="-1"></a>      <span class="st">"render(file.path(analysis_asset_dir, 'pathways'), basename(a_file), pw_dir, overwrite=TRUE)"</span>,</span>
<span id="cb9-434"><a href="#cb9-434" aria-hidden="true" tabindex="-1"></a>      <span class="st">"```"</span>,</span>
<span id="cb9-435"><a href="#cb9-435" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb9-436"><a href="#cb9-436" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span></span>
<span id="cb9-437"><a href="#cb9-437" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">envir =</span> <span class="fu">environment</span>(), <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-438"><a href="#cb9-438" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb9-439"><a href="#cb9-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-440"><a href="#cb9-440" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(res, <span class="at">sep =</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb9-441"><a href="#cb9-441" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-442"><a href="#cb9-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-443"><a href="#cb9-443" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb9-444"><a href="#cb9-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-445"><a href="#cb9-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-446"><a href="#cb9-446" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Using `plotDots` in R</span></span>
<span id="cb9-447"><a href="#cb9-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-448"><a href="#cb9-448" aria-hidden="true" tabindex="-1"></a>This block runs the <span class="in">`plotDots`</span> function that we have used in previous chapters</span>
<span id="cb9-449"><a href="#cb9-449" aria-hidden="true" tabindex="-1"></a>on the objects that we create in the previous subsection, <span class="in">`nn_pwdata`</span>.</span>
<span id="cb9-450"><a href="#cb9-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-453"><a href="#cb9-453" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-454"><a href="#cb9-454" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plotDots-visuals</span></span>
<span id="cb9-455"><a href="#cb9-455" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-456"><a href="#cb9-456" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb9-457"><a href="#cb9-457" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb9-458"><a href="#cb9-458" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb9-459"><a href="#cb9-459" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-460"><a href="#cb9-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-461"><a href="#cb9-461" aria-hidden="true" tabindex="-1"></a>py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>obsm[<span class="st">'spatial'</span>][,<span class="dv">2</span>] <span class="ot">&lt;-</span> py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>obsm[<span class="st">'spatial'</span>][,<span class="dv">2</span>] <span class="sc">*</span> <span class="sc">-</span><span class="dv">1</span> <span class="co"># &lt;1&gt;</span></span>
<span id="cb9-462"><a href="#cb9-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-463"><a href="#cb9-463" aria-hidden="true" tabindex="-1"></a>features <span class="ot">&lt;-</span> py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>var_names<span class="sc">$</span><span class="fu">to_list</span>()</span>
<span id="cb9-464"><a href="#cb9-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-465"><a href="#cb9-465" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(feature <span class="cf">in</span> features){</span>
<span id="cb9-466"><a href="#cb9-466" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plotDots</span>(py<span class="sc">$</span>nn_pwdata, <span class="at">color_by=</span>feature,</span>
<span id="cb9-467"><a href="#cb9-467" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot_global =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-468"><a href="#cb9-468" aria-hidden="true" tabindex="-1"></a>              <span class="at">facet_by_group =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-469"><a href="#cb9-469" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_plot_parameters =</span> <span class="fu">list</span>(</span>
<span id="cb9-470"><a href="#cb9-470" aria-hidden="true" tabindex="-1"></a>                  <span class="at">geom_point_params =</span> <span class="fu">list</span>(</span>
<span id="cb9-471"><a href="#cb9-471" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size=</span><span class="fl">0.001</span></span>
<span id="cb9-472"><a href="#cb9-472" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb9-473"><a href="#cb9-473" aria-hidden="true" tabindex="-1"></a>                  <span class="at">scale_bar_params =</span> <span class="fu">list</span>(</span>
<span id="cb9-474"><a href="#cb9-474" aria-hidden="true" tabindex="-1"></a>                    <span class="at">location =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">0</span>),</span>
<span id="cb9-475"><a href="#cb9-475" aria-hidden="true" tabindex="-1"></a>                    <span class="at">width =</span> <span class="dv">2</span>,</span>
<span id="cb9-476"><a href="#cb9-476" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n =</span> <span class="dv">3</span>,</span>
<span id="cb9-477"><a href="#cb9-477" aria-hidden="true" tabindex="-1"></a>                    <span class="at">height =</span> <span class="fl">0.1</span>,</span>
<span id="cb9-478"><a href="#cb9-478" aria-hidden="true" tabindex="-1"></a>                    <span class="at">scale_colors =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"grey30"</span>),</span>
<span id="cb9-479"><a href="#cb9-479" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label_nudge_y =</span> <span class="sc">-</span><span class="fl">0.3</span></span>
<span id="cb9-480"><a href="#cb9-480" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb9-481"><a href="#cb9-481" aria-hidden="true" tabindex="-1"></a>                  <span class="at">directory =</span> pw_dir,</span>
<span id="cb9-482"><a href="#cb9-482" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fileType =</span> <span class="st">"png"</span>,</span>
<span id="cb9-483"><a href="#cb9-483" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dpi =</span> <span class="dv">200</span>,</span>
<span id="cb9-484"><a href="#cb9-484" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> <span class="dv">8</span>, </span>
<span id="cb9-485"><a href="#cb9-485" aria-hidden="true" tabindex="-1"></a>                  <span class="at">height =</span> <span class="dv">8</span>,</span>
<span id="cb9-486"><a href="#cb9-486" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prefix=</span><span class="fu">paste0</span>(<span class="st">"plotDots_"</span>, feature)</span>
<span id="cb9-487"><a href="#cb9-487" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb9-488"><a href="#cb9-488" aria-hidden="true" tabindex="-1"></a>              <span class="at">additional_ggplot_layers =</span> <span class="fu">list</span>(</span>
<span id="cb9-489"><a href="#cb9-489" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_bw</span>(), </span>
<span id="cb9-490"><a href="#cb9-490" aria-hidden="true" tabindex="-1"></a>                <span class="fu">scale_color_gradient2</span>(<span class="at">low =</span> <span class="st">"darkblue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"darkred"</span>, <span class="at">midpoint =</span> <span class="dv">0</span>),</span>
<span id="cb9-491"><a href="#cb9-491" aria-hidden="true" tabindex="-1"></a>                <span class="fu">xlab</span>(<span class="st">"X (mm)"</span>),</span>
<span id="cb9-492"><a href="#cb9-492" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ylab</span>(<span class="st">"Y (mm)"</span>), </span>
<span id="cb9-493"><a href="#cb9-493" aria-hidden="true" tabindex="-1"></a>                <span class="fu">coord_fixed</span>(),</span>
<span id="cb9-494"><a href="#cb9-494" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.4</span>))</span>
<span id="cb9-495"><a href="#cb9-495" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb9-496"><a href="#cb9-496" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb9-497"><a href="#cb9-497" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-498"><a href="#cb9-498" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-499"><a href="#cb9-499" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Flipping the y-axis back.</span>
<span id="cb9-500"><a href="#cb9-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-501"><a href="#cb9-501" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb9-502"><a href="#cb9-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-505"><a href="#cb9-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-506"><a href="#cb9-506" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: asis</span></span>
<span id="cb9-507"><a href="#cb9-507" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb9-508"><a href="#cb9-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-509"><a href="#cb9-509" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">Sys.glob</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"plotDots_*__spatial__*.png"</span>))</span>
<span id="cb9-510"><a href="#cb9-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-511"><a href="#cb9-511" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_chr</span>(files, \(a_file) {</span>
<span id="cb9-512"><a href="#cb9-512" aria-hidden="true" tabindex="-1"></a>  path <span class="ot">=</span> <span class="fu">gsub</span>(<span class="st">'plotDots_'</span>, <span class="st">''</span>, <span class="fu">strsplit</span>(<span class="fu">basename</span>(a_file), <span class="at">split=</span><span class="st">'__'</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>])</span>
<span id="cb9-513"><a href="#cb9-513" aria-hidden="true" tabindex="-1"></a>  label <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">'Path: '</span>, path)</span>
<span id="cb9-514"><a href="#cb9-514" aria-hidden="true" tabindex="-1"></a>  fig_label <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">'#| label: fig-'</span>, <span class="fu">gsub</span>(<span class="st">": "</span>, <span class="st">"-"</span>, label))</span>
<span id="cb9-515"><a href="#cb9-515" aria-hidden="true" tabindex="-1"></a>  fig_cap <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">'#| fig-cap: </span><span class="sc">\"</span><span class="st">Local '</span>, path ,<span class="st">' pathway scores plotted with the plotDots function.</span><span class="sc">\"</span><span class="st">'</span>)</span>
<span id="cb9-516"><a href="#cb9-516" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">knit_child</span>(<span class="at">text =</span> <span class="fu">c</span>(</span>
<span id="cb9-517"><a href="#cb9-517" aria-hidden="true" tabindex="-1"></a>      <span class="st">"##### `r paste0('Path: ', gsub('plotDots_', '', strsplit(basename(a_file), split='__')[[1]][1]))`"</span>,</span>
<span id="cb9-518"><a href="#cb9-518" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb9-519"><a href="#cb9-519" aria-hidden="true" tabindex="-1"></a>      <span class="st">"```{r eval=TRUE}"</span>,</span>
<span id="cb9-520"><a href="#cb9-520" aria-hidden="true" tabindex="-1"></a>      <span class="st">"#| echo: false"</span>,</span>
<span id="cb9-521"><a href="#cb9-521" aria-hidden="true" tabindex="-1"></a>      fig_label,</span>
<span id="cb9-522"><a href="#cb9-522" aria-hidden="true" tabindex="-1"></a>      fig_cap,</span>
<span id="cb9-523"><a href="#cb9-523" aria-hidden="true" tabindex="-1"></a>      <span class="st">"render(file.path(analysis_asset_dir, 'pathways'), basename(a_file), pw_dir, overwrite=TRUE)"</span>,</span>
<span id="cb9-524"><a href="#cb9-524" aria-hidden="true" tabindex="-1"></a>      <span class="st">"```"</span>,</span>
<span id="cb9-525"><a href="#cb9-525" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span>,</span>
<span id="cb9-526"><a href="#cb9-526" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span></span>
<span id="cb9-527"><a href="#cb9-527" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">envir =</span> <span class="fu">environment</span>(), <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-528"><a href="#cb9-528" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb9-529"><a href="#cb9-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-530"><a href="#cb9-530" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(res, <span class="at">sep =</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb9-531"><a href="#cb9-531" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-532"><a href="#cb9-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-533"><a href="#cb9-533" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb9-534"><a href="#cb9-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-535"><a href="#cb9-535" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb9-536"><a href="#cb9-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-537"><a href="#cb9-537" aria-hidden="true" tabindex="-1"></a><span class="fu">### Global: Per Cell Type</span></span>
<span id="cb9-538"><a href="#cb9-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-539"><a href="#cb9-539" aria-hidden="true" tabindex="-1"></a>In addition to plotting the local pathway scores in space with scanpy or <span class="in">`plotDots`</span>,</span>
<span id="cb9-540"><a href="#cb9-540" aria-hidden="true" tabindex="-1"></a>we can visualize the results summarized across each cell type or each domain. </span>
<span id="cb9-541"><a href="#cb9-541" aria-hidden="true" tabindex="-1"></a>These next two subsections do just that. We'll</span>
<span id="cb9-542"><a href="#cb9-542" aria-hidden="true" tabindex="-1"></a>use the plotting functionality within the <span class="in">`complexHeatmap`</span> R package. It can be</span>
<span id="cb9-543"><a href="#cb9-543" aria-hidden="true" tabindex="-1"></a>helpful to plot the average enrichment as well as the Z-scores. The former helps</span>
<span id="cb9-544"><a href="#cb9-544" aria-hidden="true" tabindex="-1"></a>with us understand the overall sense of what is being enriched whereas the latter</span>
<span id="cb9-545"><a href="#cb9-545" aria-hidden="true" tabindex="-1"></a>helps to compare a particular effect size relative to other cell types. </span>
<span id="cb9-546"><a href="#cb9-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-549"><a href="#cb9-549" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-550"><a href="#cb9-550" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: celltype-summary</span></span>
<span id="cb9-551"><a href="#cb9-551" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-552"><a href="#cb9-552" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb9-553"><a href="#cb9-553" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb9-554"><a href="#cb9-554" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb9-555"><a href="#cb9-555" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-556"><a href="#cb9-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-557"><a href="#cb9-557" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>obs <span class="sc">%&gt;%</span> <span class="fu">select</span>(cell_ID, celltype_broad, celltype_fine)</span>
<span id="cb9-558"><a href="#cb9-558" aria-hidden="true" tabindex="-1"></a>expr <span class="ot">&lt;-</span> py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>X</span>
<span id="cb9-559"><a href="#cb9-559" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(expr) <span class="ot">&lt;-</span> py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>var_names<span class="sc">$</span><span class="fu">to_list</span>()</span>
<span id="cb9-560"><a href="#cb9-560" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(df, expr)</span>
<span id="cb9-561"><a href="#cb9-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-562"><a href="#cb9-562" aria-hidden="true" tabindex="-1"></a>pathway_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(df), <span class="fu">c</span>(<span class="st">"cell_ID"</span>, <span class="st">"celltype_broad"</span>, <span class="st">"celltype_fine"</span>))</span>
<span id="cb9-563"><a href="#cb9-563" aria-hidden="true" tabindex="-1"></a>min_obs <span class="ot">=</span> <span class="dv">50</span></span>
<span id="cb9-564"><a href="#cb9-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-565"><a href="#cb9-565" aria-hidden="true" tabindex="-1"></a>mean_enrich_by_ct <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb9-566"><a href="#cb9-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(celltype_broad, celltype_fine) <span class="sc">%&gt;%</span></span>
<span id="cb9-567"><a href="#cb9-567" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb9-568"><a href="#cb9-568" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb9-569"><a href="#cb9-569" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">all_of</span>(pathway_cols), mean, <span class="at">.names =</span> <span class="st">"{.col}_mean"</span>),</span>
<span id="cb9-570"><a href="#cb9-570" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb9-571"><a href="#cb9-571" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-572"><a href="#cb9-572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;=</span> min_obs) <span class="sc">%&gt;%</span></span>
<span id="cb9-573"><a href="#cb9-573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(celltype_broad, celltype_fine)</span>
<span id="cb9-574"><a href="#cb9-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-575"><a href="#cb9-575" aria-hidden="true" tabindex="-1"></a>scaled_enrich_by_ct <span class="ot">&lt;-</span> mean_enrich_by_ct <span class="sc">%&gt;%</span></span>
<span id="cb9-576"><a href="#cb9-576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>), <span class="sc">~</span><span class="fu">as.numeric</span>(<span class="fu">scale</span>(.)))) <span class="sc">%&gt;%</span></span>
<span id="cb9-577"><a href="#cb9-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(celltype_broad, celltype_fine)</span>
<span id="cb9-578"><a href="#cb9-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-579"><a href="#cb9-579" aria-hidden="true" tabindex="-1"></a>celltype_broad_colors <span class="ot">&lt;-</span> results_list[[<span class="st">'celltype_broad_colors'</span>]]</span>
<span id="cb9-580"><a href="#cb9-580" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(celltype_broad_colors) <span class="ot">&lt;-</span> results_list[[<span class="st">'celltype_broad_names'</span>]]</span>
<span id="cb9-581"><a href="#cb9-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-582"><a href="#cb9-582" aria-hidden="true" tabindex="-1"></a>celltype_fine_colors <span class="ot">&lt;-</span> results_list[[<span class="st">'celltype_fine_colors'</span>]]</span>
<span id="cb9-583"><a href="#cb9-583" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(celltype_fine_colors) <span class="ot">&lt;-</span> results_list[[<span class="st">'celltype_fine_names'</span>]]</span>
<span id="cb9-584"><a href="#cb9-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-585"><a href="#cb9-585" aria-hidden="true" tabindex="-1"></a><span class="co"># Shared Row Annotation</span></span>
<span id="cb9-586"><a href="#cb9-586" aria-hidden="true" tabindex="-1"></a>row_ha <span class="ot">&lt;-</span> <span class="fu">HeatmapAnnotation</span>(</span>
<span id="cb9-587"><a href="#cb9-587" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Cell Group"</span> <span class="ot">=</span> scaled_enrich_by_ct<span class="sc">$</span>celltype_broad,</span>
<span id="cb9-588"><a href="#cb9-588" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Cell Type"</span> <span class="ot">=</span> scaled_enrich_by_ct<span class="sc">$</span>celltype_fine,</span>
<span id="cb9-589"><a href="#cb9-589" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">list</span>(</span>
<span id="cb9-590"><a href="#cb9-590" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cell Group"</span> <span class="ot">=</span> celltype_broad_colors,</span>
<span id="cb9-591"><a href="#cb9-591" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cell Type"</span> <span class="ot">=</span> celltype_fine_colors</span>
<span id="cb9-592"><a href="#cb9-592" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb9-593"><a href="#cb9-593" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_legend =</span> <span class="fu">c</span>(<span class="st">"Cell Group"</span> <span class="ot">=</span> <span class="cn">FALSE</span>, <span class="st">"Cell Type"</span> <span class="ot">=</span> <span class="cn">FALSE</span>),</span>
<span id="cb9-594"><a href="#cb9-594" aria-hidden="true" tabindex="-1"></a>  <span class="at">which =</span> <span class="st">"row"</span></span>
<span id="cb9-595"><a href="#cb9-595" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-596"><a href="#cb9-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-597"><a href="#cb9-597" aria-hidden="true" tabindex="-1"></a>zscore_col_fun <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="fu">c</span>(<span class="st">"#2166AC"</span>, <span class="st">"white"</span>, <span class="st">"#B2182B"</span>))</span>
<span id="cb9-598"><a href="#cb9-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-599"><a href="#cb9-599" aria-hidden="true" tabindex="-1"></a>heatmap_matrix_z <span class="ot">&lt;-</span> scaled_enrich_by_ct <span class="sc">%&gt;%</span></span>
<span id="cb9-600"><a href="#cb9-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-601"><a href="#cb9-601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb9-602"><a href="#cb9-602" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(heatmap_matrix_z) <span class="ot">&lt;-</span> scaled_enrich_by_ct<span class="sc">$</span>celltype_fine</span>
<span id="cb9-603"><a href="#cb9-603" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(heatmap_matrix_z) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_mean"</span>, <span class="st">""</span>, <span class="fu">colnames</span>(heatmap_matrix_z))</span>
<span id="cb9-604"><a href="#cb9-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-605"><a href="#cb9-605" aria-hidden="true" tabindex="-1"></a>ht_z <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(</span>
<span id="cb9-606"><a href="#cb9-606" aria-hidden="true" tabindex="-1"></a>  heatmap_matrix_z,</span>
<span id="cb9-607"><a href="#cb9-607" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"Pathway Z-score</span><span class="sc">\n</span><span class="st">(Relative)"</span>,</span>
<span id="cb9-608"><a href="#cb9-608" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> zscore_col_fun,</span>
<span id="cb9-609"><a href="#cb9-609" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-610"><a href="#cb9-610" aria-hidden="true" tabindex="-1"></a>  <span class="at">left_annotation =</span> row_ha,</span>
<span id="cb9-611"><a href="#cb9-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-612"><a href="#cb9-612" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_row_names =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-613"><a href="#cb9-613" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">6</span>),</span>
<span id="cb9-614"><a href="#cb9-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-615"><a href="#cb9-615" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_columns =</span> <span class="cn">FALSE</span>, <span class="co"># &lt;1&gt;</span></span>
<span id="cb9-616"><a href="#cb9-616" aria-hidden="true" tabindex="-1"></a>  <span class="at">column_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">7</span>),</span>
<span id="cb9-617"><a href="#cb9-617" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_split =</span> scaled_enrich_by_ct<span class="sc">$</span>celltype_broad, </span>
<span id="cb9-618"><a href="#cb9-618" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_row_slices =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-619"><a href="#cb9-619" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_rows =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-620"><a href="#cb9-620" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_rot =</span> <span class="dv">0</span>,</span>
<span id="cb9-621"><a href="#cb9-621" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">10</span>)</span>
<span id="cb9-622"><a href="#cb9-622" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-623"><a href="#cb9-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-624"><a href="#cb9-624" aria-hidden="true" tabindex="-1"></a>svglite<span class="sc">::</span><span class="fu">svglite</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_cell_type_zscore.svg"</span>), <span class="at">width =</span> <span class="fl">3.5</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb9-625"><a href="#cb9-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(</span>
<span id="cb9-626"><a href="#cb9-626" aria-hidden="true" tabindex="-1"></a>    ht_z, </span>
<span id="cb9-627"><a href="#cb9-627" aria-hidden="true" tabindex="-1"></a>    <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, </span>
<span id="cb9-628"><a href="#cb9-628" aria-hidden="true" tabindex="-1"></a>    <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>,</span>
<span id="cb9-629"><a href="#cb9-629" aria-hidden="true" tabindex="-1"></a>    <span class="at">merge_legend =</span> <span class="cn">TRUE</span></span>
<span id="cb9-630"><a href="#cb9-630" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-631"><a href="#cb9-631" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb9-632"><a href="#cb9-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-633"><a href="#cb9-633" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_cell_type_zscore.png"</span>), </span>
<span id="cb9-634"><a href="#cb9-634" aria-hidden="true" tabindex="-1"></a>    <span class="at">width=</span><span class="dv">4</span>, <span class="at">height=</span><span class="dv">8</span>, <span class="at">res=</span><span class="dv">350</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">type =</span> <span class="st">'cairo'</span>)</span>
<span id="cb9-635"><a href="#cb9-635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(</span>
<span id="cb9-636"><a href="#cb9-636" aria-hidden="true" tabindex="-1"></a>    ht_z, </span>
<span id="cb9-637"><a href="#cb9-637" aria-hidden="true" tabindex="-1"></a>    <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, </span>
<span id="cb9-638"><a href="#cb9-638" aria-hidden="true" tabindex="-1"></a>    <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>,</span>
<span id="cb9-639"><a href="#cb9-639" aria-hidden="true" tabindex="-1"></a>    <span class="at">merge_legend =</span> <span class="cn">TRUE</span></span>
<span id="cb9-640"><a href="#cb9-640" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-641"><a href="#cb9-641" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb9-642"><a href="#cb9-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-643"><a href="#cb9-643" aria-hidden="true" tabindex="-1"></a>heatmap_matrix_mean <span class="ot">&lt;-</span> mean_enrich_by_ct <span class="sc">%&gt;%</span></span>
<span id="cb9-644"><a href="#cb9-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-645"><a href="#cb9-645" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb9-646"><a href="#cb9-646" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(heatmap_matrix_mean) <span class="ot">&lt;-</span> mean_enrich_by_ct<span class="sc">$</span>celltype_fine</span>
<span id="cb9-647"><a href="#cb9-647" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(heatmap_matrix_mean) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_mean"</span>, <span class="st">""</span>, <span class="fu">colnames</span>(heatmap_matrix_mean))</span>
<span id="cb9-648"><a href="#cb9-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-649"><a href="#cb9-649" aria-hidden="true" tabindex="-1"></a>quantile_limit <span class="ot">&lt;-</span> <span class="fl">0.95</span></span>
<span id="cb9-650"><a href="#cb9-650" aria-hidden="true" tabindex="-1"></a>limit <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(<span class="fu">abs</span>(<span class="fu">as.vector</span>(heatmap_matrix_mean)), quantile_limit, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb9-651"><a href="#cb9-651" aria-hidden="true" tabindex="-1"></a>mean_col_fun <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="fu">c</span>(<span class="sc">-</span>limit, <span class="dv">0</span>, limit), <span class="fu">c</span>(<span class="st">"#2166AC"</span>, <span class="st">"white"</span>, <span class="st">"#B2182B"</span>))</span>
<span id="cb9-652"><a href="#cb9-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-653"><a href="#cb9-653" aria-hidden="true" tabindex="-1"></a>ht_mean <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(</span>
<span id="cb9-654"><a href="#cb9-654" aria-hidden="true" tabindex="-1"></a>  heatmap_matrix_mean,</span>
<span id="cb9-655"><a href="#cb9-655" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"PROGENy Score</span><span class="sc">\n</span><span class="st">(Mean)"</span>,</span>
<span id="cb9-656"><a href="#cb9-656" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> mean_col_fun,</span>
<span id="cb9-657"><a href="#cb9-657" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-658"><a href="#cb9-658" aria-hidden="true" tabindex="-1"></a>  <span class="at">left_annotation =</span> row_ha,</span>
<span id="cb9-659"><a href="#cb9-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-660"><a href="#cb9-660" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_row_names =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-661"><a href="#cb9-661" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">6</span>),</span>
<span id="cb9-662"><a href="#cb9-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-663"><a href="#cb9-663" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_columns =</span> <span class="cn">FALSE</span>, </span>
<span id="cb9-664"><a href="#cb9-664" aria-hidden="true" tabindex="-1"></a>  <span class="at">column_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">7</span>),</span>
<span id="cb9-665"><a href="#cb9-665" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_split =</span> mean_enrich_by_ct<span class="sc">$</span>celltype_broad, </span>
<span id="cb9-666"><a href="#cb9-666" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_row_slices =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-667"><a href="#cb9-667" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_rows =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-668"><a href="#cb9-668" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_rot =</span> <span class="dv">0</span>,</span>
<span id="cb9-669"><a href="#cb9-669" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">10</span>)</span>
<span id="cb9-670"><a href="#cb9-670" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-671"><a href="#cb9-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-672"><a href="#cb9-672" aria-hidden="true" tabindex="-1"></a>svglite<span class="sc">::</span><span class="fu">svglite</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_cell_type_mean.svg"</span>), <span class="at">width =</span> <span class="fl">3.5</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb9-673"><a href="#cb9-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(</span>
<span id="cb9-674"><a href="#cb9-674" aria-hidden="true" tabindex="-1"></a>    ht_mean, </span>
<span id="cb9-675"><a href="#cb9-675" aria-hidden="true" tabindex="-1"></a>    <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, </span>
<span id="cb9-676"><a href="#cb9-676" aria-hidden="true" tabindex="-1"></a>    <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>,</span>
<span id="cb9-677"><a href="#cb9-677" aria-hidden="true" tabindex="-1"></a>    <span class="at">merge_legend =</span> <span class="cn">TRUE</span></span>
<span id="cb9-678"><a href="#cb9-678" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-679"><a href="#cb9-679" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb9-680"><a href="#cb9-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-681"><a href="#cb9-681" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_cell_type_mean.png"</span>), </span>
<span id="cb9-682"><a href="#cb9-682" aria-hidden="true" tabindex="-1"></a>    <span class="at">width=</span><span class="dv">4</span>, <span class="at">height=</span><span class="dv">8</span>, <span class="at">res=</span><span class="dv">350</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">type =</span> <span class="st">'cairo'</span>)</span>
<span id="cb9-683"><a href="#cb9-683" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(</span>
<span id="cb9-684"><a href="#cb9-684" aria-hidden="true" tabindex="-1"></a>    ht_mean, </span>
<span id="cb9-685"><a href="#cb9-685" aria-hidden="true" tabindex="-1"></a>    <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, </span>
<span id="cb9-686"><a href="#cb9-686" aria-hidden="true" tabindex="-1"></a>    <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>,</span>
<span id="cb9-687"><a href="#cb9-687" aria-hidden="true" tabindex="-1"></a>    <span class="at">merge_legend =</span> <span class="cn">TRUE</span></span>
<span id="cb9-688"><a href="#cb9-688" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-689"><a href="#cb9-689" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb9-690"><a href="#cb9-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-691"><a href="#cb9-691" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Set to FALSE to make it easier to compare the mean and the Z-score heatmaps. Set to TRUE to make it easier to group similar pathway signatures.</span>
<span id="cb9-692"><a href="#cb9-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-693"><a href="#cb9-693" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb9-694"><a href="#cb9-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-695"><a href="#cb9-695" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Mean</span></span>
<span id="cb9-696"><a href="#cb9-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-699"><a href="#cb9-699" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-700"><a href="#cb9-700" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-heatmap-paths-by-celltypes-m</span></span>
<span id="cb9-701"><a href="#cb9-701" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb9-702"><a href="#cb9-702" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb9-703"><a href="#cb9-703" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb9-704"><a href="#cb9-704" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Average pathway enrichment scores by cell type."</span></span>
<span id="cb9-705"><a href="#cb9-705" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb9-706"><a href="#cb9-706" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: "70%"</span></span>
<span id="cb9-707"><a href="#cb9-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-708"><a href="#cb9-708" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(<span class="fu">file.path</span>(analysis_asset_dir, <span class="st">'pathways'</span>), <span class="st">"heatmap_by_cell_type_mean.png"</span>, <span class="at">source_parent_folder=</span>pw_dir, <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb9-709"><a href="#cb9-709" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-710"><a href="#cb9-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-711"><a href="#cb9-711" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Z-score</span></span>
<span id="cb9-712"><a href="#cb9-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-715"><a href="#cb9-715" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-716"><a href="#cb9-716" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-heatmap-paths-by-celltypes-z</span></span>
<span id="cb9-717"><a href="#cb9-717" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb9-718"><a href="#cb9-718" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb9-719"><a href="#cb9-719" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb9-720"><a href="#cb9-720" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Average pathway enrichment scores (z-score) by cell type."</span></span>
<span id="cb9-721"><a href="#cb9-721" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb9-722"><a href="#cb9-722" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: "70%"</span></span>
<span id="cb9-723"><a href="#cb9-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-724"><a href="#cb9-724" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(<span class="fu">file.path</span>(analysis_asset_dir, <span class="st">'pathways'</span>), <span class="st">"heatmap_by_cell_type_zscore.png"</span>, <span class="at">source_parent_folder=</span>pw_dir, <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb9-725"><a href="#cb9-725" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-726"><a href="#cb9-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-727"><a href="#cb9-727" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb9-728"><a href="#cb9-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-729"><a href="#cb9-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-730"><a href="#cb9-730" aria-hidden="true" tabindex="-1"></a><span class="fu">### Global: Per Domain</span></span>
<span id="cb9-731"><a href="#cb9-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-732"><a href="#cb9-732" aria-hidden="true" tabindex="-1"></a>This follows a similar procedure as above but summarized across spatial domains. </span>
<span id="cb9-733"><a href="#cb9-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-736"><a href="#cb9-736" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-737"><a href="#cb9-737" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: domain-summary</span></span>
<span id="cb9-738"><a href="#cb9-738" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-739"><a href="#cb9-739" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb9-740"><a href="#cb9-740" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb9-741"><a href="#cb9-741" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb9-742"><a href="#cb9-742" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-743"><a href="#cb9-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-744"><a href="#cb9-744" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">merge</span>(df, py<span class="sc">$</span>nn_pwdata<span class="sc">$</span>obs <span class="sc">%&gt;%</span> <span class="fu">select</span>(cell_ID, annotated_domain), <span class="at">by=</span><span class="st">"cell_ID"</span>)</span>
<span id="cb9-745"><a href="#cb9-745" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">filter</span>(df, <span class="sc">!</span><span class="fu">is.na</span>(annotated_domain))</span>
<span id="cb9-746"><a href="#cb9-746" aria-hidden="true" tabindex="-1"></a>min_obs <span class="ot">=</span> <span class="dv">50</span></span>
<span id="cb9-747"><a href="#cb9-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-748"><a href="#cb9-748" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Mean Scores</span></span>
<span id="cb9-749"><a href="#cb9-749" aria-hidden="true" tabindex="-1"></a>mean_enrich_by_domain <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb9-750"><a href="#cb9-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(annotated_domain) <span class="sc">%&gt;%</span></span>
<span id="cb9-751"><a href="#cb9-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb9-752"><a href="#cb9-752" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb9-753"><a href="#cb9-753" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">all_of</span>(pathway_cols), mean, <span class="at">.names =</span> <span class="st">"{.col}_mean"</span>),</span>
<span id="cb9-754"><a href="#cb9-754" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb9-755"><a href="#cb9-755" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-756"><a href="#cb9-756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;=</span> min_obs, <span class="sc">!</span><span class="fu">is.na</span>(annotated_domain)) <span class="sc">%&gt;%</span></span>
<span id="cb9-757"><a href="#cb9-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(annotated_domain)</span>
<span id="cb9-758"><a href="#cb9-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-759"><a href="#cb9-759" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Z-scores (Scale the means)</span></span>
<span id="cb9-760"><a href="#cb9-760" aria-hidden="true" tabindex="-1"></a>scaled_enrich_by_domain <span class="ot">&lt;-</span> mean_enrich_by_domain <span class="sc">%&gt;%</span></span>
<span id="cb9-761"><a href="#cb9-761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>), <span class="sc">~</span><span class="fu">as.numeric</span>(<span class="fu">scale</span>(.)))) <span class="sc">%&gt;%</span></span>
<span id="cb9-762"><a href="#cb9-762" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(annotated_domain)</span>
<span id="cb9-763"><a href="#cb9-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-764"><a href="#cb9-764" aria-hidden="true" tabindex="-1"></a><span class="co"># Colors</span></span>
<span id="cb9-765"><a href="#cb9-765" aria-hidden="true" tabindex="-1"></a>domain_colors_df  <span class="ot">&lt;-</span> results_list[[<span class="st">'domain_colors'</span>]]</span>
<span id="cb9-766"><a href="#cb9-766" aria-hidden="true" tabindex="-1"></a>domain_colors <span class="ot">&lt;-</span> domain_colors_df<span class="sc">$</span>domain_color</span>
<span id="cb9-767"><a href="#cb9-767" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(domain_colors) <span class="ot">&lt;-</span> domain_colors_df<span class="sc">$</span>domain_description</span>
<span id="cb9-768"><a href="#cb9-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-769"><a href="#cb9-769" aria-hidden="true" tabindex="-1"></a><span class="co"># Common Row Annotation</span></span>
<span id="cb9-770"><a href="#cb9-770" aria-hidden="true" tabindex="-1"></a>row_ha <span class="ot">&lt;-</span> <span class="fu">HeatmapAnnotation</span>(</span>
<span id="cb9-771"><a href="#cb9-771" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Spatial Domain"</span> <span class="ot">=</span> mean_enrich_by_domain<span class="sc">$</span>annotated_domain,</span>
<span id="cb9-772"><a href="#cb9-772" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">list</span>(<span class="st">"Spatial Domain"</span> <span class="ot">=</span> domain_colors),</span>
<span id="cb9-773"><a href="#cb9-773" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_legend =</span> <span class="fu">c</span>(<span class="st">"Spatial Domain"</span> <span class="ot">=</span> <span class="cn">FALSE</span>),</span>
<span id="cb9-774"><a href="#cb9-774" aria-hidden="true" tabindex="-1"></a>  <span class="at">which =</span> <span class="st">"row"</span></span>
<span id="cb9-775"><a href="#cb9-775" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-776"><a href="#cb9-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-777"><a href="#cb9-777" aria-hidden="true" tabindex="-1"></a><span class="co"># Color Functions</span></span>
<span id="cb9-778"><a href="#cb9-778" aria-hidden="true" tabindex="-1"></a>zscore_col_fun <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="fu">c</span>(<span class="st">"#2166AC"</span>, <span class="st">"white"</span>, <span class="st">"#B2182B"</span>))</span>
<span id="cb9-779"><a href="#cb9-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-780"><a href="#cb9-780" aria-hidden="true" tabindex="-1"></a><span class="co"># Z-Score Heatmap</span></span>
<span id="cb9-781"><a href="#cb9-781" aria-hidden="true" tabindex="-1"></a>heatmap_matrix_z <span class="ot">&lt;-</span> scaled_enrich_by_domain <span class="sc">%&gt;%</span></span>
<span id="cb9-782"><a href="#cb9-782" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-783"><a href="#cb9-783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb9-784"><a href="#cb9-784" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(heatmap_matrix_z) <span class="ot">&lt;-</span> scaled_enrich_by_domain<span class="sc">$</span>annotated_domain</span>
<span id="cb9-785"><a href="#cb9-785" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(heatmap_matrix_z) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_mean"</span>, <span class="st">""</span>, <span class="fu">colnames</span>(heatmap_matrix_z))</span>
<span id="cb9-786"><a href="#cb9-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-787"><a href="#cb9-787" aria-hidden="true" tabindex="-1"></a>ht_z <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(</span>
<span id="cb9-788"><a href="#cb9-788" aria-hidden="true" tabindex="-1"></a>  heatmap_matrix_z,</span>
<span id="cb9-789"><a href="#cb9-789" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"Pathway Z-score</span><span class="sc">\n</span><span class="st">(Relative)"</span>,</span>
<span id="cb9-790"><a href="#cb9-790" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> zscore_col_fun,</span>
<span id="cb9-791"><a href="#cb9-791" aria-hidden="true" tabindex="-1"></a>  <span class="at">left_annotation =</span> row_ha,</span>
<span id="cb9-792"><a href="#cb9-792" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_row_names =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-793"><a href="#cb9-793" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="fl">5.5</span>),</span>
<span id="cb9-794"><a href="#cb9-794" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_columns =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-795"><a href="#cb9-795" aria-hidden="true" tabindex="-1"></a>  <span class="at">column_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="fl">5.5</span>),</span>
<span id="cb9-796"><a href="#cb9-796" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_rot =</span> <span class="dv">0</span>,</span>
<span id="cb9-797"><a href="#cb9-797" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">8</span>)</span>
<span id="cb9-798"><a href="#cb9-798" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-799"><a href="#cb9-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-800"><a href="#cb9-800" aria-hidden="true" tabindex="-1"></a>svglite<span class="sc">::</span><span class="fu">svglite</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_domain_zscore.svg"</span>), <span class="at">width =</span> <span class="fl">3.5</span>, <span class="at">height =</span> <span class="dv">3</span>)</span>
<span id="cb9-801"><a href="#cb9-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(ht_z, <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">merge_legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-802"><a href="#cb9-802" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb9-803"><a href="#cb9-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-804"><a href="#cb9-804" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_domain_zscore.png"</span>), <span class="at">width=</span><span class="fl">3.5</span>, <span class="at">height=</span><span class="fl">3.5</span>, <span class="at">res=</span><span class="dv">350</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">type =</span> <span class="st">'cairo'</span>)</span>
<span id="cb9-805"><a href="#cb9-805" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(ht_z, <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">merge_legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-806"><a href="#cb9-806" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb9-807"><a href="#cb9-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-808"><a href="#cb9-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-809"><a href="#cb9-809" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean Score Heatmap</span></span>
<span id="cb9-810"><a href="#cb9-810" aria-hidden="true" tabindex="-1"></a>heatmap_matrix_mean <span class="ot">&lt;-</span> mean_enrich_by_domain <span class="sc">%&gt;%</span></span>
<span id="cb9-811"><a href="#cb9-811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">"_mean"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-812"><a href="#cb9-812" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb9-813"><a href="#cb9-813" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(heatmap_matrix_mean) <span class="ot">&lt;-</span> mean_enrich_by_domain<span class="sc">$</span>annotated_domain</span>
<span id="cb9-814"><a href="#cb9-814" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(heatmap_matrix_mean) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_mean"</span>, <span class="st">""</span>, <span class="fu">colnames</span>(heatmap_matrix_mean))</span>
<span id="cb9-815"><a href="#cb9-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-816"><a href="#cb9-816" aria-hidden="true" tabindex="-1"></a>quantile_limit <span class="ot">&lt;-</span> <span class="fl">0.95</span></span>
<span id="cb9-817"><a href="#cb9-817" aria-hidden="true" tabindex="-1"></a>limit <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(<span class="fu">abs</span>(<span class="fu">as.vector</span>(heatmap_matrix_mean)), quantile_limit, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb9-818"><a href="#cb9-818" aria-hidden="true" tabindex="-1"></a>mean_col_fun <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="fu">c</span>(<span class="sc">-</span>limit, <span class="dv">0</span>, limit), <span class="fu">c</span>(<span class="st">"#2166AC"</span>, <span class="st">"white"</span>, <span class="st">"#B2182B"</span>))</span>
<span id="cb9-819"><a href="#cb9-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-820"><a href="#cb9-820" aria-hidden="true" tabindex="-1"></a>ht_mean <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(</span>
<span id="cb9-821"><a href="#cb9-821" aria-hidden="true" tabindex="-1"></a>  heatmap_matrix_mean,</span>
<span id="cb9-822"><a href="#cb9-822" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"PROGENy Score</span><span class="sc">\n</span><span class="st">(Mean)"</span>,</span>
<span id="cb9-823"><a href="#cb9-823" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> mean_col_fun,</span>
<span id="cb9-824"><a href="#cb9-824" aria-hidden="true" tabindex="-1"></a>  <span class="at">left_annotation =</span> row_ha,</span>
<span id="cb9-825"><a href="#cb9-825" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_row_names =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-826"><a href="#cb9-826" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="fl">5.5</span>),</span>
<span id="cb9-827"><a href="#cb9-827" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_columns =</span> <span class="cn">TRUE</span>, </span>
<span id="cb9-828"><a href="#cb9-828" aria-hidden="true" tabindex="-1"></a>  <span class="at">column_names_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="fl">5.5</span>),</span>
<span id="cb9-829"><a href="#cb9-829" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_rot =</span> <span class="dv">0</span>,</span>
<span id="cb9-830"><a href="#cb9-830" aria-hidden="true" tabindex="-1"></a>  <span class="at">row_title_gp =</span> <span class="fu">gpar</span>(<span class="at">fontsize =</span> <span class="dv">8</span>)</span>
<span id="cb9-831"><a href="#cb9-831" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-832"><a href="#cb9-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-833"><a href="#cb9-833" aria-hidden="true" tabindex="-1"></a>svglite<span class="sc">::</span><span class="fu">svglite</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_domain_mean.svg"</span>), <span class="at">width =</span> <span class="fl">3.5</span>, <span class="at">height =</span> <span class="dv">3</span>)</span>
<span id="cb9-834"><a href="#cb9-834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(ht_mean, <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">merge_legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-835"><a href="#cb9-835" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb9-836"><a href="#cb9-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-837"><a href="#cb9-837" aria-hidden="true" tabindex="-1"></a><span class="fu">png</span>(<span class="fu">file.path</span>(pw_dir, <span class="st">"heatmap_by_domain_mean.png"</span>), <span class="at">width=</span><span class="fl">3.5</span>, <span class="at">height=</span><span class="fl">3.5</span>, <span class="at">res=</span><span class="dv">350</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">type =</span> <span class="st">'cairo'</span>)</span>
<span id="cb9-838"><a href="#cb9-838" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw</span>(ht_mean, <span class="at">heatmap_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">annotation_legend_side =</span> <span class="st">"bottom"</span>, <span class="at">merge_legend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-839"><a href="#cb9-839" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb9-840"><a href="#cb9-840" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-841"><a href="#cb9-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-842"><a href="#cb9-842" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb9-843"><a href="#cb9-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-844"><a href="#cb9-844" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Mean</span></span>
<span id="cb9-845"><a href="#cb9-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-848"><a href="#cb9-848" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-849"><a href="#cb9-849" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-heatmap-paths-by-domains-m</span></span>
<span id="cb9-850"><a href="#cb9-850" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb9-851"><a href="#cb9-851" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb9-852"><a href="#cb9-852" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb9-853"><a href="#cb9-853" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Average pathway enrichment scores by spatial domain. Colors correspond to domains in @fig-xy-domains. Note: columns were clustered and so will have a difference order than that found in @fig-heatmap-paths-by-domains-z."</span></span>
<span id="cb9-854"><a href="#cb9-854" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb9-855"><a href="#cb9-855" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: "70%"</span></span>
<span id="cb9-856"><a href="#cb9-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-857"><a href="#cb9-857" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(<span class="fu">file.path</span>(analysis_asset_dir, <span class="st">'pathways'</span>), <span class="st">"heatmap_by_domain_mean.png"</span>, </span>
<span id="cb9-858"><a href="#cb9-858" aria-hidden="true" tabindex="-1"></a>       <span class="at">source_parent_folder=</span>pw_dir, <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb9-859"><a href="#cb9-859" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-860"><a href="#cb9-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-861"><a href="#cb9-861" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Z-score</span></span>
<span id="cb9-862"><a href="#cb9-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-865"><a href="#cb9-865" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-866"><a href="#cb9-866" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-heatmap-paths-by-domains-z</span></span>
<span id="cb9-867"><a href="#cb9-867" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb9-868"><a href="#cb9-868" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb9-869"><a href="#cb9-869" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "R Code"</span></span>
<span id="cb9-870"><a href="#cb9-870" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Average pathway enrichment scores (z-score) by spatial domain. Colors correspond to domains in @fig-xy-domains. Note: columns were clustered and so will have a difference order than that found in @fig-heatmap-paths-by-domains-m."</span></span>
<span id="cb9-871"><a href="#cb9-871" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: center</span></span>
<span id="cb9-872"><a href="#cb9-872" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: "70%"</span></span>
<span id="cb9-873"><a href="#cb9-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-874"><a href="#cb9-874" aria-hidden="true" tabindex="-1"></a><span class="fu">render</span>(<span class="fu">file.path</span>(analysis_asset_dir, <span class="st">'pathways'</span>), <span class="st">"heatmap_by_domain_zscore.png"</span>, </span>
<span id="cb9-875"><a href="#cb9-875" aria-hidden="true" tabindex="-1"></a>       <span class="at">source_parent_folder=</span>pw_dir, <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb9-876"><a href="#cb9-876" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-877"><a href="#cb9-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-878"><a href="#cb9-878" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb9-879"><a href="#cb9-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-880"><a href="#cb9-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-881"><a href="#cb9-881" aria-hidden="true" tabindex="-1"></a>Examining and comparing the spatial plots in @sec-local-path-plots with the </span>
<span id="cb9-882"><a href="#cb9-882" aria-hidden="true" tabindex="-1"></a>global heatmaps @fig-heatmap-paths-by-celltypes-m,</span>
<span id="cb9-883"><a href="#cb9-883" aria-hidden="true" tabindex="-1"></a>@fig-heatmap-paths-by-celltypes-z,</span>
<span id="cb9-884"><a href="#cb9-884" aria-hidden="true" tabindex="-1"></a>@fig-heatmap-paths-by-domains-m, and </span>
<span id="cb9-885"><a href="#cb9-885" aria-hidden="true" tabindex="-1"></a>@fig-heatmap-paths-by-domains-z reveals several findings in this tissue. </span>
<span id="cb9-886"><a href="#cb9-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-887"><a href="#cb9-887" aria-hidden="true" tabindex="-1"></a>For example:</span>
<span id="cb9-888"><a href="#cb9-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-889"><a href="#cb9-889" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In the tumor cells we see little enrichment of the</span>
<span id="cb9-890"><a href="#cb9-890" aria-hidden="true" tabindex="-1"></a>pro-apoptotic TRAIL pathway (mean = 0.0; Z-score = -1.1) but high EGFR</span>
<span id="cb9-891"><a href="#cb9-891" aria-hidden="true" tabindex="-1"></a>enrichment (mean = 2.6; Z-score = 3.7), a pattern associated with increased cell</span>
<span id="cb9-892"><a href="#cb9-892" aria-hidden="true" tabindex="-1"></a>invasion and metastasis @Sasaki2013. </span>
<span id="cb9-893"><a href="#cb9-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-894"><a href="#cb9-894" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Tumor cells are likely a "CMS4" or mesenchymal colon cancer phenotype. The three signatures of this phenotype are 'prominent transforming growth factor–β activation, stromal invasion and angiogenesis' @Guinney2015. Looking at growth regulation, tumor cells themsevles show little enrichment of TGF-$\beta$ (mean = -2.3; Z-score = -0.85); however, the CAFs show the highest levels in the dataset (mean = 7.0; Z-score = 3.9). This pattern mirrors the TGF-$\beta$ exclusion phenotype described in the literature, where stromal activation drives poor prognosis in colon cancer @Calon2015 @Ma2024. For stromal invasion, we can see from the spatial plots both at the cell type-level @fig-xy-celltype-broad and the domain-level (@fig-xy-domains) that CAFs and tumors are found in interdigitated domains. And finally, we found a signature of angiogenesis in tumor cells and tumor and stromal domains with the enrichment of VEGF @Duffy2004.</span>
<span id="cb9-895"><a href="#cb9-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-896"><a href="#cb9-896" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>There is a strong enrichment of TNF-$\alpha$ and NF-$\kappa$B on the left side</span>
<span id="cb9-897"><a href="#cb9-897" aria-hidden="true" tabindex="-1"></a>of the tissue that is still unresolved. The left side of the tissue is part of the</span>
<span id="cb9-898"><a href="#cb9-898" aria-hidden="true" tabindex="-1"></a>"Heterogeneous" spatial domain that is found throughout (@sec-domains) that contains</span>
<span id="cb9-899"><a href="#cb9-899" aria-hidden="true" tabindex="-1"></a>a high proportion of undetermined cell types (@fig-contingency-table). Perhaps</span>
<span id="cb9-900"><a href="#cb9-900" aria-hidden="true" tabindex="-1"></a>a follow up analysis would include isolating the cells within this "sub-domain"</span>
<span id="cb9-901"><a href="#cb9-901" aria-hidden="true" tabindex="-1"></a>to understand which cells might be driving the reduction of apoptosis and preventing</span>
<span id="cb9-902"><a href="#cb9-902" aria-hidden="true" tabindex="-1"></a>an effective immune response. This could be done with lasso selecting the region </span>
<span id="cb9-903"><a href="#cb9-903" aria-hidden="true" tabindex="-1"></a>(see our <span class="co">[</span><span class="ot">blog post on lasso selecting with napari</span><span class="co">](https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-rois/cosmx-rois.html)</span>{target="_blank"}).</span>
<span id="cb9-904"><a href="#cb9-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-905"><a href="#cb9-905" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb9-906"><a href="#cb9-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-907"><a href="#cb9-907" aria-hidden="true" tabindex="-1"></a>In this chapter, we showed a simple nearest-neighbor smoothing technique and </span>
<span id="cb9-908"><a href="#cb9-908" aria-hidden="true" tabindex="-1"></a>scored pathways using one of the available databases (PROGENy; for others see</span>
<span id="cb9-909"><a href="#cb9-909" aria-hidden="true" tabindex="-1"></a><span class="in">`decoupler.op.show_resources()`</span>). Then we showed a few ways to pivot the data</span>
<span id="cb9-910"><a href="#cb9-910" aria-hidden="true" tabindex="-1"></a>and visualize the local scores or global aggregates these scores across cell types </span>
<span id="cb9-911"><a href="#cb9-911" aria-hidden="true" tabindex="-1"></a>and spatial domains to guide our inference. </span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.min.js"></script>

<script>
window.addEventListener('load', function() {
  // Initialize Tippy.js ONLY on links with the .link-preview class
  tippy('.link-preview', {
    content(reference) {
      const iframe = document.createElement('iframe');
      iframe.src = reference.href;
      iframe.width = "400px";
      iframe.height = "300px";
      iframe.style.border = "1px solid #ddd";
      iframe.style.borderRadius = "4px";
      return iframe;
    },
    allowHTML: true,
    interactive: true,
    placement: 'auto',
    arrow: true,
    animation: 'fade',
    delay: [300, 200],
    maxWidth: 420
  });
});
</script>




</body></html>