<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dan McGuire">
<meta name="dcterms.date" content="2025-10-30">
<meta name="description" content="Better dimension reduction techniques for spatial data.">

<title>scPearsonPCA: An R package for efficient Principal Components decomposition of pearson residual normalized single cell data – Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/logo_Bruker_black.png" rel="icon" type="image/png">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-3a01e2046221230fdceeea94b1ec5d67.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-a4a11d514c7d463668e07712114998e6.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-8dd817d487e8e26707729065bc6b7e6d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-29W4MW0Y2W"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-29W4MW0Y2W', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../.././assets/logo_Bruker_white.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../license.html"> 
<span class="menu-text">License</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../link-to-code.html"> 
<span class="menu-text">Code</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">Browse Posts by Topic</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/company/bruker-spatial"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">scPearsonPCA: An R package for efficient Principal Components decomposition of pearson residual normalized single cell data</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          Better dimension reduction techniques for spatial data.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">normalization</div>
                <div class="quarto-category">pearson residuals</div>
                <div class="quarto-category">principal component analysis</div>
                <div class="quarto-category">batch correction</div>
                <div class="quarto-category">multiomics</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliations</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Dan McGuire <a href="https://orcid.org/0009-0006-0286-9625" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Bruker Spatial Biology
            </p>
          <p class="affiliation">
              Github: <a href="https://github.com/dan11mcguire" target="_blank">dan11mcguire</a>
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 30, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation"><span class="header-section-number">2</span> Installation</a></li>
  <li><a href="#most-used-functions" id="toc-most-used-functions" class="nav-link" data-scroll-target="#most-used-functions"><span class="header-section-number">3</span> Most used functions</a></li>
  <li><a href="#quickstart-example-usage" id="toc-quickstart-example-usage" class="nav-link" data-scroll-target="#quickstart-example-usage"><span class="header-section-number">4</span> Quickstart / Example Usage</a></li>
  <li><a href="#pearson-pca-using-sparse_quasipoisson_pca_seurat" id="toc-pearson-pca-using-sparse_quasipoisson_pca_seurat" class="nav-link" data-scroll-target="#pearson-pca-using-sparse_quasipoisson_pca_seurat"><span class="header-section-number">5</span> Pearson PCA using <code>sparse_quasipoisson_pca_seurat</code></a>
  <ul class="collapse">
  <li><a href="#using-the-output-for-downstream-analysis" id="toc-using-the-output-for-downstream-analysis" class="nav-link" data-scroll-target="#using-the-output-for-downstream-analysis"><span class="header-section-number">5.1</span> Using the output for downstream analysis</a></li>
  </ul></li>
  <li><a href="#batch-corrected-pearson-pca-using-sparse_quasipoisson_pca_seurat_batch" id="toc-batch-corrected-pearson-pca-using-sparse_quasipoisson_pca_seurat_batch" class="nav-link" data-scroll-target="#batch-corrected-pearson-pca-using-sparse_quasipoisson_pca_seurat_batch"><span class="header-section-number">6</span> Batch corrected Pearson PCA using <code>sparse_quasipoisson_pca_seurat_batch</code></a>
  <ul class="collapse">
  <li><a href="#using-the-output-for-downstream-analysis-1" id="toc-using-the-output-for-downstream-analysis-1" class="nav-link" data-scroll-target="#using-the-output-for-downstream-analysis-1"><span class="header-section-number">6.1</span> Using the output for downstream analysis</a></li>
  </ul></li>
  <li><a href="#pearson-pca-for-multiomic-data-using-sparse_quasipoisson_pca_seurat_multiomic" id="toc-pearson-pca-for-multiomic-data-using-sparse_quasipoisson_pca_seurat_multiomic" class="nav-link" data-scroll-target="#pearson-pca-for-multiomic-data-using-sparse_quasipoisson_pca_seurat_multiomic"><span class="header-section-number">7</span> Pearson PCA for multiomic data using <code>sparse_quasipoisson_pca_seurat_multiomic</code></a>
  <ul class="collapse">
  <li><a href="#using-the-output-for-downstream-analysis-2" id="toc-using-the-output-for-downstream-analysis-2" class="nav-link" data-scroll-target="#using-the-output-for-downstream-analysis-2"><span class="header-section-number">7.1</span> Using the output for downstream analysis</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>Here we present a package for better dimension reduction in spatial data. Pearson residuals can be an effective normalization method for spatially-resolved transcriptomic data. However, the normalized data matrix produced is <strong>dense</strong> with nearly all values non-zero. This limits the usability of pearson residuals for high-plex or large datasets where computing memory can be a limiting factor.</p>
<p>However, the principal component (PC) decomposition of quasi-poisson pearson residuals can be computed directly from a sparse counts matrix and a few easy-to-calculate summary statistics. The R package <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/scPearsonPCA">scPearsonPCA</a> enables this PC decomposition, including the returning the PCs as if the normalized data had been centered, scaled, and influential values clipped according to common best practices for PC analysis.</p>
<p>In this post we demonstrate a few quick examples for the package, as well as how to use the PCA results returned for common downstream analyses like UMAP and unsupervised clustering.</p>
</section>
<section id="installation" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="installation"><span class="header-section-number">2</span> Installation</h2>
<p>You can install <code>scPearsonPCA</code> using the remotes package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"Nanostring-Biostats/CosMx-Analysis-Scratch-Space"</span>,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">subdir =</span> <span class="st">"_code/scPearsonPCA"</span>, <span class="at">ref =</span> <span class="st">"Main"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="most-used-functions" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="most-used-functions"><span class="header-section-number">3</span> Most used functions</h2>
<ul>
<li><p><code>sparse_quasipoisson_pca_seurat()</code> This function takes a counts matrix as input and returns a PCA Seurat-style reduction by default. The PCA is based on quasi-poisson pearson residual normalization. Similar to a NormalizeData <span class="math inline">\(\rightarrow\)</span> ScaleData <span class="math inline">\(\rightarrow\)</span> RunPCA workflow, arguments available for returning the PCA as if data were centered and scaled, with extreme values clipped.</p></li>
<li><p><code>sparse_quasipoisson_pca_seurat_batch()</code> This function employs a batch-correction method to PCA, provided there is a single categorical variable for ‘batch’. Examples could be ‘patient’, ‘slide_id’, ‘tma_id’, etc. Akin to a quasipoisson glm-based correction with the batch variable used as a covariate, the basic idea here is that gene frequencies are computed separately by batch rather than across the full sample.</p></li>
<li><p><code>sparse_quasipoisson_pca_seurat_multiomic()</code> This function is useful for getting the PCA decomposition from same-cell multiomic data. Here we assume we have two matrices, a sparse RNA counts matrix <code>x</code>, and a (possibly dense,lower dimensional) matrix of already-normalized protein expression <code>xother</code>. We want to be able to get PCA from the combined dataset, while still applying effective normalization to the RNA data. This function uses similar algebraic shortcuts which allow for efficient calculation of PCA from the <strong>covariance matrix</strong> of pearson residuals from the RNA, by deriving PCA from the combined covariance matrix of pre-normalized protein, and pearson-normalized RNA. We’ll demo a full example below using a multiomics breast cancer dataset.</p></li>
</ul>
</section>
<section id="quickstart-example-usage" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="quickstart-example-usage"><span class="header-section-number">4</span> Quickstart / Example Usage</h2>
<p>First we’ll read in our Seurat object dataset. This is 960-plex NSCLC tissue.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table); <span class="fu">setDTthreads</span>(<span class="dv">1</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scPearsonPCA)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>sem <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"seurat_obj_nsclc.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pearson-pca-using-sparse_quasipoisson_pca_seurat" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="pearson-pca-using-sparse_quasipoisson_pca_seurat"><span class="header-section-number">5</span> Pearson PCA using <code>sparse_quasipoisson_pca_seurat</code></h2>
<p>We typically recommend to use up to 2,000-3,000 highly variable genes for generating PCA results.</p>
<p>A few summary stats used as input for calculating pearson-normalized PCs:</p>
<ul>
<li><code>tc</code> is the total counts per cell across all genes.</li>
<li><code>genefreq</code> is the proportion of transcript calls for each gene across all cells.</li>
</ul>
<p>In general, it’s recommended to calculate these summary stats based on all genes rather than a subset of highly variable genes. While this dataset is only 960-plex, the code below uses 900 highly-variable genes as a demonstration for a basic workflow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>tc <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">colSums</span>(sem[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts) <span class="do">## total counts per cell (across all genes)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>genefreq <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">gene_frequency</span>(sem[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts) <span class="do">## gene frequency (across all cells)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(genefreq)<span class="sc">==</span><span class="dv">1</span> <span class="co"># TRUE</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>sem <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">FindVariableFeatures</span>(sem, <span class="at">nfeatures =</span> <span class="dv">900</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>hvgs <span class="ot">&lt;-</span> sem<span class="sc">@</span>assays<span class="sc">$</span>RNA<span class="sc">@</span>var.features</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="do">### Returns a Seurat-style DimReduc object with </span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="do">### hvgs x pcs feature loadings</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="do">### cells x pcs cell embeddings</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="do">### gene-length vector of the mean pearson of residuals</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="do">### gene-length vector of the standard deviation of pearson residuals</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>pcaobj <span class="ot">&lt;-</span> </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">sparse_quasipoisson_pca_seurat</span>(sem[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts[hvgs,]</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                               ,<span class="at">totalcounts =</span> tc</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                               ,<span class="at">grate =</span> genefreq[hvgs]</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>                               ,<span class="at">scale.max =</span> <span class="dv">10</span> <span class="do">## PCs reflect clipping pearson residuals &gt; 10 SDs above the mean pearson residual</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>                               ,<span class="at">do.scale =</span> <span class="cn">TRUE</span> <span class="do">## PCs reflect as if pearson residuals for each gene were scaled to have standard deviation=1</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>                               ,<span class="at">do.center =</span> <span class="cn">TRUE</span> <span class="do">## PCs reflect as if pearson residuals for each gene were centered to have mean=0</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                               )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="using-the-output-for-downstream-analysis" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="using-the-output-for-downstream-analysis"><span class="header-section-number">5.1</span> Using the output for downstream analysis</h3>
<p>Here we’ll take the <code>pcaobj</code> we created and add the “<code>DimReduc</code>” to our seurat object. We can use this for downstream Seurat package analysis. Then, we’ll create a UMAP from these PC results using a helper function <code>make_umap</code>, which will also return a cells x cells nearest-neighbors graph we’ll use for unsupervised clustering.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>umapobj <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">make_umap</span>(pcaobj)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsonpca"</span>]] <span class="ot">&lt;-</span> pcaobj<span class="sc">$</span>reduction.data</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsonumap"</span>]] <span class="ot">&lt;-</span> umapobj<span class="sc">$</span>ump  <span class="do">## umap</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsongraph"</span>]] <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">as.Graph</span>(umapobj<span class="sc">$</span>grph) <span class="do">## nearest neighbors / adjacency matrix used for unsupervised clustering</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>sem <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">FindClusters</span>(sem, <span class="at">graph =</span> <span class="st">"pearsongraph"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>sem<span class="sc">@</span>meta.data<span class="sc">$</span>pearson_clusters <span class="ot">&lt;-</span> sem<span class="sc">@</span>meta.data<span class="sc">$</span>seurat_clusters</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>umapplot <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">plot_umap</span>(<span class="at">umapreduc =</span> <span class="st">"pearsonumap"</span>, <span class="at">clustercol =</span> <span class="st">"pearson_clusters"</span>, <span class="at">semuse =</span> sem)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(umapplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="readmedata/umapplot.png" class="img-fluid figure-img" width="6000"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="batch-corrected-pearson-pca-using-sparse_quasipoisson_pca_seurat_batch" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="batch-corrected-pearson-pca-using-sparse_quasipoisson_pca_seurat_batch"><span class="header-section-number">6</span> Batch corrected Pearson PCA using <code>sparse_quasipoisson_pca_seurat_batch</code></h2>
<p>The syntax is very similar if we want to correct for a batch variable, in this case ‘patient’. A few extra arguments are the cell identifier <code>cellid_colname</code>, batch identifier <code>batch_variable</code>, and a data.frame <code>obs</code> which should include both of these columns.</p>
<p>We also re-compute gene frequency passing these same additional arguments. This returns a genes x batches matrix of gene frequencies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>genefreq_batch <span class="ot">&lt;-</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gene_frequency</span>(sem[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts, <span class="at">obs =</span> <span class="fu">data.table</span>(sem<span class="sc">@</span>meta.data)[,.(cell_ID, patient)]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>               ,<span class="at">cellid_colname =</span> <span class="st">"cell_ID"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>               ,<span class="at">batch_variable =</span> <span class="st">"patient"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>Matrix<span class="sc">::</span><span class="fu">colSums</span>(genefreq_batch)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="do">### Returns a Seurat-style DimReduc object with </span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="do">### hvgs x pcs feature loadings</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="do">### cells x pcs cell embeddings</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="do">### gene-length vector of the mean pearson of residuals</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="do">### gene-length vector of the standard deviation of pearson residuals</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>pcaobj_batch <span class="ot">&lt;-</span> </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="fu">sparse_quasipoisson_pca_seurat_batch</span>(sem[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts[hvgs,]</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">totalcounts =</span> tc</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">grate =</span> genefreq_batch[hvgs,] <span class="do">##</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">obs =</span><span class="fu">data.table</span>(sem<span class="sc">@</span>meta.data)[,.(cell_ID, patient)] </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">batch_variable =</span> <span class="st">"patient"</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">cellid_colname =</span> <span class="st">"cell_ID"</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">scale.max =</span> <span class="dv">10</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">do.scale =</span> <span class="cn">TRUE</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">do.center =</span> <span class="cn">TRUE</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>                                     )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="using-the-output-for-downstream-analysis-1" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="using-the-output-for-downstream-analysis-1"><span class="header-section-number">6.1</span> Using the output for downstream analysis</h3>
<p>Here again we’ll take the <code>pcaobj_batch</code> object and use it to create a UMAP and perform unsupervised clustering.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>umapobj_batch <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">make_umap</span>(pcaobj_batch)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsonbatchpca"</span>]] <span class="ot">&lt;-</span> pcaobj_batch<span class="sc">$</span>reduction.data</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsonbatchumap"</span>]] <span class="ot">&lt;-</span> umapobj_batch<span class="sc">$</span>ump</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsonbatchgraph"</span>]] <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">as.Graph</span>(umapobj_batch<span class="sc">$</span>grph) <span class="do">## nearest neighbors / adjacency matrix used for unsupervised clustering</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>sem <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">FindClusters</span>(sem, <span class="at">graph =</span> <span class="st">"pearsonbatchgraph"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>sem<span class="sc">@</span>meta.data<span class="sc">$</span>pearson_clusters_batch <span class="ot">&lt;-</span> sem<span class="sc">@</span>meta.data<span class="sc">$</span>seurat_clusters</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>umapplotbatch <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">plot_umap</span>(<span class="at">umapreduc =</span> <span class="st">"pearsonbatchumap"</span>, <span class="at">clustercol =</span> <span class="st">"pearson_clusters_batch"</span>, <span class="at">semuse =</span> sem)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(umapplotbatch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="readmedata/umapplotbatch.png" class="img-fluid figure-img" width="6000"></p>
</figure>
</div>
</div>
</div>
<p>For this dataset, there are epithelial cell clusters which are fairly specific to each patient. This is expected in cancer tissue and may not warrant any batch correction.</p>
<p>For sake of demonstration here, however, we can visualize how the batch variable ‘patient’ separates more on the UMAP before vs.&nbsp;after batch-correction, where patient clusters have higher overlap in UMAP space.</p>
<p>In case of known batch effects, multiple methods of correction may be considered, and the best performing method may well vary from dataset to dataset. One alternative recommended method which often works well is ‘Harmony’, described in this <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/batchcorrection/">post</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>umapplot_patient_batch <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">plot_umap</span>(<span class="at">umapreduc =</span> <span class="st">"pearsonbatchumap"</span>, <span class="at">clustercol =</span> <span class="st">"patient"</span>, <span class="at">semuse =</span> sem,<span class="at">alpha=</span><span class="fl">0.1</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>umapplot_patient <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">plot_umap</span>(<span class="at">umapreduc =</span> <span class="st">"pearsonumap"</span>, <span class="at">clustercol =</span> <span class="st">"patient"</span>, <span class="at">semuse =</span> sem,<span class="at">alpha=</span><span class="fl">0.1</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>cp <span class="ot">&lt;-</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(umapplot_patient_batch <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"UMAP using batch-corrected pearson PCs"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                   ,umapplot_patient <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"UMAP using pearson PCs"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                   ,<span class="at">nrow=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">'white'</span>,<span class="at">color=</span><span class="st">'white'</span>)) <span class="sc">+</span> </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  cowplot<span class="sc">::</span><span class="fu">panel_border</span>(<span class="at">remove=</span><span class="cn">TRUE</span>)  </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="readmedata/umapplot_patient_compare.png" class="img-fluid figure-img" width="6000"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="pearson-pca-for-multiomic-data-using-sparse_quasipoisson_pca_seurat_multiomic" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="pearson-pca-for-multiomic-data-using-sparse_quasipoisson_pca_seurat_multiomic"><span class="header-section-number">7</span> Pearson PCA for multiomic data using <code>sparse_quasipoisson_pca_seurat_multiomic</code></h2>
<p>Below we’ll use a breast cancer dataset with WTx RNA + 64-plex protein to demo multiomic PCA and downstream analysis.</p>
<section id="reading-in-rna-and-protein-datasets" class="level5">
<h5 class="anchored" data-anchor-id="reading-in-rna-and-protein-datasets">Reading in RNA and protein datasets</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Note, using a v3-style Seurat Object below, i.e., `sem[["RNA"]]@counts`</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="do">## For v5-style, the syntax would be like `sem[["RNA"]]$counts`</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">Seurat.object.assay.version =</span> <span class="st">"v3"</span>)  </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>sem_protein <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"Breast/sem_protein.rds"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>sem_rna <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"Breast/sem_rna.rds"</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>sem_rna <span class="ot">&lt;-</span> <span class="fu">subset</span>(sem_rna, nCount_RNA <span class="sc">&gt;=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="normalizing-the-protein-data" class="level5">
<h5 class="anchored" data-anchor-id="normalizing-the-protein-data">Normalizing the protein data</h5>
<p>The <code>sparse_quasipoisson_pca_seurat_multiomic</code> function won’t do any special normalization to the protein data, so the data should be normalized going in. Here we’ll use pearson residuals from a gamma regression model as a normalization method, although other reasonable methods might be considered and left to the user’s disgression.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## normalize each protein taking pearson residuals from gamma generalized linear model.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>pgamm <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">pearson_normalize_gamma_glm</span>(<span class="fu">as.matrix</span>(sem_protein[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                                                   ,<span class="at">upper_q_thresh =</span> <span class="fl">0.99</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                                                   ,<span class="at">lower_q_thresh =</span> <span class="fl">0.01</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                                                   )</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="do">### add a '_protein' suffix to the protein names - helps differentiate proteins and RNA's with the same name. </span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(pgamm) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">rownames</span>(pgamm), <span class="st">"_protein"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>pgamm[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="do">## normalized protein data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>                      c_1_100_1  c_1_100_10 c_1_100_100 c_1_100_1000
4-1BB_protein        -0.1592977  0.03704303  0.48381341 -0.054332422
B7-H3_protein        -0.2409877 -0.08788226  0.08696422  0.006506165
Bcl-2_protein        -0.3037842 -0.26226294  0.26853206 -0.278620332
Beta-catenin_protein -0.7617500 -0.06967635  0.14393940 -0.430273385
CCR7_protein         -0.1174789 -0.21163185  0.24066117  5.283740671
                     c_1_100_1001
4-1BB_protein          -0.0686042
B7-H3_protein           0.8100425
Bcl-2_protein          -0.2199310
Beta-catenin_protein   -0.3508033
CCR7_protein           -0.3366898</code></pre>
</div>
</div>
</section>
<section id="pca-analysis-derived-from-the-joint-covariance-matrix-of-the-the-proteins-and-rnas" class="level5">
<h5 class="anchored" data-anchor-id="pca-analysis-derived-from-the-joint-covariance-matrix-of-the-the-proteins-and-rnas">PCA analysis derived from the joint covariance matrix of the the proteins and RNAs</h5>
<p>First we’ll identify a subset of highly variable genes from the RNA data. Then , we’ll pass in the RNA counts matrix and normalized protein matrix to get the PCA.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## select genes from RNA data to use for PCA analysis.</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Will take the top 2k features as well as any pre-defined immune celltyping markers from HieraType</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>sem_rna <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">FindVariableFeatures</span>(sem_rna, <span class="at">nfeatures =</span> <span class="dv">2000</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>use_genes <span class="ot">&lt;-</span> <span class="fu">c</span>(sem_rna<span class="sc">@</span>assays<span class="sc">$</span>RNA<span class="sc">@</span>var.features)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="do">### total counts and gene frequency from RNA data computed across full dataset</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>tc <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">colSums</span>(sem_rna[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>genefreq <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">gene_frequency</span>(sem_rna[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="do">### Principal components derived from the combined covariance matrix of pearson residual normalized RNA and protein.</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>pcaobj_multiomics <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">sparse_quasipoisson_pca_seurat_multiomic</span>(sem_rna[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts[use_genes,] <span class="do">## raw counts matrix for hvgs</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">totalcounts =</span> tc</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">grate =</span> genefreq[use_genes]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">xother =</span> pgamm <span class="do">## normalized protein</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">do.scale =</span> <span class="cn">TRUE</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">do.center =</span> <span class="cn">TRUE</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">scale.max =</span> <span class="dv">10</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">ncores =</span> <span class="dv">1</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>PC_ 1 
Positive:  CD127_protein, pan-RAS_protein, p53_protein, EGFR_protein, TCF7_protein, NF-kB p65_protein, Channel-PanCK_protein, CTLA4_protein, EpCAM_protein, Beta-catenin_protein 
       LAMP1_protein, Ki-67_protein, AZGP1, FASN, SERHL2, DBI, KRT19, CD138_protein, PIP, NAMPT 
Negative:  CD39_protein, CD16_protein, CD40_protein, CD45_protein, VIM, CD4_protein, SPARC, CD74, COL1A1, COL3A1 
       HLA-DRB1, COL1A2, STING_protein, HLA-DRA, CTSB, CST3, SMA_protein, APOE, Vimentin_protein, ICAM1_protein 
PC_ 2 
Positive:  KRT19, AFMID, SERHL2, KRT8, FOXP3_protein, p53_protein, KRT7, CYP1B1, IgD_protein, LAG3_protein 
       ALDOA, MLPH, XBP1, NDRG1, CD24, CD123_protein, PGK1, Her2_protein, Channel-PanCK_protein, CD56_protein 
Negative:  H3C15, H4C14, H4C11, H3-7, H2BC4, H3C2, H4C12, H3C13, H2AC18, H2BC18 
       H3C10, H1-2, H3C7, H2BC9, H2AC16, H1-5, H2BC12L, H2AC11, H3C11, H3C8 
PC_ 3 
Positive:  CD34_protein, CD123_protein, CD31_protein, COL4A1, SPARC, IGFBP7, COL4A2, PLVAP, GZMB_protein, SMA_protein 
       CD56_protein, HSPG2, LAG3_protein, FOXP3_protein, COL3A1, COL1A2, COL1A1, IgD_protein, LAMA4, COL6A2 
Negative:  HLA-DRB1, CD74, HLA-DRA, APOE, Channel-CD68_protein, CTSD, HLA-DR_protein, LYZ, CD11c_protein, HLA-DQB1 
       IFI30, CD68_protein, APOC1, HLA-DPA1, C1QC, GPNMB, CD45_protein, C1QB, HLA-DQA1, CTSB 
PC_ 4 
Positive:  PD-L2_protein, GITR_protein, FOXP3_protein, 4-1BB_protein, LAG3_protein, CD56_protein, GZMB_protein, COL1A1, iNOS_protein, IgD_protein 
       Her2_protein, COL1A2, COL3A1, AEBP1, PD-1_protein, GZMA_protein, LUM, CD11b_protein, FN1, COL12A1 
Negative:  PLVAP, CD34_protein, CD31_protein, COL4A1, A2M, EGFL7, AQP1, FLT1, KDR, COL4A2 
       HSPG2, SHANK3, PODXL, PECAM1, ENG, CD34, MCAM, ECSCR, INSR, NHERF2 
PC_ 5 
Positive:  COL1A1, COL1A2, COL3A1, FN1, AEBP1, POSTN, LUM, COL6A3, COL12A1, C1S 
       THBS2, FBN1, SULF1, COL6A1, COL5A1, HTRA3, SFRP2, EpCAM_protein, Beta-catenin_protein, CTHRC1 
Negative:  CD123_protein, GZMB_protein, FOXP3_protein, PD-L2_protein, LAG3_protein, iNOS_protein, CD56_protein, 4-1BB_protein, Her2_protein, GITR_protein 
       IgD_protein, CD31_protein, CD11b_protein, CD34_protein, CD68_protein, GZMA_protein, PD-1_protein, STING_protein, A2M, PLVAP </code></pre>
</div>
</div>
</section>
<section id="using-the-output-for-downstream-analysis-2" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="using-the-output-for-downstream-analysis-2"><span class="header-section-number">7.1</span> Using the output for downstream analysis</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>umapobj_multiomics <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">make_umap</span>(pcaobj_multiomics)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>sem_rna[[<span class="st">"multiumap"</span>]] <span class="ot">&lt;-</span> umapobj_multiomics<span class="sc">$</span>ump</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>sem_rna[[<span class="st">"multigrph"</span>]] <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">as.Graph</span>(umapobj_multiomics<span class="sc">$</span>grph[<span class="fu">colnames</span>(sem_rna),<span class="fu">colnames</span>(sem_rna)])</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>sem_rna <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">FindClusters</span>(sem_rna, <span class="at">graph.name=</span><span class="st">"multigrph"</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>sem_rna<span class="sc">@</span>meta.data<span class="sc">$</span>clusters_multi_unsup <span class="ot">&lt;-</span> sem_rna<span class="sc">@</span>meta.data<span class="sc">$</span>seurat_clusters</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>xyp_multi_unsup <span class="ot">&lt;-</span> <span class="fu">xyplot</span>(<span class="st">"clusters_multi_unsup"</span>, <span class="at">metadata =</span> sem_rna<span class="sc">@</span>meta.data, <span class="at">ptsize =</span> <span class="fl">0.05</span>) <span class="sc">+</span> <span class="fu">coord_fixed</span>()</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(xyp_multi_unsup)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="readmedata/xyp_multi_unsup.png" class="img-fluid figure-img" width="2640"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>umapp <span class="ot">&lt;-</span> <span class="fu">plot_umap</span>(<span class="at">umapreduc =</span> <span class="st">"multiumap"</span>, <span class="at">clustercol =</span> <span class="st">"clusters_multi_unsup"</span>, <span class="at">semuse =</span> sem_rna)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(umapp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="readmedata/umapp_multi.png" class="img-fluid figure-img" width="2640"></p>
</figure>
</div>
</div>
</div>
<section id="rna-and-protein-marker-heatmaps" class="level4" data-number="7.1.1">
<h4 data-number="7.1.1" class="anchored" data-anchor-id="rna-and-protein-marker-heatmaps"><span class="header-section-number">7.1.1</span> RNA and protein marker heatmaps</h4>
<p>Below we’ll look at a couple of marker heatmaps for these unsupervised clusters. These functions below use the <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/HieraType">HieraType package</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#remotes::install_github("Nanostring-Biostats/CosMx-Analysis-Scratch-Space", </span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                        subdir = "_code/HieraType", ref = "Main")</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(HieraType)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>fctbl_rna <span class="ot">&lt;-</span> <span class="fu">clusterwise_foldchange_metrics</span>(sem_rna[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts[use_genes,]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                                            ,<span class="at">totalcounts =</span> tc</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                                            ,<span class="at">metadata =</span> sem_rna<span class="sc">@</span>meta.data</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                                            ,<span class="at">cluster_column =</span> <span class="st">"clusters_multi_unsup"</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                                            )</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>hm_rna <span class="ot">&lt;-</span> <span class="fu">add_ncells</span>(<span class="fu">marker_heatmap</span>(fctbl_rna)) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"rna heatmap"</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hm_rna)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="wider-image">
<p><img src="./readmedata/hm_rna_multi.png" alt="Wide Image"></p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fctbl_protein <span class="ot">&lt;-</span> HieraType<span class="sc">::</span><span class="fu">clusterwise_foldchange_metrics_protein</span>(sem_protein[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts[,<span class="fu">rownames</span>(sem_rna<span class="sc">@</span>meta.data)]</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                                                        ,<span class="at">metadata =</span> sem_rna<span class="sc">@</span>meta.data</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                                                        ,<span class="at">cluster_column =</span> <span class="st">"clusters_multi_unsup"</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                                                        ,<span class="at">propd =</span> (pgamm[,<span class="fu">rownames</span>(sem_rna<span class="sc">@</span>meta.data)] <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                                            )</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>hm_protein <span class="ot">&lt;-</span> <span class="fu">add_ncells</span>(<span class="fu">marker_heatmap</span>(fctbl_protein)) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"protein heatmap"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hm_protein)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="wider-image">
<p><img src="./readmedata/hm_protein_multi.png" alt="Wide Image"></p>
</div>


<!-- -->

</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/nanostring-biostats\.github\.io\/CosMx-Analysis-Scratch-Space");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb18" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "scPearsonPCA: An R package for efficient Principal Components decomposition of pearson residual normalized single cell data"</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Dan McGuire</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    orcid: 0009-0006-0286-9625</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">      - ref: nstg</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">      - ref: dan11mcguire</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="an">toc-title:</span><span class="co"> Contents</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 3</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="an">toc-expand:</span><span class="co"> 2</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="an">toc-location:</span><span class="co"> left</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="an">number-sections:</span><span class="co"> true</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="an">number-depth:</span><span class="co"> 4</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2025-10-30"</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">  - normalization</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">  - pearson residuals</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">  - principal component analysis</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co">  - batch correction</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co">  - multiomics</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> readmedata/umapplot.png</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Better dimension reduction techniques for spatial data."</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="an">draft:</span><span class="co"> false</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co">  html: </span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>Here we present a package for better dimension reduction in spatial data.</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>Pearson residuals can be an effective normalization method for spatially-resolved transcriptomic data. However, the normalized data matrix produced is **dense** with nearly all values non-zero. This limits the usability of pearson residuals for high-plex or large datasets where computing memory can be a limiting factor.</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>However, the principal component (PC) decomposition of quasi-poisson pearson residuals can be computed directly from a sparse counts matrix and a few easy-to-calculate summary statistics. The R package <span class="co">[</span><span class="ot">scPearsonPCA</span><span class="co">](https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/scPearsonPCA)</span> enables this PC decomposition, including the returning the PCs as if the normalized data had been centered, scaled, and influential values clipped according to common best practices for PC analysis.</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>In this post we demonstrate a few quick examples for the package, as well as how to use the PCA results returned for common downstream analyses like UMAP and unsupervised clustering.</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="fu">## Installation</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>You can install <span class="in">`scPearsonPCA`</span> using the remotes package</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="in">remotes::install_github("Nanostring-Biostats/CosMx-Analysis-Scratch-Space",</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="in">                         subdir = "_code/scPearsonPCA", ref = "Main")</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="fu">## Most used functions</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`sparse_quasipoisson_pca_seurat()`</span> This function takes a counts matrix as input and returns a PCA Seurat-style reduction by default. The PCA is based on quasi-poisson pearson residual normalization. Similar to a NormalizeData $\rightarrow$ ScaleData $\rightarrow$ RunPCA workflow, arguments available for returning the PCA as if data were centered and scaled, with extreme values clipped.</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`sparse_quasipoisson_pca_seurat_batch()`</span> This function employs a batch-correction method to PCA, provided there is a single categorical variable for 'batch'. Examples could be 'patient', 'slide_id', 'tma_id', etc. Akin to a quasipoisson glm-based correction with the batch variable used as a covariate, the basic idea here is that gene frequencies are computed separately by batch rather than across the full sample.</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span><span class="in">`sparse_quasipoisson_pca_seurat_multiomic()`</span> This function is useful for getting the PCA decomposition from same-cell multiomic data.  Here we assume we have two matrices, a sparse RNA counts matrix <span class="in">`x`</span>, </span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>and a (possibly dense,lower dimensional) matrix of already-normalized protein expression <span class="in">`xother`</span>. </span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>We want to be able to get PCA from the combined dataset, while still applying effective normalization to the RNA data.  This function uses similar algebraic shortcuts which allow for efficient calculation of PCA from the **covariance matrix** of pearson residuals from the RNA, by deriving PCA from the combined covariance matrix of pre-normalized protein, and pearson-normalized RNA.  We'll demo a full example below using a multiomics breast cancer dataset.</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="fu">## Quickstart / Example Usage</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>First we'll read in our Seurat object dataset. This is 960-plex NSCLC tissue.</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table); <span class="fu">setDTthreads</span>(<span class="dv">1</span>)</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scPearsonPCA)</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>datadir <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"extdata"</span>, <span class="at">package=</span><span class="st">"scPearsonPCA"</span>)</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>sem <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(datadir, <span class="st">"/seurat_obj_nsclc.rds"</span>))</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>sem <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"seurat_obj_nsclc.rds"</span>)</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pearson PCA using `sparse_quasipoisson_pca_seurat`</span></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>We typically recommend to use up to 2,000-3,000 highly variable genes for generating PCA results.</span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a>A few summary stats used as input for calculating pearson-normalized PCs:</span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`tc`</span> is the total counts per cell across all genes.</span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`genefreq`</span> is the proportion of transcript calls for each gene across all cells.</span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>In general, it's recommended to calculate these summary stats based on all genes rather than a subset of highly variable genes. While this dataset is only 960-plex, the code below uses 900 highly-variable genes as a demonstration for a basic workflow.</span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a>tc <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">colSums</span>(sem[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts) <span class="do">## total counts per cell (across all genes)</span></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a>genefreq <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">gene_frequency</span>(sem[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts) <span class="do">## gene frequency (across all cells)</span></span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(genefreq)<span class="sc">==</span><span class="dv">1</span> <span class="co"># TRUE</span></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a>sem <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">FindVariableFeatures</span>(sem, <span class="at">nfeatures =</span> <span class="dv">900</span>)</span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a>hvgs <span class="ot">&lt;-</span> sem<span class="sc">@</span>assays<span class="sc">$</span>RNA<span class="sc">@</span>var.features</span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a><span class="do">### Returns a Seurat-style DimReduc object with </span></span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a><span class="do">### hvgs x pcs feature loadings</span></span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a><span class="do">### cells x pcs cell embeddings</span></span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a><span class="do">### gene-length vector of the mean pearson of residuals</span></span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a><span class="do">### gene-length vector of the standard deviation of pearson residuals</span></span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a>pcaobj <span class="ot">&lt;-</span> </span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a><span class="fu">sparse_quasipoisson_pca_seurat</span>(sem[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts[hvgs,]</span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a>                               ,<span class="at">totalcounts =</span> tc</span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a>                               ,<span class="at">grate =</span> genefreq[hvgs]</span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a>                               ,<span class="at">scale.max =</span> <span class="dv">10</span> <span class="do">## PCs reflect clipping pearson residuals &gt; 10 SDs above the mean pearson residual</span></span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a>                               ,<span class="at">do.scale =</span> <span class="cn">TRUE</span> <span class="do">## PCs reflect as if pearson residuals for each gene were scaled to have standard deviation=1</span></span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a>                               ,<span class="at">do.center =</span> <span class="cn">TRUE</span> <span class="do">## PCs reflect as if pearson residuals for each gene were centered to have mean=0</span></span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a>                               )</span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a><span class="fu">### Using the output for downstream analysis</span></span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a>Here we'll take the <span class="in">`pcaobj`</span> we created and add the "<span class="in">`DimReduc`</span>" to our seurat object. We can use this for downstream Seurat package analysis. Then, we'll create a UMAP from these PC results using a helper function <span class="in">`make_umap`</span>, which will also return a cells x cells nearest-neighbors graph we'll use for unsupervised clustering.</span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-145"><a href="#cb18-145" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-146"><a href="#cb18-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a>umapobj <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">make_umap</span>(pcaobj)</span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsonpca"</span>]] <span class="ot">&lt;-</span> pcaobj<span class="sc">$</span>reduction.data</span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsonumap"</span>]] <span class="ot">&lt;-</span> umapobj<span class="sc">$</span>ump  <span class="do">## umap</span></span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsongraph"</span>]] <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">as.Graph</span>(umapobj<span class="sc">$</span>grph) <span class="do">## nearest neighbors / adjacency matrix used for unsupervised clustering</span></span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a>sem <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">FindClusters</span>(sem, <span class="at">graph =</span> <span class="st">"pearsongraph"</span>)</span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a>sem<span class="sc">@</span>meta.data<span class="sc">$</span>pearson_clusters <span class="ot">&lt;-</span> sem<span class="sc">@</span>meta.data<span class="sc">$</span>seurat_clusters</span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a>umapplot <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">plot_umap</span>(<span class="at">umapreduc =</span> <span class="st">"pearsonumap"</span>, <span class="at">clustercol =</span> <span class="st">"pearson_clusters"</span>, <span class="at">semuse =</span> sem)</span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(umapplot)</span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(pcaobj, <span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/pcaobj.rds"</span>)</span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(umapobj, <span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/umapobj.rds"</span>)</span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/umapplot.png"</span>, <span class="at">plot=</span>umapplot, <span class="at">height =</span> <span class="dv">720</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">10</span>), <span class="at">width =</span> <span class="dv">922</span> <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">10</span>),<span class="at">units=</span><span class="st">'px'</span>)</span>
<span id="cb18-168"><a href="#cb18-168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-169"><a href="#cb18-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-175"><a href="#cb18-175" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.show: "hold"</span></span>
<span id="cb18-176"><a href="#cb18-176" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: "6000px"</span></span>
<span id="cb18-177"><a href="#cb18-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-178"><a href="#cb18-178" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"readmedata/umapplot.png"</span>)</span>
<span id="cb18-179"><a href="#cb18-179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-180"><a href="#cb18-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-181"><a href="#cb18-181" aria-hidden="true" tabindex="-1"></a><span class="fu">## Batch corrected Pearson PCA using `sparse_quasipoisson_pca_seurat_batch`</span></span>
<span id="cb18-182"><a href="#cb18-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-183"><a href="#cb18-183" aria-hidden="true" tabindex="-1"></a>The syntax is very similar if we want to correct for a batch variable, in this case 'patient'. A few extra arguments are the cell identifier <span class="in">`cellid_colname`</span>, batch identifier <span class="in">`batch_variable`</span>, and a data.frame <span class="in">`obs`</span> which should include both of these columns.</span>
<span id="cb18-184"><a href="#cb18-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-185"><a href="#cb18-185" aria-hidden="true" tabindex="-1"></a>We also re-compute gene frequency passing these same additional arguments. This returns a genes x batches matrix of gene frequencies.</span>
<span id="cb18-186"><a href="#cb18-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-189"><a href="#cb18-189" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-190"><a href="#cb18-190" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-191"><a href="#cb18-191" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-192"><a href="#cb18-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-193"><a href="#cb18-193" aria-hidden="true" tabindex="-1"></a>genefreq_batch <span class="ot">&lt;-</span> </span>
<span id="cb18-194"><a href="#cb18-194" aria-hidden="true" tabindex="-1"></a><span class="fu">gene_frequency</span>(sem[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts, <span class="at">obs =</span> <span class="fu">data.table</span>(sem<span class="sc">@</span>meta.data)[,.(cell_ID, patient)]</span>
<span id="cb18-195"><a href="#cb18-195" aria-hidden="true" tabindex="-1"></a>               ,<span class="at">cellid_colname =</span> <span class="st">"cell_ID"</span></span>
<span id="cb18-196"><a href="#cb18-196" aria-hidden="true" tabindex="-1"></a>               ,<span class="at">batch_variable =</span> <span class="st">"patient"</span>)</span>
<span id="cb18-197"><a href="#cb18-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-198"><a href="#cb18-198" aria-hidden="true" tabindex="-1"></a>Matrix<span class="sc">::</span><span class="fu">colSums</span>(genefreq_batch)</span>
<span id="cb18-199"><a href="#cb18-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-200"><a href="#cb18-200" aria-hidden="true" tabindex="-1"></a><span class="do">### Returns a Seurat-style DimReduc object with </span></span>
<span id="cb18-201"><a href="#cb18-201" aria-hidden="true" tabindex="-1"></a><span class="do">### hvgs x pcs feature loadings</span></span>
<span id="cb18-202"><a href="#cb18-202" aria-hidden="true" tabindex="-1"></a><span class="do">### cells x pcs cell embeddings</span></span>
<span id="cb18-203"><a href="#cb18-203" aria-hidden="true" tabindex="-1"></a><span class="do">### gene-length vector of the mean pearson of residuals</span></span>
<span id="cb18-204"><a href="#cb18-204" aria-hidden="true" tabindex="-1"></a><span class="do">### gene-length vector of the standard deviation of pearson residuals</span></span>
<span id="cb18-205"><a href="#cb18-205" aria-hidden="true" tabindex="-1"></a>pcaobj_batch <span class="ot">&lt;-</span> </span>
<span id="cb18-206"><a href="#cb18-206" aria-hidden="true" tabindex="-1"></a><span class="fu">sparse_quasipoisson_pca_seurat_batch</span>(sem[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts[hvgs,]</span>
<span id="cb18-207"><a href="#cb18-207" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">totalcounts =</span> tc</span>
<span id="cb18-208"><a href="#cb18-208" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">grate =</span> genefreq_batch[hvgs,] <span class="do">##</span></span>
<span id="cb18-209"><a href="#cb18-209" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">obs =</span><span class="fu">data.table</span>(sem<span class="sc">@</span>meta.data)[,.(cell_ID, patient)] </span>
<span id="cb18-210"><a href="#cb18-210" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">batch_variable =</span> <span class="st">"patient"</span></span>
<span id="cb18-211"><a href="#cb18-211" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">cellid_colname =</span> <span class="st">"cell_ID"</span></span>
<span id="cb18-212"><a href="#cb18-212" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">scale.max =</span> <span class="dv">10</span></span>
<span id="cb18-213"><a href="#cb18-213" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">do.scale =</span> <span class="cn">TRUE</span></span>
<span id="cb18-214"><a href="#cb18-214" aria-hidden="true" tabindex="-1"></a>                                     ,<span class="at">do.center =</span> <span class="cn">TRUE</span></span>
<span id="cb18-215"><a href="#cb18-215" aria-hidden="true" tabindex="-1"></a>                                     )</span>
<span id="cb18-216"><a href="#cb18-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-217"><a href="#cb18-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-218"><a href="#cb18-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-219"><a href="#cb18-219" aria-hidden="true" tabindex="-1"></a><span class="fu">### Using the output for downstream analysis</span></span>
<span id="cb18-220"><a href="#cb18-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-221"><a href="#cb18-221" aria-hidden="true" tabindex="-1"></a>Here again we'll take the <span class="in">`pcaobj_batch`</span> object and use it to create a UMAP and perform unsupervised clustering.</span>
<span id="cb18-222"><a href="#cb18-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-225"><a href="#cb18-225" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-226"><a href="#cb18-226" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-227"><a href="#cb18-227" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-228"><a href="#cb18-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-229"><a href="#cb18-229" aria-hidden="true" tabindex="-1"></a>umapobj_batch <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">make_umap</span>(pcaobj_batch)</span>
<span id="cb18-230"><a href="#cb18-230" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsonbatchpca"</span>]] <span class="ot">&lt;-</span> pcaobj_batch<span class="sc">$</span>reduction.data</span>
<span id="cb18-231"><a href="#cb18-231" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsonbatchumap"</span>]] <span class="ot">&lt;-</span> umapobj_batch<span class="sc">$</span>ump</span>
<span id="cb18-232"><a href="#cb18-232" aria-hidden="true" tabindex="-1"></a>sem[[<span class="st">"pearsonbatchgraph"</span>]] <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">as.Graph</span>(umapobj_batch<span class="sc">$</span>grph) <span class="do">## nearest neighbors / adjacency matrix used for unsupervised clustering</span></span>
<span id="cb18-233"><a href="#cb18-233" aria-hidden="true" tabindex="-1"></a>sem <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">FindClusters</span>(sem, <span class="at">graph =</span> <span class="st">"pearsonbatchgraph"</span>)</span>
<span id="cb18-234"><a href="#cb18-234" aria-hidden="true" tabindex="-1"></a>sem<span class="sc">@</span>meta.data<span class="sc">$</span>pearson_clusters_batch <span class="ot">&lt;-</span> sem<span class="sc">@</span>meta.data<span class="sc">$</span>seurat_clusters</span>
<span id="cb18-235"><a href="#cb18-235" aria-hidden="true" tabindex="-1"></a>umapplotbatch <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">plot_umap</span>(<span class="at">umapreduc =</span> <span class="st">"pearsonbatchumap"</span>, <span class="at">clustercol =</span> <span class="st">"pearson_clusters_batch"</span>, <span class="at">semuse =</span> sem)</span>
<span id="cb18-236"><a href="#cb18-236" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(umapplotbatch)</span>
<span id="cb18-237"><a href="#cb18-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-238"><a href="#cb18-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-241"><a href="#cb18-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-242"><a href="#cb18-242" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-243"><a href="#cb18-243" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-244"><a href="#cb18-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-245"><a href="#cb18-245" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(pcaobj_batch, <span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/pcaobj_batch.rds"</span>)</span>
<span id="cb18-246"><a href="#cb18-246" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(umapobj_batch, <span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/umapobj_batch.rds"</span>)</span>
<span id="cb18-247"><a href="#cb18-247" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/umapplotbatch.png"</span>, <span class="at">plot=</span>umapplotbatch, <span class="at">height =</span> <span class="dv">720</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">10</span>), <span class="at">width =</span> <span class="dv">922</span> <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">10</span>),<span class="at">units=</span><span class="st">'px'</span>)</span>
<span id="cb18-248"><a href="#cb18-248" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-249"><a href="#cb18-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-252"><a href="#cb18-252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-253"><a href="#cb18-253" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb18-254"><a href="#cb18-254" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-255"><a href="#cb18-255" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.show: "hold"</span></span>
<span id="cb18-256"><a href="#cb18-256" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: "6000px"</span></span>
<span id="cb18-257"><a href="#cb18-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-258"><a href="#cb18-258" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"readmedata/umapplotbatch.png"</span>)</span>
<span id="cb18-259"><a href="#cb18-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-260"><a href="#cb18-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-261"><a href="#cb18-261" aria-hidden="true" tabindex="-1"></a>For this dataset, there are epithelial cell clusters which are fairly specific to each patient. This is expected in cancer tissue and may not warrant any batch correction.</span>
<span id="cb18-262"><a href="#cb18-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-263"><a href="#cb18-263" aria-hidden="true" tabindex="-1"></a>For sake of demonstration here, however, we can visualize how the batch variable 'patient' separates more on the UMAP before vs. after batch-correction, where patient clusters have higher overlap in UMAP space.</span>
<span id="cb18-264"><a href="#cb18-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-265"><a href="#cb18-265" aria-hidden="true" tabindex="-1"></a>In case of known batch effects, multiple methods of correction may be considered, and the best performing method may well vary from dataset to dataset. One alternative recommended method which often works well is 'Harmony', described in this <span class="co">[</span><span class="ot">post</span><span class="co">](https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/batchcorrection/)</span>.</span>
<span id="cb18-266"><a href="#cb18-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-269"><a href="#cb18-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-270"><a href="#cb18-270" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-271"><a href="#cb18-271" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-272"><a href="#cb18-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-273"><a href="#cb18-273" aria-hidden="true" tabindex="-1"></a>umapplot_patient_batch <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">plot_umap</span>(<span class="at">umapreduc =</span> <span class="st">"pearsonbatchumap"</span>, <span class="at">clustercol =</span> <span class="st">"patient"</span>, <span class="at">semuse =</span> sem,<span class="at">alpha=</span><span class="fl">0.1</span>)</span>
<span id="cb18-274"><a href="#cb18-274" aria-hidden="true" tabindex="-1"></a>umapplot_patient <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">plot_umap</span>(<span class="at">umapreduc =</span> <span class="st">"pearsonumap"</span>, <span class="at">clustercol =</span> <span class="st">"patient"</span>, <span class="at">semuse =</span> sem,<span class="at">alpha=</span><span class="fl">0.1</span>)</span>
<span id="cb18-275"><a href="#cb18-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-276"><a href="#cb18-276" aria-hidden="true" tabindex="-1"></a>cp <span class="ot">&lt;-</span> </span>
<span id="cb18-277"><a href="#cb18-277" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(umapplot_patient_batch <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"UMAP using batch-corrected pearson PCs"</span>)</span>
<span id="cb18-278"><a href="#cb18-278" aria-hidden="true" tabindex="-1"></a>                   ,umapplot_patient <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"UMAP using pearson PCs"</span>)</span>
<span id="cb18-279"><a href="#cb18-279" aria-hidden="true" tabindex="-1"></a>                   ,<span class="at">nrow=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb18-280"><a href="#cb18-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">'white'</span>,<span class="at">color=</span><span class="st">'white'</span>)) <span class="sc">+</span> </span>
<span id="cb18-281"><a href="#cb18-281" aria-hidden="true" tabindex="-1"></a>  cowplot<span class="sc">::</span><span class="fu">panel_border</span>(<span class="at">remove=</span><span class="cn">TRUE</span>)  </span>
<span id="cb18-282"><a href="#cb18-282" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cp)</span>
<span id="cb18-283"><a href="#cb18-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-284"><a href="#cb18-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-287"><a href="#cb18-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-288"><a href="#cb18-288" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-289"><a href="#cb18-289" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-290"><a href="#cb18-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-291"><a href="#cb18-291" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/umapplot_patient_compare.png"</span>, <span class="at">plot=</span>cp, <span class="at">height =</span> <span class="dv">687</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">10</span>), <span class="at">width =</span> <span class="dv">1471</span> <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">10</span>),<span class="at">units=</span><span class="st">'px'</span>)</span>
<span id="cb18-292"><a href="#cb18-292" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-293"><a href="#cb18-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-296"><a href="#cb18-296" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-297"><a href="#cb18-297" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb18-298"><a href="#cb18-298" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-299"><a href="#cb18-299" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.show: "hold"</span></span>
<span id="cb18-300"><a href="#cb18-300" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: "6000px"</span></span>
<span id="cb18-301"><a href="#cb18-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-302"><a href="#cb18-302" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"readmedata/umapplot_patient_compare.png"</span>)</span>
<span id="cb18-303"><a href="#cb18-303" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-304"><a href="#cb18-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-305"><a href="#cb18-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-306"><a href="#cb18-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-307"><a href="#cb18-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-308"><a href="#cb18-308" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pearson PCA for multiomic data using `sparse_quasipoisson_pca_seurat_multiomic`</span></span>
<span id="cb18-309"><a href="#cb18-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-310"><a href="#cb18-310" aria-hidden="true" tabindex="-1"></a>Below we'll use a breast cancer dataset with WTx RNA + 64-plex protein to demo multiomic PCA and downstream analysis.</span>
<span id="cb18-311"><a href="#cb18-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-312"><a href="#cb18-312" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Reading in RNA and protein datasets</span></span>
<span id="cb18-315"><a href="#cb18-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-316"><a href="#cb18-316" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-317"><a href="#cb18-317" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-318"><a href="#cb18-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-319"><a href="#cb18-319" aria-hidden="true" tabindex="-1"></a><span class="do">## Note, using a v3-style Seurat Object below, i.e., `sem[["RNA"]]@counts`</span></span>
<span id="cb18-320"><a href="#cb18-320" aria-hidden="true" tabindex="-1"></a><span class="do">## For v5-style, the syntax would be like `sem[["RNA"]]$counts`</span></span>
<span id="cb18-321"><a href="#cb18-321" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">Seurat.object.assay.version =</span> <span class="st">"v3"</span>)  </span>
<span id="cb18-322"><a href="#cb18-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-323"><a href="#cb18-323" aria-hidden="true" tabindex="-1"></a>sem_protein <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"Breast/sem_protein.rds"</span>)</span>
<span id="cb18-324"><a href="#cb18-324" aria-hidden="true" tabindex="-1"></a>sem_rna <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"Breast/sem_rna.rds"</span>)</span>
<span id="cb18-325"><a href="#cb18-325" aria-hidden="true" tabindex="-1"></a>sem_rna <span class="ot">&lt;-</span> <span class="fu">subset</span>(sem_rna, nCount_RNA <span class="sc">&gt;=</span><span class="dv">100</span>)</span>
<span id="cb18-326"><a href="#cb18-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-327"><a href="#cb18-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-328"><a href="#cb18-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-329"><a href="#cb18-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-330"><a href="#cb18-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-333"><a href="#cb18-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-334"><a href="#cb18-334" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-335"><a href="#cb18-335" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-336"><a href="#cb18-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-337"><a href="#cb18-337" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">Seurat.object.assay.version =</span> <span class="st">"v3"</span>)  </span>
<span id="cb18-338"><a href="#cb18-338" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">load_all</span>(<span class="st">"~/data/dan/imputation_smoothing/HieraType_dev"</span>, <span class="at">export_all =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-339"><a href="#cb18-339" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">load_all</span>(<span class="st">"~/data/dan/scPearsonPCA"</span>, <span class="at">export_all =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-340"><a href="#cb18-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-341"><a href="#cb18-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-342"><a href="#cb18-342" aria-hidden="true" tabindex="-1"></a>sem_protein <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/data/multiomics_hackathon/Breast/sem_protein.rds"</span>)</span>
<span id="cb18-343"><a href="#cb18-343" aria-hidden="true" tabindex="-1"></a>sem_rna <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/data/multiomics_hackathon/Breast/sem_rna.rds"</span>)</span>
<span id="cb18-344"><a href="#cb18-344" aria-hidden="true" tabindex="-1"></a>sem_rna <span class="ot">&lt;-</span> <span class="fu">subset</span>(sem_rna, nCount_RNA <span class="sc">&gt;=</span><span class="dv">100</span>)</span>
<span id="cb18-345"><a href="#cb18-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-346"><a href="#cb18-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-347"><a href="#cb18-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-348"><a href="#cb18-348" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Normalizing the protein data</span></span>
<span id="cb18-349"><a href="#cb18-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-350"><a href="#cb18-350" aria-hidden="true" tabindex="-1"></a>The <span class="in">`sparse_quasipoisson_pca_seurat_multiomic`</span> function won't do any special normalization to the protein data, so the data should be normalized going in.</span>
<span id="cb18-351"><a href="#cb18-351" aria-hidden="true" tabindex="-1"></a>Here we'll use pearson residuals from a gamma regression model as a normalization method, although other reasonable methods might be considered and left to the user's disgression.</span>
<span id="cb18-352"><a href="#cb18-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-355"><a href="#cb18-355" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-356"><a href="#cb18-356" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-357"><a href="#cb18-357" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-358"><a href="#cb18-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-359"><a href="#cb18-359" aria-hidden="true" tabindex="-1"></a><span class="do">## normalize each protein taking pearson residuals from gamma generalized linear model.</span></span>
<span id="cb18-360"><a href="#cb18-360" aria-hidden="true" tabindex="-1"></a>pgamm <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">pearson_normalize_gamma_glm</span>(<span class="fu">as.matrix</span>(sem_protein[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts)</span>
<span id="cb18-361"><a href="#cb18-361" aria-hidden="true" tabindex="-1"></a>                                                   ,<span class="at">upper_q_thresh =</span> <span class="fl">0.99</span></span>
<span id="cb18-362"><a href="#cb18-362" aria-hidden="true" tabindex="-1"></a>                                                   ,<span class="at">lower_q_thresh =</span> <span class="fl">0.01</span></span>
<span id="cb18-363"><a href="#cb18-363" aria-hidden="true" tabindex="-1"></a>                                                   )</span>
<span id="cb18-364"><a href="#cb18-364" aria-hidden="true" tabindex="-1"></a><span class="do">### add a '_protein' suffix to the protein names - helps differentiate proteins and RNA's with the same name. </span></span>
<span id="cb18-365"><a href="#cb18-365" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(pgamm) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">rownames</span>(pgamm), <span class="st">"_protein"</span>)</span>
<span id="cb18-366"><a href="#cb18-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-367"><a href="#cb18-367" aria-hidden="true" tabindex="-1"></a>pgamm[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>] <span class="do">## normalized protein data</span></span>
<span id="cb18-368"><a href="#cb18-368" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-369"><a href="#cb18-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-372"><a href="#cb18-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-373"><a href="#cb18-373" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb18-374"><a href="#cb18-374" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-375"><a href="#cb18-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-376"><a href="#cb18-376" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">readRDS</span>(<span class="st">"readmedata/pgamm_head.rds"</span>))</span>
<span id="cb18-377"><a href="#cb18-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-378"><a href="#cb18-378" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-379"><a href="#cb18-379" aria-hidden="true" tabindex="-1"></a><span class="fu">##### PCA analysis derived from the joint covariance matrix of the the proteins and RNAs</span></span>
<span id="cb18-380"><a href="#cb18-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-381"><a href="#cb18-381" aria-hidden="true" tabindex="-1"></a>First we'll identify a subset of highly variable genes from the RNA data.  Then , we'll pass in the RNA counts matrix and normalized protein matrix to get the PCA.</span>
<span id="cb18-384"><a href="#cb18-384" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-385"><a href="#cb18-385" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-386"><a href="#cb18-386" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-387"><a href="#cb18-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-388"><a href="#cb18-388" aria-hidden="true" tabindex="-1"></a><span class="do">## select genes from RNA data to use for PCA analysis.</span></span>
<span id="cb18-389"><a href="#cb18-389" aria-hidden="true" tabindex="-1"></a><span class="do">## Will take the top 2k features as well as any pre-defined immune celltyping markers from HieraType</span></span>
<span id="cb18-390"><a href="#cb18-390" aria-hidden="true" tabindex="-1"></a>sem_rna <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">FindVariableFeatures</span>(sem_rna, <span class="at">nfeatures =</span> <span class="dv">2000</span>)</span>
<span id="cb18-391"><a href="#cb18-391" aria-hidden="true" tabindex="-1"></a>use_genes <span class="ot">&lt;-</span> <span class="fu">c</span>(sem_rna<span class="sc">@</span>assays<span class="sc">$</span>RNA<span class="sc">@</span>var.features)</span>
<span id="cb18-392"><a href="#cb18-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-393"><a href="#cb18-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-394"><a href="#cb18-394" aria-hidden="true" tabindex="-1"></a><span class="do">### total counts and gene frequency from RNA data computed across full dataset</span></span>
<span id="cb18-395"><a href="#cb18-395" aria-hidden="true" tabindex="-1"></a>tc <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">colSums</span>(sem_rna[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts)</span>
<span id="cb18-396"><a href="#cb18-396" aria-hidden="true" tabindex="-1"></a>genefreq <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">gene_frequency</span>(sem_rna[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts)</span>
<span id="cb18-397"><a href="#cb18-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-398"><a href="#cb18-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-399"><a href="#cb18-399" aria-hidden="true" tabindex="-1"></a><span class="do">### Principal components derived from the combined covariance matrix of pearson residual normalized RNA and protein.</span></span>
<span id="cb18-400"><a href="#cb18-400" aria-hidden="true" tabindex="-1"></a>pcaobj_multiomics <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">sparse_quasipoisson_pca_seurat_multiomic</span>(sem_rna[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts[use_genes,] <span class="do">## raw counts matrix for hvgs</span></span>
<span id="cb18-401"><a href="#cb18-401" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">totalcounts =</span> tc</span>
<span id="cb18-402"><a href="#cb18-402" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">grate =</span> genefreq[use_genes]</span>
<span id="cb18-403"><a href="#cb18-403" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">xother =</span> pgamm <span class="do">## normalized protein</span></span>
<span id="cb18-404"><a href="#cb18-404" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">do.scale =</span> <span class="cn">TRUE</span></span>
<span id="cb18-405"><a href="#cb18-405" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">do.center =</span> <span class="cn">TRUE</span></span>
<span id="cb18-406"><a href="#cb18-406" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">scale.max =</span> <span class="dv">10</span></span>
<span id="cb18-407"><a href="#cb18-407" aria-hidden="true" tabindex="-1"></a>                                                                       ,<span class="at">ncores =</span> <span class="dv">1</span></span>
<span id="cb18-408"><a href="#cb18-408" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-409"><a href="#cb18-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-410"><a href="#cb18-410" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-411"><a href="#cb18-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-414"><a href="#cb18-414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-415"><a href="#cb18-415" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-416"><a href="#cb18-416" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-417"><a href="#cb18-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-418"><a href="#cb18-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-419"><a href="#cb18-419" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(pgamm[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], <span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/pgamm_head.rds"</span>)<span class="do">## normalized protein data</span></span>
<span id="cb18-420"><a href="#cb18-420" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(pcaobj_multiomics, <span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/pcaobj_multi.rds"</span>)</span>
<span id="cb18-421"><a href="#cb18-421" aria-hidden="true" tabindex="-1"></a>pcaobj_multiomics <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"readmedata/pcaobj_multi.rds"</span>)</span>
<span id="cb18-422"><a href="#cb18-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-423"><a href="#cb18-423" aria-hidden="true" tabindex="-1"></a>msg <span class="ot">&lt;-</span> utils<span class="sc">::</span><span class="fu">capture.output</span>(<span class="fu">print</span>(</span>
<span id="cb18-424"><a href="#cb18-424" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> pcaobj_multiomics<span class="sc">$</span>reduction.data,</span>
<span id="cb18-425"><a href="#cb18-425" aria-hidden="true" tabindex="-1"></a>  <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb18-426"><a href="#cb18-426" aria-hidden="true" tabindex="-1"></a>  <span class="at">nfeatures =</span> <span class="dv">20</span></span>
<span id="cb18-427"><a href="#cb18-427" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb18-428"><a href="#cb18-428" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">paste</span>(msg, <span class="at">collapse =</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>))</span>
<span id="cb18-429"><a href="#cb18-429" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(msg, <span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/pca_multiomics_toppcs_msg.rds"</span>)</span>
<span id="cb18-430"><a href="#cb18-430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-433"><a href="#cb18-433" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-434"><a href="#cb18-434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-435"><a href="#cb18-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-438"><a href="#cb18-438" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-439"><a href="#cb18-439" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb18-440"><a href="#cb18-440" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-441"><a href="#cb18-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-442"><a href="#cb18-442" aria-hidden="true" tabindex="-1"></a>msg <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"readmedata/pca_multiomics_toppcs_msg.rds"</span>)</span>
<span id="cb18-443"><a href="#cb18-443" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">paste</span>(msg, <span class="at">collapse =</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>))</span>
<span id="cb18-444"><a href="#cb18-444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-445"><a href="#cb18-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-446"><a href="#cb18-446" aria-hidden="true" tabindex="-1"></a><span class="fu">### Using the output for downstream analysis</span></span>
<span id="cb18-447"><a href="#cb18-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-448"><a href="#cb18-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-451"><a href="#cb18-451" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-452"><a href="#cb18-452" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-453"><a href="#cb18-453" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-454"><a href="#cb18-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-455"><a href="#cb18-455" aria-hidden="true" tabindex="-1"></a>umapobj_multiomics <span class="ot">&lt;-</span> scPearsonPCA<span class="sc">::</span><span class="fu">make_umap</span>(pcaobj_multiomics)</span>
<span id="cb18-456"><a href="#cb18-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-457"><a href="#cb18-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-458"><a href="#cb18-458" aria-hidden="true" tabindex="-1"></a>sem_rna[[<span class="st">"multiumap"</span>]] <span class="ot">&lt;-</span> umapobj_multiomics<span class="sc">$</span>ump</span>
<span id="cb18-459"><a href="#cb18-459" aria-hidden="true" tabindex="-1"></a>sem_rna[[<span class="st">"multigrph"</span>]] <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">as.Graph</span>(umapobj_multiomics<span class="sc">$</span>grph[<span class="fu">colnames</span>(sem_rna),<span class="fu">colnames</span>(sem_rna)])</span>
<span id="cb18-460"><a href="#cb18-460" aria-hidden="true" tabindex="-1"></a>sem_rna <span class="ot">&lt;-</span> Seurat<span class="sc">::</span><span class="fu">FindClusters</span>(sem_rna, <span class="at">graph.name=</span><span class="st">"multigrph"</span>)</span>
<span id="cb18-461"><a href="#cb18-461" aria-hidden="true" tabindex="-1"></a>sem_rna<span class="sc">@</span>meta.data<span class="sc">$</span>clusters_multi_unsup <span class="ot">&lt;-</span> sem_rna<span class="sc">@</span>meta.data<span class="sc">$</span>seurat_clusters</span>
<span id="cb18-462"><a href="#cb18-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-463"><a href="#cb18-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-464"><a href="#cb18-464" aria-hidden="true" tabindex="-1"></a>xyp_multi_unsup <span class="ot">&lt;-</span> <span class="fu">xyplot</span>(<span class="st">"clusters_multi_unsup"</span>, <span class="at">metadata =</span> sem_rna<span class="sc">@</span>meta.data, <span class="at">ptsize =</span> <span class="fl">0.05</span>) <span class="sc">+</span> <span class="fu">coord_fixed</span>()</span>
<span id="cb18-465"><a href="#cb18-465" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(xyp_multi_unsup)</span>
<span id="cb18-466"><a href="#cb18-466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-467"><a href="#cb18-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-470"><a href="#cb18-470" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-471"><a href="#cb18-471" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb18-472"><a href="#cb18-472" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-473"><a href="#cb18-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-474"><a href="#cb18-474" aria-hidden="true" tabindex="-1"></a><span class="co">#knitr::include_graphics("readmedata/umapplot.png")</span></span>
<span id="cb18-475"><a href="#cb18-475" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"readmedata/xyp_multi_unsup.png"</span>)</span>
<span id="cb18-476"><a href="#cb18-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-477"><a href="#cb18-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-478"><a href="#cb18-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-481"><a href="#cb18-481" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-482"><a href="#cb18-482" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-483"><a href="#cb18-483" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-484"><a href="#cb18-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-485"><a href="#cb18-485" aria-hidden="true" tabindex="-1"></a>umapp <span class="ot">&lt;-</span> <span class="fu">plot_umap</span>(<span class="at">umapreduc =</span> <span class="st">"multiumap"</span>, <span class="at">clustercol =</span> <span class="st">"clusters_multi_unsup"</span>, <span class="at">semuse =</span> sem_rna)</span>
<span id="cb18-486"><a href="#cb18-486" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(umapp)</span>
<span id="cb18-487"><a href="#cb18-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-488"><a href="#cb18-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-491"><a href="#cb18-491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-492"><a href="#cb18-492" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb18-493"><a href="#cb18-493" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-494"><a href="#cb18-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-495"><a href="#cb18-495" aria-hidden="true" tabindex="-1"></a><span class="co">#knitr::include_graphics("readmedata/umapplot.png")</span></span>
<span id="cb18-496"><a href="#cb18-496" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"readmedata/umapp_multi.png"</span>)</span>
<span id="cb18-497"><a href="#cb18-497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-498"><a href="#cb18-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-499"><a href="#cb18-499" aria-hidden="true" tabindex="-1"></a><span class="fu">#### RNA and protein marker heatmaps </span></span>
<span id="cb18-500"><a href="#cb18-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-501"><a href="#cb18-501" aria-hidden="true" tabindex="-1"></a>Below we'll look at a couple of marker heatmaps for these unsupervised clusters.</span>
<span id="cb18-502"><a href="#cb18-502" aria-hidden="true" tabindex="-1"></a>These functions below use the <span class="co">[</span><span class="ot">HieraType package</span><span class="co">](https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/HieraType)</span>. </span>
<span id="cb18-505"><a href="#cb18-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-506"><a href="#cb18-506" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-507"><a href="#cb18-507" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-508"><a href="#cb18-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-509"><a href="#cb18-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-510"><a href="#cb18-510" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(umapobj_multiomics,<span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/umapobj_multiomics.rds"</span>)</span>
<span id="cb18-511"><a href="#cb18-511" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/xyp_multi_unsup.png"</span></span>
<span id="cb18-512"><a href="#cb18-512" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">plot=</span>xyp_multi_unsup</span>
<span id="cb18-513"><a href="#cb18-513" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">device =</span> <span class="st">"png"</span></span>
<span id="cb18-514"><a href="#cb18-514" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">width =</span> <span class="dv">1181</span> <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">20</span>)</span>
<span id="cb18-515"><a href="#cb18-515" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">height=</span><span class="dv">689</span> <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">20</span>)</span>
<span id="cb18-516"><a href="#cb18-516" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">units =</span> <span class="st">'px'</span></span>
<span id="cb18-517"><a href="#cb18-517" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-518"><a href="#cb18-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-519"><a href="#cb18-519" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/umapp_multi.png"</span></span>
<span id="cb18-520"><a href="#cb18-520" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">plot=</span>umapp</span>
<span id="cb18-521"><a href="#cb18-521" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">device =</span> <span class="st">"png"</span></span>
<span id="cb18-522"><a href="#cb18-522" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">width =</span> <span class="dv">1181</span> <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">20</span>)</span>
<span id="cb18-523"><a href="#cb18-523" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">height=</span><span class="dv">800</span> <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">20</span>)</span>
<span id="cb18-524"><a href="#cb18-524" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">units =</span> <span class="st">'px'</span></span>
<span id="cb18-525"><a href="#cb18-525" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-526"><a href="#cb18-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-527"><a href="#cb18-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-528"><a href="#cb18-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-531"><a href="#cb18-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-532"><a href="#cb18-532" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-533"><a href="#cb18-533" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-534"><a href="#cb18-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-535"><a href="#cb18-535" aria-hidden="true" tabindex="-1"></a><span class="co">#remotes::install_github("Nanostring-Biostats/CosMx-Analysis-Scratch-Space", </span></span>
<span id="cb18-536"><a href="#cb18-536" aria-hidden="true" tabindex="-1"></a><span class="co">#                        subdir = "_code/HieraType", ref = "Main")</span></span>
<span id="cb18-537"><a href="#cb18-537" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(HieraType)</span>
<span id="cb18-538"><a href="#cb18-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-539"><a href="#cb18-539" aria-hidden="true" tabindex="-1"></a>fctbl_rna <span class="ot">&lt;-</span> <span class="fu">clusterwise_foldchange_metrics</span>(sem_rna[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts[use_genes,]</span>
<span id="cb18-540"><a href="#cb18-540" aria-hidden="true" tabindex="-1"></a>                                            ,<span class="at">totalcounts =</span> tc</span>
<span id="cb18-541"><a href="#cb18-541" aria-hidden="true" tabindex="-1"></a>                                            ,<span class="at">metadata =</span> sem_rna<span class="sc">@</span>meta.data</span>
<span id="cb18-542"><a href="#cb18-542" aria-hidden="true" tabindex="-1"></a>                                            ,<span class="at">cluster_column =</span> <span class="st">"clusters_multi_unsup"</span></span>
<span id="cb18-543"><a href="#cb18-543" aria-hidden="true" tabindex="-1"></a>                                            )</span>
<span id="cb18-544"><a href="#cb18-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-545"><a href="#cb18-545" aria-hidden="true" tabindex="-1"></a>hm_rna <span class="ot">&lt;-</span> <span class="fu">add_ncells</span>(<span class="fu">marker_heatmap</span>(fctbl_rna)) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"rna heatmap"</span>)</span>
<span id="cb18-546"><a href="#cb18-546" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hm_rna)</span>
<span id="cb18-547"><a href="#cb18-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-548"><a href="#cb18-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-549"><a href="#cb18-549" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-550"><a href="#cb18-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-553"><a href="#cb18-553" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-554"><a href="#cb18-554" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-555"><a href="#cb18-555" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-556"><a href="#cb18-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-557"><a href="#cb18-557" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot=</span>hm_rna, <span class="at">filename =</span> <span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/hm_rna_multi.png"</span>, <span class="at">width =</span> <span class="dv">1522</span> <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">20</span>), <span class="at">height =</span> <span class="dv">430</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">20</span>), <span class="at">dpi=</span><span class="dv">400</span>,<span class="at">units=</span><span class="st">'px'</span>)</span>
<span id="cb18-558"><a href="#cb18-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-559"><a href="#cb18-559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-560"><a href="#cb18-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-561"><a href="#cb18-561" aria-hidden="true" tabindex="-1"></a>&lt;div class="wider-image"&gt;</span>
<span id="cb18-562"><a href="#cb18-562" aria-hidden="true" tabindex="-1"></a>  &lt;img src="./readmedata/hm_rna_multi.png" alt="Wide Image"&gt;</span>
<span id="cb18-563"><a href="#cb18-563" aria-hidden="true" tabindex="-1"></a>&lt;/div&gt;</span>
<span id="cb18-564"><a href="#cb18-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-567"><a href="#cb18-567" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-568"><a href="#cb18-568" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-569"><a href="#cb18-569" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-570"><a href="#cb18-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-571"><a href="#cb18-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-572"><a href="#cb18-572" aria-hidden="true" tabindex="-1"></a>fctbl_protein <span class="ot">&lt;-</span> HieraType<span class="sc">::</span><span class="fu">clusterwise_foldchange_metrics_protein</span>(sem_protein[[<span class="st">"RNA"</span>]]<span class="sc">@</span>counts[,<span class="fu">rownames</span>(sem_rna<span class="sc">@</span>meta.data)]</span>
<span id="cb18-573"><a href="#cb18-573" aria-hidden="true" tabindex="-1"></a>                                                        ,<span class="at">metadata =</span> sem_rna<span class="sc">@</span>meta.data</span>
<span id="cb18-574"><a href="#cb18-574" aria-hidden="true" tabindex="-1"></a>                                                        ,<span class="at">cluster_column =</span> <span class="st">"clusters_multi_unsup"</span></span>
<span id="cb18-575"><a href="#cb18-575" aria-hidden="true" tabindex="-1"></a>                                                        ,<span class="at">propd =</span> (pgamm[,<span class="fu">rownames</span>(sem_rna<span class="sc">@</span>meta.data)] <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb18-576"><a href="#cb18-576" aria-hidden="true" tabindex="-1"></a>                                            )</span>
<span id="cb18-577"><a href="#cb18-577" aria-hidden="true" tabindex="-1"></a>hm_protein <span class="ot">&lt;-</span> <span class="fu">add_ncells</span>(<span class="fu">marker_heatmap</span>(fctbl_protein)) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"protein heatmap"</span>)</span>
<span id="cb18-578"><a href="#cb18-578" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hm_protein)</span>
<span id="cb18-579"><a href="#cb18-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-580"><a href="#cb18-580" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-581"><a href="#cb18-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-584"><a href="#cb18-584" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-585"><a href="#cb18-585" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-586"><a href="#cb18-586" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-587"><a href="#cb18-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-588"><a href="#cb18-588" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot=</span>hm_protein, <span class="at">filename =</span> <span class="st">"/home/rstudio/data/dan/scPearsonPCA/readmedata/hm_protein_multi.png"</span>, <span class="at">width =</span> <span class="dv">1522</span> <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">20</span>), <span class="at">height =</span> <span class="dv">430</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">20</span>), <span class="at">dpi=</span><span class="dv">400</span>,<span class="at">units=</span><span class="st">'px'</span>)</span>
<span id="cb18-589"><a href="#cb18-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-590"><a href="#cb18-590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-591"><a href="#cb18-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-592"><a href="#cb18-592" aria-hidden="true" tabindex="-1"></a>&lt;div class="wider-image"&gt;</span>
<span id="cb18-593"><a href="#cb18-593" aria-hidden="true" tabindex="-1"></a>  &lt;img src="./readmedata/hm_protein_multi.png" alt="Wide Image"&gt;</span>
<span id="cb18-594"><a href="#cb18-594" aria-hidden="true" tabindex="-1"></a>&lt;/div&gt;</span>
<span id="cb18-595"><a href="#cb18-595" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../../license.html">
<p>License</p>
</a>
  </li>  
</ul>
    <div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>