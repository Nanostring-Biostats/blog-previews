<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Blog</title>
<link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/</link>
<atom:link href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/index.xml" rel="self" type="application/rss+xml"/>
<description>Bruker Spatial Biology&#39;s CosMx Analysis Scratch Space</description>
<generator>quarto-1.6.30</generator>
<lastBuildDate>Fri, 13 Feb 2026 00:00:00 GMT</lastBuildDate>
<item>
  <title>Data Analysis Workflow for GeoMx® NGS-Protein Data</title>
  <dc:creator>Felicia New</dc:creator>
  <dc:creator>Claire Williams</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>In this vignette, we will introduce a data analysis workflow for GeoMx® NGS protein expression data profiled with the <a href="https://nanostring.com/products/geomx-digital-spatial-profiler/geomx-protein-assays/io-proteome-atlas/" target="_blank">GeoMx IO Proteome Atlas (IPA) atlas</a>. The workflow introduced in this vignette can be applied to the new <a href="https://nanostring.com/products/geomx-digital-spatial-profiler/geomx-protein-assays/discovery-proteome-atlas/" target="_blank">Discovery Proteome Atlas (DPA) panel</a>, as well.</p>
<p>The GeoMx Digital Spatial Profiler (DSP) is a platform for capturing spatially resolved high-plex gene or protein expression data from tissue (<span class="citation" data-cites="Merritt2020">Merritt et al. (2020)</span>). In particular, formalin-fixed paraffin-embedded (FFPE) or fresh-frozen (FF) tissue sections are stained with barcoded in-situ hybridization probes that bind to endogenous mRNA transcripts or barcoded antibodies that recognize endogenous proteins. The user then selects regions of the interest (ROI) to profile; if desired, each ROI segment can be further sub-divided into areas of illumination (AOI) based on tissue morphology. The GeoMx DSP then photo-cleaves and collects expression barcodes for each AOI segment separately for downstream sequencing and data processing.</p>
<p>The final results are spatially resolved unique expression datasets for every protein-coding gene (&gt;18,000 genes) or over 570 proteins from every individual segment profiled from tissue. Here, we walk through an analysis workflow with one example dataset.</p>
<p>This vignette is divided into the following major sections:</p>
<ul>
<li>Section&nbsp;2 Study Design</li>
<li>Section&nbsp;3 Quality Control</li>
<li>Section&nbsp;4 Exploratory Data Analysis</li>
<li>Section&nbsp;5 Differential Expression</li>
<li>Section&nbsp;6 Conclusions</li>
</ul>
<div class="cell">
<style type="text/css">
.hscroll-plot {
  overflow-x: auto;
  overflow-y: hidden;
  max-width: 100%;
  padding-bottom: 0.25rem;
}
.hscroll-plot img, .hscroll-plot svg, .hscroll-plot canvas {
  display: block;
  max-width: none !important;
}
</style>
</div>
<p>Before getting started, we load in key libraries and set locations of folders we’ll use for intermediate and final analyses and results.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># List of CRAN packages for session</span></span>
<span id="cb1-2">.cran_packages <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plyr"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dplyr"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FactoMineR"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ggplot2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ggforce"</span>, </span>
<span id="cb1-3">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openxlsx"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"psych"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kableExtra"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GGally"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"magick"</span>, </span>
<span id="cb1-4">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ggrepel"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circlize"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pals"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ggupset"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tidyr"</span>, </span>
<span id="cb1-5">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reshape2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ggprism"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gtools"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parcats"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"svglite"</span>, </span>
<span id="cb1-6">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"vdiffr"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parallel"</span>,</span>
<span id="cb1-7">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"easyalluvial"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ggtext"</span>)</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># List of Bioconductor packages for session</span></span>
<span id="cb1-10">.bioc_packages <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GSEABase"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GSVA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Biobase"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NanoStringNCTools"</span>, </span>
<span id="cb1-11">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GeomxTools"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GeoMxWorkflows"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SpatialDecon"</span>, </span>
<span id="cb1-12">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ComplexHeatmap"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"org.Hs.eg.db"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"org.Mm.eg.db"</span>)</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Install packages if any are missing</span></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Install CRAN packages (if not already installed)</span></span>
<span id="cb1-16">.inst <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> .cran_packages <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">installed.packages</span>()</span>
<span id="cb1-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(.cran_packages[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>.inst]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(.cran_packages[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>.inst])</span>
<span id="cb1-18"></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Install Bioconductor packages (if not already installed)</span></span>
<span id="cb1-20">.bioc_inst <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> .bioc_packages <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">installed.packages</span>()</span>
<span id="cb1-21"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(.bioc_packages[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>.bioc_inst]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>){</span>
<span id="cb1-22">  BiocManager<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install</span>(.bioc_packages[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>.bioc_inst])</span>
<span id="cb1-23">}</span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># require these packages</span></span>
<span id="cb1-26">cran_loaded <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(.cran_packages, require, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">character.only=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-27">bioc_loaded <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(.bioc_packages, require, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">character.only=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-28"></span>
<span id="cb1-29"></span>
<span id="cb1-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load in useful functions for GeoMx Data Analysis</span></span>
<span id="cb1-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/Main/_code/geomx_vignette/GeoMx_Workflow_Helpers.R"</span>)</span>
<span id="cb1-32"></span>
<span id="cb1-33"></span>
<span id="cb1-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up directory structure</span></span>
<span id="cb1-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># datadir is the location of dcc files, pkc file(s), and images (if applicable).</span></span>
<span id="cb1-36">datadir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/path/to/data/dir/"</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set data directory</span></span>
<span id="cb1-37"></span>
<span id="cb1-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initiate a date tag &amp; directory naming</span></span>
<span id="cb1-39">project_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Demo"</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set a name for the project</span></span>
<span id="cb1-40">date_tag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.Date</span>(), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%Y%m%d"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, project_name)</span>
<span id="cb1-41">outdir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output_"</span>, date_tag)</span>
<span id="cb1-42">object_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R_objects"</span>)</span>
<span id="cb1-43">qc_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qc"</span>)</span>
<span id="cb1-44">de_plot_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"de"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Plots"</span>)</span>
<span id="cb1-45">de_data_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"de"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data"</span>)</span>
<span id="cb1-46"></span>
<span id="cb1-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize output directory for static images, tables, and serialized R objects.</span></span>
<span id="cb1-48"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(dir_i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(outdir, object_dir, qc_dir, de_plot_dir, de_data_dir)){</span>
<span id="cb1-49">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.exists</span>(dir_i)){</span>
<span id="cb1-50">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.create</span>(dir_i, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">recursive =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-51">  }</span>
<span id="cb1-52">}</span>
<span id="cb1-53"></span>
<span id="cb1-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Select your p_adjust method. Note: this value must be one of the following: "holm", "hochberg", "hommel", "bonferroni", "BH", "BY", "fdr", "none"</span></span>
<span id="cb1-55">p_adjust_method_selected <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fdr"</span></span>
<span id="cb1-56">p_adjust_threshold <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span></span></code></pre></div>
</details>
</div>
</section>
<section id="sec-study-design" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Study Design</h1>
<p>Here we describe the experimental setup and the raw data that will form the basis of our analysis.</p>
<details>
<summary>
Click to show/hide study design overview
</summary>
<section id="slides-and-profiling-strategy" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="slides-and-profiling-strategy"><span class="header-section-number">2.1</span> Slides and Profiling Strategy</h2>
<p>In this vignette, we will analyze a GeoMx DSP breast cancer dataset created with the IPA assay. The dataset of interest is comprised of six breast cancer samples from six patients who received a therapeutic treatment, with 3 responders and 3 non-responders. Regions of interest (ROIs) were further segmented into PanCK+ and PanCK- areas of illumination (AOIs), separating epithelial and tumor compartments from stromal compartments.</p>
<p>To follow along with this vignette, the data set used here can be downloaded from this <a href="https://nanostring.box.com/s/o15x51acki3096y52li2jcxrw3r855wk" target="_blank">Box link</a>. After downloading, unzip the file and place the outputs (key data files) in your <code>datadir</code>, as specified above.</p>
<p>The key data files are:</p>
<ul>
<li>DCCs files - expression count data and sequencing quality metadata</li>
<li>PKCs file(s) - probe assay metadata describing the protein targets present in the data. PKC files can be found <a href="https://nanostring.com/products/geomx-digital-spatial-profiler/geomx-dsp-configuration-files/" target="_blank">here</a>.</li>
<li>Annotation file - This should be the Lab Worksheet from the GeoMx instrument study readout package. Users should add any useful tissue information, including the type of segment profiled (ex: responder vs.&nbsp;non-responder), segment area/nuclei count, and other tissue characteristics when applicable (ex: diseased vs.&nbsp;healthy). Please note, the row order of NTCs is important to ensure proper processing of files. To ensure the proper order, the file should be sorted by DSP file name. The Lab Worksheet needs to be formatted for ingestion with GeoMxTools. First, the lab worksheet should be opened in Excel, and the first ~15 rows should be deleted so that only the header row and sample information remain.</li>
</ul>
<p>We first locate the downloaded files and then we load the data to create a data object using the <code>readNanoStringGeoMxSet</code> function from the <code>GeomxTools</code> package. For more information about this data object, see this <a href="https://www.bioconductor.org/packages/release/workflows/vignettes/GeoMxWorkflows/inst/doc/GeomxTools_RNA-NGS_Analysis.html#91_GeoMxSet_Object_Overview" target="_blank">GeoMxSetObject Overview</a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/images/GeomxSetStructure.png" class="img-fluid figure-img"></p>
<figcaption><em>GeoMxSetObject structure</em>.</figcaption>
</figure>
</div>
<div class="cell" data-show="false">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If the object probe_data already exists in object_dir, </span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load it from disk. Otherwise, run readNanoStringGeoMxSet</span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(object_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_data.RDS"</span>))){</span>
<span id="cb2-5">  probe_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(object_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_data.RDS"</span>))</span>
<span id="cb2-6">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb2-7"> DCCFiles <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(datadir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dccs"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".dcc$"</span>,</span>
<span id="cb2-8">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">recursive =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-9"> PKCFiles <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(datadir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pkcs"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".pkc$"</span>,</span>
<span id="cb2-10">                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">recursive =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-11"> SampleAnnotationFile <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb2-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(datadir), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"demo.xlsx$"</span>,</span>
<span id="cb2-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">recursive =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-14">  probe_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb2-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readNanoStringGeoMxSet</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dccFiles =</span> DCCFiles,</span>
<span id="cb2-16">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pkcFiles =</span> PKCFiles,</span>
<span id="cb2-17">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phenoDataFile =</span> SampleAnnotationFile,</span>
<span id="cb2-18">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phenoDataSheet =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sheet 1"</span>,</span>
<span id="cb2-19">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phenoDataDccColName =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sample_ID"</span>,</span>
<span id="cb2-20">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">protocolDataColNames =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aoi"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roi"</span>),</span>
<span id="cb2-21">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">experimentDataColNames =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"panel"</span>),</span>
<span id="cb2-22">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">analyte =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Protein'</span>)</span>
<span id="cb2-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">object=</span>probe_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(object_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"probe_data.RDS"</span>))</span>
<span id="cb2-24">}</span>
<span id="cb2-25"></span>
<span id="cb2-26"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"slide name"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(probe_data))){</span>
<span id="cb2-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The reserved column </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">slide name</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> was not found in this dataset."</span>)</span>
<span id="cb2-28">}</span>
<span id="cb2-29"></span>
<span id="cb2-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Select factors of interest from the data's metadata</span></span>
<span id="cb2-31">factors_of_interest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Responder"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"slide"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Segment"</span>)</span>
<span id="cb2-32"></span>
<span id="cb2-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set colors for main factors of interest</span></span>
<span id="cb2-34">pal_main <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb2-35"> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getColorPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(probe_data)[, factors_of_interest[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(factors_of_interest),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Main"</span>)</span></code></pre></div>
</details>
</div>
<p>All of the expression, annotation, and probe information are now linked and stored together into a single data object.</p>
<p>We summarize the study design in a Sankey diagram, which illustrates how samples flow through each step and link to their biological annotations. The width of each connecting band reflects how many segments are shared between the two annotations, making it easy to see where groups diverge or overlap.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">pheno_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(probe_data)</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Select factor of interest to color sankey based on this factor</span></span>
<span id="cb3-4">sankey_focal_factor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> factors_of_interest[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Subset the desired columns</span></span>
<span id="cb3-7">sample_overview <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pheno_data[factors_of_interest]</span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create alluvial plot</span></span>
<span id="cb3-10">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> easyalluvial<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alluvial_wide</span>(sample_overview, </span>
<span id="cb3-11">                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_variables =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, </span>
<span id="cb3-12">                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col_vector_value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(pal_main),</span>
<span id="cb3-13">                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col_vector_flow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.vector</span>(pal_main[[sankey_focal_factor]]))</span>
<span id="cb3-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Main_Alluvial.svg"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">path =</span> qc_dir, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">device =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"svg"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)</span>
<span id="cb3-15"></span>
<span id="cb3-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add hover option details to plot</span></span>
<span id="cb3-17">pc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parcats</span>(p,</span>
<span id="cb3-18">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">marginal_histograms =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb3-19">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data_input =</span> sample_overview,</span>
<span id="cb3-20">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labelfont =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>),</span>
<span id="cb3-21">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hoveron=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dimension"</span>,</span>
<span id="cb3-22">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hoverinfo =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>,</span>
<span id="cb3-23">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">offset_marginal_histograms =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span>
<span id="cb3-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(pc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/pc_interactive.rds"</span>))</span></code></pre></div>
</details>
</div>
<p>This makes both a static Sankey diagram:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/Main_Alluvial.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And an interactive Sankey diagram:</p>
<div class="cell">
<div class="cell-output-display">
<div class="parcats html-widget html-fill-item" id="htmlwidget-3229e94d3177429dcd3c" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-3229e94d3177429dcd3c">{"x":{"traces":{"parcats":{"type":"parcats","dimensions":[{"label":"Responder","values":["No","No","No","No","No","No","Yes","Yes","Yes","Yes","Yes","Yes"],"categoryorder":"array","categoryarray":["Yes","No"]},{"label":"slide","values":["slide4","slide4","slide5","slide5","slide6","slide6","slide1","slide1","slide2","slide2","slide3","slide3"],"categoryorder":"array","categoryarray":["slide6","slide5","slide4","slide3","slide2","slide1"]},{"label":"Segment","values":["CK neg","CK pos","CK neg","CK pos","CK neg","CK pos","CK neg","CK pos","CK neg","CK pos","CK neg","CK pos"],"categoryorder":"array","categoryarray":["CK pos","CK neg"]}],"counts":[30,30,4,4,13,14,16,16,20,20,11,12],"line":{"shape":"hspline","color":["#F28E2B","#F28E2B","#F28E2B","#F28E2B","#F28E2B","#F28E2B","#8F6954","#8F6954","#8F6954","#8F6954","#8F6954","#8F6954"]},"hoveron":"dimension","hoverinfo":"count","labelfont":{"size":12,"color":"black"},"arrangement":"perpendicular","bundlecolors":true,"sortpaths":"forward","tickfont":null,"domain":{"y":[0,1]}}},"layout":[],"shapes":[],"shapes_original":[],"map_curve":[],"map_trace_2_shape":[],"map_type":[],"map_color":[],"parcats_cols":["#F28E2B","#F28E2B","#F28E2B","#F28E2B","#F28E2B","#F28E2B","#8F6954","#8F6954","#8F6954","#8F6954","#8F6954","#8F6954"],"imp":false},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section></details>
</section>

<section id="sec-quality-control" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Quality Control</h1>
<p>Before we dive into deeper analysis, we first run through a few key quality measures to assess the dataset.</p>
<details>
<summary>
Click to show/hide quality control steps
</summary>
<p>The QC steps can be summarized as follows:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/images/GeoMx_Protein_Workflow.png" class="img-fluid figure-img"></p>
<figcaption><em>A standard GeoMx workflow</em>.</figcaption>
</figure>
</div>
<section id="segment-qc" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="segment-qc"><span class="header-section-number">3.1</span> Segment QC</h2>
<p>Set up QC parameters to use for the study. Here we list parameters that are a good starting point for IPA datasets, but as always we recommend examining the distribution of these metrics in your dataset to choose appropriate thresholds.</p>
<p>Every ROI/AOI segment is tested for:</p>
<ul>
<li><p><strong>Raw sequencing reads</strong>: segments with &lt;1000 raw reads are removed.</p></li>
<li><p><strong>% Aligned, % Trimmed, or % Stitched sequencing reads</strong>: segments below ~80% for one or more of these QC parameters are removed.</p></li>
<li><p><strong>% Sequencing saturation</strong>: Defined as ([1-deduplicated reads/aligned reads]%). Segments below ~50% require additional sequencing to capture full sample diversity and are not typically analyzed until improved.</p></li>
<li><p><strong>Minimum Negative Count</strong>: this is the geometric mean of the several unique negative probes in the GeoMx panel that do not target endogenous proteins and establish the background count level per segment; segments with low negative counts (1-10) are not necessarily removed but may be studied closer for low endogenous signal and/or insufficient tissue sampling.</p></li>
<li><p><strong>No Template Control (NTC) count</strong>: values &gt;1000 could indicate contamination for the segments associated with this NTC; however, in cases where the NTC count is between 1000-10000, the segments may be used if the NTC data is uniformly low (e.g.&nbsp;0-2 counts for all probes).</p></li>
<li><p><strong>Nuclei</strong>: &gt;100 nuclei per segment is generally recommended; however, this cutoff is highly study/tissue dependent and may need to be reduced; what is most important is consistency in the nuclei distribution for segments within the study.</p></li>
<li><p><strong>Area</strong>: generally correlates with nuclei; a strict cutoff is not generally applied based on area.</p></li>
</ul>
<p>More information about these parameters can be found in the <a href="http://www.bioconductor.org/packages/release/bioc/html/GeomxTools.html" target="_blank">GeomxTools Bioconductor page</a> and <a href="http://www.bioconductor.org/packages/release/bioc/manuals/GeomxTools/man/GeomxTools.pdf" target="_blank">reference manual</a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters used</span></span>
<span id="cb4-2">QC_params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb4-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minSegmentReads =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb4-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">percentTrimmed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>,</span>
<span id="cb4-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">percentStitched =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>,</span>
<span id="cb4-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">percentAligned =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>,</span>
<span id="cb4-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">percentSaturation =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb4-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minNegativeCount =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxNTCCount =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9000</span>,</span>
<span id="cb4-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minNuclei =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,</span>
<span id="cb4-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minArea =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb4-12"> </span>
<span id="cb4-13">)</span>
<span id="cb4-14"></span>
<span id="cb4-15">top_quantile <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.90</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># quantile of features to select for comparing top CV features</span></span></code></pre></div>
</details>
</div>
<p>We first will assess sequencing quality and adequate tissue sampling for every ROI/AOI segment. We do this by comparing segment metrics to the QC thresholds set above. Following this QC check, we show plots visualizing each metric followed by a table summarizing the segments that pass the key QC metrics.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">probe_data_qc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> probe_data</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save this as a data frame</span></span>
<span id="cb5-4">qc_param_tab <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Parameter=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(QC_params), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Default value'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(GeomxTools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span>DEFAULTS[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(QC_params)]), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Actual value'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(QC_params))</span>
<span id="cb5-5"></span>
<span id="cb5-6">results_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results.rds"</span>))</span>
<span id="cb5-7">results_list<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>qc_param_tab <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> qc_param_tab</span>
<span id="cb5-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(results_list, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results.rds"</span>))</span>
<span id="cb5-9"></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Assess QC flags using setSegmentQCFlags</span></span>
<span id="cb5-11">probe_data_qc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setSegmentQCFlags</span>(probe_data_qc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">qcCutoffs =</span> QC_params)</span>
<span id="cb5-12"></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Collate QC Results</span></span>
<span id="cb5-14">QCResults <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">protocolData</span>(probe_data_qc)[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QCFlags"</span>]])</span>
<span id="cb5-15">flag_columns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(QCResults)</span>
<span id="cb5-16">QC_Summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Pass =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>QCResults[, flag_columns]),</span>
<span id="cb5-17">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Warning =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(QCResults[, flag_columns]))</span>
<span id="cb5-18">QCResults<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>QCStatus <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(QCResults, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) {</span>
<span id="cb5-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>L, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PASS"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WARNING"</span>)</span>
<span id="cb5-20">})</span>
<span id="cb5-21">QC_Summary[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TOTAL FLAGS"</span>, ] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb5-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(QCResults[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QCStatus"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PASS"</span>),</span>
<span id="cb5-23">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(QCResults[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QCStatus"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WARNING"</span>))</span>
<span id="cb5-24"></span>
<span id="cb5-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add QC status back to probe_data</span></span>
<span id="cb5-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(probe_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>QC <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> QCResults<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>QCStatus</span>
<span id="cb5-27"></span>
<span id="cb5-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save QC Summary</span></span>
<span id="cb5-29">results_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results.rds"</span>))</span>
<span id="cb5-30">results_list<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>QC_Summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> QC_Summary</span>
<span id="cb5-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(results_list, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results.rds"</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Default.value</th>
<th style="text-align: left;">Actual.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">minSegmentReads</td>
<td style="text-align: left;">1000</td>
<td style="text-align: left;">1000</td>
</tr>
<tr class="even">
<td style="text-align: left;">percentTrimmed</td>
<td style="text-align: left;">80</td>
<td style="text-align: left;">80</td>
</tr>
<tr class="odd">
<td style="text-align: left;">percentStitched</td>
<td style="text-align: left;">80</td>
<td style="text-align: left;">80</td>
</tr>
<tr class="even">
<td style="text-align: left;">percentAligned</td>
<td style="text-align: left;">80</td>
<td style="text-align: left;">75</td>
</tr>
<tr class="odd">
<td style="text-align: left;">percentSaturation</td>
<td style="text-align: left;">50</td>
<td style="text-align: left;">50</td>
</tr>
<tr class="even">
<td style="text-align: left;">minNegativeCount</td>
<td style="text-align: left;">10</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">maxNTCCount</td>
<td style="text-align: left;">60</td>
<td style="text-align: left;">9000</td>
</tr>
<tr class="even">
<td style="text-align: left;">minNuclei</td>
<td style="text-align: left;">200</td>
<td style="text-align: left;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">minArea</td>
<td style="text-align: left;">16000</td>
<td style="text-align: left;">1000</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="segment-qc-plots" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="segment-qc-plots"><span class="header-section-number">3.1.1</span> Segment QC Plots</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Processing data for QC plots</span></span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Un-embed data frames from the QC data</span></span>
<span id="cb6-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (column <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sData</span>(probe_data_qc))) {</span>
<span id="cb6-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sData</span>(probe_data_qc)[,column], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data.frame"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sData</span>(probe_data_qc)[,column])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>){</span>
<span id="cb6-6">        probe_data_qc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>protocolData<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>data[,column] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sData</span>(probe_data_qc)[, column][,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb6-7">    }</span>
<span id="cb6-8">}</span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate the negative geometric means for each module</span></span>
<span id="cb6-10">negativeGeoMeans <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb6-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">esBy</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">negativeControlSubset</span>(probe_data_qc), </span>
<span id="cb6-12">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">GROUP =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Module"</span>, </span>
<span id="cb6-13">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) { </span>
<span id="cb6-14">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assayDataApply</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MARGIN =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> ngeoMean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exprs"</span>) </span>
<span id="cb6-15">         }) </span>
<span id="cb6-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert embedded matrix to df then to AnnotatedDataFrame</span></span>
<span id="cb6-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">protocolData</span>(probe_data_qc) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as</span>(</span>
<span id="cb6-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(</span>
<span id="cb6-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">protocolData</span>(probe_data_qc), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data.frame"</span>),</span>
<span id="cb6-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(negativeGeoMeans)</span>
<span id="cb6-21">  ), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AnnotatedDataFrame"</span>)</span>
<span id="cb6-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Here are the module names</span></span>
<span id="cb6-23">pkcs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation</span>(probe_data_qc)</span>
<span id="cb6-24">modules <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".pkc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, pkcs)</span>
<span id="cb6-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Copy the Negative geoMeans from sData to pData</span></span>
<span id="cb6-26">negCols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NegGeoMean_"</span>, modules)</span>
<span id="cb6-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># negCols &lt;- colnames(sData(probe_data_qc)[["NegGeoMean"]])</span></span>
<span id="cb6-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(probe_data_qc)[, negCols] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sData</span>(probe_data_qc)[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sData</span>(probe_data_qc)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> modules)]</span>
<span id="cb6-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># detatch neg_geomean columns ahead of aggregateCounts call</span></span>
<span id="cb6-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(probe_data_qc) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(probe_data_qc)[, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(probe_data_qc)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> negCols]</span></code></pre></div>
</details>
</div>
<p>The tabs below visualize the segment QC distributions for various sequence and segment quality metrics.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true">Percent trimmed</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false">Percent Aligned</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false">Percent Stitched</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" aria-controls="tabset-1-4" aria-selected="false">Percent Saturation</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" aria-controls="tabset-1-5" aria-selected="false">Segment Areas</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" aria-controls="tabset-1-6" aria-selected="false">Segment Nuclei</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-7" aria-controls="tabset-1-7" aria-selected="false">Negative probe means</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p>The plot below shows the distribution of trimmed reads in the data with the percent threshold as set in the QC parameters code block shown as a vertical dotted line.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot trimmed reads with helper function makeQCHistograms</span></span>
<span id="cb7-2">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeQCHistogram</span>(probe_data_qc, </span>
<span id="cb7-3">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">annotation_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Trimmed (%)"</span>, </span>
<span id="cb7-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill_by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Segment"</span>, </span>
<span id="cb7-5">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb7-6">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> QC_params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>percentTrimmed)</span>
<span id="cb7-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trimmed.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/trimmed.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p>The plot below shows the distribution of aligned reads in the data with the percent threshold of aligned reads as set in the QC parameters code block shown as a vertical dotted line.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeQCHistogram</span>(probe_data_qc, </span>
<span id="cb8-2">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">annotation_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Aligned (%)"</span>, </span>
<span id="cb8-3">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill_by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Segment"</span>, </span>
<span id="cb8-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb8-5">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> QC_params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>percentAligned)</span>
<span id="cb8-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aligned.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/aligned.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<p>The plot below shows the distribution of stitched reads in the data with the percent threshold of stitched reads as set in the QC parameters code block shown as a vertical dotted line.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeQCHistogram</span>(probe_data_qc, </span>
<span id="cb9-2">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">annotation_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stitched (%)"</span>, </span>
<span id="cb9-3">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill_by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Segment"</span>, </span>
<span id="cb9-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb9-5">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> QC_params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>percentStitched)</span>
<span id="cb9-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stitched.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/stitched.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" aria-labelledby="tabset-1-4-tab">
<p>The plot below shows the distribution of aligned reads in the data with the percent saturation threshold as set in the QC parameters code block shown as a vertical dotted line. Saturation is defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?100*%20%5Cleft(%201%20-%20%5Cfrac%7Bdeduplicated%7D%7Baligned%7D%20%5Cright)"></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeQCHistogram</span>(probe_data_qc, </span>
<span id="cb10-2">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">annotation_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Saturated (%)"</span>, </span>
<span id="cb10-3">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill_by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Segment"</span>, </span>
<span id="cb10-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb10-5">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> QC_params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>percentSaturation) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sequencing Saturation (%)"</span>,</span>
<span id="cb10-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sequencing Saturation (%)"</span>)</span>
<span id="cb10-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"saturated.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/saturated.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-5" class="tab-pane" aria-labelledby="tabset-1-5-tab">
<p>The plot below shows the distribution of area in the data with the area threshold in μm<sup>2</sup> as set in the QC parameters code block shown as a vertical dotted line.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeQCHistogram</span>(probe_data_qc, </span>
<span id="cb11-2">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">annotation_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"area"</span>, </span>
<span id="cb11-3">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill_by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Segment"</span>, </span>
<span id="cb11-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb11-5">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> QC_params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>minArea)</span>
<span id="cb11-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"area.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/area.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-6" class="tab-pane" aria-labelledby="tabset-1-6-tab">
<p>The plot below shows the distribution of nuclei counts in the data with the threshold of nuclei as set in the QC parameters code block shown as a vertical dotted line. .</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeQCHistogram</span>(probe_data_qc, </span>
<span id="cb12-2">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">annotation_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nuclei"</span>, </span>
<span id="cb12-3">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill_by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Segment"</span>, </span>
<span id="cb12-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb12-5">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> QC_params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>minNuclei)</span>
<span id="cb12-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nuclei.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/nuclei.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-7" class="tab-pane" aria-labelledby="tabset-1-7-tab">
<p>Plot the negative probe geometric mean. The vertical bars represent a value of two. Typically geometric mean background values of less than 2 are considered “unstable”.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set core panel name - change this if using a different core panel</span></span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This is the panel that includes the negative probes</span></span>
<span id="cb13-3">core_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hs_P_PRO_NGS_Core_v1.1"</span></span>
<span id="cb13-4"></span>
<span id="cb13-5">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeQCHistogram</span>(probe_data_qc, </span>
<span id="cb13-6">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">annotation_col =</span> core_name, </span>
<span id="cb13-7">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill_by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Segment"</span>, </span>
<span id="cb13-8">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb13-9">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb13-10">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale_trans =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log10"</span>)</span>
<span id="cb13-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(core_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".svg"</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/Hs_P_PRO_NGS_Core_v1.1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>As a summary, we show a table of passing and flagged segments.</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">Pass</th>
<th style="text-align: right;">Warning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">LowReads</td>
<td style="text-align: right;">190</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">LowTrimmed</td>
<td style="text-align: right;">190</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LowStitched</td>
<td style="text-align: right;">190</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">LowAligned</td>
<td style="text-align: right;">190</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LowSaturation</td>
<td style="text-align: right;">176</td>
<td style="text-align: right;">14</td>
</tr>
<tr class="even">
<td style="text-align: left;">HighNTC</td>
<td style="text-align: right;">190</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LowNuclei</td>
<td style="text-align: right;">189</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">LowArea</td>
<td style="text-align: right;">190</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">TOTAL FLAGS</td>
<td style="text-align: right;">175</td>
<td style="text-align: right;">15</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Additionally, we summarize the No Template Control (NTC) counts on a per plate basis. Values &gt;1,000 could indicate contamination for the segments associated with this NTC; however, in cases where the NTC count is between 1,000- 10,000, the segments may be used if the NTC data is uniformly low (e.g.&nbsp;distributed across the whole panel, this would represent 0-2 counts for all probes).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create summary table of NTCs</span></span>
<span id="cb14-2">ntc_summary_tab <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ddply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sData</span>(probe_data_qc) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb14-3">                          dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(Plate_ID, NTC_ID, NTC), .(Plate_ID, NTC_ID), <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x){</span>
<span id="cb14-4"> ntc_well <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>NTC_ID[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb14-5"> ntc_count <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>NTC[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb14-6"> n_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(x)</span>
<span id="cb14-7"> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NTC Well ID'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>ntc_well, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NTC counts'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ntc_count, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Samples'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>n_samples))</span>
<span id="cb14-8">}) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>NTC_ID)</span>
<span id="cb14-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(ntc_summary_tab) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Plate"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NTC Well"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NTC Counts"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Samples"</span>)</span>
<span id="cb14-10"></span>
<span id="cb14-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save NTC Summary</span></span>
<span id="cb14-12">results_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results.rds"</span>))</span>
<span id="cb14-13">results_list<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>NTC_Summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ntc_summary_tab</span>
<span id="cb14-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(results_list, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results.rds"</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Plate</th>
<th style="text-align: left;">NTC Well</th>
<th style="text-align: right;">NTC Counts</th>
<th style="text-align: right;">Samples</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1001660033000</td>
<td style="text-align: left;">DSP-1001660033000-Y-A01.dcc</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">95</td>
</tr>
<tr class="even">
<td style="text-align: left;">1001660034000</td>
<td style="text-align: left;">DSP-1001660034000-Z-A01.dcc</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">95</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Here, we remove any segments that were flagged in our segment QC.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">seg_qc_samples_to_remove <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(QCResults)[QCResults<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>QCStatus<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PASS"</span>]</span>
<span id="cb15-2"></span>
<span id="cb15-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(seg_qc_samples_to_remove)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>){</span>
<span id="cb15-4">  probe_data_qc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> probe_data_qc[,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(probe_data_qc) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> seg_qc_samples_to_remove)]</span>
<span id="cb15-5">}</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="quality-control-of-housekeeper-proteins-and-background-isotypes" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="quality-control-of-housekeeper-proteins-and-background-isotypes"><span class="header-section-number">3.2</span> Quality control of housekeeper proteins and background (isotypes)</h2>
<p>Before we perform any normalization to control molecules, we need to check if the control molecules are themselves correlated with the predictors of interests. There are two classes of control molecules in the dataset: isotypes and housekeepers. We extract their names here.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">results_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results.rds"</span>))</span>
<span id="cb16-2"></span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># biological negatives (isotype controls)</span></span>
<span id="cb16-4">iggs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">iggNames</span>(probe_data_qc)</span>
<span id="cb16-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"All IgGs: "</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(iggs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>)))</span>
<span id="cb16-6"></span>
<span id="cb16-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># housekeepers:</span></span>
<span id="cb16-8">hks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hkNames</span>(probe_data_qc)</span>
<span id="cb16-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"All HKGs: "</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(hks, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>)))</span>
<span id="cb16-10"></span>
<span id="cb16-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store names</span></span>
<span id="cb16-12">results_list<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>iggs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iggs</span>
<span id="cb16-13">results_list<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hks</span>
<span id="cb16-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(results_list, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results.rds"</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>All IgGs: Hmr IgG, Ms IgG2b, Rb IgG, Rt IgG2a, Ms IgG1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>All HKGs: Calreticulin, Histone H3, RPS6, TOMM20, GAPDH</code></pre>
</div>
</div>
<section id="isotype-controls" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="isotype-controls"><span class="header-section-number">3.2.1</span> Isotype Controls</h3>
<p>Plot the joint expression of each pairwise <code>IgG</code> control molecule to see if:</p>
<ol type="1">
<li>There’s evidence that one <code>IgG</code> is noisy compared to others</li>
<li>There’s clustering by predictors</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract counts</span></span>
<span id="cb19-2">counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assayDataElement</span>(probe_data_qc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exprs"</span>))</span>
<span id="cb19-3">iggs_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(counts[,iggs]))</span>
<span id="cb19-4"></span>
<span id="cb19-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Bind to phenotypic data</span></span>
<span id="cb19-6">pheno_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(probe_data_qc)</span>
<span id="cb19-7">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(iggs_df)</span>
<span id="cb19-8">iggs_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(iggs_df, pheno_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(Responder, slide, Segment))</span>
<span id="cb19-9"></span>
<span id="cb19-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plots</span></span>
<span id="cb19-11">p0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> GGally<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggpairs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>iggs_df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">progress=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb19-12">            ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()</span>
<span id="cb19-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QC_pairs_background.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb19-14"></span>
<span id="cb19-15"></span>
<span id="cb19-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Explore by factors of interest</span></span>
<span id="cb19-17">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs_custom</span>(iggs_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(iggs), Responder), Responder)</span>
<span id="cb19-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QC_pairs_background_Responder.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)</span>
<span id="cb19-19"></span>
<span id="cb19-20">p3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs_custom</span>(iggs_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(iggs), slide), slide) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span>
<span id="cb19-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QC_pairs_background_slide.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)</span>
<span id="cb19-22"></span>
<span id="cb19-23">p4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs_custom</span>(iggs_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(iggs), Segment), Segment)</span>
<span id="cb19-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p4, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QC_pairs_background_Segment.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)</span></code></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true">IgGs Alone</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false">Responder</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" aria-controls="tabset-2-3" aria-selected="false">Slide</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-4" aria-controls="tabset-2-4" aria-selected="false">Segment</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/QC_pairs_background.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/QC_pairs_background_Responder.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" aria-labelledby="tabset-2-3-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/QC_pairs_background_slide.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-4" class="tab-pane" aria-labelledby="tabset-2-4-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/QC_pairs_background_Segment.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>As expected, we see high correlations between isotype controls, indicating that all five isotype controls can be used for normalization. If an isototype control were to show low correlations with all others, we would suggest excluding that isotype control from normalization.</p>
</div>
</div>
</section>
<section id="housekeeping-controls" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="housekeeping-controls"><span class="header-section-number">3.2.2</span> Housekeeping Controls</h3>
<p>Run the same analysis for the housekeepers. This is the same overall process as for the isotypes.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">hks_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(counts[,hks]))</span>
<span id="cb20-2">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(hks_df)</span>
<span id="cb20-3">hks_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(hks_df, pheno_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(Responder, slide, Segment))</span>
<span id="cb20-4"></span>
<span id="cb20-5">p6 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggpairs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>hks_df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">progress=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb20-6">            ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()</span>
<span id="cb20-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p6,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QC_pairs_housekeepers.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb20-8"></span>
<span id="cb20-9"></span>
<span id="cb20-10">p7 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs_custom</span>(hks_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(hks), Responder), Responder)</span>
<span id="cb20-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p7, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QC_pairs_HK_Responder.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)</span>
<span id="cb20-12"></span>
<span id="cb20-13">p8 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs_custom</span>(hks_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(hks), slide), slide) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span>
<span id="cb20-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p8, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QC_pairs_HK_slide.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)</span>
<span id="cb20-15"></span>
<span id="cb20-16">p9 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs_custom</span>(hks_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(hks), Segment), Segment)</span>
<span id="cb20-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p9, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QC_pairs_HK_Segment.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)</span></code></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" aria-controls="tabset-3-1" aria-selected="true">HKs Alone</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" aria-controls="tabset-3-2" aria-selected="false">Responder</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" aria-controls="tabset-3-3" aria-selected="false">Slide</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-4" aria-controls="tabset-3-4" aria-selected="false">Segment</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/QC_pairs_housekeepers.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/QC_pairs_HK_Responder.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-3-3" class="tab-pane" aria-labelledby="tabset-3-3-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/QC_pairs_HK_slide.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-3-4" class="tab-pane" aria-labelledby="tabset-3-4-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/QC_pairs_HK_Segment.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>As expected, we see high correlation between housekeeper proteins. It is possible for one or two of the proteins to show lower correlation with the others, indicating that these should be removed if using the housekeeper proteins for normalization.</p>
</div>
</div>
</section>
<section id="isotype-vs-housekeeper-controls" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="isotype-vs-housekeeper-controls"><span class="header-section-number">3.2.3</span> Isotype vs housekeeper controls</h3>
<p>Next, we look at the correlation between the geometric means of the housekeeper proteins and the isotype (background) controls. We’re looking for concordance between the two sets of controls. In a high quality dataset, we expect to see reasonable correlation between the housekeeper and isotype controls.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">iggs_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(counts[,iggs]))</span>
<span id="cb21-2">hks_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(counts[,hks]))</span>
<span id="cb21-3">igg_geo_means <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(iggs_df, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, EnvStats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>geoMean))</span>
<span id="cb21-4">hks_geo_means <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(hks_df, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, EnvStats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>geoMean))</span>
<span id="cb21-5">geo_means <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(igg_geo_means, hks_geo_means))</span>
<span id="cb21-6"></span>
<span id="cb21-7">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(geo_means)</span>
<span id="cb21-8">p10 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> GGally<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggpairs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>geo_means, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">columns=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">progress=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb21-9">            ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()</span>
<span id="cb21-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p10, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QC_pairwise_geomeans.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/QC_pairwise_geomeans.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>High correlation between the geometric means of the housekeeper proteins and the isotype (background) controls.</p>
</div>
</div>
</section>
</section>
<section id="signal-to-noise-ratio-snr" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="signal-to-noise-ratio-snr"><span class="header-section-number">3.3</span> Signal to noise ratio, SNR</h2>
<p>We calculate the signal-to-noise ratio (SNR) for every protein in every AOI using the background probes. For this, we use the <code>IgGs</code> to represent background. We then plot the signal-to-noise ratio for all AOIs with all protein probes together. Because we have hundreds of proteins, we make an extra wide plot for exploration such that the protein names are legible.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate SNR</span></span>
<span id="cb22-2">backgrounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iggs</span>
<span id="cb22-3">prData <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">protocolData</span>(probe_data_qc))</span>
<span id="cb22-4">snr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_snr</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exp=</span>counts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">backgrounds =</span> backgrounds, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_processors =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, </span>
<span id="cb22-5">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SBR"</span>)</span>
<span id="cb22-6">snr2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reshape2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">melt</span>(snr, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id.var=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb22-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(snr2) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"protein"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"snr"</span>)</span>
<span id="cb22-8">snr2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> base<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(snr2, prData <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(prData)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(name), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>)</span>
<span id="cb22-9">                            </span>
<span id="cb22-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Order proteins based on median SNR, low to high. </span></span>
<span id="cb22-11">medians_snr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ddply</span>(snr2, .(protein), summarize, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Median=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(snr), </span>
<span id="cb22-12">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">UQ=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(snr, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(UQ)</span>
<span id="cb22-13">snr2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(snr2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>protein), </span>
<span id="cb22-14">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(medians_snr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>protein), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">order=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb22-15">snr2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> snr2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(protein, name)</span>
<span id="cb22-16"></span>
<span id="cb22-17"></span>
<span id="cb22-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up protein names to color by type</span></span>
<span id="cb22-19">levs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(snr2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>protein))                                  </span>
<span id="cb22-20">labs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setNames</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='color:"</span>,</span>
<span id="cb22-21">                        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(levs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> iggs, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,</span>
<span id="cb22-22">                               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(levs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> hks,  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)),</span>
<span id="cb22-23">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'&gt;"</span>, levs, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;/span&gt;"</span>), levs)                  </span>
<span id="cb22-24"></span>
<span id="cb22-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add segment metadata</span></span>
<span id="cb22-26">snr2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Segment <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pheno_data[snr2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Segment"</span>]</span>
<span id="cb22-27"></span>
<span id="cb22-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot SNRs</span></span>
<span id="cb22-29">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>snr2, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>protein, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(snr))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_boxplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outlier.shape =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> Segment)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> pal_main<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Segment) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xlab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Protein"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ylab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2(SNR)"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> labs) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb22-37">                                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb22-38">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>,</span>
<span id="cb22-39">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>, </span>
<span id="cb22-40">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey20"</span>),</span>
<span id="cb22-41">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))) </span>
<span id="cb22-43"></span>
<span id="cb22-44"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"snr_plot.png"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limitsize=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
</details>
</div>
<div class="hscroll-plot">
<div class="cell" data-layout-align="left" data-fig-responsive="false">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/snr_plot.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="6000"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The signal to noise ratio is above background for most proteins in at least one AOI, though note a few proteins with relatively low signal. We will not be dropping any proteins at this point, but will use these results as context while investigating the data further.</p>
</div>
</div>
</section>
<section id="normalization" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="normalization"><span class="header-section-number">3.4</span> Normalization</h2>
<p>The purpose of normalization is to adjust for technical variables, such as ROI/AOI surface area and tissue quality, and enable meaningful biological and statistical discoveries.</p>
<p>Two common methods for normalization of GeoMx DSP Protein data are i) Background (IgGs) or ii) Housekeeper normalization. Both methods estimate a normalization factor per ROI/AOI segment to bring the segment data distributions together. Background is typically the preferred approach. We demonstrate both approaches here.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>High correlation between the geometric mean of the negative control probe counts and the geometric mean of the housekeeper protein counts suggests that both background and housekeeper-based normalization would work well in this dataset. We generally recommend background normalization as we find it to be robust in the majority of datasets. Therefore, this dataset will undergo background normalization using the isotype controls.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Background or IgG normalization</span></span>
<span id="cb23-2">target_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normalize</span>(probe_data_qc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">norm_method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"neg"</span>,</span>
<span id="cb23-3">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fromElt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exprs"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">toElt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"neg_norm"</span>)</span>
<span id="cb23-4"></span>
<span id="cb23-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assayDataElement</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">object =</span> target_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_neg"</span>) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb23-6">     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assayDataApply</span>(target_data, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> log, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"neg_norm"</span>)</span>
<span id="cb23-7"></span>
<span id="cb23-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># # use norm_method = "hk" for housekeeper norm</span></span>
<span id="cb23-9">target_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normalize</span>(target_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">norm_method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hk"</span>,</span>
<span id="cb23-10">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">toElt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hk_norm"</span>)</span>
<span id="cb23-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assayDataElement</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">object =</span> target_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_hk"</span>) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb23-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assayDataApply</span>(target_data, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> log, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hk_norm"</span>)</span></code></pre></div>
</details>
</div>
<p>At this point, we have now performed quality control checks on our AOIs (sequencing statistics, area metrics) and on our probes (control probe correlations, SNR). We’ve additionally performed normalization to take technical effects into account and are ready to proceed to exploratory data analyses.</p>
<p>In summary:</p>
<ul>
<li>175 out of 190 AOI segments passed QC</li>
<li>14 AOIs were flagged for low sequencing saturation and 1 AOI was flagged for low nuclei counts</li>
<li>We see high correlation between the IgG proteins, as well as within the housekeeper proteins</li>
<li>Data underwent background (IgG) normalization</li>
</ul>
</section></details>
</section>

<section id="sec-eda" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Exploratory Data Analysis</h1>
<p>The following section is used to understand the general structure of the data and whether the hypotheses that were defined initially are likely to identify significant findings. This qualitative exploration can also help identify any study design considerations for downstream analyses.</p>
<details>
<summary>
Click to show/hide exploratory data analysis steps
</summary>
<section id="dimensional-reduction" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="dimensional-reduction"><span class="header-section-number">4.1</span> Dimensional Reduction</h2>
<p>In this section, we use two dimensional reduction techniques to identify broad patterns in the expression data. For both of these, we start from the normalized data.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" aria-controls="tabset-6-1" aria-selected="true">PCA</a></li><li class="nav-item"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" aria-controls="tabset-6-2" aria-selected="false">UMAP</a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" aria-labelledby="tabset-6-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">target_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getPCA</span>(target_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_neg"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">the_prefix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PCA"</span>)</span></code></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" aria-controls="tabset-4-1" aria-selected="true">Basic</a></li><li class="nav-item"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" aria-controls="tabset-4-2" aria-selected="false">Faceted</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" aria-labelledby="tabset-4-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the variables that will determine the color/shape of the points in the dim reduction section:</span></span>
<span id="cb25-2">dim_reduction_color_by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> factors_of_interest[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb25-3">dim_reduction_shape_by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> factors_of_interest[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb25-4"></span>
<span id="cb25-5">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data),</span>
<span id="cb25-6">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> PCA_coords_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> PCA_coords_2)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes_string</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> dim_reduction_color_by,</span>
<span id="cb25-8">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> dim_reduction_shape_by),</span>
<span id="cb25-9">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb25-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PCA 1 ("</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">experimentData</span>(target_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>other<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>PCA[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%)"</span>),</span>
<span id="cb25-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PCA 2 ("</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">experimentData</span>(target_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>other<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>PCA[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%)"</span>),</span>
<span id="cb25-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PCA"</span></span>
<span id="cb25-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>()</span>
<span id="cb25-18"></span>
<span id="cb25-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(dim_reduction_color_by)) {</span>
<span id="cb25-20">  p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> pal_main[[dim_reduction_color_by]])</span>
<span id="cb25-21">}</span>
<span id="cb25-22"></span>
<span id="cb25-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PCA_log2_norm.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/PCA_log2_norm.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" aria-labelledby="tabset-4-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data),</span>
<span id="cb26-2">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> PCA_coords_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> PCA_coords_2)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb26-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes_string</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> dim_reduction_color_by,</span>
<span id="cb26-4">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> dim_reduction_shape_by),</span>
<span id="cb26-5">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb26-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> slide, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb26-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb26-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PCA 1 ("</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">experimentData</span>(target_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>other<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>PCA[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%)"</span>),</span>
<span id="cb26-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PCA 2 ("</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">experimentData</span>(target_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>other<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>PCA[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%)"</span>)</span>
<span id="cb26-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb26-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb26-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb26-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>()</span>
<span id="cb26-14"></span>
<span id="cb26-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(dim_reduction_color_by)) {</span>
<span id="cb26-16">  p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> pal_main[[dim_reduction_color_by]])</span>
<span id="cb26-17">}</span>
<span id="cb26-18"></span>
<span id="cb26-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PCA_log2_norm_faceted.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/PCA_log2_norm_faceted.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" aria-labelledby="tabset-6-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">target_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getUMAP</span>(target_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_neg"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">the_prefix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMAP"</span>)</span></code></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" aria-controls="tabset-5-1" aria-selected="true">Basic</a></li><li class="nav-item"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" aria-controls="tabset-5-2" aria-selected="false">Faceted</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" aria-labelledby="tabset-5-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data),</span>
<span id="cb28-2">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> UMAP_coords_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> UMAP_coords_2)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes_string</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> dim_reduction_color_by,</span>
<span id="cb28-4">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> dim_reduction_shape_by),</span>
<span id="cb28-5">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMAP 1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMAP 2"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMAP"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>()</span>
<span id="cb28-9"></span>
<span id="cb28-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(dim_reduction_color_by)) {</span>
<span id="cb28-11">  p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> pal_main[[dim_reduction_color_by]])</span>
<span id="cb28-12">}</span>
<span id="cb28-13"></span>
<span id="cb28-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMAP_log2_norm.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/UMAP_log2_norm.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" aria-labelledby="tabset-5-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data),</span>
<span id="cb29-2">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> UMAP_coords_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> UMAP_coords_2)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes_string</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> dim_reduction_color_by,</span>
<span id="cb29-4">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> dim_reduction_shape_by),</span>
<span id="cb29-5">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> slide, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMAP 1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMAP 2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>,</span>
<span id="cb29-10">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.box =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"vertical"</span>,</span>
<span id="cb29-11">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>()</span>
<span id="cb29-13"></span>
<span id="cb29-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(dim_reduction_color_by)) {</span>
<span id="cb29-15">  p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> pal_main[[dim_reduction_color_by]])</span>
<span id="cb29-16">}</span>
<span id="cb29-17"></span>
<span id="cb29-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMAP_log2_norm_faceted.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/UMAP_log2_norm_faceted.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Data in the PCA and UMAP show clustering primarily by segment type, with some localized clustering by response status.</p>
</div>
</div>
</section>
<section id="clustering-features-with-high-coefficient-of-variation" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="clustering-features-with-high-coefficient-of-variation"><span class="header-section-number">4.2</span> Clustering features with high coefficient of variation</h2>
<p>Another approach to explore the data is to calculate the coefficient of variation (CV) for each protein (<img src="https://latex.codecogs.com/png.latex?g">) using the formula <img src="https://latex.codecogs.com/png.latex?CV_g%20=%20SD_g/mean_g">. We then identify proteins with high CVs that should have large differences across the various profiled segments. This unbiased approach can reveal highly variable proteins across the study that may be of particular interest.</p>
<p>For this study, we plot the proteins with CVs in the 90th quantile for closer exploration. We use unsupervised hierarchical clustering based on Pearson distance, displayed as a heatmap.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1">top_quantile <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.90</span></span>
<span id="cb30-2"></span>
<span id="cb30-3">CV_dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assayDataApply</span>(target_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_neg"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MARGIN =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, getCV)</span>
<span id="cb30-4">cv_feats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(CV_dat)[CV_dat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(CV_dat, top_quantile)]</span>
<span id="cb30-5"></span>
<span id="cb30-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cv_heatmap.RDS"</span>))){</span>
<span id="cb30-7"> cv_heatmap <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cv_heatmap.RDS"</span>))</span>
<span id="cb30-8">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb30-9">  cv_heatmap <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Heatmap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assayDataElement</span>(target_data[cv_feats, ], </span>
<span id="cb30-10">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_neg"</span>)))),</span>
<span id="cb30-11">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRamp2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)), </span>
<span id="cb30-12">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0092b5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#a6ce39"</span>))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>))),</span>
<span id="cb30-13">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'z-score'</span>,</span>
<span id="cb30-14">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustering_distance_rows =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearson"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustering_method_rows =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"average"</span>,</span>
<span id="cb30-15">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustering_distance_columns =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearson"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustering_method_columns =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"average"</span>,</span>
<span id="cb30-16">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_split =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_split =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb30-17">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgray"</span>),</span>
<span id="cb30-18">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_row_names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_column_names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb30-19">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use_raster =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb30-20">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">top_annotation =</span> </span>
<span id="cb30-21">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HeatmapAnnotation</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data)[, factors_of_interest],</span>
<span id="cb30-22">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> pal_main,</span>
<span id="cb30-23">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>))</span>
<span id="cb30-24">        )</span>
<span id="cb30-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(cv_heatmap, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cv_heatmap.RDS"</span>))</span>
<span id="cb30-26">}</span>
<span id="cb30-27"></span>
<span id="cb30-28">svglite<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">svglite</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(qc_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cv_heatmap.svg"</span>),</span>
<span id="cb30-29">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.5</span>)</span>
<span id="cb30-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">draw</span>(cv_heatmap, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_legend_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>)</span>
<span id="cb30-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dev.off</span>()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/cv_heatmap.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this plot of top CV proteins, we see that the cv data cluster by segment and slide.</p>
</div>
</div>
<p>After these exploratory analyses are complete, we recommend saving the processed object, <code>target_data</code>, for easier reloading in future sessions.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save normalized expression to disk.</span></span>
<span id="cb31-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">object=</span>target_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(object_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"target_data.RDS"</span>))</span></code></pre></div>
</details>
</div>
<p>We’ve now done some basic exploratory analysis to examine which segments and proteins tend to cluster together, and to identify which factors may be the biggest drivers of differences across our dataset. Next, we’ll move on to test explicitly laid out hypotheses in our differential expression section.</p>
</section></details>
</section>

<section id="sec-de" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Differential Expression</h1>
<p>Differential expression (DE) is a common method used to compare protein expression between sample groups and to quantify the significance of these differences. We perform DE on a per-protein basis where the normalized expression is modeled using a linear mixed-effect model (LMM) to account for the sampling of multiple ROI/AOI segments per tissue.</p>
<details>
<summary>
Click to show/hide differential expression steps
</summary>
<p>For a given comparison, we will subset the data down to the relevant segments and perform DE. We provide tables, heatmaps, violin plots, and volcano plots of the top differentially expressed proteins.</p>
<section id="contrasting-groups-with-linear-mixed-models" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="contrasting-groups-with-linear-mixed-models"><span class="header-section-number">5.1</span> Contrasting groups with linear mixed models</h2>
<p>In a given contrast, we are interested in comparing the magnitude of differences between groups and quantifying the significance. In many GeoMx experiments, multiple areas of illumination (AOIs) or regions of interest (ROIs) are sampled in a given slide. To account for the nested, non-independent sampling, we often use a linear mixed effect model (LMM) with slide as a random effect. The LMM accounts for the subsampling per tissue, allowing us to adjust for the fact that the multiple regions of interest placed per tissue section are not independent observations, as is the assumption with other traditional statistical tests.</p>
<p>Overall, there are two main types of the LMM models when used with GeoMx data: A) with random slope and B) without random slope.</p>
<p>When comparing features that co-exist in a given tissue section, a random slope is included in the LMM model. When comparing features that are mutually exclusive in a given tissue section the LMM model does not require a random slope. We represent the two variations on the LMM in the schematic below. Note that the schematic says ‘gene’ but the same logic applies to proteins. In this example, there are a number of slides (“Slide”). A slide is classified as either healthy or a disease in the “Disease” category. Within a slide, different regions are present and these are illustrated as pink or green ROIs.</p>
<p><em>Example A</em>: When estimating the effect of “Region”, “Slide” is used as a random effect. Because the slope of “Region” may differ across slides, “Region” is used as a random slope.</p>
<p><em>Example B</em>: In this example study design, Disease is mutually exclusive to a slide. In other words, a slide can only be a “disease” or “healthy”. In this case, there is no need to include the additional term in the model.</p>
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/images/GeomxDETypes.png" class="img-fluid"> In the breast cancer dataset that we’re working with in this vignette, there are not known biological differences (for example tumor vs healthy tissue) within slides and so we will set up our DE test following Example B. We ask: <em>within the stromal compartments, how does protein abundance differ between responders and non-responders?</em></p>
</section>
<section id="contrast-1-ck--responder-vs-non-responder" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="contrast-1-ck--responder-vs-non-responder"><span class="header-section-number">5.2</span> Contrast 1: CK- Responder vs Non-responder</h2>
<p>We will compare the stromal compartment between responders vs non-responders in the CK negative compartment.</p>
<p>The following formula was used to model differences for a given protein:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20protein%20%5Csim%20Responder%20+%20(1%7Cslide)%20"></p>
<p>We adjust for the multiple sampling of ROI/AOI segments per tissue with the <img src="https://latex.codecogs.com/png.latex?slide"> variable.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert test variables to factors</span></span>
<span id="cb32-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (variable <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> factors_of_interest){</span>
<span id="cb32-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data)[[variable]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data)[[variable]])</span>
<span id="cb32-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span>(variable)</span>
<span id="cb32-5">  }</span>
<span id="cb32-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"slide name"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> factors_of_interest){</span>
<span id="cb32-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data)[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"slide"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data)[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"slide name"</span>]])</span>
<span id="cb32-8">}</span>
<span id="cb32-9"></span>
<span id="cb32-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Responder <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Responder, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Yes"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No"</span>))</span>
<span id="cb32-11"></span>
<span id="cb32-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Subset data: Filter samples for the contrast as needed. </span></span>
<span id="cb32-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add and remove parameters as needed. </span></span>
<span id="cb32-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If no filtering is required, use contrast{i}_samples &lt;- rownames(filter(pData(target_data)))</span></span>
<span id="cb32-15">model_formula1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">~</span> Responder <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>slide)</span>
<span id="cb32-16">group_variable1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Responder"</span></span>
<span id="cb32-17"></span>
<span id="cb32-18">contrast1_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb32-19"> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(target_data),</span>
<span id="cb32-20">                 Segment <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CK neg"</span>))</span>
<span id="cb32-21">contrast1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> target_data[,contrast1_samples] </span>
<span id="cb32-22"></span>
<span id="cb32-23"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(de_data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"de_contrast1.RDS"</span>))){</span>
<span id="cb32-24"> de_contrast1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(de_data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"de_contrast1.RDS"</span>))</span>
<span id="cb32-25">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb32-26">  de_contrast1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mixedModelDE</span>(contrast1,</span>
<span id="cb32-27">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_neg"</span>,</span>
<span id="cb32-28">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">modelFormula =</span> model_formula1,</span>
<span id="cb32-29">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">groupVar =</span> group_variable1, </span>
<span id="cb32-30">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nCores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb32-31">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">multiCore =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb32-32">  de_contrast1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">formatLMMResults</span>(de_contrast1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_adjust_method =</span> p_adjust_method_selected)</span>
<span id="cb32-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(de_contrast1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(de_data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"de_contrast1.RDS"</span>))</span>
<span id="cb32-34"></span>
<span id="cb32-35">}</span>
<span id="cb32-36"></span>
<span id="cb32-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Identify top features to label</span></span>
<span id="cb32-38">de_padj_threshold_contrast1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span></span>
<span id="cb32-39">de_fc_threshold_contrast1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span></span>
<span id="cb32-40"></span>
<span id="cb32-41">label_de1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getTopFeatures</span>(de_contrast1, </span>
<span id="cb32-42">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_features =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>,</span>
<span id="cb32-43">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">est_thr =</span> de_fc_threshold_contrast1, </span>
<span id="cb32-44">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_adjust_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P"</span>,</span>
<span id="cb32-45">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_adjust_thr =</span> de_padj_threshold_contrast1)</span></code></pre></div>
</details>
</div>
<p>Figures in the tabs below can be used to visualize differences between our two groups. The <code>Volcano</code> tab plots the log<sub>2</sub> fold change (FC) between groups within the contrast and significance (p-value) for all protein, as well as a correction for multiple comparisons (<code>p_adjust</code>). The <code>Heatmap</code> tab visualizes the top proteins using unsupervised hierarchical clustering on Pearson distances of the normalized data z-scores.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" aria-controls="tabset-7-1" aria-selected="true">Volcano</a></li><li class="nav-item"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" aria-controls="tabset-7-2" aria-selected="false">Heatmap</a></li><li class="nav-item"><a class="nav-link" id="tabset-7-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-3" aria-controls="tabset-7-3" aria-selected="false">Violin</a></li></ul>
<div class="tab-content">
<div id="tabset-7-1" class="tab-pane active" aria-labelledby="tabset-7-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">de_contrast1_volcano_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeVolcano</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df=</span>de_contrast1, </span>
<span id="cb33-2">                                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to_label=</span>label_de1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>all,</span>
<span id="cb33-3">                                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label_color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey20"</span>, </span>
<span id="cb33-4">                                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">SCALE=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">LWD=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb33-5">                                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">the_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CK- Responder vs CK- Non-responder"</span>),</span>
<span id="cb33-6">                                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log_type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2(FC)"</span>, </span>
<span id="cb33-7">                                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fc_cutoff=</span>de_fc_threshold_contrast1,</span>
<span id="cb33-8">                                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_adjust_column =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toupper</span>(p_adjust_method_selected),</span>
<span id="cb33-9">                                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pval_cutoff=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb33-10"></span>
<span id="cb33-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write.table</span>(de_contrast1_volcano_list[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(de_data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contrast1_de_volcano.tsv"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"   "</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quote=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col.names=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row.names=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb33-12">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> de_contrast1_volcano_list[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb33-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(de_plot_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contrast1_de_volcano.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/de/Plots/contrast1_de_volcano.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-7-2" class="tab-pane" aria-labelledby="tabset-7-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">heatmap1_features <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(de_contrast1, de_contrast1[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P"</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> de_padj_threshold_contrast1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> </span>
<span id="cb34-2">                                    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Estimate</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> de_fc_threshold_contrast1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Feature))</span>
<span id="cb34-3"></span>
<span id="cb34-4">heatmap_dat1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(</span>
<span id="cb34-5"> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assayDataElement</span>(contrast1[heatmap1_features, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"neg_norm"</span>))))</span>
<span id="cb34-6">contrast1_de_heatmap <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb34-7"> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Heatmap</span>(heatmap_dat1,</span>
<span id="cb34-8">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRamp2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)), </span>
<span id="cb34-9">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0092b5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#a6ce39"</span>))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">121</span>))),</span>
<span id="cb34-10">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'z-score'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use_raster =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb34-11">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustering_distance_rows =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearson"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustering_method_rows =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"average"</span>,</span>
<span id="cb34-12">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustering_distance_columns =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearson"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustering_method_columns =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"average"</span>,</span>
<span id="cb34-13">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_split =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_split =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb34-14">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgray"</span>),</span>
<span id="cb34-15">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_row_names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_column_names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb34-16">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">right_annotation =</span> </span>
<span id="cb34-17">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowAnnotation</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">foo =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">anno_mark</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">at =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(label_de1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>all, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(heatmap_dat1)),</span>
<span id="cb34-18">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> label_de1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>all)),</span>
<span id="cb34-19">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">top_annotation =</span> </span>
<span id="cb34-20">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HeatmapAnnotation</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(contrast1)[,factors_of_interest],</span>
<span id="cb34-21">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> pal_main,</span>
<span id="cb34-22">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>)))</span>
<span id="cb34-23"></span>
<span id="cb34-24">svglite<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">svglite</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(de_plot_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contrast1_de_heatmap.svg"</span>),</span>
<span id="cb34-25">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb34-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">draw</span>(contrast1_de_heatmap, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">merge_legend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_legend_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>, </span>
<span id="cb34-27">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">annotation_legend_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjust_annotation_extension =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb34-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dev.off</span>()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/de/Plots/contrast1_de_heatmap.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-7-3" class="tab-pane" aria-labelledby="tabset-7-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(label_de1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(contrast1)))){</span>
<span id="cb35-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"column names in pheno data cannot be label feature names."</span>)</span>
<span id="cb35-3">}</span>
<span id="cb35-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># individual points</span></span>
<span id="cb35-5">contrast_factor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> factors_of_interest[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb35-6">violin_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pData</span>(contrast1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(contrast_factor)),</span>
<span id="cb35-7">                  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assayDataElement</span>(contrast1[label_de1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>all, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"neg_norm"</span>)))</span>
<span id="cb35-8">violin_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> violin_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Feature"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Expression"</span>)</span>
<span id="cb35-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(violin_df)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contrast_factor"</span></span>
<span id="cb35-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format summary stats</span></span>
<span id="cb35-11">violin_p_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(de_contrast1, Feature <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> label_de1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>all)</span>
<span id="cb35-12">violin_p_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> violin_p_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> Comparison, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">into=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"group1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"group2"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" vs "</span>)</span>
<span id="cb35-13">violin_p_df[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toupper</span>(p_adjust_method_selected)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(violin_p_df[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toupper</span>(p_adjust_method_selected)], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb35-14">violin_exp_max <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ddply</span>(violin_df, .(Feature), summarize,</span>
<span id="cb35-15">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y.position=</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(Expression)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># +1 for safe log2</span></span>
<span id="cb35-16">violin_p_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> base<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(violin_p_df, violin_exp_max, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Feature"</span>)</span>
<span id="cb35-17"></span>
<span id="cb35-18"></span>
<span id="cb35-19">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(violin_df, </span>
<span id="cb35-20">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>contrast_factor, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>Expression, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>contrast_factor)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb35-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_violin</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb35-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> pal_main[[contrast_factor]]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Feature, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(contrast_factor), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Expression (normalized counts)"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trans =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expansion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mult =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb35-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(contrast_factor)))</span>
<span id="cb35-29">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ggprism<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_pvalue</span>(</span>
<span id="cb35-30">  violin_p_df,</span>
<span id="cb35-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{classifyPAdjustMethod(p_adjust_method_selected)} = {violin_p_df[[toupper(p_adjust_method_selected)]]}"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label.size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.6</span>,</span>
<span id="cb35-32">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y.position =</span> violin_p_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y.position</span>
<span id="cb35-33">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>)</span>
<span id="cb35-34"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(de_plot_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contrast1_FOI.svg"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/de/Plots/contrast1_FOI.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>The searchable table below lists log<sub>2</sub> fold change estimates and p-values for each protein used in the above heatmap.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Change the adjusted P-value column name to its classified adjusted P-value method for display.</span></span>
<span id="cb36-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(p_adjust_method_selected <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>){</span>
<span id="cb36-3"> dt1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> de_contrast1[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Feature"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comparison"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Estimate"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P"</span>)]</span>
<span id="cb36-4"> selected_dt1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(dt1, Feature <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> heatmap1_features) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(P)</span>
<span id="cb36-5">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb36-6"> dt1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> de_contrast1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(P)</span>
<span id="cb36-7"> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(dt1)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(de_contrast1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> p_adjust_method_selected)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classifyPAdjustMethod</span>(p_adjust_method_selected)</span>
<span id="cb36-8"> selected_dt1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(dt1, Feature <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> heatmap1_features) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(p_adjust_method_selected)</span>
<span id="cb36-9">}</span>
<span id="cb36-10"></span>
<span id="cb36-11">results_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results.rds"</span>))</span>
<span id="cb36-12">results_list<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dt1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dt1</span>
<span id="cb36-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(results_list, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results.rds"</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-2c9124abdea73d8001ba" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2c9124abdea73d8001ba">{"x":{"filter":"none","vertical":false,"extensions":["Buttons","Scroller","FixedColumns"],"data":[["HIF-1 alpha","TLR7","CD68","PRDM1/Blimp1","Syk (phospho Y352) +ZAP70 (phospho Y319)","Histone H3 (tri methyl K9)","Histone H3 (mono methyl K4)","Histone H3 (di methyl K79)","Histone H3","SHP1","S100A8 + S100A9","HLA-DR","Histone H3 (phospho S10)","MRP8","Histone H2A (acetyl K5)","STAT6 (phospho Y641)","Histone H3 (acetyl K14)","LAG-3","p53 (phospho S392)","Bcl-XL","SLC7A5/LAT1","RPS6","p53 (acetyl K373)","Histone H2B (acetyl K5)","Histone H3 (acetyl K18)","Histone H3 (acetyl K9)","Syndecan-1","iNOS","Topoisomerase II alpha (phospho T1343)","Histone H3 (acetyl K27)","CXCR3","GITR","CD31","PI 3 Kinase p85 alpha","CD39","S100A12/CGRP","c-Fos","Cathepsin S","FAK","IFNGR1","Cytokeratin 1","IL-1 alpha","HLA-DPB1","PI 3 Kinase catalytic subunit alpha/PIK3CA","IL22 RA2/IL-22BP","PTGES2/Gbf1","Cdk6","Progesterone Receptor (phospho S190)","NCR1","IL-15RA","PU.1/Spi1","CCR6","IL-5RA","CD16","Myeloperoxidase","LYVE1","NCAM1","Tuberin (phospho T1462)","Oct4","Insulin Receptor beta","TIM 3","CCL18","ErbB4 / HER4+ErbB2 / HER2","Tuberin","Histone H2A.X","Insulin Receptor alpha","MLH1","CD38","Sonic Hedgehog","T-bet / Tbx21","CXCL5 + CXCL6","Somatostatin Receptor 2","GSK3 beta","Histone H3 (tri methyl K36)","S100A9","ST2","Rho A + B + C","Dihydrofolate reductase (DHFR)","Urokinase","HLA E","NKG2D","MEK1 (phospho S298)","CD11c","CDK1","SOCS3","MMP8","IL-6R","IMP3","PF4","Topoisomerase I","p63","TNF alpha","CD133","CD47","Glucocorticoid Receptor (phospho S226)","CD33","Raptor","ARID3A","Rb (phospho S807)","Granzyme A","Catalase","VCAM1","STAT5 (phospho Y694)","Ms IgG2b","FOXO4/AFX","Tuberin (phospho S1254)","GGT1/GGT","CD15","CD40 Ligand","EGFR","ATG7","2B4","Oct-2","Neutrophil Elastase","SHP2","MS4A2","CDK1 + CDK2 + CDK3 + CDK5 (phospho Y15)","TNFAIP3","Indoleamine 2_3-dioxygenase","HLA A","TRAF6","YKL-40/CHI3L1","RPS6 (phospho S235 + S236)","IGF1 Receptor","Liver Arginase","Ras","p73","Cytokeratin 8 (phospho S431)","SDHA","Vimentin","APG5L/ATG5","CD99","STAT6","CD14","Histone H2A (phospho T120)","ALDH1A1","ErbB4 / HER4 (phospho Y1162)","EpCAM","JNK1 + JNK2 + JNK3 (phospho T183+T183+T221)","Glutaminase","HDAC3","TBR2 / Eomes","CD40","MMP7","SIRT1","MMP1","MMP3","Glucose Transporter GLUT1","LILRB3","Histone H3 (di methyl K4)","SIGLEC5","NQO1","TAK1","Rad51","p53","N Cadherin","IRF4","Insulin","TLR9","PI 3 Kinase catalytic subunit gamma/PI3K-gamma","CXCR5","TLR8","IDH1","Nanog","CD79a","p40 - DeltaNp63","GAPDH","HDAC6","Macrophage Inflammatory Protein 3 alpha","Bak","Cyclin E1","ICOS","Bad","HDAC9","Musashi 1 / Msi1","Thymidylate Synthase","KIR3DL1 + KIR3DS1","NFAT2","HMGB2","beta Actin","p57 Kip2","STAT3 (phospho Y705)","CD79b","AKT1 (phospho S473)","UBE2C","IKKi/IKKe","CXCR4","CXCR6","Cytokeratin 17","PLCG 2","HLA F","CD127","Wee1","Rb (phospho S608)","CCR3","Adenosine Receptor A2a","Mannose Receptor","BRCA1","HuR / ELAVL1","ETS1","PI 3 Kinase p85 beta","MelanA","CD134 / OX40L receptor","PDGF B","Osteopontin","LAMP2A","SMAD5","Hsp90","Topoisomerase II alpha (phospho S1106)","NSD3","Galectin 3","CD64","IL-1RA","Rb (phospho T252)","CD34","CD94","Carbonic Anhydrase 9/CA9","CD11b","CD74","SIRT3","Macrophage Inflammatory Protein 1 alpha / CCL3","Wnt3a","PARP1","Occludin","Syk","CD44","p53 (phospho S46)","ATM","Caspase-3","MEKK3","Cdk4","Transferrin Receptor","ErbB2 / HER2 (phospho Y877)","KDM3A / JHDM2A","Bax","Ikaros","STAT3","Poliovirus Receptor/PVR","TAP2","Src","Heme Oxygenase 1","Prostate Specific Antigen","IKK alpha","CD4","Caspase-10/CASP-10","SOX9","CD103","Interferon gamma","Smad2 (phospho S467)","CDKN2A/p16INK4a","NAK/TBK1","AMPK alpha 1","Rb (phospho T356)","Androgen Receptor","PRAS40","HDAC4 + 5 + 9","Bid","RAGE","IL-22RA1","IL3RA/CD123","Ki67","HDAC1","SIRT1 (phospho S47)","Topoisomerase II alpha","p27 KIP 1","Collagen IV","IKK beta","Melanoma gp100","TMS1/ASC","ERG","CD66b","BRAF","VEGF Receptor 1","C Reactive Protein","eNOS","RPS6 (phospho S240 + S244)","IL-12RB1","c-Maf","TRAF1","cIAP2","HLA B7","STING","15-PGDH","Beclin 1","FGFR2","HMGB1","ICAM1","ATM (phospho S1981)","Hsp27 (phospho S78)","NRF1","Lamin A + Lamin B1 + Lamin C","BTK","CD90 / Thy1","IGF2BP1/IMP1","IL-2RG","Wilms Tumor Protein","FANCI","Smac/Diablo","GRP78 BiP","IL-12A","COX2 / Cyclooxygenase 2","FBP2","p38 beta/MAPK11 + p38 alpha/MAPK14","Smad4","CDKN2A/p14ARF","STAT4","Rel B","LAMP1","p27 KIP 1 (phospho S10)","Nectin 2","Met (c-Met) (phospho Y1349)","Cyclin D1","Chk1","Rb IgG","Cathepsin G","CDK1 (phospho T161) + CDK2 / CDK3 (phospho T160)","Cyclin E2","PTCH2","ENO1 + ENO2 + ENO3","HLA G","beta glucuronidase (GUSB)","CD70","CD11a","CD73","CD177","PTEN","ASS1","S100A4","Cleaved PARP1","ERK1","c-Kit","Lactate Dehydrogenase","Actin","Rho","IL-1 beta","CD86","PAK1+PAK2+PAK3 (phospho S141 + S144 + S154)","Axl","CD28","Aldolase B+Aldolase C","CTLA4","Cytokeratin 8","Rb","VEGFD","SCF","S100P","CD27","CD83","IL-18","KIR2DL1 + KIR2DL2","PAK1","KMT6 / EZH2","Bcl6","Pro Caspase-8","NKG2A + NKG2E + NKG2C","Rt IgG2a","RSK1 p90","ERK1 (phospho T202) + ERK2 (phospho T185)","CREB","IRF3","Cyclophilin A","AKT3 + AKT2 + AKT1","Wee1 (phospho S642)","MDM2 (phospho S166)","PRAME","Hmr IgG","AKR1B10","beta 2 Microglobulin","Histone H3 (phospho S28)","VEGF Receptor 2","Dnmt1","CPT1A","Hexokinase 1","CD3D","ERK2","Cytokeratin 19","CD44v6","Granzyme K","Integrin alpha 5","SMAD1 + SMAD5 + SMAD9 (phospho S463 + S465 + S467)","E Cadherin","FADD","FABP4","Cytokeratin 14","ROS1","ATR (phospho S428)","Cyclin A2","ZAP70","Retinoic Acid Receptor beta","SOD2/MnSOD (acetyl K68)","IL-2 Receptor alpha","Calreticulin","Lck","Fibronectin","alpha smooth muscle Actin","STAT1","JAK3","STAT1 (phospho S727)","IRF5","Chk2","GLB1/Beta-galactosidase","TEF1/TEAD-1","ACE2","Ms IgG1","Von Willebrand Factor","GNLY/Granulysin","DUSP6","SFRP1","CD3 epsilon","Cyclin B1","Carbonic Anhydrase 3/CA3","S100 beta","MEK2","C4a","NFkB p105 / p50","TROP2","RSK1 p90 (phospho T359)","FOXP3","Granzyme B","VISTA","uPA Receptor/U-PAR","KMT6/EZH2 (phospho T487)","Nectin-4","Sumo 1","Cytokeratin 5","S6K1","JunD","MyD88","Podoplanin / gp36","Collagen I","CD63","MMP14","CD163","Glucose 6 Phosphate Dehydrogenase","APC","ALK","SOD2/MnSOD","IKK gamma/NEMO","Fatty Acid Synthase","c-Jun (phospho S63)","MEK4/MKK4 (phospho S80)","Fos B","SQSTM1 / p62","AIF","GLP-1R","TOMM20","PCNA","ErbB3 / HER3","c-Myb (phospho S11)","CD18","c-Myc (phospho S62)","Scavenging Receptor SR-BI","Hsp27","p38 (phospho T180)","CD276","GSK3 beta (phospho S9)","PKC beta 1","CD3G","STAT5a","MSH2","Glutathione Peroxidase 4","PDGFR alpha + PDGFR beta","Progesterone Receptor","CD45","Histone H3 (tri methyl K27)","ERK1 (phospho T202 + Y204) + ERK2 (phospho T185 + Y187)","Smad2 (phospho S255)","BRG1","active YAP1","Rb (phospho T780)","Notch1","beta Catenin","PSMA","pan Cytokeratin","Ret","Pan Trk","Cullin 1/CUL-1","DR5","CD20","ROCK2 + ROCK1","NF-kB p65","FOXO1A","CCR7","Integrin beta 1","Integrin alpha 6","Syk (phospho Y323)","Smad2","Cathepsin K","Bim","STAT5b","Ubiquitin","EGFR (phospho Y1068)","IFIT1","CXCL10/IP-10","Brd4","M-CSF","LEF1","IDH2","Argonaute-2","IL-33","15 Lipoxygenase 1","ATF2","YAP1 (phospho S127)","VEGFA","C5 / C5b","Caspase-3 p12","Hsp70","Periostin","CCR5","FGF2","IL4","ATF3","gamma H2A.X (phospho S139)","mTOR","Rb (phospho T373)","MX1","PD-L2","LC3B","mTOR (phospho S2448)","ATG12","ROCK1","GATA3","beta Tubulin","CREB (phospho S133)","AKT1 (phospho T450)","PD-L1","SFRP4","Aurora A","MICA + MICB","CD8 alpha","c-Jun","Tissue Factor","PDGFR alpha","c-Myc","MUC1","CD22","CD36","MEK1","HDAC2","ErbB2 / HER2","Met (c-Met)","EMR1/ADGRE1","Cdk2","SIRT2","BFL-1/GRS","ISG15","GLP-1","Hexokinase II","MSH6","Aldolase","CREBBP","TGF beta 1","PP2A alpha + beta","5 Lipoxygenase/5-LO","beta Arrestin 1","STAT2","Bcl-2","KIR2DL3","TMPRSS2","TRAF2","CD45RA","LDL Receptor","RUNX1 / AML1 + RUNX3 + RUNX2","CD272/BTLA","ARID1A","Smad3 (phospho S423 + S425)","PD1","Smad3","HLA-C","Fas","Caveolin-1","IKB alpha","Survivin","CSF-1-R","Mucin 5AC","CDK1 + Cdk2 + Cdk3 (phospho T14)","Monoamine Oxidase A/MAO-A","MMP9","PTEN (phospho T366)","YAP1"],["No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes","No vs Yes"],[0.6611207754493321,0.4063802434960061,0.801108211617142,0.2503537162683815,0.2981994748665276,1.059430856734876,0.8264992080772733,0.8525453167572088,0.6031747933129367,0.2780353357335477,1.458980088072234,1.529845760608016,1.100751404331,2.090149800480897,0.875016754966534,0.3813821328325142,0.9358025752493909,0.5338855824525087,0.6422059297352777,0.5470630595579358,0.6163051271025128,0.3893147239873748,0.5837248889018072,0.5400349949434959,0.6995746494854306,1.173557188125007,1.52517666795677,0.696267905458094,0.5101531405058584,0.5970839115685861,0.4506172803836964,0.5941731818311772,0.487000642544647,0.414992430549255,0.4862752452629211,0.7096559628882039,0.3261205682762813,0.983611325466066,1.309165216593301,0.3639841819752231,0.320243390792643,1.11814428972961,0.8853777650513588,0.6143173650779766,0.2873647587674098,0.4169274138672563,0.6947405256665959,0.377851862111298,0.3539518437723115,0.5126892101710415,0.3954002229667518,0.7384186453641758,0.3248501703481297,1.076698146909489,0.2583678108136199,0.3746174750958853,0.3090045041951373,0.2483569058734132,0.3420513892359823,0.4807492164161655,0.3896484286046538,0.2988883560267738,0.3934520385455633,1.014440704131324,0.6917974613916209,0.4356512367638897,0.3952156168432663,1.051808939358483,1.070059146268154,0.3223442709046447,0.363344428820141,0.3090924220595924,0.3865162681525688,0.3569372697021697,0.8759956953925342,0.2347859691103093,0.3426731032779705,0.714736245304143,0.3766598085947905,0.6614529644335673,0.2484043609528421,0.3262073512254265,0.3702440300176859,0.5969211171929162,0.3251590631002373,0.2633125236163727,0.2436950845231167,0.2560488381583353,0.2675067544788792,0.3733822314692042,-0.3687286183345732,0.2708975767448453,0.507314175063744,0.3860848526061013,0.372343826164518,0.3322170804465169,0.2752478366786451,0.2971479284427015,0.3306748127744324,0.2620460694877796,0.588721944608888,0.3657814278424805,0.4574445446676403,0.07571573851070877,0.2388630397900357,0.5585619175529816,0.3332718814219012,-0.5146003948777734,0.2071825487507813,0.3910292018642901,0.5251507343943804,0.2335675058599201,0.2705443719101355,0.2347422507347381,0.2596528608891097,0.3188875703640469,-0.2289915924441373,0.3875194637074704,0.4985162945415785,0.9496318711031071,0.2545186469199519,0.2259707940346386,0.5224339202071654,0.2839508799700628,0.1865464138560672,0.2999145720551998,0.25674310932496,-0.5201096045030209,0.3141463191909361,0.7550060972507426,0.1880106466234951,0.2388143609133363,0.462521033971672,0.3933086580155028,0.3760151376754904,0.2798837016472128,0.2641134628057177,-0.7988024950279691,0.2189260959428848,0.6696164034310036,0.2688470112405651,0.2262701428327917,0.5014430246483041,0.2557740256119637,0.2458456734027595,0.1803798770837597,0.2704950231410339,-0.6296353108683508,0.2487633684459481,0.4636313645426101,0.2645226685088564,0.5782810123594742,0.1899113242056886,0.2267403224263966,0.2214911702075115,0.2184798452525123,0.3267471695609942,0.2204561834439543,0.2342200876845875,0.2980726016178446,0.2613380384010473,0.2593875088181912,0.3704126414340834,0.1800511384867812,0.2439074824557407,0.2115830328696549,-0.3905868625430045,0.3619785670728617,0.2002532590505321,0.6637169011547523,0.3208487124822199,0.243072127762589,0.2646977389811755,0.335553979886363,0.1170424492127879,0.284825248256126,0.2145264519035529,0.6000393395805329,0.4329690722210218,0.3517644694746358,0.3009333383810445,0.2645891188845575,0.3395704048544039,0.2353603839326599,0.1927162061995996,0.461460375926366,0.2211092965458355,0.2072775947566081,0.1585995222126484,0.2748875118904003,0.1424646183092159,0.2201864734333262,0.254152661229447,0.273640187990866,0.1878619965059014,0.2800224363489603,0.4997015963938379,0.2369285129532804,0.2964651885720548,0.2152877503403829,0.1762608863465273,0.1881803029246116,0.2444483750319216,0.4840140928339645,-0.3588842950208981,0.34618872376743,0.2711443793095283,0.2043328636798865,0.186122470907622,0.2682415878821493,0.6430817664385824,0.2538446864507237,0.1582584229179302,0.2187447245107896,0.2835169922975136,0.1717189564043499,-0.3118546137552302,0.1559827974315673,0.5549041230427262,0.2087277030667908,0.1642107806255544,0.1088436267702086,0.2557526943112788,0.1383082981985598,0.2248233607326344,0.3633521781226555,0.2138662782065762,0.2213672115891216,0.2447072451225126,0.1786089125350002,0.2198152352395236,0.2346051338472279,0.202373003130577,0.1396715715052371,0.2878542306732227,0.4859149900460588,0.2492432967822046,0.2030326732449208,0.8399030456524708,0.2376413636537645,0.3915364650672782,0.1577299357701743,0.2817757237102555,0.2658284697768623,0.2666382760744213,0.2827685950981214,0.158030939798471,0.1300906995524344,0.2897149477367857,-0.1740527914278348,0.2431100814915534,0.1753906903811254,0.1650321190456085,-0.3411433486577142,0.1651779056979582,0.3099874180331064,0.2338231862358491,0.141153287404925,0.1604355265671726,0.1967523962286649,0.1931049065380444,0.1480777244183566,0.2502480314974256,0.2377855839840341,0.4400162076994395,0.1564753422965113,0.147845514593569,0.1464953294982892,0.5542481693405173,0.2405447250989259,0.2318399994380467,0.2102544599837384,-0.2806523430133966,-0.1533935169259328,0.228606018719903,0.3483832274527814,0.2302151948661577,0.1204864230128621,0.2691607831085494,-0.1473708580044384,-0.3094032303707837,0.3875527438968631,-0.245092470895429,-0.201626227807541,0.1398738666200524,0.3662105235270547,0.1518029767209569,0.2485145212258362,-0.3469674138212699,0.4495029083053995,0.3164864771915233,0.1646156981420853,0.3160365546061102,0.1206235782749046,0.1913566391127973,0.08508915387508972,0.1472679184507549,0.2082341788537648,0.1092868792889259,0.150468542186996,0.07787014135175213,0.09973501687252316,0.09952016750116656,0.1408377600080212,-0.1199621952208774,0.2011060310048744,0.235336827532711,0.2166681594355362,0.1841253628204321,0.1555617551992186,0.2218721721371815,0.1306842427676562,0.1208064845242763,0.09580078907624276,0.3695761020623664,0.3665190329494137,0.1038277085378029,0.1870749576934109,-0.127103444253995,0.2229303416769793,0.5092349010702023,0.1078919143342565,0.1644952144072356,0.1927358343774131,0.1303268378604147,0.1527132898236154,0.1439569508125654,0.2847067249042102,0.1099216302317061,0.2586528697591192,0.1318953580960342,-0.2138175211648528,-0.1713486145424601,-0.1684017614977467,0.2241054530214206,0.1226095789329733,0.2496820465998434,-0.2047736699899232,0.1020716713776804,0.1102623227316995,-0.09923313383483161,-0.2781977766564893,0.09620625951688357,0.1061819122489787,0.1355063306724123,0.08567642321726621,0.2046696667522278,0.1063351680286763,0.1357217767296339,0.1051261064881273,0.1440666906661054,0.1594689627805664,0.09584881607417751,0.1223889134984669,0.1180247620481135,0.06954180984996834,0.1054742228289941,0.08577723983087306,0.1707174506330416,0.2651052976089389,-0.2407564489654498,0.1959409786183495,0.107496872750607,0.1513201475856141,0.1020680147033129,-0.1647652217945831,-0.113849692003514,0.511240639112569,0.2894369292905088,0.1437576169181825,0.09807329340635093,0.1105851690345196,0.174845827742082,0.2507133639610955,0.2845541417766144,-0.3449737738109118,0.138060972321995,0.07747658465902897,-0.2034602049460529,0.1962729262624477,0.3833233674752749,0.1097653239886961,-0.2080081349764023,0.08320464873726659,0.06511137812230688,0.1196820498800921,0.08453699908766796,0.2432701509747909,-0.0741088291036455,0.204846046142154,0.08425121812084606,0.1768632549096263,0.1698969620892861,-0.5803211271804183,-0.3741918696467527,0.3984795635623501,0.06970437897965996,0.3276217791915582,0.07666718486632292,0.1954692023105089,0.2727713900052515,0.08421641584284553,-0.1967989874560089,-0.04766546944256835,0.1523640649499595,0.08779553800320851,0.06934648229523639,0.1045012248635073,0.1859623974148101,-0.08016930803957246,0.1009972766762631,0.1918651854905557,0.1926941870849958,-0.1976958443259795,0.2920223890947448,0.1962279136661107,0.1350692200942802,-0.05917561863657374,0.07506789770089203,0.1718936295846905,0.1235017989451681,0.1505007719465417,0.08152239413743276,0.09862847641804202,-0.2241703506254126,0.1285920420388992,0.1499635771736707,0.09571851838470817,0.1304023224799259,-0.3820390500421316,0.1503519193324136,0.07968264152735642,0.07740987230617398,-0.1186655541374918,0.07404714114807297,0.06257422152999659,0.1804540876663084,-0.07210965633153901,-0.189037672475997,0.05824807992444954,0.1231962302748421,0.06835680002247894,0.239101778528457,0.09231476852394725,0.07278250532284332,0.1383066949730552,-0.163868373994617,-0.09605768249515508,0.1089598231344294,-0.04386459836051232,0.06368206141914635,0.06614291054477428,-0.1638583317116601,0.1081872670685859,-0.2228211694358843,0.05217897152069795,0.06740047440082701,-0.1268456440169886,0.201654489250103,0.08908118122433453,0.09242673839245749,0.1218943891569391,-0.08417231348519881,0.08866626467047162,0.04102235350751094,0.1173743544343772,0.07544035396898757,0.06764562884419094,-0.1329166473351556,0.08466727381708646,0.05095736612403616,0.1600501322484576,0.1203509875985795,0.06887248374055137,0.04083676120542599,0.06926659999394739,0.04969120992067235,-0.05728677430793325,0.2675296983109366,0.06326735435259857,0.09882667405410578,-0.07167141436825399,0.05529101810545854,-0.0540083611952237,-0.06717780280087676,0.05964324495148499,0.06548836179829315,0.04952409687797633,0.04251166346891094,0.1565008628276663,0.05398255420129239,-0.124006524617687,-0.1221563092656626,0.04002762006962609,0.1289280139478512,0.05511951915075902,0.04410025203143405,-0.09511642642531148,-0.05305592702854776,0.04963973250072419,-0.04344965838361698,0.05179354901223202,-0.0636527413490425,-0.06403346597433306,-0.05186610977163927,-0.03605107859971941,0.04686448942910844,-0.1433083557986625,0.0503725827571467,-0.03163612139257563,-0.06108918103918796,-0.04838055317196344,0.05178748386201899,0.03277962892827337,0.03761972968180687,0.1238799357080468,0.02786788244956926,0.03392772808897554,0.04622179026973147,0.04467211279811032,0.05093404543987923,0.03751402534624352,0.05977429172985631,0.08006219257652179,0.03302031613873639,-0.02588419161909808,0.09240823637353454,0.0354230636956353,-0.01251667027941855,0.03863806642117843,-0.03535305983109263,0.02366267169065592,-0.04075153671986891,0.02494396936307729,-0.06719583403933033,-0.02691318408190224,-0.02673304441581857,0.03972598895381791,0.04936863265311226,0.1014367572007782,-0.02593315434928361,-0.02540881170847065,-0.02553015361231586,0.0169175451747052,-0.02315930550884062,-0.03329694487747632,0.011577376423488,0.009381669069421002,0.02418235194317854,-0.0200197410135064,0.0259894027991663,-0.009377476024069379,-0.02367728905517069,0.01671496250764277,-0.01629615539163025,-0.01569015297738431,-0.01964702411119663,-0.0129382093458606,0.007199411755434077,0.01060544335608019,0.01246812728881315,-0.0149034885481886,-0.02221804432439081,0.01323883428352591,0.01403638122723559,0.01259067674587019,-0.01067567804867535,-0.009499665954761392,-0.02934982075053132,-0.004655150774308912,-0.01695720503376364,0.008530164990706966,-0.003007544322027126,0.007345368999063638,0.002371118741552133,0.002752349110520746,-0.004786821753800637,0.001289569604860186,-0.001149018118406728,0.0008069056834506879],[8.253907865882999e-07,4.356055074431498e-06,2.395394249303221e-05,0.0008405693219355069,0.003849063283017301,0.01940777788048553,0.0326598162028711,0.04103069114624449,0.04107731251020114,0.04397006893883364,0.04679354573686929,0.05596371487617147,0.075242877871967,0.07525226274630711,0.07538467718866361,0.07642015023026966,0.07980949537565796,0.08897219560378621,0.08967419146873315,0.09231775022001415,0.09300223456308722,0.09307702408398803,0.09827199890950977,0.09975623906154364,0.1003309462771187,0.1009244118974138,0.1017846801692339,0.1067698917061961,0.1074601082236949,0.1105606138761503,0.1167167877561992,0.1233392335573399,0.124621735984204,0.1271634198090999,0.1318865229210586,0.1324597570307968,0.1333922567348344,0.1344541672694249,0.1368721419225838,0.1369157979626655,0.1411179192647149,0.1457433017951265,0.1461052596345198,0.1465652113989398,0.1487398274002805,0.1492562189933584,0.1547261364838134,0.1550547141050011,0.1590358072930989,0.1624466059853099,0.1653656920463664,0.1671728193407855,0.168227303091967,0.1689658647831241,0.1805817765318972,0.1809054014647609,0.1824535313348958,0.1843188478244256,0.1907528920103198,0.1922117852428037,0.1938652157380856,0.1948141802330094,0.1954854521343173,0.1965080062416971,0.1982101540804746,0.1990560042749212,0.1993233775489432,0.202341613925523,0.2110435235388718,0.2174566447369809,0.2186821259135988,0.2195553158337383,0.220502283248202,0.222139164214146,0.2225420973700383,0.2232446062089606,0.2244169769787878,0.2327774506990082,0.2356963665904668,0.2384811972924115,0.2422524480479346,0.250938413887314,0.2519959439089235,0.2543084485523937,0.2545163827581403,0.2634249129155245,0.2658862314023338,0.266076963295345,0.26671032183841,0.2680363657540854,0.2682014382691137,0.2686661961105934,0.2697774585583923,0.270017109685061,0.2753842761703305,0.279024304004625,0.2803816087149213,0.2807364197953215,0.2826177646767407,0.2832435481598863,0.2836703766738087,0.2843785993465262,0.2847674187475301,0.2890205802631129,0.2897012544134029,0.2922927523622777,0.293998390715266,0.2969931251116102,0.2976519088305853,0.2980555911567648,0.2994255412310627,0.3001540270510539,0.3025944503824214,0.3030489011351628,0.3042591225188526,0.3053107086905596,0.3060793183916632,0.3086165948128725,0.3126620594205187,0.3183501194453107,0.3216591025520797,0.3217153873957991,0.3245874473633672,0.3258509640239542,0.3263069116935605,0.3264886009507298,0.3301734119560312,0.3310718071380773,0.3349374243641121,0.3357237276813601,0.3363193930671623,0.3390990020142181,0.3396910639184018,0.3420357627994181,0.3424533511789892,0.3433511106270437,0.3461779469770102,0.3479869189984884,0.3482890543254262,0.3488407925517154,0.3510670781783521,0.3555560575837872,0.362496292652207,0.368737733044415,0.3695803693722774,0.3723276418273625,0.3734078345278914,0.374133030708202,0.3741659493799555,0.3750220486178661,0.3767469286552986,0.3799250385348377,0.3805399645228412,0.3829940284479599,0.3862940036041933,0.3864317879929425,0.386556360049681,0.386696114562669,0.3874419354380714,0.388246173700407,0.3883267129073854,0.3893580360916399,0.3902761277223328,0.3983148857101633,0.3984248385648325,0.399250670458366,0.3995111080061663,0.4013512199492934,0.4019815750437943,0.4044662769419042,0.4051414349795806,0.4052822981908253,0.4060640636733032,0.4112819917678002,0.4160169460906795,0.4161243185700079,0.4161679409725707,0.4164738962910441,0.4178445539927914,0.4196683564594127,0.4198279953076918,0.4205690760273892,0.4210991515994138,0.4227305552171706,0.422883506676368,0.4231669378581369,0.4236634558181532,0.4237364637876344,0.4249716079952796,0.4267917468583213,0.4280037965708219,0.4291271426576558,0.4293929499575073,0.4304130371606338,0.4304824930508689,0.4314732279533403,0.4334543881217155,0.4341014917626108,0.4342637547036665,0.435498919586149,0.4358182021784635,0.4360676389466543,0.4363489735254126,0.4415109921642733,0.4416577301527359,0.4425862159484288,0.4484724887624797,0.4522038979000675,0.4603099113953978,0.4607233277498751,0.4612218762343154,0.4616576993779254,0.4638261938380622,0.4650982559675215,0.4653629119811786,0.4653909626576818,0.4655143084484215,0.4667428470423064,0.4688820019672272,0.473169930649574,0.4732478092835192,0.4735017834296681,0.4735629312614515,0.4737894778710252,0.4753833989069817,0.4754913845909451,0.4797676438425507,0.4803244554607872,0.480373231721083,0.4813134028531985,0.4813952907132538,0.4830870693085684,0.4850549170541631,0.4856699546111666,0.4861893919217333,0.4868355450614434,0.4882565502535554,0.4908490006647881,0.4930822048492572,0.4938475051212629,0.4948618817922239,0.4949055794272872,0.4956507797742402,0.4957552575708673,0.5011061995439462,0.5036909092404422,0.5041818600751601,0.5063818363512373,0.5069262459541061,0.5070995193129902,0.5099550246054603,0.5103043583710168,0.510617412492629,0.5126120443847652,0.5134527547924698,0.5153770669246746,0.5156804424267729,0.5172095579928161,0.5173440229876576,0.5193953488266553,0.5212485203095414,0.5217204020683475,0.5220321412121569,0.5238707420995321,0.5261625669296027,0.5275011854548235,0.5314832366714193,0.5317143487976977,0.532128067984818,0.532345651040346,0.5360210135641027,0.5371161193708566,0.5383735375771125,0.5393743333300355,0.543065626317862,0.5446718539717357,0.54761314248382,0.5490554664594677,0.5516836735207782,0.552017297332059,0.5530368069113518,0.5575114619018773,0.5589109561479304,0.5622275191571595,0.5653223005330106,0.5686371357394259,0.5748734922310379,0.5822854548406716,0.5867354879805926,0.5874029255666822,0.591265353744113,0.5945844713518009,0.59473801380158,0.5984802554582254,0.5991045551898772,0.5994275362606072,0.6010674463202824,0.6017724300165241,0.6018089271847777,0.6020331428224042,0.6022624608538354,0.6024923287667059,0.6051331378542252,0.6056319782510823,0.607236942609768,0.6077484214608286,0.6082657985745386,0.6089282342098723,0.609209771511417,0.6095733479359886,0.6122259801859511,0.6124432013085628,0.6130010701747708,0.6191899046455011,0.6195212924365986,0.620191532423606,0.6216103973955924,0.6231092370997833,0.6250646729367509,0.6256764525413305,0.6274265759263371,0.630147437151106,0.6314244689923278,0.6315165217588468,0.6320880993772836,0.6323495744087588,0.6353899192884694,0.6363866715482015,0.6366095467675672,0.6380170897040653,0.6381109281516071,0.6401726582304106,0.6412346420533295,0.6448073184968569,0.6494779364787506,0.6511153940917813,0.6512767450551664,0.65170911634831,0.6517964516248553,0.6528181782745978,0.6537924369817556,0.6550433378219251,0.6561007243978706,0.6568447818894479,0.6570339166747079,0.6570341735555041,0.6600651828961758,0.6633883339574629,0.6659491071690806,0.6664500528522209,0.6668373970538665,0.6689806492709882,0.669519192707189,0.6722953658527739,0.6735101014551922,0.6754981305494476,0.6782957518393475,0.6796822805783609,0.6797112597875095,0.6800555832943247,0.6801107330369296,0.6806926726388181,0.6824008189797874,0.6824917085920043,0.6827319101774162,0.684580217865715,0.6847586268312102,0.6857910707080574,0.6864282286470033,0.6882502884146625,0.69119255631583,0.6930476322562856,0.6935127906569589,0.6935855227145007,0.6963595528377342,0.6964876574483897,0.6970383823524197,0.6975593685423352,0.700968418224624,0.7026554677067305,0.7036257591366859,0.7038307686610792,0.7055948911842272,0.7073487821604523,0.7075065842746739,0.710089056225931,0.7121510008943268,0.7141371652697148,0.7145420155819369,0.7153410669507592,0.7160021944970129,0.7173059898619626,0.7188083955828791,0.719386262933341,0.7199320239200582,0.7265315209374166,0.7268709823730045,0.7272739374350811,0.7290872995913833,0.7302123387998192,0.7315686026886129,0.7328830421956996,0.7336757167643172,0.737225498352042,0.7384804779990234,0.7405289302365077,0.7441348291782071,0.7455540915156516,0.7485104844346122,0.7530884517423222,0.75474014202958,0.7551708609756087,0.7582514658540472,0.762530424502877,0.7651817614139227,0.765783294754907,0.7662487582167479,0.7662902738389885,0.7665448462596693,0.7683568641779406,0.7693946800695851,0.7694984247854697,0.7697447135069835,0.7706917859260781,0.7727669118109888,0.7730735479794156,0.7736643815373169,0.7737423838505955,0.7737876988121902,0.7741413960231778,0.7742689484712775,0.7784222210126386,0.7809589708736406,0.7836190765337256,0.7850355096239844,0.7853015369186344,0.7937544326301933,0.794014350066953,0.797741949615286,0.8010724303950993,0.8040948984275134,0.8045614993927517,0.8048623462491397,0.805596430558296,0.8080597700329017,0.8084335742145894,0.8090011051201825,0.8096621662743952,0.8104307243086032,0.8108581072603689,0.8122882324708051,0.815518731489106,0.8162041329559775,0.8183318645594312,0.8189464233529206,0.8197724956308987,0.8221697908801544,0.8238473662188505,0.8247110882490876,0.8268189079750923,0.8271213389967174,0.8277768732973928,0.8307285678462719,0.8314503020174119,0.8419207659607935,0.8419736579075086,0.8424318992159582,0.8432301714735367,0.8441187571249125,0.8442744102119922,0.8448375080142584,0.8457480724319377,0.8478463057921035,0.848975716602909,0.8494067035653894,0.8507680697178284,0.852424559594577,0.8570439618432705,0.8609100085352859,0.8616072765003222,0.8620531532357459,0.8637259252141698,0.864371530408812,0.8644911028561356,0.8649907414915124,0.865712035058574,0.8675658010328244,0.8693615667842323,0.8716750423181312,0.872106559359128,0.8725688593228056,0.8764805736010083,0.8785759968614935,0.8797683879422241,0.8822387410954706,0.885593068759949,0.885792341604842,0.88730511234607,0.8883426515012358,0.889869584828708,0.8899768628709125,0.8905001040863582,0.8907670839891528,0.8908378123534438,0.8943519530198935,0.894954288278067,0.8957642576126225,0.8964083178192064,0.8972586026168966,0.8973083054136686,0.8999791311329383,0.9006301425992134,0.9033371299937933,0.9034326730282806,0.9042549906201188,0.9048035512792262,0.90638577312387,0.9068970892985556,0.9070223796862823,0.9090704748368598,0.9099149025225896,0.9107499250231736,0.9178575628654616,0.9178765521577654,0.9181789547956851,0.9204228581576052,0.9205378882786726,0.9248882905101045,0.9268437135642885,0.9291788605577278,0.9295132474839907,0.9320899140503964,0.9339470502427062,0.9340447693691427,0.9357790449663665,0.9357880639172933,0.9378362937966813,0.9385106113806434,0.9419460264483479,0.9435824964044039,0.944723570942656,0.9462154637121627,0.950767895720494,0.951574965253846,0.9541844615738355,0.9557421237690407,0.9557689263261803,0.9562334006657176,0.9572046614103871,0.9587651164104521,0.9594995574823789,0.9601087142766813,0.9608582338276317,0.9633262110072029,0.966631700155518,0.9682749988613152,0.9683023338899421,0.969593493125578,0.9726004354808423,0.9726372743414865,0.9727940435841254,0.9727965434226473,0.9729153381950107,0.9733875216071542,0.9742688925726883,0.9766046416170575,0.9780709784334094,0.9784383089647872,0.9795280528040801,0.9812971755656376,0.9815797817998061,0.9827343088036202,0.9877478248745364,0.9894266278706182,0.9896688777849489,0.9903412213452722,0.9905317310158708,0.9960557140996535,0.9976727071399817,0.9989937653917627],[0.0004787266562212139,0.001263255971585134,0.004631095548652894,0.1218825516806485,0.446491340830007,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9956818093400434,0.9989937653917627,0.9989937653917627,0.9989937653917627]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Feature<\/th>\n      <th>Comparison<\/th>\n      <th>Estimate<\/th>\n      <th>P<\/th>\n      <th>FDR<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":4,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatSignif(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 3, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3,4]},{"name":"Feature","targets":0},{"name":"Comparison","targets":1},{"name":"Estimate","targets":2},{"name":"P","targets":3},{"name":"FDR","targets":4}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render"],"jsHooks":[]}</script>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Overall, we see a handful of proteins are differentially expressed between these two groups. In the heatmap we see that these proteins are clustering primarily by responder.</p>
</div>
</div>
</section></details>
</section>

<section id="sec-conclusion" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Conclusions</h1>
<p>Together, these steps provide a reproducible framework for processing, exploring, and interpreting GeoMx protein expression data. By establishing data quality, normalization, and early biological patterns up front, the workflow sets a strong foundation for downstream differential expression and biological insight.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-Merritt2020" class="csl-entry">
Merritt, Christopher R., Giang T. Ong, Sarah E. Church, Kristi Barker, Patrick Danaher, Gary Geiss, Margaret Hoang, et al. 2020. <span>“Multiplex Digital Spatial Profiling of Proteins and RNA in Fixed Tissue.”</span> <em>Nature Biotechnology</em> 38 (5): 586–99. <a href="https://doi.org/10.1038/s41587-020-0472-9">https://doi.org/10.1038/s41587-020-0472-9</a>.
</div>
</div></section></div> ]]></description>
  <category>GeoMx</category>
  <category>how-tos</category>
  <category>overview</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/</guid>
  <pubDate>Fri, 13 Feb 2026 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/geomx_vignette/Assets/qc/cv_heatmap.svg" medium="image" type="image/svg+xml"/>
</item>
<item>
  <title>New how-to guide to analyze WTX data</title>
  <dc:creator>Evelyn Metzger</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/wtx-guide-launcher-post/launcher.html</link>
  <description><![CDATA[ 





<p>
This is an end-to-end workflow that walks through analyzing CosMx® whole transcriptome single-slide dataset – from loading flat files to quality processing to performing pathway analysis – using open-source tools in a blend of R and Python. Here you will find best practices, interactive visualizations to show what effects certain processing parameters have on the data, and applications of cutting-edge tools that have been described in our blog, like HieraType.
</p>
<p>
<a href="../../guides/the-wtx-guide/index.html">Please click here navigate to the new Guides section</a>.
</p>



 ]]></description>
  <category>Gudies</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/wtx-guide-launcher-post/launcher.html</guid>
  <pubDate>Fri, 30 Jan 2026 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/guides/the-wtx-guide/assets/analysis_results/ct/annotated_domain__spatial__S0__plot.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Interactive Spatial Analysis with LLMs</title>
  <dc:creator>Evelyn Metzger</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-discovery-tips/</link>
  <description><![CDATA[ 





<script>
  function jumpTo(seconds) {
    var vid = document.getElementById("mainVideo");
    if (vid) {
      vid.currentTime = seconds;
      vid.play();
    }
  }
</script>

<div class="video-wrapper">
  <video id="mainVideo" controls="" playsinline="" style="width: 100%; border-radius: 8px;">
      <source src="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/releases/download/spatial_discovery/SDM-demo.mp4" type="video/mp4">
  </video>
</div>

<div class="no-row-height column-margin column-container"><section id="quick-jump" class="level3">
<h3 class="anchored" data-anchor-id="quick-jump">Quick Jump</h3>
<ul>
<li><a href="javascript:void(0);" onclick="jumpTo(0)">▶ Create Study (0:00)</a></li>
<li><a href="javascript:void(0);" onclick="jumpTo(38)">▶ View Results (0:38)</a></li>
<li><a href="javascript:void(0);" onclick="jumpTo(107)">▶ Download Results (1:47)</a></li>
<li><a href="javascript:void(0);" onclick="jumpTo(131)">▶ Converse with LLM (2:11)</a></li>
<li><a href="javascript:void(0);" onclick="jumpTo(227)">▶ Infer cell types (3:47)</a></li>
<li><a href="javascript:void(0);" onclick="jumpTo(272)">▶ Infer domain names (4:32)</a></li>
<li><a href="javascript:void(0);" onclick="jumpTo(425)">▶ Pathway insights (7:05)</a></li>
</ul>
</section></div><section id="spatial-discovery" class="level2">
<h2 class="anchored" data-anchor-id="spatial-discovery">Spatial Discovery</h2>
<p>AtoMx SIP 2.2 brings several new features and enhancements to users in the beta release of its brand new visual-first experience. This includes pre-processing and pre-calculations of many of “upstream” modules like quality, cluster, <em>etc</em>. In addition to visual enhancements, this new experience brings new analysis modules like Novae domains and Spatial Discovery.</p>
<p>In this “vlog” post, I quickly explain what the Spatial Discovery is and demonstrate and example of how I use it in combination with LLMs to accelerate my discoveries. Click the chapters to the right of the video to begin.</p>
</section>
<section id="study-insights" class="level2">
<h2 class="anchored" data-anchor-id="study-insights">Study Insights</h2>
<p>When downloading the <a href="javascript:void(0);" onclick="jumpTo(107)">Spatial Discovery Study Insights</a> you will get a zip file. Within that zip file is a series of text files containing pertinent results from the study. One of those files is the readme markdown file which explains what each file contains, the column names, the data types, and other useful information that an LLM can use for added context.</p>
</section>
<section id="example-prompts" class="level2">
<h2 class="anchored" data-anchor-id="example-prompts">Example Prompts</h2>
<p>One of the most exciting things about this interactive approach is that you can really ask any number of questions to the prompt. I typically start by confirming if it can understand the files I uploaded and some questions defining my spatial domains and cell types before asking about biological processes but it’s entirely open-ended. Here’s some example prompts that you can try.</p>
<ul>
<li>Can you read and understand the contents of these files related to my colon cancer dataset? If so, I would like to have a conversation about the data with you.</li>
<li>Tell me the most likely cell types from my Leiden clusters. From the data, can you provide me a table with the Leiden cluster, the most likely cell type, 1-3 marker genes that helped you determine this cell type, and a brief biological justification?</li>
<li>From the Leiden cluster and domain information, can you provide a contingency table showing the counts? For example, in domain1 there are X number of Leiden 1 cells.</li>
<li>Given the composition of cell types (Leiden) and domains, can you assign a biological name to each domain for me?</li>
<li>What are the top 5 biologically relevant pathways in each domain?</li>
<li>For &lt;insert pathway&gt;, show me the relationship between mean intensity and spatial autocorrelation for each cell type (Leiden cluster). Make this an interactive xy scatter plot for me.</li>
<li>Tell me something interesting about this dataset.</li>
<li>Give me three interesting pathway paterns that you found that I should check out spatially in AtoMx SIP.</li>
</ul>
</section>
<section id="tips-when-working-with-llms" class="level2">
<h2 class="anchored" data-anchor-id="tips-when-working-with-llms">Tips when working with LLMs</h2>
<ul>
<li>We have tested this on several models (chatGPT, copilot, Gemini) and premium tiers tend to perform best as they can hold more content than the free tiers. Free tiers also have a shorter conversaton limit and more restricting data upload size limits.</li>
<li>If working with many samples and/or conditions, using “temporary” chats can reduce the LLMs from “pulling in” results that are not related to the current study.</li>
<li>Taking screenshots of the sample from AtoMx SIP and pasting them in the chat can help provide the LLM more context. LLMs thrive on plain text and verification is recommended.</li>
</ul>
<p>If you discover other tips when working an analyzing your CosMx SMI results in this format, I would love to hear from you.</p>


</section>

 ]]></description>
  <category>AtoMx SIP</category>
  <category>LLMs</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-discovery-tips/</guid>
  <pubDate>Wed, 28 Jan 2026 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-discovery-tips/figures/sdm.png" medium="image" type="image/png" height="102" width="144"/>
</item>
<item>
  <title>Basic analysis vignette: differential expression</title>
  <dc:creator>Patrick Danaher</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/03_DE.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Here we provide workflows for differential expression testing. Also see the companion posts on <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/01_preprocessing.html">pre-processing</a> and <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/02_exploratory_analysis.html">exploratory analysis</a>. A complete analysis will typically begin with the pre-processing workflow, use exploratory analyses to generate hypotheses, then conclude by using differential expression analysis to test those hypotheses.</p>
<p>Whether you crafted your study with specific hypotheses in mind or discovered interesting trends while exploring your data, most CosMx<sup>®</sup> analyses will culminate in differential expression (DE) analyses. DE is a remarkably versatile tool for posing biological questions about how cells’ behavior changes in response to exposures like spatial context or patient-level attributes. Here we provide a convenient framework for posing your biological questions as DE tests.</p>
<p>Code is organized into the following sections, with the following inputs and outputs:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 34%">
<col style="width: 39%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Step</strong></th>
<th><strong>Inputs</strong></th>
<th><strong>Outputs</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Defining predictor variables</td>
<td>xy, cell type, custom inputs</td>
<td>Predictor variables</td>
</tr>
<tr class="even">
<td>Find safe genes via overlap ratio metric</td>
<td>Raw counts, xy, cell type</td>
<td>Genes to analyze per cell type</td>
</tr>
<tr class="odd">
<td>pre-DE calculations</td>
<td>xy</td>
<td>preDE (object for modeling segmentation errors)</td>
</tr>
<tr class="even">
<td>“Standard” DE with smiDE</td>
<td>Predictor variables, Raw counts, preDE, cell type, list of genes to analyze per cell type</td>
<td>DE outputs: p-values, effect sizes, etc.</td>
</tr>
<tr class="odd">
<td>“Optimal / slow” DE with smiDE</td>
<td>Predictor variables, Raw counts, preDE, cell type, genes to analyze per cell type</td>
<td>DE outputs: p-values, effect sizes, etc.</td>
</tr>
<tr class="even">
<td>“Hasty / exploratory” DE with hastyDE</td>
<td>Predictor variables, Normalized counts, cell type, genes to analyze per cell type</td>
<td>DE outputs: p-values, effect sizes, etc.</td>
</tr>
<tr class="odd">
<td>“Stepwise” DE with hastyDE &amp; smiDE</td>
<td>Predictor variables, Normalized counts, Raw counts, cell type, genes to analyze per cell type</td>
<td>DE outputs: p-values, effect sizes, etc.</td>
</tr>
<tr class="even">
<td>Analysis of DE results</td>
<td>DE results</td>
<td>plots and tables</td>
</tr>
</tbody>
</table>
<p>This document exists to facilitate the coding of DE analyses, not as a literature review or an unveiling of new methods. For an extensive discussion of DE in spatial data, see <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/" target="_blank">this ealier post</a>. We’ll be relying on the <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/smiDE" target="_blank">smiDE package</a>, described in <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/" target="_blank">this post</a> and <a href="https://www.biorxiv.org/content/10.1101/2024.08.02.606405v2.abstract" target="_blank">this preprint</a>.</p>
<section id="getting-started" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="getting-started"><span class="header-section-number">1.1</span> Getting started</h2>
<p>To begin, load your fully pre-processed data (including cell type annotations). We assume the format generated by the <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/01_preprocessing.html">preprocessing vignette</a>:</p>
<ul>
<li>a sparse counts matrix with cells in rows and genes in columns</li>
<li>a data table of per-cell metadata, row-aligned with the counts matrix</li>
<li>a matrix of cells’ xy positions, row-aligned with the counts matrix</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## load necessary libraries</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for more memory efficient data frames</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(Matrix) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for sparse matrices like our counts matrix</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(smiDE) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remotes::install_github("Nanostring-Biostats/CosMx-Analysis-Scratch-Space", subdir = "_code/smiDE", ref = "Main")</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pheatmap)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(InSituCor) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># devtools::install_github("https://github.com/Nanostring-Biostats/InSituCor")</span></span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## load data:</span></span>
<span id="cb1-10">counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/counts.RDS"</span>))</span>
<span id="cb1-11">metadata <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/metadata.RDS"</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected to have the column "celltype"</span></span>
<span id="cb1-12">xy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/xy.RDS"</span>))</span></code></pre></div>
</details>
</div>
<p>Then we’ll define each cell’s neighbors. This will prove useful for a variety of downstream calculations. Note that cells are not included in their own neighbors.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## define cell neighborhoods:</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the 50 nearest neighbors of each cell:</span></span>
<span id="cb2-3">neighbors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nearestNeighborGraph</span>(</span>
<span id="cb2-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], </span>
<span id="cb2-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of neighbors</span></span>
<span id="cb2-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>slide_ID_numeric)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># optional argument to ensure cells with similar xy positions in different slides aren't linked</span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># or alternatively, get neighbors within a radius of 0.1mm:</span></span>
<span id="cb2-9">neighbors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">radiusBasedGraph</span>(</span>
<span id="cb2-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], </span>
<span id="cb2-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># radius</span></span>
<span id="cb2-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>slide_ID_numeric) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># optional argument to ensure cells with similar xy positions in different slides aren't linked</span></span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># see how many neighbors you're defining for each cell:</span></span>
<span id="cb2-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (neighbors20 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)))</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="crafting-predictor-variables-for-de" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Crafting predictor variables for DE</h1>
<p>Repurpose the below code chunks to create precisely the predictor variable you want to use in DE.</p>
<section id="defining-categorical-variables" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="defining-categorical-variables"><span class="header-section-number">2.1</span> Defining categorical variables</h2>
<p>Below we provide code for 4 different approaches to defining categorical variables for analysis:</p>
<ol type="1">
<li>Partitioning the tissue into niches / spatial domains using the Novae algorithm. Spatial domains are a natural framework for comparing cells’ expression patterns across spatial contexts; we have found the Novae algorithm to perform well.</li>
<li>Selecting custom regions of interest. Use this code to hand-select regions for comparison, e.g.&nbsp;distinct lobes of a tumor, or a tertiary lymphoid structure, or a region suggested by review of H&amp;E, IF, or protein images.</li>
<li>Logical combinations of existing metadata columns, including dichotomization of continuous variables, e.g.&nbsp;gene expression (“B2M high”), pathway score (“INFG signaling high”) or one of the continuous variables calculated below (“distance to tumor glands”).</li>
<li>Defining anatomical features consisting of spatially contiguous cells.</li>
</ol>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true">Novae niches</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false">Custom ROIs</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false">Combining existing annotations</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" aria-controls="tabset-1-4" aria-selected="false">Anatomical features / groups of contiguous cells</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p>You can now get Novae niches in an AtoMx pipeline module. Alternatively, compute them with the below code. Note that Novae is a python package; here we show how to call it from R, leaving details of python setup to you.</p>
<p>First we’ll use R to prepare our data for Novae, writing it to a h5ad file:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create a seurat object:</span></span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to single cell experiment</span></span>
<span id="cb3-4">sce <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.SingleCellExperiment</span>(seu.obj)</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save as h5ad</span></span>
<span id="cb3-7">h5ad_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(objects_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/assay_data.h5ad"</span>)</span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#writeH5AD(se_hdf5, file = h5ad_path)</span></span>
<span id="cb3-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">writeH5AD</span>(sce, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> h5ad_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X_name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"counts"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"counts"</span>)</span></code></pre></div>
</details>
</div>
<p>Now we run python code to call Novae. Note that this can easily take a day to compute on a CPU; a GPU might take 30 minutes.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(reticulate)</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">py_run_string</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb4-4"></span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import novae</span></span>
<span id="cb4-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import igraph</span></span>
<span id="cb4-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import matplotlib</span></span>
<span id="cb4-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">matplotlib.use('Agg')</span></span>
<span id="cb4-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import matplotlib.pyplot as plt</span></span>
<span id="cb4-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import scanpy as sc</span></span>
<span id="cb4-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import numpy as np</span></span>
<span id="cb4-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import os</span></span>
<span id="cb4-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import hdf5plugin</span></span>
<span id="cb4-15"></span>
<span id="cb4-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">sc.settings.figdir = os.path.join(r.niche_dir, "</span>Plots<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">")</span></span>
<span id="cb4-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#torch.set_float32_matmul_precision('high') </span></span>
<span id="cb4-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">novae.settings.auto_preprocessing = True</span></span>
<span id="cb4-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#os.environ["</span>CUDA_VISIBLE_DEVICES<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"] = "</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb4-20"></span>
<span id="cb4-21"></span>
<span id="cb4-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Read in sample</span></span>
<span id="cb4-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">adata = sc.read_h5ad("</span>analysis<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Robjects<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>assay_data.h5ad<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">")</span></span>
<span id="cb4-24"></span>
<span id="cb4-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">## convert spatial from mm to microns for novae</span></span>
<span id="cb4-26"></span>
<span id="cb4-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Extract coordinates from obs</span></span>
<span id="cb4-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">x_mm = adata.obs["</span>x_slide_mm<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"].to_numpy()</span></span>
<span id="cb4-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">y_mm = adata.obs["</span>y_slide_mm<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"].to_numpy()</span></span>
<span id="cb4-30"></span>
<span id="cb4-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Create spatial_mm matrix</span></span>
<span id="cb4-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">spatial_mm = np.column_stack((x_mm, y_mm))</span></span>
<span id="cb4-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">adata.obsm["</span>spatial_mm<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"] = spatial_mm</span></span>
<span id="cb4-34"></span>
<span id="cb4-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Convert to microns</span></span>
<span id="cb4-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">spatial_um = spatial_mm * 1000</span></span>
<span id="cb4-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">adata.obsm["</span>spatial_um<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"] = spatial_um</span></span>
<span id="cb4-38"></span>
<span id="cb4-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Duplicate spatial_um to spatial</span></span>
<span id="cb4-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">adata.obsm["</span>spatial<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"] = spatial_um</span></span>
<span id="cb4-41"></span>
<span id="cb4-42"></span>
<span id="cb4-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">## Start running novae</span></span>
<span id="cb4-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Create a Delaunay graph of the data</span></span>
<span id="cb4-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">novae.spatial_neighbors(adata, radius=80, coord_type='generic')</span></span>
<span id="cb4-46"></span>
<span id="cb4-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Use a quick plot to ensure that neighbors were calculated appropriately</span></span>
<span id="cb4-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Looking for very few red (unconnected) cells that are only on the edges of tissue</span></span>
<span id="cb4-49"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">novae.plot.connectivities(adata)</span></span>
<span id="cb4-50"></span>
<span id="cb4-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Load in pre-trained model</span></span>
<span id="cb4-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model1 = novae.Novae.from_pretrained("</span>MICS<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Lab<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>novae<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>human<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-0</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">")</span></span>
<span id="cb4-53"></span>
<span id="cb4-54"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Fine tune model based on CosMx data in this study</span></span>
<span id="cb4-55"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#model1.fine_tune(adata, max_epochs=50, logger=True, accelerator='cuda', num_workers=4)</span></span>
<span id="cb4-56"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model1.fine_tune(adata, max_epochs=50, logger=True) # Took ~24 hours on an r5b.12xlarge with CPU only</span></span>
<span id="cb4-57"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model1.compute_representations(adata, zero_shot=False) # Took ~8 hrs</span></span>
<span id="cb4-58"></span>
<span id="cb4-59"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">for i in range(1, 20):</span></span>
<span id="cb4-60"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  model1.assign_domains(adata, i)</span></span>
<span id="cb4-61"></span>
<span id="cb4-62"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model1_dir = os.path.join(r.niche_dir, "</span>novae_model_one<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">")</span></span>
<span id="cb4-63"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model1.save_pretrained(save_directory=model1_dir)</span></span>
<span id="cb4-64"></span>
<span id="cb4-65"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import matplotlib.pyplot as plt</span></span>
<span id="cb4-66"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">dh = model1.plot_domains_hierarchy()</span></span>
<span id="cb4-67"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">plt.savefig(os.path.join(r.niche_dir, "</span>Plots<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>novae_model1_hierarchy.png<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"))</span></span>
<span id="cb4-68"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">plt.close()</span></span>
<span id="cb4-69"></span>
<span id="cb4-70"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">novae.plot.paga(adata, obs_key="</span>novae_domains_11<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", save="</span>_novae_model1_graph.png<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">")</span></span>
<span id="cb4-71"></span>
<span id="cb4-72"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">adata.write_h5ad(</span></span>
<span id="cb4-73"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  os.path.join(r.objects_dir, "</span>anndata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>plus<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>novae.h5ad<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"),</span></span>
<span id="cb4-74"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  compression=hdf5plugin.FILTERS["</span>zstd<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"],</span></span>
<span id="cb4-75"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  compression_opts=hdf5plugin.Zstd(clevel=5).filter_options</span></span>
<span id="cb4-76"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-77"></span>
<span id="cb4-78"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p>Here we provide a function, <code>defineROI</code>, to support two workflows for selecting ROIs:</p>
<ol type="1">
<li>Clicking on points in the graphics window to define an ROI boundary (relies on the <code>identify</code> function, which can be buggy.)</li>
<li>Hard-coding the xy coordinates of the ROI boundary.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' Define roi's by Clicking on cells in a graphics window</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' </span></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' How to use:</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \itemize{</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Plot your cells in xy space. Use asp = 1. </span></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Click cells around the boundary of your roi.</span></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Hit enter or escape when done with your selection.</span></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' }</span></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' Other details:</span></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \itemize{</span></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Uses graphics::identify() to select points. </span></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Only works for base graphics, not ggplots.</span></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Can go wrong (draw rois in the wrong place) if the plot doesn't have asp = 1. </span></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' }</span></span>
<span id="cb5-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param xy Matrix of xy positions used in the plot. </span></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param show Logical, for whether to show the selected roi when you're done. </span></span>
<span id="cb5-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param type One of:</span></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \itemize{</span></span>
<span id="cb5-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item "direct" to define the boundary points in order, exactly as you click</span></span>
<span id="cb5-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item "ahull" to draw an alpha hull around your selection</span></span>
<span id="cb5-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' } </span></span>
<span id="cb5-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @return A list with 3 elements:</span></span>
<span id="cb5-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \itemize{</span></span>
<span id="cb5-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item roi: The indices of the points in the roi</span></span>
<span id="cb5-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item selected: The indices of the user-selected points</span></span>
<span id="cb5-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item hull: The hull of the roi, either the user-selected polygon or the results of alphahull:ahull}</span></span>
<span id="cb5-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @importFrom graphics identify</span></span>
<span id="cb5-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @importFrom alphahull ahull</span></span>
<span id="cb5-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @</span></span>
<span id="cb5-30">defineROI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"direct"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">boundary_points =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb5-31">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(boundary_points)) {</span>
<span id="cb5-32">    hull.x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> boundary_points[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb5-33">    hull.y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> boundary_points[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb5-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get points in the boundary:</span></span>
<span id="cb5-35">    roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">point.in.polygon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">point.x =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">point.y =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], </span>
<span id="cb5-36">                                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pol.x =</span> hull.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pol.y =</span> hull.y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb5-37">    inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb5-38">    hull <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb5-39">  }</span>
<span id="cb5-40">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(boundary_points)) {</span>
<span id="cb5-41">    </span>
<span id="cb5-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.element</span>(type, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"direct"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ahull"</span>))) {</span>
<span id="cb5-43">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"must either give boundary_points or set type to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">direct</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> or </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ahull</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-44">    }</span>
<span id="cb5-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># user identifies boundary:</span></span>
<span id="cb5-46">    identifyres <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">identify</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">order =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb5-47">    inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> identifyres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ind[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(identifyres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>order)]</span>
<span id="cb5-48">    </span>
<span id="cb5-49">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"direct"</span>) {</span>
<span id="cb5-50">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The hull is just the polygon you've selected:</span></span>
<span id="cb5-51">      hull.x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xy[inds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb5-52">      hull.y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xy[inds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb5-53">      hull <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> inds</span>
<span id="cb5-54">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get points in the boundary:</span></span>
<span id="cb5-55">      roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">point.in.polygon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">point.x =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">point.y =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], </span>
<span id="cb5-56">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pol.x =</span> hull.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pol.y =</span> hull.y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb5-57">    }</span>
<span id="cb5-58">    </span>
<span id="cb5-59">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ahull"</span>) {</span>
<span id="cb5-60">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get alpha hull of boundary:</span></span>
<span id="cb5-61">      hull <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> alphahull<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ahull</span>(xy[inds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], xy[inds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb5-62">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get points in the boundary:</span></span>
<span id="cb5-63">      roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> alphahull<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inahull</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ahull.obj =</span> hull, xy)</span>
<span id="cb5-64">    }</span>
<span id="cb5-65">    </span>
<span id="cb5-66">  }</span>
<span id="cb5-67">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot:</span></span>
<span id="cb5-68">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (show) {</span>
<span id="cb5-69">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[inds, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb5-70">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">polygon</span>(xy[hull, ])</span>
<span id="cb5-71">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[roi, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gold"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>))</span>
<span id="cb5-72">  }</span>
<span id="cb5-73">  </span>
<span id="cb5-74">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">roi =</span> roi, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">selected =</span> inds, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hull =</span> hull)</span>
<span id="cb5-75">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(out)</span>
<span id="cb5-76">}</span></code></pre></div>
</details>
</div>
<p>An example of the click-to-select workflow:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### example usage 1: clicking the graphics window to identify a region </span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">NOTE</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: uses the identify() function, which can be finnicky and hard to debug.</span></span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb6-5">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb6-6">roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">defineROI</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"direct"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add to metadata: </span></span>
<span id="cb6-8">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>inmyroi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> roi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>roi</span></code></pre></div>
</details>
</div>
<p>… and of the hard-coded boundary workflow:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### example usage 2: inputing xy coordinates of the ROI's boundary:</span></span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb7-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb7-4">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># place a grid over it to determine where to pick boundary points:</span></span>
<span id="cb7-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">h =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pretty</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(xy[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pretty</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(xy[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey20"</span>)</span>
<span id="cb7-7"></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hard-code boundary points:</span></span>
<span id="cb7-9">boundary_points <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb7-10">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.85</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.05</span>,</span>
<span id="cb7-11">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.1</span>,</span>
<span id="cb7-12">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.05</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.95</span>,</span>
<span id="cb7-13">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.95</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.85</span>,</span>
<span id="cb7-14">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.87</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.9</span></span>
<span id="cb7-15">), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb7-16">roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">defineROI</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">boundary_points =</span> boundary_points, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span>
<span id="cb7-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add to metadata: </span></span>
<span id="cb7-18">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>inmyroi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> roi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>roi</span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<p>No example code is needed here, but here are some examples for inspiration:</p>
<ul>
<li><strong>Condense niches</strong>: in one study, we obtained 9 niches, then condensed them into 3 broad categories (tumor, interior stroma, exterior stroma) for some analyses.<br>
</li>
<li><strong>Dichotomize a continuous variable</strong>: for example, you could pretty accurately identify cells in glomeruli as all cells with &gt;5 native glomerular cells (podocytes/mesangial cells/glomerular endothelial cells…) in their 20 nearest neighbors. And in some tumors, you could pretty accurately define tertiary lymphoid structures as all cells with &gt;10 B/T cells in their 20 nearest neighbors. Or you could divide a tumor into glycolysis high/low zones by dichotomizing a score of cells’ mean neighborhood glycolysis pathway scores.</li>
<li><strong>Combine metadata columns</strong>: for example, combine a handful of custom ROI’s into a single annotation column like “inflamed regions” or “dysplastic regions”.</li>
</ul>
</div>
<div id="tabset-1-4" class="tab-pane" aria-labelledby="tabset-1-4-tab">
<p>Often, instead of just selecting cells belonging to a given cell type, you want cells in anatomical structures. For example, you might want to select tumor glands while omitting single isolated tumor cells, or you might want to define blood vessels as groups of contiguous endothelial cells, omitting isolated endothelial cells. The below code uses the DBSCAN algorithm to achieve this:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define the starting group of cells, e.g. cells of a given cell type:</span></span>
<span id="cb8-2">tempcells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Endothelial"</span></span>
<span id="cb8-3">dbscancluster <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dbscan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbscan</span>(xy[tempcells, ],</span>
<span id="cb8-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># very small radius</span></span>
<span id="cb8-5">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minPts =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># throw out clusters of less than 5 cells</span></span>
<span id="cb8-6">                     )<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cluster</span>
<span id="cb8-7">selectedcells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dbscancluster <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb8-8">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>selected <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb8-9">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>selected[tempcells][selectedcells] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span></code></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="defining-continuous-variables" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="defining-continuous-variables"><span class="header-section-number">2.2</span> Defining continuous variables</h2>
<p>Here we provide code for a few ways to define useful continuous variables:</p>
<ul>
<li>Distance to nearest cell in a set (e.g.&nbsp;nearest T-cell)</li>
<li>Abundance of a cell set in a cell’s nearest neighbors (e.g.&nbsp;number of T-cell neighbors)</li>
<li>Mean value of a continuous variable in a cell’s neighborhood (e.g.&nbsp;neighborhood CD274 expression, or neighborhood interferon gamma pathway score)</li>
</ul>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true">Distance to nearest neighbor</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false">Number of neighbors</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" aria-controls="tabset-2-3" aria-selected="false">Mean neighborhood expression</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<p>The below code shows how to find the distance to the nearest neighbor of a given set of cells, e.g.&nbsp;tumor cells, or cells in a given niche, or cells in a region of interest (ROI). This approach is appropriate when you expect your selected cells to impact their surroundings in a way that declines over distance, e.g.&nbsp;with oxygen availability dropping with distance to the nearest blood vessel.</p>
<p>By modifying the <code>k</code> variable below you can take the distance to the <em>k</em>-th closest cell in the set. This can be useful when you’re trying to get distance to anatomical features like tumor glands rather than just single isolated tumor cells.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># collection of cells we want to take a distance to:</span></span>
<span id="cb9-2">istargetcell <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tcell"</span></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># record all cells' distances to k-th nearest target cell</span></span>
<span id="cb9-4">k <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb9-5">dist2target <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> FNN<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get.knnx</span>(</span>
<span id="cb9-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(xy[istargetcell, , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]),</span>
<span id="cb9-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">query =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(xy),</span>
<span id="cb9-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> k</span>
<span id="cb9-9">)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.dist[, k]</span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<p>The below code shows how to record how many of each cells’ nearest neighbors belong to a given set of cells, e.g.&nbsp;T-cells or This approach is appropriate when you expect the impact of your selected cells on their neighbors to compound. E.g., a neighborhood with more T cells might have a stronger inflammatory milieu than a neighborhood with just 1 T cell.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># collection of cells we want to take a distance to:</span></span>
<span id="cb10-2">istargetcell <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tcell"</span></span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># count the target cells among cells' neighbors:</span></span>
<span id="cb10-5">neighboring.targetcells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">neighbor_sum</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (istargetcell),</span>
<span id="cb10-6">                                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbors =</span> neighbors)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculated in the preliminaries</span></span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" aria-labelledby="tabset-2-3-tab">
<p>The below code shows how to measure the mean / total expression of a gene in each cells’ neighborhood.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## examples of a variable to average over neighborhoods:</span></span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># raw counts of a gene:</span></span>
<span id="cb11-3">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> counts[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CXCL14"</span>] </span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normalized expression of a gene:</span></span>
<span id="cb11-5">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> counts[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CXCL14"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA</span>
<span id="cb11-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># or you could use a pathway score, or protein expression (if measured)</span></span>
<span id="cb11-7"></span>
<span id="cb11-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## get average expression in each cell's neighborhood:</span></span>
<span id="cb11-9">neighbormean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">neighbor_sum</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbors =</span> neighbors)</span></code></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="transformations-on-continuous-variables" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="transformations-on-continuous-variables"><span class="header-section-number">2.3</span> Transformations on continuous variables:</h2>
<p>Once we’ve derived a continuous variable, we still have decisions to make. When we put a variable in a model, we are implicitly assume a linear relationship between the variable and our gene expression (“gene expression” occurring either on the linear or log scale, depending on the model). It often makes scientific sense to transform a variable before entering it into a model. See the code below for examples of useful transformations.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" aria-controls="tabset-3-1" aria-selected="true">Monotonic tranformations</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" aria-controls="tabset-3-2" aria-selected="false">Binning</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" aria-controls="tabset-3-3" aria-selected="false">Splines</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" aria-labelledby="tabset-3-1-tab">
<p>If you think distance to a feature matters because of some diffused signals, then concentration of those molecules will vary with 1/distance. If neighborhood expression of a molecule is strongly right-tailed, which is common, then a log transformation could prevent the end of the tail from having undue influence. To make effect sizes more interpretable, scale the variable from 0-1. For variables with strong skew or long tails, a quantile transformation can prevent extreme values from exerting excess influence on DE results.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># inverse:</span></span>
<span id="cb12-2">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(x[x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]))</span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># log2-transform:</span></span>
<span id="cb12-4">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>)</span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># scale from 0-1:</span></span>
<span id="cb12-6">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(x)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(x))</span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># scale to have unit SD:</span></span>
<span id="cb12-8">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(x)</span>
<span id="cb12-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># quantile transformation:</span></span>
<span id="cb12-10">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(x)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(x)</span>
<span id="cb12-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># truncate at the upper extreme:</span></span>
<span id="cb12-12">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.995</span>))</span>
<span id="cb12-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># truncate at the lower extreme:</span></span>
<span id="cb12-14">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>))</span>
<span id="cb12-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># truncate at both extremes:</span></span>
<span id="cb12-16">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>)), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.995</span>))</span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" aria-labelledby="tabset-3-2-tab">
<p>If you’re unwilling to commit to the shape of a relationship between a variable and gene expression, you can take a non-parametric approach and break it into bins. Our favored DE library, smiDE, will then give you results for all pairwise comparisons between bins, and it can be useful to e.g.&nbsp;compare all bins to the first bin. Alteratively, using various base R packages for linear models, you can run both a full model and a “null” model omitting your binned variable, then use a likelihood ratio test (<code>lrtest</code>) to get a p-value for the variable as a whole rather than for individual levels.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># break a variable into bins of equal width:</span></span>
<span id="cb13-2">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># break a variable into bins of equal cell numbers:</span></span>
<span id="cb13-4">quants <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>))</span>
<span id="cb13-5">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(quants))</span></code></pre></div>
</details>
</div>
<p>After the above, <code>x</code> is now a factor with 20 levels.</p>
</div>
<div id="tabset-3-3" class="tab-pane" aria-labelledby="tabset-3-3-tab">
<p>Instead of forcing the data into discrete bins, we can use splines to get a smoother fit.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">splinex <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(splines<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ns</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>))</span></code></pre></div>
</details>
</div>
<p>This produces a matrix with 20 columns, suitable as use as predictors for DE. Prioritize genes by their global p-values from a likelihood ratio test vs.&nbsp;a model excluding this matrix. (This approach is not yet supported by smiDE.)</p>
</div>
</div>
</div>
</section>
<section id="confirm-your-variable" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="confirm-your-variable"><span class="header-section-number">2.4</span> Confirm your variable:</h2>
<p>Once you’ve crafted a variable, plot it in space to confirm it’s as you hoped:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plotting a categorical variable:</span></span>
<span id="cb15-2">cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb15-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E41A1C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#377EB8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#4DAF4A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#984EA3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF7F00"</span>,</span>
<span id="cb15-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A65628"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F781BF"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#999999"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#66C2A5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FC8D62"</span>,</span>
<span id="cb15-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#8DA0CB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E78AC3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A6D854"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFD92F"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E5C494"</span>,</span>
<span id="cb15-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B3B3B3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1B9E77"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#D95F02"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#7570B3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E7298A"</span>,</span>
<span id="cb15-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#66A61E"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E6AB02"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A6761D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#666666"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A6CEE3"</span>,</span>
<span id="cb15-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1F78B4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B2DF8A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#33A02C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FB9A99"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E31A1C"</span>,</span>
<span id="cb15-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FDBF6F"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF7F00"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#CAB2D6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#6A3D9A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFFF99"</span>,</span>
<span id="cb15-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B15928"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#8DD3C7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFFFB3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#BEBADA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FB8072"</span></span>
<span id="cb15-11">), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(x))]</span>
<span id="cb15-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb15-13">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> cols[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(x))])</span>
<span id="cb15-14"></span>
<span id="cb15-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plotting a continuous variable that goes up from 0:</span></span>
<span id="cb15-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb15-17">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#4B0082"</span>))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb15-18">       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(x))</span>
<span id="cb15-19">     ])</span>
<span id="cb15-20"></span>
<span id="cb15-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plotting a continuous variable centered at 0:</span></span>
<span id="cb15-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb15-23">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkred"</span>))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb15-24">       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">51</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(x)))</span>
<span id="cb15-25">     ])</span>
<span id="cb15-26"></span>
<span id="cb15-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plotting a continous variable with arbitrary center:</span></span>
<span id="cb15-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb15-29">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkred"</span>))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb15-30">       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(x)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(x)))</span>
<span id="cb15-31">     ])</span>
<span id="cb15-32"></span>
<span id="cb15-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draw a histogram of the continuous variable to confirm it's not excessively long-tailed:</span></span>
<span id="cb15-34"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>)</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="running-de" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Running DE</h1>
<p>In this section we’ll provide example code for running smiDE with the variables we created above.</p>
<section id="preliminaries-for-smide" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="preliminaries-for-smide"><span class="header-section-number">3.1</span> Preliminaries for smiDE</h2>
<p>To harden our DE results against bias from segmentation errors, we take two countermeasures before running DE.</p>
<p><strong>First, we identify genes at risk of bias from segmentation errors, and omit them from our analysis</strong>. The intuition is simple: if a gene is more highly expressed in the neighbors of a cell type than in the cell type itself, then it’s at risk of meaningful bias from segmentation errors. We formalize this intuition in the function <code>smiDE::overlap_ratio_metric</code>, demonstrated below:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># obtain the overlap ratio metrics:</span></span>
<span id="cb16-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb16-3">  overlapres <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> smiDE<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">overlap_ratio_metric</span>(</span>
<span id="cb16-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay_matrix =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(counts),</span>
<span id="cb16-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(xy, metadata),</span>
<span id="cb16-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_id"</span>,</span>
<span id="cb16-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype"</span>,</span>
<span id="cb16-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdimx_col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(xy)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb16-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdimy_col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(xy)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb16-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">radius =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb16-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(overlapres, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processed_data/overlapres.RDS"</span>)</span>
<span id="cb16-12">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb16-13">  overlapres <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processed_data/overlapres.RDS"</span>)</span>
<span id="cb16-14">}</span>
<span id="cb16-15"></span>
<span id="cb16-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># extract the genes to analyze for your cell type (in this example, "macrophage"):</span></span>
<span id="cb16-17">genes_to_analyze <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> overlapres[celltype<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage"</span>][ratio <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>][[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"target"</span>]]</span></code></pre></div>
</details>
</div>
<p><strong>Second, we record cells’ spatial neighbors</strong>, which smiDE uses to adjust for any lingering bias from segmentation errors:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># required preliminary for smiDE:</span></span>
<span id="cb17-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb17-3">  pre_de_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb17-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pre_de</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(xy, metadata),</span>
<span id="cb17-5">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cell_type_metadata_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype"</span>,</span>
<span id="cb17-6">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_id"</span>,</span>
<span id="cb17-7">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_neighbors_by_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tissue"</span>,</span>
<span id="cb17-8">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mm_radius =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb17-9">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdimx_colname =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(xy)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb17-10">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdimy_colname =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(xy)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb17-11">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb17-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(pre_de_obj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processed_data/pre_de_obj.RDS"</span>)</span>
<span id="cb17-13">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb17-14">  pre_de_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processed_data/pre_de_obj.RDS"</span>)</span>
<span id="cb17-15">}</span></code></pre></div>
</details>
</div>
</section>
<section id="running-smide" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="running-smide"><span class="header-section-number">3.2</span> running smiDE</h2>
<p>Now, at last, we’re ready to run DE. Here we’re faced with tradeoffs between model thoroughness and computation time. The best models to date are prohibitively slow in large studies, while the fastest models compute in moments but suffer more false positives.</p>
<p>What do we mean by the “best models?” DE in spatial data runs into two challenges:</p>
<p>First, errors in cell segmentation bias cells to resemble their neighbors. This can cause false positive results when comparing across different spatial contexts. We already screened out genes at unacceptable risk of segmentation errors, but ideally we’ll take the further step of directly adjusting for this bias in the genes that remain.</p>
<p>Second, we would ideally model the <em>spatial correlation</em> in our data. Expression among spatially neighboring cells is often correlated due to some spatially smooth factor unrelated to our predictor variable. This can lead to biased effect estimates, and potentially inflated statistical significance. We can model this correlation and get more accurate p-values by including a spatial random effect. This works best when the magnitude of variation in the spatial random effect is small, or when the correlation between the random effect and the covariate is small. In addition, it’s helpful for the DE predictor to be more spatially nuanced than the smooth random effect. Unfortunately, modeling spatial correlation becomes very computationally intensive over large numbers of cells.</p>
<p>Our recommended modeling approaches for different settings are below:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Approach</strong></th>
<th><strong>Model bias from segmentation errors?</strong></th>
<th><strong>Model spatial correlation?</strong></th>
<th><strong>Speed</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Standard</strong></td>
<td>Yes</td>
<td>No</td>
<td>moderate</td>
</tr>
<tr class="even">
<td><strong>Optimal/slow</strong></td>
<td>Yes</td>
<td>Yes</td>
<td>very slow</td>
</tr>
<tr class="odd">
<td><strong>Hasty/exploratory</strong></td>
<td>No</td>
<td>No</td>
<td>very fast</td>
</tr>
<tr class="even">
<td><strong>Stepwise: screen with hasty, validate with optimal</strong></td>
<td>Yes</td>
<td>Yes</td>
<td>moderate</td>
</tr>
</tbody>
</table>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" aria-controls="tabset-4-1" aria-selected="true">Standard</a></li><li class="nav-item"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" aria-controls="tabset-4-2" aria-selected="false">Optimal/slow</a></li><li class="nav-item"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" aria-controls="tabset-4-3" aria-selected="false">Hasty/exploratory</a></li><li class="nav-item"><a class="nav-link" id="tabset-4-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-4" aria-controls="tabset-4-4" aria-selected="false">Stepwise</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" aria-labelledby="tabset-4-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## define the problem:</span></span>
<span id="cb18-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># which cells to analyze: (a logical vector over all cells)</span></span>
<span id="cb18-3">inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage"</span></span>
<span id="cb18-4">totalcounts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA</span>
<span id="cb18-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(totalcounts) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_id</span>
<span id="cb18-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## run smiDE with a Negative Binomial model and no spatial correlation modeling:</span></span>
<span id="cb18-7">de_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb18-8">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">smi_de</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay_matrix =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(counts),</span>
<span id="cb18-9">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> metadata[inds, ],</span>
<span id="cb18-10">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RankNorm</span>(otherct_expr) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(nCount_RNA)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> distance_to_tumor,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;----- first two terms adjust for segmentation errors and per-cell signal strength, final term is the variable to be analyzed, must be a column in metadata</span></span>
<span id="cb18-11">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pre_de_obj =</span> pre_de_obj,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># depends on pre_de_obj calculated earlier</span></span>
<span id="cb18-12">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_id"</span>,</span>
<span id="cb18-13">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_cell_type_metadata_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype"</span>,</span>
<span id="cb18-14">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_overlap_weight_colname =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb18-15">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_overlap_agg =</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sum"</span>,</span>
<span id="cb18-16">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_totalcount_normalize =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&lt;--------- @Dan: correct, since I have that offset term above?</span></span>
<span id="cb18-17">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_totalcount_scalefactor =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb18-18">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nbinom2"</span>,</span>
<span id="cb18-19">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">targets=</span>genes_to_analyze     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculated in earlier code block</span></span>
<span id="cb18-20">   ) </span>
<span id="cb18-21">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> smiDE<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">results</span>(de_obj)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use res$pairwise for most cases. res$one.vs.rest can also be useful. </span></span>
<span id="cb18-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(res) </span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" aria-labelledby="tabset-4-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## define the problem:</span></span>
<span id="cb19-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># which cells to analyze: (a logical vector over all cells)</span></span>
<span id="cb19-3">inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage"</span></span>
<span id="cb19-4">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sdimx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb19-5">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sdimy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb19-6">totalcounts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA</span>
<span id="cb19-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(totalcounts) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_id</span>
<span id="cb19-8"></span>
<span id="cb19-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># which genes: (this method is SLOW, so don't just test everything)</span></span>
<span id="cb19-10">selected_genes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KRT16"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EPCAM"</span>)</span>
<span id="cb19-11"></span>
<span id="cb19-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## run smiDE with a Negative Binomial model and no spatial correlation modeling:</span></span>
<span id="cb19-13">de_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb19-14">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">smi_de</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay_matrix =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(counts),</span>
<span id="cb19-15">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> metadata[inds, ],</span>
<span id="cb19-16">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RankNorm</span>(otherct_expr) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(nCount_RNA)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> distance_to_tumor,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;----- first two terms adjust for segmentation errors and per-cell signal strength, final term is the variable to be analyzed, must be a column in metadata</span></span>
<span id="cb19-17">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pre_de_obj =</span> pre_de_obj,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># depends on pre_de_obj calculated earlier</span></span>
<span id="cb19-18">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_id"</span>,</span>
<span id="cb19-19">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_cell_type_metadata_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype"</span>,</span>
<span id="cb19-20">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_overlap_weight_colname =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb19-21">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_overlap_agg =</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sum"</span>,</span>
<span id="cb19-22">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_totalcount_normalize =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb19-23">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_totalcount_scalefactor =</span> totalcounts,</span>
<span id="cb19-24">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nbinom2"</span>,</span>
<span id="cb19-25">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">targets=</span>selected_genes,    </span>
<span id="cb19-26">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">spatial_model =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GP_INLA"</span>,</span>
<span id="cb19-27">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_coord_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sdimx"</span>,  </span>
<span id="cb19-28">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_coord_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sdimy"</span>,</span>
<span id="cb19-29">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quantiles =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(targs), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">-0.025</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(targs)),</span>
<span id="cb19-30">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num.threads=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)          </span>
<span id="cb19-31">   ) </span>
<span id="cb19-32">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> smiDE<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">results</span>(de_obj)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pairwise    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use res$pairwise for most cases. res$one.vs.rest can also be useful. </span></span>
<span id="cb19-33"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(res) </span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-4-3" class="tab-pane" aria-labelledby="tabset-4-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## define the problem:</span></span>
<span id="cb20-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># which cells to analyze: (a logical vector over all cells)</span></span>
<span id="cb20-3">inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage"</span></span>
<span id="cb20-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variable to analyze (defined over all cells):</span></span>
<span id="cb20-5">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> distance_to_tumor</span>
<span id="cb20-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normalized data:</span></span>
<span id="cb20-7">normfactor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA </span>
<span id="cb20-8">norm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> counts</span>
<span id="cb20-9">norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> counts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> normfactor[ counts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L ]</span>
<span id="cb20-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## to put genes on similar scales, scale the columns of norm:</span></span>
<span id="cb20-11">genefactors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(norm))  </span>
<span id="cb20-12">normscaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> genefactors)</span>
<span id="cb20-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(normscaled) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(norm)</span>
<span id="cb20-14"></span>
<span id="cb20-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## source the fast DE function:</span></span>
<span id="cb20-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/refs/heads/Main/_code/PatchDE/DEutils.R"</span>)</span>
<span id="cb20-17"></span>
<span id="cb20-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## run fast DE:</span></span>
<span id="cb20-19">fastres <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hastyDE</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> normscaled[, genes_to_analyze], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">distance2tumor =</span> x))</span>
<span id="cb20-20"></span>
<span id="cb20-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## extract estimates and p-values:</span></span>
<span id="cb20-22">ests <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fastres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>effect</span>
<span id="cb20-23">ps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fastres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p</span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-4-4" class="tab-pane" aria-labelledby="tabset-4-4-tab">
<p>When it’s vital to adjust for spatial correlation, but our dataset’s size makes that impractical, we can run a very efficient but spatially blind model to prioritize the most useful genes, then validate them with a proper spatial correlation model in smiDE.</p>
<p><strong>An important caveat</strong>: because we’ve selected the genes for the smiDE run based on their evidence in the spatial-free DE model, calculating proper adjusted p-values becomes very complicated - we can neither ignore the omitted genes, nor can we use their (presumably over-optimistic) spatial-free p-values.</p>
<p>As a solution, we propose the following procedure, which will produce conservative adjusted p-values:</p>
<ol type="1">
<li>Keep the smiDE p-values from the screened genes.</li>
<li>For the remaining genes, throw out the “hasty” p-values, and generate p-values from the null distribution, i.e.&nbsp;uniformly between 0-1.</li>
<li>Run your preferred p-value adjustment method on the resulting vector of p-values.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## define the problem:</span></span>
<span id="cb21-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># which cells to analyze: (a logical vector over all cells)</span></span>
<span id="cb21-3">inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage"</span></span>
<span id="cb21-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variable to analyze (defined over all cells):</span></span>
<span id="cb21-5">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> distance_to_tumor</span>
<span id="cb21-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normalized data:</span></span>
<span id="cb21-7">normfactor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA </span>
<span id="cb21-8">norm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> counts</span>
<span id="cb21-9">norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> counts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> normfactor[ counts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L ]</span>
<span id="cb21-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to put genes on similar scales, scale the columns of norm:</span></span>
<span id="cb21-11">genefactors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(norm))  </span>
<span id="cb21-12">normscaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> genefactors)</span>
<span id="cb21-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(normscaled) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(norm)</span>
<span id="cb21-14"></span>
<span id="cb21-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## source the fast DE function:</span></span>
<span id="cb21-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/refs/heads/Main/_code/PatchDE/DEutils.R"</span>)</span>
<span id="cb21-17"></span>
<span id="cb21-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## run fast DE:</span></span>
<span id="cb21-19">fastres <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hastyDE</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> normscaled[, genes_to_analyze], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">distance2tumor =</span> x))</span>
<span id="cb21-20"></span>
<span id="cb21-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract top genes:</span></span>
<span id="cb21-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This example takes the top 10 genes by effect size from the top 1% of p-values.</span></span>
<span id="cb21-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We recommend extracting top genes with some human oversight. </span></span>
<span id="cb21-24">topgenes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(fastres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(fastres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>effect) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (fastres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(fastres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)]  </span>
<span id="cb21-25"></span>
<span id="cb21-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run smiDE on the top genes with the optimal / spatial-aware call to smiDE:</span></span>
<span id="cb21-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## define the problem:</span></span>
<span id="cb21-28">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sdimx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb21-29">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sdim2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb21-30">totalcounts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA</span>
<span id="cb21-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(totalcounts) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_id</span>
<span id="cb21-32"></span>
<span id="cb21-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## run smiDE with a Negative Binomial model and with spatial correlation modeling:</span></span>
<span id="cb21-34">de_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb21-35">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">smi_de</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay_matrix =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(counts),</span>
<span id="cb21-36">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> metadata[inds, ],</span>
<span id="cb21-37">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RankNorm</span>(otherct_expr) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">offset</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(nCount_RNA)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> distance_to_tumor,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;----- first two terms adjust for segmentation errors and per-cell signal strength, final term is the variable to be analyzed, must be a column in metadata</span></span>
<span id="cb21-38">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pre_de_obj =</span> pre_de_obj,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># depends on pre_de_obj calculated earlier</span></span>
<span id="cb21-39">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_id"</span>,</span>
<span id="cb21-40">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_cell_type_metadata_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype"</span>,</span>
<span id="cb21-41">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_overlap_weight_colname =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb21-42">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_overlap_agg =</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sum"</span>,</span>
<span id="cb21-43">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_totalcount_normalize =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb21-44">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_expr_totalcount_scalefactor =</span> totalcounts,</span>
<span id="cb21-45">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nbinom2"</span>,</span>
<span id="cb21-46">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">targets=</span>topgenes,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only analyze the genes of greatest interest</span></span>
<span id="cb21-47">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">spatial_model =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GP_INLA"</span>,</span>
<span id="cb21-48">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_coord_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sdimx"</span>,  </span>
<span id="cb21-49">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_coord_col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sdimy"</span>,</span>
<span id="cb21-50">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quantiles =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(targs), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">-0.025</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(targs)),</span>
<span id="cb21-51">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num.threads=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)          </span>
<span id="cb21-52">   ) </span>
<span id="cb21-53">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">results</span>(de_obj)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pairwise   </span>
<span id="cb21-54"></span>
<span id="cb21-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get conservative adjusted p-values for the top genes, replacing hasty p-values with the null distribution:</span></span>
<span id="cb21-56">ps.spatial <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pairwise<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p.value[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"distance_to_tumor"</span>, res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pairwise<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>contrast)]</span>
<span id="cb21-57"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(ps.spatial) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pairwise<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>target[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"distance_to_tumor"</span>, res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pairwise<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>contrast)]</span>
<span id="cb21-58">ps.null <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(genes_to_analyze) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(topgenes))</span>
<span id="cb21-59"></span>
<span id="cb21-60">ps.spatial.adjusted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">p.adjust</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ps.spatial, ps.null), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BH"</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(ps.spatial)]</span></code></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="analyzing-de-results" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Analyzing DE results</h1>
<p>When your models have finished, it remains to prioritize the most promising genes for reporting and further analysis, then validate and explore their results.</p>
<section id="prioritizing-genes" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="prioritizing-genes"><span class="header-section-number">4.1</span> Prioritizing genes</h2>
<p>How you prioritize genes depends on your setting. There are two basic cases:</p>
<p><strong>High power settings</strong>: when your model has high N (e.g.&nbsp;&gt;10000 cells) and no adjusting for spatial correlation, it’s common to get very tiny p-values, e.g.&nbsp;&lt; 10^-50. In these cases, apply a reasonable p-value cutoff, say the top 20% of genes, then rank genes by effect size.</p>
<p><strong>Low power settings</strong>: when p-values aren’t infinitesimal, rank genes as you would in other DE settings, i.e.&nbsp;considering both p-value and effect size.</p>
</section>
<section id="exploring-results" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="exploring-results"><span class="header-section-number">4.2</span> Exploring results</h2>
<p>The usual DE tools, like volcano plots and GSEA, apply directly to spatial data, and your existing workflows should work without modification. A few additional techniques bear mention. Since these explorations are highly custom, we leave it to you to code these final plots however you like.</p>
<p>For continuous variables like distance to a cell type or local abundance of a cell type, it can be helpful to show mean expression across bins of the variable. E.g. in the below image, we show selected genes’ mean expression in tumor cells at different distances from blood vessels. This lets us see in more nuance how genes change over space, and it lets us cluster together genes with similar spatial patterns.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/DE heatmap.png" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
</div>
</div>
<p>Second, unlike in single cell data, we can easily verify our results by plotting a gene’s expression in our given cell type over space. We favor plots that both show the “exposure” you’re studying and color the cells we’re studying by gene expression. E.g., in the below image, we were studying how tumor cells respond to proximity to blood vessels. Most cells are in a mute grey. Then we brightly color the exposure (blood vessels) blue, and use a yellow-red color scale to show a target gene’s expression in tumor cells.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/VEGFA.png" class="img-fluid figure-img" style="width:40.0%"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can plot a single gene’s mean expression across values of a continuous variable. E.g., below we plot VEGFA expression vs.&nbsp;distance from vessels, with lines showing trends in 4 different cell types:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/VEGFA-traceplot.png" class="img-fluid figure-img" style="width:40.0%"></p>
</figure>
</div>
</div>
</div>
<p>For categorical variables, we can use polygons over space to denote predictor category, while using color to show expression:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/depolygons.png" class="img-fluid figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
<p>And we can use standard bar plots (or better, bar-and-whisker plots), or violin plots, to summarize expression across categories:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/pdcd1.png" class="img-fluid figure-img" style="width:20.0%"></p>
</figure>
</div>
</div>
</div>
<p>Or we can use a heatmap to show the mean expression per category of many genes at once:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/deheatmap2.png" class="img-fluid figure-img" style="width:15.0%"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>recommended</category>
  <category>differential expression</category>
  <category>overview</category>
  <category>how-tos</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/03_DE.html</guid>
  <pubDate>Wed, 24 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/DAPI-red.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Basic analysis vignette: exploratory analysis</title>
  <dc:creator>Patrick Danaher</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/02_exploratory_analysis.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Here we provide workflows for exploratory analysis. Also see the companion posts on <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/01_preprocessing.html">pre-processing</a> and confirmatory analysis with <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/03_DE.html">differential expression testing</a>. A complete analysis will typically begin with the pre-processing workflow, use exploratory analyses to generate hypotheses, then conclude by using differential expression analysis to test those hypotheses.</p>
<p>CosMx datasets, with thousands of genes and hundreds of thousands of cells, contain an incomprehensible richness of biological trends. Even when you have a primary hypothesis in mind, it’s worth seeing what unexpected findings your data holds. To this end, various exploratory analysis tools exist to help you answer the basic question, “what in this dataset might be worth paying attention to?”</p>
<p>A great many tools exist for exploring spatial data, and we do not attempt to catalog them here. Instead, we’ll share a few techniques we’ve found useful. The four tools we discuss are:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Approach</strong></th>
<th><strong>Inputs</strong></th>
<th><strong>Outputs</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Score pathway activity with AUCell</td>
<td>raw counts</td>
<td>pathway scores</td>
</tr>
<tr class="even">
<td>Look for spatially variable genes (or pathways)</td>
<td>normalized counts, xy, cell type</td>
<td>per-gene Moran’s I stats</td>
</tr>
<tr class="odd">
<td>Look for spatially correlated genes using InSituCor</td>
<td>normalized counts, xy, cell type</td>
<td>modules of spatially correlated genes</td>
</tr>
<tr class="even">
<td>Look for perturbations from baseline using InSituDiff</td>
<td>normalized counts, xy</td>
<td>diverse outputs</td>
</tr>
</tbody>
</table>
<section id="getting-started" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="getting-started"><span class="header-section-number">1.1</span> Getting started</h2>
<p>To begin, load your fully pre-processed data (including cell type annotations). We assume the format generated by the <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/01_preprocessing.html">preprocessing vignette</a>:</p>
<ul>
<li>a sparse counts matrix with cells in rows and genes in columns</li>
<li>a data table of per-cell metadata, row-aligned with the counts matrix</li>
<li>a matrix of cells’ xy positions, row-aligned with the counts matrix</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## load necessary libraries</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for more memory efficient data frames</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(Matrix) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for sparse matrices like our counts matrix</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(InSituCor) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># devtools::install_github("https://github.com/Nanostring-Biostats/InSituCor")</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(InSituDiff) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remotes::install_github("Nanostring-Biostats/CosMx-Analysis-Scratch-Space", subdir = "_code/InSituDiff", ref = "Main")</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(AUCell) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BiocManager::install("AUCell")</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(msigdbr) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BiocManager::install("msigdbr")</span></span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## load data:</span></span>
<span id="cb1-10">counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/counts.RDS"</span>))</span>
<span id="cb1-11">metadata <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/metadata.RDS"</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected to have the column "celltype"</span></span>
<span id="cb1-12">xy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/xy.RDS"</span>))</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## normalize counts matrix using efficient sparse matrix calls:</span></span>
<span id="cb1-15">scale_row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA</span>
<span id="cb1-16">norm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> counts</span>
<span id="cb1-17">norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> scale_row[norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L]</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="pathway" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Computing pathway scores</h1>
<p>Computing per-cell scores of pathway activity is useful for a few reasons:</p>
<ol type="1">
<li>Single gene expression values are noisy; pathway scores, computed across broader sets of genes, are more statistically stable.</li>
<li>Pathway scores are often easier to interpret.</li>
<li>Dimension reduction: it’s more convenient to analyze hundreds of pathways than thousands of genes.</li>
</ol>
<p>We have tried a variety of pathway scoring approaches, and <a href="https://github.com/aertslab/AUCell" target="_blank">AUCell</a> with REACTOME gene sets has emerged as our preferred approach. (That said, our benchmarking was not definitive, and we have no specific concerns about alternative methods.)</p>
<p>For full details on running AUCell, see the <a href="https://bioconductor.org/packages/release/bioc/vignettes/AUCell/inst/doc/AUCell.html" target="_blank">AUC package vignette</a>.</p>
<p>You can compute per-cell pathway scores as follows:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## run AUCell:  # </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">WARNING</span><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">: below takes hours in a single flowcell dataset and creates a 3 Gb data object</span></span>
<span id="cb2-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb2-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tic</span>()</span>
<span id="cb2-4">  pathscores <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> AUCell<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">AUCell_run</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exprMat =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(counts), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geneSets =</span> gene.sets) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># , BPPARAM = BiocParallel::MulticoreParam(workers = 8)</span></span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toc</span>()</span>
<span id="cb2-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(pathscores, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/pathscores.RDS"</span>))</span>
<span id="cb2-7">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb2-8">  pathscores <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/pathscores.RDS"</span>))</span>
<span id="cb2-9">}</span></code></pre></div>
</details>
</div>
<p>The pathway scores calculated above can now be used anywhere you’d use a gene expression matrix. Our favorite uses of pathway scores are:</p>
<ul>
<li>Simply look at spatial plots for pathways of interest.</li>
<li>Look for spatially variable pathway scores, e.g.&nbsp;with the Moran’s I code below.</li>
<li>Score cells for neighborhood pathway activity, e.g.&nbsp;“mean neighborhood IFNG pathway score”, and use this as a predictor in differential expression analyses.</li>
<li>Compare mean pathway scores between cell types of interest, e.g.&nbsp;tumor subclusters.</li>
<li>Compare pathway scores across niches.</li>
<li>It’s also possible to run differential expression analysis on pathway scores, but we prefer to run DE on single genes, then run gene set enrichment analysis.</li>
</ul>
<p><strong>Note:</strong> the above code produces a dense matrix of cell x pathway scores. For larger datasets, this will tax your memory. For bigger studies, you could compute them in chunks, e.g.&nbsp;separately for each tissue, or for each cell type.</p>
</section>
<section id="moran" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Looking for spatially variable genes</h1>
<p>Many methods have been developed for this task. We use Moran’s I, a very old approach from the world of spatial statistics.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Source the efficient Moran's function</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/Main/_code/vignette2/utils/moransMultiFast.R"</span>)</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute neighbors matrix:</span></span>
<span id="cb3-5">neighbors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nearestNeighborGraph</span>(xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>slide_ID)  </span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for speed, subset to FOVs covering ~100k cells</span></span>
<span id="cb3-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-9">ncells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e6</span></span>
<span id="cb3-10">cellsperfov <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>FOV))</span>
<span id="cb3-11">nfovs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ceiling</span>(ncells <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> cellsperfov)</span>
<span id="cb3-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (nfovs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>FOV))) {</span>
<span id="cb3-13">  usefovs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>FOV), nfovs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb3-14">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb3-15">  usefovs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>FOV)</span>
<span id="cb3-16">}</span>
<span id="cb3-17">inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.element</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>FOV, usefovs)</span>
<span id="cb3-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute moran's:</span></span>
<span id="cb3-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (very fast if not too many cells)</span></span>
<span id="cb3-20">morans_all <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">moransMultiFast</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> norm[inds, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> neighbors[inds, inds], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">perm =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">compute_sparse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">compute_perm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb3-21"></span>
<span id="cb3-22"></span>
<span id="cb3-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot moran's vs. mean expression</span></span>
<span id="cb3-24">meanexpr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(counts)</span>
<span id="cb3-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> meanexpr), morans_all<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>I[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(meanexpr), morans_all<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb3-26">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Log2 mean counts"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Moran's I"</span>)</span>
<span id="cb3-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> meanexpr), morans_all<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>I[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(meanexpr), morans_all<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene)], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(meanexpr), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb3-28"></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># save spatially variable genes:</span></span>
<span id="cb3-30">svgs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> morans_all<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene[morans_all<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>]</span></code></pre></div>
</details>
</div>
<p>Genes in the list generated above have strong spatial correlation and therefore are more likely to hold biological interest. Plotting them spatially one-by-one and examining the output is a good way to start.</p>
<section id="morans-by-cell-type" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="morans-by-cell-type"><span class="header-section-number">3.1</span> Moran’s by cell type</h2>
<p>Moran’s I and similar approaches have one disappointing feature: they often just highlight cell type marker genes. We don’t need to look for spatial variability to learn that a cell type has spatial patterns; we can just look at the cell type’s spatial distribution. One way to avoid wasting time on trivial discoveries like marker genes is to calculate Moran’s I within a cell type of interest. The top genes from such an analysis will suggest ways the cell type is changing over space.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## calculate Moran's within a cell type:</span></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># select just the cell type's cells:</span></span>
<span id="cb4-3">inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage"</span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the neighbor relationships within just the cell type:</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (Here we'll use a radius-based approach to account for the fact that cells from a given cell type may fall quite far from their nearest neighbors from the same cell type.)</span></span>
<span id="cb4-6">tempneighbors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">radiusBasedGraph</span>(xy[inds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], xy[inds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>slide_ID)  </span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check there's a reasonable number of neighbors per cell:</span></span>
<span id="cb4-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(tempneighbors <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute moran's:</span></span>
<span id="cb4-11">morans_mycelltype <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">moransMultiFast</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> norm[inds, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">W =</span> neighbors[inds, inds], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">perm =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">compute_sparse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">compute_perm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb4-12"></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot moran's vs. mean expression</span></span>
<span id="cb4-14">meanexpr_mycelltype <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(counts[inds, ])</span>
<span id="cb4-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> meanexpr_mycelltype), </span>
<span id="cb4-16">     morans_mycelltype<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>I[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(meanexpr_mycelltype), morans_mycelltype<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb4-17">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Log2 mean counts"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Moran's I"</span>)</span>
<span id="cb4-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> meanexpr_mycelltype), </span>
<span id="cb4-19">     morans_mycelltype<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>I[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(meanexpr_mycelltype), morans_mycelltype<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene)], </span>
<span id="cb4-20">     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(meanexpr_mycelltype), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="insitucor" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Finding modules of spatially correlated genes with InSituCor</h1>
<p>Just as genes with strong spatial trends are potentially interesting, so are sets of genes with shared spatial patterns. We created InSituCor to find groups of spatially correlated genes. Importantly, InSituCor ignores correlation driven by the cell type landscape. E.g., it won’t tend to cluster CD19 and CD20 together, because their spatial correlation is only driven by their being expressed in the same cell type, not by any interesting spatial trend. For a full writeup, see <a href="https://link.springer.com/article/10.1186/s13059-025-03554-1" target="_blank">the paper</a>; for code, see <a href="https://github.com/Nanostring-Biostats/InSitucor" target="_blank">the package</a>.</p>
<p>A quick run-through of the InSituCor workflow is below:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## key input: data to be conditioned on. Only cell type is necessary, though slide / tissue ID could be used as well .</span></span>
<span id="cb5-2">conditionon <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(metadata[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>])</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## run InSituCor:</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (&lt;10 mins)</span></span>
<span id="cb5-6">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">insitucor</span>(</span>
<span id="cb5-7">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fundamental input data:</span></span>
<span id="cb5-8">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts =</span> norm, </span>
<span id="cb5-9">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conditionon =</span> conditionon, </span>
<span id="cb5-10">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">celltype =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype,</span>
<span id="cb5-11">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># args for neighbor definition:</span></span>
<span id="cb5-12">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbors =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xy =</span> xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">radius =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tissue =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,  </span>
<span id="cb5-13">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># args for module definition:</span></span>
<span id="cb5-14">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_module_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_module_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_module_cor =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb5-15">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gene_weighting_rule =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"inverse_sqrt"</span>,   </span>
<span id="cb5-16">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># args for controlling memory and compute</span></span>
<span id="cb5-17">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">roundcortozero =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_cells =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e5</span>,                               </span>
<span id="cb5-18">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># args for cell type attribution scoring</span></span>
<span id="cb5-19">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">attribution_subset_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,                                      </span>
<span id="cb5-20">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb5-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(res)</span>
<span id="cb5-22"></span>
<span id="cb5-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## exploring InSituCor results: </span></span>
<span id="cb5-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># You'll want to look for modules that:</span></span>
<span id="cb5-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - have interesting genes (look at the module content)</span></span>
<span id="cb5-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - involve your cell types of interest (look at the cell type involvement / attribution scores)</span></span>
<span id="cb5-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - have interesting spatial patterns (plot their scores in space)</span></span>
<span id="cb5-28"></span>
<span id="cb5-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># look at the spatial correlation network:</span></span>
<span id="cb5-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plotCorrelationNetwork</span>(res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>condcor, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">modules =</span> res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>modules, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_gene_names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, </span>
<span id="cb5-31">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">corthresh =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb5-32"></span>
<span id="cb5-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># look at module content:</span></span>
<span id="cb5-34"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>modules)</span>
<span id="cb5-35"></span>
<span id="cb5-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot a selected module over space:</span></span>
<span id="cb5-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mfrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb5-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... at the single cell level:</span></span>
<span id="cb5-39">tempscore <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>scores_sc[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb5-40"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex.main =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>,</span>
<span id="cb5-41">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>scores_env)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" single cell score"</span>),</span>
<span id="cb5-42">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x mm"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y mm"</span>,</span>
<span id="cb5-43">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> viridis<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">viridis_pal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>)(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb5-44">       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (tempscore <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(tempscore, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.995</span>))), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)])</span>
<span id="cb5-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... and at the level of cellular neighborhoods:</span></span>
<span id="cb5-46">tempscore <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>scores_env[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb5-47"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex.main =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>,</span>
<span id="cb5-48">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>scores_env)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" neighborhood score"</span>),</span>
<span id="cb5-49">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x mm"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y mm"</span>,</span>
<span id="cb5-50">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> viridis<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">viridis_pal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>)(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb5-51">       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (tempscore <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(tempscore, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.995</span>))), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)])</span>
<span id="cb5-52"></span>
<span id="cb5-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># look at the involvement of each cell type in each module:</span></span>
<span id="cb5-54"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pheatmap</span>(res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltypeinvolvement, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>),</span>
<span id="cb5-55">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Contribution of cell types to module scores"</span>)</span>
<span id="cb5-56"></span>
<span id="cb5-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># zoom in on the cell type involvement for a single module:</span></span>
<span id="cb5-58"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pheatmap</span>(res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>attributionmats[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>),</span>
<span id="cb5-59">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Contribution of cell types to module genes"</span>)</span></code></pre></div>
</details>
</div>
<p>Our results include:</p>
<ul>
<li>A list of gene modules:</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/iscor_modules.png" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>The spatial correlation network:</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/cornet.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Module scores over space:</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/iscorxy.png" class="img-fluid figure-img" style="width:45.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>“Cell type attribution scores” estimating how much each cell type is responsible for each module of correlated genes.</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/attribmat.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>And for each module, attribution scores estimating how much each cell type is responsible for each gene in the module.</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/attribmat2.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="insitudiff" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Studying perturbations from baseline using InSituDiff</h1>
<p>The InSituDiff algorithm is a useful tool for exploring studies with both disease and baseline samples. It matches cellular neighborhoods in disease with the most similar baseline neighborhoods, then records the discrepancies as “perturbations”. These perturbations are then very useful fodder for downstream analysis. In practice, we find that InSituDiff quickly highlights the genes and spatial regions that are most worthy of attention. For a full writeup, see <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/insitudiff/" target="_blank">the blog post</a>; for code, see <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/InSituDiff" target="_blank">the package</a>.</p>
<p>Note: InSituDiff is meant to reveal perturbations from baseline. If you have no reasonable baseline samples, say in most cancer studies, then you’re better off using InSituCor.</p>
<p>A quick run-through of exploratory analysis using InSituDiff is below:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the necessary data to run analyses:</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (a few minutes)</span></span>
<span id="cb6-3">obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituDiff<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">initializeISD</span>(</span>
<span id="cb6-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mat =</span> norm, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># matrix of normalized expression</span></span>
<span id="cb6-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xy =</span> xy, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># matrix of xy coordinates</span></span>
<span id="cb6-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tissue =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tissue, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vector of cells' tissue IDs</span></span>
<span id="cb6-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iscontrol =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"control"</span>, metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tissue), </span>
<span id="cb6-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define cellular neighborhoods as a cell's 50 nearest neighbors</span></span>
<span id="cb6-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(obj)</span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># score perturbations of selected genes over all cells:</span></span>
<span id="cb6-12">selectedperturbations <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituDiff<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getPerturbations</span>(</span>
<span id="cb6-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> norm, </span>
<span id="cb6-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obj =</span> obj, </span>
<span id="cb6-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cells =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(counts)[metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tissue <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tissue1"</span>], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only look at one tissue</span></span>
<span id="cb6-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">genes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IGHA1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FGFR3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HIF1A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ACE2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SAT1"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only look at a few genes of interest</span></span>
<span id="cb6-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">residtype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2ratio"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># look at perturbations on the scale of log fold-changes</span></span>
<span id="cb6-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-19"></span>
<span id="cb6-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># score overall perturbation per gene:</span></span>
<span id="cb6-21">genescores <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituDiff<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarizeGenePerturbation</span>(</span>
<span id="cb6-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> norm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obj =</span> obj, </span>
<span id="cb6-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">residtype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2ratio"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plotresults =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subsetsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e5</span>) </span>
<span id="cb6-24"></span>
<span id="cb6-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># identify highly perturbed genes:</span></span>
<span id="cb6-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(genescores[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb6-27">thresh <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb6-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v =</span> thresh, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb6-29">hpgs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(genescores)[genescores[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"broadness"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> thresh]</span>
<span id="cb6-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Highly perturbed genes: "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(hpgs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>)))</span>
<span id="cb6-31"></span>
<span id="cb6-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get modules of genes whose perturbations are spatially correlated:</span></span>
<span id="cb6-33">modules <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituDiff<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">buildGeneModules</span>(</span>
<span id="cb6-34">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> norm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obj =</span> obj, </span>
<span id="cb6-35">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">genes =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subset of genes to use; enter NULL to use all, or "highlyperturbed" to take just the most perturbed genes ("highlyperturbed" is our default and our recommendation for full studies; here we use NULL because our mini dataset has only 30 genes.)</span></span>
<span id="cb6-36">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resolution =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># control leiden clustering</span></span>
<span id="cb6-37">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">corthresh =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># control the adjacency network used by leiden clustering</span></span>
<span id="cb6-38">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_module_cor =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># throw out modules with average cor below this</span></span>
<span id="cb6-39">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subsetsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e5</span>, </span>
<span id="cb6-40">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, </span>
<span id="cb6-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">residtype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2ratio"</span>) </span>
<span id="cb6-42">modules</span>
<span id="cb6-43"></span>
<span id="cb6-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># score perturbations of selected modules across all cells:</span></span>
<span id="cb6-45">moduleperturbations <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituDiff<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getPerturbations</span>(</span>
<span id="cb6-46">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> norm, </span>
<span id="cb6-47">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obj =</span> obj, </span>
<span id="cb6-48">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cells =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only look at one tissue</span></span>
<span id="cb6-49">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">genes =</span> modules[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># arbitrarily plotting the first and second modules</span></span>
<span id="cb6-50">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">residtype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2ratio"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># look at perturbations on the scale of log fold-changes</span></span>
<span id="cb6-51">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb6-52"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb6-53">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Perturbation of module "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(moduleperturbations)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb6-54">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorZeroCentered</span>(moduleperturbations[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxquant =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.999</span>))</span>
<span id="cb6-55"></span>
<span id="cb6-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define spatial domains of perturbations by clustering perturbation values across space:</span></span>
<span id="cb6-57"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb6-58">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituDiff<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterPerturbations</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> norm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obj =</span> obj, </span>
<span id="cb6-59">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cells =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb6-60">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">genes =</span> hpgs, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using the highly perturbed genes we defined earlier </span></span>
<span id="cb6-61">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">residtype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log2ratio"</span>, </span>
<span id="cb6-62">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nclust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb6-63"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb6-64">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cornflowerblue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkviolet"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orange"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"forestgreen"</span>)[</span>
<span id="cb6-65">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clust))])  </span>
<span id="cb6-66"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pheatmap</span>(res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>means, </span>
<span id="cb6-67">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>), </span>
<span id="cb6-68">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkred"</span>))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span></code></pre></div>
</details>
</div>
<p>The above produces:</p>
<ul>
<li>Scores for how broadly and how intensely each gene is perturbed</li>
<li>A list of highly perturbed genes - this is very useful for beginning exploratory analyses</li>
<li>Modules of genes whose perturbations are spatially correlated:</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/isdiff_modules.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Spatial clustering results based on perturbations, not expression. This is useful for partitioning tissues by domains of disease process rather than by tissue architecture.</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/isdiff_domains.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>“Perturbation profiles” of those domains:</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/hpg_domain_heatmap.png" class="img-fluid figure-img" style="width:45.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Conclusion</h1>
<p>The above methods are best for hypothesis generation, not as final results in themselves. Trends discovered with these tools very often suggest a specific hypothesis which can be tested with differential expression or with a custom hypothesis test.</p>


</section>

 ]]></description>
  <category>recommended</category>
  <category>exploratory analysis</category>
  <category>overview</category>
  <category>how-tos</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/02_exploratory_analysis.html</guid>
  <pubDate>Tue, 23 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/DAPI-purple.png" medium="image" type="image/png" height="143" width="144"/>
</item>
<item>
  <title>Basic analysis vignette: QC, normalization, dimension reduction and cell typing</title>
  <dc:creator>Patrick Danaher</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/01_preprocessing.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Here we propose an updated pipeline for basic CosMx<sup>®</sup> analysis in R, from data loading through cell typing. This workflow applies to all our RNA assays. Also see the companion posts on <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/02_exploratory_analysis.html">exploratory data analysis</a> and confirmatory analysis with <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/03_DE.html">differential expression testing</a>. A complete analysis will typically begin with the pre-processing described here, use exploratory analyses to generate hypotheses, then conclude by using differential expression analysis to test those hypotheses.</p>
<p>This code assumes a whole study can be fit into your compute environment’s memory. For very large studies, see our upcoming vignette on the topic.</p>
<p>This post is exclusively in R. Many steps have easy python analogs, but some, like the HieraType immune cell typing algorithm and the FOV QC functions, only have R implementations.</p>
<section id="outline" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="outline"><span class="header-section-number">1.1</span> Outline</h2>
<p>A high-level view of our workflow is below:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th><strong>Step</strong></th>
<th><strong>Inputs</strong></th>
<th><strong>Outputs</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Load flat files</td>
<td>Flat files</td>
<td>Raw counts, metadata, xy</td>
</tr>
<tr class="even">
<td>Customize tissues’ xy arrangement</td>
<td>xy</td>
<td>xy</td>
</tr>
<tr class="odd">
<td>QC cells and FOVs</td>
<td>Raw counts, metadata, xy</td>
<td>Raw counts, metadata, xy (filtered)</td>
</tr>
<tr class="even">
<td>Normalization</td>
<td>Raw counts</td>
<td>Normalized counts</td>
</tr>
<tr class="odd">
<td>Dimension reduction: get HVGs</td>
<td>Raw counts</td>
<td>HVGs</td>
</tr>
<tr class="even">
<td>Dimension reduction: PCA</td>
<td>Raw counts, metadata, HVGs</td>
<td>PCs</td>
</tr>
<tr class="odd">
<td>Dimension reduction: UMAP</td>
<td>PCs</td>
<td>UMAP projection, nearest neighbors</td>
</tr>
<tr class="even">
<td>Graph clustering (Louvain or Leiden)</td>
<td>Nearest neighbors</td>
<td>Clusters</td>
</tr>
<tr class="odd">
<td>InSituType clustering</td>
<td>Raw counts, HVGs, metadata (mean negprobe column)</td>
<td>Clusters</td>
</tr>
<tr class="even">
<td>Cluster naming / marker gene ID</td>
<td>Clusters, raw counts</td>
<td>Suggested cluster names</td>
</tr>
<tr class="odd">
<td>Cluster QC</td>
<td>Clusters, raw counts</td>
<td>Suggested cluster names</td>
</tr>
<tr class="even">
<td>Immune cell typing with HieraType</td>
<td>Raw counts, nearest neighbors</td>
<td>HieraType calls</td>
</tr>
<tr class="odd">
<td>Harmonize HieraType with prior clusters</td>
<td>HieraType calls, clusters</td>
<td>Cell type calls</td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled" title="Note on large studies">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note on large studies
</div>
</div>
<div class="callout-body-container callout-body">
<p>When your data is too large to fit into memory – and this can happen with just a few slides of WTX data – At this point, we recommend the below workflow, which we will demonstrate in a separate vignette in early 2026:</p>
<ol type="1">
<li>Obtain a subsample of the larger study. This could be FOVs chosen at random from all the tissues in the study, or just the first couple slides to come off the instrument.</li>
<li>Use this subsample to fix a basic pre-processing pipeline. Importantly, this pipeline has to be applicable to new samples: their data has to be projected onto the same dimension-reduced embedding, and their cell typing has to map to the cell typing of the subsample.</li>
<li>Apply the above pre-processing pipeline separately to each tissue/slide in the study.</li>
<li>Define an additional “hypothesis testing” pipeline, also to be applied separately to each tissue. This pipeline will compute whatever summary statistics you’re interested in, e.g.&nbsp;DE results, cell type abundance, LR interaction scores.</li>
<li>Perform meta-analysis of every tissues’ summary statistics together. E.g. contrast DE results or cell type abundances across responders and non-responders.</li>
<li>Custom subset analyses: you may also have to load in custom subsets of the data for analysis, e.g.&nbsp;just the macrophages from every tissue.</li>
</ol>
</div>
</div>
</section>
</section>
<section id="loading" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Loading flat files</h1>
<p>First we’ll load the packages we need. Importantly, we’ll load “Matrix”, which handles <em>sparse matrices</em>. When a matrix has mainly zeroes, which is generally the case for single cell data, storing it in sparse matrix format has huge memory savings. Given the size of CosMx data, it is vital to be memory-efficient.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># necessary libraries</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for more memory efficient data frames</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(Matrix) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for sparse matrices like our counts matrix</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(InSituCor) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># devtools::install_github("https://github.com/Nanostring-Biostats/InSituCor")</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(HieraType) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remotes::install_github("Nanostring-Biostats/CosMx-Analysis-Scratch-Space", subdir = "_code/HieraType", ref = "Main")</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(Seurat)</span></code></pre></div>
</details>
</div>
<p><a href="../../posts/flat-file-exports/flat-files-compare.html" target="_blank">AtoMx flat file exports</a> come with each slide packaged in its own directory. Our example here has one slide, titled “BreastCancer”; its contents look like this:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/flatfiles.png" class="img-fluid figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
<p>So we have 5 files: an expression matrix, cell metadata, cell polygons, a map of fov positions, and the (very large) transcript locations file from this analysis. This analysis will only use the expression matrix and metadata. As such, you could reasonably export only those files from AtoMx. For examples on how to use the cell polygons in plots, see <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/" target="_blank">this post</a>.</p>
<p>Now we’ll load in the flat files and format as we want.</p>
<p>Trying to load an entire matrix into memory at once may cause out-of-memory issues for large files.<br>
In the code below, we load the counts matrices in chunks.<br>
* First, we’ll use <code>data.table::fread</code> function which can directly read gzipped files, and determine how many rows and columns we’re working with.<br>
* Then, we’ll read each chunk of data in, and convert it to a low-memory sparse matrix format before moving onto the next chunk.<br>
* At the end, we’ll combine our sparse matrices to create the full data matrix.</p>
<p>Note: we’ll store our count matrices with cells in rows and genes in columns. Many protocols arrange their count matrix the other way around, but our approach here will be more performant for most operations.</p>
<p>To begin, tell your script where to operate:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## set up:</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># location of flat files:</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (point to a directory containing one folder of flat files per slide)</span></span>
<span id="cb2-4">myflatfiledir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"path_to_your_flat_files_folder/flatFiles"</span>    </span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># where to write output:</span></span>
<span id="cb2-6">outdir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"path_to_your_desired_output_location"</span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set up results directories for later</span></span>
<span id="cb2-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.exists</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results"</span>))){</span>
<span id="cb2-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.create</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results"</span>))</span>
<span id="cb2-11">}</span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># directory to hold intermediate data files</span></span>
<span id="cb2-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.exists</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data"</span>))){</span>
<span id="cb2-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.create</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data"</span>))</span>
<span id="cb2-15">}</span>
<span id="cb2-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setwd</span>(outdir)</span></code></pre></div>
</details>
</div>
<p>The below code performs the loading and merging operations, producing 4 data objects:</p>
<ul>
<li>A cell metadata matrix (cells x variables)</li>
<li>A counts matrix (cells x genes)</li>
<li>A matrix of cells’ xy positions (in mm)</li>
<li>(Optional) A negative control probe (“negprobe”) counts matrix (cells x negprobes)</li>
<li>(Optional) A SystemControl (“falsecode”) counts matrix (cells x falsecodes)</li>
</ul>
<p>If given a flat files directory with multiple slides, it will seamlessly load and combine their data into a unified dataset.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### source readFlatFiles:</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/Main/_code/vignette2/utils/readFlatFiles.R"</span>)</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### automatically get slide names:</span></span>
<span id="cb3-5">slidenames <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir</span>(myflatfiledir)</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### load the flat files and return as distinct data objects:</span></span>
<span id="cb3-8">temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readFlatFiles</span>(myflatfiledir, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slidenames =</span> slidenames, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">return_negprobes =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">return_falsecodes =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">offset_slides =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span>
<span id="cb3-9">counts   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>counts;    temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb3-10">metadata <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>metadata;  temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>metadata <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb3-11">xy       <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>xy;        temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>xy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb3-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span>(temp)</span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># checks</span></span>
<span id="cb3-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">identical</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(counts), metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_id))</span>
<span id="cb3-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(counts) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
</details>
</div>
<p>Note that the above performs some well-advised modifications to the metadata:</p>
<ul>
<li>Removes the “fov” column, which has duplicate values over multiple slides (e.g.&nbsp;any two slides will each have a fov 1). Replace it with the “FOV” column, which appends a slide identifier to FOV IDs so that each FOV has a unique id.</li>
<li>Removes the “cell_ID” column, which also can have duplicate values across slides, and retain the duplicate-free column “cell_id”.</li>
<li>For convenience, extracts cells’ xy positions as a separate data object, and recasts them from pixel-scale to mm-scale.</li>
<li>Adds the mean negprobe counts to the metadata (the metadata has the <em>sum</em> of the negprobes already, but since negprobe counts vary across panels it’s worth recording this value now so we won’t have to remember our negprobe number later.)</li>
</ul>
<p>Finally, we save these data objects as .RDS files. These files are smaller on disk (they benefit from more compression than flat files do), and they’re faster to read back into R.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Please note that these files hold intermediate results for convenience during analysis; they are not official file formats supported by BSB.</strong></p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># save data in R-friendly form:</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(counts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/counts_unfiltered.RDS"</span>))</span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(metadata, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/metadata_unfiltered.RDS"</span>))</span>
<span id="cb4-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/xy_unfiltered.RDS"</span>))</span></code></pre></div>
</details>
</div>
<p>Now we have data in 3 locations:</p>
<ul>
<li>The RDS files we just created</li>
<li>The flat files we began with</li>
<li>The original data on AtoMx SIP</li>
</ul>
<p>This is unnecessary duplication, and since CosMx data is so large, storing extra copies can incur real cost. There are two feasible approaches:</p>
<ol type="1">
<li><p>Once you’ve finished your analysis, delete all the large .RDS files created during it. They can always be regenerated by re-running the analysis scripts. If you are computing on the cloud, re-running does incur some compute costs, but these are minor compared to the cost of indefinitely storing large files.</p></li>
<li><p>Once you’ve confirmed this data loading script has run successfully, you can safely delete the flat files - you won’t be using them again. If you do need to go back to them, they’ll be on AtoMx, ready to be downloaded again: AtoMx acts as a persistent, authoritative source of unmodified data.</p></li>
</ol>
</section>
<section id="xy" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Customizing the tissues’ spatial arrangements</h1>
<p>To show multiple slides in the same spatial plot, or just to produce spatial plots without a lot of extraneous white space, we often have to shift around tissues’ and/or FOVs’ xy positions. (We of course will preserve the relative xy positions of any cells we plan to analyze together spatially.) Below are some tools and code chunks for facilitating these operations, some borrowed from <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/visuals-reduce-whitespace/" target="_blank">this post</a>.</p>
<p>The basic operations of customized xy layouts are as follows:</p>
<p><strong>First</strong>, for multi-slide studies, adjust the slides’ xy positions so they don’t overlap. This function is called within our flat file reader, but you can call it again to customize how slides are tiled.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># source the tiling function:</span></span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/Main/_code/vignette2/utils/readFlatFiles.R"</span>)</span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define new xy positions in which multiple slides no longer overlap each other:</span></span>
<span id="cb5-4">xy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">condenseTissues</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xy =</span> xy, </span>
<span id="cb5-5">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tissue =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Run_Tissue_name, </span>
<span id="cb5-6">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tissueorder =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># optional, specify the order tissues are tiled in</span></span>
<span id="cb5-7">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">buffer =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># space between tissues</span></span>
<span id="cb5-8">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">widthheightratio =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># desired shape of final xy locations </span></span></code></pre></div>
</details>
</div>
<p><strong>Second</strong>, break your cells into spatially contiguous groups (which may be separate tissues from one slide, or merely discontinuous FOV blocks from the same tissue). This can be done manually, as in the below chunk where we select cells in a selected xy range:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># select a group of cells based on cutoffs in xy:</span></span>
<span id="cb6-2">xrange <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.2</span>)</span>
<span id="cb6-3">yrange <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb6-4">thisgroup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ((xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> xrange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> xrange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> </span>
<span id="cb6-5">  ((xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> yrange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> yrange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))</span></code></pre></div>
</details>
</div>
<p>Or, we can automatically group contiguous FOVs using the dbscan algorithm:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># cells within eps range of each other will be grouped together. </span></span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set eps appropriately to link sufficiently close FOVs and separate sufficiently distant FOVs. </span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># An FOV's width is about 1 mm. </span></span>
<span id="cb7-4">cellgroups <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dbscan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbscan</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minPts =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cluster</span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># confirm the grouping is as desired:</span></span>
<span id="cb7-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb7-7">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colors</span>())[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(cellgroups))])</span></code></pre></div>
</details>
</div>
<p><strong>Third</strong>, we rearrange groups. We can move groups manually:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shift a group of cells to the right:</span></span>
<span id="cb8-2">xy[thisgroup, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xy[thisgroup, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># or up:</span></span>
<span id="cb8-4">xy[thisgroup, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xy[thisgroup, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span></code></pre></div>
</details>
</div>
<p>…or we can move them automatically using the same <code>condenseTissues</code> function we used above:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">xy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">condenseTissues</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xy =</span> xy, </span>
<span id="cb9-2">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tissue =</span> cellgroups, </span>
<span id="cb9-3">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tissueorder =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># optional, specify the order tissues are tiled in</span></span>
<span id="cb9-4">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">buffer =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># space between tissues</span></span>
<span id="cb9-5">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">widthheightratio =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># desired shape of final xy locations </span></span></code></pre></div>
</details>
</div>
</section>
<section id="qc" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> QC</h1>
<p>QC of CosMx data is mostly straightforward. Technical effects can be complex, but they manifest in limited ways:</p>
<ul>
<li>Many individual cells can have low signal</li>
<li>Segmentation errors can create “cells” with bad data</li>
<li>Sporadic FOVs can have low signal</li>
<li>Sporadic FOVs can have distorted / outlier expression profiles</li>
</ul>
<p>Our workflow will create then add to <code>flag</code>, a vector marking cells flagged for one reason or another. When we’re done, we’ll delete everything we’ve flagged. (The full original data will remain on AtoMx, so this step is not as drastic as it seems. For smaller studies it could still be reasonable to hold on to the pre-QC .RDS files.)</p>
<section id="per-cell-qc" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="per-cell-qc"><span class="header-section-number">4.1</span> Per-cell QC:</h2>
<p>First, we’ll apply a threshold on cells’ total counts. Our defaults are fairly permissive; it would be reasonable to double them in datasets where you can do so without throwing out too many cells.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># require sufficient counts per cell </span></span>
<span id="cb10-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Log2 counts per cell"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N cells"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb10-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## cut off the low tail: </span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># recommendations:</span></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - 1000plex: 20 (permissive) or 50 (conservative)</span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - 6000plex: 50 (permissive) or 100 (conservative)</span></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - WTX: 100 (permissive) or 200 (conservative)</span></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - all panels: no more than 5% of cells (permissive) or 10% of cells (conservative)</span></span>
<span id="cb10-9">count_threshold <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.10</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># apply threshold, but don't flag &gt;10% of cells</span></span>
<span id="cb10-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(count_threshold), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)</span>
<span id="cb10-11">flag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> count_threshold</span>
<span id="cb10-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topleft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(flag) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"% rejected"</span>))</span>
<span id="cb10-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(flag)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/QC_counts_histogram.png" class="img-fluid figure-img" style="width:115.0%"></p>
</figure>
</div>
</div>
</div>
<p>Next we’ll throw out cells with excessively large areas. In most studies, these “cells” are the result of segmentation errors. This step typically removes very few cells.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># what's the distribution of areas?</span></span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Area, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell Area"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell area (pixels)"</span>)</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># based on the above, set a threshold well out into the tail:</span></span>
<span id="cb11-5">area_threshold <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30000</span></span>
<span id="cb11-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v =</span> area_threshold, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)</span>
<span id="cb11-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Area <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> area_threshold) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"% rejected"</span>))</span>
<span id="cb11-8"></span>
<span id="cb11-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># flag cells based on area:</span></span>
<span id="cb11-10">flag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> flag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Area <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> area_threshold)</span>
<span id="cb11-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(flag)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/QC_area_histogram.png" class="img-fluid figure-img" style="width:115.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note: some tissues do have very large cells, e.g.&nbsp;purkinje cells in the brain or cardiomyocytes in the heart. You’ll likely want to skip the area filter in those studies.</p>
</div>
</div>
<p>To check for segmentation errors, consider our R package <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/segmentation-error-evaluation/" target="_blank">FastReseg</a>, which uses transcript positions to flag cells with likely segmentation errors, then remove or reassign transcripts assigned to the wrong cells. We also advise examining the segmentation results in AtoMx’s tissue viewer; studies will occasionally need to be re-segmented under a different set of parameters.</p>
</section>
<section id="fov-qc" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="fov-qc"><span class="header-section-number">4.2</span> FOV QC</h2>
<p>We check FOVs for two indicators of artifacts: diminished total counts, and biased gene expression profiles. Procedures for both these checks, along with a detailed discussion, can be found in a method described <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/fov-qc/" target="_blank">here</a>.</p>
<p>To summarize briefly: for each “bit” in our barcodes (e.g.&nbsp;red in reporter cycle 8), we look for FOVs where genes using the bit are underexpressed. We also look for FOVs where total expression is suppressed.</p>
<p>Below we’ll run our FOV QC code and examine its results:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## preparing resources:</span></span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># source the FOV QC tool:</span></span>
<span id="cb12-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/Main/_code/FOV%20QC/FOV%20QC%20utils.R"</span>)</span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load necessary information for the QC tool: the gene to barcode map:</span></span>
<span id="cb12-5">allbarcodes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">url</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/raw/Main/_code/FOV%20QC/barcodes_by_panel.RDS"</span>))</span>
<span id="cb12-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(allbarcodes)</span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the barcodes for the panel we want:</span></span>
<span id="cb12-8">barcodemap <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> allbarcodes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Hs_WTX    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;------- choose the right map for your panel</span></span>
<span id="cb12-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(barcodemap)</span>
<span id="cb12-10"></span>
<span id="cb12-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## run the method:</span></span>
<span id="cb12-12">fovqcresult <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runFOVQC</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts =</span> counts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xy =</span> xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fov =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>FOV, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">barcodemap =</span> barcodemap) </span>
<span id="cb12-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(fovqcresult, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/fovqcresult.RDS"</span>))</span>
<span id="cb12-14"></span>
<span id="cb12-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># map of flagged FOVs:</span></span>
<span id="cb12-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mapFlaggedFOVs</span>(fovqcresult)</span>
<span id="cb12-17"></span>
<span id="cb12-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># list FOVs flagged for any reason, for loss of signal, for bias:</span></span>
<span id="cb12-19">fovqcresult<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>flaggedfovs</span>
<span id="cb12-20">fovqcresult<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>flaggedfovs_fortotalcounts</span>
<span id="cb12-21">fovqcresult<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>flaggedfovs_forbias</span>
<span id="cb12-22"></span>
<span id="cb12-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># flag cells in flagged FOVs:</span></span>
<span id="cb12-24">flag[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.element</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>FOV, fovqcresult<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>flaggedfovs)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb12-25"></span>
<span id="cb12-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot the result:</span></span>
<span id="cb12-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FOVSignalLossSpatialPlot</span>(fovqcresult) </span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/QC_FOVQC.png" class="img-fluid figure-img" width="264"></p>
</figure>
</div>
</div>
</div>
<p>We don’t have any flagged FOVs in this study. For examples of studies with more flagged FOVs, see <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/fov-qc/" target="_blank">the FOV QC post</a> and <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis/assets/2.-QC-and-normalization.html" target="_blank">this older vignette</a>. The FOV signal loss plot above does show variation in signal strength, but that variation appears to track spatially smooth biology, likely contours of tumor glands, rather than sharp FOV boundaries.</p>
</section>
<section id="descriptive-qc-plots" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="descriptive-qc-plots"><span class="header-section-number">4.3</span> Descriptive QC plots</h2>
<p>In addition to the above per-cell flags, it can be worth plotting some QC metrics atop the space of your tissues. The purpose of these plots is to become aware of possible technical effects that might explain any artifacts you discover later in analysis. In the vast majority of studies, these plots will not require any action from you.</p>
<p>First, plot total counts over space:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## plot total counts over space:</span></span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb13-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb13-4">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">viridis_pal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>)(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb13-5">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>))</span>
<span id="cb13-6">     ])</span>
<span id="cb13-7">legendvals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>)</span>
<span id="cb13-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottomright"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, </span>
<span id="cb13-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">viridis_pal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>)(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(legendvals) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>))]),</span>
<span id="cb13-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Total counts:"</span>, legendvals))</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/QC_counts_over_xy.png" class="img-fluid figure-img" style="width:115.0%"></p>
</figure>
</div>
</div>
</div>
<p>We see ample variability in total counts over space, but it all appears biological, not technical, with the exception of some FOV edge effects in which cells partially captured at some FOV edges have suppressed counts.</p>
<p>We also like to plot background over space. Because negative control counts are so sparse at the level of single cells, we plot <em>spatially smoothed</em> background, i.e.&nbsp;we color each cell by the mean background over its 50 nearest neighbors. To isolate background tendency from overall signal strength, we also normalize our background (negprobe) counts to each cells’ total RNA counts.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install insitucor:</span></span>
<span id="cb14-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) {</span>
<span id="cb14-3">  devtools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/Nanostring-Biostats/InSituCor"</span>)</span>
<span id="cb14-4">}</span>
<span id="cb14-5"></span>
<span id="cb14-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## plot smoothed background over space:</span></span>
<span id="cb14-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get spatial neighbors:</span></span>
<span id="cb14-8">neighbors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nearestNeighborGraph</span>(xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>slide_ID)  </span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate spatially-smoothed and totalcount-normalized background:</span></span>
<span id="cb14-10">smoothedgbrate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">neighbor_mean</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_negprobes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbors =</span> neighbors)</span>
<span id="cb14-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot:</span></span>
<span id="cb14-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb14-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb14-14">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">viridis_pal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>)(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb14-15">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(smoothedgbrate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(smoothedgbrate, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9995</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb14-16">     ])</span>
<span id="cb14-17">legendvals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(smoothedgbrate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb14-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottomright"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, </span>
<span id="cb14-19">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">viridis_pal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>)(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(legendvals <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(smoothedgbrate, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9995</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)]),</span>
<span id="cb14-20">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Spatially smoothed totalcounts-normalized background:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x median"</span>)))</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/spatial_bgoversignal.png" class="img-fluid figure-img" style="width:115.0%"></p>
</figure>
</div>
</div>
</div>
<p>We see some regions of elevated background. No immediate action is needed, but by becoming aware of these isolated technical effects we’ll be armed to interpret any strange results driven by them. High local background often occurs in regions of necrosis.</p>
<p>Finally, we plot flagged cells in space:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot flagged cells in space:</span></span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb15-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb15-4">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> flag])</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/QC_flaggedcells.png" class="img-fluid figure-img" style="width:115.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can see flagged cells clustered in ducts/vessels/gaps in the tissue. Again, no action is needed, but we should keep this in mind while we interpret results.</p>
</section>
<section id="removing-flagged-cells" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="removing-flagged-cells"><span class="header-section-number">4.4</span> Removing flagged cells</h2>
<p>As our final QC step, we remove flagged cells and save the filtered data for downstream analysis:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># save data with flagged cells removed</span></span>
<span id="cb16-2">counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> counts[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>flag, ]</span>
<span id="cb16-3">metadata <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>flag, ]</span>
<span id="cb16-4">xy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xy[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>flag, ]</span>
<span id="cb16-5"></span>
<span id="cb16-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># save filtered data objects, to be used in the remainder of the analysis</span></span>
<span id="cb16-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(counts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/counts.RDS"</span>))</span>
<span id="cb16-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(metadata, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/metadata.RDS"</span>))</span>
<span id="cb16-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/xy.RDS"</span>))</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="norm" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Normalization</h1>
<p>We typically normalize each cell’s expression profile to its total counts. The below code does this efficiently. In fact, given the size of the matrix and the speed of this calculation, there is no need to save a normalized data object; it’s cheaper to re-compute it than to store it.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normalize counts matrix using efficient sparse matrix calls:</span></span>
<span id="cb17-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (recall our counts matrix has cells in rows and genes in columns)</span></span>
<span id="cb17-3">scale_row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA</span>
<span id="cb17-4">norm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> counts</span>
<span id="cb17-5">norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> scale_row[norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L]</span></code></pre></div>
</details>
</div>
<p>Note that no steps in this workflow actually use the normalized data, although the dimension reduction step performs its own normalization under the hood. Normalized data will be useful in later analyses, e.g.&nbsp;for plotting expression over space or running differential expression.</p>
<p>We do not generally use a log1p transformation. Pearson residuals have nice properties, but they produce a dense matrix, which is too memory-intensive for most studies. (See below for how we nonetheless get PC’s based on Pearson residuals.)</p>
</section>
<section id="dimred" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Dimension reduction</h1>
<p>Here we demonstrate an important improvement in dimension reduction for large studies. The single cell analysis world has long used Pearson residuals to normalize &amp; transform their data prior to running PCA; these residuals scale count data to better balance the information available in each cell / gene. However, Pearson residuals are dense, meaning we cannot encode them with a sparse matrix, making them computationally intractable for larger datasets. To benefit from Pearson residuals without taxing our compute instances, we have developed a method of calculating the principal components of a Pearson residual matrix without ever having to store the entire matrix. A full description is <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca/" target="_blank">here</a>. We demonstrate this function below.</p>
<p>We’ll start by identifying highly variable genes. In this section we’ll take advantage of some of the functions in the Seurat ecosystem.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make a seurat object:</span></span>
<span id="cb18-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(Seurat)</span>
<span id="cb18-3">seu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CreateSeuratObject</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(counts),</span>
<span id="cb18-4">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta.data =</span> metadata)</span>
<span id="cb18-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find HVG's:</span></span>
<span id="cb18-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># recommend nfeatures = 3000 for WTX, 2000 for 6k panel, and using all features for 1k panels</span></span>
<span id="cb18-7">seu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindVariableFeatures</span>(seu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nfeatures =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span>) </span>
<span id="cb18-8">hvgs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(seu<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>assays<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>RNA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>var.features, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb18-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(hvgs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/hvgs.RDS"</span>))</span></code></pre></div>
</details>
</div>
<p>Next we run our Pearson residual-based PCA algorithm. You can install it with this command:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install the sparse pearson PCA package:</span></span>
<span id="cb19-2">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nanostring-Biostats/CosMx-Analysis-Scratch-Space"</span>,</span>
<span id="cb19-3">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subdir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_code/scPearsonPCA"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Main"</span>)</span></code></pre></div>
</details>
</div>
<p>The algorithm runs in two versions: standard, and batch-aware. The batch-aware version allows for gene frequencies that vary across some categorical batch variable like tissue or slide.</p>
<p>Note the code saving the output. This lets us re-run the script without waiting for long algorithms to reprocess. However, this particular routine runs fast enough, and generates a large enough data object, that it would also be reasonable to recalculate rather than store its output.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true">Standard mode</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false">Batch-aware mode</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## get PCs based on Pearson residuals:</span></span>
<span id="cb20-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># version without batch adjustment:</span></span>
<span id="cb20-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb20-4">  genefreq <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gene_frequency</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(counts)) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## gene frequency (across all cells)</span></span>
<span id="cb20-5">  pcaobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_quasipoisson_pca_seurat</span>(</span>
<span id="cb20-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(counts[, hvgs]),</span>
<span id="cb20-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA,</span>
<span id="cb20-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grate =</span> genefreq[hvgs],</span>
<span id="cb20-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale.max =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## PC's reflect clipping pearson residuals &gt; 10 SDs above the mean pearson residual</span></span>
<span id="cb20-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.scale =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## PC's reflect as if pearson residuals for each gene were scaled to have standard deviation=1</span></span>
<span id="cb20-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.center =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## PC's reflect as if pearson residuals for each gene were centered to have mean=0</span></span>
<span id="cb20-12">  )</span>
<span id="cb20-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(pcaobj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/pcaobj.RDS"</span>))</span>
<span id="cb20-14">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb20-15">  pcaobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/pcaobj.RDS"</span>))</span>
<span id="cb20-16">}</span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># In this example code we assume the metadata has a column "patient" that we wish to treat as a possible batch effect</span></span>
<span id="cb21-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb21-3">  genefreq_batch <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gene_frequency</span>(</span>
<span id="cb21-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(counts),</span>
<span id="cb21-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obs =</span> metadata[,.(cell_id, patient)],</span>
<span id="cb21-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_id"</span>,</span>
<span id="cb21-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">batch_variable =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"patient"</span>)</span>
<span id="cb21-8">  </span>
<span id="cb21-9">  pcaobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb21-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_quasipoisson_pca_seurat_batch</span>(</span>
<span id="cb21-11">      Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(counts[, hvgs]),</span>
<span id="cb21-12">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA,</span>
<span id="cb21-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grate =</span> genefreq_batch[hvgs,],</span>
<span id="cb21-14">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obs =</span> metadata[,.(cell_id, patient)],</span>
<span id="cb21-15">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">batch_variable =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"patient"</span>,</span>
<span id="cb21-16">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_id"</span>,</span>
<span id="cb21-17">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale.max =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb21-18">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.scale =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb21-19">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.center =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb21-20">    )</span>
<span id="cb21-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(pcaobj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/pcaobj.RDS"</span>))</span>
<span id="cb21-22">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb21-23">  pcaobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/pcaobj.RDS"</span>))</span>
<span id="cb21-24">}</span></code></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>Next we’ll obtain a UMAP projection from those PCs:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## run UMAP:</span></span>
<span id="cb22-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb22-3">  umapobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_umap</span>(pcaobj)</span>
<span id="cb22-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># save the full object: the umap connectivity graph will be useful later on:</span></span>
<span id="cb22-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(umapobj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/umapobj.RDS"</span>))</span>
<span id="cb22-6">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb22-7">  umapobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/umapobj.RDS"</span>))</span>
<span id="cb22-8">}</span>
<span id="cb22-9"></span>
<span id="cb22-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## plot the UMAP projection, coloring by total counts:</span></span>
<span id="cb22-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb22-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(umapobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ump<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb22-13">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">viridis_pal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>)(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb22-14">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>))</span>
<span id="cb22-15">     ], <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>))</span>
<span id="cb22-16">legendvals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>)</span>
<span id="cb22-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topleft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, </span>
<span id="cb22-18">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">viridis_pal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>)(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(legendvals) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>))]),</span>
<span id="cb22-19">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Total counts:"</span>, legendvals))</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/umap_totalcounts.png" class="img-fluid figure-img" style="width:85.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cell-typing" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Cell typing</h1>
<section id="unsupervised-clustering" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="unsupervised-clustering"><span class="header-section-number">7.1</span> Unsupervised clustering</h2>
<p>Here we demonstrate the most consistently successful approach to cell typing we have found. (Supervised cell typing with InSituType can also work quite well, but depends on a good reference marix.) First, we perform unsupervised clustering using a set of a few thousand highly variable genes (hvg’s). Second, we use the HieraType algorithm to obtain accurate immune cell classification, then overwrite our initial clustering results with HieraType’s calls wherever it finds immune cells. This approach is robust, and requires minimal configuration and re-running. Naming clusters used to be time-consuming, but we have found that the right prompts to a large language model (LLM), <em>combined with rigorous oversight</em>, minimize the burden of cluster naming. We will demonstrate two approaches to unsupervised clustering:</p>
<ul>
<li>Louvain clustering, using PC’s derived from Pearson residuals of hvg’s.</li>
<li>InSituType’s unsupervised mode, run on hvg’s.</li>
</ul>
<p>Of the above two methods, Louvain tends to be faster, while InSituType is easier to refine, and, more importantly, straightforward to project onto future datasets. (InSituType clusters come with mean expression profiles which can be used as input to InSituType’s supervised cell typing mode.)</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true">Louvain clustering</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false">Clustering with InSituType</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<p><strong>Note:</strong> Here we run louvain clustering with a high resolution, intentionally over-clustering with the plan to condense afterwards. It’s often better to run with the default resolution (0.8) at first, then subcluster selected cell types afterwards. To sub-cluster a cell type, first filter out genes for which segmentation errors are likely to bias its profiles. Use <code>smiDE::overlap_ratio_metric</code> to do so. (smiDE is available on the scratch space.)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use Seurat to run Louvain clustering on the graph from our umap object</span></span>
<span id="cb23-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb23-3">  seu[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsongraph"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Graph</span>(umapobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grph) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## nearest neighbors / adjacency matrix used for unsupervised clustering</span></span>
<span id="cb23-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb23-5">  seu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindClusters</span>(seu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">graph =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsongraph"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resolution =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># choosing a high resolution with the plan to condense afterwards</span></span>
<span id="cb23-6">  clust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> seu<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seurat_clusters</span>
<span id="cb23-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(clust, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/clust.RDS"</span>))</span>
<span id="cb23-8">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb23-9">  clust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/clust.RDS"</span>))</span>
<span id="cb23-10">}</span>
<span id="cb23-11"></span>
<span id="cb23-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># save to metadata</span></span>
<span id="cb23-13">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> clust</span>
<span id="cb23-14"></span>
<span id="cb23-15">cellcols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb23-16">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E41A1C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#377EB8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#4DAF4A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#984EA3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF7F00"</span>,</span>
<span id="cb23-17">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A65628"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F781BF"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#999999"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#66C2A5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FC8D62"</span>,</span>
<span id="cb23-18">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#8DA0CB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E78AC3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A6D854"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFD92F"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E5C494"</span>,</span>
<span id="cb23-19">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B3B3B3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1B9E77"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#D95F02"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#7570B3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E7298A"</span>,</span>
<span id="cb23-20">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#66A61E"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E6AB02"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A6761D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#666666"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A6CEE3"</span>,</span>
<span id="cb23-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1F78B4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B2DF8A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#33A02C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FB9A99"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E31A1C"</span>,</span>
<span id="cb23-22">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FDBF6F"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF7F00"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#CAB2D6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#6A3D9A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFFF99"</span>,</span>
<span id="cb23-23">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B15928"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#8DD3C7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFFFB3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#BEBADA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FB8072"</span></span>
<span id="cb23-24">), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(clust))]</span>
<span id="cb23-25"></span>
<span id="cb23-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Quick xy and umap plots of clusters to confirm resolution looks right:</span></span>
<span id="cb23-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(umapobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ump<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb23-28">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(cellcols[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(clust))], <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>))</span>
<span id="cb23-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb23-30">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> cellcols[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(clust))])</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/umap_louvain.png" class="img-fluid figure-img" width="312"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/cluster_xy_1stlook.png" class="img-fluid figure-img" width="464"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<p>Here we refer you to the <a href="https://github.com/Nanostring-Biostats/InSituType/blob/main/vignettes/NSCLC-RNA_InsituType-vignette.Rmd" target="_blank">InSituType vignette</a>. Running in unsupervised mode is simplest, though supervised and semi-supervised modes can work well provided with good reference profiles.</p>
<p>A call to InSituType that would work with our setup here is:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb24-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb24-3">  unsup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">insitutype</span>(</span>
<span id="cb24-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> counts[, hvgs],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only use HVG's. InSituType's computation time scales with the number of genes, so analyzing the full WTX panel is very slow. </span></span>
<span id="cb24-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neg =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>negmean,</span>
<span id="cb24-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assay_type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>, </span>
<span id="cb24-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reference_profiles =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb24-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reference_sds =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb24-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cohort =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># see the InSituType docs for how to use this argument to incorporate spatial information into clustering</span></span>
<span id="cb24-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_clusts =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,</span>
<span id="cb24-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_starts =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb24-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_iters =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span></span>
<span id="cb24-13">  ) </span>
<span id="cb24-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(unsup, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/unsup.RDS"</span>))</span>
<span id="cb24-15">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb24-16">  unsup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/unsup.RDS"</span>))</span>
<span id="cb24-17">}</span>
<span id="cb24-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># save results</span></span>
<span id="cb24-19">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> clust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> unsup<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clust</span>
<span id="cb24-20"></span>
<span id="cb24-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Quick xy and umap plots of clusters to confirm resolution looks right:</span></span>
<span id="cb24-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(umapobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ump<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb24-23">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(cellcols[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(clust))], <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>))</span>
<span id="cb24-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb24-25">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> cellcols[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(clust))])</span></code></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="naming" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="naming"><span class="header-section-number">7.2</span> Naming clusters</h2>
<p>Determining which cell type a cluster corresponds to is a complex exercise that should take into account:</p>
<ul>
<li>The cluster’s marker genes</li>
<li>Its overall abundance</li>
<li>Its spatial locations</li>
</ul>
<p>This can be onerous, but we can get a big jump start on this work by using large language models (LLM’s). Below, we’ll create a custom prompt asking a LLM to name your cluster. We have found LLM’s to do a very good (<strong>though not perfect</strong>) job of naming cell types given this information. After this step we’ll show how to QC your cell type assignments.</p>
<p>As a first step, we’ll derive marker genes for our clusters:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb25-2">  markers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics</span>(</span>
<span id="cb25-3">    Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(counts),</span>
<span id="cb25-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> metadata,</span>
<span id="cb25-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clust"</span>,</span>
<span id="cb25-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_id"</span>)</span>
<span id="cb25-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(markers, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processed_data/markers.RDS"</span>)</span>
<span id="cb25-8">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb25-9">  markers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processed_data/markers.RDS"</span>)</span>
<span id="cb25-10">}</span>
<span id="cb25-11"></span>
<span id="cb25-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get a more succinct list of markers: only the top N per cell type:</span></span>
<span id="cb25-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prioritize by fold change, but penalize low-expressers:</span></span>
<span id="cb25-14">markers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>prioritystat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (markers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cluster_expr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (markers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clusterprime_expr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>)</span>
<span id="cb25-15">markersshort <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>()</span>
<span id="cb25-16">nperclust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb25-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(markers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cluster)) {</span>
<span id="cb25-18">  inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> markers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cluster <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> name</span>
<span id="cb25-19">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(inds) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb25-20">    markersshort <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(markersshort,</span>
<span id="cb25-21">                      markers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene[inds][<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(markers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>prioritystat[inds], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decreasing =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(nperclust, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(inds))]])</span>
<span id="cb25-22">  }</span>
<span id="cb25-23">}</span></code></pre></div>
</details>
</div>
<p>In addition to data-derived marker genes, we’ll also look at a pre-defined list of well-known markers of broad cell types and lineages.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load general-purpose lineage and marker genes:</span></span>
<span id="cb26-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/Main/_code/vignette2/lineage_and_marker_genes.R"</span>)</span>
<span id="cb26-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (loads the list "lineagegenes")</span></span>
<span id="cb26-4"></span>
<span id="cb26-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># save both selected markers and lineage genes:</span></span>
<span id="cb26-6">allusefulmarkers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(counts), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(lineagegenes), markersshort)))</span></code></pre></div>
</details>
</div>
<p>Now that we have marker genes identified, we can proceed to crafting an LLM prompt:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## describe your tissue here. </span></span>
<span id="cb27-2">mytissuetype <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HER2+ breast cancer"</span></span>
<span id="cb27-3"></span>
<span id="cb27-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the preamble:</span></span>
<span id="cb27-5">prompt_preamble <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(</span>
<span id="cb27-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Please propose cell type names for the clusters I</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ve found in a CosMx study. This is data from a "</span>, mytissuetype, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">". "</span>,</span>
<span id="cb27-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Below are two tables. The first is each cell type</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">s abundance in the dataset. "</span>,</span>
<span id="cb27-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The second is a table of mean expression levels of various marker genes and lineage-defining genes in each cluster. "</span>,</span>
<span id="cb27-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"It</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">s possible that some clusters could be closely-related cell types, or distinct states of the same cell type. Call that out when it</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">s apparent. "</span>,</span>
<span id="cb27-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"For each cluster, give me your best guess at its identity, and give me your justification. Let me know when you</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">re uncertain. "</span>,</span>
<span id="cb27-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Then, give me R code defining a named vector called </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">cluster_labels</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> in which my cluster IDs are the names and the values are your proposed cell types. "</span>,</span>
<span id="cb27-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Don</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">t hallucinate, and check your work three times. "</span>)</span>
<span id="cb27-13"></span>
<span id="cb27-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># info on cluster frequencies:</span></span>
<span id="cb27-15">prompt_frequencies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(</span>
<span id="cb27-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb27-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">The cluster frequencies are: "</span>, </span>
<span id="cb27-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cluster "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(clust)), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">":"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(clust)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>))</span>
<span id="cb27-19"></span>
<span id="cb27-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## give the LLM each cluster's mean expression profile over relevant genes:</span></span>
<span id="cb27-21"></span>
<span id="cb27-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># obtain a matrix of the clusters' marker gene profiles:</span></span>
<span id="cb27-23">allusefulmarkers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(counts), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(lineagegenes), markersshort)))</span>
<span id="cb27-24">meanexpression <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> markers[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcast</span>(.SD, gene <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> cluster, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value.var =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cluster_expr"</span>)]</span>
<span id="cb27-25">meanexpression <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(meanexpression[, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># drop gene col</span></span>
<span id="cb27-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(meanexpression) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> markers[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(gene)]</span>
<span id="cb27-27">meanexpression <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meanexpression[allusefulmarkers, ]</span>
<span id="cb27-28"></span>
<span id="cb27-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reduce to just lineage genes with decent expression (but keep de novo markers):</span></span>
<span id="cb27-30">isdenovo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.element</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(meanexpression), markersshort)</span>
<span id="cb27-31">meanexpression <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meanexpression[isdenovo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(meanexpression, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, max) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, ]</span>
<span id="cb27-32"></span>
<span id="cb27-33">prompt_profiles <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(</span>
<span id="cb27-34">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"And here is a table of each cluster's mean expression of selected data- and biology-derived marker genes: "</span>,</span>
<span id="cb27-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture.output</span>(</span>
<span id="cb27-36">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write.table</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(meanexpression, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb27-37">  ), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>))</span>
<span id="cb27-38"></span>
<span id="cb27-39"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(prompt_preamble, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, prompt_frequencies, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, prompt_profiles))</span>
<span id="cb27-40"></span>
<span id="cb27-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># save old results for rewriting later on:</span></span>
<span id="cb27-42">unnamedclust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> clust</span>
<span id="cb27-43">unnamedmeanexpression <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meanexpression</span></code></pre></div>
</details>
</div>
<p>This creates the below prompt, which can be copied into whichever LLM you prefer:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/LLMprompt.png" class="img-fluid figure-img" style="width:120.0%"></p>
</figure>
</div>
</div>
</div>
<p>When this prompt was passed to ChatGPT5, it produced a writeup that looked like this:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/LLMresponse.png" class="img-fluid figure-img" style="width:110.0%"></p>
</figure>
</div>
</div>
</div>
<p>… and more importantly, the below code ready to be copy-pasted into our analysis:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">cluster_labels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb28-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0"</span>  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Luminal epithelial (low-RNA/quiescent)"</span>,</span>
<span id="cb28-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Neutrophils (state C, degranulating/secretory-high)"</span>,</span>
<span id="cb28-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span>  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T cells (CD4-like, resting)"</span>,</span>
<span id="cb28-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3"</span>  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IFN-high epithelial (luminal, inflamed)"</span>,</span>
<span id="cb28-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4"</span>  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Luminal epithelial (apocrine-leaning; state A)"</span>,</span>
<span id="cb28-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5"</span>  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CAFs (matrix-rich fibroblasts)"</span>,</span>
<span id="cb28-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6"</span>  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Antigen-presenting myeloid (cDC2 / moDC)"</span>,</span>
<span id="cb28-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"7"</span>  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Luminal epithelial (apocrine-high; state B)"</span>,</span>
<span id="cb28-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8"</span>  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Luminal epithelial (apocrine-high; state C)"</span>,</span>
<span id="cb28-11">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"9"</span>  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Neutrophils (state B)"</span>,</span>
<span id="cb28-12">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"10"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Luminal epithelial (apocrine-secretory)"</span>,</span>
<span id="cb28-13">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"11"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Luminal epithelial (apocrine-high; state D)"</span>,</span>
<span id="cb28-14">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"12"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Luminal epithelial (apocrine-very-high; state E)"</span>,</span>
<span id="cb28-15">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"13"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Macrophages (APOE+/C1QA+ TAMs)"</span>,</span>
<span id="cb28-16">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"14"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Neutrophils (state A; S100A8/A9-max)"</span>,</span>
<span id="cb28-17">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"15"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epithelial–neutrophil admixture (uncertain)"</span>,</span>
<span id="cb28-18">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"16"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CAFs (cycling)"</span>,</span>
<span id="cb28-19">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"17"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Endothelial (blood/lymphatic mix)"</span>,</span>
<span id="cb28-20">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"18"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Inflamed epithelial with myeloid shadow (uncertain)"</span>,</span>
<span id="cb28-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"19"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pericytes / vascular SMC"</span>,</span>
<span id="cb28-22">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"20"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Luminal epithelial (mucociliary-like secretory)"</span>,</span>
<span id="cb28-23">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"21"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cycling epithelial"</span>,</span>
<span id="cb28-24">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"22"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Luminal epithelial (baseline state)"</span>,</span>
<span id="cb28-25">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"23"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IFN-high epithelial (luminal, inflamed)"</span>,</span>
<span id="cb28-26">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"24"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Luminal epithelial (mucociliary-like secretory)"</span>,</span>
<span id="cb28-27">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"25"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Plasma cells"</span>,</span>
<span id="cb28-28">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"26"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Antigen-presenting cells (B/cDC; cycling, uncertain)"</span>,</span>
<span id="cb28-29">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"27"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cytotoxic T / NK cells"</span></span>
<span id="cb28-30">)</span>
<span id="cb28-31"></span>
<span id="cb28-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for now, just uncritically take the names. Clustering QC and possible renaming will come later.</span></span>
<span id="cb28-33">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> clust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cluster_labels[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(unnamedclust)]</span>
<span id="cb28-34"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(meanexpression) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cluster_labels[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cluster"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(unnamedmeanexpression)))]</span></code></pre></div>
</details>
</div>
</section>
<section id="clustqc" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="clustqc"><span class="header-section-number">7.3</span> QC of clustering results</h2>
<p>The LLM gave us a good guess at cluster names, but we still need to verify them. To assist in this process, we recommend looking at 4 outputs:</p>
<ol type="1">
<li>The LLM’s justifications for its calls</li>
<li>A heatmap of each cluster’s expression of key marker genes</li>
<li>The clusters’ distributions in space.</li>
<li>The clusters’ UMAP positions</li>
</ol>
<p>The code below draws the key plots:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># heatmap of marker genes - drawn tall so we can read all gene names:</span></span>
<span id="cb29-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dev.off</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to silence the current graphics device for a pheatmap pdf to render properly</span></span>
<span id="cb29-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pdf</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/results/marker heatmap tall.pdf"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb29-4">pheatmap<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pheatmap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sweep</span>(meanexpression, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(meanexpression, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, max)), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>),</span>
<span id="cb29-5">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>),</span>
<span id="cb29-6">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize_row =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb29-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dev.off</span>()</span>
<span id="cb29-8"></span>
<span id="cb29-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># umap positions</span></span>
<span id="cb29-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">png</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"results/umap_by_cluster.png"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">res =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>)</span>
<span id="cb29-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb29-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(umapobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ump<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb29-13">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(cellcols[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(clust))], <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>))</span>
<span id="cb29-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topleft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(clust)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> cellcols[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(clust)))])</span>
<span id="cb29-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dev.off</span>()</span>
<span id="cb29-16">  </span>
<span id="cb29-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># xy positions:</span></span>
<span id="cb29-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(clust)) {</span>
<span id="cb29-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">png</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"results/cluster xy - "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make.names</span>(name), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>), </span>
<span id="cb29-20">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, </span>
<span id="cb29-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb29-22">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">res =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">350</span>)</span>
<span id="cb29-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb29-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb29-25">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(cellcols, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(clust))], </span>
<span id="cb29-26">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xaxt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yaxt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>)</span>
<span id="cb29-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[clust <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> name, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb29-28">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)</span>
<span id="cb29-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bty =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>)</span>
<span id="cb29-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dev.off</span>()</span>
<span id="cb29-31">}</span></code></pre></div>
</details>
</div>
<p>We obtain:</p>
<p>A .pdf heatmap of marker gene expression, stretched out to allow for scrutinizing gene names (not legible zoomed-out; meant to be explored via zooming and scrolling):</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/tallheatmapsnippet.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>A .png showing each cluster in umap space, giving you another look at which clusters are similar to each other:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/umapbyclustersnippet.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</div>
</div>
<p>A .png for each cluster showing its positions in xy space (bold black points atop faded points for other clusters):</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/cluster_xy_snippet.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<p>With these plots in hand, you should scrutinize the initial cluster names and correct as needed. Note that you can gloss over immune clusters: we’ll be overriding them later with the HieraType algorithm’s results.</p>
<p>To rename clusters, simply edit the cluster names in the definition of <code>cluster_labels</code> above, and re-run from that code block onward. This step can also be used to merge closely-related clusters by assigning multiple clusters the same name. In our case, we renamed three clusters of cancer cells that the LLM labeled as neutrophils (some of the classic neutrophil markers are also expressed by cancer cells).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For tumor studies, additional techniques can help classify cancer cells:</p>
<ol type="1">
<li>Cancer cells tend to be extremely transcriptionally active. Clusters with high total counts per cell are usually cancer.</li>
<li>The <a href="https://github.com/Jonyyqn/scMalignantFinder" target="_blank">scMalignantFinder algorithm</a> promises to call cells as cancer vs.&nbsp;non-cancer. We have not tried it, but it seems promising.</li>
<li>For WTX studies, it’s possible to estimate cells’ copy number variants. Cells with clear CNV’s will usually be cancer. We have used <a href="https://github.com/Moldia/InSituCNV" target="_blank">insituCNV</a> successfully. A newer method, <a href="https://github.com/seasoncloud/Clonalscope" target="_blank">ClonalScope</a>, also looks promising.</li>
</ol>
</div>
</div>
</section>
</section>
<section id="hieratype" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Optimizing immune cell calling with the HieraType algorithm</h1>
<section id="hieratyperun" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="hieratyperun"><span class="header-section-number">8.1</span> Running HieraType</h2>
<p>We created the <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/" target="_blank">HieraType algorithm</a> to classify immune cells in a way that is informed by marker genes. We have found it to consistently outperform other algorithms in immune cell typing. Our standard approach now is to overwrite our initial clustering results with HieraType’s results whenever it calls an immune cell.</p>
<p><strong>An important caveat:</strong> the HieraType workflow below was designed for solid tissues containing the typical infiltrating immune cell classes, i.e.&nbsp;everything you might expect to find in a solid tumor. For tissues with specialized immune cell types, e.g.&nbsp;progenitor cells, or immune-derived cancer cells, HieraType could still run but would need modifications to its marker genes / “pipeline” data object. See the <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/HieraType" target="_blank">HieraType package</a> for a deeper read before setting that up.</p>
<p>Below, we run HieraType in two steps. In the first, we call broad cell types (e.g.&nbsp;epithelial, immune, …) then subclassify the immune cells (B, T, macrophage…)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### set up HieraType pipeline:</span></span>
<span id="cb30-2">pipeline_io_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_pipeline</span>(</span>
<span id="cb30-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">markerslists =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb30-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l1"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_l1</span>
<span id="cb30-5">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_immune</span>
<span id="cb30-6">  )</span>
<span id="cb30-7">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb30-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l1"</span></span>
<span id="cb30-9">  )</span>
<span id="cb30-10">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors_category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb30-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"immune"</span></span>
<span id="cb30-12">  )</span>
<span id="cb30-13">)</span>
<span id="cb30-14"></span>
<span id="cb30-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb30-16">  hieratyperes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_pipeline</span>(</span>
<span id="cb30-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pipeline =</span> pipeline_io_rna,</span>
<span id="cb30-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> counts,</span>
<span id="cb30-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA,</span>
<span id="cb30-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> umapobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grph[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(counts), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(counts)]</span>
<span id="cb30-21">  )</span>
<span id="cb30-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(hieratyperes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processed_data/hieratyperes.RDS"</span>)</span>
<span id="cb30-23">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb30-24">  hieratyperes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processed_data/hieratyperes.RDS"</span>)</span>
<span id="cb30-25">}</span>
<span id="cb30-26"></span>
<span id="cb30-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># further subclassify T-cells:</span></span>
<span id="cb30-28">tcell_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hieratyperes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l1[celltype_granular<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tcell"</span>][[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span>]]</span>
<span id="cb30-29"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb30-30">  tcell_typing <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb30-31">    HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_pipeline</span>(</span>
<span id="cb30-32">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pipeline =</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>pipeline_tcell,</span>
<span id="cb30-33">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> counts[tcell_ids, ],</span>
<span id="cb30-34">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA,</span>
<span id="cb30-35">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> umapobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grph[tcell_ids, tcell_ids],</span>
<span id="cb30-36">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">celltype_call_threshold =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb30-37">    )</span>
<span id="cb30-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(tcell_typing, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processed_data/tcell_typing.RDS"</span>)</span>
<span id="cb30-39">} <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb30-40">  tcell_typing <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processed_data/tcell_typing.RDS"</span>)</span>
<span id="cb30-41">}</span>
<span id="cb30-42"></span>
<span id="cb30-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unify the two levels of hieratype results:</span></span>
<span id="cb30-44">htclust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hieratyperes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_granular</span>
<span id="cb30-45"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(htclust) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hieratyperes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_ID</span>
<span id="cb30-46">htclust[tcell_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmajor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_ID] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tcell_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmajor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_granular</span>
<span id="cb30-47">htclust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> htclust[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_id, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(htclust))]</span>
<span id="cb30-48">metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hieratype_call <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> htclust</span></code></pre></div>
</details>
</div>
<p>Now we’ll use a simple marker heatmap to confirm HieraType worked as hoped:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pull out canonical ("index") markers:</span></span>
<span id="cb31-2">indexmarkers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb31-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(pipeline_io_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>markerslists<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l2)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index_marker"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(pipeline_io_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>markerslists<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l2)))],</span>
<span id="cb31-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>pipeline_tcell)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index_marker"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>pipeline_tcell)))]</span>
<span id="cb31-5">))</span>
<span id="cb31-6"></span>
<span id="cb31-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make a marker heatmap for the hieratype immune cell calls:</span></span>
<span id="cb31-8">fcmetrics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics</span>(</span>
<span id="cb31-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normed  =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(norm[, indexmarkers]),</span>
<span id="cb31-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(htclust), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hieratype_call"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> htclust),</span>
<span id="cb31-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hieratype_call"</span></span>
<span id="cb31-12">)</span>
<span id="cb31-13">hm_hier <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_heatmap</span>(fcmetrics, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extras =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span>
<span id="cb31-14"></span>
<span id="cb31-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(hm_hier)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/hieratype_marker_heatmap.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<p>The above heatmap doesn’t show the strongest markers; it shows the most biologically-relevant markers. We can gain further confidence in our immune cell typing results looking at data-driven markers:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">fctbl_unsup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb32-2">  HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normed  =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(norm),</span>
<span id="cb32-3">                                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(htclust), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hieratype_call"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> htclust),</span>
<span id="cb32-4">                                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hieratype_call"</span></span>
<span id="cb32-5">  )</span>
<span id="cb32-6"></span>
<span id="cb32-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## make a marker heatmap</span></span>
<span id="cb32-8">hm_unsup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_heatmap</span>(fctbl_unsup)</span>
<span id="cb32-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(hm_unsup)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/hieratype_marker_heatmap2.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="hieratypemerge" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="hieratypemerge"><span class="header-section-number">8.2</span> Merging clustering and HieraType results</h2>
<p>To finish our cell typing exercise, we now merge the Louvain and HieraType results. All cells called immune by HieraType will get HieraType labels. All other cells will retain their old labels, with one important exception: clusters that were overwhelmingly called immune by HieraType will be removed, and their cells will be assigned to whatever consensus cell type is most abundant in its nearest neighbors in expression space.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## merge w existing clusters:</span></span>
<span id="cb33-2">merged <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">celltype_label_integration</span>(</span>
<span id="cb33-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> metadata,</span>
<span id="cb33-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_mat =</span> umapobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grph,</span>
<span id="cb33-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_id"</span>,</span>
<span id="cb33-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unsupervised_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clust"</span>,</span>
<span id="cb33-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">supervised_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hieratype_call"</span>,</span>
<span id="cb33-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">supervised_labels_keep =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_immune)</span>
<span id="cb33-9">                                   ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_tcellmajor)</span>
<span id="cb33-10">                                   ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd4tminor)</span>
<span id="cb33-11">                                   ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd8tminor))</span>
<span id="cb33-12">  ),</span>
<span id="cb33-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dissolve_smallcluster_if_overwritten_prop_greaterthan =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>),</span>
<span id="cb33-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">and_dissolve_smallcluster_if_finalcluster_prop_lessthan =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb33-15">)</span>
<span id="cb33-16"></span>
<span id="cb33-17">celltype <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> merged<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_id, merged<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_id)]</span>
<span id="cb33-18"></span>
<span id="cb33-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># celltype[is.element(celltype, louvain_immune_names)] &lt;- "immune_unspecified"</span></span>
<span id="cb33-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(celltype, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/celltype.RDS"</span>))</span>
<span id="cb33-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(metadata, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/metadata.RDS"</span>))</span></code></pre></div>
</details>
</div>
<p>Once our cell types are complete, we re-generate the spatial plots:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># xy positions:</span></span>
<span id="cb34-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(celltype)) {</span>
<span id="cb34-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">png</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"results/celltype xy - "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make.names</span>(name), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>), </span>
<span id="cb34-4">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, </span>
<span id="cb34-5">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb34-6">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">unit =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">res =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">350</span>)</span>
<span id="cb34-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb34-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb34-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(cellcols, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(celltype))], </span>
<span id="cb34-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xaxt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yaxt =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>)</span>
<span id="cb34-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> name, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb34-12">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)</span>
<span id="cb34-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bty =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>)</span>
<span id="cb34-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dev.off</span>()</span>
<span id="cb34-15">}</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="conclusion" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Conclusion</h1>
<p>The code above provides a direct path through the basic preprocessing of CosMx data. With these results secured, you’re ready to proceed to the rewarding parts of data analysis: exploring your data and testing hypotheses. The next pages of this vignette discuss those topics. For exploratory analysis, differential expression, or any other further analysis, we recommend containing distinct analyses in standalone scripts, each beginning by loading the data we’ve prepared here:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load basic data:</span></span>
<span id="cb35-2">counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/counts.RDS"</span>))</span>
<span id="cb35-3">metadata <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/metadata.RDS"</span>))</span>
<span id="cb35-4">xy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(outdir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/processed_data/xy.RDS"</span>))</span>
<span id="cb35-5"></span>
<span id="cb35-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get normalized data if desired:</span></span>
<span id="cb35-7">scale_row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA</span>
<span id="cb35-8">norm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> counts</span>
<span id="cb35-9">norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> scale_row[norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L]</span>
<span id="cb35-10"></span>
<span id="cb35-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># likely to be useful: compute nearest neighbors:</span></span>
<span id="cb35-12">neighbors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nearestNeighborGraph</span>(xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>slide_ID)  </span></code></pre></div>
</details>
</div>


</section>

 ]]></description>
  <category>recommended</category>
  <category>quality control</category>
  <category>cell typing</category>
  <category>normalization</category>
  <category>overview</category>
  <category>how-tos</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/01_preprocessing.html</guid>
  <pubDate>Mon, 22 Dec 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/vignette-basic-analysis-updated/figures/DAPI-blue.png" medium="image" type="image/png" height="145" width="144"/>
</item>
<item>
  <title>CosMx® Multiomics: Deriving an expression matrix from aligned CosMx RNA data</title>
  <dc:creator>Claire Williams</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/aligned_rna_exp_matrix/</link>
  <description><![CDATA[ 





<section id="cosmx-smi-aligned-rna-to-expression-matrix" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> CosMx<sup>®</sup> SMI Aligned RNA to Expression matrix</h1>
<p>When running a multiomic CosMx<sup>®</sup> SMI experiment, RNA data must be aligned to protein data as described in the post <a href="../../posts/multiomics-alignment/index.html">here</a>. This alignment generates new transcript location files for each FOV in a folder with the suffix <code>_Shifted</code>, as shown in panel (b) of the screenshot below (Figure&nbsp;1).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-align-screenshot" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-align-screenshot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/aligned_rna_exp_matrix/figures/Figure6.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-align-screenshot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Output of RNA alignment to protein data
</figcaption>
</figure>
</div>
</div>
</div>
<p>For downstream analysis, it’s common to create an expression matrix that captures gene expression for every cell on the slide. This brief post includes <code>R</code> code demonstrating how to extract transcripts for each cell and combine them into a single sparse matrix. After loading the three indicated libraries and the three functions, the key function is <code>load_aligned_RNA_to_expMat</code>. The resulting matrices, one for endogenous targets and another for Negative Probes, can be used directly or converted into a convenient format, such as a Seurat object with the function <code>CreateSeuratObject</code>, for further processing.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Load required libraries ----</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fast file reading and data manipulation</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(Matrix)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sparse matrix operations</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(future.apply)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parallel processing</span></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Helper: Pad a sparse matrix to full gene/cell dimensions ----</span></span>
<span id="cb1-7">pad_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(mat, all_genes, all_cells) {</span>
<span id="cb1-8">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(all_genes), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(all_cells), </span>
<span id="cb1-9">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sparse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb1-10">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dimnames =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(all_genes, all_cells))</span>
<span id="cb1-11">  out[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(mat), all_genes), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(mat), all_cells)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mat</span>
<span id="cb1-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(out)</span>
<span id="cb1-13">}</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Helper: Load one target file into sparse matrices ----</span></span>
<span id="cb1-16">load_to_exp_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(target_file, slide_number) {</span>
<span id="cb1-17">  calls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(target_file, </span>
<span id="cb1-18">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">select =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CellId"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fov"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"codeclass"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"target"</span>))</span>
<span id="cb1-19">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(calls) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Endogenous =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Negative =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>))</span>
<span id="cb1-20">  </span>
<span id="cb1-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get gene sets BEFORE filtering CellId == 0</span></span>
<span id="cb1-22">  all_endogenous <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(calls[codeclass <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Endogenous"</span>, target])</span>
<span id="cb1-23">  all_negative <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(</span>
<span id="cb1-24">    calls[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Neg"</span>, codeclass, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ignore.case =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>), target])</span>
<span id="cb1-25">  </span>
<span id="cb1-26">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove extracellular transcripts</span></span>
<span id="cb1-27">  calls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> calls[CellId <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb1-28">  </span>
<span id="cb1-29">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add slide-wide cell ID</span></span>
<span id="cb1-30">  calls[, cell_ID <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c_"</span>, slide_number, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, fov, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, CellId)]</span>
<span id="cb1-31">  all_cells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(calls<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_ID)</span>
<span id="cb1-32">  </span>
<span id="cb1-33">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to build sparse matrix for a given type</span></span>
<span id="cb1-34">  make_sparse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(type, genes) {</span>
<span id="cb1-35">    subset <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> calls[codeclass <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> type]</span>
<span id="cb1-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(subset) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb1-37">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(genes), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(all_cells), </span>
<span id="cb1-38">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sparse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb1-39">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dimnames =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(genes, all_cells)))</span>
<span id="cb1-40">    }</span>
<span id="cb1-41">    counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> subset[, .N, by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> .(target, cell_ID)]</span>
<span id="cb1-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparseMatrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(counts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>target, genes),</span>
<span id="cb1-43">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">j =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(counts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_ID, all_cells),</span>
<span id="cb1-44">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> counts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>N,</span>
<span id="cb1-45">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dims =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(genes), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(all_cells)),</span>
<span id="cb1-46">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dimnames =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(genes, all_cells))</span>
<span id="cb1-47">  }</span>
<span id="cb1-48">  </span>
<span id="cb1-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Endogenous =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sparse</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Endogenous"</span>, all_endogenous),</span>
<span id="cb1-50">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Negative =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_sparse</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Negative"</span>, all_negative))</span>
<span id="cb1-51">}</span>
<span id="cb1-52"></span>
<span id="cb1-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- Main Function ----</span></span>
<span id="cb1-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' Load aligned RNA data into sparse expression matrices</span></span>
<span id="cb1-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'</span></span>
<span id="cb1-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' Reads multiple target call files from an aligned RNA directory </span></span>
<span id="cb1-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' and returns two sparse matrices: </span></span>
<span id="cb1-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' one for endogenous targets (genes) and one for negative controls.</span></span>
<span id="cb1-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'</span></span>
<span id="cb1-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param aligned_RNA_dir Path to aligned RNA data </span></span>
<span id="cb1-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' (folder ending with "_Shifted")</span></span>
<span id="cb1-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param slide_number Slide number used in cell IDs</span></span>
<span id="cb1-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @return A named list with two sparse matrices: "Endogenous" and "Negative"</span></span>
<span id="cb1-64"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @examples</span></span>
<span id="cb1-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' exp_matrices &lt;- load_aligned_RNA_to_expMat(</span></span>
<span id="cb1-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#'                      "AnalysisResults/7hzxsoa7rs_Shifted", 2)</span></span>
<span id="cb1-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' </span></span>
<span id="cb1-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' library(Seurat)</span></span>
<span id="cb1-69"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' sem &lt;- CreateSeuratObject(exp_matrices[["Endogenous"]])</span></span>
<span id="cb1-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' </span></span>
<span id="cb1-71"> </span>
<span id="cb1-72"></span>
<span id="cb1-73">load_aligned_RNA_to_expMat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(aligned_RNA_dir, slide_number) {</span>
<span id="cb1-74">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Validate input</span></span>
<span id="cb1-75">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.exists</span>(aligned_RNA_dir)) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Directory does not exist"</span>)</span>
<span id="cb1-76">  </span>
<span id="cb1-77">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get target call files</span></span>
<span id="cb1-78">  target_call_files <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list.files</span>(aligned_RNA_dir, </span>
<span id="cb1-79">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_complete_code_cell_target_call_coord.csv"</span>,</span>
<span id="cb1-80">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">recursive =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-81">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(target_call_files) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No target call files found"</span>)</span>
<span id="cb1-82">  </span>
<span id="cb1-83">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parallel load of all FOVs</span></span>
<span id="cb1-84">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plan</span>(multisession)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set parallel backend</span></span>
<span id="cb1-85">  exp_mat_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">future_lapply</span>(target_call_files, load_to_exp_mat, </span>
<span id="cb1-86">                                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slide_number =</span> slide_number)</span>
<span id="cb1-87">  </span>
<span id="cb1-88">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Collect all genes and cells across FOVs</span></span>
<span id="cb1-89">  all_endogenous_genes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(</span>
<span id="cb1-90">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(exp_mat_list, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(x[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Endogenous"</span>]]))))</span>
<span id="cb1-91">  all_negative_genes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(</span>
<span id="cb1-92">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(exp_mat_list, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(x[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Negative"</span>]]))))</span>
<span id="cb1-93">  all_cells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(</span>
<span id="cb1-94">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(exp_mat_list, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(x[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Endogenous"</span>]]))))</span>
<span id="cb1-95">  </span>
<span id="cb1-96">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine matrices across FOVs</span></span>
<span id="cb1-97">  combine_mats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(type, all_genes) {</span>
<span id="cb1-98">    mats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(exp_mat_list, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pad_matrix</span>(x[[type]], </span>
<span id="cb1-99">                                                        all_genes, all_cells))</span>
<span id="cb1-100">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Reduce</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">+</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, mats)</span>
<span id="cb1-101">  }</span>
<span id="cb1-102">  </span>
<span id="cb1-103">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Endogenous =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">combine_mats</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Endogenous"</span>, all_endogenous_genes),</span>
<span id="cb1-104">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Negative =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">combine_mats</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Negative"</span>, all_negative_genes))</span>
<span id="cb1-105">}</span></code></pre></div>
</details>
</div>
<p>Once you have this expression matrix and / or Seurat object, you are ready to continue with downstream tertiary analysis. As mentioned in the alignment post, after alignment all cell metadata and segmentation information is contained in the protein data and thus can be extracted from the protein run outputs. As one example of a downstream analysis utilizing both the RNA and protein data, see our recently released approach for <a href="../../posts/multiomics-hieratype/index.html">multiomic cell typing</a>.</p>


</section>

 ]]></description>
  <category>multiomics</category>
  <category>RNA</category>
  <category>alignment</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/aligned_rna_exp_matrix/</guid>
  <pubDate>Wed, 26 Nov 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/aligned_rna_exp_matrix/figures/ExpMatrixSnippet.png" medium="image" type="image/png" height="31" width="144"/>
</item>
<item>
  <title>Integrated RNA + protein multiomic cell typing using HieraType</title>
  <dc:creator>Dan McGuire</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-hieratype/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>This post showcases how the <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/HieraType">HieraType cell typing package</a> can be used for integrated same-slide multiomic (protein + rna) cell typing.</p>
<p>As an example, we use a breast cancer tissue sample with both 64-plex protein and WTx 18,935 plex RNA assayed. We start by comparing cell typing with three approaches:</p>
<ul>
<li>both RNA + protein</li>
<li>protein-only</li>
<li>RNA-only</li>
</ul>
<p>We compare cell typing performance and show that, overall, protein-only and RNA-only cell typing calls show more disagreement with each other than they do with with integrated multiomic cell type calls. We also demonstrate evidence of improved coherence of cell type labels with the defining marker genes and proteins when using an integrated approach that makes use of both analytes.</p>
<p>Finally, we show a simple yet effective way to integrate unsupervised clusters with supervised immune cell type labels generated with HieraType. This can enable granular detection of novel or tissue-specific cell types along with well known immune cell types.</p>
<p>Code for this analysis end-to-end can be found by skipping ahead here.</p>
</section>
<section id="a-quick-look-at-the-tissue" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> A quick look at the tissue</h1>
<p>Here’s a quick look at this breast cancer tissue, where unsupervised clustering was performed using both the pearson residual normalized RNA + protein. Code for creating these unsupervised clusters is here. Next, we’ll compare multiomic immune cell typing performance with RNA-only or protein-only cell typing.</p>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-hieratype/figures/xyp_multi_unsup.png" alt="Wide Image"></p>
</div>
</section>
<section id="evidence-multiomics-can-improve-cell-typing" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Evidence multiomics can improve cell typing</h1>
<p>We used the Adjusted Rand Index (ARI) metric to quantify the agreement between protein-only, RNA-only, and multiomic cell type labels (code). ARI is a numerical measure of similarity between two data clusterings <span class="citation" data-cites="ariref">(Rand 1971)</span>. We found protein-only and RNA-only cell typing calls show more disagreement with each other than they do with with integrated multiomic cell type calls, with:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?ARI(%5Ctext%7Bmultiomic,RNA-only%7D)=%200.679"></li>
<li><img src="https://latex.codecogs.com/png.latex?ARI(%5Ctext%7Bmultiomic,%20protein-only%7D)=%200.589"></li>
<li><img src="https://latex.codecogs.com/png.latex?ARI(%5Ctext%7Bprotein-only,%20RNA-only%7D)=%200.483"></li>
</ul>
<p>We compared the agreement between celltype predictions and canonical protein markers and RNA markers, and found that the multiomic cell type labels often show stronger alignment than RNA-only or protein-only cell typing. ( Code for RNA-only, protein-only, multiomic HieraType calls.)</p>
<section id="t-cell-improvement-demonstration-via-area-under-the-roc-curves" class="level3" data-number="3.0.1">
<h3 data-number="3.0.1" class="anchored" data-anchor-id="t-cell-improvement-demonstration-via-area-under-the-roc-curves"><span class="header-section-number">3.0.1</span> T cell improvement demonstration via area under the ROC curves</h3>
<p>For example, the figure below shows ROC curves for T cell predictions along with three canonical cell type markers for T cells (one protein, and two RNA). In this context, for a given level of marker expression, ‘<em>sensitivity</em>’ refers to the frequency a cell is labeled a T-cell (for all cells above that threshold of marker expression). ‘<em>Specificity</em>’ refers to the proportion of times a cell is labeled anything other than a T-cell (for all cells below that threshold).<br>
If we treat our normalized marker expression as a gold standard for cell type calling, then we would want to see high sensitivity and specificity of the T cell calls depending on whether marker expression is high or low. In general, larger area under the ROC curve indicates better agreement between cell type calls and marker expression.</p>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-hieratype/figures/rocplot_tcell_lbl.png" alt="Wide Image"></p>
</div>
<p>Above, as we might expect, we see that using <span style="color:#377EB8;">RNA-only</span> for calling T cells does not optimize agreement between CD3 protein (AUC=0.871). Unsurprisingly, agreement improves when using CD3 protein directly for celltyping (<span style="color:#E41A1C;">protein-only</span> AUC=0.927). In this case, we actually observed the best AUC when both RNA and protein were used jointly (<span style="color:#9D4EA3;">multiomics</span> AUC=0.937).</p>
<p>A perhaps unsurprising theme that emerged from these cell typing comparisons was that we often see the worst agreement for protein markers when using RNA-only for celltyping, and the worst agreement for RNA markers when using protein-only for celltyping. Meanwhile, using both RNA and protein analytes often yields the best or nearly-best agreement for both marker types. This is further shown above in the middle-and-right panels when looking at CD3D and CD2 RNA markers. <span style="color:#9D4EA3;">Multiomic</span> celltyping outperforms <span style="color:#E41A1C;">protein-only</span> by the widest margin, and also slightly outperforms <span style="color:#377EB8;">RNA-only</span>.</p>
<p>One interesting point of note when comparing the shapes of the ROC curves above is the smoothness of the curve for the CD3 protein marker, compared to the CD2 and CD3D RNA markers (which show a sharper bump closer to the lower-left corner where sensitivity=0 and specificity=1). Due to the sparsity of RNA counts, we see a sharp spike in sensitivity close to an expression threshold at which cells have a single count of the marker gene. Because <span style="color:#377EB8;">RNA-only</span> cell typing uses only the RNA markers, the AUC is larger and more influenced around this local threshold of a single marker gene count, while <span style="color:#E41A1C;">protein-only</span> and <span style="color:#9D4EA3;">multiomic</span> cell type labels are impacted directly by marker protein expression.</p>
</section>
<section id="improved-auc-across-immune-cell-types" class="level3" data-number="3.0.2">
<h3 data-number="3.0.2" class="anchored" data-anchor-id="improved-auc-across-immune-cell-types"><span class="header-section-number">3.0.2</span> Improved AUC across immune cell types</h3>
<p>We saw a similar trend as that demonstrated above across immune cell types.<br>
Here, for the most important ‘index markers’ of each immune cell type, we show the area under the ROC curve for <span style="color:#377EB8;">RNA-only</span>, <span style="color:#E41A1C;">protein-only</span>, and <span style="color:#9D4EA3;">multiomic</span> celltyping results (code for this analysis can be found here in the end-to-end code section). In general, there appears to be an improvement in AUC for both RNA and protein markers compared to if one of the analytes were removed.</p>
<p>Average AUC was highest for multiomic celltyping across all markers and celltypes, with</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?%5Coverline%7BAUC%7D(%5Ctext%7Bmultiomic%7D)%20=%200.711"></li>
<li><img src="https://latex.codecogs.com/png.latex?%5Coverline%7BAUC%7D(%5Ctext%7BRNA-only%7D)%20=%200.709"></li>
<li><img src="https://latex.codecogs.com/png.latex?%5Coverline%7BAUC%7D(%5Ctext%7Bprotein-only%7D)%20=%200.701"></li>
</ul>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-hieratype/figures/aucbarplot_wtext.png" alt="Wide Image"></p>
</div>
</section>
</section>
<section id="multiomic" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Running HieraType using Protein + RNA</h1>
<p>Below, we’ll step through the process of generating cell type labels with multiomic data. The code for using HieraType with protein data uses very similar syntax as a regular HieraType call, with a few exceptions worth calling out.</p>
<section id="protein-naming-convention" class="level5">
<h5 class="anchored" data-anchor-id="protein-naming-convention">Protein naming convention</h5>
<p>HieraType works from a set of pre-defined ‘markers’ which correspond to each cell type we hope to classify. For multiomic or protein-only data, protein marker names must end with the suffix “_protein” in our <code>markerslist</code> objects.<br>
For example, here is the HieraType package multiomic markerslist for CD8 T cells (<code>cd8t</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_tcellmajor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cd8t)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>$index_marker
[1] "CD8A"        "CD8B"        "CD8_protein"

$predictors
 [1] "CD8_protein"    "CD3_protein"    "CCR7_protein"   "CD45RA_protein" "CD27_protein"   "GZMA_protein"  
 [7] "GZMB_protein"   "LAG3_protein"   "TCF7_protein"   "CD3D"           "CD3E"           "CD3G"          
[13] "CD8A"           "CD8B"           "IL7R"           "CD27"           "SELL"           "CCR7"          
[19] "TCF7"           "LEF1"           "FOXP1"          "BACH2"          "KLF2"           "CD28"          
[25] "ICOS"           "STAT3"          "STAT5"          "RUNX3"          "BATF"           "EOMES"         
[31] "TBX21"          "PRDM1"          "PDCD1"          "LAG3"           "TIGIT"          "HAVCR2"        
[37] "GZMK"           "GZMA"           "GZMB"           "PRF1"           "GNLY"           "KLRG1"         
[43] "KLRD1"          "IFNG"           "CCL5"           "CX3CR1"         "NKG7"           "FAS"           
[49] "FASLG"          "IL2"            "CD244"          "CXCR3"          "KLRB1"          "TOX"           
[55] "NR4A2"          "BCL6"           "CXCL13"        

$use_offclass_markers_as_negative_predictors
[1] TRUE</code></pre>
</div>
</div>
</section>
<section id="protein-data-normalization-and-constructing-a-multiomic-adjacency_matrix" class="level5">
<h5 class="anchored" data-anchor-id="protein-data-normalization-and-constructing-a-multiomic-adjacency_matrix">Protein data normalization and constructing a multiomic adjacency_matrix</h5>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Below, we make use of the <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/scPearsonPCA">scPearsonPCA package</a>. This R package provides convenience functions for getting the principal component embeddings for pearson-residual normalized data directly from a raw counts matrix. When normalized protein is also available, we can get the PC decomposition from both RNA and normalized protein using the functions below. For more detail on the package, please check out the <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/scPearsonPCA">README</a>.</p>
</div>
</div>
<p>Protein data should be normalized, then combined with a sparse un-normalized RNA counts matrix before passing to HieraType. Here we’ll use pearson residuals from a gamma regression model as a normalization method, although other reasonable methods might be considered and left to the user’s disgression. We then add the “_protein” suffix to the protein names, so they’ll align with the HieraType markerlists.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## normalize each protein taking pearson residuals from gamma generalized linear model.</span></span>
<span id="cb3-2">pgamm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pearson_normalize_gamma_glm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(sem_protein[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts)</span>
<span id="cb3-3">                                                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper_q_thresh =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span></span>
<span id="cb3-4">                                                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower_q_thresh =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb3-5">                                                   )</span>
<span id="cb3-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_protein"</span>)</span></code></pre></div>
</div>
<p>Here we conduct a principal component decomposition from combined RNA and proteins across all cells; this can be used to give us the cells x cells similarity graph we’ll pass to HieraType.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## select genes from RNA data to use for PCA analysis.</span></span>
<span id="cb4-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Take the top 2k features as well as any pre-defined celltyping markers from HieraType</span></span>
<span id="cb4-3">sem_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindVariableFeatures</span>(sem_rna, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nfeatures =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>)</span>
<span id="cb4-4">markerg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb4-5">  HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_l1</span>
<span id="cb4-6">  ,HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_immune</span>
<span id="cb4-7">  ,HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd8tminor</span>
<span id="cb4-8">  ,HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd4tminor</span>
<span id="cb4-9">  ,HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_tcellmajor</span>
<span id="cb4-10">), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[["</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"predictors"</span>))</span>
<span id="cb4-11">use_genes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>assays<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>RNA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>var.features, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(markerg, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(sem_rna))))</span>
<span id="cb4-12"></span>
<span id="cb4-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### total counts and gene frequency from RNA data computed across full dataset</span></span>
<span id="cb4-14">tc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts)</span>
<span id="cb4-15">genefreq <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gene_frequency</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts)</span>
<span id="cb4-16"></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiomic RNA and Protein cluster analysis</span></span>
<span id="cb4-18">pcaobj_multi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_quasipoisson_pca_seurat_multiomic</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[use_genes,]</span>
<span id="cb4-19">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> tc</span>
<span id="cb4-20">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grate =</span> genefreq[use_genes]</span>
<span id="cb4-21">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xother =</span> pgamm <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## normalized protein</span></span>
<span id="cb4-22">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.scale =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb4-23">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.center =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb4-24">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale.max =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb4-25">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-26">)</span>
<span id="cb4-27"></span>
<span id="cb4-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Make a cell-cell adjacency matrix for HieraType </span></span>
<span id="cb4-29">multi_simgrph <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> uwot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">similarity_graph</span>(pcaobj_multi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>reduction.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings</span>
<span id="cb4-30">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_neighbors =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb4-31">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nn_method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"annoy"</span></span>
<span id="cb4-32">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cosine'</span></span>
<span id="cb4-33">                                  )</span>
<span id="cb4-34"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multi_simgrph) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(multi_simgrph) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pcaobj_multi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>reduction.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings)</span></code></pre></div>
</div>
</section>
<section id="hieratype-call" class="level5">
<h5 class="anchored" data-anchor-id="hieratype-call">HieraType call</h5>
<p>Here we construct our ‘multiomic’ expression matrix which includes our sparse RNA counts with the normalized protein expression, then we call <code>HieraType::run_pipeline</code> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### combining sparse RNA counts and normalized proteins into a single matrix 'multimat'</span></span>
<span id="cb5-2">overlapping_cells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(sem_protein), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(sem_rna))</span>
<span id="cb5-3">multimat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(pgamm[,overlapping_cells])</span>
<span id="cb5-4">multimat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(multimat, Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[use_genes,overlapping_cells]))</span>
<span id="cb5-5"></span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Define pipeline, using multiomic markerslists</span></span>
<span id="cb5-8">pipeline_io_multiomics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_pipeline</span>(</span>
<span id="cb5-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">markerslists =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb5-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l1"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_l1</span>
<span id="cb5-11">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_immune</span>
<span id="cb5-12">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_tcellmajor</span>
<span id="cb5-13">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt4minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_cd4tminor</span>
<span id="cb5-14">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt8minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_cd8tminor</span>
<span id="cb5-15">  )</span>
<span id="cb5-16">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb5-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l1"</span></span>
<span id="cb5-18">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span></span>
<span id="cb5-19">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt4minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span></span>
<span id="cb5-20">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt8minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span></span>
<span id="cb5-21">  )</span>
<span id="cb5-22">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors_category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb5-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"immune"</span></span>
<span id="cb5-24">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tcell"</span></span>
<span id="cb5-25">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt4minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4t"</span></span>
<span id="cb5-26">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt8minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8t"</span></span>
<span id="cb5-27">  )</span>
<span id="cb5-28">)</span>
<span id="cb5-29"></span>
<span id="cb5-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Run the celltyping pipeline</span></span>
<span id="cb5-31">multictobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_pipeline</span>(</span>
<span id="cb5-32">   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pipeline =</span> pipeline_io_multiomics</span>
<span id="cb5-33">   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts=</span> tc[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multimat)]</span>
<span id="cb5-34">   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gene_wise_frequency =</span> genefreq</span>
<span id="cb5-35">   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> multimat </span>
<span id="cb5-36">   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> multi_simgrph[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multimat), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multimat)]</span>
<span id="cb5-37"> )</span></code></pre></div>
</div>
</section>
<section id="outputs" class="level5">
<h5 class="anchored" data-anchor-id="outputs">Outputs</h5>
<p>For extensive description of the outputs we get from HieraType, we refer the reader to the original post. Here, we’ll demonstrate how to make a few marker heatmaps from the RNA and protein data to sanity check our cell typing results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">multictobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>] <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## posterior probabilities for each cell type</span></span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>        cell_ID celltype_thresh celltype_granular best_score_granular
1     c_1_100_1          immune          monocyte           0.2832607
2    c_1_100_10          plasma            plasma           0.9505284
3   c_1_100_100      epithelial        epithelial           0.9894404
4  c_1_100_1000              l1         cd4_naive           0.1029328
5  c_1_100_1001              l1       endothelial           0.3917291
6  c_1_100_1002          immune        macrophage           0.2146396
7  c_1_100_1003          plasma            plasma           0.9697994
8  c_1_100_1004          immune         dendritic           0.3165272
9  c_1_100_1005              l1        fibroblast           0.2769950
10 c_1_100_1006          plasma            plasma           0.9283903
   best_score_thresh
1          0.9979747
2          0.9505284
3          0.9894404
4          0.4220678
5          0.3917291
6          0.5871081
7          0.9697994
8          0.9999999
9          0.2769950
10         0.9283903</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Use the major cell type categories for a heatmap</span></span>
<span id="cb8-2">ppmulti <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(multictobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l1)</span>
<span id="cb8-3">ppmulti[,celltype_multi_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span>celltype_granular]</span>
<span id="cb8-4">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4"</span>,celltype_multi_major),celltype_multi_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4_tcell"</span>]</span>
<span id="cb8-5">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8"</span>,celltype_multi_major),celltype_multi_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8_tcell"</span>]</span>
<span id="cb8-6">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mono|macro"</span>,celltype_multi_major),celltype_multi_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage_monocyte"</span>]</span>
<span id="cb8-7"></span>
<span id="cb8-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### fold change metrics to show in RNA heatmap</span></span>
<span id="cb8-9">fctbl_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb8-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[use_genes,]</span>
<span id="cb8-11">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts)</span>
<span id="cb8-12">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> ppmulti</span>
<span id="cb8-13">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_multi_major"</span></span>
<span id="cb8-14">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span></span>
<span id="cb8-15">                               )</span>
<span id="cb8-16"></span>
<span id="cb8-17">hm_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_ncells</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_heatmap</span>(fctbl_rna))</span>
<span id="cb8-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(hm_rna)</span></code></pre></div>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-hieratype/figures/hm_rna_multi.png" alt="Wide Image"></p>
</div>
<p>For the protein data, almost all proteins have some positive measurement in each cell. We can use the pearson residuals to set a cutoff for computing the proportion of positive cells by marker and by cell type. Below, we’ll use cutoff of ‘pearson residual &gt; 1’ to determine the size of the bubble in the heatmap.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">fctbl_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics_protein</span>(sem_protein[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[,overlapping_cells]</span>
<span id="cb9-3">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> ppmulti</span>
<span id="cb9-4">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_multi_major"</span></span>
<span id="cb9-5">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">propd =</span> (pgamm[,overlapping_cells] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb9-6"></span>
<span id="cb9-7">hm_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_ncells</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_heatmap</span>(fctbl_protein))</span>
<span id="cb9-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(hm_protein)</span></code></pre></div>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-hieratype/figures/hm_protein_multi.png" alt="Wide Image"></p>
</div>
</section>
</section>
<section id="integrating-unsupervised-clusters-with-immune-cell-type-labels" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Integrating unsupervised clusters with immune cell type labels</h1>
HieraType was designed to find celltypes with known, pre-specified markers. Often, unsupervised clustering is sufficiently granular to identify very distinct tissue-specific clusters, but may not identify commune immune cell types of interest due to relative sparsity of the immune markers. We demonstrate an easy way (code) to reconcile the labels between HieraType and unsupervised clustering; keeping the HieraType label when a cell is classified as immune, and taking the unsupervised cluster label otherwise. This can be a useful technique regardless of whether one is using RNA, protein, or both to cell type their single cell dataset.
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-hieratype/figures/xyp_multi_semisup.png" alt="Wide Image"></p>
</div>
</section>
<section id="conclusion" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Conclusion</h1>
<p>The HieraType method constructs continuous celltype metagene scores, which are then probabilistically clustered to classify cell types. Because these metagene scores are continuous and the clustering uses flexible gaussian mixture models, the inputted expression can be fluidly specified in terms of RNA markers, protein markers, or some combination of both. This allows for an elegant and efficient solution for fully integrated celltyping when both protein and RNA are available.<br>
Overall, we’ve found improved cell typing performance when both analytes are used compared to either analyte on its own across multiple multiomic datasets, and as demonstrated for the breast cancer sample in this post.</p>
<p>While the HieraType method is fully supervised and cannot identify novel cell types not specified in a ‘<code>markerslist</code>’, we demonstrate an easy approach for integrating unsupervised clusters with HieraType immune cell typing calls, enabling high resolution cell typing for both immune cell types as well as epithelial or tissue context specific cell types which may not have a known marker profile a priori. This can help reap benefits of both unsupervised and supervised approaches - well controlled pre-specified immune cell typing combined with granular unsupervised epithelial clusters.</p>
</section>
<section id="endtoend" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> End-to-end detailed analysis code</h1>
<p>For completeness, here are a few end-to-end code blocks for each analysis step.</p>
<section id="reading-in-the-data" class="level5">
<h5 class="anchored" data-anchor-id="reading-in-the-data">Reading in the data</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#remotes::install_github("Nanostring-Biostats/CosMx-Analysis-Scratch-Space", </span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#                        subdir = "_code/HieraType", ref = "Main")</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#remotes::install_github("Nanostring-Biostats/CosMx-Analysis-Scratch-Space", </span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#                        subdir = "_code/scPearsonPCA", ref = "Main")</span></span>
<span id="cb10-5"></span>
<span id="cb10-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb10-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggrepel)</span>
<span id="cb10-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)</span>
<span id="cb10-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scPearsonPCA)</span>
<span id="cb10-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(HieraType)</span>
<span id="cb10-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)</span>
<span id="cb10-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pROC)</span>
<span id="cb10-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mclust)</span>
<span id="cb10-14"></span>
<span id="cb10-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Note, using a v3-style Seurat Object below, i.e., `sem[["RNA"]]@counts`</span></span>
<span id="cb10-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## For v5-style, the syntax would be like `sem[["RNA"]]$counts`</span></span>
<span id="cb10-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Seurat.object.assay.version =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v3"</span>)  </span>
<span id="cb10-18"></span>
<span id="cb10-19">sem_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Breast/sem_protein.rds"</span>)</span>
<span id="cb10-20">sem_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Breast/sem_rna.rds"</span>)</span>
<span id="cb10-21">sem_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(sem_rna, nCount_RNA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div>
</div>
</section>
<section id="normalizing-protein-data" class="level5">
<h5 class="anchored" data-anchor-id="normalizing-protein-data">Normalizing protein data</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## normalize each protein taking pearson residuals from gamma generalized linear model.</span></span>
<span id="cb11-2">pgamm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pearson_normalize_gamma_glm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(sem_protein[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts)</span>
<span id="cb11-3">                                                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper_q_thresh =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span></span>
<span id="cb11-4">                                                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower_q_thresh =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb11-5">                                                   )</span>
<span id="cb11-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_protein"</span>)</span></code></pre></div>
</div>
</section>
<section id="multiunsup" class="level5">
<h5 class="anchored" data-anchor-id="multiunsup">Multiomic pearson residual PCA analysis using the protein and RNA</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## select genes from RNA data to use for PCA analysis.</span></span>
<span id="cb12-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Will take the top 2k features as well as any pre-defined immune celltyping markers from HieraType</span></span>
<span id="cb12-3">sem_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindVariableFeatures</span>(sem_rna, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nfeatures =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>)</span>
<span id="cb12-4">markerg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb12-5">  HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_l1</span>
<span id="cb12-6">  ,HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_immune</span>
<span id="cb12-7">  ,HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd8tminor</span>
<span id="cb12-8">  ,HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd4tminor</span>
<span id="cb12-9">  ,HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_tcellmajor</span>
<span id="cb12-10">), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[["</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"predictors"</span>))</span>
<span id="cb12-11">use_genes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>assays<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>RNA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>var.features, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(markerg, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(sem_rna))))</span>
<span id="cb12-12"></span>
<span id="cb12-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### total counts and gene frequency from RNA data computed across full dataset</span></span>
<span id="cb12-14">tc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts)</span>
<span id="cb12-15">genefreq <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gene_frequency</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts)</span>
<span id="cb12-16"></span>
<span id="cb12-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### add a '_protein' suffix to the protein names - helps differentiate proteins and RNA's with the same name. </span></span>
<span id="cb12-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_protein"</span>)</span>
<span id="cb12-19"></span>
<span id="cb12-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Principal components derived from the combined covariance matrix of pearson residual normalized RNA and protein.</span></span>
<span id="cb12-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### </span></span>
<span id="cb12-22">pcaobj_multi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_quasipoisson_pca_seurat_multiomic</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[use_genes,]</span>
<span id="cb12-23">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> tc</span>
<span id="cb12-24">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grate =</span> genefreq[use_genes]</span>
<span id="cb12-25">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xother =</span> pgamm <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## normalized protein</span></span>
<span id="cb12-26">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.scale =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb12-27">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.center =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb12-28">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale.max =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb12-29">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-30">)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>PC_ 1 
Positive:  CD45_protein, CD4_protein, CD39_protein, CD16_protein, Channel-CD45_protein, Fibronectin_protein, CD3_protein, Vimentin_protein, CD40_protein, CD14_protein 
       HLA-DR_protein, STING_protein, SMA_protein, ICAM1_protein, CD68_protein, CD163_protein, CD11c_protein, ICOS_protein, CD20_protein, CD8_protein 
Negative:  AZGP1, KRT7, KRT18, NAMPT, KRT8, KRT19, FASN, S100A11, DBI, SERHL2 
       MYL6, EPCAM, ASPH, PRDX2, ALDOA, WFDC2, CYB5A, GSTP1, TMBIM6, NFIX 
PC_ 2 
Positive:  VIM, SPARC, COL3A1, COL1A1, COL1A2, CD39_protein, IGFBP7, HLA-DRB1, CST3, TIMP2 
       HLA-DRA, AEBP1, CD74, LUM, COL6A2, CD40_protein, CD16_protein, BGN, CYBA, COL6A1 
Negative:  pan-RAS_protein, p53_protein, Channel-PanCK_protein, CD127_protein, EGFR_protein, NF-kB p65_protein, EpCAM_protein, CTLA4_protein, TCF7_protein, LAMP1_protein 
       Beta-catenin_protein, Ki-67_protein, CD138_protein, VISTA_protein, FOXP3_protein, Her2_protein, LAG3_protein, CD45RA_protein, DBI, SERHL2 
PC_ 3 
Positive:  H3C15, H3C2, H3-7, H4C14, H4C11, H3C10, H3C13, H4C12, H3C7, H2AC16 
       H2BC4, H1-5, H2BC9, H1-2, H2AC18, H2AC11, H2BC18, H3C8, H3C11, H1-3 
Negative:  KRT19, p53_protein, FOXP3_protein, LAG3_protein, NDRG1, TCF7_protein, Her2_protein, CTLA4_protein, IgD_protein, KRT8 
       Channel-PanCK_protein, CD56_protein, VEGFA, LDHA, CD123_protein, AFMID, GZMB_protein, PGK1, ALDOA, iNOS_protein 
PC_ 4 
Positive:  HLA-DRB1, HLA-DRA, CD74, HLA-DR_protein, APOE, Channel-CD68_protein, CD11c_protein, CD45_protein, LYZ, HLA-DQB1 
       CD68_protein, CTSD, HLA-DPA1, C1QC, IFI30, CD16_protein, APOC1, HLA-DQA1, C1QB, CD4_protein 
Negative:  CD123_protein, CD34_protein, GZMB_protein, IGFBP7, CD31_protein, COL4A1, SPARC, CD56_protein, LAG3_protein, FOXP3_protein 
       COL4A2, IgD_protein, PLVAP, Her2_protein, GITR_protein, HSPG2, 4-1BB_protein, LAMA4, p53_protein, SMA_protein 
PC_ 5 
Positive:  PLVAP, COL4A1, CD34_protein, KDR, Beta-catenin_protein, CD31_protein, EGFL7, EpCAM_protein, COL4A2, AQP1 
       FLT1, HSPG2, SHANK3, PODXL, A2M, LAMP1_protein, CD34, ECSCR, INSR, STC1 
Negative:  PD-L2_protein, FOXP3_protein, LAG3_protein, 4-1BB_protein, GITR_protein, CD56_protein, GZMB_protein, iNOS_protein, Her2_protein, IgD_protein 
       GZMA_protein, PD-1_protein, CD11b_protein, CD19_protein, TCF7_protein, CD163_protein, CD123_protein, CTLA4_protein, IL-18_protein, Bcl-2_protein </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Make a cell-cell adjacency matrix for HieraType </span></span>
<span id="cb14-2">multi_simgrph <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> uwot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">similarity_graph</span>(pcaobj_multi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>reduction.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings</span>
<span id="cb14-3">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_neighbors =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb14-4">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nn_method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"annoy"</span></span>
<span id="cb14-5">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cosine'</span></span>
<span id="cb14-6">                                  )</span>
<span id="cb14-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multi_simgrph) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(multi_simgrph) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pcaobj_multi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>reduction.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings)</span>
<span id="cb14-8"></span>
<span id="cb14-9"></span>
<span id="cb14-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###  Unsupervised clusters using multiomic cell-cell adjacency graph</span></span>
<span id="cb14-11">sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"multigrph"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Graph</span>(multi_simgrph[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(sem_rna),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(sem_rna)])</span>
<span id="cb14-12">sem_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindClusters</span>(sem_rna, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">graph.name=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"multigrph"</span>)</span>
<span id="cb14-13">sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clusters_multi_unsup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seurat_clusters</span>
<span id="cb14-14"></span>
<span id="cb14-15">xyp_multi_unsup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xyplot</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clusters_multi_unsup"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ptsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>()</span>
<span id="cb14-16"></span>
<span id="cb14-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"figures/xyp_multi_unsup.png"</span></span>
<span id="cb14-18">       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot=</span>xyp_multi_unsup</span>
<span id="cb14-19">       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">device =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"png"</span></span>
<span id="cb14-20">       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1181</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb14-21">       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">689</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb14-22">       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'px'</span></span>
<span id="cb14-23">)</span></code></pre></div>
</div>
</section>
<section id="multiomic-cell-typing-code-using-hieratype" class="level5">
<h5 class="anchored" data-anchor-id="multiomic-cell-typing-code-using-hieratype">Multiomic cell typing code using HieraType</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Define the pipeline using multiomic markerlists in HieraType package</span></span>
<span id="cb15-2"></span>
<span id="cb15-3">overlapping_cells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(sem_protein), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(sem_rna))</span>
<span id="cb15-4">multimat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(pgamm[,overlapping_cells])</span>
<span id="cb15-5">multimat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(multimat, Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[use_genes,overlapping_cells]))</span>
<span id="cb15-6"></span>
<span id="cb15-7"></span>
<span id="cb15-8">pipeline_io_multiomics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_pipeline</span>(</span>
<span id="cb15-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">markerslists =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb15-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l1"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_l1</span>
<span id="cb15-11">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_immune</span>
<span id="cb15-12">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_tcellmajor</span>
<span id="cb15-13">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt4minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_cd4tminor</span>
<span id="cb15-14">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt8minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_cd8tminor</span>
<span id="cb15-15">  )</span>
<span id="cb15-16">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb15-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l1"</span></span>
<span id="cb15-18">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span></span>
<span id="cb15-19">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt4minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span></span>
<span id="cb15-20">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt8minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span></span>
<span id="cb15-21">  )</span>
<span id="cb15-22">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors_category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb15-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"immune"</span></span>
<span id="cb15-24">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tcell"</span></span>
<span id="cb15-25">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt4minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4t"</span></span>
<span id="cb15-26">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt8minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8t"</span></span>
<span id="cb15-27">  )</span>
<span id="cb15-28">)</span>
<span id="cb15-29"></span>
<span id="cb15-30">multictobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_pipeline</span>(</span>
<span id="cb15-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pipeline =</span> pipeline_io_multiomics</span>
<span id="cb15-32">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts=</span> tc[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multimat)]</span>
<span id="cb15-33">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gene_wise_frequency =</span> genefreq</span>
<span id="cb15-34">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> multimat</span>
<span id="cb15-35">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> multi_simgrph[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multimat), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multimat)]</span>
<span id="cb15-36">)</span></code></pre></div>
</div>
</section>
<section id="rnaonly" class="level5">
<h5 class="anchored" data-anchor-id="rnaonly">RNA-only cell typing</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### RNA-only PCA and similarity graph</span></span>
<span id="cb16-2">pcaobj_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_quasipoisson_pca_seurat</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[use_genes,]</span>
<span id="cb16-3">                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> tc</span>
<span id="cb16-4">                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grate =</span> genefreq[use_genes]</span>
<span id="cb16-5">                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.scale =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb16-6">                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.center =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb16-7">                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale.max =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb16-8">                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb16-9">)</span>
<span id="cb16-10"></span>
<span id="cb16-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Make a cell-cell adjacency matrix for HieraType </span></span>
<span id="cb16-12">rna_simgrph <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> uwot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">similarity_graph</span>(pcaobj_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>reduction.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings</span>
<span id="cb16-13">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_neighbors =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb16-14">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nn_method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"annoy"</span></span>
<span id="cb16-15">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cosine'</span></span>
<span id="cb16-16">                                  )</span>
<span id="cb16-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(rna_simgrph) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(rna_simgrph) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pcaobj_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>reduction.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings)</span>
<span id="cb16-18"></span>
<span id="cb16-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## RNA-only hieratype</span></span>
<span id="cb16-20">rnactobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_pipeline</span>(</span>
<span id="cb16-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pipeline =</span> pipeline_io_multiomics <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## the _protein markers are automatically excluded, </span></span>
<span id="cb16-22">                                    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## because they won't be found in the counts_matrix below</span></span>
<span id="cb16-23">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts=</span> tc[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multimat)]</span>
<span id="cb16-24">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gene_wise_frequency =</span> genefreq[use_genes]</span>
<span id="cb16-25">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> multimat[,use_genes] <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## exclude proteins, only use the 'use_genes'.  </span></span>
<span id="cb16-26">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> rna_simgrph[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multimat), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multimat)]</span>
<span id="cb16-27">)</span></code></pre></div>
</div>
</section>
<section id="proteinonly" class="level5">
<h5 class="anchored" data-anchor-id="proteinonly">Protein-only cell typing</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">pgamm_prot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pgamm</span>
<span id="cb17-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm_prot) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_protein$"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm_prot))</span>
<span id="cb17-3">sem_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SetAssayData</span>(sem_protein,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">layer =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new.data =</span> pgamm_prot)</span>
<span id="cb17-4">sem_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ScaleData</span>(sem_protein)</span>
<span id="cb17-5">sem_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RunPCA</span>(sem_protein, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(sem_protein))</span>
<span id="cb17-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Make a cell-cell adjacency matrix for HieraType </span></span>
<span id="cb17-7">protein_simgrph <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> uwot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">similarity_graph</span>(sem_protein<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>reductions<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pca<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings</span>
<span id="cb17-8">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_neighbors =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb17-9">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nn_method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"annoy"</span></span>
<span id="cb17-10">                                  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cosine'</span></span>
<span id="cb17-11">                                  )</span>
<span id="cb17-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(protein_simgrph) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(protein_simgrph) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(sem_protein<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>reductions<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pca<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings)</span>
<span id="cb17-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### Make a copy of the cell typing pipeline to use for protein</span></span>
<span id="cb17-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### -- Remove 'mast' cells, which dont have a specific protein marker.</span></span>
<span id="cb17-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### -- remove the minor T8 and T4 subtypes</span></span>
<span id="cb17-16">pipeline_io_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pipeline_io_multiomics</span>
<span id="cb17-17">pipeline_io_protein<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>markerslists<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mast <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb17-18">pipeline_io_protein<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>markerslists<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lt4minor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb17-19">pipeline_io_protein<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>markerslists<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lt8minor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb17-20">pipeline_io_protein<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>priors<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lt4minor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb17-21">pipeline_io_protein<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>priors<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lt8minor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb17-22">pipeline_io_protein<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>priors_category<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lt4minor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb17-23">pipeline_io_protein<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>priors_category<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lt8minor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb17-24"></span>
<span id="cb17-25">proteinctobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_pipeline</span>(</span>
<span id="cb17-26">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pipeline =</span> pipeline_io_protein</span>
<span id="cb17-27">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> multimat[,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_protein$"</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(multimat),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)]</span>
<span id="cb17-28">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> protein_simgrph[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multimat), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(multimat)]</span>
<span id="cb17-29">)</span></code></pre></div>
</div>
</section>
<section id="combining-metadata" class="level5">
<h5 class="anchored" data-anchor-id="combining-metadata">Combining metadata</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Combining metadata</span></span>
<span id="cb18-2"></span>
<span id="cb18-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Adding on multiomic celltype annotations</span></span>
<span id="cb18-4">ppmulti <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(multictobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l1)</span>
<span id="cb18-5">ppmulti[,celltype_multi_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span>celltype_granular]</span>
<span id="cb18-6">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4"</span>,celltype_multi_major),celltype_multi_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4_tcell"</span>]</span>
<span id="cb18-7">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8"</span>,celltype_multi_major),celltype_multi_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8_tcell"</span>]</span>
<span id="cb18-8">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mono|macro"</span>,celltype_multi_major),celltype_multi_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage_monocyte"</span>]</span>
<span id="cb18-9">ppmulti[,.N,by<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>.(celltype_multi_major, celltype_granular)]</span>
<span id="cb18-10"></span>
<span id="cb18-11"></span>
<span id="cb18-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Adding on RNA-only based  celltype annotations</span></span>
<span id="cb18-13">ppmulti <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(ppmulti, rnactobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l1[,.(cell_ID, celltype_granular)]</span>
<span id="cb18-14">                 ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffixes=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_multi"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_rna"</span>))</span>
<span id="cb18-15"></span>
<span id="cb18-16">ppmulti[,celltype_rna_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span>celltype_granular_rna]</span>
<span id="cb18-17">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4"</span>,celltype_rna_major),celltype_rna_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4_tcell"</span>]</span>
<span id="cb18-18">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8"</span>,celltype_rna_major),celltype_rna_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8_tcell"</span>]</span>
<span id="cb18-19">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mono|macro"</span>,celltype_rna_major),celltype_rna_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage_monocyte"</span>]</span>
<span id="cb18-20">ppmulti[,.N,by<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>.(celltype_rna_major, celltype_granular_rna)]</span>
<span id="cb18-21"></span>
<span id="cb18-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Adding protein-only based celltype annotations</span></span>
<span id="cb18-23">ppmulti <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(ppmulti, proteinctobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l1[,.(cell_ID, celltype_granular)]</span>
<span id="cb18-24">                 ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffixes=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_multi"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_protein"</span>))</span>
<span id="cb18-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setnames</span>(ppmulti, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_granular"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_granular_protein"</span>))</span>
<span id="cb18-26">ppmulti[,celltype_protein_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span>celltype_granular_protein]</span>
<span id="cb18-27">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4"</span>,celltype_protein_major),celltype_protein_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4_tcell"</span>]</span>
<span id="cb18-28">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8"</span>,celltype_protein_major),celltype_protein_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8_tcell"</span>]</span>
<span id="cb18-29">ppmulti[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mono|macro"</span>,celltype_protein_major),celltype_protein_major<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage_monocyte"</span>]</span>
<span id="cb18-30">ppmulti[,.N,by<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>.(celltype_protein_major, celltype_granular_protein)]</span></code></pre></div>
</div>
</section>
<section id="integrateunsup" class="level5">
<h5 class="anchored" data-anchor-id="integrateunsup">Integrating unsupervised clusters with immune cell type labels</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Annotating non-immune clusters with unsupervised labels, creating more granular annotations</span></span>
<span id="cb19-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### </span></span>
<span id="cb19-3">ppmulti <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(ppmulti, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)[,.(cell_ID, x_slide_mm, y_slide_mm, clusters_multi_unsup)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span>)</span>
<span id="cb19-4">ppmulti[,celltype_multi_semi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span>celltype_multi_major]</span>
<span id="cb19-5">ppmulti[celltype_multi_semi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plasma"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endothelial"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"epithelial"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fibroblast"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"smooth_muscle"</span>),celltype_multi_semi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span>clusters_multi_unsup]</span>
<span id="cb19-6">ppmulti[,.N,by<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>.(clusters_multi_unsup, celltype_multi_major)]</span>
<span id="cb19-7">class_other <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ppmulti[,.N,by<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>.(clusters_multi_unsup, celltype_multi_major)][,prop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span>N<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(N),by<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>.(clusters_multi_unsup)][<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>prop)][</span>
<span id="cb19-8">  ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(.SD,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),by<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>.(clusters_multi_unsup)]</span>
<span id="cb19-9">others <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> class_other[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>celltype_multi_major <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plasma"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endothelial"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"epithelial"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fibroblast"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"smooth_muscle"</span>)][[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clusters_multi_unsup"</span>]]</span>
<span id="cb19-10">ppmulti[celltype_multi_semi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> others, celltype_multi_semi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"other"</span>]</span>
<span id="cb19-11"></span>
<span id="cb19-12">  </span>
<span id="cb19-13"></span>
<span id="cb19-14">xyp_multi_semisup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xyplot</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_multi_semi"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> ppmulti, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ptsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>()</span>
<span id="cb19-15"></span>
<span id="cb19-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"figures/xyp_multi_semisup.png"</span></span>
<span id="cb19-17">       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot=</span>xyp_multi_semisup</span>
<span id="cb19-18">       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">device =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"png"</span></span>
<span id="cb19-19">       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1181</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb19-20">       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">689</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb19-21">       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'px'</span></span>
<span id="cb19-22">)</span></code></pre></div>
</div>
</section>
<section id="ari" class="level5">
<h5 class="anchored" data-anchor-id="ari">ARI quantifying agreement between cell type labels</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ARI</span></span>
<span id="cb20-2">mclust<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adjustedRandIndex</span>(ppmulti<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_multi_major, ppmulti<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_protein_major)</span>
<span id="cb20-3">mclust<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adjustedRandIndex</span>(ppmulti<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_multi_major, ppmulti<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_rna_major)</span>
<span id="cb20-4">mclust<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adjustedRandIndex</span>(ppmulti<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_protein_major, ppmulti<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_rna_major)</span></code></pre></div>
</div>
</section>
<section id="making-roc-curves-computing-and-plotting-area-under-the-curve" class="level5">
<h5 class="anchored" data-anchor-id="making-roc-curves-computing-and-plotting-area-under-the-curve">Making ROC curves, computing and plotting area under the curve</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Get the most important 'index markers' for each celltype (including proteins and RNAs)</span></span>
<span id="cb21-2">index_markers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_immune, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[["</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index_marker"</span>))</span>
<span id="cb21-3">index_markers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbindlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_immune), <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(ct){</span>
<span id="cb21-4">  markerdt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">celltype =</span> ct</span>
<span id="cb21-5">                         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">marker =</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_multiomic_immune[[ct]][[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index_marker"</span>]]</span>
<span id="cb21-6">                         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">typ =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna"</span></span>
<span id="cb21-7">  )</span>
<span id="cb21-8">  markerdt[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_protein$"</span>, marker),typ<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"protein"</span>]</span>
<span id="cb21-9">  markerdt[,marker<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_protein$"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, marker)]</span>
<span id="cb21-10">  markerdt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> markerdt[(typ<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> marker <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(sem_rna)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (typ<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"protein"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> marker <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(sem_protein))]</span>
<span id="cb21-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(markerdt)</span>
<span id="cb21-12">}))</span>
<span id="cb21-13"></span>
<span id="cb21-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Combine macrophage and monocyte due to similarity</span></span>
<span id="cb21-15">index_markers[celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"monocyte"</span>),celltype<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage_monocyte"</span>]</span>
<span id="cb21-16">aucrocl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb21-17">plotdata_markerl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb21-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_protein"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm))</span>
<span id="cb21-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(ii <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(index_markers)){</span>
<span id="cb21-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(ii)</span>
<span id="cb21-21">  res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> index_markers[ii]</span>
<span id="cb21-22">  typ <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> res[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typ"</span>]]</span>
<span id="cb21-23"></span>
<span id="cb21-24"></span>
<span id="cb21-25">  marker <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> res[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"marker"</span>]]</span>
<span id="cb21-26">  celltype <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> res[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype"</span>]] </span>
<span id="cb21-27">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(typ<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna"</span>){</span>
<span id="cb21-28">    x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[marker,ppmulti[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span>]]]</span>
<span id="cb21-29">    tc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[,ppmulti[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span>]]])</span>
<span id="cb21-30">    muhat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> genefreq[marker] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> tc </span>
<span id="cb21-31">    x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> muhat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(muhat) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## normalized expression for marker (pearson residuals)</span></span>
<span id="cb21-32">  }  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb21-33">    x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pgamm[marker,ppmulti[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span>]]]</span>
<span id="cb21-34">  }</span>
<span id="cb21-35">  </span>
<span id="cb21-36">  pdlbl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>() </span>
<span id="cb21-37">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(labelname <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_multi_major"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_rna_major"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_protein_major"</span>)){</span>
<span id="cb21-38">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(labelname)</span>
<span id="cb21-39">    labels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ppmulti[[labelname]]</span>
<span id="cb21-40">    labels[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tcell"</span>, labels)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tcell"</span> </span>
<span id="cb21-41">    y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(labels<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span>celltype)</span>
<span id="cb21-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>){</span>
<span id="cb21-43">      roc_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">roc</span>(y, x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb21-44">      res[,(labelname)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">auc</span>(roc_obj))]</span>
<span id="cb21-45">    }</span>
<span id="cb21-46">    pdlbl[[labelname]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb21-47">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">spec=</span>roc_obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>specificities, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sens=</span>roc_obj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sensitivities,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">marker=</span>marker)[,label<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span>labelname][<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,.N,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), .N))]</span>
<span id="cb21-48">  }</span>
<span id="cb21-49">  plotdata_markerl[[ii]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbindlist</span>(pdlbl)[,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">:=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">celltype =</span> celltype, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">marker=</span>marker, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">typ =</span> typ)]</span>
<span id="cb21-50">  aucrocl[[ii]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data.table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(res) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#return(res)</span></span>
<span id="cb21-51">}</span></code></pre></div>
</div>
</section>
<section id="average-auc-across-markers-and-celltypes" class="level4" data-number="7.0.0.1">
<h4 data-number="7.0.0.1" class="anchored" data-anchor-id="average-auc-across-markers-and-celltypes"><span class="header-section-number">7.0.0.1</span> Average AUC across markers and celltypes</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">aucroc[celltype<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mast"</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(.SD, mean),.SDcols<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]</span></code></pre></div>
</div>
</section>
<section id="t-cell-roc-curves" class="level4" data-number="7.0.0.2">
<h4 data-number="7.0.0.2" class="anchored" data-anchor-id="t-cell-roc-curves"><span class="header-section-number">7.0.0.2</span> T cell ROC curves</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">  methcls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#9D4EA3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#377EB8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E41A1C"</span>)</span>
<span id="cb23-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(methcls) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"multiomic typing"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna-only cell typing"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"protein-only cell typing"</span>)</span>
<span id="cb23-3"></span>
<span id="cb23-4">  shw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbindlist</span>(plotdata_markerl)[marker <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD2"</span>)]</span>
<span id="cb23-5">  shw[,method<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(label, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_multi_major"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_rna_major"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_protein_major"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"multiomic typing"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna-only cell typing"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"protein-only cell typing"</span>))]</span>
<span id="cb23-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(shw, aucrocl)</span>
<span id="cb23-7">  data.table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setnames</span>(shw, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typ"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"analyte"</span>))</span>
<span id="cb23-8">  shw[,marker<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(marker, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD2"</span>))]</span>
<span id="cb23-9">  shw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shw[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(marker)]</span>
<span id="cb23-10">  aucroc[marker <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shw<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>marker]</span>
<span id="cb23-11">  rocplot_tcell <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb23-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(shw, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>spec), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> sens,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> method,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>method)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>marker <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> analyte, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labeller=</span>label_both) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"specificity"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sensitivity"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#scale_color_manual(values = brewer.pal(8,"Set1")[c(1:2,3)]</span></span>
<span id="cb23-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> methcls</span>
<span id="cb23-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#scale_color_manual(values = brewer.pal(8,"Dark2")[c(1:3)]</span></span>
<span id="cb23-20">                       , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)))  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  </span>
<span id="cb23-23">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ROC curve with T cell RNA and protein markers:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Multimomic integrated celltyping outperforms</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">either RNA or protein alone when considering cell type markers measured on both analytes"</span>)</span>
<span id="cb23-24">  </span>
<span id="cb23-25">  lbld <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb23-26">    aucroc[marker <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shw<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>marker]</span>
<span id="cb23-27">  lbld <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">melt</span>(lbld, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id.vars=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"marker"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typ"</span>),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value.name=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auc"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable.name=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label"</span>)</span>
<span id="cb23-28">  lbld[,method<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(label</span>
<span id="cb23-29">                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_multi_major"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_rna_major"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_protein_major"</span>)</span>
<span id="cb23-30">                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"multiomic typing"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna-only cell typing"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"protein-only cell typing"</span>))]</span>
<span id="cb23-31">  lbld[,marker<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(marker, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD2"</span>))]</span>
<span id="cb23-32">  lbld[,analyte<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span>typ]</span>
<span id="cb23-33">  lbld[,lbl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(method, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" auc="</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">formatC</span>(auc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))]</span>
<span id="cb23-34">  lbld[,spec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>]</span>
<span id="cb23-35">  lbld[,sens<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(lbld<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>method)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>]</span>
<span id="cb23-36">  rocplot_tcell_lbl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rocplot_tcell <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>lbld, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> lbl),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb23-37">  </span>
<span id="cb23-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot=</span>rocplot_tcell_lbl</span>
<span id="cb23-39">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"figures/rocplot_tcell_lbl.png"</span></span>
<span id="cb23-40">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1372</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>)</span>
<span id="cb23-41">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">742</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>)</span>
<span id="cb23-42">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpi =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span></span>
<span id="cb23-43">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'px'</span></span>
<span id="cb23-44">  )</span></code></pre></div>
</div>
</section>
<section id="auc-barplots" class="level4" data-number="7.0.0.3">
<h4 data-number="7.0.0.3" class="anchored" data-anchor-id="auc-barplots"><span class="header-section-number">7.0.0.3</span> AUC barplots</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">  methcls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#9D4EA3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#377EB8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E41A1C"</span>)</span>
<span id="cb24-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(methcls) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_multi_major"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_rna_major"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_protein_major"</span>)</span>
<span id="cb24-3">  mroc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">melt</span>(aucroc</span>
<span id="cb24-4">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id.vars=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"marker"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"typ"</span>)</span>
<span id="cb24-5">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value.name=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auc"</span></span>
<span id="cb24-6">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable.name=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"method"</span></span>
<span id="cb24-7">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable.factor =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb24-8">  )</span>
<span id="cb24-9">  mroc[,celltype<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(celltype, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tcell"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bcell"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage_monocyte"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dendritic"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"neutrophil"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nk"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mast"</span>))]</span>
<span id="cb24-10">  mroc[,marker_label<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(marker, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" ("</span>, typ, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">")"</span>)]</span>
<span id="cb24-11">  mroc[,marker_label<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(marker_label,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span>mroc[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(celltype,typ, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>auc),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(marker_label)])]</span>
<span id="cb24-12">  aucbar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb24-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mroc[celltype<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mast"</span>]</span>
<span id="cb24-14">           ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> marker_label, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> auc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>method)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb24-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'identity'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb24-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb24-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> methcls <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#brewer.pal(3,"Set1")#unname(pals::alphabet())</span></span>
<span id="cb24-18">                      , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb24-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>celltype, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labeller=</span>label_both,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb24-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Agreement between celltype label and marker gene/protein as measured by area under the ROC curve"</span></span>
<span id="cb24-21">        ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"area under the ROC curve"</span>)</span>
<span id="cb24-22">  </span>
<span id="cb24-23">  </span>
<span id="cb24-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot=</span>aucbar</span>
<span id="cb24-25">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"figures/aucbarplot.png"</span></span>
<span id="cb24-26">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1430</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb24-27">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">874</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb24-28">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'px'</span></span>
<span id="cb24-29">  )</span>
<span id="cb24-30"></span>
<span id="cb24-31">  aucbar_with_text <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  </span>
<span id="cb24-32">  aucbar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">formatC</span>(auc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>))  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb24-33">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_cartesian</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clip =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb24-34">  </span>
<span id="cb24-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot=</span>aucbar_with_text </span>
<span id="cb24-36">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"figures/aucbarplot_wtext.png"</span></span>
<span id="cb24-37">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1430</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb24-38">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">874</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb24-39">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpi =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span></span>
<span id="cb24-40">         ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'px'</span></span>
<span id="cb24-41">  )</span></code></pre></div>
</div>


<!-- -->


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-ariref" class="csl-entry">
Rand, William M. 1971. <span>“Objective Criteria for the Evaluation of Clustering Methods.”</span> <em>Journal of the American Statistical Association</em> 66 (336): 846–50. <a href="https://doi.org/10.1080/01621459.1971.10482356">https://doi.org/10.1080/01621459.1971.10482356</a>.
</div>
</div></section></div> ]]></description>
  <category>cell typing</category>
  <category>algorithms</category>
  <category>multiomics</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-hieratype/</guid>
  <pubDate>Tue, 04 Nov 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-hieratype/figures/rocplot_tcell_lbl.png" medium="image" type="image/png" height="78" width="144"/>
</item>
<item>
  <title>scPearsonPCA: An R package for efficient Principal Components decomposition of pearson residual normalized single cell data</title>
  <dc:creator>Dan McGuire</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca/</link>
  <description><![CDATA[ 





<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>Here we present a package for better dimension reduction in spatial data. Pearson residuals can be an effective normalization method for spatially-resolved transcriptomic data. However, the normalized data matrix produced is <strong>dense</strong> with nearly all values non-zero. This limits the usability of pearson residuals for high-plex or large datasets where computing memory can be a limiting factor.</p>
<p>However, the principal component (PC) decomposition of quasi-poisson pearson residuals can be computed directly from a sparse counts matrix and a few easy-to-calculate summary statistics. The R package <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/scPearsonPCA">scPearsonPCA</a> enables this PC decomposition, including the returning the PCs as if the normalized data had been centered, scaled, and influential values clipped according to common best practices for PC analysis.</p>
<p>In this post we demonstrate a few quick examples for the package, as well as how to use the PCA results returned for common downstream analyses like UMAP and unsupervised clustering.</p>
</section>
<section id="installation" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="installation"><span class="header-section-number">2</span> Installation</h2>
<p>You can install <code>scPearsonPCA</code> using the remotes package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nanostring-Biostats/CosMx-Analysis-Scratch-Space"</span>,</span>
<span id="cb1-2">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subdir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_code/scPearsonPCA"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Main"</span>)</span></code></pre></div>
</div>
</section>
<section id="most-used-functions" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="most-used-functions"><span class="header-section-number">3</span> Most used functions</h2>
<ul>
<li><p><code>sparse_quasipoisson_pca_seurat()</code> This function takes a counts matrix as input and returns a PCA Seurat-style reduction by default. The PCA is based on quasi-poisson pearson residual normalization. Similar to a NormalizeData <img src="https://latex.codecogs.com/png.latex?%5Crightarrow"> ScaleData <img src="https://latex.codecogs.com/png.latex?%5Crightarrow"> RunPCA workflow, arguments available for returning the PCA as if data were centered and scaled, with extreme values clipped.</p></li>
<li><p><code>sparse_quasipoisson_pca_seurat_batch()</code> This function employs a batch-correction method to PCA, provided there is a single categorical variable for ‘batch’. Examples could be ‘patient’, ‘slide_id’, ‘tma_id’, etc. Akin to a quasipoisson glm-based correction with the batch variable used as a covariate, the basic idea here is that gene frequencies are computed separately by batch rather than across the full sample.</p></li>
<li><p><code>sparse_quasipoisson_pca_seurat_multiomic()</code> This function is useful for getting the PCA decomposition from same-cell multiomic data. Here we assume we have two matrices, a sparse RNA counts matrix <code>x</code>, and a (possibly dense,lower dimensional) matrix of already-normalized protein expression <code>xother</code>. We want to be able to get PCA from the combined dataset, while still applying effective normalization to the RNA data. This function uses similar algebraic shortcuts which allow for efficient calculation of PCA from the <strong>covariance matrix</strong> of pearson residuals from the RNA, by deriving PCA from the combined covariance matrix of pre-normalized protein, and pearson-normalized RNA. We’ll demo a full example below using a multiomics breast cancer dataset.</p></li>
</ul>
</section>
<section id="quickstart-example-usage" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="quickstart-example-usage"><span class="header-section-number">4</span> Quickstart / Example Usage</h2>
<p>First we’ll read in our Seurat object dataset. This is 960-plex NSCLC tissue.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setDTthreads</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scPearsonPCA)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggrepel)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">sem <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seurat_obj_nsclc.rds"</span>)</span></code></pre></div>
</div>
</section>
<section id="pearson-pca-using-sparse_quasipoisson_pca_seurat" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="pearson-pca-using-sparse_quasipoisson_pca_seurat"><span class="header-section-number">5</span> Pearson PCA using <code>sparse_quasipoisson_pca_seurat</code></h2>
<p>We typically recommend to use up to 2,000-3,000 highly variable genes for generating PCA results.</p>
<p>A few summary stats used as input for calculating pearson-normalized PCs:</p>
<ul>
<li><code>tc</code> is the total counts per cell across all genes.</li>
<li><code>genefreq</code> is the proportion of transcript calls for each gene across all cells.</li>
</ul>
<p>In general, it’s recommended to calculate these summary stats based on all genes rather than a subset of highly variable genes. While this dataset is only 960-plex, the code below uses 900 highly-variable genes as a demonstration for a basic workflow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">tc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## total counts per cell (across all genes)</span></span>
<span id="cb4-2">genefreq <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gene_frequency</span>(sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## gene frequency (across all cells)</span></span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(genefreq)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TRUE</span></span>
<span id="cb4-4"></span>
<span id="cb4-5">sem <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindVariableFeatures</span>(sem, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nfeatures =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">900</span>)</span>
<span id="cb4-6">hvgs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>assays<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>RNA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>var.features</span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Returns a Seurat-style DimReduc object with </span></span>
<span id="cb4-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### hvgs x pcs feature loadings</span></span>
<span id="cb4-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### cells x pcs cell embeddings</span></span>
<span id="cb4-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### gene-length vector of the mean pearson of residuals</span></span>
<span id="cb4-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### gene-length vector of the standard deviation of pearson residuals</span></span>
<span id="cb4-13">pcaobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb4-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_quasipoisson_pca_seurat</span>(sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[hvgs,]</span>
<span id="cb4-15">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> tc</span>
<span id="cb4-16">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grate =</span> genefreq[hvgs]</span>
<span id="cb4-17">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale.max =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## PCs reflect clipping pearson residuals &gt; 10 SDs above the mean pearson residual</span></span>
<span id="cb4-18">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.scale =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## PCs reflect as if pearson residuals for each gene were scaled to have standard deviation=1</span></span>
<span id="cb4-19">                               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.center =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## PCs reflect as if pearson residuals for each gene were centered to have mean=0</span></span>
<span id="cb4-20">                               )</span></code></pre></div>
</div>
<section id="using-the-output-for-downstream-analysis" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="using-the-output-for-downstream-analysis"><span class="header-section-number">5.1</span> Using the output for downstream analysis</h3>
<p>Here we’ll take the <code>pcaobj</code> we created and add the “<code>DimReduc</code>” to our seurat object. We can use this for downstream Seurat package analysis. Then, we’ll create a UMAP from these PC results using a helper function <code>make_umap</code>, which will also return a cells x cells nearest-neighbors graph we’ll use for unsupervised clustering.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">umapobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_umap</span>(pcaobj)</span>
<span id="cb5-2">sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsonpca"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pcaobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>reduction.data</span>
<span id="cb5-3">sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsonumap"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> umapobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ump  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## umap</span></span>
<span id="cb5-4">sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsongraph"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Graph</span>(umapobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grph) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## nearest neighbors / adjacency matrix used for unsupervised clustering</span></span>
<span id="cb5-5">sem <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindClusters</span>(sem, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">graph =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsongraph"</span>)</span>
<span id="cb5-6">sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pearson_clusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seurat_clusters</span>
<span id="cb5-7">umapplot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_umap</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">umapreduc =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsonumap"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustercol =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearson_clusters"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">semuse =</span> sem)</span>
<span id="cb5-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(umapplot)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca/readmedata/umapplot.png" class="img-fluid figure-img" width="6000"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="batch-corrected-pearson-pca-using-sparse_quasipoisson_pca_seurat_batch" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="batch-corrected-pearson-pca-using-sparse_quasipoisson_pca_seurat_batch"><span class="header-section-number">6</span> Batch corrected Pearson PCA using <code>sparse_quasipoisson_pca_seurat_batch</code></h2>
<p>The syntax is very similar if we want to correct for a batch variable, in this case ‘patient’. A few extra arguments are the cell identifier <code>cellid_colname</code>, batch identifier <code>batch_variable</code>, and a data.frame <code>obs</code> which should include both of these columns.</p>
<p>We also re-compute gene frequency passing these same additional arguments. This returns a genes x batches matrix of gene frequencies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">genefreq_batch <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gene_frequency</span>(sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)[,.(cell_ID, patient)]</span>
<span id="cb6-3">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span></span>
<span id="cb6-4">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">batch_variable =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"patient"</span>)</span>
<span id="cb6-5"></span>
<span id="cb6-6">Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(genefreq_batch)</span>
<span id="cb6-7"></span>
<span id="cb6-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Returns a Seurat-style DimReduc object with </span></span>
<span id="cb6-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### hvgs x pcs feature loadings</span></span>
<span id="cb6-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### cells x pcs cell embeddings</span></span>
<span id="cb6-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### gene-length vector of the mean pearson of residuals</span></span>
<span id="cb6-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### gene-length vector of the standard deviation of pearson residuals</span></span>
<span id="cb6-13">pcaobj_batch <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb6-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_quasipoisson_pca_seurat_batch</span>(sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[hvgs,]</span>
<span id="cb6-15">                                     ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> tc</span>
<span id="cb6-16">                                     ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grate =</span> genefreq_batch[hvgs,] <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##</span></span>
<span id="cb6-17">                                     ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obs =</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)[,.(cell_ID, patient)] </span>
<span id="cb6-18">                                     ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">batch_variable =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"patient"</span></span>
<span id="cb6-19">                                     ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cellid_colname =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span></span>
<span id="cb6-20">                                     ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale.max =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb6-21">                                     ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.scale =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb6-22">                                     ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.center =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb6-23">                                     )</span></code></pre></div>
</div>
<section id="using-the-output-for-downstream-analysis-1" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="using-the-output-for-downstream-analysis-1"><span class="header-section-number">6.1</span> Using the output for downstream analysis</h3>
<p>Here again we’ll take the <code>pcaobj_batch</code> object and use it to create a UMAP and perform unsupervised clustering.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">umapobj_batch <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_umap</span>(pcaobj_batch)</span>
<span id="cb7-2">sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsonbatchpca"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pcaobj_batch<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>reduction.data</span>
<span id="cb7-3">sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsonbatchumap"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> umapobj_batch<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ump</span>
<span id="cb7-4">sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsonbatchgraph"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Graph</span>(umapobj_batch<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grph) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## nearest neighbors / adjacency matrix used for unsupervised clustering</span></span>
<span id="cb7-5">sem <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindClusters</span>(sem, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">graph =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsonbatchgraph"</span>)</span>
<span id="cb7-6">sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pearson_clusters_batch <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seurat_clusters</span>
<span id="cb7-7">umapplotbatch <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_umap</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">umapreduc =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsonbatchumap"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustercol =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearson_clusters_batch"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">semuse =</span> sem)</span>
<span id="cb7-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(umapplotbatch)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca/readmedata/umapplotbatch.png" class="img-fluid figure-img" width="6000"></p>
</figure>
</div>
</div>
</div>
<p>For this dataset, there are epithelial cell clusters which are fairly specific to each patient. This is expected in cancer tissue and may not warrant any batch correction.</p>
<p>For sake of demonstration here, however, we can visualize how the batch variable ‘patient’ separates more on the UMAP before vs.&nbsp;after batch-correction, where patient clusters have higher overlap in UMAP space.</p>
<p>In case of known batch effects, multiple methods of correction may be considered, and the best performing method may well vary from dataset to dataset. One alternative recommended method which often works well is ‘Harmony’, described in this <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/batchcorrection/">post</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">umapplot_patient_batch <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_umap</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">umapreduc =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsonbatchumap"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustercol =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"patient"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">semuse =</span> sem,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb8-2">umapplot_patient <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_umap</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">umapreduc =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pearsonumap"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustercol =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"patient"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">semuse =</span> sem,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb8-3"></span>
<span id="cb8-4">cp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb8-5">cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_grid</span>(umapplot_patient_batch <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMAP using batch-corrected pearson PCs"</span>)</span>
<span id="cb8-6">                   ,umapplot_patient <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMAP using pearson PCs"</span>)</span>
<span id="cb8-7">                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-9">  cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">remove=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)  </span>
<span id="cb8-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(cp)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca/readmedata/umapplot_patient_compare.png" class="img-fluid figure-img" width="6000"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="pearson-pca-for-multiomic-data-using-sparse_quasipoisson_pca_seurat_multiomic" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="pearson-pca-for-multiomic-data-using-sparse_quasipoisson_pca_seurat_multiomic"><span class="header-section-number">7</span> Pearson PCA for multiomic data using <code>sparse_quasipoisson_pca_seurat_multiomic</code></h2>
<p>Below we’ll use a breast cancer dataset with WTx RNA + 64-plex protein to demo multiomic PCA and downstream analysis.</p>
<section id="reading-in-rna-and-protein-datasets" class="level5">
<h5 class="anchored" data-anchor-id="reading-in-rna-and-protein-datasets">Reading in RNA and protein datasets</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Note, using a v3-style Seurat Object below, i.e., `sem[["RNA"]]@counts`</span></span>
<span id="cb9-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## For v5-style, the syntax would be like `sem[["RNA"]]$counts`</span></span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Seurat.object.assay.version =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v3"</span>)  </span>
<span id="cb9-4"></span>
<span id="cb9-5">sem_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Breast/sem_protein.rds"</span>)</span>
<span id="cb9-6">sem_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Breast/sem_rna.rds"</span>)</span>
<span id="cb9-7">sem_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(sem_rna, nCount_RNA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div>
</div>
</section>
<section id="normalizing-the-protein-data" class="level5">
<h5 class="anchored" data-anchor-id="normalizing-the-protein-data">Normalizing the protein data</h5>
<p>The <code>sparse_quasipoisson_pca_seurat_multiomic</code> function won’t do any special normalization to the protein data, so the data should be normalized going in. Here we’ll use pearson residuals from a gamma regression model as a normalization method, although other reasonable methods might be considered and left to the user’s disgression.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## normalize each protein taking pearson residuals from gamma generalized linear model.</span></span>
<span id="cb10-2">pgamm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pearson_normalize_gamma_glm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(sem_protein[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts)</span>
<span id="cb10-3">                                                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper_q_thresh =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span></span>
<span id="cb10-4">                                                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower_q_thresh =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb10-5">                                                   )</span>
<span id="cb10-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### add a '_protein' suffix to the protein names - helps differentiate proteins and RNA's with the same name. </span></span>
<span id="cb10-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pgamm), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_protein"</span>)</span>
<span id="cb10-8"></span>
<span id="cb10-9">pgamm[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>] <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## normalized protein data</span></span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>                      c_1_100_1  c_1_100_10 c_1_100_100 c_1_100_1000
4-1BB_protein        -0.1592977  0.03704303  0.48381341 -0.054332422
B7-H3_protein        -0.2409877 -0.08788226  0.08696422  0.006506165
Bcl-2_protein        -0.3037842 -0.26226294  0.26853206 -0.278620332
Beta-catenin_protein -0.7617500 -0.06967635  0.14393940 -0.430273385
CCR7_protein         -0.1174789 -0.21163185  0.24066117  5.283740671
                     c_1_100_1001
4-1BB_protein          -0.0686042
B7-H3_protein           0.8100425
Bcl-2_protein          -0.2199310
Beta-catenin_protein   -0.3508033
CCR7_protein           -0.3366898</code></pre>
</div>
</div>
</section>
<section id="pca-analysis-derived-from-the-joint-covariance-matrix-of-the-the-proteins-and-rnas" class="level5">
<h5 class="anchored" data-anchor-id="pca-analysis-derived-from-the-joint-covariance-matrix-of-the-the-proteins-and-rnas">PCA analysis derived from the joint covariance matrix of the the proteins and RNAs</h5>
<p>First we’ll identify a subset of highly variable genes from the RNA data. Then , we’ll pass in the RNA counts matrix and normalized protein matrix to get the PCA.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## select genes from RNA data to use for PCA analysis.</span></span>
<span id="cb12-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Will take the top 2k features as well as any pre-defined immune celltyping markers from HieraType</span></span>
<span id="cb12-3">sem_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindVariableFeatures</span>(sem_rna, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nfeatures =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>)</span>
<span id="cb12-4">use_genes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>assays<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>RNA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>var.features)</span>
<span id="cb12-5"></span>
<span id="cb12-6"></span>
<span id="cb12-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### total counts and gene frequency from RNA data computed across full dataset</span></span>
<span id="cb12-8">tc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts)</span>
<span id="cb12-9">genefreq <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gene_frequency</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts)</span>
<span id="cb12-10"></span>
<span id="cb12-11"></span>
<span id="cb12-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Principal components derived from the combined covariance matrix of pearson residual normalized RNA and protein.</span></span>
<span id="cb12-13">pcaobj_multiomics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sparse_quasipoisson_pca_seurat_multiomic</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[use_genes,] <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## raw counts matrix for hvgs</span></span>
<span id="cb12-14">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> tc</span>
<span id="cb12-15">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grate =</span> genefreq[use_genes]</span>
<span id="cb12-16">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xother =</span> pgamm <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## normalized protein</span></span>
<span id="cb12-17">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.scale =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb12-18">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">do.center =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb12-19">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale.max =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb12-20">                                                                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-21">)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>PC_ 1 
Positive:  CD127_protein, pan-RAS_protein, p53_protein, EGFR_protein, TCF7_protein, NF-kB p65_protein, Channel-PanCK_protein, CTLA4_protein, EpCAM_protein, Beta-catenin_protein 
       LAMP1_protein, Ki-67_protein, AZGP1, FASN, SERHL2, DBI, KRT19, CD138_protein, PIP, NAMPT 
Negative:  CD39_protein, CD16_protein, CD40_protein, CD45_protein, VIM, CD4_protein, SPARC, CD74, COL1A1, COL3A1 
       HLA-DRB1, COL1A2, STING_protein, HLA-DRA, CTSB, CST3, SMA_protein, APOE, Vimentin_protein, ICAM1_protein 
PC_ 2 
Positive:  KRT19, AFMID, SERHL2, KRT8, FOXP3_protein, p53_protein, KRT7, CYP1B1, IgD_protein, LAG3_protein 
       ALDOA, MLPH, XBP1, NDRG1, CD24, CD123_protein, PGK1, Her2_protein, Channel-PanCK_protein, CD56_protein 
Negative:  H3C15, H4C14, H4C11, H3-7, H2BC4, H3C2, H4C12, H3C13, H2AC18, H2BC18 
       H3C10, H1-2, H3C7, H2BC9, H2AC16, H1-5, H2BC12L, H2AC11, H3C11, H3C8 
PC_ 3 
Positive:  CD34_protein, CD123_protein, CD31_protein, COL4A1, SPARC, IGFBP7, COL4A2, PLVAP, GZMB_protein, SMA_protein 
       CD56_protein, HSPG2, LAG3_protein, FOXP3_protein, COL3A1, COL1A2, COL1A1, IgD_protein, LAMA4, COL6A2 
Negative:  HLA-DRB1, CD74, HLA-DRA, APOE, Channel-CD68_protein, CTSD, HLA-DR_protein, LYZ, CD11c_protein, HLA-DQB1 
       IFI30, CD68_protein, APOC1, HLA-DPA1, C1QC, GPNMB, CD45_protein, C1QB, HLA-DQA1, CTSB 
PC_ 4 
Positive:  PD-L2_protein, GITR_protein, FOXP3_protein, 4-1BB_protein, LAG3_protein, CD56_protein, GZMB_protein, COL1A1, iNOS_protein, IgD_protein 
       Her2_protein, COL1A2, COL3A1, AEBP1, PD-1_protein, GZMA_protein, LUM, CD11b_protein, FN1, COL12A1 
Negative:  PLVAP, CD34_protein, CD31_protein, COL4A1, A2M, EGFL7, AQP1, FLT1, KDR, COL4A2 
       HSPG2, SHANK3, PODXL, PECAM1, ENG, CD34, MCAM, ECSCR, INSR, NHERF2 
PC_ 5 
Positive:  COL1A1, COL1A2, COL3A1, FN1, AEBP1, POSTN, LUM, COL6A3, COL12A1, C1S 
       THBS2, FBN1, SULF1, COL6A1, COL5A1, HTRA3, SFRP2, EpCAM_protein, Beta-catenin_protein, CTHRC1 
Negative:  CD123_protein, GZMB_protein, FOXP3_protein, PD-L2_protein, LAG3_protein, iNOS_protein, CD56_protein, 4-1BB_protein, Her2_protein, GITR_protein 
       IgD_protein, CD31_protein, CD11b_protein, CD34_protein, CD68_protein, GZMA_protein, PD-1_protein, STING_protein, A2M, PLVAP </code></pre>
</div>
</div>
</section>
<section id="using-the-output-for-downstream-analysis-2" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="using-the-output-for-downstream-analysis-2"><span class="header-section-number">7.1</span> Using the output for downstream analysis</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">umapobj_multiomics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scPearsonPCA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_umap</span>(pcaobj_multiomics)</span>
<span id="cb14-2"></span>
<span id="cb14-3"></span>
<span id="cb14-4">sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"multiumap"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> umapobj_multiomics<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ump</span>
<span id="cb14-5">sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"multigrph"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Graph</span>(umapobj_multiomics<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grph[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(sem_rna),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(sem_rna)])</span>
<span id="cb14-6">sem_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindClusters</span>(sem_rna, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">graph.name=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"multigrph"</span>)</span>
<span id="cb14-7">sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clusters_multi_unsup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seurat_clusters</span>
<span id="cb14-8"></span>
<span id="cb14-9"></span>
<span id="cb14-10">xyp_multi_unsup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xyplot</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clusters_multi_unsup"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ptsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>()</span>
<span id="cb14-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(xyp_multi_unsup)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca/readmedata/xyp_multi_unsup.png" class="img-fluid figure-img" width="2640"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">umapp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_umap</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">umapreduc =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"multiumap"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clustercol =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clusters_multi_unsup"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">semuse =</span> sem_rna)</span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(umapp)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca/readmedata/umapp_multi.png" class="img-fluid figure-img" width="2640"></p>
</figure>
</div>
</div>
</div>
<section id="rna-and-protein-marker-heatmaps" class="level4" data-number="7.1.1">
<h4 data-number="7.1.1" class="anchored" data-anchor-id="rna-and-protein-marker-heatmaps"><span class="header-section-number">7.1.1</span> RNA and protein marker heatmaps</h4>
<p>Below we’ll look at a couple of marker heatmaps for these unsupervised clusters. These functions below use the <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/HieraType">HieraType package</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#remotes::install_github("Nanostring-Biostats/CosMx-Analysis-Scratch-Space", </span></span>
<span id="cb16-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#                        subdir = "_code/HieraType", ref = "Main")</span></span>
<span id="cb16-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(HieraType)</span>
<span id="cb16-4"></span>
<span id="cb16-5">fctbl_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics</span>(sem_rna[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[use_genes,]</span>
<span id="cb16-6">                                            ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totalcounts =</span> tc</span>
<span id="cb16-7">                                            ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data</span>
<span id="cb16-8">                                            ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clusters_multi_unsup"</span></span>
<span id="cb16-9">                                            )</span>
<span id="cb16-10"></span>
<span id="cb16-11">hm_rna <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_ncells</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_heatmap</span>(fctbl_rna)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna heatmap"</span>)</span>
<span id="cb16-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(hm_rna)</span></code></pre></div>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca/readmedata/hm_rna_multi.png" alt="Wide Image"></p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">fctbl_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics_protein</span>(sem_protein[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)]</span>
<span id="cb17-2">                                                        ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data</span>
<span id="cb17-3">                                                        ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clusters_multi_unsup"</span></span>
<span id="cb17-4">                                                        ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">propd =</span> (pgamm[,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(sem_rna<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb17-5">                                            )</span>
<span id="cb17-6">hm_protein <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_ncells</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_heatmap</span>(fctbl_protein)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"protein heatmap"</span>)</span>
<span id="cb17-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(hm_protein)</span></code></pre></div>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca/readmedata/hm_protein_multi.png" alt="Wide Image"></p>
</div>


<!-- -->

</section>
</section>
</section>

 ]]></description>
  <category>normalization</category>
  <category>pearson residuals</category>
  <category>principal component analysis</category>
  <category>batch correction</category>
  <category>multiomics</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca/</guid>
  <pubDate>Thu, 30 Oct 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/pearsonpca/readmedata/umapplot.png" medium="image" type="image/png" height="112" width="144"/>
</item>
<item>
  <title>Differential expression: best practices and advanced techniques</title>
  <dc:creator>Patrick Danaher</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/</link>
  <description><![CDATA[ 





<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>CosMx (R) SMI analyses often culminate in a differential expression (DE) analysis. Exploratory analyses uncover all manner of interesting trends, and then these trends suggest hypotheses that can be tested with DE. A surprising breadth of questions can be framed as DE problems. To give a few examples:</p>
<ul>
<li>How do tumor cells respond to the presence of T-cells?</li>
<li>How do microglia activate in regions of inflammation?</li>
<li>How do microglia differ across brain regions?</li>
<li>How do T-cells change as they get farther from blood vessels?</li>
<li>How do fibroblasts respond to signaling from ligands in nearby cells?</li>
<li>How are macrophages different in inflamed tissue regions?</li>
<li>How do beta cells in pancreatic islets respond to local inflammation?</li>
</ul>
<p>Or, in the general form:</p>
<p>“How does <em>my favorite cell type</em> change in response to <em>some aspect of its environment</em>?”</p>
<p>This post reviews major topics in DE in spatial transcriptomics, providing code when necessary.</p>
</section>
<section id="setting-up-a-de-question" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="setting-up-a-de-question"><span class="header-section-number">2</span> Setting up a DE question</h2>
<p>Our experience suggests that most studies demand a highly custom DE question whose framing depends on the investigator’s primary questions and working assumptions about the biological system. To assist with this framing, we present below a collection of examples which, with slight modifications and remixing, covers most DE investigations you are likely to find productive. In each case we’ll define a variable that can be used as a predictor in DE models.</p>
<section id="important-note-treatment-of-continuous-variables" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="important-note-treatment-of-continuous-variables"><span class="header-section-number">2.1</span> Important note: treatment of continuous variables</h3>
<p>Say we want to run DE against a continuous variable like distance to a cell type, or the expression level of a cytokine in a cell’s neighbors. We can calculate that distance (or neighborhood expression level) and use it as a predictor in our model. However, in doing so we implicitly assume a linear relationship between the variable and our outcome (either linear or log-scale gene expression, depending on the model). Other models might be more appropriate: we could consider transforming the variable, or we could break it into bins for a non-parametric approach. In particular, we have often found that binning of continuous variables produces satisfactory results.</p>
<section id="transformations" class="level4" data-number="2.1.1">
<h4 data-number="2.1.1" class="anchored" data-anchor-id="transformations"><span class="header-section-number">2.1.1</span> Transformations:</h4>
<ul>
<li>If you think distance to a feature matters because of some diffused signals, then concentration of those molecules will vary with 1/distance.</li>
<li>If neighborhood expression of a molecule is strongly right-tailed, which is likely, then a log transformation could prevent the end of the tail from having undue influence.</li>
<li>To make effect sizes more interpretable, scale the variable from 0-1.</li>
<li>For variables with strong skew or long tails, a quantile transformation can prevent extreme values from exerting excess influence on DE results.</li>
</ul>
</section>
<section id="binning-discretizing" class="level4" data-number="2.1.2">
<h4 data-number="2.1.2" class="anchored" data-anchor-id="binning-discretizing"><span class="header-section-number">2.1.2</span> Binning / discretizing:</h4>
<p>You can avoid assumptions about the shape of a variable by binning it, e.g.&nbsp;assigning cells to 20 bins of “distance to nearest T-cell”. Then, you can use a likelihood ratio test against a null model (intercept-only) to test the compound null hypothesis that “this variable predicts expression.” Because we usually have so many cells to work with, the slight loss in statistical power that comes with this approach is usually a cheap tradeoff to make for its flexibility. Also nice: you can use plots like the below to show how each gene changes expression across bins:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/bins.png" class="img-fluid figure-img" style="width:110.0%"></p>
</figure>
</div>
</div>
</div>
<p>Note: When binning, examine the number of cells per bin. If some bins have too few cells to produce stable results, either consider discarding them, or take wider bins.</p>
</section>
<section id="splines-flexibility-without-bins" class="level4" data-number="2.1.3">
<h4 data-number="2.1.3" class="anchored" data-anchor-id="splines-flexibility-without-bins"><span class="header-section-number">2.1.3</span> Splines: flexibility without bins</h4>
<p>Discretizing / binning has one drawback: the fit to discretized variables can be highly discontinuous, e.g.&nbsp;with a single bin having a large estimated effect size. It often makes sense to assume your design variable’s impact on gene expression varies smoothly across its range. To achieve this, you can use splines:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define a continuous variable:</span></span>
<span id="cb1-2">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>)</span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fit splines to it, producing a matrix of 10 dimensions:</span></span>
<span id="cb1-4">splinex <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(splines<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ns</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>))</span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the "splinex" matrix can now be input into DE models</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># how splinex relates to x:</span></span>
<span id="cb1-8">o <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(x)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, splinex[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spline values"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex.lab =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.3</span>)</span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draw each spline as a line:</span></span>
<span id="cb1-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(splinex)) {</span>
<span id="cb1-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(x[o], splinex[o, i], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>))</span>
<span id="cb1-13">}</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/splines.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
<p>To measure a gene’s significance when using splines, use a likelihood ratio test against an intercept-only null model, just as you would with a binned variable. To explore your results, plot mean values across bins for your most significant genes as in the above heatmap.</p>
</section>
</section>
<section id="example-data" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="example-data"><span class="header-section-number">2.2</span> Example data</h3>
<p>First, let’s pull in data in a standard format. We’ll assume you’re starting with flat files exported from AtoMx, read into R as demonstrated in our basic analysis vignettes.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Expected inputs:</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - counts: a sparse matrix of expression in cells * genes</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - metadata: a data frame or data table of cell metadata, aligned by row to counts</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - xy: a 2-column matrix of xy positions, aligned by row to counts</span></span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Further calculations: get normalized counts:</span></span>
<span id="cb2-7">norm_factors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA </span>
<span id="cb2-8">norm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> norm_factors) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> counts</span></code></pre></div>
</details>
</div>
<p>For our examples, we’ll look at a subset of data from a breast tumor. Our metadata picks up midway through an analysis: we already have cell types and niche calls in the metadata. Here’s a glance at all the metadata we’ll use:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(meta_data)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/metadatatable.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
<p>…and the sample itself:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">clustcols  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tumor=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#C4B7A6"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Macrophage=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#D55E00"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Fibroblast=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#009E73"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dendritic=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#CC79A7"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Necrotic cells</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#999999"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tcell=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0072B2"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Plasma=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#56B4E9"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neutrophil=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E69F00"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">innate_lymphoid=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F0E442"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Vasculature=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#800000"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nk=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#117733"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mast=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A65628"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bcell=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#6A3D9A"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Unknown=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#666666"</span>)</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb4-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-5">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> clustcols[meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb4-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topleft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> clustcols, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(clustcols), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/celltypemap.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="gallery-of-differential-expression-setups" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="gallery-of-differential-expression-setups"><span class="header-section-number">2.3</span> Gallery of Differential Expression setups</h3>
<p>Below we demonstrate a variety of ways to define predictor variables for DE. In each case, we’ll plot the variable spatially and provide code for defining it.</p>
<section id="niche-spatial-domain-unsupervised" class="level4" data-number="2.3.1">
<h4 data-number="2.3.1" class="anchored" data-anchor-id="niche-spatial-domain-unsupervised"><span class="header-section-number">2.3.1</span> Niche / spatial domain (unsupervised)</h4>
<p>A great many algorithms exist for clustering cellular neighborhoods into niches / spatial domains. Lately we favor the Novae algorithm. However you define niches, they’re often a reasonable basis for a DE analysis.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## (use pre-calculated niche)</span></span>
<span id="cb5-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## plot niche:</span></span>
<span id="cb5-3">inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor"</span></span>
<span id="cb5-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb5-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy[inds, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb5-6">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor cells colored by niche"</span>,</span>
<span id="cb5-7">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orange"</span>)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>niche[inds]))],</span>
<span id="cb5-8">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb5-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>inds, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>)</span>
<span id="cb5-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topleft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodgerblue3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orange"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"niche = "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>niche[inds]))), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/niche.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="custom-defined-niche" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="custom-defined-niche"><span class="header-section-number">2.4</span> Custom-defined niche</h3>
<p>Niches defined through a spatial clustering algorithm are useful for exploring a dataset, but often they are not perfectly aligned to your understanding of a tissue. It is therefore often necessary to define niches by hand, to capture precisely the biology you want. Examples include anatomical structures like cortical layers in the brain, disease states like areas of inflammation, or custom constructs like “near vs.&nbsp;far from glomeruli”.</p>
<p>In general, such partitions of the data can be built by applying the code of the following examples, using thresholds to dichotomize continuous variables as needed.</p>
<p>For example, in a past anaylsis of a kidney, we defined niches as follows:</p>
<ul>
<li>“glomeruli”: cells with &gt;30% of their nearest neighbors being glomerulus-specific cell types (podocyte, mesangial cell, glomerular endothelial cells).</li>
<li>“glomerular boundary”: cells within a fixes distance of glomeruli</li>
<li>“tubulointerstitium”: everything else</li>
<li>“immune hotspots”: cells with &gt;10 immune cells in their nearest neighbors. This overrode all the above annotations.</li>
</ul>
<p>This approach was driven by our knowledge of the tissue and by our biological questions.</p>
</section>
<section id="distance-to-nearest-cell-from-a-given-cluster-group" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="distance-to-nearest-cell-from-a-given-cluster-group"><span class="header-section-number">2.5</span> Distance to nearest cell from a given cluster / group</h3>
<p>A common and productive DE question is: how does my favorite cell type change with proximity to another cell type?</p>
<p>To demonstrate how to ask this kind of question, below we score tumor cells by their distance to the nearest T-cell:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Calculate tumor cells' distance to nearest T-cell:</span></span>
<span id="cb6-2">inds.tumor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor"</span></span>
<span id="cb6-3">inds.t     <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tcell"</span></span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(inds.tumor), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(inds.t))</span>
<span id="cb6-5">dist2tcell <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> FNN<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get.knnx</span>(</span>
<span id="cb6-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(xy[inds.t, , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]),</span>
<span id="cb6-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">query =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(xy),</span>
<span id="cb6-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-9">)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.dist[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb6-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># store in metadata:</span></span>
<span id="cb6-11">meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dist2tcell <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dist2tcell</span>
<span id="cb6-12"></span>
<span id="cb6-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## plot tumor cells, coloring by distance to T-cell:</span></span>
<span id="cb6-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb6-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy[inds.tumor, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb6-16">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor cells colored by distance to T-cell"</span>,</span>
<span id="cb6-17">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A6CEE3"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1F78B4"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#081D58"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb6-18">       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dist2tcell <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(dist2tcell))</span>
<span id="cb6-19">     ][inds.tumor],</span>
<span id="cb6-20">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb6-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>inds.tumor, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wheat"</span>)</span>
<span id="cb6-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[inds.t, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)</span>
<span id="cb6-23"></span>
<span id="cb6-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topleft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1F78B4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wheat"</span>), </span>
<span id="cb6-25">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor cells (colored by distance to T-cells)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T-cells"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"other cells"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/dist2tcell.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="distance-to-nearest-cell-from-an-anatomical-structure" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="distance-to-nearest-cell-from-an-anatomical-structure"><span class="header-section-number">2.6</span> Distance to nearest cell from an anatomical structure</h3>
<p>Many cell types fall in structures, e.g.&nbsp;blood vessels, tumor glands, or glomeruli. When calculating distance to a structure, it is tempting to simply record distance to the nearest relevant cell type, e.g.&nbsp;endothelial cells for blood vessels, or tumor cells for tumor glands, or podocytes and mesangial cells for glomeruli. However, this approach is easily distorted by sporadic cell typing errors. It is more robust to look at distance to the nearest <em>spatially contiguous group</em> of the target cell type.</p>
<p>Below, we’ll define an annotation for ‘vascular structure’, based on contiguous groups of endothelial cells. We use DBSCAN algorithm, an incredibly fast algorithm which can cluster together cells within a fixed radius of each other. We’ll keep only cells that fall in clusters of at least 3.</p>
<p>First let’s look at our target cell type:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## show the target cell type: vasculature</span></span>
<span id="cb7-2">inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vasculature"</span></span>
<span id="cb7-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb7-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy[, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb7-5">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vasculature"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>,</span>
<span id="cb7-6">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb7-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[inds, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkred"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/vessel.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
<p>Then retain only the spatially-contiguous groups:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## use dbscan to isolate clusters of Vasculature cells:</span></span>
<span id="cb8-2">db <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dbscan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbscan</span>(xy[inds, ],</span>
<span id="cb8-3">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># very small radius</span></span>
<span id="cb8-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minPts =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cluster</span>
<span id="cb8-5">inds.in.clusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> db <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb8-6">is.vessel <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> inds</span>
<span id="cb8-7">is.vessel[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(inds)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> inds.in.clusters</span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># store in metadata:</span></span>
<span id="cb8-9">meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>is.vessel <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> is.vessel</span>
<span id="cb8-10"></span>
<span id="cb8-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## show the result:</span></span>
<span id="cb8-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb8-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy[, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb8-14">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vasculature after filter with dbscan"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>,</span>
<span id="cb8-15">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb8-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[inds <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is.vessel,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>)</span>
<span id="cb8-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[is.vessel, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)</span>
<span id="cb8-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topleft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>), </span>
<span id="cb8-19">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Blood vessel cells"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vasculature cells excluded by dbscan"</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/vesseldb.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
<p>After obtaining this cleaned up annotation, we could then take the distance to it using<br>
code from the tumor distance to T-cell example earlier.</p>
</section>
<section id="number-of-a-given-cell-type-in-a-neighborhood" class="level3" data-number="2.7">
<h3 data-number="2.7" class="anchored" data-anchor-id="number-of-a-given-cell-type-in-a-neighborhood"><span class="header-section-number">2.7</span> Number of a given cell type in a neighborhood</h3>
<p>Another common question: how does a cell type change in response to the abundance of another cell type in its neighborhood? Here we’ll log-transform our predictor to acknowledge the probability of diminishing effects of each new T-cell in a tumor cell’s neighborhood.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Calculate the number of T-cells in each tumor cell's neighborhood:</span></span>
<span id="cb9-2">inds.tumor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor"</span></span>
<span id="cb9-3">inds.t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tcell"</span></span>
<span id="cb9-4"></span>
<span id="cb9-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the 50 nearest neighbors of each cell:</span></span>
<span id="cb9-6">neighbors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nearestNeighborGraph</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (or alternatively, get neighbors within a radius of 0.1mm):</span></span>
<span id="cb9-8">neighbors.radius <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">radiusBasedGraph</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb9-9"></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># count the T-cells among cells' neighbors:</span></span>
<span id="cb9-11">neighboring.tcells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">neighbor_sum</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tcell"</span>),</span>
<span id="cb9-12">                                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbors =</span> neighbors)</span>
<span id="cb9-13">log.neighboring.tcells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> neighboring.tcells)</span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># store in metadata:</span></span>
<span id="cb9-15">meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>log.neighboring.tcells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> log.neighboring.tcells</span>
<span id="cb9-16"></span>
<span id="cb9-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># color tumor cells by the number of T-cell neighbors:</span></span>
<span id="cb9-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb9-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy[inds.tumor, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb9-20">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor cells colored by log2(number of T-cell neighbors)"</span>,</span>
<span id="cb9-21">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A6CEE3"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1F78B4"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#081D58"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb9-22">       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> log.neighboring.tcells <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(log.neighboring.tcells))</span>
<span id="cb9-23">     ][inds.tumor],</span>
<span id="cb9-24">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb9-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>inds.tumor, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wheat"</span>)</span>
<span id="cb9-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[inds.t, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)</span>
<span id="cb9-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topleft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1F78B4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wheat"</span>), </span>
<span id="cb9-28">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor cells colored by log2(number of neighboring T-cells)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T-cells"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"other cells"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/ntcells.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="gene-expression-in-cells-neighborhoods" class="level3" data-number="2.8">
<h3 data-number="2.8" class="anchored" data-anchor-id="gene-expression-in-cells-neighborhoods"><span class="header-section-number">2.8</span> Gene expression in cells’ neighborhoods</h3>
<p>To investigate how a gene impacts nearby cells, we can run differential expression against the gene’s total expression in each cell’s neighborhood. Below, we score macrophages for the total abundance of CXCL14 in their neighborhoods. This sets us up for DE studies of how macrophages respond to signaling from CXCL14. In the below example, we take the additional step of log-transforming neighborhood CXCL14.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## get average CXCL14 expression in each cell's neighborhood:</span></span>
<span id="cb10-2"></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the 50 nearest neighbors of each cell:</span></span>
<span id="cb10-4">neighbors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nearestNeighborGraph</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (or alternatively, get neighbors within a radius of 0.1mm):</span></span>
<span id="cb10-6">neighbors.radius <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">radiusBasedGraph</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb10-7"></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normalized CXCL14:</span></span>
<span id="cb10-9">normvals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> counts[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CXCL14"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA</span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get average CXCL14 expression in each cell's neighborhood:</span></span>
<span id="cb10-11">neighboring.cxcl14 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> InSituCor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">neighbor_sum</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> normvals,</span>
<span id="cb10-12">                                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbors =</span> neighbors)</span>
<span id="cb10-13">log2.neighboring.cxcl14 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> neighboring.cxcl14)</span>
<span id="cb10-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add to metadata:</span></span>
<span id="cb10-15">meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>log2.neighboring.cxcl14 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> log2.neighboring.cxcl14</span>
<span id="cb10-16"></span>
<span id="cb10-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## plot macrophages, coloring by local CXCL14 expression:</span></span>
<span id="cb10-18">inds.mac <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Macrophage"</span></span>
<span id="cb10-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb10-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wheat"</span>,</span>
<span id="cb10-21">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Macrophages colored by log2(neighborhood CXCL14 expression)"</span>,</span>
<span id="cb10-22">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb10-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[inds.mac, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, </span>
<span id="cb10-24">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A6CEE3"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1F78B4"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#081D58"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb10-25">       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> log2.neighboring.cxcl14 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(log2.neighboring.cxcl14))</span>
<span id="cb10-26">     ][inds.mac])</span>
<span id="cb10-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topleft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1F78B4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wheat"</span>), </span>
<span id="cb10-28">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Macrophages colored by log2(neighborhood CXCL14 expression)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"other cells"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/cxcl14.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="distance-to-a-hand-selected-region" class="level3" data-number="2.9">
<h3 data-number="2.9" class="anchored" data-anchor-id="distance-to-a-hand-selected-region"><span class="header-section-number">2.9</span> Distance to a hand-selected region</h3>
<p>Sometimes it’s easier to select a region of a tissue by hand than to devise a computational rule to do so. If your study has e.g.&nbsp;hundreds of glomeruli, you probably want a rule to define in/out of a glomerulus. But if your study has e.g.&nbsp;just a few tertiary lymphoid structures, it’s probably simpler to circle them by hand. Below is code for hand-drawing Regions Of Interest (ROIs) and flagging cells as in/out of them:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' Define roi's by Clicking on cells in a graphics window</span></span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' </span></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' How to use:</span></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \itemize{</span></span>
<span id="cb11-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Plot your cells in xy space. Use asp = 1. </span></span>
<span id="cb11-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Click cells around the boundary of your roi.</span></span>
<span id="cb11-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Hit enter or escape when done with your selection.</span></span>
<span id="cb11-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' }</span></span>
<span id="cb11-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' Other details:</span></span>
<span id="cb11-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \itemize{</span></span>
<span id="cb11-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Uses graphics::identify() to select points. </span></span>
<span id="cb11-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Only works for base graphics, not ggplots.</span></span>
<span id="cb11-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item Can go wrong (draw rois in the wrong place) if the plot doesn't have asp = 1. </span></span>
<span id="cb11-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' }</span></span>
<span id="cb11-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param xy Matrix of xy positions used in the plot. </span></span>
<span id="cb11-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param show Logical, for whether to show the selected roi when you're done. </span></span>
<span id="cb11-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @param type One of:</span></span>
<span id="cb11-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \itemize{</span></span>
<span id="cb11-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item "direct" to define the boundary points in order, exactly as you click</span></span>
<span id="cb11-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item "ahull" to draw an alpha hull around your selection</span></span>
<span id="cb11-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' } </span></span>
<span id="cb11-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @return A list with 3 elements:</span></span>
<span id="cb11-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \itemize{</span></span>
<span id="cb11-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item roi: The indices of the points in the roi</span></span>
<span id="cb11-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item selected: The indices of the user-selected points</span></span>
<span id="cb11-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' \item hull: The hull of the roi, either the user-selected polygon or the results of alphahull:ahull}</span></span>
<span id="cb11-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @importFrom graphics identify</span></span>
<span id="cb11-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @importFrom alphahull ahull</span></span>
<span id="cb11-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' @</span></span>
<span id="cb11-30">defineROI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"direct"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">boundary_points =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb11-31">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(boundary_points)) {</span>
<span id="cb11-32">    hull.x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> boundary_points[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb11-33">    hull.y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> boundary_points[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb11-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get points in the boundary:</span></span>
<span id="cb11-35">    roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">point.in.polygon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">point.x =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">point.y =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], </span>
<span id="cb11-36">                                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pol.x =</span> hull.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pol.y =</span> hull.y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb11-37">    inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb11-38">    hull <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb11-39">  }</span>
<span id="cb11-40">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(boundary_points)) {</span>
<span id="cb11-41">    </span>
<span id="cb11-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.element</span>(type, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"direct"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ahull"</span>))) {</span>
<span id="cb11-43">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"must either give boundary_points or set type to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">direct</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> or </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ahull</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb11-44">    }</span>
<span id="cb11-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># user identifies boundary:</span></span>
<span id="cb11-46">    identifyres <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">identify</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">order =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb11-47">    inds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> identifyres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ind[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(identifyres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>order)]</span>
<span id="cb11-48">    </span>
<span id="cb11-49">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"direct"</span>) {</span>
<span id="cb11-50">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The hull is just the polygon you've selected:</span></span>
<span id="cb11-51">      hull.x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xy[inds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb11-52">      hull.y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xy[inds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb11-53">      hull <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> inds</span>
<span id="cb11-54">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get points in the boundary:</span></span>
<span id="cb11-55">      roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">point.in.polygon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">point.x =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">point.y =</span> xy[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], </span>
<span id="cb11-56">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pol.x =</span> hull.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pol.y =</span> hull.y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb11-57">    }</span>
<span id="cb11-58">    </span>
<span id="cb11-59">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ahull"</span>) {</span>
<span id="cb11-60">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get alpha hull of boundary:</span></span>
<span id="cb11-61">      hull <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> alphahull<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ahull</span>(xy[inds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], xy[inds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb11-62">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get points in the boundary:</span></span>
<span id="cb11-63">      roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> alphahull<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inahull</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ahull.obj =</span> hull, xy)</span>
<span id="cb11-64">    }</span>
<span id="cb11-65">    </span>
<span id="cb11-66">  }</span>
<span id="cb11-67">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot:</span></span>
<span id="cb11-68">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (show) {</span>
<span id="cb11-69">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[inds, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb11-70">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">polygon</span>(xy[hull, ])</span>
<span id="cb11-71">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[roi, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gold"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>))</span>
<span id="cb11-72">  }</span>
<span id="cb11-73">  </span>
<span id="cb11-74">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">roi =</span> roi, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">selected =</span> inds, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hull =</span> hull)</span>
<span id="cb11-75">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(out)</span>
<span id="cb11-76">}</span>
<span id="cb11-77"></span>
<span id="cb11-78"></span>
<span id="cb11-79"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## example usage:</span></span>
<span id="cb11-80">clustcols  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tumor=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#C4B7A6"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Macrophage=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#D55E00"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Fibroblast=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#009E73"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dendritic=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#CC79A7"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Necrotic cells</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#999999"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tcell=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0072B2"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Plasma=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#56B4E9"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neutrophil=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E69F00"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">innate_lymphoid=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F0E442"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Vasculature=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#800000"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nk=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#117733"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mast=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A65628"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bcell=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#6A3D9A"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Unknown=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#666666"</span>)</span>
<span id="cb11-81"></span>
<span id="cb11-82"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb11-83"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb11-84">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> clustcols[meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb11-85"></span>
<span id="cb11-86">roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">defineROI</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"direct"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/ROI.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
<p>Note that the <code>identify()</code> function used by <code>defineROI()</code> above can be finnicky and surprisingly challenging to debug. If it works in your R environment, great. If not, then you can instead call the <code>defineROI()</code> function as in below code to flag cells inside a set of pre-defined xy coordinates.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draw the tissue:</span></span>
<span id="cb12-2">clustcols  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tumor=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#C4B7A6"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Macrophage=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#D55E00"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Fibroblast=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#009E73"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dendritic=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#CC79A7"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Necrotic cells</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#999999"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tcell=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0072B2"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Plasma=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#56B4E9"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neutrophil=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#E69F00"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">innate_lymphoid=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F0E442"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Vasculature=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#800000"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nk=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#117733"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mast=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A65628"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bcell=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#6A3D9A"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Unknown=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#666666"</span>)</span>
<span id="cb12-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb12-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb12-5">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> clustcols[meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb12-6"></span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># place a grid over it to determine where to pick boundary points:</span></span>
<span id="cb12-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">h =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pretty</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(xy[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pretty</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(xy[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey20"</span>)</span>
<span id="cb12-9"></span>
<span id="cb12-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># select points by hand:</span></span>
<span id="cb12-11">boundary_points <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb12-12">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.85</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.05</span>,</span>
<span id="cb12-13">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.1</span>,</span>
<span id="cb12-14">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.05</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.95</span>,</span>
<span id="cb12-15">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.95</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.85</span>,</span>
<span id="cb12-16">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.87</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.9</span></span>
<span id="cb12-17">), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb12-18"></span>
<span id="cb12-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define the ROI, i.e. the points in the boundary:</span></span>
<span id="cb12-20">roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">defineROI</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">boundary_points =</span> boundary_points, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/gridROI.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
<p>Then, you can record distance to your ROI:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Calculate macrophages' distance to nearest T-cell:</span></span>
<span id="cb13-2">inds.mac <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Macrophage"</span></span>
<span id="cb13-3">inds.roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> roi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>roi</span>
<span id="cb13-4">dist2roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> FNN<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get.knnx</span>(</span>
<span id="cb13-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> xy[inds.roi, ], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2-column matrix of xy locations</span></span>
<span id="cb13-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">query =</span> xy, </span>
<span id="cb13-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.dist</span>
<span id="cb13-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add to metadata:</span></span>
<span id="cb13-9">meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dist2roi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dist2roi</span>
<span id="cb13-10"></span>
<span id="cb13-11"></span>
<span id="cb13-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## plot:</span></span>
<span id="cb13-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb13-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb13-15">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wheat"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb13-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[inds.roi, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orange"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb13-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">points</span>(xy[inds.mac, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb13-18">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A6CEE3"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1F78B4"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#081D58"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb13-19">       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dist2roi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(dist2roi))][inds.mac])</span>
<span id="cb13-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topleft"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,</span>
<span id="cb13-21">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1F78B4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orange"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wheat"</span>),</span>
<span id="cb13-22">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Macrophages colored by distance to ROI"</span>,</span>
<span id="cb13-23">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cells in ROI"</span>,</span>
<span id="cb13-24">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other cells"</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/dist2roi.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="considerations-for-running-de" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="considerations-for-running-de"><span class="header-section-number">3</span> Considerations for running DE</h2>
<p>Above we showed how to set up a variable to run DE against. Now we turn to the mechanics of actually running DE. We’ll discuss 2 important topics:</p>
<ul>
<li>How to handle bias arising from cell segmentation errors</li>
<li>How to account for possible spatial correlation in your data</li>
</ul>
<p>Both of these topics are discussed in great depth in <a href="https://www.biorxiv.org/content/10.1101/2024.08.02.606405v2.abstract" target="_blank">this preprint</a>, which accompanies our differential expression package smiDE (<a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/" target="_blank">blog post</a>) (<a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/smiDE" target="_blank">package</a>). Here we’ll merely summarize.</p>
<section id="bias-from-segmentation-errors" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="bias-from-segmentation-errors"><span class="header-section-number">3.1</span> Bias from segmentation errors:</h3>
<p>Until the day that cell segmentation algorithms become perfectly accurate, cells’ expression profiles will occasionally be assigned transcripts from neighboring cells. Because the gene identity of these misassigned transcripts isn’t random across space, they can act as a powerful unmodeled confounding variable. For example: if we’re comparing T-cells in the stroma to T-cells in the tumor, the stroma T-cell profiles will contain transcripts from fibroblasts, and the tumor T-cell profiles will contain transcripts from tumor cells. DE will then discover many highly significant genes: fibroblast genes will appear up-regulated in stroma T-cells, and tumor genes will appear up in tumor-residing T-cells. These spurious hits waste analyst time and compromise analysis quality.</p>
<p>We propose two countermeasures to this bias, both implemented in the smiDE package:</p>
<ol type="1">
<li><p><strong>Don’t even analyze the genes at greatest risk of this bias.</strong> If you’re running DE on T-cells, don’t include genes like EPCAM, which is highly abundant in tumor cells and nearly absent in T-cells. smiDE implements a simple filter to flag genes based on their risk of cell segmentation bias - see the function <code>overlap_ratio_metric()</code>.</p></li>
<li><p><strong>In the remaining genes, adjust for minor bias.</strong> We measure a gene’s potential to suffer misassignment into a cell using its mean expression <em>in other cell types</em> around the cell. This then becomes a term in DE models. Taking this step mitigates bias from segmentation errors, though does not fully remove it.</p></li>
</ol>
</section>
<section id="accounting-for-spatial-correlation" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="accounting-for-spatial-correlation"><span class="header-section-number">3.2</span> Accounting for spatial correlation</h3>
<p>Due to the large number of cells in most experiments, it’s common for DE analyses to produce infinitesimal p-values, e.g.&nbsp;10^-60. This seems intuitively wrong: how can a dataset hold such strong evidence for expression changes? Where traditional models differ from our intuition (and from common sense) is the assumption that every cell is <em>independent</em> from every other cell. This is almost never true: cells nearby each other are subject to similar environmental influences unrelated to our design variables, so so their standard errors will be dependent, or correlated. In practice, this means that p-values from models assuming independence will be profoundly over-excitable.</p>
<p>The field of spatial statistics has long grappled with inference in the presence of spatial correlation such as this, and a sizeable arsenal of methods has been developed. In Vasconcelos &amp; McGuire et al., the aforementioned preprint, we characterize the performance of many of these methods, along with some new ones we propose. We find a tradeoff between accuracy and computational efficiency, with the best methods taking unacceptably long to run in large datasets. Our key finding is that ignoring spatial correlation, i.e.&nbsp;running a traditional DE method, leads to large numbers of false positive hits, often far in excess of the presumed true positive hits whose p-values survive accounting for spatial correlation. Whichever method in the paper seems suitable for your study, you can run it using <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/smiDE" target="_blank">our R package smiDE</a>.</p>
</section>
<section id="other-model-choice-considerations" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="other-model-choice-considerations"><span class="header-section-number">3.3</span> Other model choice considerations</h3>
<p>We find that negative binomial models outperform Gaussian models, but at a cost in computational time. Poisson models offer a middle ground in terms of computational time, but typically underestimate standard errors, leading to inflated Type I errors.</p>
<p>The performance of Gaussian models is generally acceptable, making them a reasonable choice when computation time is a limitation. smiDE implements all these options under a variety of spatial correlation-aware methods.</p>
</section>
</section>
<section id="approach-for-maximal-speed-simultaneous-fitting-of-all-genes-using-linear-algebra" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="approach-for-maximal-speed-simultaneous-fitting-of-all-genes-using-linear-algebra"><span class="header-section-number">4</span> Approach for maximal speed: simultaneous fitting of all genes using linear algebra</h2>
<p>Unfortunately, there’s a cost in compute time and money to many of the more theoretically optimal DE approaches (e.g.&nbsp;using a NB distribution, accounting for spatial correlation, adjusting for bias from segmentation errors). An analysis of 19k genes in hundreds of thousands of cells can take a reasonably powerful EC2 instance a day or more to complete. When computation time is a concern, or when simply pursuing exploratory analysis, we recommend using a less optimal but much faster approach. In the code below, we demonstrate how to run a basic Gaussian / “ordinary least squares” regression simultaneously across all genes at once. This code returns reasonable DE results in seconds. This approach cannot model spatial correlation, nor can it adjust for confounding from cell segmentation errors. But its speed makes it very useful for exploratory analyses. It could also be used to prioritize genes for more computationally expensive models.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/blob/Main/_code/PatchDE/DEutils.R"</span>)</span>
<span id="cb14-2"></span>
<span id="cb14-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Example usage:</span></span>
<span id="cb14-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># run DE:</span></span>
<span id="cb14-5">inds.tumor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor"</span></span>
<span id="cb14-6">inds.t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tcell"</span></span>
<span id="cb14-7">dist2tcell <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> FNN<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get.knnx</span>(</span>
<span id="cb14-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> xy[inds.t, ], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2-column matrix of xy locations</span></span>
<span id="cb14-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">query =</span> xy, </span>
<span id="cb14-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.dist</span>
<span id="cb14-11"></span>
<span id="cb14-12">out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hastyDE</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> norm[inds.tumor, ], </span>
<span id="cb14-13">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dist2tcell"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dist2tcell[inds.tumor])) </span>
<span id="cb14-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(out)</span></code></pre></div>
</details>
</div>
</section>
<section id="multi-tissue-analyses" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="multi-tissue-analyses"><span class="header-section-number">5</span> Multi-tissue analyses</h2>
<p>So far we have only discussed the case of a single-tissue analysis. When analyzing multiple tissues, we have a simple recommendation: instead of running one giant DE model across all tissues at once, run your model separately for each tissue. This approach has a few benefits. First, it’s easier to manage computationally - you don’t need to load several large datasets into memory at once. Second, it’s scientifically appealing: we’ll usually have relatively few tissues and a whole lot of cells per tissue. This means we’re powered to run DE within each tissue, and there are few enough tissues that we have the cognitive ability to understand their results individually rather than averaged together. This per-tissue approach lets you see conclusions like, “T-cells react strongly to tumor cells in these three tissues, but not in these other two.” If you want to reduce a DE relationship to a single number, you can always use metaanalysis techniques to get the average relationship across all tissues.</p>
<p>Our favorite way to display a multi-tissue DE analysis is with a heatmap of per-tissue results, coloring by effect size when results meet a p-value threshold:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/per_tissue_heatmap.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
<p>This approach lets you see which DE trends are universal and which are tissue-specific.</p>
<section id="best-practices-for-multi-tissue-de" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="best-practices-for-multi-tissue-de"><span class="header-section-number">5.1</span> Best practices for multi-tissue DE:</h3>
<ol type="1">
<li>Choose an appropriate single-tissue DE approach as described earlier. We recommend the smiDE library for most cases.</li>
<li>As with all DE analyses, remove genes failing smiDE’s cell overlap ratio metric.</li>
<li>Display results in a heatmap of genes x tissues. Color by effect size, and only give color to results with p &lt; 0.001 (or choose your own threshold). Show only genes that meet a strong effect size / p-value threshold in at least one tissue.</li>
<li>Summarize each gene’s total evidence with a meta-analysis. We have had luck with the metafor package.</li>
</ol>
</section>
</section>
<section id="experimental-approach-stratifying-de-across-tissue-patches" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="experimental-approach-stratifying-de-across-tissue-patches"><span class="header-section-number">6</span> Experimental approach: stratifying DE across tissue patches</h2>
<p>Here we describe an alternative, experimental approach to DE that we have found to be useful. We emphasize that this approach is thus far <strong>very</strong> lightly tested, but we include it here before fully developing it in hopes that it proves useful and that community feedback strengthens a later release.</p>
<p>Our motivation arises from two complaints about typical tissue-wide DE:</p>
<ol type="1">
<li><strong>Biology</strong>: we’ll often expect a DE relationship to vary across space, or to only occur locally. For example, perhaps T-cells only respond to nearby tumor cells when they’re in the nutrient-rich stroma rather than the tumor interior. When we look across the whole tissue for this relationship, we have a harder time discovering it since we model both regions where it occurs and regions where it doesn’t. In statistical terminology: unobserved variables across the span of the tissue are acting as effect modifiers.</li>
<li><strong>Convenience</strong>: because accounting for spatial correlation can be slow, running DE on a highly abundant cell type often means making a choice between extreme compute times or using sub-optimal methods that ignore spatial correlation.</li>
</ol>
<p>Our solution is to divide the tissue into small patches, then to run DE separately within each patch. This produces a matrix of DE results across genes and patches. Then, looking at patch-specific results, we can discover strong relationships that only occur in a few places. And using metaanalysis techniques across all patches, we recover our ability to discover relationships that exist broadly. In short, we get a more nuanced picture of DE behavior within a diverse tissue.</p>
<p>This approach has one other benefit: when we analyze small patches, spatial correlation becomes less important, as the spatial context within a given patch will be less variable than spatial context across a whole tissue. This lets us run the super-fast algorithm above within each patch. The speed benefit of this approach is so great that even in a large WTX dataset we obtain full DE results across all patches in minutes, while running just a single tissue-wide model for each gene might take a day.</p>
<p>To support patch-based DE. We have created an algorithm to partition a tissue into patches. This algorithm, “patchDE”, attempts to build patches that achieve a balance between the following goals:</p>
<ul>
<li>Ensure each patch has reasonable statistical power</li>
<li>Prevent overly large patches</li>
<li>Build as many patches as possible</li>
</ul>
<p>In other words, we seek to partition the tissue into reasonably-shaped districts that are all well-powered to run DE against the predictor variable.</p>
<p>The patchDE algorithm is available as an R script <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/blob/Main/_code/PatchDE/DEutils.R" target="_blank">here</a>.</p>
<p>Below is a demonstration of patchDE’s use.</p>
<p>First we use define patches:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### use Patch DE to partition the tissue into patches:</span></span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/blob/Main/_code/PatchDE/DEutils.R"</span>)</span>
<span id="cb15-3"></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define your design variable:</span></span>
<span id="cb15-5">inds.tumor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor"</span></span>
<span id="cb15-6">inds.t     <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tcell"</span></span>
<span id="cb15-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(inds.tumor), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(inds.t))</span>
<span id="cb15-8">dist2tcell <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> FNN<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get.knnx</span>(</span>
<span id="cb15-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(xy[inds.t, , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]),</span>
<span id="cb15-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">query =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(xy),</span>
<span id="cb15-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb15-12">)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.dist[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb15-13"></span>
<span id="cb15-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## derive patches:</span></span>
<span id="cb15-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Suggested tuning parameters to use: </span></span>
<span id="cb15-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  1. Control granularity: npatches.</span></span>
<span id="cb15-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  2. Control learning rate: bizesize, then possibly alpha. </span></span>
<span id="cb15-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  3. Patch size and shape: maxradius, roundness</span></span>
<span id="cb15-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  4. Patch position: initwithhotspots</span></span>
<span id="cb15-20">patches <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getPatches</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xy =</span> xy[inds.tumor, ], </span>
<span id="cb15-21">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> dist2tcell[inds.tumor], </span>
<span id="cb15-22">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">npatches =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,</span>
<span id="cb15-23">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bitesize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb15-24">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxradius =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb15-25">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">roundness =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>,</span>
<span id="cb15-26">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">initwithhotspots =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb15-27">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_iters =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,</span>
<span id="cb15-28">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plotprogress =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb15-29">) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># produces a vector of patch assigments, potentially including NA's for cells not given a patch</span></span>
<span id="cb15-30"></span>
<span id="cb15-31"></span>
<span id="cb15-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to view, draw polygon boundaries around each patch:</span></span>
<span id="cb15-33">patchhulls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getPatchHulls</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xy =</span> xy[inds.tumor, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">patch =</span> patches) </span>
<span id="cb15-34"></span>
<span id="cb15-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot patches:</span></span>
<span id="cb15-36"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb15-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy[inds.tumor, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb15-38">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor cells colored by distance to T-cell, with patches for stratified DE"</span>,</span>
<span id="cb15-39">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A6CEE3"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1F78B4"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#081D58"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)[</span>
<span id="cb15-40">       <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dist2tcell <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(dist2tcell))[inds.tumor]</span>
<span id="cb15-41">     ],</span>
<span id="cb15-42">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb15-43"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(patchhulls)) {</span>
<span id="cb15-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(patchhulls[[i]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">wpoints =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">add =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb15-45">}</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/patches.png" class="img-fluid figure-img" style="width:120.0%"></p>
</figure>
</div>
</div>
</div>
<p>Below you can see the patches evolve over iterations. Our goal is to get a high “predictor sum of squares” (which determines statistical power) in each patch. You will notice that the per-patch power tends to improve over iterations, especially the early ones, as cells are moved from over-powered patches to under-powered ones. Also note that there algorithm does not converge to a single optimal solution; it ends up wandering around through a space of similarly satisfactory solutions.</p>
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/patchanimation.gif" class="img-fluid"></p>
<p>With patches in hand, we can run a computationally-efficient DE test within each patch:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### run DE in each patch, using hastyDE, which computationally-efficient but ignores spatial correlation:</span></span>
<span id="cb16-2">deresults <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">patchDE</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> norm[inds.tumor, ],</span>
<span id="cb16-3">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dist2tcell"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> dist2tcell[inds.tumor]),</span>
<span id="cb16-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">patch =</span> patches)</span>
<span id="cb16-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(deresults)</span>
<span id="cb16-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># List of 1</span></span>
<span id="cb16-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  $ dist2tcell:List of 3</span></span>
<span id="cb16-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ..$ pvals: num [1:3, 1:12] 2.59e-01 7.85e-01 3.61e-12 5.70e-01 7.52e-02 ...</span></span>
<span id="cb16-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span id="cb16-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   .. .. ..$ : chr [1:3] "PGC" "CXCL14" "VEGFA"</span></span>
<span id="cb16-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   .. .. ..$ : chr [1:12] "patch8" "patch3" "patch4" "patch12" ...</span></span>
<span id="cb16-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ..$ ests : num [1:3, 1:12] 1.0276 0.0797 6.3659 -0.3679 -0.2379 ...</span></span>
<span id="cb16-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span id="cb16-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   .. .. ..$ : chr [1:3] "PGC" "CXCL14" "VEGFA"</span></span>
<span id="cb16-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   .. .. ..$ : chr [1:12] "patch8" "patch3" "patch4" "patch12" ...</span></span>
<span id="cb16-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ..$ ses  : num [1:3, 1:12] 0.911 0.292 0.91 0.647 0.134 ...</span></span>
<span id="cb16-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span id="cb16-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   .. .. ..$ : chr [1:3] "PGC" "CXCL14" "VEGFA"</span></span>
<span id="cb16-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   .. .. ..$ : chr [1:12] "patch8" "patch3" "patch4" "patch12" ...</span></span></code></pre></div>
</details>
</div>
<p>Now we’ve got DE results for every gene x patch. Next comes the hard part: figuring our which results to prioritize. We recommend two approaches:</p>
<ol type="1">
<li>Find genes that have significant and large effect sizes in at least a few patches (strong but possibly sporadic results).</li>
<li>Find genes with strong meta-analysis p-values (consistent but less dramatic results). <strong>Warning</strong>: most meta-analyses, including the version demonstrated below, will assume each patch is independent. Under the realistic scenario where neighboring patches will have correlated results, this assumption fails, producing overly optimistic p-values.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### prep for gene prioritization:</span></span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># replace NA results - arising from all-0 expression - with 0s:</span></span>
<span id="cb17-4">ps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replace</span>(deres[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pvals, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(deres[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pvals), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb17-5">ests <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replace</span>(deres[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ests, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(deres[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pvals), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb17-6">ses <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replace</span>(deres[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ses, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(deres[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pvals), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e6</span>)</span>
<span id="cb17-7"></span>
<span id="cb17-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># scale ests by genes' mean expression:</span></span>
<span id="cb17-9">genefactors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(norm[inds.tumor, ]), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb17-10">ests <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sweep</span>(ests, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, genefactors[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(ests)], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>)</span>
<span id="cb17-11"></span>
<span id="cb17-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### identify genes with a few strong patches:</span></span>
<span id="cb17-13">est.thresh <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb17-14">p.thresh <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb17-15">crit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(ests) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> est.thresh) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (ps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> p.thresh)</span>
<span id="cb17-16">critdir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((ests <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> est.thresh) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (ps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> p.thresh)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((ests <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>est.thresh) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (ps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> p.thresh))</span>
<span id="cb17-17">topgenes1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(crit) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb17-18"></span>
<span id="cb17-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### use meta-analysis to summarize genes' trends across patches</span></span>
<span id="cb17-20">metapvals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(deresults[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pvals), <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(gene) {</span>
<span id="cb17-21">  fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metafor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rma.uni</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yi =</span> deresults[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ests[gene, ], </span>
<span id="cb17-22">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sei =</span> deresults[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ses[gene, ], </span>
<span id="cb17-23">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"REML"</span>)</span>
<span id="cb17-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pval)</span>
<span id="cb17-25">})</span>
<span id="cb17-26">topgenes2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(metapvals)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(metapvals, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decreasing =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>]], <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span></code></pre></div>
</details>
</div>
<p>Once you’ve prioritized genes via the above two lists (<code>topgenes1</code> and <code>topgenes2</code>), we recommend making a heatmap of their DE results:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## now use a heatmap to plot results from either list of top genes:</span></span>
<span id="cb18-2">pheatmap<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pheatmap</span>((deresults[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ests <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (deresults[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pvals <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>))[topgenes1, ],</span>
<span id="cb18-3">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRampPalette</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkred"</span>))(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>),</span>
<span id="cb18-4">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/deheatmap.png" class="img-fluid figure-img" style="width:170.0%"></p>
</figure>
</div>
</div>
</div>
<p>From there, it’s the usual exploration of DE results, leaning heavily on spatial plots and literature searches.</p>
<p>Finally, a note on multiplicity: when we run DE across dozens of patches, the problem of multiple testing gets even worse. So, before getting excited about a single gene in a single patch, take one of these countermeasures to multiplicity:</p>
<ul>
<li>Confirm the gene x patch has a strong adjusted p-value <em>considering all the p-values from all the genes x patches</em>.</li>
<li>Confirm the gene has a strong adjusted p-value from the metaanalysis, considering the p-values from all the genes’ metaanalysis results.</li>
</ul>
</section>
<section id="comment-on-statistical-power-and-false-discoveries" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="comment-on-statistical-power-and-false-discoveries"><span class="header-section-number">7</span> Comment on statistical power and false discoveries</h2>
<p>Very large numbers of cells give us very high statistical power to detect even tiny effect sizes. Paradoxically, this creates a hazard for analysts, as our high statistical power applies both to real effects <strong>and</strong> to the effects of unmeasured confounding variables. Now it’s usually a safe assumption that a given gene is being influenced by a variety of factors in a tissue, many of them unmeasured and at least lightly correlated with your design variable. In other words, any given gene is likely subject to unmeasured confounding, meaning there’s a false positive signal that we are well-powered to find significant and get fooled by.</p>
<p>The countermeasure to this phenomenon is simple: don’t get excited by p-values, but rather focus on effect sizes. The stronger a gene’s fold-change with your design variable, the more likely the change you see is driven by your design variable rather than unobserved confounders. You should still apply a reasonable p-value or FDR cutoff, but beyond that cutoff you should rank genes by effect size.</p>
</section>
<section id="the-limitations-of-de" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="the-limitations-of-de"><span class="header-section-number">8</span> The limitations of DE</h2>
<p>DE analyses have a tidy framework: you specify variables that you hypothesize will impact gene expression, then you look for which genes correlate with those variables. But when we look at gene expression in space, we often find variability far beyond the explanatory ability of any variables we known enough to specify. In other words, the spatial determinants of gene expression are far more complicated than the DE models we build from our limited biological knowledge. This does not mean the DE is futile - we still consider it the primary tool for wringing biology from spatial data - but it’s worth keeping some implications of this phenomenon in mind:</p>
<ol type="1">
<li>When DE identifies a gene, look at its expression in space and evaluate: how much of its variability is due to your design variable? Are there other strong spatial trends that suggest a different explanation? Taking the Moran’s I stat of a gene’s residuals could also be useful:</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">inds.tumor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor"</span></span>
<span id="cb19-2">W <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> spdep<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnearneigh</span>(xy[inds.tumor, ], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(FNN<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get.knn</span>(xy[inds.tumor, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.dist[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">95</span>))</span>
<span id="cb19-3">Wl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> spdep<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nb2listw</span>(W, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"W"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">zero.policy =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb19-4">outcome <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> norm[inds.tumor, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"VEGFA"</span>]</span>
<span id="cb19-5">predictor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dist2tcell</span>
<span id="cb19-6">spdep<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">moran.test</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">residuals</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(outcome <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> predictor)), Wl)</span></code></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>To understand a tissue, you should also pursue approaches that are not limited by the design variables you specify. Look for spatial variable genes, or for <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/insitucor/" target="_blank">spatially correlated genes</a>, or for <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/insitudiff/" target="_blank">perturbed spatial neighborhoods</a>. These unsupervised, exploratory approaches will reveal the strongest spatial signals in your data without requiring you to know the full set of explanatory variables a priori.</li>
</ol>


</section>

 ]]></description>
  <category>differential expression</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/</guid>
  <pubDate>Tue, 21 Oct 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/DE-guide/figures/thumbnail.png" medium="image" type="image/png" height="134" width="144"/>
</item>
<item>
  <title>Aligning CosMx® Same-Cell Multiomics Data</title>
  <dc:creator>Mithra Korukonda</dc:creator>
  <dc:creator>Claire Williams</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-alignment/</link>
  <description><![CDATA[ 





<section id="cosmx-multiomics-data" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> CosMx Multiomics Data</h1>
<p>CosMx<sup>®</sup> SMI allows users to acquire protein and RNA data from the same tissue as consecutive experiments. These data are acquired as independent runs and therefore need to be aligned, post-acquisition, to combine them into a multiomic study. This alignment process brings the decoded RNA transcripts into the coordinate system of protein data. To accomplish this, we have developed a standalone alignment tool that can be used to align CosMx data exported from AtoMx<sup>®</sup> SIP. The tool has a 2-step workflow represented in Figure&nbsp;1:</p>
<p>Step 1: Align the RNA morphology fields of view (FOVs) to protein references.</p>
<p>Step 2: Assign the RNA transcripts to the protein cell segmentation labels.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-align-workflow" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-align-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-alignment/figures/Figure1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-align-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Multiomics alignment workflow
</figcaption>
</figure>
</div>
</div>
</div>
<div class="{callout-note}">
<p>Like other items in our <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/about.html" target="_blank">CosMx Analysis Scratch Space</a>, the multiomics alignment tool presented here is experimental so the usual <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/about.html" target="_blank">caveats</a> and <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/license.html" target="_blank">license</a> applies.</p>
</div>
</section>
<section id="export-cosmx-multiomics-data-from-atomx-sip" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Export CosMx Multiomics Data from AtoMx SIP</h1>
<p>To export data from AtoMx SIP, you will need an sFTP application such as WinSCP. Launch the AtoMx Export function to obtain the AtoMx Hostname and Username (Figure&nbsp;2, left). Use those credentials, with the AtoMx SIP user’s password, to open a WinSCP portal (Figure&nbsp;2, right).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-data-export" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-data-export-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-alignment/figures/Figure2.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-data-export-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Establishing export access between AtoMx SIP and WinSCP
</figcaption>
</figure>
</div>
</div>
</div>
<p>Next, export data from the protein experiment according to Figure&nbsp;3 (a). Export data from the RNA experiment according to Figure&nbsp;3 (b).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-data-selection" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-data-selection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-alignment/figures/Figure3.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-data-selection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Data selection for (a) Protein and (b) RNA export from AtoMx SIP
</figcaption>
</figure>
</div>
</div>
</div>
<p>Check the exported data to confirm the following contents:</p>
<ul>
<li><p>Protein <code>CellStatsDir</code> folder and <code>Morphology2D</code> folder within</p></li>
<li><p>RNA <code>CellStatsDir</code> folder and <code>Morphology2D</code> folder within</p></li>
<li><p>RNA <code>AnalysisResults</code> folder</p></li>
</ul>
</section>
<section id="download-and-use-alignment-tool" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Download and Use Alignment Tool</h1>
<p>Download and unzip the <code>MultiO_Alignment_Tool_V1.4.1.zip</code> file available <a href="https://bruker-my.sharepoint.com/:u:/p/s_korukonda/IQBavkxg6PHwQ5tbZnfxJAIjARtLulL57UkVRpxUihY3JzE?e=JLrBYi" target="_blank">here</a>. Once the file has been unzipped, launch the tool by double-clicking the <code>MultiOAligmentUI.bat</code> file. The executable will launch an interactive graphical user interface (GUI) as shown in Figure&nbsp;4.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This multiomics alignment tool is actively and continuously under development in the RnD groups at Bruker Spatial Biology. Please be aware that there may be bugs and that it has not gone through the regular level of quality and testing. Our goal here is to bring the capabilities of multiomics to CosMx SMI users as fast as possible. For technical support, please contact support.spatial@bruker.com.</p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-gui" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gui-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-alignment/figures/Figure4.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gui-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Standalone multiomics alignment tool GUI
</figcaption>
</figure>
</div>
</div>
</div>
<section id="step-1-calculate-2d-shift" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="step-1-calculate-2d-shift"><span class="header-section-number">3.1</span> Step 1: Calculate 2D Shift</h2>
<p>To launch image alignment, select the <code>Morphology2D</code> folders for both the protein and RNA runs and click <code>Perform Alignment</code>. The standard search area used for the alignment is by default 500 pixels or roughly 60 microns. This range is large enough to account for shifts introduced by slide replacement. This search area is editable and can be increased to 750 if the user suspects a larger shift (though adjustment is typically not needed – the software makes an assessment of search range need prior to alignment).</p>
<p>During alignment a new folder called <code>AlignmentQC</code> is created within the RNA data folder structure and is populated with the outputs from the alignment. Occasionally, certain FOVs may be discarded from the multiomic analysis if they fail alignment. This can happen in cases of tissue peeling or significant cell loss. These FOVs, identified as outliers, are recorded in the <code>Alignment_Stats_Curated.csv</code> file and are excluded from the transcript re-assignment process. Refer to Table&nbsp;1 for a list of <code>AlignmentQC</code> folder outputs and descriptions of the individual files.</p>
<div id="tbl-alignment-qc-outputs" class="quarto-float quarto-figure quarto-figure-center anchored" data-tbl-colwidths="[40,60]">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-alignment-qc-outputs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Folder outputs and descriptions
</figcaption>
<div aria-describedby="tbl-alignment-qc-outputs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 40%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>AlignmentQC Folder Outputs</th>
<th style="text-align: left;">Description of individual files</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Alignment_Stats.csv</td>
<td style="text-align: left;">List of the paired Protein and RNA FOVs along with the computed XY shift (in pixels) between them.</td>
</tr>
<tr class="even">
<td>FOV_mask.TIF</td>
<td style="text-align: left;">Binary Map of the FOV Locations.</td>
</tr>
<tr class="odd">
<td>FOV_Cluster.TIF</td>
<td style="text-align: left;">Visualization of FOV Clusters.</td>
</tr>
<tr class="even">
<td>Displacement_Vectors.png</td>
<td style="text-align: left;">Visualization of the FOV displacement with marker outliers.</td>
</tr>
<tr class="odd">
<td>Alignment_Stats_Curated.csv</td>
<td style="text-align: left;">Updated Stats file with associated cluster label and outlier flag.</td>
</tr>
<tr class="even">
<td>Stats_Report.txt</td>
<td style="text-align: left;">Reports the percentage of FOVs that were successfully aligned, along with a list of FOVs that failed alignment and were excluded from target re-assignment.</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="step-2-shift-and-assign-transcripts" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="step-2-shift-and-assign-transcripts"><span class="header-section-number">3.2</span> Step 2: Shift and Assign Transcripts</h2>
<p>Once the alignment process has been completed for all the FOVs, the path of the final alignment will appear in the GUI Alignment box (Figure&nbsp;5 ). The user can review the computed alignment to verify accuracy of the results.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-alignment-folders" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-alignment-folders-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-alignment/figures/Figure5.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-alignment-folders-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Alignment tool generates XY registration between the protein and RNA images
</figcaption>
</figure>
</div>
</div>
</div>
<p>Once the image registration is complete, the next step is to apply the computed shifts to transcripts and re-assign them to protein segmentation labels. For this step, select the Protein <code>CellStatsDir</code> and the location of the RNA transcripts folder (Figure&nbsp;6 ). If the original folder structure of export is maintained, these folders will be automatically populated when the RNA and protein morphology folders are selected. Once the inputs have been chosen, click <code>Assign transcripts</code> as shown in Figure&nbsp;6 (a).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-final-output" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-final-output-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-alignment/figures/Figure6.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-final-output-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: (a) Alignment tool shifts and re-assigns RNA transcripts to protein segmentation labels. (b) Final output fo the alignment.
</figcaption>
</figure>
</div>
</div>
</div>
<p>For every FOV, the assignment process takes as input the calculated shift and applies it to the transcript locations and then updates the cell id based on the associated protein cell label data. Once the re-assignment is complete, the final output is a folder with the updated transcripts data as shown in Figure&nbsp;6 (b).</p>
</section>
</section>
<section id="conclusions" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Conclusions</h1>
<p>After using the off-AtoMx alignment tool to apply protein cell segmentation boundaries and cell ID labels to the RNA data, you can use transcript-to-cell alignments found in the <code>*_FOV#####__complete_code_cell_target_call_coords.csv</code> per FOV files within the <code>AnalysisResults_shifted</code> folder to continue analysis with the aligned RNA dataset. For an example of how to gather the aligned RNA transcript information into an updated gene x cell expression matrix, see the post <a href="../../posts/aligned_rna_exp_matrix/index.html">here</a>. These updated files can be used alongside the protein run flat files to create a new multiomic data object. It’s important to note that all transcripts in the aligned RNA data will now reference the segmentation results and metadata from the protein run.</p>
<p>If you prefer to integrate the aligned RNA data into an existing data object, you can do so by starting with the protein run object and either replacing the protein expression matrix with an aligned RNA matrix or appending the RNA data as an additional assay.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Once the protein and RNA data are exported from AtoMx and modified through alignment, the updated data cannot be re-imported into AtoMx. As of AtoMx v2.2 and earlier, the platform retains only the original, pre-aligned data.</p>
</div>
</div>


</section>

 ]]></description>
  <category>multiomics</category>
  <category>algorithms</category>
  <category>protein</category>
  <category>RNA</category>
  <category>alignment</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-alignment/</guid>
  <pubDate>Thu, 02 Oct 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/multiomics-alignment/figures/CosMx_Protein_RNA_Image.png" medium="image" type="image/png" height="46" width="144"/>
</item>
<item>
  <title>Visualizing Spatial Transcriptomics: A Guide to Effective Plotting</title>
  <dc:creator>Claire Williams</dc:creator>
  <dc:creator>Felicia New</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/</link>
  <description><![CDATA[ 





<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>Spatial transcriptomics data provide rich opportunities for visual exploration. In this post, we demonstrate several useful visualizations for CosMx<sup>®</sup> data, particularly when working from <a href="../../posts/flat-file-exports/flat-files-compare.html">flat files</a>, and showcase a range of visualizations to highlight different aspects of CosMx data. Similar plots could be generated when working with common packages such as Seurat <span class="citation" data-cites="Hao2024">(Hao et al. 2024)</span> or Squidpy <span class="citation" data-cites="Palla2022">(Palla et al. 2022)</span>. For more plotting ideas with these tools, see the following posts:</p>
<p><a href="../../posts/seurat-cosmx-basics/index.html">Plotting with Seurat objects</a></p>
<p><a href="../../posts/squidpy-essentials/squidpy-essentials.html">Plotting and analysis with Squidpy</a></p>
<p>These plots serve as a foundation for both quality control and exploratory analysis and are meant to serve as inspiration for additional plots you could make. For every plot, we show one version made in R and another made in Python; you can view the corresponding R or Python code by expanding the dropdown tab above the figure.</p>
</section>
<section id="data-set-up" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="data-set-up"><span class="header-section-number">2</span> Data set up</h2>
<p>For demonstration in this post, we use data from a breast cancer sample that has been analyzed in AtoMx<sup>®</sup> SIP through unsupervised cell typing. Many of the below plots rely on the same data objects. For convenience, we show how each of these objects are read in here and will use them in later code blocks. We also load in libraries that will be used in later sections.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(grid)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(R.utils)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggsci)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pals)</span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(FNN)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(viridis)</span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define paths</span></span>
<span id="cb1-13">raw_data_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/path/to/raw/data"</span></span>
<span id="cb1-14">out_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/path/to/out/dir"</span></span>
<span id="cb1-15">slide_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"slideName"</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set this to your slide name, i.e. the identifier at the front of each flat file</span></span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read data</span></span>
<span id="cb1-18">cell_meta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(raw_data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>, slide_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_metadata_file.csv.gz"</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Note this is a small file and we read it into a data frame for convenience</span></span>
<span id="cb1-19">cell_polygons <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(raw_data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>, slide_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-polygons.csv.gz"</span>))</span>
<span id="cb1-20">fov_positions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(raw_data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>, slide_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_fov_positions_file.csv.gz"</span>))</span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gzip</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> subprocess</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> io</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb2-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.cm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> cm</span>
<span id="cb2-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.patches <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mpatches</span>
<span id="cb2-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.colors <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mcolors</span>
<span id="cb2-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mpl_toolkits.axes_grid1.inset_locator <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> inset_axes</span>
<span id="cb2-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.neighbors <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> NearestNeighbors</span>
<span id="cb2-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> string</span>
<span id="cb2-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math</span>
<span id="cb2-16"></span>
<span id="cb2-17"></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define paths</span></span>
<span id="cb2-19">raw_data_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/path/to/raw/data"</span>)</span>
<span id="cb2-20">out_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/path/to/out/dir"</span>)</span>
<span id="cb2-21">slide_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"slideName"</span></span>
<span id="cb2-22"></span>
<span id="cb2-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read data</span></span>
<span id="cb2-24">cell_meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(raw_data_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>slide_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_metadata_file.csv.gz"</span>)</span>
<span id="cb2-25">cell_polygons <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(raw_data_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>slide_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">-polygons.csv.gz"</span>)</span>
<span id="cb2-26">fov_positions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(raw_data_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>slide_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_fov_positions_file.csv.gz"</span>)</span></code></pre></div>
</details>
</div>
</div>
</div>
</div>
<section id="scale-bar-function" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="scale-bar-function"><span class="header-section-number">2.1</span> Scale Bar Function</h3>
<p>Because the majority of these plots are spatial plots, we’ll often want to include a scale bar. Rather than showing how to make that scale bar for every plot, we write two quick general functions (<code>R</code> and <code>python</code> versions) here at the beginning to make a nice scale bar and reuse these functions throughout this post.</p>
<p>Additionally, all the code here is designed to work from positions given in pixels, as they are in default flat files. If you have positions in mm you’ll want to adjust accordingly, primarily in the scale bar function.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar function</span></span>
<span id="cb3-2"></span>
<span id="cb3-3">make_scale_bar_r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x_vals, y_vals, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">microns_per_pixel =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.12028</span>) {</span>
<span id="cb3-4">  </span>
<span id="cb3-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adds a scale bar to a ggplot.</span></span>
<span id="cb3-6"></span>
<span id="cb3-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Parameters:</span></span>
<span id="cb3-8">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#x_vals: vector of x coordinates in pixels</span></span>
<span id="cb3-9">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#y_vals: vector of y coordinates in pixels</span></span>
<span id="cb3-10">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#microns_per_pixel: conversion factor from pixels to microns. Default is conversion factor for commercial CosMx instrument</span></span>
<span id="cb3-11">   </span>
<span id="cb3-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example usage:</span></span>
<span id="cb3-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># scale_bar = make_scale-bar_r(x_vals = cell_meta$CenterX_global_px, y_vals = cell_meta$CenterY_global_px)</span></span>
<span id="cb3-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggplot() + scale_bar$bg + scale_bar$rect + scale_bar$label</span></span>
<span id="cb3-15">  </span>
<span id="cb3-16">  </span>
<span id="cb3-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate x-axis range</span></span>
<span id="cb3-18">  x_range <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(x_vals, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-19">  x_length <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diff</span>(x_range)</span>
<span id="cb3-20">  x_length_um <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x_length <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> microns_per_pixel</span>
<span id="cb3-21">  </span>
<span id="cb3-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Target scale length ~1/4 of the x-axis</span></span>
<span id="cb3-23">  target <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x_length_um <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb3-24">  </span>
<span id="cb3-25">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute order of magnitude</span></span>
<span id="cb3-26">  order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">floor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log10</span>(target))</span>
<span id="cb3-27">  mantissa <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> target <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> order</span>
<span id="cb3-28">  </span>
<span id="cb3-29">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Round mantissa to nearest 1, 2, or 5</span></span>
<span id="cb3-30">  nice_mantissa <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (mantissa <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) {</span>
<span id="cb3-31">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-32">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (mantissa <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>) {</span>
<span id="cb3-33">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb3-34">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (mantissa <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.5</span>) {</span>
<span id="cb3-35">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb3-36">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb3-37">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb3-38">  }</span>
<span id="cb3-39">  </span>
<span id="cb3-40">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Final scale length in pixels</span></span>
<span id="cb3-41">  scale_length_um <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nice_mantissa <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> order</span>
<span id="cb3-42">  scale_length_px <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> scale_length_um <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> microns_per_pixel</span>
<span id="cb3-43">  </span>
<span id="cb3-44">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format label</span></span>
<span id="cb3-45">  scale_label <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (scale_length_um <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>) {</span>
<span id="cb3-46">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(scale_length_um <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" mm"</span>)</span>
<span id="cb3-47">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb3-48">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(scale_length_um, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" µm"</span>)</span>
<span id="cb3-49">  }</span>
<span id="cb3-50">  </span>
<span id="cb3-51">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set coordinates for the scale bar </span></span>
<span id="cb3-52">  x_start <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x_range[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> scale_length_px <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span></span>
<span id="cb3-53">  x_end <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x_range[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> scale_length_px <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb3-54">  y_pos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(y_vals, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> scale_length_px <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb3-55"></span>
<span id="cb3-56">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate scale bar background, scale bar and annotation to return</span></span>
<span id="cb3-57">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb3-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_custom</span>(</span>
<span id="cb3-59">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rectGrob</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)),</span>
<span id="cb3-60">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> x_start<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> scale_length_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> x_end<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> scale_length_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb3-61">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> y_pos<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> scale_length_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> y_pos <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> scale_length_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span></span>
<span id="cb3-62">  ),</span>
<span id="cb3-63">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rect =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_custom</span>(</span>
<span id="cb3-64">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rectGrob</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)),</span>
<span id="cb3-65">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> x_start, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> x_end,</span>
<span id="cb3-66">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> y_pos, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> y_pos <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> scale_length_px <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span></span>
<span id="cb3-67">    ),</span>
<span id="cb3-68">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotation_custom</span>(</span>
<span id="cb3-69">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">textGrob</span>(scale_label, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">just =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb3-70">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> (x_start <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x_end)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> (x_start <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x_end)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb3-71">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> y_pos <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> scale_length_px <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> y_pos <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> scale_length_px <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb3-72">    )</span>
<span id="cb3-73">  )</span>
<span id="cb3-74">}</span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Set up scale bar function</span></span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> make_scale_bar_py(ax, x_coords, y_coords, microns_per_pixel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.12028</span>):</span>
<span id="cb4-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Adds a scale bar to a matplotlib plot.</span></span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - ax: matplotlib Axes object</span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - x_coords: list or array of x coordinates</span></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - y_coords: list or array of y coordinates</span></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - microns_per_pixel: conversion factor from pixels to microns. Default is conversion factor for commercial CosMx instrument</span></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Example usage:</span></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - fig, ax = plt.subplots()</span></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - ax.scatter(x, y)</span></span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - make_scale_bar_py(ax, microns_per_pixel, x, y)</span></span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb4-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate x-axis range</span></span>
<span id="cb4-20">    x_range <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(x_coords), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(x_coords)]</span>
<span id="cb4-21">    x_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_range[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x_range[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb4-22">    x_length_um <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> microns_per_pixel</span>
<span id="cb4-23"></span>
<span id="cb4-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Target scale length ~1/4 of the x-axis</span></span>
<span id="cb4-25">    target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_length_um <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb4-26"></span>
<span id="cb4-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute order of magnitude</span></span>
<span id="cb4-28">    order <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> np.floor(np.log10(target))</span>
<span id="cb4-29">    mantissa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> order</span>
<span id="cb4-30"></span>
<span id="cb4-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Round mantissa to nearest 1, 2, or 5</span></span>
<span id="cb4-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> mantissa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>:</span>
<span id="cb4-33">        nice_mantissa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> mantissa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>:</span>
<span id="cb4-35">        nice_mantissa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb4-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> mantissa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.5</span>:</span>
<span id="cb4-37">        nice_mantissa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb4-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb4-39">        nice_mantissa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb4-40"></span>
<span id="cb4-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Final scale length in pixels</span></span>
<span id="cb4-42">    scale_length_um <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nice_mantissa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> order</span>
<span id="cb4-43">    scale_length_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> scale_length_um <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> microns_per_pixel</span>
<span id="cb4-44"></span>
<span id="cb4-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format label</span></span>
<span id="cb4-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> scale_length_um <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>:</span>
<span id="cb4-47">        scale_label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>scale_length_um <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> mm"</span></span>
<span id="cb4-48">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb4-49">        scale_label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>scale_length_um<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.0f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> µm"</span></span>
<span id="cb4-50"></span>
<span id="cb4-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set coordinates for the scale bar</span></span>
<span id="cb4-52">    x_start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_range[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> scale_length_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span></span>
<span id="cb4-53">    x_end <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_range[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> scale_length_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb4-54">    y_pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(y_coords) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> scale_length_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb4-55">    </span>
<span id="cb4-56">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up background for scale bar</span></span>
<span id="cb4-57">    scale_bg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mpatches.Rectangle(</span>
<span id="cb4-58">        (x_start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> scale_length_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, y_pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> scale_length_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>),</span>
<span id="cb4-59">        width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(x_end <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x_start) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> scale_length_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb4-60">        height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>scale_length_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>,</span>
<span id="cb4-61">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,</span>
<span id="cb4-62">        zorder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb4-63">    )</span>
<span id="cb4-64">    </span>
<span id="cb4-65">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add background</span></span>
<span id="cb4-66">    ax.add_patch(scale_bg)</span>
<span id="cb4-67"></span>
<span id="cb4-68">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Draw scale bar</span></span>
<span id="cb4-69">    ax.plot([x_start, x_end], [y_pos, y_pos], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)</span>
<span id="cb4-70">    ax.text((x_start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x_end) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, y_pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> scale_length_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, scale_label,</span>
<span id="cb4-71">            color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>, ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'center'</span>, va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bottom'</span>, zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span></code></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="plotting-data-in-space" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="plotting-data-in-space"><span class="header-section-number">3</span> Plotting Data in Space</h2>
<p>Spatial transcriptomics unlocks the ability to visualize gene expression in its native tissue context. In this section, we explore a variety of spatial plots, from full tissue views to single FOVs or smaller, and from cell outlines to transcript overlays, highlighting different ways to represent spatial data.</p>
<section id="cell-positions" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="cell-positions"><span class="header-section-number">3.1</span> Cell Positions</h3>
<p>Visualize cell centroids from the cell metadata file. This shows a broad overview of the tissue structure. We start with all cells colored grey.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" aria-controls="tabset-3-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" aria-controls="tabset-3-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar</span></span>
<span id="cb5-2">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>CenterX_global_px,</span>
<span id="cb5-3">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span> cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>CenterY_global_px)</span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb5-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(cell_meta,</span>
<span id="cb5-7">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> CenterX_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> CenterY_global_px)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fix aspect ratio</span></span>
<span id="cb5-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-11">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-12">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-13">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb5-14">  </span>
<span id="cb5-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_positions.png"</span>),</span>
<span id="cb5-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/cell_positions.png" class="img-fluid figure-img" style="width:30.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Create the scatter plot</span></span>
<span id="cb6-2">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb6-3">ax.scatter(</span>
<span id="cb6-4">    cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CenterX_global_px"</span>],</span>
<span id="cb6-5">    cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CenterY_global_px"</span>],</span>
<span id="cb6-6">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey"</span>,</span>
<span id="cb6-7">    s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb6-8">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span></span>
<span id="cb6-9">)</span>
<span id="cb6-10">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>, adjustable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'box'</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fix aspect ratio</span></span>
<span id="cb6-11">ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Removes axes and grid</span></span>
<span id="cb6-12"></span>
<span id="cb6-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb6-14">make_scale_bar_py(ax, cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CenterX_global_px"</span>], cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CenterY_global_px"</span>])</span>
<span id="cb6-15"></span>
<span id="cb6-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the figure</span></span>
<span id="cb6-17">plt.savefig(os.path.join(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python_cell_positions.png"</span>), bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>, pad_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb6-18">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_cell_positions.png" class="img-fluid figure-img" style="width:30.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="cell-polygons" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="cell-polygons"><span class="header-section-number">3.2</span> Cell Polygons</h3>
<p>To illustrate cell boundaries, we plot polygon outlines derived from the polygon flat files. These visualizations are most informative when zoomed in, so we focus on a single FOV where individual cell shapes are more discernible.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note on Polygon Flat Files
</div>
</div>
<div class="callout-body-container callout-body">
<p>The polygon flat file encodes each cell’s shape using a simplified set of vertices. As a result, some cells may appear to overlap when plotted—this is a visual artifact caused by rounding during polygon generation.</p>
<p>Importantly, the actual segmentation used for transcript assignment does <strong>not</strong> contain overlapping cell borders. The cell boundaries are sampled using a convex hull to minimize the number of points in the polygons flat file. This file is intended to provide a rough approximation of cell shapes, which is why convex hull simplification may introduce overlaps.</p>
<p>For precise cell boundaries, refer to the <code>CellLabels_F#####.TIF</code> file, which defines borders at the per-pixel level.</p>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" aria-controls="tabset-4-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" aria-controls="tabset-4-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" aria-labelledby="tabset-4-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar</span></span>
<span id="cb7-2">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(x_global_px),</span>
<span id="cb7-3">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span>  cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(y_global_px))</span>
<span id="cb7-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb7-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Select cells in FOV 100</span></span>
<span id="cb7-6">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> cell)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_polygon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-10">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-11">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-12">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb7-13">  </span>
<span id="cb7-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_outlines_singleFOV.png"</span>),</span>
<span id="cb7-15">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/cell_outlines_singleFOV.png" class="img-fluid figure-img" width="600"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" aria-labelledby="tabset-4-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter data for FOV 100</span></span>
<span id="cb8-2">filtered_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_polygons[cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fov"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>]</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Create the polygon plot</span></span>
<span id="cb8-5">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key, group <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> filtered_data.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell"</span>):</span>
<span id="cb8-8">  ax.plot(group[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>], group[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-9">    </span>
<span id="cb8-10">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>, adjustable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'box'</span>)</span>
<span id="cb8-11">ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Removes axes and grid</span></span>
<span id="cb8-12"></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb8-14">make_scale_bar_py(ax, filtered_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>], filtered_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>])</span>
<span id="cb8-15"></span>
<span id="cb8-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the figure</span></span>
<span id="cb8-17">plt.savefig(os.path.join(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python_cell_outlines_singleFOV.png"</span>), bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>, pad_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb8-18">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_cell_outlines_singleFOV.png" class="img-fluid figure-img" width="462"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="color-cells-by-metadata" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="color-cells-by-metadata"><span class="header-section-number">3.3</span> Color Cells by Metadata</h3>
<p>Overlay polygons with metadata such as cell type. Here, we use results from Leiden clustering. Throughout the post, we showcase a variety of color palettes. When only a few colors are needed, we aim for consistency between <code>R</code> and <code>Python</code> plots. In cases requiring many colors, we highlight diverse palette options, which may differ across the two languages.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are a small number of cells with no associated cell type as they got flagged in QC. These show up as <code>NA</code> in the plots.</p>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" aria-controls="tabset-5-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" aria-controls="tabset-5-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" aria-labelledby="tabset-5-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Add cell type to polygons</span></span>
<span id="cb9-2">plot.df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>()</span>
<span id="cb9-3">meta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(cell_meta)</span>
<span id="cb9-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(meta) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell</span>
<span id="cb9-5">plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(meta)[plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>]</span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar</span></span>
<span id="cb9-8">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> plot.df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(x_global_px),</span>
<span id="cb9-9">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span>  plot.df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(y_global_px))</span>
<span id="cb9-10"></span>
<span id="cb9-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb9-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot.df,</span>
<span id="cb9-13">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_global_px, </span>
<span id="cb9-14">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> cell, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Group cells for polygons</span></span>
<span id="cb9-15">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(cell_type))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Polygon fill by cell type</span></span>
<span id="cb9-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_polygon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_ucscgb</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Palette inspired by UCSB Genome Browser</span></span>
<span id="cb9-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-21">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-22">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-23">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb9-24">  </span>
<span id="cb9-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_polygons_singleFOV.png"</span>),</span>
<span id="cb9-26">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/celltype_polygons_singleFOV.png" class="img-fluid figure-img" width="900"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" aria-labelledby="tabset-5-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter for FOV 100</span></span>
<span id="cb10-2">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_polygons[cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fov"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>]</span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Merge only the 'leiden_cluster' column</span></span>
<span id="cb10-5">meta_subset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>]]</span>
<span id="cb10-6">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_df.merge(meta_subset, on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>, how<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>)</span>
<span id="cb10-7"></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a colormap</span></span>
<span id="cb10-9">clusters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>].unique()</span>
<span id="cb10-10"></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter out NA values first</span></span>
<span id="cb10-12">valid_clusters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [c <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> clusters <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pd.notna(c)]</span>
<span id="cb10-13"></span>
<span id="cb10-14">cmap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cm.get_cmap(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tab20"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_clusters))</span>
<span id="cb10-15">cluster_to_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {cluster: cmap(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, cluster <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(valid_clusters)}</span>
<span id="cb10-16"></span>
<span id="cb10-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Add color for NA values</span></span>
<span id="cb10-18">cluster_to_color[np.nan] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgrey"</span></span>
<span id="cb10-19"></span>
<span id="cb10-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Create the polygon plot</span></span>
<span id="cb10-21">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb10-22"></span>
<span id="cb10-23"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key, group <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> plot_df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell"</span>): <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Iterate through each cell</span></span>
<span id="cb10-24">    cluster <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>].iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb10-25">    color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cluster_to_color[np.nan] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pd.isna(cluster) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> cluster_to_color[cluster]</span>
<span id="cb10-26">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>]].values</span>
<span id="cb10-27">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.vstack([coords, coords[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># close the polygon</span></span>
<span id="cb10-28">    ax.fill(coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], facecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-29"></span>
<span id="cb10-30"></span>
<span id="cb10-31">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>, adjustable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'box'</span>)</span>
<span id="cb10-32">ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Removes axes and grid</span></span>
<span id="cb10-33"></span>
<span id="cb10-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb10-35">make_scale_bar_py(ax, plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>], plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>])</span>
<span id="cb10-36"></span>
<span id="cb10-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create legend handles</span></span>
<span id="cb10-38">legend_handles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb10-39">    mpatches.Patch(</span>
<span id="cb10-40">      color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color, </span>
<span id="cb10-41">      label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Cluster </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(cluster)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pd.notna(cluster) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cluster NA"</span>)</span>
<span id="cb10-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> cluster, color <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> cluster_to_color.items()</span>
<span id="cb10-43">]</span>
<span id="cb10-44"></span>
<span id="cb10-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add legend to the right</span></span>
<span id="cb10-46">ax.legend(</span>
<span id="cb10-47">  handles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>legend_handles, </span>
<span id="cb10-48">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>, </span>
<span id="cb10-49">  bbox_to_anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.05</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb10-50">  loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper left'</span>,</span>
<span id="cb10-51">  fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,</span>
<span id="cb10-52">  title_fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb10-53"></span>
<span id="cb10-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save</span></span>
<span id="cb10-55">plt.savefig(os.path.join(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python_celltype_polygons_singleFOV.png"</span>), bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>, pad_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb10-56">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_celltype_polygons_singleFOV.png" class="img-fluid figure-img" width="602"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="highlight-one-cell-type" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="highlight-one-cell-type"><span class="header-section-number">3.4</span> Highlight One Cell Type</h3>
<p>Here we change the color on a single cell type, designated as tumor subtype A, to highlight these cells.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" aria-controls="tabset-6-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" aria-controls="tabset-6-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" aria-labelledby="tabset-6-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Add cell type to polygons</span></span>
<span id="cb11-2">plot.df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>()</span>
<span id="cb11-3">meta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(cell_meta)</span>
<span id="cb11-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(meta) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell</span>
<span id="cb11-5">plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(meta)[plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>] </span>
<span id="cb11-6"></span>
<span id="cb11-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Select cells to highlight</span></span>
<span id="cb11-8">plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>highlight <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tumor A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other"</span>)</span>
<span id="cb11-9"></span>
<span id="cb11-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar</span></span>
<span id="cb11-11">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> plot.df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(x_global_px),</span>
<span id="cb11-12">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span>  plot.df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(y_global_px))</span>
<span id="cb11-13"></span>
<span id="cb11-14"></span>
<span id="cb11-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb11-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot.df,</span>
<span id="cb11-17">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> cell,</span>
<span id="cb11-18">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> highlight)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_polygon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgrey"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_jco</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use a color palette from JCO (Journal of Clinical Oncology)</span></span>
<span id="cb11-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-24">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-25">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-26">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb11-27"> </span>
<span id="cb11-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltypeHighlight_polygons_singleFOV.png"</span>),</span>
<span id="cb11-29">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/celltypeHighlight_polygons_singleFOV.png" class="img-fluid figure-img" width="900"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" aria-labelledby="tabset-6-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter for FOV 100</span></span>
<span id="cb12-2">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_polygons[cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fov"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>]</span>
<span id="cb12-3"></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Merge only the 'leiden_cluster' and 'nCount_RNA' columns</span></span>
<span id="cb12-5">meta_subset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nCount_RNA'</span>]]</span>
<span id="cb12-6">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_df.merge(meta_subset, on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>, how<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>)</span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add highlight column</span></span>
<span id="cb12-9">plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'highlight'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Tumor A'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Other'</span>)</span>
<span id="cb12-10"></span>
<span id="cb12-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Plot</span></span>
<span id="cb12-12">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb12-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key, group <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> plot_df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell"</span>):</span>
<span id="cb12-14">    highlight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"highlight"</span>].iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb12-15">    fill_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#EFC000'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> highlight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Tumor A'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#0073C2'</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fill color logic, matching blue / yellow shown in R plot</span></span>
<span id="cb12-16">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>]].values</span>
<span id="cb12-17">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.vstack([coords, coords[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># close the polygon</span></span>
<span id="cb12-18">    ax.fill(coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], facecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>fill_color, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'darkgrey'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, zorder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb12-19"></span>
<span id="cb12-20">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>)</span>
<span id="cb12-21">ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb12-22"></span>
<span id="cb12-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb12-24">make_scale_bar_py(ax, plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>], plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>])</span>
<span id="cb12-25"></span>
<span id="cb12-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Legend</span></span>
<span id="cb12-27">legend_handles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb12-28">    mpatches.Patch(color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#0073C2'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Tumor A'</span>),</span>
<span id="cb12-29">    mpatches.Patch(color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#EFC000'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Other'</span>)</span>
<span id="cb12-30">]</span>
<span id="cb12-31">ax.legend(handles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>legend_handles, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>, bbox_to_anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.05</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper left'</span>)</span>
<span id="cb12-32"></span>
<span id="cb12-33">plt.savefig(os.path.join(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python_celltypeHighlight_polygons_singleFOV.png"</span>), bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>, pad_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb12-34">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_celltypeHighlight_polygons_singleFOV.png" class="img-fluid figure-img" width="898"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="mute-background-cells" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="mute-background-cells"><span class="header-section-number">3.5</span> Mute Background Cells</h3>
<p>As an alternative, we can highlight one cell type by muting the color for all others. However, keep in mind that when many colors are present, muting can reduce contrast and make distinctions harder to perceive. To improve interpretability, consider grouping cells into 5–10 major types or manually assigning similar hues to related cell types. As another option, color the cells of interest black, which may allow you to mute other colors less.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" aria-controls="tabset-7-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" aria-controls="tabset-7-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-7-1" class="tab-pane active" aria-labelledby="tabset-7-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Add cell type to polygons</span></span>
<span id="cb13-2">plot.df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>()</span>
<span id="cb13-3">meta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(cell_meta)</span>
<span id="cb13-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(meta) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell</span>
<span id="cb13-5">plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(meta)[plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>] </span>
<span id="cb13-6"></span>
<span id="cb13-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set alpha by cell type</span></span>
<span id="cb13-8">alpha_vals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type)))</span>
<span id="cb13-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(alpha_vals) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type))</span>
<span id="cb13-10">alpha_vals[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5"</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb13-11"></span>
<span id="cb13-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar</span></span>
<span id="cb13-13">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> plot.df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(x_global_px),</span>
<span id="cb13-14">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span>  plot.df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(y_global_px))</span>
<span id="cb13-15"></span>
<span id="cb13-16"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb13-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot.df,</span>
<span id="cb13-18">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> cell,</span>
<span id="cb13-19">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(cell_type), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(cell_type))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_polygon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgrey"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_d3</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category20"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgrey"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Inspired by colors in the D3 visualization library</span></span>
<span id="cb13-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_alpha_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> alpha_vals, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.value =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adjust opacity by cell type</span></span>
<span id="cb13-26">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-27">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-28">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb13-29">  </span>
<span id="cb13-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltypeAlphaHighlight_polygons_singleFOV.png"</span>),</span>
<span id="cb13-31">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/celltypeAlphaHighlight_polygons_singleFOV.png" class="img-fluid figure-img" width="900"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-7-2" class="tab-pane" aria-labelledby="tabset-7-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter for FOV 100</span></span>
<span id="cb14-2">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_polygons[cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fov"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>]</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Merge only the 'leiden_cluster' column</span></span>
<span id="cb14-5">meta_subset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>]]</span>
<span id="cb14-6">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_df.merge(meta_subset, on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>, how<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>)</span>
<span id="cb14-7"></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a colormap</span></span>
<span id="cb14-9">clusters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>].unique()</span>
<span id="cb14-10"></span>
<span id="cb14-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter out NA values first</span></span>
<span id="cb14-12">valid_clusters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [c <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> clusters <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pd.notna(c)]</span>
<span id="cb14-13"></span>
<span id="cb14-14">cmap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cm.get_cmap(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set3"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_clusters)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Use matplotlib's Set3 palette</span></span>
<span id="cb14-15">cluster_to_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {cluster: cmap(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, cluster <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(valid_clusters)}</span>
<span id="cb14-16"></span>
<span id="cb14-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Add color for NA values</span></span>
<span id="cb14-18">cluster_to_color[np.nan] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgrey"</span></span>
<span id="cb14-19"></span>
<span id="cb14-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add alpha column</span></span>
<span id="cb14-21">plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb14-22"></span>
<span id="cb14-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Plot</span></span>
<span id="cb14-24">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb14-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key, group <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> plot_df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell"</span>):</span>
<span id="cb14-26">    cell_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>].iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb14-27">    alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alpha"</span>].iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb14-28">    fill_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cluster_to_color[np.nan] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pd.isna(cell_type) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> cluster_to_color[cell_type]</span>
<span id="cb14-29">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>]].values</span>
<span id="cb14-30">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.vstack([coords, coords[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># close the polygon</span></span>
<span id="cb14-31">    ax.fill(coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], facecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>fill_color, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'darkgrey'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alpha, zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb14-32"></span>
<span id="cb14-33">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>)</span>
<span id="cb14-34">ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb14-35"></span>
<span id="cb14-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb14-37">make_scale_bar_py(ax, plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>], plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>])</span>
<span id="cb14-38"></span>
<span id="cb14-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Legend for fill colors</span></span>
<span id="cb14-40">unique_clusters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>].unique()</span>
<span id="cb14-41">legend_handles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb14-42">    mpatches.Patch(</span>
<span id="cb14-43">      color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color, </span>
<span id="cb14-44">      label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Cluster </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(cluster)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pd.notna(cluster) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cluster NA"</span>,</span>
<span id="cb14-45">      alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> cluster <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb14-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> cluster, color <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> cluster_to_color.items()</span>
<span id="cb14-47">]</span>
<span id="cb14-48">ax.legend(</span>
<span id="cb14-49">  handles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>legend_handles, </span>
<span id="cb14-50">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>, </span>
<span id="cb14-51">  bbox_to_anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>), </span>
<span id="cb14-52">  loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper left'</span>,</span>
<span id="cb14-53">  fontsize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,</span>
<span id="cb14-54">  title_fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb14-55"></span>
<span id="cb14-56">plt.savefig(os.path.join(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python_celltypeAlphaHighlight_polygons_singleFOV.png"</span>), bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>, pad_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb14-57">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_celltypeAlphaHighlight_polygons_singleFOV.png" class="img-fluid figure-img" width="845"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="dynamically-color-one-cell-type" class="level3" data-number="3.6">
<h3 data-number="3.6" class="anchored" data-anchor-id="dynamically-color-one-cell-type"><span class="header-section-number">3.6</span> Dynamically Color One Cell Type</h3>
<p>Sometimes we want to highlight metadata about a single cell type, such as counts per cell specifically for tumor cells. To do this, we can set all other cells to a background color such as light grey and then dynamically color the cells of interest.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-8-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-1" aria-controls="tabset-8-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-8-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-2" aria-controls="tabset-8-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-8-1" class="tab-pane active" aria-labelledby="tabset-8-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Add cell type and counts to polygons</span></span>
<span id="cb15-2">plot.df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>()</span>
<span id="cb15-3">meta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(cell_meta)</span>
<span id="cb15-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(meta) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell</span>
<span id="cb15-5">plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(meta)[plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>]</span>
<span id="cb15-6">plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nCount_RNA <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(meta)[plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nCount_RNA"</span>]</span>
<span id="cb15-7"></span>
<span id="cb15-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar</span></span>
<span id="cb15-9">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> plot.df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(x_global_px),</span>
<span id="cb15-10">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span>  plot.df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(y_global_px))</span>
<span id="cb15-11"></span>
<span id="cb15-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb15-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot.df,</span>
<span id="cb15-14">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> cell,</span>
<span id="cb15-15">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(cell_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5"</span>, nCount_RNA, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Logic to color only cells of one type by total counts</span></span>
<span id="cb15-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_polygon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgrey"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"magma"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trans =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log10"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgrey"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use viridis color palette</span></span>
<span id="cb15-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Transcripts per cell"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-21">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-22">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-23">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb15-24">  </span>
<span id="cb15-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltypeHighlightTxperCell_polygons_singleFOV.png"</span>),</span>
<span id="cb15-26">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/celltypeHighlightTxperCell_polygons_singleFOV.png" class="img-fluid figure-img" width="900"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-2" class="tab-pane" aria-labelledby="tabset-8-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter for FOV 100</span></span>
<span id="cb16-2">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_polygons[cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fov"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>]</span>
<span id="cb16-3"></span>
<span id="cb16-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Merge only the 'leiden_cluster' and 'nCount_RNA' columns</span></span>
<span id="cb16-5">meta_subset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nCount_RNA'</span>]]</span>
<span id="cb16-6">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_df.merge(meta_subset, on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>, how<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>)</span>
<span id="cb16-7"></span>
<span id="cb16-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare log10-transformed values for cluster 5</span></span>
<span id="cb16-9">highlight_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_df[plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>].copy()</span>
<span id="cb16-10">highlight_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log_nCount_RNA'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.log10(highlight_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nCount_RNA'</span>].replace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, np.nan)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Log10 transform</span></span>
<span id="cb16-11">vmin, vmax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> highlight_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log_nCount_RNA'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(), highlight_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log_nCount_RNA'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>()</span>
<span id="cb16-12">norm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mcolors.Normalize(vmin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vmin, vmax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vmax) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Normalize to 0 - 1 range as expected by matplotlib colormap</span></span>
<span id="cb16-13">cmap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cm.get_cmap(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"magma"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the magma palette</span></span>
<span id="cb16-14"></span>
<span id="cb16-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Assign colors dynamically</span></span>
<span id="cb16-16">cell_to_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb16-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _, row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> plot_df.iterrows():</span>
<span id="cb16-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> pd.notna(row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nCount_RNA'</span>]) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nCount_RNA'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb16-19">        log_val <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.log10(row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nCount_RNA'</span>])</span>
<span id="cb16-20">        scaled_val <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> norm(log_val)</span>
<span id="cb16-21">        cell_to_color[row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cmap(scaled_val)</span>
<span id="cb16-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb16-23">        cell_to_color[row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgrey"</span></span>
<span id="cb16-24"></span>
<span id="cb16-25"></span>
<span id="cb16-26"></span>
<span id="cb16-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Plot</span></span>
<span id="cb16-28">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb16-29"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key, group <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> plot_df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell"</span>):</span>
<span id="cb16-30">    fill_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_to_color[key]</span>
<span id="cb16-31">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>]].values</span>
<span id="cb16-32">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.vstack([coords, coords[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># close the polygon</span></span>
<span id="cb16-33">    ax.fill(coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], facecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>fill_color, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'darkgrey'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb16-34"></span>
<span id="cb16-35">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>)</span>
<span id="cb16-36">ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb16-37"></span>
<span id="cb16-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb16-39">make_scale_bar_py(ax, plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>], plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>])</span>
<span id="cb16-40"></span>
<span id="cb16-41"></span>
<span id="cb16-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add colorbar with original transcript counts</span></span>
<span id="cb16-43">sm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cm.ScalarMappable(cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cmap, norm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>norm)</span>
<span id="cb16-44">sm.set_array([])</span>
<span id="cb16-45">cbar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fig.colorbar(sm, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)</span>
<span id="cb16-46">tick_vals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(vmin, vmax, num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb16-47">cbar.set_ticks(tick_vals)</span>
<span id="cb16-48">cbar.set_ticklabels([<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>val)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:,}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> val <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tick_vals])</span>
<span id="cb16-49">cbar.set_label(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Transcripts per cell"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb16-50"></span>
<span id="cb16-51"></span>
<span id="cb16-52">plt.savefig(os.path.join(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python_celltypeHighlightTxperCell_polygons_singleFOV.png"</span>), bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>, pad_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb16-53">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_celltypeHighlightTxperCell_polygons_singleFOV.png" class="img-fluid figure-img" width="726"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="gallery-of-single-cell-type-highlighting" class="level3" data-number="3.7">
<h3 data-number="3.7" class="anchored" data-anchor-id="gallery-of-single-cell-type-highlighting"><span class="header-section-number">3.7</span> Gallery of single cell type highlighting</h3>
<p>Similar to above, here we highlight one cell type at a time. However, we now do this for each cell type separately and show a tiled gallery of all cell types. For this example, we show the whole tissue to give the broader context of where each cell type appears.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In making this gallery, plotting all cells in every facet causes many cells to be plotted if you’re looking at a large slide. Here, we instead show 5% of cells in our background to give a tissue overview and all 100% of cells of the type of interest in the foreground.</p>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-9-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-1" aria-controls="tabset-9-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-9-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-2" aria-controls="tabset-9-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-9-1" class="tab-pane active" aria-labelledby="tabset-9-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar</span></span>
<span id="cb17-2">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>CenterX_global_px,</span>
<span id="cb17-3">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span> cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>CenterY_global_px)</span>
<span id="cb17-4"></span>
<span id="cb17-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a copy of metadata that lacks the cell type</span></span>
<span id="cb17-6">df2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(cell_meta, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>leiden_cluster)</span>
<span id="cb17-7"></span>
<span id="cb17-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sample 5% of cells for background</span></span>
<span id="cb17-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2025</span>)</span>
<span id="cb17-10">df2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df2[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df2), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>),]</span>
<span id="cb17-11"></span>
<span id="cb17-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb17-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(cell_meta,</span>
<span id="cb17-14">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> CenterX_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> CenterY_global_px)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey80"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Background cells</span></span>
<span id="cb17-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Foreground highlighted cells</span></span>
<span id="cb17-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-19">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-20">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-21">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>leiden_cluster)</span>
<span id="cb17-23">  </span>
<span id="cb17-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gallery_celltype_positions.png"</span>),</span>
<span id="cb17-25">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/gallery_celltype_positions.png" class="img-fluid figure-img" width="1200"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-2" class="tab-pane" aria-labelledby="tabset-9-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a 5% random sample for background</span></span>
<span id="cb18-2">df2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta.drop(columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>).sample(frac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2025</span>)</span>
<span id="cb18-3"></span>
<span id="cb18-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create faceted plots by leiden_cluster</span></span>
<span id="cb18-5">unique_clusters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>].unique()</span>
<span id="cb18-6">unique_clusters.sort()</span>
<span id="cb18-7">n_clusters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(unique_clusters)</span>
<span id="cb18-8">n_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> math.ceil(math.sqrt(n_clusters))</span>
<span id="cb18-9">n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(np.ceil(n_clusters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> n_cols))</span>
<span id="cb18-10"></span>
<span id="cb18-11">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(n_rows, n_cols, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>), squeeze<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb18-12"></span>
<span id="cb18-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ax, cluster <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(axes.flat, unique_clusters):</span>
<span id="cb18-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Background layer</span></span>
<span id="cb18-15">    ax.scatter(df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterX_global_px'</span>], df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterY_global_px'</span>],</span>
<span id="cb18-16">               color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'grey'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb18-17"></span>
<span id="cb18-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Foreground red points for this cluster</span></span>
<span id="cb18-19">    cluster_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> cluster]</span>
<span id="cb18-20">    ax.scatter(cluster_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterX_global_px'</span>], cluster_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterY_global_px'</span>],</span>
<span id="cb18-21">               color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb18-22"></span>
<span id="cb18-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb18-24">    make_scale_bar_py(ax, cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterX_global_px'</span>], cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterY_global_px'</span>])</span>
<span id="cb18-25">    </span>
<span id="cb18-26">    ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Cluster </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>cluster<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-27">    ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>)</span>
<span id="cb18-28">    ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb18-29"></span>
<span id="cb18-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hide any unused subplots</span></span>
<span id="cb18-31"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ax <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> axes.flat[n_clusters:]:</span>
<span id="cb18-32">    ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb18-33"></span>
<span id="cb18-34">plt.tight_layout()</span>
<span id="cb18-35">plt.savefig(os.path.join(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python_gallery_celltype_positions.png"</span>), dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb18-36">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_gallery_celltype_positions.png" class="img-fluid figure-img" width="1200"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="plot-one-cell-and-its-20-nearest-neighbors" class="level3" data-number="3.8">
<h3 data-number="3.8" class="anchored" data-anchor-id="plot-one-cell-and-its-20-nearest-neighbors"><span class="header-section-number">3.8</span> Plot One Cell and Its 20 Nearest Neighbors</h3>
<p>For this plot, we select one cell of interest and plot it along with its 20 nearest neighbors, based on the cell centroids.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-10-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-1" aria-controls="tabset-10-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-10-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-2" aria-controls="tabset-10-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-10-1" class="tab-pane active" aria-labelledby="tabset-10-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Get cells to plot</span></span>
<span id="cb19-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract cell centroids</span></span>
<span id="cb19-3">xy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_meta[,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CenterX_global_px"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CenterY_global_px"</span>)]</span>
<span id="cb19-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(xy) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_id</span>
<span id="cb19-5"></span>
<span id="cb19-6">neighbors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> FNN<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get.knnx</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> xy, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2-column matrix of xy locations</span></span>
<span id="cb19-7">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">query =</span> xy, </span>
<span id="cb19-8">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set to one more than target. Value chosen includes the cell itself.</span></span>
<span id="cb19-9"></span>
<span id="cb19-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(neighbors<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.index) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(xy)</span>
<span id="cb19-11"></span>
<span id="cb19-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Select cell of interest</span></span>
<span id="cb19-13">coi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c_1_100_555"</span></span>
<span id="cb19-14"></span>
<span id="cb19-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract neighboring cells</span></span>
<span id="cb19-16">neighboring_cells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(neighbors<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.index)[neighbors<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.index[coi,]]</span>
<span id="cb19-17"></span>
<span id="cb19-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add cell type to polygons</span></span>
<span id="cb19-19">plot.df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(cell <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(neighboring_cells, coi)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>()</span>
<span id="cb19-20">meta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(cell_meta)</span>
<span id="cb19-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(meta) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell</span>
<span id="cb19-22">plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(meta)[plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>] </span>
<span id="cb19-23"></span>
<span id="cb19-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar</span></span>
<span id="cb19-25">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> plot.df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(x_global_px),</span>
<span id="cb19-26">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span>  plot.df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(y_global_px))</span>
<span id="cb19-27"></span>
<span id="cb19-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb19-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot.df,</span>
<span id="cb19-30">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> cell,</span>
<span id="cb19-31">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(cell_type), </span>
<span id="cb19-32">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> (cell <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Emphasize cell of interest</span></span>
<span id="cb19-33">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> (cell <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Emphasize cell of interest</span></span>
<span id="cb19-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_polygon</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-35">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_alpha_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TRUE"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FALSE"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-36">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TRUE"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FALSE"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgrey"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_npg</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use palette inspired by nature publishing group</span></span>
<span id="cb19-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-43">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-44">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-45">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb19-46"></span>
<span id="cb19-47"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_polygons_cell20neighbors.png"</span>),</span>
<span id="cb19-48">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/celltype_polygons_cell20neighbors.png" class="img-fluid figure-img" width="600"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-10-2" class="tab-pane" aria-labelledby="tabset-10-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract cell centroids</span></span>
<span id="cb20-2">xy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterX_global_px'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterY_global_px'</span>]].values</span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find nearest neighbors</span></span>
<span id="cb20-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#nbrs = sklearn.neighbors.NearestNeighbors(n_neighbors=21).fit(xy)</span></span>
<span id="cb20-6">nbrs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> NearestNeighbors(n_neighbors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>).fit(xy)</span>
<span id="cb20-7">distances, indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nbrs.kneighbors(xy)</span>
<span id="cb20-8"></span>
<span id="cb20-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Select cell of interest</span></span>
<span id="cb20-10">coi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c_1_100_555'</span></span>
<span id="cb20-11">coi_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell_id'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi].index[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb20-12"></span>
<span id="cb20-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract neighboring cells</span></span>
<span id="cb20-14">neighboring_cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta.iloc[indices[coi_index]].cell_id.values</span>
<span id="cb20-15"></span>
<span id="cb20-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add cell type to polygons</span></span>
<span id="cb20-17">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_polygons[cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>].isin(neighboring_cells)]</span>
<span id="cb20-18">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_df.merge(cell_meta[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell_id'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>]], left_on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>, right_on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell_id'</span>)</span>
<span id="cb20-19">plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alpha'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb20-20"></span>
<span id="cb20-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up color mapping</span></span>
<span id="cb20-22">unique_clusters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>].dropna().unique())</span>
<span id="cb20-23">cmap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.cm.get_cmap(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Accent"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(unique_clusters)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matplotlib's accent color palette</span></span>
<span id="cb20-24">cluster_to_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {cluster: cmap(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, cluster <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(unique_clusters)}</span>
<span id="cb20-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>].isna().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>():</span>
<span id="cb20-26">  cluster_to_color[np.nan] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgrey"</span></span>
<span id="cb20-27"></span>
<span id="cb20-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Plot</span></span>
<span id="cb20-29">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb20-30"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key, group <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> plot_df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell"</span>):</span>
<span id="cb20-31">    cell_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>].iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb20-32">    alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alpha"</span>].iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb20-33">    edge_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> group[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell"</span>].iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'darkgrey'</span></span>
<span id="cb20-34">    fill_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cluster_to_color[np.nan] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pd.isna(cell_type) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> cluster_to_color[cell_type]</span>
<span id="cb20-35">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>]].values</span>
<span id="cb20-36">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.vstack([coords, coords[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># close the polygon</span></span>
<span id="cb20-37">    ax.fill(coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], facecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>fill_color, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>edge_color, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alpha, zorder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-38"></span>
<span id="cb20-39">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>)</span>
<span id="cb20-40">ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb20-41"></span>
<span id="cb20-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb20-43">make_scale_bar_py(ax, plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>], plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>])</span>
<span id="cb20-44"></span>
<span id="cb20-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Legend for fill colors</span></span>
<span id="cb20-46">legend_handles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb20-47">    mpatches.Patch(</span>
<span id="cb20-48">      color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color, </span>
<span id="cb20-49">      label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Cluster </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(cluster)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pd.notna(cluster) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cluster NA"</span>)</span>
<span id="cb20-50">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> cluster, color <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> cluster_to_color.items()</span>
<span id="cb20-51">]</span>
<span id="cb20-52"></span>
<span id="cb20-53">ax.legend(handles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>legend_handles, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>, bbox_to_anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.05</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper left'</span>)</span>
<span id="cb20-54"></span>
<span id="cb20-55">plt.tight_layout()</span>
<span id="cb20-56">plt.savefig(os.path.join(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python_celltype_polygons_cell20neighbors.png"</span>), bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>, pad_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb20-57">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_celltype_polygons_cell20neighbors.png" class="img-fluid figure-img" width="852"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="plot-one-cell-in-its-neighborhood" class="level3" data-number="3.9">
<h3 data-number="3.9" class="anchored" data-anchor-id="plot-one-cell-in-its-neighborhood"><span class="header-section-number">3.9</span> Plot one cell in its neighborhood</h3>
<p>Sometimes, plotting a single cell alongside its x nearest neighbors can give a misleading impression, making it seem like the cells are isolated, even when they’re actually part of a densely packed region. A more spatially accurate alternative is to visualize a square section of tissue centered on a cell of interest.</p>
<p>To do this, we first select all cells within a broader radius to ensure complete polygon shapes are captured. Then, we trim the plot to display only a smaller, focused square around the target cell. This approach preserves spatial context while highlighting the local environment.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-11-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-1" aria-controls="tabset-11-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-11-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-2" aria-controls="tabset-11-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-11-1" class="tab-pane active" aria-labelledby="tabset-11-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Get cells to plot</span></span>
<span id="cb21-2"></span>
<span id="cb21-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Conversion factor for commercial CosMx instrument.</span></span>
<span id="cb21-4">microns_per_pixel <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.12028</span></span>
<span id="cb21-5"></span>
<span id="cb21-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Select cell of interest</span></span>
<span id="cb21-7">coi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c_1_100_555"</span></span>
<span id="cb21-8"></span>
<span id="cb21-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set square edge size in microns and pixels</span></span>
<span id="cb21-10">square_edge_um <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb21-11">square_edge_px <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> square_edge_um <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> microns_per_pixel</span>
<span id="cb21-12"></span>
<span id="cb21-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract large square boundaries, double the width and height of target, centered on coi</span></span>
<span id="cb21-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensures that we're not cutting through a cell</span></span>
<span id="cb21-15">coi_x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(cell <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(x_global_px) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>()</span>
<span id="cb21-16">coi_y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(cell <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(y_global_px) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>()</span>
<span id="cb21-17">plot.df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb21-18">  x_global_px <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> (coi_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px),</span>
<span id="cb21-19">   x_global_px <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (coi_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px),</span>
<span id="cb21-20">   y_global_px <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> (coi_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px),</span>
<span id="cb21-21">   y_global_px <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (coi_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px)</span>
<span id="cb21-22">)</span>
<span id="cb21-23"></span>
<span id="cb21-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add cell type to polygons</span></span>
<span id="cb21-25">meta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(cell_meta)</span>
<span id="cb21-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(meta) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell</span>
<span id="cb21-27">plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(meta)[plot.df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"leiden_cluster"</span>] </span>
<span id="cb21-28"></span>
<span id="cb21-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar, adding min / max values directly because we'll be showing a subset of the data</span></span>
<span id="cb21-30">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(coi_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, coi_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb21-31">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(coi_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, coi_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb21-32"></span>
<span id="cb21-33"></span>
<span id="cb21-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb21-35"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot.df,</span>
<span id="cb21-36">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> cell,</span>
<span id="cb21-37">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(cell_type), </span>
<span id="cb21-38">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> (cell <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Emphasize cell of interest</span></span>
<span id="cb21-39">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> (cell <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Emphasize cell of interest</span></span>
<span id="cb21-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_polygon</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-41">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_alpha_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TRUE"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FALSE"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TRUE"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FALSE"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgrey"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_d3</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category20c"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Inspired by colors in the D3 visualization library</span></span>
<span id="cb21-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-46">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-48">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set reduced coordinates</span></span>
<span id="cb21-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ratio =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb21-50">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(coi_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, coi_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb21-51">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(coi_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, coi_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-52">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-53">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-54">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb21-55"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_polygons_cell100umsquare.png"</span>),</span>
<span id="cb21-56">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/celltype_polygons_cell100umsquare.png" class="img-fluid figure-img" width="900"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-11-2" class="tab-pane" aria-labelledby="tabset-11-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Constants</span></span>
<span id="cb22-2">microns_per_pixel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.12028</span></span>
<span id="cb22-3">coi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c_1_100_555"</span></span>
<span id="cb22-4">square_edge_um <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb22-5">square_edge_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> square_edge_um <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> microns_per_pixel</span>
<span id="cb22-6"></span>
<span id="cb22-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute centroid of cell of interest</span></span>
<span id="cb22-8">coi_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_polygons[cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi]</span>
<span id="cb22-9">coi_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coi_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>].median()</span>
<span id="cb22-10">coi_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coi_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>].median()</span>
<span id="cb22-11"></span>
<span id="cb22-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter polygons within square region</span></span>
<span id="cb22-13">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_polygons[</span>
<span id="cb22-14">    (cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> (coi_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb22-15">    (cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (coi_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb22-16">    (cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> (coi_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb22-17">    (cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (coi_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px))</span>
<span id="cb22-18">].copy()</span>
<span id="cb22-19"></span>
<span id="cb22-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add cell type</span></span>
<span id="cb22-21">meta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta.set_index(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>)</span>
<span id="cb22-22">plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell_type'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>])</span>
<span id="cb22-23"></span>
<span id="cb22-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up color mapping</span></span>
<span id="cb22-25">unique_clusters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_type"</span>].dropna().unique())</span>
<span id="cb22-26">cmap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.cm.get_cmap(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tab20b"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(unique_clusters)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matplotlib's tab20b palette</span></span>
<span id="cb22-27">cluster_to_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {cluster: cmap(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, cluster <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(unique_clusters)}</span>
<span id="cb22-28"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_type"</span>].isna().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>():</span>
<span id="cb22-29">  cluster_to_color[np.nan] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgrey"</span></span>
<span id="cb22-30"></span>
<span id="cb22-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plotting</span></span>
<span id="cb22-32">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb22-33"></span>
<span id="cb22-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Group by cell to draw polygons</span></span>
<span id="cb22-35"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> cell_id, group <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> plot_df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell'</span>):</span>
<span id="cb22-36">    cell_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_type"</span>].iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb22-37">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>]].values</span>
<span id="cb22-38">    polygon <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mpatches.Polygon(coords, closed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb22-39">                      facecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cluster_to_color[np.nan] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pd.isna(cell_type) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> cluster_to_color[cell_type],</span>
<span id="cb22-40">                      edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> cell_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'darkgrey'</span>,</span>
<span id="cb22-41">                      alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> cell_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> coi <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb22-42">    ax.add_patch(polygon)</span>
<span id="cb22-43">    </span>
<span id="cb22-44"></span>
<span id="cb22-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar, setting up arrays that are the axis limits since we'll be reducing the plotting window</span></span>
<span id="cb22-46">make_scale_bar_py(ax, np.array([coi_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, coi_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]), np.array([coi_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, coi_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))  </span>
<span id="cb22-47"></span>
<span id="cb22-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set plot limits and aspect</span></span>
<span id="cb22-49">ax.set_xlim(coi_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, coi_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb22-50">ax.set_ylim(coi_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> square_edge_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, coi_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> square_edge_px <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb22-51">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>)</span>
<span id="cb22-52">ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb22-53"></span>
<span id="cb22-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Legend for fill colors with only colors in the visible region</span></span>
<span id="cb22-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get current axis limits</span></span>
<span id="cb22-56">xlim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.get_xlim()</span>
<span id="cb22-57">ylim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.get_ylim()</span>
<span id="cb22-58"></span>
<span id="cb22-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Identify cells whose polygons fall within the visible region</span></span>
<span id="cb22-60">visible_cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_df[</span>
<span id="cb22-61">    (plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> xlim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> xlim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb22-62">    (plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> ylim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> ylim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb22-63">]</span>
<span id="cb22-64"></span>
<span id="cb22-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get unique visible cell types</span></span>
<span id="cb22-66">visible_cell_types <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> visible_cells[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell_type'</span>].dropna().unique().tolist()</span>
<span id="cb22-67"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> visible_cells[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell_type'</span>].isna().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>():</span>
<span id="cb22-68">    visible_cell_types.append(np.nan)</span>
<span id="cb22-69"></span>
<span id="cb22-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter legend handles to only include visible cell types</span></span>
<span id="cb22-71">legend_handles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb22-72">    mpatches.Patch(</span>
<span id="cb22-73">        color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color,</span>
<span id="cb22-74">        label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Cluster </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(cluster)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> pd.notna(cluster) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cluster NA"</span></span>
<span id="cb22-75">    )</span>
<span id="cb22-76">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> cluster, color <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> cluster_to_color.items()</span>
<span id="cb22-77">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> cluster <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> visible_cell_types</span>
<span id="cb22-78">]</span>
<span id="cb22-79"></span>
<span id="cb22-80"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the filtered legend</span></span>
<span id="cb22-81">ax.legend(handles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>legend_handles, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>, bbox_to_anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.05</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper left'</span>)</span>
<span id="cb22-82"></span>
<span id="cb22-83"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save figure</span></span>
<span id="cb22-84">plt.tight_layout()</span>
<span id="cb22-85">plt.savefig(os.path.join(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python_celltype_polygons_cell100umsquare.png"</span>), dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>)</span>
<span id="cb22-86">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_celltype_polygons_cell100umsquare.png" class="img-fluid figure-img" width="884"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="overlay-specific-transcripts" class="level3" data-number="3.10">
<h3 data-number="3.10" class="anchored" data-anchor-id="overlay-specific-transcripts"><span class="header-section-number">3.10</span> Overlay Specific Transcripts</h3>
<p>Add transcripts of interest (e.g., <code>KRT8</code>) as points.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Transcript File Performance Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Reading the full transcript file into memory can be computationally intensive, especially if you’re only interested in a subset of transcripts for plotting.</p>
<p>Instead of loading the entire file, here we filter the relevant lines using a shell command before importing them into R with <code>fread()</code> or into Python. This can significantly reduce load time although with a large dataset it still may take a few minutes.</p>
<p>For even better performance in future workflows, you might convert the transcript file to a more efficient format like <strong>Parquet</strong>, which supports faster reads and selective column access.</p>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-12-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-1" aria-controls="tabset-12-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-12-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-2" aria-controls="tabset-12-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-12-1" class="tab-pane active" aria-labelledby="tabset-12-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Read in transcripts</span></span>
<span id="cb23-2"></span>
<span id="cb23-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define your file name as a variable</span></span>
<span id="cb23-4">file_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(raw_data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>, slide_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_tx_file.csv.gz"</span>)</span>
<span id="cb23-5"></span>
<span id="cb23-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Construct the shell command using sprintf</span></span>
<span id="cb23-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fov is in column 1 and target is in column 9</span></span>
<span id="cb23-8">cmd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zcat %s | awk -F',' 'NR==1 || ($1==</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> &amp;&amp; $9==</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">KRT8</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\"</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)'"</span>, file_name)</span>
<span id="cb23-9"></span>
<span id="cb23-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read the filtered tx data</span></span>
<span id="cb23-11">filtered_tx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cmd =</span> cmd)</span>
<span id="cb23-12"></span>
<span id="cb23-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar</span></span>
<span id="cb23-14">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(x_global_px),</span>
<span id="cb23-15">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span>  cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(y_global_px))</span>
<span id="cb23-16"></span>
<span id="cb23-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb23-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(cell_polygons <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>),</span>
<span id="cb23-19">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> cell)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_polygon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgrey"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgrey"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> filtered_tx, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_global_px), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Overlay transcript points</span></span>
<span id="cb23-22">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>()  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-25">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-26">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-27">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb23-28">  </span>
<span id="cb23-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"polygons_singleFOV_singleTx.png"</span>),</span>
<span id="cb23-30">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/polygons_singleFOV_singleTx.png" class="img-fluid figure-img" width="900"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-12-2" class="tab-pane" aria-labelledby="tabset-12-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define your file name as a variable</span></span>
<span id="cb24-2">file_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(raw_data_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>slide_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_tx_file.csv.gz"</span>)</span>
<span id="cb24-3"></span>
<span id="cb24-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Construct the shell command using sprintf</span></span>
<span id="cb24-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fov is in column 1 and target is in column 9</span></span>
<span id="cb24-6">cmd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"zcat </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>file_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> | awk -F',' 'NR==1 || ($1==</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">100</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> &amp;&amp; $9==</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">KRT8</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\"</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)'"</span></span>
<span id="cb24-7"></span>
<span id="cb24-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the command and capture output</span></span>
<span id="cb24-9">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> subprocess.run(cmd, shell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, stdout<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>subprocess.PIPE, text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb24-10"></span>
<span id="cb24-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read the filtered result into a DataFrame</span></span>
<span id="cb24-12">filtered_tx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(io.StringIO(result.stdout))</span>
<span id="cb24-13"></span>
<span id="cb24-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter cell polygons to focus on one fov</span></span>
<span id="cb24-15">plot_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_polygons[cell_polygons[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fov"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>]</span>
<span id="cb24-16"></span>
<span id="cb24-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot</span></span>
<span id="cb24-18">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb24-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _, group <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> plot_df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell"</span>):</span>
<span id="cb24-20">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> group[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>]].values</span>
<span id="cb24-21">    coords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.vstack([coords, coords[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># close the polygon</span></span>
<span id="cb24-22">    ax.fill(coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], coords[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], facecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgrey"</span>, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgrey"</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb24-23"></span>
<span id="cb24-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Overlay transcript dots</span></span>
<span id="cb24-25">ax.scatter(filtered_tx[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>], filtered_tx[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb24-26"></span>
<span id="cb24-27">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>, adjustable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'box'</span>)</span>
<span id="cb24-28">ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb24-29"></span>
<span id="cb24-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb24-31">make_scale_bar_py(ax, plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>], plot_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>])</span>
<span id="cb24-32"></span>
<span id="cb24-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save</span></span>
<span id="cb24-34">plt.savefig(os.path.join(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python_polygons_singleFOV_singleTx.png"</span>), bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>, pad_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb24-35">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_polygons_singleFOV_singleTx.png" class="img-fluid figure-img" width="462"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="qc-module-visualizations" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="qc-module-visualizations"><span class="header-section-number">4</span> QC Module Visualizations</h2>
<p>Here we generate plots to visualize many of the metrics output by the <a href="https://github.com/Nanostring-Biostats/CosMxDACustomModules/tree/main/RNAQCPlots" target="_blank">RNAQC plots module</a> for AtoMx SIP.</p>
<p>We start by reading in the outputs of this module for use in multiple of the plots in this section. We also add one more column, SNR, which we calculate as mean transcripts per plex / mean negative probes per plex.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-13-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-1" aria-controls="tabset-13-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-13-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-2" aria-controls="tabset-13-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-13-1" class="tab-pane active" aria-labelledby="tabset-13-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1">qc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(raw_data_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Per_FOV_data_quality_metrics.csv"</span>), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For convenience, we assume this is stored in the same directory as the flat files.</span></span>
<span id="cb25-2">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row.names =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb25-3"></span>
<span id="cb25-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up plex for this dataset</span></span>
<span id="cb25-5">dataset_plex <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18935</span></span>
<span id="cb25-6"></span>
<span id="cb25-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add per FOV SNR</span></span>
<span id="cb25-8">qc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>SNR_Per_FOV <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (qc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Mean_Transcripts_Per_Cell_Per_FOV <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> dataset_plex) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> qc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Mean_Negative_Probe_Per_Plex_Per_Cell_Per_FOV</span></code></pre></div>
</details>
</div>
</div>
<div id="tabset-13-2" class="tab-pane" aria-labelledby="tabset-13-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">qc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(Path(raw_data_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Per_FOV_data_quality_metrics.csv"</span>), index_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For convenience, we assume this is stored in the same directory as the flat files.</span></span>
<span id="cb26-2"></span>
<span id="cb26-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up plex for this dataset</span></span>
<span id="cb26-4">dataset_plex <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18935</span></span>
<span id="cb26-5"></span>
<span id="cb26-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add per FOV SNR</span></span>
<span id="cb26-7">qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SNR_Per_FOV'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Mean_Transcripts_Per_Cell_Per_FOV'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> dataset_plex) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Mean_Negative_Probe_Per_Plex_Per_Cell_Per_FOV'</span>]</span></code></pre></div>
</details>
</div>
</div>
</div>
</div>
<section id="distribution-of-qc-metrics" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="distribution-of-qc-metrics"><span class="header-section-number">4.1</span> Distribution of QC Metrics</h3>
<p>Histograms showing the distribution for each per FOV metric.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-16-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-1" aria-controls="tabset-16-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-16-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-2" aria-controls="tabset-16-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-16-1" class="tab-pane active" aria-labelledby="tabset-16-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract fov metric columns to plot</span></span>
<span id="cb27-2">fov_metrics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Per_FOV"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(qc), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb27-3"></span>
<span id="cb27-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(fov_metric <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> fov_metrics){</span>
<span id="cb27-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(qc, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(fov_metric))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>, fov_metric)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ylab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of FOVs"</span>)</span>
<span id="cb27-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/Histogram_qc_"</span>, fov_metric, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>),</span>
<span id="cb27-12">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span>
<span id="cb27-13">}</span></code></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-14-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-1" aria-controls="tabset-14-1" aria-selected="true">Mean_Negative_Probe_Per_Plex_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-14-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-2" aria-controls="tabset-14-2" aria-selected="false">Mean_SystemControl_Per_Plex_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-14-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-3" aria-controls="tabset-14-3" aria-selected="false">Mean_Transcripts_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-14-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-4" aria-controls="tabset-14-4" aria-selected="false">Mean_Unique_Transcripts_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-14-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-5" aria-controls="tabset-14-5" aria-selected="false">Number_Cells_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-14-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-6" aria-controls="tabset-14-6" aria-selected="false">SNR_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-14-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-7" aria-controls="tabset-14-7" aria-selected="false">Total_Transcripts_Per_FOV</a></li></ul>
<div class="tab-content">
<div id="tabset-14-1" class="tab-pane active" aria-labelledby="tabset-14-1-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/Histogram_qc_Mean_Negative_Probe_Per_Plex_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1200"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-14-2" class="tab-pane" aria-labelledby="tabset-14-2-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/Histogram_qc_Mean_SystemControl_Per_Plex_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1200"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-14-3" class="tab-pane" aria-labelledby="tabset-14-3-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/Histogram_qc_Mean_Transcripts_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1200"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-14-4" class="tab-pane" aria-labelledby="tabset-14-4-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/Histogram_qc_Mean_Unique_Transcripts_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1200"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-14-5" class="tab-pane" aria-labelledby="tabset-14-5-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/Histogram_qc_Number_Cells_Per_FOV.png" class="img-fluid figure-img" width="1200"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-14-6" class="tab-pane" aria-labelledby="tabset-14-6-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/Histogram_qc_SNR_Per_FOV.png" class="img-fluid figure-img" width="1200"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-14-7" class="tab-pane" aria-labelledby="tabset-14-7-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/Histogram_qc_Total_Transcripts_Per_FOV.png" class="img-fluid figure-img" width="1200"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-16-2" class="tab-pane" aria-labelledby="tabset-16-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract FOV metric columns</span></span>
<span id="cb28-2">fov_metrics <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [col <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> col <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> qc.columns <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Per_FOV'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> col]</span>
<span id="cb28-3"></span>
<span id="cb28-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate histograms</span></span>
<span id="cb28-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fov_metric <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> fov_metrics:</span>
<span id="cb28-6">    plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb28-7">    plt.hist(qc[fov_metric].dropna(), bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'steelblue'</span>, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>)</span>
<span id="cb28-8">    plt.title(fov_metric.replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>))</span>
<span id="cb28-9">    plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb28-10">    plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Number of FOVs'</span>)</span>
<span id="cb28-11">    plt.tight_layout()</span>
<span id="cb28-12">    plt.savefig(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>out_dir<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/python_Histogram_qc_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fov_metric<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.png"</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb28-13">    plt.close()</span></code></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-15-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-1" aria-controls="tabset-15-1" aria-selected="true">Mean_Negative_Probe_Per_Plex_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-15-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-2" aria-controls="tabset-15-2" aria-selected="false">Mean_SystemControl_Per_Plex_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-15-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-3" aria-controls="tabset-15-3" aria-selected="false">Mean_Transcripts_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-15-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-4" aria-controls="tabset-15-4" aria-selected="false">Mean_Unique_Transcripts_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-15-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-5" aria-controls="tabset-15-5" aria-selected="false">Number_Cells_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-15-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-6" aria-controls="tabset-15-6" aria-selected="false">SNR_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-15-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-7" aria-controls="tabset-15-7" aria-selected="false">Total_Transcripts_Per_FOV</a></li></ul>
<div class="tab-content">
<div id="tabset-15-1" class="tab-pane active" aria-labelledby="tabset-15-1-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_Histogram_qc_Mean_Negative_Probe_Per_Plex_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-15-2" class="tab-pane" aria-labelledby="tabset-15-2-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_Histogram_qc_Mean_SystemControl_Per_Plex_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-15-3" class="tab-pane" aria-labelledby="tabset-15-3-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_Histogram_qc_Mean_Transcripts_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-15-4" class="tab-pane" aria-labelledby="tabset-15-4-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_Histogram_qc_Mean_Unique_Transcripts_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-15-5" class="tab-pane" aria-labelledby="tabset-15-5-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_Histogram_qc_Number_Cells_Per_FOV.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-15-6" class="tab-pane" aria-labelledby="tabset-15-6-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_Histogram_qc_SNR_Per_FOV.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-15-7" class="tab-pane" aria-labelledby="tabset-15-7-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_Histogram_qc_Total_Transcripts_Per_FOV.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="spatial-visualization-of-per-fov-metrics" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="spatial-visualization-of-per-fov-metrics"><span class="header-section-number">4.2</span> Spatial visualization of per FOV metrics</h3>
<p>To help identify spatial patterns in quality control metrics, we generate a spatial plot for each FOV. Each plot includes the FOV number overlaid for easy reference and comparison across the tissue.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-19-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-19-1" aria-controls="tabset-19-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-19-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-19-2" aria-controls="tabset-19-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-19-1" class="tab-pane active" aria-labelledby="tabset-19-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract fov metric columns to plot</span></span>
<span id="cb29-2">fov_metrics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Per_FOV"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(qc), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb29-3"></span>
<span id="cb29-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add xy positions for each FOV to qc dataframe</span></span>
<span id="cb29-5">fov_positions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(fov_positions)</span>
<span id="cb29-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(fov_positions) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(fov_positions<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>FOV)</span>
<span id="cb29-7">qc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>x_global_px <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fov_positions[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(qc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fov), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>]</span>
<span id="cb29-8">qc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y_global_px <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fov_positions[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(qc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fov), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>]</span>
<span id="cb29-9"></span>
<span id="cb29-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar for all plots</span></span>
<span id="cb29-11">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> qc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(x_global_px),</span>
<span id="cb29-12">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span>  qc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(y_global_px))</span>
<span id="cb29-13"></span>
<span id="cb29-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot each per FOV metric in space</span></span>
<span id="cb29-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(fov_metric <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> fov_metrics){</span>
<span id="cb29-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(qc, </span>
<span id="cb29-17">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_global_px, </span>
<span id="cb29-18">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(fov_metric))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_tile</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4254</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4254</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#CosMx FOVs are 4254x4254 pixels</span></span>
<span id="cb29-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_gradient</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"magenta"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> fov)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Label each FOV in space</span></span>
<span id="cb29-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-23">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>, fov_metric),</span>
<span id="cb29-24">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>, fov_metric)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb29-26">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-27">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-28">    scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-29">    scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-30">    scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb29-31">    </span>
<span id="cb29-32">  </span>
<span id="cb29-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/XY_qc_"</span>, fov_metric, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>),</span>
<span id="cb29-34">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span>
<span id="cb29-35">}</span></code></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-17-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-1" aria-controls="tabset-17-1" aria-selected="true">Mean_Negative_Probe_Per_Plex_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-17-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-2" aria-controls="tabset-17-2" aria-selected="false">Mean_SystemControl_Per_Plex_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-17-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-3" aria-controls="tabset-17-3" aria-selected="false">Mean_Transcripts_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-17-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-4" aria-controls="tabset-17-4" aria-selected="false">Mean_Unique_Transcripts_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-17-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-5" aria-controls="tabset-17-5" aria-selected="false">Number_Cells_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-17-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-6" aria-controls="tabset-17-6" aria-selected="false">SNR_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-17-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-7" aria-controls="tabset-17-7" aria-selected="false">Total_Transcripts_Per_FOV</a></li></ul>
<div class="tab-content">
<div id="tabset-17-1" class="tab-pane active" aria-labelledby="tabset-17-1-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/XY_qc_Mean_Negative_Probe_Per_Plex_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-17-2" class="tab-pane" aria-labelledby="tabset-17-2-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/XY_qc_Mean_SystemControl_Per_Plex_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-17-3" class="tab-pane" aria-labelledby="tabset-17-3-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/XY_qc_Mean_Transcripts_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-17-4" class="tab-pane" aria-labelledby="tabset-17-4-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/XY_qc_Mean_Unique_Transcripts_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-17-5" class="tab-pane" aria-labelledby="tabset-17-5-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/XY_qc_Number_Cells_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-17-6" class="tab-pane" aria-labelledby="tabset-17-6-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/XY_qc_SNR_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-17-7" class="tab-pane" aria-labelledby="tabset-17-7-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/XY_qc_Total_Transcripts_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-19-2" class="tab-pane" aria-labelledby="tabset-19-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract FOV metric columns</span></span>
<span id="cb30-2">fov_metrics <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [col <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> col <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> qc.columns <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Per_FOV'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> col]</span>
<span id="cb30-3"></span>
<span id="cb30-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add xy positions for each FOV to qc dataframe</span></span>
<span id="cb30-5">fov_positions.set_index(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'FOV'</span>, inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb30-6">qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fov'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(fov_positions[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>])</span>
<span id="cb30-7">qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fov'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(fov_positions[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>])</span>
<span id="cb30-8"></span>
<span id="cb30-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up a color scale to use</span></span>
<span id="cb30-10">blue_magenta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mcolors.LinearSegmentedColormap.from_list(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue_magenta"</span>, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"magenta"</span>])</span>
<span id="cb30-11"></span>
<span id="cb30-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot each per FOV metric in space</span></span>
<span id="cb30-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> fov_metric <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> fov_metrics:</span>
<span id="cb30-14">    fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>))</span>
<span id="cb30-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The 's' parameter indicates the point size and was empirically determined for this dataset.</span></span>
<span id="cb30-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># You may need to increase or decrease it to get the boxes to fill the space in other datasets.</span></span>
<span id="cb30-17">    ax.scatter(qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>], qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>], c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>qc[fov_metric], cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'coolwarm'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">700</span>, marker <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"s"</span>)</span>
<span id="cb30-18">    scatter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.scatter(qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>], qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>], c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>qc[fov_metric], cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>blue_magenta, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">700</span>, marker <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"s"</span>)</span>
<span id="cb30-19">    cbar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fig.colorbar(scatter, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)</span>
<span id="cb30-20">    cbar.set_label(fov_metric.replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>))</span>
<span id="cb30-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> qc.iterrows():</span>
<span id="cb30-22">        ax.text(row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>], row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fov'</span>]), fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'center'</span>, va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'center'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>)</span>
<span id="cb30-23">    ax.set_title(fov_metric.replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>))</span>
<span id="cb30-24">    ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>, adjustable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'box'</span>)</span>
<span id="cb30-25">    ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb30-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb30-27">    make_scale_bar_py(ax, qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_global_px"</span>], qc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_global_px"</span>])</span>
<span id="cb30-28">    </span>
<span id="cb30-29">    plt.savefig(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>out_dir<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/python_XY_qc_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fov_metric<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.png"</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb30-30">    plt.close()</span></code></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-18-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-1" aria-controls="tabset-18-1" aria-selected="true">Mean_Negative_Probe_Per_Plex_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-18-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-2" aria-controls="tabset-18-2" aria-selected="false">Mean_SystemControl_Per_Plex_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-18-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-3" aria-controls="tabset-18-3" aria-selected="false">Mean_Transcripts_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-18-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-4" aria-controls="tabset-18-4" aria-selected="false">Mean_Unique_Transcripts_Per_Cell_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-18-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-5" aria-controls="tabset-18-5" aria-selected="false">Number_Cells_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-18-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-6" aria-controls="tabset-18-6" aria-selected="false">SNR_Per_FOV</a></li><li class="nav-item"><a class="nav-link" id="tabset-18-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-7" aria-controls="tabset-18-7" aria-selected="false">Total_Transcripts_Per_FOV</a></li></ul>
<div class="tab-content">
<div id="tabset-18-1" class="tab-pane active" aria-labelledby="tabset-18-1-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_XY_qc_Mean_Negative_Probe_Per_Plex_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-18-2" class="tab-pane" aria-labelledby="tabset-18-2-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_XY_qc_Mean_SystemControl_Per_Plex_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-18-3" class="tab-pane" aria-labelledby="tabset-18-3-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_XY_qc_Mean_Transcripts_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-18-4" class="tab-pane" aria-labelledby="tabset-18-4-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_XY_qc_Mean_Unique_Transcripts_Per_Cell_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-18-5" class="tab-pane" aria-labelledby="tabset-18-5-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_XY_qc_Number_Cells_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-18-6" class="tab-pane" aria-labelledby="tabset-18-6-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_XY_qc_SNR_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-18-7" class="tab-pane" aria-labelledby="tabset-18-7-tab">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_XY_qc_Total_Transcripts_Per_FOV.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="qc-metric-by-cell-type" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="qc-metric-by-cell-type"><span class="header-section-number">4.3</span> QC Metric by Cell Type</h3>
<p>In addition to the outputs of the QC module, there are a number of QC metrics that can be extracted from the meta data and plotted by cell type. As an example here, we show transcripts per cell separated by cell type.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-20-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-20-1" aria-controls="tabset-20-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-20-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-20-2" aria-controls="tabset-20-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-20-1" class="tab-pane active" aria-labelledby="tabset-20-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>leiden_cluster)</span>
<span id="cb31-2"></span>
<span id="cb31-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use alphabet palette</span></span>
<span id="cb31-4">my_pal <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pals<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alphabet</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type)))</span>
<span id="cb31-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(my_pal) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_type)</span>
<span id="cb31-6"></span>
<span id="cb31-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(cell_meta, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> cell_type, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> nCount_RNA, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> cell_type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_boxplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> my_pal) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xlab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ylab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Transcript counts per cell"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Transcript Count by Cell Type"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_log10</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb31-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/BarPlot_qc_txPerCell_cellType.png"</span>),</span>
<span id="cb31-18">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/BarPlot_qc_txPerCell_cellType.png" class="img-fluid figure-img" width="900"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-20-2" class="tab-pane" aria-labelledby="tabset-20-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert leiden_cluster to string and assign to cell_type</span></span>
<span id="cb32-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fill NaNs with a placeholder (e.g., -1) before converting</span></span>
<span id="cb32-3">cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>].fillna(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb32-4">cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell_type'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>].astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>).astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>)</span>
<span id="cb32-5"></span>
<span id="cb32-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert NA values back</span></span>
<span id="cb32-7">cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>].replace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, np.nan)</span>
<span id="cb32-8">cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell_type'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell_type'</span>].replace({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-1'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Not assigned'</span>})</span>
<span id="cb32-9"></span>
<span id="cb32-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get unique cell types and assign colors</span></span>
<span id="cb32-11">unique_cell_types <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell_type'</span>].unique(), key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x.isdigit() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'inf'</span>))</span>
<span id="cb32-12">colors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.cm.get_cmap(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tab20c'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(unique_cell_types)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Use tab20c palette</span></span>
<span id="cb32-13">color_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {cell_type: colors(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, cell_type <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(unique_cell_types)}</span>
<span id="cb32-14"></span>
<span id="cb32-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare data for boxplot</span></span>
<span id="cb32-16">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [cell_meta[cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cell_type'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> ct][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nCount_RNA'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ct <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> unique_cell_types]</span>
<span id="cb32-17"></span>
<span id="cb32-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the boxplot</span></span>
<span id="cb32-19">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb32-20">box <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.boxplot(data, patch_artist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, labels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>unique_cell_types)</span>
<span id="cb32-21"></span>
<span id="cb32-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply colors to boxes</span></span>
<span id="cb32-23"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> patch, ct <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(box[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'boxes'</span>], unique_cell_types):</span>
<span id="cb32-24">    patch.set_facecolor(color_dict[ct])</span>
<span id="cb32-25"></span>
<span id="cb32-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Customize plot</span></span>
<span id="cb32-27">ax.set_yscale(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log'</span>)</span>
<span id="cb32-28">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Cell type'</span>)</span>
<span id="cb32-29">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Transcript counts per cell'</span>)</span>
<span id="cb32-30">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Transcript Count by Cell Type'</span>)</span>
<span id="cb32-31">plt.xticks(rotation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'right'</span>)</span>
<span id="cb32-32">plt.legend([], [], frameon<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove legend</span></span>
<span id="cb32-33">plt.tight_layout()</span>
<span id="cb32-34"></span>
<span id="cb32-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the plot</span></span>
<span id="cb32-36">plt.savefig(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>out_dir<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/python_BarPlot_qc_txPerCell_cellType.png"</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb32-37">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_BarPlot_qc_txPerCell_cellType.png" class="img-fluid figure-img" width="1800"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="per-cell-qc-metrics-in-space" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="per-cell-qc-metrics-in-space"><span class="header-section-number">4.4</span> Per cell QC metrics in space</h3>
<p>Another QC metric in the meta data is whether a cell has been ‘flagged’ by any of the QC steps in AtoMx. We can plot each cell’s ‘qcCellsFlagged’ status in space to look for spatial patterns in the cells get flagged. Keep an eye out for overplotting here, which can lead to the incorrect conclusion that all cells in a region have been lost. We reduce the opacity to counter this impression.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-21-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-21-1" aria-controls="tabset-21-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-21-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-21-2" aria-controls="tabset-21-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-21-1" class="tab-pane active" aria-labelledby="tabset-21-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar</span></span>
<span id="cb33-2">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>CenterX_global_px,</span>
<span id="cb33-3">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span>  cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>CenterY_global_px)</span>
<span id="cb33-4"></span>
<span id="cb33-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb33-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(cell_meta[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>qcCellsFlagged),], <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Ordering plots 'false' cells first</span></span>
<span id="cb33-7">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(CenterX_global_px, CenterY_global_px)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb33-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> qcCellsFlagged), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb33-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#D6DBDF"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#D86769"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb33-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb33-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Flagged"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb33-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb33-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>()  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-14">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-15">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-16">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb33-17">  </span>
<span id="cb33-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/qc_flaggedCells.png"</span>),</span>
<span id="cb33-19">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/qc_flaggedCells.png" class="img-fluid figure-img" width="600"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-21-2" class="tab-pane" aria-labelledby="tabset-21-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define color mapping for flagged status</span></span>
<span id="cb34-2">color_map <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#D86769"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#D6DBDF"</span>}</span>
<span id="cb34-3"></span>
<span id="cb34-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># To increase the visibility of the flagged cells, we split the data frame and plot the flagged cells second</span></span>
<span id="cb34-5">false_cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'qcCellsFlagged'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>]</span>
<span id="cb34-6">true_cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'qcCellsFlagged'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>]</span>
<span id="cb34-7"></span>
<span id="cb34-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the plot</span></span>
<span id="cb34-9">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb34-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cells not flagged</span></span>
<span id="cb34-11">ax.scatter(</span>
<span id="cb34-12">    false_cells[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterX_global_px'</span>],</span>
<span id="cb34-13">    false_cells[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterY_global_px'</span>],</span>
<span id="cb34-14">    c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>false_cells[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'qcCellsFlagged'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(color_map),</span>
<span id="cb34-15">    s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>,</span>
<span id="cb34-16">    alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,</span>
<span id="cb34-17">    zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb34-18">)</span>
<span id="cb34-19"></span>
<span id="cb34-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cells flagged</span></span>
<span id="cb34-21">ax.scatter(</span>
<span id="cb34-22">    true_cells[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterX_global_px'</span>],</span>
<span id="cb34-23">    true_cells[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterY_global_px'</span>],</span>
<span id="cb34-24">    c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true_cells[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'qcCellsFlagged'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(color_map),</span>
<span id="cb34-25">    s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>,</span>
<span id="cb34-26">    alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,</span>
<span id="cb34-27">    zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb34-28">)</span>
<span id="cb34-29"></span>
<span id="cb34-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb34-31">make_scale_bar_py(ax, cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CenterX_global_px"</span>], cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CenterY_global_px"</span>])</span>
<span id="cb34-32"></span>
<span id="cb34-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add a legend with larger marker size</span></span>
<span id="cb34-34"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib.lines <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Line2D</span>
<span id="cb34-35">legend_elements <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb34-36">    Line2D([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], marker<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'False'</span>,</span>
<span id="cb34-37">           markerfacecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color_map[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>], markersize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>),</span>
<span id="cb34-38">    Line2D([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], marker<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'o'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'True'</span>,</span>
<span id="cb34-39">           markerfacecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color_map[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>], markersize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb34-40">]</span>
<span id="cb34-41">ax.legend(handles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>legend_elements, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Flagged"</span>)</span>
<span id="cb34-42"></span>
<span id="cb34-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fix aspect ratio and remove axes</span></span>
<span id="cb34-44">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>, adjustable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'box'</span>)</span>
<span id="cb34-45">ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb34-46"></span>
<span id="cb34-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the plot</span></span>
<span id="cb34-48">plt.savefig(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>out_dir<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/python_qc_flaggedCells.png"</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>)</span>
<span id="cb34-49">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_qc_flaggedCells.png" class="img-fluid figure-img" width="406"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="neighborhood-visualizations" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="neighborhood-visualizations"><span class="header-section-number">5</span> Neighborhood Visualizations</h2>
<p>We cover more extensive cell neighborhood analysis in a <a href="../../posts/cellular-neighborhoods/cellular-neighborhoods.html">dedicated post</a>, but include some summary visualizations here.</p>
<section id="distance-to-nearest-cell-of-type-a" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="distance-to-nearest-cell-of-type-a"><span class="header-section-number">5.1</span> Distance to Nearest Cell of Type A</h3>
<p>We find that often we’re interested in examining how close a given cell is to a cell of a certain type, for example how close every cell is to the nearest macrophage. Here we make a spatial plot to show the distance to the nearest macrophage. Based on the marker genes and spatial distribution here we’ll designate unsupervised cell type 3 as macrophage.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-22-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-22-1" aria-controls="tabset-22-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-22-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-22-2" aria-controls="tabset-22-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-22-1" class="tab-pane active" aria-labelledby="tabset-22-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Separate macrophages and other cells</span></span>
<span id="cb35-2">macrophages <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_meta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(leiden_cluster <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(CenterX_global_px, CenterY_global_px)</span>
<span id="cb35-3">all_cells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_meta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(CenterX_global_px, CenterY_global_px)</span>
<span id="cb35-4"></span>
<span id="cb35-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find nearest macrophage for each cell</span></span>
<span id="cb35-6">nn <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> FNN<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get.knnx</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> macrophages, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">query =</span> all_cells, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb35-7"></span>
<span id="cb35-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract distances</span></span>
<span id="cb35-9">distances <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nn<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.dist[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb35-10"></span>
<span id="cb35-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add to original data</span></span>
<span id="cb35-12">cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nearest_macrophage_distance <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> distances</span>
<span id="cb35-13"></span>
<span id="cb35-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to distance in microns</span></span>
<span id="cb35-15">microns_per_pixel <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.12028</span></span>
<span id="cb35-16">cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nearest_macrophage_distance_um <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nearest_macrophage_distance <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> microns_per_pixel</span>
<span id="cb35-17"></span>
<span id="cb35-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># There are a few outliers in distance, so we cap the distance plotted</span></span>
<span id="cb35-19"></span>
<span id="cb35-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the 90th percentile cap</span></span>
<span id="cb35-21">cap_value <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nearest_macrophage_distance_um, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb35-22"></span>
<span id="cb35-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cap the values</span></span>
<span id="cb35-24">cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>distance_capped <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nearest_macrophage_distance_um, cap_value)</span>
<span id="cb35-25"></span>
<span id="cb35-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define breaks and labels</span></span>
<span id="cb35-27">breaks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pretty</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, cap_value), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb35-28">breaks[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(breaks)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cap_value</span>
<span id="cb35-29">labels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(breaks)</span>
<span id="cb35-30">labels[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(labels)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt; "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(cap_value))</span>
<span id="cb35-31"></span>
<span id="cb35-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Set up scale bar</span></span>
<span id="cb35-33">scale_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scale_bar_r</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_vals =</span> cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>CenterX_global_px,</span>
<span id="cb35-34">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_vals =</span>  cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>CenterY_global_px)</span>
<span id="cb35-35"></span>
<span id="cb35-36"></span>
<span id="cb35-37"></span>
<span id="cb35-38"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot it</span></span>
<span id="cb35-39"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(cell_meta,</span>
<span id="cb35-40">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> CenterX_global_px, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> CenterY_global_px,</span>
<span id="cb35-41">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> distance_capped)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distance to</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nearest mac.</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">(µm)"</span>,</span>
<span id="cb35-44">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> breaks,</span>
<span id="cb35-45">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> labels) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb35-46">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_void</span>()  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-48">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-49">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rect <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-50">  scale_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>label</span>
<span id="cb35-51"></span>
<span id="cb35-52"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nearest_cell.png"</span>),</span>
<span id="cb35-53">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/nearest_cell.png" class="img-fluid figure-img" style="width:30.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-22-2" class="tab-pane" aria-labelledby="tabset-22-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Separate macrophages and all cells</span></span>
<span id="cb36-2">macrophages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>][[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterX_global_px'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterY_global_px'</span>]]</span>
<span id="cb36-3">all_cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterX_global_px'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterY_global_px'</span>]]</span>
<span id="cb36-4"></span>
<span id="cb36-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find nearest macrophage for each cell</span></span>
<span id="cb36-6">nn_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> NearestNeighbors(n_neighbors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb36-7">nn_model.fit(macrophages)</span>
<span id="cb36-8">distances, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn_model.kneighbors(all_cells)</span>
<span id="cb36-9"></span>
<span id="cb36-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add distances to the original DataFrame</span></span>
<span id="cb36-11">cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nearest_macrophage_distance'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> distances[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb36-12"></span>
<span id="cb36-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to microns</span></span>
<span id="cb36-14">microns_per_pixel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.12028</span></span>
<span id="cb36-15">cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nearest_macrophage_distance_um'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nearest_macrophage_distance'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> microns_per_pixel</span>
<span id="cb36-16"></span>
<span id="cb36-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cap the 'nearest_macrophage_distance' at the 90th percentile</span></span>
<span id="cb36-18">cap_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nearest_macrophage_distance_um'</span>].quantile(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)</span>
<span id="cb36-19">cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance_capped'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.minimum(cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'nearest_macrophage_distance_um'</span>], cap_value)</span>
<span id="cb36-20"></span>
<span id="cb36-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define breaks and labels similar to R's pretty function</span></span>
<span id="cb36-22">breaks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, cap_value, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb36-23">labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(b)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> b <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> breaks]</span>
<span id="cb36-24">labels[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"&gt; </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(cap_value)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb36-25"></span>
<span id="cb36-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Plot</span></span>
<span id="cb36-27">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb36-28">scatter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.scatter(</span>
<span id="cb36-29">    cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterX_global_px'</span>],</span>
<span id="cb36-30">    cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterY_global_px'</span>],</span>
<span id="cb36-31">    c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'distance_capped'</span>],</span>
<span id="cb36-32">    cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>,</span>
<span id="cb36-33">    s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb36-34">    alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb36-35">    zorder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb36-36">)</span>
<span id="cb36-37">cbar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fig.colorbar(scatter, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Distance to</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">nearest mac.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">(µm)'</span>)</span>
<span id="cb36-38">cbar.set_ticks(breaks)</span>
<span id="cb36-39">cbar.set_ticklabels(labels)</span>
<span id="cb36-40">cbar.solids.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb36-41">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>, adjustable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'box'</span>)</span>
<span id="cb36-42">ax.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb36-43"></span>
<span id="cb36-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add scale bar</span></span>
<span id="cb36-45">make_scale_bar_py(ax, cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CenterX_global_px"</span>], cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CenterY_global_px"</span>])</span>
<span id="cb36-46"></span>
<span id="cb36-47">plt.savefig(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>out_dir<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/python_nearest_cell.png"</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>)</span>
<span id="cb36-48">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_nearest_cell.png" class="img-fluid figure-img" style="width:30.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="cell-type-composition-by-annotation" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="cell-type-composition-by-annotation"><span class="header-section-number">5.2</span> Cell type composition by annotation</h3>
<p>We often want to show the cell type composition within a specific region or across patients. We don’t have multiple patients or slides in this dataset, so instead here we show the cell type composition by groups of FOVs, after splitting the sample into an upper and lower lobe. A more common use might be to show cell type composition by niche, but we have not calculated niches on this dataset.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-23-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-23-1" aria-controls="tabset-23-1" aria-selected="true">R</a></li><li class="nav-item"><a class="nav-link" id="tabset-23-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-23-2" aria-controls="tabset-23-2" aria-selected="false">Python</a></li></ul>
<div class="tab-content">
<div id="tabset-23-1" class="tab-pane active" aria-labelledby="tabset-23-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add a basic lobe designation for demonstration purposes</span></span>
<span id="cb37-2">cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lobe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>CenterY_global_px <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50000</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"upper"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lower"</span>)</span>
<span id="cb37-3"></span>
<span id="cb37-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add FOV group for demonstration similar to niche</span></span>
<span id="cb37-5">cell_meta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cell_meta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fov_group =</span> letters[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ceiling</span>(fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)])</span>
<span id="cb37-7"></span>
<span id="cb37-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use polychrome palette</span></span>
<span id="cb37-9">my_pal <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pals<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">polychrome</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>leiden_cluster)))</span>
<span id="cb37-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(my_pal) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(cell_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>leiden_cluster)</span>
<span id="cb37-11"></span>
<span id="cb37-12"></span>
<span id="cb37-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot cell composition by niche, split by lobe</span></span>
<span id="cb37-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(cell_meta,</span>
<span id="cb37-15">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> fov_group, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(leiden_cluster))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fill"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> my_pal, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb37-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>lobe, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ylab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fraction of cells"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xlab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FOV group (niche)"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>()</span>
<span id="cb37-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(out_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/barPlot_cellTypes_annotations.png"</span>),</span>
<span id="cb37-23">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"in"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/barPlot_cellTypes_annotations.png" class="img-fluid figure-img" width="1200"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-23-2" class="tab-pane" aria-labelledby="tabset-23-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add a basic lobe designation for demonstration purposes</span></span>
<span id="cb38-2">cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lobe'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CenterY_global_px'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> y: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50000</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lower'</span>)</span>
<span id="cb38-3"></span>
<span id="cb38-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add FOV group for demonstration similar to niche</span></span>
<span id="cb38-5">cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fov_group'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fov'</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: string.ascii_lowercase[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(np.ceil(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb38-6"></span>
<span id="cb38-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get unique cell types and assign colors</span></span>
<span id="cb38-8">unique_cell_types <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>].unique()</span>
<span id="cb38-9">colors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.cm.get_cmap(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tab20'</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(unique_cell_types))</span>
<span id="cb38-10">color_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {cell_type: colors(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, cell_type <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(unique_cell_types)}</span>
<span id="cb38-11"></span>
<span id="cb38-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare data</span></span>
<span id="cb38-13">grouped <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell_meta.groupby([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lobe'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fov_group'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>]).size().reset_index(name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>)</span>
<span id="cb38-14">grouped[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fraction'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped.groupby([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lobe'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fov_group'</span>])[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>].transform(<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> x.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>())</span>
<span id="cb38-15"></span>
<span id="cb38-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot</span></span>
<span id="cb38-17">lobes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lobe'</span>].unique()</span>
<span id="cb38-18">niches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fov_group'</span>].unique()</span>
<span id="cb38-19">cell_types <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>].unique()</span>
<span id="cb38-20"></span>
<span id="cb38-21">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(lobes), figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(lobes), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>), sharey<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb38-22"></span>
<span id="cb38-23"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(lobes) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb38-24">    axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [axes]</span>
<span id="cb38-25"></span>
<span id="cb38-26"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ax, lobe <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(axes, lobes):</span>
<span id="cb38-27">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped[grouped[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lobe'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> lobe]</span>
<span id="cb38-28">    lobe_niches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fov_group'</span>].unique())</span>
<span id="cb38-29">    bottom <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Series(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lobe_niches, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'float64'</span>)</span>
<span id="cb38-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ct <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> cell_types:</span>
<span id="cb38-31">        values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'leiden_cluster'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> ct].set_index(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fov_group'</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fraction'</span>].reindex(lobe_niches, fill_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb38-32">        ax.bar(lobe_niches, values.values, bottom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bottom[lobe_niches].values, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ct, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color_dict.get(ct, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#333333'</span>))</span>
<span id="cb38-33">        bottom[lobe_niches] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> values</span>
<span id="cb38-34">    ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Lobe: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lobe<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb38-35">    ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FOV group (niche)"</span>)</span>
<span id="cb38-36">    ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fraction of cells"</span>)</span>
<span id="cb38-37"></span>
<span id="cb38-38">handles, labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].get_legend_handles_labels()</span>
<span id="cb38-39">labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(label))) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> label.replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).isdigit() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> label <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> label <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> labels]</span>
<span id="cb38-40">fig.legend(handles, labels, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cell type"</span>, bbox_to_anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.02</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>), loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'center left'</span>)</span>
<span id="cb38-41"></span>
<span id="cb38-42">plt.tight_layout()</span>
<span id="cb38-43">plt.savefig(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>out_dir<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/python_barPlot_cellTypes_annotations.png"</span>, bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb38-44">plt.close()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_barPlot_cellTypes_annotations.png" class="img-fluid figure-img" width="1962"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="summary"><span class="header-section-number">6</span> Summary</h2>
<p>This post introduced a suite of visualization techniques for CosMx spatial transcriptomics data starting from flat file inputs. Whether you’re assessing data quality, visualizing spatial structure, or exploring cell interactions, these plots can provide a powerful first look.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-Hao2024" class="csl-entry">
Hao, Yuhan, Tim Stuart, Madeline H. Kowalski, Saket Choudhary, Paul Hoffman, Austin Hartman, Avi Srivastava, et al. 2024. <span>“Dictionary Learning for Integrative, Multimodal and Scalable Single-Cell Analysis.”</span> <em>Nature Biotechnology</em> 42 (February): 293–304. <a href="https://doi.org/10.1038/s41587-023-01767-y">https://doi.org/10.1038/s41587-023-01767-y</a>.
</div>
<div id="ref-Palla2022" class="csl-entry">
Palla, Giovanni, Hannah Spitzer, Michal Klein, David Fischer, Anna Christina Schaar, Louis Benedikt Kuemmerle, Sergei Rybakov, et al. 2022. <span>“Squidpy: A Scalable Framework for Spatial Omics Analysis.”</span> <em>Nature Methods</em> 19 (February): 171–78. <a href="https://doi.org/10.1038/s41592-021-01358-2">https://doi.org/10.1038/s41592-021-01358-2</a>.
</div>
</div></section></div> ]]></description>
  <category>visualization</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/</guid>
  <pubDate>Wed, 20 Aug 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/spatial-plotting/figures/python_celltype_polygons_singleFOV.png" medium="image" type="image/png" height="110" width="144"/>
</item>
<item>
  <title>Aligning H&amp;E and CosMx Images in napari</title>
  <dc:creator>Yi Cui</dc:creator>
  <dc:creator>Lidan Wu</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Aligning Hematoxylin and Eosin (H&amp;E) histology with CosMx<sup>®</sup> Spatial Molecular Imager (SMI) data is more than a cosmetic step: it’s turning two complementary modalities into a single, interpretable picture. H&amp;E provides the spatial scaffold which includes tissue boundaries, cell shapes, and histopathology cues, while CosMx adds the multiplexed molecular profile for each cell. When accurately aligned, these layers reinforce each other: structure informs expression, and expression validates structure. However, it’s a common challenge to align these two kinds of images as they often differ in scale, orientation, or position due to variations in acquisition methods.</p>
<p>In this tutorial, we’ll walk through how to effectively align H&amp;E and CosMx images in <a href="https://napari.org/stable/" target="_blank"><code>napari</code></a> with a two-part workflow:</p>
<ol type="1">
<li>first do a quick landmark-based alignment with <a href="https://github.com/jni/affinder/tree/main" target="_blank"><code>affinder</code></a> plugin,</li>
<li>then fine tune with custom transformation widgets <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/napari-alignment-tools" target="_blank"><code>napari_alignment_tools</code></a> for controlled micro-nudges.</li>
</ol>
<p>By the end, you’ll be able to:</p>
<ul>
<li>Load stitched CosMx data and matching H&amp;E images in napari.</li>
<li>Perform coarse alignment with <code>affinder</code> (affine/similarity/euclidean models).</li>
<li>Fine-tune transforms with intuitive widgets <code>napari_alignment_tools</code> for pixel-level adjustments.</li>
<li>Verify results visually and save an aligned H&amp;E ready for analysis.</li>
</ul>
<p>Like other items in our <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/about.html" target="_blank">CosMx Analysis Scratch Space</a>, the usual <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/about.html" target="_blank">caveats</a> and <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/license.html" target="_blank">license</a> applies.</p>
</section>
<section id="environment-installation" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Environment &amp; Installation</h1>
<section id="set-up-general-environment" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="set-up-general-environment"><span class="header-section-number">2.1</span> Set up general environment</h2>
<p>It’s recommended to create a dedicated environment for <code>napari</code> applications. If you already have an environment with <code>napari</code> and <code>napari-cosmx</code> plugin installed, you could just activate that environment directly and proceed to Section&nbsp;2.2.</p>
<p>Below is the example command line to create virtual environment <code>napariEnv</code>.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>setup napari environment</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create environment</span></span>
<span id="cb1-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv /path/to/my/napariEnv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># activate environment</span></span>
<span id="cb1-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> /path/to/my/napariEnv/bin/activate   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Windows: /path/to/my/napariEnv/Scripts/activate</span></span>
<span id="cb1-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--upgrade</span> pip</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install napari viewer</span></span>
<span id="cb1-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"napari[all]"</span></span></code></pre></div>
</div>
</div>
<p>Following the instructions in earlier <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-cosmx-intro/#part-2-installing-napari-cosmx" target="_blank">post</a>, one should next install the <code>napari-cosmx</code> plugin from the latest <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/assets/napari-cosmx%20releases" target="_blank">wheel file</a> for interacting with CosMx data.</p>
<p>With <code>napari-cosmx</code> plugin installed, one could start to prepare CosMx napari dataset and overlaying single-cell and transcriptional analysis results on top of morphological images. Please refer to earlier <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/#category=napari" target="_blank"><code>napari</code> post series</a> for more details.</p>
</section>
<section id="sec-plugins" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="sec-plugins"><span class="header-section-number">2.2</span> Install alignment-required plugins</h2>
<p>Two plugins are required for this tutorial:</p>
<ul>
<li><a href="https://github.com/jni/affinder/tree/main" target="_blank"><code>affinder</code></a> and</li>
<li>custom transformation widgets <code>napari_alignment_tools</code>, whose wheel file <code>.whl</code> needs to be downloaded from <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/napari-alignment-tools" target="_blank">here</a>.</li>
</ul>
<p>You can either install them via command line or in <code>napari</code> GUI.</p>
<p><strong>Option 1</strong>: install via command line.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>install alignment plugins</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install affinder</span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install /path/to/wheel/file/napari_alignment_tools-<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>-py3-none-any.whl</span></code></pre></div>
</div>
</div>
<p><strong>Option 2</strong>: install via <code>napari</code> GUI.</p>
<p>First launch <code>napari</code> GUI by typing <code>napari</code> in command line, and then go to <code>Plugins</code> menu and follow the steps below.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true"><code>affinder</code></a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false">custom <code>napari-alignment-tools</code></a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/Fig2p1-plugin-install01.png" class="img-fluid figure-img" width="1262"></p>
<figcaption>(A) Launch plugin manager; (B) Locate <code>affinder</code> in search box and install (red arrows). (C) The installed plugin would show up under <code>Plugins</code> menu when launching napari next time.</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/Fig2p1-plugin-install02.png" class="img-fluid figure-img" width="1316"></p>
<figcaption>For cutom plugin, (A) launch plugin manger under <code>Plugins</code> menu; (B) Drag the downloaded wheel file to the bottom field and click <code>install</code> (yellow arrows) and watch <code>Show Status</code> (C) for the installation progress.</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="data-prerequisites" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Data prerequisites</h1>
<ul>
<li><p><strong>CosMx (stitched) dataset</strong>: See the <code>napari</code> <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-stitching/napari-cosmx-stitching.html" target="_blank">stitching tutorial</a> on how to create it for your dataset. Example file path at <code>~/data/cosmx/Napari</code>.</p></li>
<li><p><strong>H&amp;E image</strong>: Example file path at <code>~/data/cosmx/WTx_Exp-25_Colon_HE.png</code>.</p>
<ul>
<li>Napari supports various other image formats, including <code>TIFF</code>and <code>Zarr</code>.</li>
<li>If your file format is not supported, you could convert it to the supported formats with other tools like <code>QuPath</code> (see <a href="https://qupath.readthedocs.io/en/stable/docs/advanced/exporting_images.html" target="_blank">here</a>).</li>
</ul></li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>For H&amp;E of large file size, prefer Zarr-backed images and avoid loading every layer at full resolution. Use the minimum layers you need for alignment.</p>
</div>
</div>
</section>
<section id="alignment-workflow" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Alignment workflow</h1>
<section id="load-data" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="load-data"><span class="header-section-number">4.1</span> Load data</h2>
<ol type="1">
<li>Start <code>napari</code>.</li>
<li>Load H&amp;E: Drag the H&amp;E file into <code>napari</code> GUI (it will be a 2D image layer), choose <code>napari builtins</code> reader if prompted.</li>
<li>Load CosMx dataset: Drag the pre-stitched cosmx data folder (which contents morphology image, cell segmentation, cell‑type metadata, etc.) into <code>napari</code> GUI, choose <code>napari CosMx</code> reader if prompted.</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/Fig3p1_load_HnE.png" class="img-fluid figure-img" width="328"></p>
<figcaption>Choose reader based on image/data type.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="coarse-alignment-with-affinder-landmarks" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="coarse-alignment-with-affinder-landmarks"><span class="header-section-number">4.2</span> Coarse alignment with <code>affinder</code> (landmarks)</h2>
<p>Goal: Compute a transform that maps the <strong>Moving</strong> H&amp;E layer onto the <strong>Reference</strong> CosMx layer by clicking corresponding landmarks.</p>
<ol type="1">
<li><p>Open <code>affinder</code>: <strong>Plugins → affinder → Start affinder</strong>. A right‑dock widget appears with drop-downs listing your layers.</p>
<ul>
<li><p>You can further click on the <code>Select file</code> field next to <code>Save transformation as</code> line of the widget to export the transformation matrix for future usage.</p></li>
<li><p>The widget allows 3 different transform models:</p>
<ul>
<li><strong>affine</strong> <em>(default)</em>: translation, rotation, scale, shear, reflection (most flexible).</li>
<li><strong>similarity</strong>: translation, rotation, uniform scale (shape‑preserving).</li>
<li><strong>euclidean</strong>: translation + rotation only (most rigid).</li>
</ul></li>
</ul></li>
<li><p>Select layers:</p>
<ul>
<li><strong>Reference Layer</strong> = your CosMx image (e.g., morphology or <code>cell_type</code> metadata image that has clear features).</li>
<li><strong>Moving Layer</strong> = your H&amp;E image.</li>
</ul></li>
<li><p>Start point selection: Click <strong>Start</strong> in the <code>affinder</code> widget.</p>
<ul>
<li><code>affinder</code> adds two <code>Points</code> layers—one for the reference, one for the moving image.</li>
<li>The viewer would focuse you on the <strong>Reference</strong> layer first. Click at least <strong>three</strong> distinct, clearly identifiable landmarks (features visible in both images) in the <strong>Reference</strong> layer.</li>
<li>The viewer would then switch focus to the <strong>Moving</strong> (H&amp;E) layer. Click the <strong>corresponding</strong> points in the <strong>same order</strong>.</li>
</ul></li>
<li><p>Transform application: After the third pair is placed, <code>affinder</code> computes and applies the transform so the <strong>H&amp;E (Moving)</strong> aligns onto the <strong>CosMx (Reference)</strong>. Continue adding additional pairs (alternating layers) to refine the alignment iteratively. The more points you add, the more accurate the alignment.</p></li>
<li><p>Click <strong>Finish</strong> when the coarse alignment looks good. The transformation matrix used would be saved to the file defined in step (1).</p></li>
</ol>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Order matters! Always click correspondence points in the same order across <strong>Reference</strong> and <strong>Moving</strong> images.</p>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true">load data and launch <code>affinder</code></a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false">point selection</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" aria-controls="tabset-2-3" aria-selected="false">aligned image</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/Fig3p2_affinder01.png" class="img-fluid figure-img" width="1808"></p>
<figcaption>The <code>napari</code> viewer has both kinds of image data loaded before starting the <code>affinder</code>. CosMx data layer <code>cell_type</code> is choosen as <code>reference</code> layer, while H&amp;E image <code>WTx_Exp-25_Colon_HE</code> is chosen as <code>moving layer</code>.</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/Fig3p2_affinder02.png" class="img-fluid figure-img" width="1072"></p>
<figcaption>Pairs of points are selected in the 2 layers before applying the transformation.</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" aria-labelledby="tabset-2-3-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/Fig1-cosmx-he-align.png" class="img-fluid figure-img" width="297"></p>
<figcaption>Upon clicking <code>Finish</code>, the <strong>Moving</strong> layer (H&amp;E) is now displayed in a way aligned to the <strong>Reference</strong> layer (CosMx cell_type metadata) based on the anchor points selected.</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="finetuning-with-custom-transform-widgets" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="finetuning-with-custom-transform-widgets"><span class="header-section-number">4.3</span> Fine‑tuning with custom transform widgets</h2>
<p>Use the widgets from <code>napari_alignment_tools</code> to make controlled adjustments after <code>affinder</code>’s coarse alignment.</p>
<p>As shown in figure below, there are 2 ways to open the <code>napari_alignment_tools</code> widgets (B):</p>
<ul>
<li>Option 1 (A): Go to <code>napari</code> menu, <strong>Plugins → Alignment Tools → Alignment Tool</strong> and <strong>Fine Nudge</strong>.</li>
<li>Option 2 (C): Go to the the console <code>&gt;</code> at bottom left corner of the dataset-loaded <code>napari</code> viewer and run:</li>
</ul>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>add custom widgets in napari console</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">from</span> napari_alignment_tools.widgets import add_widgets_to_viewer</span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">add_widgets_to_viewer</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">viewer</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</div>
<p>This adds two dock widgets to the right dock: <strong>Alignment Tool</strong> (for coarse parameters) and <strong>Fine Nudge</strong> (for small increments). Both widgets allow you to put in defined numbers (instead of adding points) for transformation and thus allow the alignment occur in a more controlled way.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/Fig2p1-plugin-install03.png" class="img-fluid figure-img" width="1316"></p>
<figcaption>After loading a pre-stitched cosmx dataset in <code>napari</code>, one could add the custm widgets (B, to the right dock) either (A) via <strong>Plugins</strong> menu or by (C) running short python command in <code>napari</code> console.</figcaption>
</figure>
</div>
</div>
</div>
<section id="use-the-alignment-tool-top-panel" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="use-the-alignment-tool-top-panel"><span class="header-section-number">4.3.1</span> Use the Alignment Tool (top panel)</h3>
<ol type="1">
<li><p>Layer selection: In <em>Alignment Tool</em>, choose your <strong>H&amp;E</strong> image layer (the <strong>Moving</strong> layer you want to adjust).</p></li>
<li><p>Adjust as needed:</p>
<ul>
<li><strong>Rotation</strong> (−180 to 180°)</li>
<li><strong>Scale Verti/Horiz</strong> (0.0001 to 1000)</li>
<li><strong>Shift Verti/Horiz</strong> (−1000 to 1000 px)</li>
<li><strong>Flip Horiz/Verti</strong> (checkboxes)</li>
</ul></li>
<li><p>Apply: Click <strong>Apply Alignment</strong>. Inspect by toggling visibility and using opacity sliders.</p></li>
</ol>
</section>
<section id="use-the-fine-nudge-tool-micro-adjustments-bottom-panel" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="use-the-fine-nudge-tool-micro-adjustments-bottom-panel"><span class="header-section-number">4.3.2</span> Use the Fine Nudge Tool (micro adjustments, bottom panel)</h3>
<ol type="1">
<li>Layer selection: Choose the <strong>H&amp;E</strong> layer.</li>
<li>Direction &amp; step size:</li>
</ol>
<ul>
<li>Pick a direction—left (Y−), right (Y+), up (X−), down (X+), rotate counter‑clockwise (Rotate−), rotate clockwise (Rotate+).</li>
<li>Set the <strong>Step</strong> (e.g., 1 px for translation; 0.5–1° for rotation).</li>
</ul>
<ol start="3" type="1">
<li>Apply <strong>Nudge</strong>, repeat this until alignment is precise.</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/Fig4_custom.png" class="img-fluid figure-img" width="1466"></p>
<figcaption>(A) Custom widgets from <code>napari_alignment_tools</code>; (B) Overlay of cell_type metadata on top of H&amp;E image before vs.&nbsp;after fine-tuning; (C) Side-by-side view of the post-fine-tuned images.</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Use <strong>opacity</strong> on the H&amp;E layer to blend with the CosMx background.</li>
<li>Toggle layer visibility (<code>V</code>) to quickly inspect.</li>
<li>Link pan/zoom across layers by multi‑selecting layers and enabling <strong>Link Layers</strong> (chain icon) in the layer controls.</li>
</ul>
</div>
</div>
</section>
<section id="verify-save" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="verify-save"><span class="header-section-number">4.3.3</span> Verify &amp; save</h3>
<ol type="1">
<li><strong>Visual checks</strong>: Zoom into salient structures (tissue boundaries, lumen edges, sharp features) and ensure edges coincide across layers.</li>
<li><strong>Save</strong>: There are a few options to save the alignment results:</li>
</ol>
<ul>
<li>To save high-resolution aligned H&amp;E-CosMx images: In the napari menu, choose <strong>File -&gt; Save Screenshot</strong> or type the following command in the napari console: <code>viewer.screenshot("Aligned image [file name].png", scale = 7)</code>. Larger scale values help with generating higher resolution images.</li>
<li>To save applied alignment adjustments for reuse: right-click the H&amp;E image layer, select <strong>Copy scale and transforms -&gt; Copy all to clipboard</strong></li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/Fig_saveTransform.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Screenshot of the dropdown menu showing how to save image transformations.</figcaption>
</figure>
</div>
</div>
</div>
<p>Save the information from the clipboard, which is a Python dictionary. It will have a format similar to below:</p>
<p><code>{"affine": [[1.04153992599718, -0.006080890992258121, -6.3775880232906275], [0.004057876599801822, 1.0290241905428268, -26.61572787836182], [0.0, 0.0, 1.0]], "rotate": [[1.0, -0.0], [0.0, 1.0]], "scale": [0.0017, 0.0017], "shear": [0.0], "translate": [0.0, 0.0]}</code></p>
<p>Next time, after reloading the same H&amp;E image, copy the saved transformation dictionary values and right-click the image layer to select <strong>Apply scale/transforms from clipboard</strong>. The exact same adjustment will be re-applied.</p>
</section>
</section>
</section>
<section id="practical-tips" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Practical Tips</h1>
<ul>
<li>Either <code>affinder</code> or the custom transformation widgets can be <strong>used independently</strong> to achieve the same alignment outcome. The former uses point inputs, while the later uses the numeric inputs.</li>
<li><strong>Pre‑stitch CosMx FOVs</strong> before alignment so both widgets sees a continuous reference image (see <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-stitching/napari-cosmx-stitching.html" target="_blank">stitching tutorial</a>).</li>
<li><strong>Mind the scale.</strong> If CosMx and H&amp;E pixel sizes differ greatly, start with <code>Affine</code> model in <code>affinder</code>, then refine scale with the custom Alignment Tool.</li>
<li><strong>Avoid overfitting.</strong> Don’t spam too many landmarks at once; add a few, check, then add more if needed.</li>
<li><strong>Work on downsampled data</strong> to prove the transform, then apply at full resolution if your workflow supports it.</li>
</ul>
</section>
<section id="gallery-of-he-aligned-cosmx-datasets" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Gallery of H&amp;E-aligned CosMx datasets</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" aria-controls="tabset-3-1" aria-selected="true">Colon</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" aria-controls="tabset-3-2" aria-selected="false">Pancreas</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" aria-controls="tabset-3-3" aria-selected="false">Brain</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/FIgure5p1_Colon_ADC.png" class="img-fluid figure-img" width="715"></p>
<figcaption>Human Colon Adenocarcinoma.</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/FIgure5p2_Pancreas.png" class="img-fluid figure-img" width="715"></p>
<figcaption>Human Pancreas.</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-3-3" class="tab-pane" aria-labelledby="tabset-3-3-tab">
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/FIgure5p3_Hippocampus.png" class="img-fluid figure-img" width="715"></p>
<figcaption>Human Hippocampus.</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="resources" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Resources</h1>
<ul>
<li><a href="https://github.com/jni/affinder/tree/main?tab=readme-ov-file#how-to-guide" target="_blank"><code>affinder</code> usage</a></li>
<li>The<code>.whl</code> file for custom widgets in <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/napari-alignment-tools" target="_blank"><code>napari_alignment_tools</code></a></li>
<li><code>napari‑cosmx</code>: <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-cosmx-intro/" target="_blank">Getting started</a></li>
<li><code>napari‑cosmx</code> <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-cosmx-basics/using-napari-cosmx.html" target="_blank">essentials</a></li>
<li>CosMx napari <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-stitching/napari-cosmx-stitching.html" target="_blank">stitching tutorial</a></li>
</ul>


</section>

 ]]></description>
  <category>napari</category>
  <category>visualization</category>
  <category>python</category>
  <category>how-tos</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/</guid>
  <pubDate>Mon, 11 Aug 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/napari-alignment-tools/figures/Fig1-cosmx-he-align.png" medium="image" type="image/png" height="145" width="144"/>
</item>
<item>
  <title>Analyzing genes’ subcellular localization</title>
  <dc:creator>Patrick Danaher</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/subcellular/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>RNA transcript locations are a standard output of CosMx experiments, but it’s uncommon for data analysis to make use of them. We speculate that the localization of transcripts within cells might reveal some undiscovered biological gems to those willing to go searching. Here we present a small demonstration of how this information might be explored. We use a cell pellet array constructed by printing 37 cell lines onto a single slide:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/subcellular/figures/CPA.png" class="img-fluid figure-img" width="376"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="setup" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Setup</h1>
<p>We ran the CosMx Human Whole Transcriptome Panel, and collected a single FOV from each cell line. This produced 18935-plex data with between 600-3400 cells per cell line. Typical for a cell line experiments, this study produced great data, with the average cell returning &gt;4000 counts.</p>
<p>Standard CosMx output includes each transcript’s cellular compartment: nucleus, cytoplasm, or membrane. For this simple demonstration, we focus on the nucleus and cytoplasm, where most transcripts are found. Our analysis was straightforward: for each cell line, we simply took the log2 ratio of each gene’s expression in the nucleus vs.&nbsp;in the cytoplasm. This allowed us to identify genes with bias towards either compartment, and to study how cell lines differ in regard to subcellular localization.</p>
</section>
<section id="results" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Results</h1>
<p>Nuclear and cytoplasmic expression tended to track each other for most genes, with a small subset of genes showing strong enrichment in the nucleus. For example, see the results from the 22RV1 cell line:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/subcellular/figures/nucleus vs. cyto one line.png" class="img-fluid figure-img" width="1000"></p>
</figure>
</div>
</div>
</div>
<p>To create a census of nucleus-enriched genes, we recorded all genes attaining 4-fold enrichment in the nucleus vs.&nbsp;the cytoplasm in at least one cell line:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/subcellular/figures/heatmap of top nuc-cyto ratios.png" class="img-fluid figure-img" width="1400"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we looked for genes whose nuclear/cytoplasmic ratio changed across cell lines. One top hit was RPLP2:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/subcellular/figures/single gene results.png" class="img-fluid figure-img" width="1600"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="discussion" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Discussion</h1>
<p>This post demonstrates the possibility of studying genes’ subcellular locations within and across cell types. Other, more complicated approaches are of course possible. RNA velocity can be estimated from the nuclear/cytoplasmic ratio, using subcellular location as a proxy for how recently an mRNA molecule was transcribed, e.g.&nbsp;with <a href="https://scvelo.readthedocs.io/en/stable/">scVelo</a>. It should also be possible to look for genes whose transcripts tend to cluster near each other in intracellular space, or for pairs of genes that cluster. Recent packages offer a few approaches on this theme, including <a href="http://github.com/bhavaygg/CellSP?tab=readme-ov-file#readme">CellSP</a>, <a href="https://genomebiology.biomedcentral.com/articles/10.1186/s13059-024-03217-7">BENTO</a>, <a href="https://pubmed.ncbi.nlm.nih.gov/39386706/">ELLA</a> and <a href="https://www.nature.com/articles/s41467-024-49457-w" target="&quot;_blank">INSTANT</a>.</p>
<p>Multiomics data will open new questions as well, for example allowing us to study whether any genes tend to fall atop the signal from any proteins. Or, even without multiomics data, we can use our morphology markers to ask questions of intracellular locations, for example, in the below image, what genes have been captured in the vesicles?</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/subcellular/figures/vesicles with transcripts.png" class="img-fluid figure-img" width="598"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>overview</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/subcellular/</guid>
  <pubDate>Mon, 11 Aug 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/subcellular/figures/CPA.png" medium="image" type="image/png" height="86" width="144"/>
</item>
<item>
  <title>Advancing cell segmentation in spatial omics: new models for diverse morphologies</title>
  <dc:creator>Lidan Wu</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Cell segmentation is a foundational step in spatial omics analysis. Inaccurate boundaries can lead to the misassignment of transcripts or proteins, ultimately distorting cellular profiles and downstream interpretations. To address this, we developed a robust image-based segmentation pipeline that leverages deep learning to generate accurate and biologically meaningful cell masks across a wide range of tissue types and imaging conditions.</p>
<p>In this post, we introduce our full segmentation pipeline and describe the three custom-trained models that power it. These models improve segmentation fidelity by tailoring input channels, training data composition, and post-processing workflows to specific biological challenges.</p>
<p>Like other items in our <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/about.html" target="_blank">CosMx Analysis Scratch Space</a>, the usual <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/about.html" target="_blank">caveats</a> and <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/license.html" target="_blank">license</a> applies.</p>
<p>You can cite this post as electronic materials in various formats shown below.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true">APA</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false">MLA</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" aria-controls="tabset-1-3" aria-selected="false">BibTeX</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" aria-controls="tabset-1-4" aria-selected="false">RIS</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" aria-controls="tabset-1-5" aria-selected="false">EndNote</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<p>Wu, L., Wardhani, A., &amp; Phan, J. (2025). Advancing cell segmentation in spatial omics: new models for diverse morphologies. Retrieved from https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/</p>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<p>Wu, Lidan, Aster Wardhani, and Joseph-Tin Phan. Advancing cell segmentation in spatial omics: new models for diverse morphologies. 16 Jul 2025, https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/</p>
</div>
<div id="tabset-1-3" class="tab-pane" aria-labelledby="tabset-1-3-tab">
<pre><code>@misc{Wu2025CosMxCellSeg
  title = {Advancing cell segmentation in spatial omics: new models for diverse morphologies},
  author = {Lidan Wu and Aster Wardhani and Joseph-Tin Phan},
  year = {2025},
  url = {https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/},
  note = {Accessed: 2026-02-12}
}</code></pre>
</div>
<div id="tabset-1-4" class="tab-pane" aria-labelledby="tabset-1-4-tab">
<pre><code>TY  - ELEC
TI  - Advancing cell segmentation in spatial omics: new models for diverse morphologies
AU  - Lidan Wu
AU  - Aster Wardhani
AU  - Joseph-Tin Phan
PY  - 2025
UR  - https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/
ER  -</code></pre>
</div>
<div id="tabset-1-5" class="tab-pane" aria-labelledby="tabset-1-5-tab">
<pre><code>%0 Electronic Article
%T Advancing cell segmentation in spatial omics: new models for diverse morphologies
%A Lidan Wu
%A Aster Wardhani
%A Joseph-Tin Phan
%D 2025
%U https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/</code></pre>
</div>
</div>
</div>
</section>
<section id="compartment-aware-segmentation-pipeline" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Compartment-Aware Segmentation Pipeline</h1>
<p>Our pipeline integrates two complementary segmentation models to produce both <strong>cell-level</strong> and <strong>subcellular</strong> compartment labels for each sample:</p>
<ol type="1">
<li>A <strong>nuclear segmentation model</strong> detects nuclei with high precision.</li>
<li>A <strong>whole-cell segmentation model</strong>, which is either a generic <strong>cyto model</strong> or a specific <strong>neural model</strong>, depending on tissue context, identifies the full cell boundaries including cytoplasmic regions.</li>
<li>These two masks are then <strong>reconciled and merged</strong> to assign:
<ul>
<li>A unique cell ID to each detected cell</li>
<li>Labels for subcellular compartments (nucleus vs.&nbsp;cytoplasm)</li>
</ul></li>
</ol>
<p>This two-model architecture ensures redundancy and resilience: when one compartment is weakly stained or difficult to model, the other can often compensate. The resulting merged masks are more complete and biologically accurate, especially for complex tissues such as brain.</p>
<div id="fig-seg-pipeline" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-seg-pipeline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/figures/Fig1-seg-pipeline.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-seg-pipeline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Schematic of full cell segmentation pipeline. Input morphology images feed into two parallel models: nuclear and whole-cell segmentation. Their outputs are merged into a final, compartment-labeled cell mask based on the overlapping behavior.
</figcaption>
</figure>
</div>
</section>
<section id="segmentation-models" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Segmentation Models</h1>
<p>All three models in our pipeline are based on the Cellpose-style architecture <span class="citation" data-cites="stringer2021cellpose">(Stringer et al. 2021)</span>, a widely adopted framework for generalist cell segmentation using spatial gradient flows and vector fields. Following the approach described in Cellpose 2.0 <span class="citation" data-cites="pachitariu2022cellpose">(Pachitariu and Stringer 2022)</span>, we trained separate models from scratch to specialize in nuclear, generic, and neural segmentation, respectively. The training datasets and input configurations were tailored to each segmentation task.</p>
<section id="nuclear-segmentation-model" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="nuclear-segmentation-model"><span class="header-section-number">3.1</span> Nuclear Segmentation Model</h2>
<p>Designed to work across many tissue types, this model takes a <strong>single-channel nuclear stain</strong> (e.g., DAPI, Histone stain) as input. It prioritizes accuracy in nucleus identification, even in densely packed or noisy imaging conditions. This model forms the backbone for subcellular compartment labeling.</p>
</section>
<section id="generic-segmentation-model" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="generic-segmentation-model"><span class="header-section-number">3.2</span> Generic Segmentation Model</h2>
<p>This model segments complete cell boundaries using <strong>two imaging channels</strong>: a required channel for general cytoplasmic or membrane staining, and an optional channel for nuclear staining. It is optimized for tissues with relatively uniform morphology and minimal extended protrusions, such as non-neural samples.</p>
</section>
<section id="neural-segmentation-model" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="neural-segmentation-model"><span class="header-section-number">3.3</span> Neural Segmentation Model</h2>
<p>To address the unique challenges of brain tissue, including highly irregular cell shapes, long processes, and closely apposed glial and neuronal cells, we developed a neural-specific model that uses <strong>three channels</strong>: nuclear, neuronal, and glial stains. This model more accurately segments astrocytes, neurons with elongated axons, and densely packed cerebellum regions.</p>
<div id="fig-3ch-model" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3ch-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/figures/Fig2-3ch-model.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3ch-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Neural cell segmentation model: input and output overview. Morphological stains from brain tissue—nuclear (green), neuronal (red), and glial (blue) markers—are combined into 3-channel inputs to the neural segmentation model (top panel). The Cellpose-style model processes these inputs to produce cell probability maps and spatial gradients (bottom panel), which are used to reconstruct accurate cell masks, even for complex neural morphologies.
</figcaption>
</figure>
</div>
</section>
</section>
<section id="diverse-and-context-relevant-training-datasets" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Diverse and Context-Relevant Training Datasets</h1>
<p>To ensure the segmentation models perform robustly on the types of tissues most relevant to spatial omics, we curated a large and diverse set of training data. A cornerstone of our approach was the generation of high-quality ground-truth annotations from CosMx<sup>®</sup> immunofluorescence images, covering a wide range of FFPE and fresh frozen tissue samples. These internal datasets include various tissue types and staining conditions, and are tailored to the real-world complexities encountered in spatial transcriptomic assays. They were essential in enabling the models to achieve high accuracy on primary tissue samples, which are the central use case for spatial omics.</p>
<p>To complement these internal datasets and further expand morphological and technical diversity, we incorporated a variety of publicly available datasets (Appendix) that span:</p>
<ul>
<li><p>Sample types: including 2D cell cultures, organoids, and whole-organism samples</p></li>
<li><p>Cell types and disease contexts: such as neurons, immune cells, and tumor cells</p></li>
<li><p>Imaging modalities: beyond immunofluorescence, including H&amp;E, brightfield, and differential interference contrast (DIC) imaging</p></li>
</ul>
<p>This hybrid training strategy, anchored in spatial omics–specific imaging and augmented by public data, ensures that the models generalize well across tissue types, imaging conditions, and biological contexts.</p>
<div id="fig-trainData" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-trainData-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/figures/Fig3-bsb-trainData.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-trainData-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Composition of training datasets used for model development. (A–C) Sunburst charts summarize the distribution of sample sources, image modalities, and staining types used to train the nuclear segmentation model (A), generic cytoplasm segmentation model (B), and neural segmentation model (C). Data were drawn from both internal CosMx assays and diverse public sources. (D) Representative immunofluorescence images from the neural training dataset highlight the complexity of brain tissue morphology, including neurons and glia labeled with various markers.
</figcaption>
</figure>
</div>
</section>
<section id="the-impact-of-training-dataset-composition-on-segmentation-performance" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> The Impact of Training Dataset Composition on Segmentation Performance</h1>
<p>Beyond architecture and stain configuration, the composition of training data had a profound effect on segmentation outcomes, particularly for complex tissues like brain. We explored this by training multiple versions of each model type (nuclear, generic whole-cell, and neural), using datasets that varied in their coverage of morphology, staining quality, and tissue types.</p>
<p>For each model type, we compared:</p>
<ul>
<li>A <strong>maximally large dataset</strong> (<code>Model #1</code>), including all available training images regardless of cell type balance.</li>
<li>One or more <strong>intermediate models</strong> (<code>Model #2</code>).</li>
<li>A <strong>balanced dataset model</strong> (<code>Model #3</code> for generic whole-cell and neural; <code>Model #2</code> for nuclei), where we carefully selected training samples to represent a diverse spectrum of cell morphologies and tissue structures.</li>
</ul>
<p>As shown in Figure&nbsp;4, masks predicted by the different models on neural tissue vary considerably in structure and completeness. Pre-trained models like <code>Cyto2</code> often undersegment neurons or fail to recover glial processes. In contrast, the morphology-balanced models produced more realistic masks, retaining fine structures and reducing erroneous fusions.</p>
<div id="fig-composition-impact" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-composition-impact-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/figures/Fig4-composition-impact.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-composition-impact-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Segmentation comparison on neural samples. Rows show: (1) input immunofluorescence images, (2) ground-truth labels, (3) Cyto2 predictions, and (4–6) outputs from custom-trained models. Morphology-balanced models (e.g., Model #3) better capture fine structures and generalize across diverse inputs.
</figcaption>
</figure>
</div>
<p>To quantify these differences, we measured sensitivity and precision across a range of IoU (Intersection over Union) thresholds for each model on held-out validation datasets, as shown in Figure&nbsp;5. The morphology-balanced models consistently outperformed others across all segmentation types: nuclei, generic cytoplasm, and neural.</p>
<ul>
<li>In nuclear segmentation (Panel A), <code>NucModel#2</code> (balanced) outperformed both the pretrained models (<code>nuclei</code>, <code>CP</code>, <code>Cyto2</code> and <code>Cyto3</code>) and <code>NucModel#1</code> (large, unbalanced set).</li>
<li>In generic cytoplasm segmentation (Panel B), <code>CytoModel#3</code> (balanced) showed the best trade-off between sensitivity and precision.</li>
<li>In neural segmentation (Panel C), <code>NeuModel#3</code> demonstrated the clearest performance gain, accurately detecting both large neuronal bodies and thin astrocytic projections (Figure&nbsp;4).</li>
</ul>
<p>These results highlight that <strong>more data is not always better</strong>—especially when morphological diversity is limited. Carefully curating a balanced training set allows models to generalize more robustly, particularly on tissue samples with heterogeneous or complex cellular structures.</p>
<div id="fig-performance-curves" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-performance-curves-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/figures/Fig5-performance-curves.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-performance-curves-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Quantitative performance of segmentation models across IoU thresholds. (A) Nuclear segmentation models. (B) Generic whole-cell segmentation models. (C) Neural segmentation models. Each curve shows sensitivity or precision on held-out test sets. Morphology-balanced models (Model #2 or #3) consistently outperform both pretrained baselines <span class="citation" data-cites="stringer2021cellpose pachitariu2022cellpose stringer2025cellpose">(Stringer et al. 2021; Pachitariu and Stringer 2022; Stringer and Pachitariu 2025)</span> and unbalanced large-set models.
</figcaption>
</figure>
</div>
</section>
<section id="post-processing-for-high-fidelity-cell-recovery" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Post-Processing for High-Fidelity Cell Recovery</h1>
<p>While Cellpose-style models output rich information, including cell probability maps and spatial gradient flows, these predictions must be converted into discrete cell masks for downstream use. The standard Cellpose post-processing pipeline performs this by applying a gradient tracking algorithm. This method first thresholds the cell probability map to define a foreground region. Then, it uses the magnitude and direction of the predicted flow vectors (horizontal and vertical) to trace each pixel along a path toward a “basin” point, interpreted as the cell’s centroid. Pixels with similar destinations are grouped into the same cell.</p>
<p>However, this method breaks down under biologically realistic conditions. Elongated cells (e.g., neurons with long processes) may have centroids that fall outside their actual boundaries, resulting in flow divergence near the edges and causing the mask to fragment. Similarly, large or highly textured cells can generate noisy or irregular flow fields, leading to mask splitting or partial segmentation. These errors persist even when adjusting thresholds on cell probability or flow magnitudes.</p>
<p>This challenge is clearly illustrated in Figure&nbsp;6 A, where raw model outputs for a neural tissue sample exhibit ambigous “basin” points. Attempts to tune cutoffs (Figure&nbsp;6 B) fail to reliably recover full cell structures, either missing elongated cells or oversegmenting compact ones.</p>
<div id="fig-gradient-tracking" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gradient-tracking-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/figures/Fig6-gradient-tracking.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gradient-tracking-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Challenges in mask generation from model outputs for irregular cell morphologies. (A) Model outputs for a neural segmentation example, including raw input, predicted cell probability, spatial gradient flow, and gradient magnitude. (B) Attempts to generate masks from these outputs using adjusted cutoffs for flows and/or cell probability show failure to capture large or atypical morphologies.
</figcaption>
</figure>
</div>
<p>To overcome these limitations, we developed a high-recovery post-processing pipeline (Figure&nbsp;7 A) that supplements the default gradient tracking with two additional strategies:</p>
<ol type="1">
<li>Initial mask generation preserves the default method’s confident segmentations (Component <strong>a</strong>).</li>
<li>Missed cells are recovered by applying auto-thresholding on the residual cell probability and gradient magnitude maps (Component <strong>b</strong>).</li>
<li>Remaining foreground pixels are assigned to nearby cells using distance-based reassignment or neighbor-consistent flow propagation, resulting in a complete, coherent mask set (Component <strong>c</strong>).</li>
</ol>
<p>This hybrid strategy improves mask continuity, structural integrity, and cell recovery, especially in densely packed or morphologically complex tissues like brain.</p>
<p>As shown in Figure&nbsp;7 B, the resulting masks successfully capture a diverse range of cell types, including large neurons, thin astrocytic processes, and small glia, while minimizing fragmentation and oversegmentation.</p>
<div id="fig-mask-recovery" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mask-recovery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/figures/Fig7-mask-recovery.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mask-recovery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Improved post-processing enables high-fidelity mask recovery. (A) Workflow for the high-recovery post-processing method. Default segmentation (a) is supplemented with threshold-based recovery (b) and foreground reassignment (c). (B) Visual comparison of default vs.&nbsp;new masks. Each row shows morphology image, predicted flows, and corresponding masks. The custom method (bottom row) improves segmentation completeness and accuracy across diverse cell shapes.
</figcaption>
</figure>
</div>
</section>
<section id="integration-into-the-cosmx-platform" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Integration into the CosMx Platform</h1>
<p>The newly developed segmentation models and high-recovery post-processing pipeline have been fully integrated into the CosMx<sup>®</sup> Spatial Molecular Imager platform to support robust and biologically meaningful cell segmentation across a wide range of samples.</p>
<p>These capabilities are now available through two complementary systems:</p>
<ul>
<li><strong>Control Center 2.0 or higher</strong>: Enables on-instrument execution of the new segmentation pipeline during CosMx image processing runs, ensuring consistency and improved performance at the point of acquisition.</li>
<li><strong>AtoMx<sup>®</sup> Spatial Informatics Portal (SIP) version 2.0 or higher</strong>: Supports cloud-based analysis workflows that utilize the new models and pipeline for segmentation across large cohorts and multiple users.</li>
</ul>
<p>For researchers who wish to customize segmentation to suit specific experimental contexts, AtoMx SIP provides a resegmentation toolkit via an interactive UI. This tool allows users to:</p>
<ul>
<li>Choose which trained model to apply for nuclear and whole-cell (Cyto) segmentation steps.</li>
<li>Specify which morphology channels are used as input for each model.</li>
<li>Re-segment images on demand with customized configurations for tissue type and staining patterns.</li>
</ul>
<p>More details can be found in the <a href="https://university.nanostring.com/cosmx-smi-data-analysis-user-manual" target="_blank">CosMx SMI Data Analysis User Manual (AtoMx v2.0)</a>, available through <a href="https://university.nanostring.com/" target="_blank">NanoU</a>.</p>
</section>
<section id="conclusion" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Conclusion</h1>
<p>Through this work, we’ve shown that better segmentation isn’t just about building a bigger model—it’s about using the right data, asking the right questions, and designing each step of the pipeline with the biology in mind. By training three specialized models for nuclear, generic whole-cell and neural segmentation, and building a smarter post-processing method to handle complex cell shapes, we’ve significantly improved how well we can detect and define cells in spatial omics data.</p>
<p>What we learned goes beyond just this application. A few key takeaways stood out:</p>
<ul>
<li>Balanced, diverse training data matters more than sheer volume, especially when working with real tissue.</li>
<li>Flow-based models need thoughtful post-processing, particularly when cells are irregular or overlapping.</li>
<li>A flexible, modular approach makes it easier to adapt segmentation tools across different tissue types and experiments.</li>
</ul>
<p>These lessons can apply to many other segmentation problems. And with these improvements now available in CosMx and AtoMx, we’re excited to see how researchers can push their spatial analysis even further.</p>
<hr>
</section>
<section id="appendix-public-datasets" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Appendix</h1>
<p>Public datasets associated with model training include:</p>
<ul>
<li>Deepflash2 neurons <span class="citation" data-cites="matthias_griebel_2023_7653312">(Griebel et al. 2023)</span></li>
<li>Neural nuclei segmentation (S-BSST265) <span class="citation" data-cites="SabineTaschner-Mandl2020">(Sabine Taschner-Mandl and Kromp 2020)</span></li>
<li>AMSActa Fluorescent Neuronal Cells <span class="citation" data-cites="amsacta7347">(Clissa et al. 2024)</span></li>
<li>BBBC collections: 007, 009, 030, 034, 038, 039 <span class="citation" data-cites="jones2005bbbc007 wiegandbbbc009 koos2016bbbc030 thirstrup2018bbbc034 caicedo2019bbbc038 caicedo2019bbbc039">(Jones, Carpenter, et al. 2005; Wiegand, Carpenter, et al. 2012; Koos et al. 2016; Thirstrup et al. 2018; Caicedo, Goodman, et al. 2019; Caicedo, Roth, et al. 2019)</span></li>
<li>Neuroblastoma images from the Cell Image Library <span class="citation" data-cites="yu2013ccdb6843">(Yu et al. 2013)</span></li>
</ul>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-caicedo2019bbbc038" class="csl-entry">
Caicedo, J. C., A. Goodman, K. W. Karhohs, et al. 2019. <span>“BBBC038v1: 2018 Data Science Bowl Nucleus Segmentation Dataset.”</span> <a href="https://bbbc.broadinstitute.org/BBBC038" class="uri">https://bbbc.broadinstitute.org/BBBC038</a>.
</div>
<div id="ref-caicedo2019bbbc039" class="csl-entry">
Caicedo, J. C., J. Roth, A. Goodman, T. Becker, K. W. Karhohs, M. Broisin, C. Molnar, et al. 2019. <span>“BBBC039v1: Fluorescence Nucleus Segmentation Dataset.”</span> <a href="https://bbbc.broadinstitute.org/BBBC039" class="uri">https://bbbc.broadinstitute.org/BBBC039</a>.
</div>
<div id="ref-amsacta7347" class="csl-entry">
Clissa, Luca, Alessandra Occhinegro, Emiliana Piscitiello, Ludovico Taddei, Antonio Macaluso, Roberto Morelli, Fabio Squarcio, et al. 2024. <span>“Fluorescent Neuronal Cells V2.”</span> University of Bologna. <a href="https://amsacta.unibo.it/id/eprint/7347/">https://amsacta.unibo.it/id/eprint/7347/</a>.
</div>
<div id="ref-matthias_griebel_2023_7653312" class="csl-entry">
Griebel, Matthias, Dennis Segebarth, Nikolai Stein, Nina Schukraft, Philip Tovote, Robert Blum, and Christoph M. Flath. 2023. <span>“Deep Learning-Enabled Segmentation of Ambiguous Bioimages with Deepflash2.”</span> Zenodo. <a href="https://doi.org/10.5281/zenodo.7653312">https://doi.org/10.5281/zenodo.7653312</a>.
</div>
<div id="ref-jones2005bbbc007" class="csl-entry">
Jones, T. R., A. E. Carpenter, et al. 2005. <span>“BBBC007v1: Drosophila Kc167 RNAi Screening Dataset.”</span> <a href="https://bbbc.broadinstitute.org/BBBC007" class="uri">https://bbbc.broadinstitute.org/BBBC007</a>.
</div>
<div id="ref-koos2016bbbc030" class="csl-entry">
Koos, K., J. Molnár, L. Kelemen, G. Tamás, and P. Horvath. 2016. <span>“BBBC030v1: DIC Image Reconstruction Dataset from the Broad Bioimage Benchmark Collection.”</span> <a href="https://bbbc.broadinstitute.org/BBBC030" class="uri">https://bbbc.broadinstitute.org/BBBC030</a>.
</div>
<div id="ref-pachitariu2022cellpose" class="csl-entry">
Pachitariu, Marius, and Carsen Stringer. 2022. <span>“Cellpose 2.0: How to Train Your Own Model.”</span> <em>Nature Methods</em> 19 (12): 1634–41. <a href="https://doi.org/10.1038/s41592-022-01663-4">https://doi.org/10.1038/s41592-022-01663-4</a>.
</div>
<div id="ref-SabineTaschner-Mandl2020" class="csl-entry">
Sabine Taschner-Mandl, Peter F. Ambros, Inge M. Ambros, and Florian Kromp. 2020. <span>“An Annotated Fluorescence Image Dataset for Training Nuclear Segmentation Methods.”</span> <a href="https://www.ebi.ac.uk/biostudies/bioimages/studies/S-BSST265">https://www.ebi.ac.uk/biostudies/bioimages/studies/S-BSST265</a>.
</div>
<div id="ref-stringer2025cellpose" class="csl-entry">
Stringer, Carsen, and Marius Pachitariu. 2025. <span>“Cellpose3: One-Click Image Restoration for Improved Cellular Segmentation.”</span> <em>Nature Methods</em> 22 (3): 592–99. <a href="https://doi.org/10.1038/s41592-025-02595-5">https://doi.org/10.1038/s41592-025-02595-5</a>.
</div>
<div id="ref-stringer2021cellpose" class="csl-entry">
Stringer, Carsen, Tim Wang, Michalis Michaelos, and Marius Pachitariu. 2021. <span>“Cellpose: A Generalist Algorithm for Cellular Segmentation.”</span> <em>Nature Methods</em> 18 (1): 100–106. <a href="https://doi.org/10.1038/s41592-020-01018-x">https://doi.org/10.1038/s41592-020-01018-x</a>.
</div>
<div id="ref-thirstrup2018bbbc034" class="csl-entry">
Thirstrup, D. et al. 2018. <span>“BBBC034v1: Allen Institute Cell Structure Dataset.”</span> <a href="https://bbbc.broadinstitute.org/BBBC034" class="uri">https://bbbc.broadinstitute.org/BBBC034</a>.
</div>
<div id="ref-wiegandbbbc009" class="csl-entry">
Wiegand, R., A. E. Carpenter, et al. 2012. <span>“BBBC009v1: Human Red Blood Cells DIC Dataset.”</span> <a href="https://bbbc.broadinstitute.org/BBBC009" class="uri">https://bbbc.broadinstitute.org/BBBC009</a>.
</div>
<div id="ref-yu2013ccdb6843" class="csl-entry">
Yu, W., H. K. Lee, S. Hariharan, W. Y. Bu, and S. Ahmed. 2013. <span>“CCDB:6843 - Mus Musculus Neuroblastoma Dataset.”</span> <a href="https://www.cellimagelibrary.org/images/CCDB_6843" class="uri">https://www.cellimagelibrary.org/images/CCDB_6843</a>.
</div>
</div></section></div> ]]></description>
  <category>segmentation</category>
  <category>algorithms</category>
  <category>CosMx 2.0</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/</guid>
  <pubDate>Wed, 16 Jul 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/image-segmentation-models/figures/Fig1-seg-pipeline.png" medium="image" type="image/png" height="67" width="144"/>
</item>
<item>
  <title>A practical guide to transcript-based cell segmentation in spatial transcriptomics</title>
  <dc:creator>Lidan Wu</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/transcript-segmentation/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Spatial transcriptomics technologies provide high-resolution spatial maps of transcript locations within tissue. A central challenge in these datasets is cell segmentation, which assigns transcripts to individual cells accurately, particularly when image data is noisy, missing, or ambiguous.</p>
<p>To address this, researchers have developed <strong>transcript-based analysis techniques</strong> that either:</p>
<ol type="1">
<li>Section&nbsp;2.1 Segment cells from transcript locations (e.g., Baysor, ProSeg),</li>
<li>Section&nbsp;2.2 Refine existing image-based segmentations using transcript patterns (e.g., FastReseg),</li>
<li>Section&nbsp;2.3 Avoid segmentation entirely by analyzing the spatial organization of transcripts directly (e.g., FICTURE).</li>
</ol>
<p>This post provides a practical walk-through of each technique with examples on using it with CosMx<sup>®</sup> data, whose standard data format are described <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/assets/Pancreas-CosMx-ReadMe.html" target="_blank">here</a>.</p>
<div id="fig-transcript-seg-methods" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-transcript-seg-methods-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/transcript-segmentation/figures/Fig1-transcript-segmentation.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-transcript-seg-methods-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Schematic of transcript-informed approaches
</figcaption>
</figure>
</div>
<p>Like other items in our <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/about.html" target="_blank">CosMx Analysis Scratch Space</a>, the usual <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/about.html" target="_blank">caveats</a> and <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/license.html" target="_blank">license</a> applies.</p>
</section>
<section id="choosing-the-right-transcript-based-approach" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Choosing the Right Transcript-Based Approach</h1>
<p>Spatial transcriptomics platforms differ in resolution, density, and image quality, and so do the challenges in analyzing them. Before diving into individual tools, it’s helpful to understand the three major transcript-informed approaches to working with spatial data: segmentation, refinement, and segmentation-free analysis. Each method type fits different scenarios and solves a unique class of problems.</p>
<section id="sec-txSeg" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="sec-txSeg"><span class="header-section-number">2.1</span> Transcript-Based Segmentation</h2>
<p>These methods directly infer cell boundaries by clustering or modeling the spatial distribution of transcripts, often using gene identity as additional signal.</p>
<p><strong>Use when:</strong></p>
<ul>
<li>You <strong>don’t have reliable cell images</strong> (e.g., missing or low-quality DAPI/membrane stains)</li>
<li>You want to define cells purely from <strong>mRNA localization</strong></li>
<li>You need a <strong>de novo</strong> segmentation pipeline without preprocessing</li>
</ul>
<p><strong>Limitations:</strong></p>
<ul>
<li>May oversegment sparse cells or misplace boundaries without priors</li>
<li>Transcript noise can bias clustering in low-resolution assays and introduce circularity in analysis pipeline</li>
</ul>
<p><strong>Best for:</strong> Datasets where transcript positions are abundant and dense.</p>
</section>
<section id="sec-txRefine" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="sec-txRefine"><span class="header-section-number">2.2</span> Segmentation Refinement</h2>
<p>These tools enhance an existing segmentation mask, correcting common segmentation errors using transcript-level context only when there is sufficient evidence.</p>
<p><strong>Use when:</strong></p>
<ul>
<li>You <strong>already ran an image-based segmentation</strong> (e.g., Cellpose, watershed)</li>
<li>You notice cells with <strong>minor contamination from neighboring cells</strong></li>
<li>You want to <strong>keep image-based alignment but improve transcript association</strong></li>
</ul>
<p><strong>Limitations:</strong></p>
<ul>
<li>Relies on the quality of the initial mask — can’t fix everything</li>
<li>Adds an extra pipeline step, but is lightweight</li>
</ul>
<p><strong>Best for:</strong> Any pipeline combining tissue images with transcript-based validation, especially if accurate cell boundaries affect downstream quantification.</p>
</section>
<section id="sec-segFree" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="sec-segFree"><span class="header-section-number">2.3</span> Segmentation-Free Analysis</h2>
<p>Instead of forcing transcripts into discrete cells, these approaches model <strong>gene expression directly in space</strong>, uncovering continuous spatial features, patterns, and regions.</p>
<p><strong>Use when:</strong></p>
<ul>
<li>You want to <strong>avoid cell segmentation biases</strong></li>
<li>Your tissue has ambiguous or <strong>poorly defined boundaries</strong></li>
<li>You aim to study <strong>gradients, niches, or expression domains</strong> more than individual cells</li>
</ul>
<p><strong>Limitations:</strong></p>
<ul>
<li>No per-cell outputs (e.g., no cell-by-gene matrices)</li>
<li>Some tools are exploratory and require interpretation beyond standard stats</li>
</ul>
<p><strong>Best for:</strong> Ultra-dense data like Seq-Scope or CosMx where transcript resolution enables high-fidelity spatial patterning without segmentation artifacts.</p>
</section>
</section>
<section id="running-transcript-informed-approaches-with-cosmx-data" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Running transcript-informed approaches with CosMx data</h1>
<p>With this foundation in place, let’s now walk through tools that exemplify each approach. The input files used are exported by AtoMx<sup>®</sup> Spatial Informatics Portal (SIP) and their file structures are described in this <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/assets/Pancreas-CosMx-ReadMe.html" target="_blank">ReadMe</a>.</p>
<div id="tbl-txSeg-types" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-txSeg-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Categories of Transcript-Based Methods
</figcaption>
<div aria-describedby="tbl-txSeg-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 32%">
<col style="width: 49%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th>Type</th>
<th>Goal</th>
<th>Example Tools</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Segmentation</td>
<td>Create cell boundaries from transcripts</td>
<td>Baysor, ProSeg</td>
</tr>
<tr class="even">
<td>Segmentation Refinement</td>
<td>Improve pre-existing cell boundaries</td>
<td>FastReseg</td>
</tr>
<tr class="odd">
<td>Segmentation-Free Analysis</td>
<td>Analyze transcript patterns directly</td>
<td>FICTURE</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<section id="baysor-probabilistic-transcript-based-segmentation" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="baysor-probabilistic-transcript-based-segmentation"><span class="header-section-number">3.1</span> Baysor: Probabilistic Transcript-Based Segmentation</h2>
<p><a href="https://github.com/kharchenkolab/Baysor" target="_blank">Baysor</a> <span class="citation" data-cites="petukhov2021cell">(Petukhov et al. 2021)</span> segments cells by modeling transcript positions and gene identities using a Bayesian mixture model. It optionally incorporates nuclei positions for prior constraints.</p>
<p><strong>Pros</strong></p>
<ul>
<li>Fully probabilistic</li>
<li>Handles overlapping cells and ambiguous boundaries</li>
<li>Optional priors improve accuracy</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>Slower and very high memory consumption on large datasets</li>
<li>Requires Julia and formatting input data</li>
<li>Sensitive to input parameters, tend to over-segmenting and bias towards smaller cells.</li>
</ul>
<section id="sec-baysor-install" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="sec-baysor-install"><span class="header-section-number">3.1.1</span> Install Baysor</h3>
<p>The simplest way to install <code>Baysor</code> on Linux is by downloading a precompiled binary from the repository’s <a href="https://github.com/kharchenkolab/Baysor/releases" target="_blank">release section</a>. Once downloaded, you can run the executable located at <code>bin/baysor</code>. Below is the example code on how to setup an AWS EC2 instance to run <code>baysor</code>. For other platforms, please refer to the full installation instruction provided by the original authors <a href="https://kharchenkolab.github.io/Baysor/dev/installation/" target="_blank">here</a>.</p>
<ol type="1">
<li>SSH log into your AWS EC2 instance as admin and navigate to a folder you can write on, e.g.&nbsp;<code>/home/YourUserName/data</code>.</li>
</ol>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>log into ec2 as admin</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># replace content inside &lt;&gt; with your actual setup</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ssh</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-i</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"your-key-to-ec2.pem"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>admin-name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>@<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>instance-ip-address<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> </span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># show container/docker info to get container ID</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> docker ps <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-a</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get into the container, replace "root" with your admin name </span></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> docker exec <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--user</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"root"</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-it</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>container-ID<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> /bin/bash</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># navigate to working directory</span></span>
<span id="cb1-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> /home/YourUserName/data</span></code></pre></div>
</div>
</div>
<ol start="2" type="1">
<li>Download and unzip the precompiled binary to target folder. For Baysor v0.7.1, there should be two executable <code>baysor</code> and <code>julia</code> inside the unzipped<code>./bin</code> folder.</li>
</ol>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>obtain Baysor binary</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> https://github.com/kharchenkolab/Baysor/releases/download/v0.7.1/baysor-x86_x64-linux-v0.7.1_build.zip</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unzip</span> baysor-x86_x64-linux-v0.7.1_build.zip</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ls</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-l</span> bin/julia</span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ls</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-l</span> bin/baysor</span></code></pre></div>
</div>
</div>
<ol start="3" type="1">
<li>Make the downloaded binary executable (<code>./bin</code> folder) for all users, <strong>set library path to empty</strong> (necessary to work with pre-compiled executable) and verify if <code>baysor/bin</code> is working.</li>
</ol>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>make Baysor executable</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> o+x /home/YourUserName/data/bin </span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> o+r /home/YourUserName/data/bin </span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ls</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-l</span> /home/YourUserName/data/bin/julia </span>
<span id="cb3-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ls</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-l</span> /home/YourUserName/data/bin/baysor</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LD_LIBRARY_PATH</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb3-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$LD_LIBRARY_PATH</span></span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">/home/YourUserName/data/bin/julia</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--help</span></span>
<span id="cb3-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">/home/YourUserName/data/bin/baysor</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--help</span></span></code></pre></div>
</div>
</div>
<ol start="4" type="1">
<li>Create symbolic links such that one could run with command line without the full path to the binary file.</li>
</ol>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>create symbolic link</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> ln <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> /home/YourUserName/data/bin/julia /usr/local/bin/julia</span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> ln <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> /home/YourUserName/data/bin/baysor /usr/local/bin/baysor</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">julia</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--help</span></span>
<span id="cb4-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">baysor</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--help</span></span></code></pre></div>
</div>
</div>
<p>Now you should be able to run <code>Baysor</code> from command line in your EC2 instance.</p>
</section>
<section id="run-baysor" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="run-baysor"><span class="header-section-number">3.1.2</span> Run Baysor</h3>
<p>As detailed in Baysor’s <a href="https://kharchenkolab.github.io/Baysor/dev/segmentation/" target="_blank">documentations</a>, <code>baysor</code> segmentation command requires data frame of transcripts’ coordinates and gene type as inputs. One can specify the data format as command arguments and configure the processing in the <code>.toml</code> file.</p>
<p><strong>Prepare Inputs</strong></p>
<p>The transcript file (e.g.&nbsp;<code>Pancreas_tx_file.csv</code>) exported by AtoMx<sup>®</sup> SIP has spatial coordinates under pixel unit in global coordinate system and is recommended to convert into micrometer unit before processing. Besides, AtoMx exported transcript file has study-unique cell ID under <code>cell</code> column which could be provided to <code>baysor</code> command as prior segmentation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prepare Tx file in R</span></span>
<span id="cb5-2">fullTx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data.table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pancreas_tx_file.csv"</span>)</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert to micrometer </span></span>
<span id="cb5-5">pixel_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.12028</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># micron per pixel </span></span>
<span id="cb5-6">z_step <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># micron per z step </span></span>
<span id="cb5-7"></span>
<span id="cb5-8">fullTx[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_allS_um'</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fullTx[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_global_px'</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pixel_size</span>
<span id="cb5-9">fullTx[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_allS_um'</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fullTx[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_global_px'</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pixel_size</span>
<span id="cb5-10">fullTx[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'z_allS_um'</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fullTx[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'z'</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z_step</span>
<span id="cb5-11"></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign unify "cell" ID to extracellular transcripts in tx file </span></span>
<span id="cb5-13">fullTx[cell_ID <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, cell <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0"</span>]</span>
<span id="cb5-14"></span>
<span id="cb5-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># export the modified transcript file to use with command line </span></span>
<span id="cb5-16">data.table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fwrite</span>(fullTx, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pancreas_prepared_tx_file.csv"</span>)</span></code></pre></div>
</div>
<p><strong>Run Command</strong></p>
<p>Below is an example command that performs Baysor segmentation on transcript file (e.g.&nbsp;<code>Pancreas_prepared_tx_file.csv</code>) and output results to folder <code>~/data/baysor_outputs</code>. Optionally, one can disable the polygon outputs for faster processing by passing <code>--polygon-format none</code> to the command.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>run Baysor</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">baysor</span> run Pancreas_prepared_tx_file.csv :cell <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--output</span> ~/data/baysor_outputs <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--gene-column</span> target <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--x-column</span> x_allS_um <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--y-column</span> y_allS_um <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--z-column</span> z_allS_um <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--config</span> baysor_cosmx_config.toml <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--count-matrix-format</span> tsv</span></code></pre></div>
</div>
</div>
<p>An example configuration file for using CosMx data with <code>Baysor</code> is shown below.</p>
<div class="sourceCode" id="cb7" data-caption="baysor_cosmx_config.toml" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[data]</span></span>
<span id="cb7-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">gene</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"target"</span></span>
<span id="cb7-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">min_molecules_per_gene</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">exclude_genes</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FalseCode*,NegPrb*,SystemControl*,Negative*,Custom*"</span></span>
<span id="cb7-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">min_molecules_per_cell</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb7-6"></span>
<span id="cb7-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[segmentation]</span></span>
<span id="cb7-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">prior_segmentation_confidence</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Confidence of the prior segmentation. Default: 0.2</span></span>
<span id="cb7-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unassigned_prior_label</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0"</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Label for unassigned cells in the prior segmentation. Default: "0"</span></span>
<span id="cb7-10"></span>
<span id="cb7-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[plotting]</span></span>
<span id="cb7-12"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">min_pixels_per_cell</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of pixels per cell of minimal size, used to estimate size of the final plot. For most protocols values around 7-30 give enough visualization quality. Default: 15</span></span>
<span id="cb7-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">max_plot_size</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Maximum size of the molecule plot in pixels. Default: 5000A</span></span></code></pre></div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Since a full run can be time-consuming, it’s recommended to perform a quick preview to extract initial insights from the data and to make informed guesses about the parameters for the full analysis. One can achieve this with <code>baysor preview</code> command using the same input arguments. For more details, see <a href="https://kharchenkolab.github.io/Baysor/dev/preview/" target="_blank">here</a> and a discussion on parameter choices could be found <a href="https://kharchenkolab.github.io/Baysor/dev/segmentation/#Choice-of-parameters" target="_blank">here</a>.</p>
</div>
</div>
<p><strong>Outputs</strong></p>
<p>By default, <code>baysor</code> segmentation generates the following outputs.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Baysor outputs</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">baysor_outputs/</span></span>
<span id="cb8-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> segmentation_cell_stats.csv</span>
<span id="cb8-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> segmentation_counts.tsv</span>
<span id="cb8-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> segmentation.csv</span>
<span id="cb8-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> segmentation_log.log</span>
<span id="cb8-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> segmentation_params.dump.toml</span>
<span id="cb8-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> segmentation_polygons_2d.json</span>
<span id="cb8-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">└──</span> segmentation_polygons_3d.json</span></code></pre></div>
</div>
</div>
<p>A full description on outputs could be found in Baysor’s <a href="https://kharchenkolab.github.io/Baysor/dev/segmentation/" target="_blank">documentations</a>. Briefly,</p>
<ul>
<li><p><code>segmentation_cell_stats.csv</code>: a cell x attributes data frame with new cell ID under <code>cell</code> column, number of transcripts assigned under <code>n_transcripts</code> column, and average assignment confidence per cell under <code>avg_assignment_confidence</code> column.</p></li>
<li><p><code>segmentation_counts.tsv</code>: the single-cell count matrix with segmented statistics; one could choose to output it as <code>loom</code> format when setting <code>--count-matrix-format loom</code> in command.</p></li>
<li><p><code>segmentation.csv</code>: the per molecular level information for the full transcript file, with <code>cell</code> column for new cell ID, <code>confidence</code> and <code>is_noise</code> columns for whether the molecule is real (not noise), and <code>assignment_confidence</code> column for the confidence that the particular molecule is assigned to a correct cell.</p>
<ul>
<li>We recommend to remove molecules with <code>confidence</code> below <code>0.9</code> or <code>is_nose = True</code> from single-cell expression matrix for downstream analysis.</li>
</ul></li>
</ul>
</section>
</section>
<section id="proseg-fast-transcript-simulation-based-segmentation" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="proseg-fast-transcript-simulation-based-segmentation"><span class="header-section-number">3.2</span> ProSeg: Fast Transcript Simulation Based Segmentation</h2>
<p><a href="https://github.com/dcjones/proseg" target="_blank">ProSeg</a> <span class="citation" data-cites="jones2025cell">(Jones et al. 2025)</span> is a high-speed, Rust-based tool that segments cells using density-based clustering of transcript positions. It is optimized for large datasets from platforms like CosMx.</p>
<p><strong>Pros</strong></p>
<ul>
<li>Much faster and smaller memory footprint than Baysor</li>
<li>Does not require image inputs to consider prior segmentation with assigned nuclear compartment</li>
<li>Works on compressed csv.gz files directly</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>Fewer model-based refinements than Baysor</li>
<li>A sampling method which runs in non-deterministic way in its current form.</li>
<li>The direct outputs are posterior expectations instead of integers counts assigned to each cell.</li>
<li>Prone to merge error and generate abnormally large cells near sample edge next to cell-free region.</li>
</ul>
<section id="install-proseg" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="install-proseg"><span class="header-section-number">3.2.1</span> Install ProSeg</h3>
<p>To install <code>ProSeg</code>, one would need to first install <code>cargo</code> and then the <code>proseg</code> package. For an AWS EC2 instance, one should first log into the instance as admin (see Baysor installation above Section&nbsp;3.1.1 for details) and then do the following.</p>
<ol type="1">
<li>Install <code>cargo</code> as admin <code>root</code> and set it up for all users.</li>
</ol>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>install cargo</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">curl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--proto</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'=https'</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--tlsv1.2</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-sSf</span> https://sh.rustup.rs <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sh</span></span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># activate cargo environment or restart session to have PATH change in effect </span></span>
<span id="cb9-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">.</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$HOME</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">/.cargo/env"</span></span>
<span id="cb9-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$HOME</span></span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test installation</span></span>
<span id="cb9-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span> cargo</span>
<span id="cb9-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">cargo</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--version</span></span></code></pre></div>
</div>
</div>
<p>By default, <code>cargo</code> would be installed under <code>/root/.cargo</code> folder. To make it executable for all users, one could copy its binary to local environment.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>setup cargo for all users</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ls</span> /root/.cargo/bin/</span>
<span id="cb10-2"></span>
<span id="cb10-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> cp /root/.cargo/bin/<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span> /usr/local/bin/</span>
<span id="cb10-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> chmod 755 /usr/local/bin/<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span></span></code></pre></div>
</div>
</div>
<p>Now, one could use <code>cargo</code> as non-admin user.</p>
<ol start="2" type="1">
<li>Clone and install <code>proseg</code>.</li>
</ol>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>install proseg</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone https://github.com/dcjones/proseg.git</span>
<span id="cb11-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">cargo</span> install proseg</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test installation</span></span>
<span id="cb11-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span> proseg</span>
<span id="cb11-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">proseg</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--version</span></span></code></pre></div>
</div>
</div>
</section>
<section id="run-proseg" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="run-proseg"><span class="header-section-number">3.2.2</span> Run ProSeg</h3>
<p>Same as <code>baysor</code>, the primary input for <code>proseg</code> is the transcript data frame. Since <code>proseg</code> command allows a more flexible data structure and internal conversion between pixel and micrometer units using <code>coordinate-scale</code> argument, the transcript file exported by AtoMx<sup>®</sup> SIP could be used directly without modification or decompression (i.e.&nbsp;working for <code>.csv.gz</code> file).</p>
<p><strong>Run Command</strong></p>
<p>Below is an example command that performs ProSeg segmentation on transcript file (e.g.&nbsp;<code>Pancreas_tx_file.csv</code>) and output results to folder <code>~/data/proseg_outputs</code>. In addition to prior segmentation, the assigned nuclear compartments in transcript files are also provided to <code>proseg</code> via arguments <code>--compartment-column CellComp --compartment-nuclear Nuclear</code>.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>run ProSeg</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">proseg</span> Pancreas_tx_file.csv <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--output-path</span> ~/data/proseg_outputs <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--gene-column</span> target <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--x-column</span> x_global_px <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--y-column</span> y_global_px <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--z-column</span> z <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--compartment-column</span> CellComp <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--compartment-nuclear</span> Nuclear <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--fov-column</span> fov <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--cell-id-column</span> cell <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--cell-id-unassigned</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--cell-assignment-column</span> cell_ID <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--cell-assignment-unassigned</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0'</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--excluded-genes</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'^(SystemControl|Negative)'</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb12-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--coordinate-scale</span> 0.12028 </span></code></pre></div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>ProSeg performs a z coordinate normalization step to remove sample tilt and cap z coordinates within 1st ~ 99th percentile of original value. Thus, it’s recommended to split your dataset by tissue sections first and then process each one separately. This helps avoid problems that can happen because the sections may have different z-coordinate values. More advice and description on argument options could be found <a href="https://github.com/dcjones/proseg/tree/main?tab=readme-ov-file#modeling-assumptions" target="_blank">here</a>.</p>
</div>
</div>
<p><strong>Outputs</strong></p>
<p>By default, <code>proseg</code> segmentation generates the following outputs.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>ProSeg outputs</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">proseg_outputs/</span></span>
<span id="cb13-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> cell-metadata.csv</span>
<span id="cb13-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> cell-polygons.geojson</span>
<span id="cb13-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> cell-polygons-layers.geojson</span>
<span id="cb13-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> expected-counts.csv</span>
<span id="cb13-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> transcript-metadata.csv</span>
<span id="cb13-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">└──</span> union-cell-polygons.geojson</span></code></pre></div>
</div>
</div>
<p>A full description on ProSeg’s output format could be found <a href="https://github.com/dcjones/proseg/tree/main?tab=readme-ov-file#output-options" target="_blank">here</a>. Briefly.</p>
<ul>
<li><p><code>cell-metadata.csv</code>: a cell x attributes data frame with new cell ID under <code>cell</code> column, cell volume under <code>volume</code> column.</p>
<ul>
<li>We recommend to inspect the <code>volume</code> value to remove cells that are abnormally large.</li>
</ul></li>
<li><p><code>expected-counts.csv</code>: the single-cell expression matrix with segmented statistics; the reported expression values are posterior expectations shown as fractional counts instead of integers.</p>
<ul>
<li>We recommend to calculate the observed single-cell count matrix with the new cell ID assignment from the output <code>transcript-metadata.csv</code> before downstream single-cell analysis for consistency.</li>
</ul></li>
<li><p><code>transcript-metadata.csv</code>: the per molecular level information for the full transcript file, with <code>gene</code> column for gene name, <code>assignment</code> column for new cell ID, <code>probability</code> and <code>background</code> columns for whether the molecule is real and confidently assigned.</p>
<ul>
<li>We recommend to remove molecules with <code>background = 1</code> before generating the observed single-cell count matrix from transcript file.</li>
</ul></li>
</ul>
<p><strong>Generate Count Matrix</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># read in ProSeg processed transcript files in R</span></span>
<span id="cb14-2">dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data.table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"proseg_outputs/transcript-metadata.csv"</span>)</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove background transcripts and keep only the needed columns </span></span>
<span id="cb14-5">dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dt[background <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, .SD, .SDcols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'assignment'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gene'</span>)]</span>
<span id="cb14-6">dt[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gene'</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(dt[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gene'</span>]])</span>
<span id="cb14-7">dt[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'assignment'</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(dt[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'assignment'</span>]])</span>
<span id="cb14-8"></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get observed cell x gene count matrix </span></span>
<span id="cb14-10">counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reshape2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">acast</span>(dt, assignment <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> gene, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fun.aggregate =</span> length)</span>
<span id="cb14-11">counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Matrix</span>(counts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sparse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span></code></pre></div>
</div>
</section>
</section>
<section id="fastreseg-transcript-based-segmentation-refinement" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="fastreseg-transcript-based-segmentation-refinement"><span class="header-section-number">3.3</span> FastReseg: Transcript-Based Segmentation Refinement</h2>
<p><a href="https://github.com/Nanostring-Biostats/FastReseg" target="_blank">FastReseg</a> <span class="citation" data-cites="Wu2025FastReseg">(Wu, Beechem, and Danaher 2025)</span> is a transcript-informed refinement tool that improves segmentation masks (e.g., from Cellpose or watershed) by leveraging local transcript expression profiles to resolve over-segmentation, under-segmentation, and cell boundaries.</p>
<p><strong>Pros</strong></p>
<ul>
<li>Fast and lightweight</li>
<li>Enhances biological accuracy without radically redefining cell boundaries</li>
<li>Supports configurable refinement rules</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>Requires an existing segmentation mask</li>
<li>Works best with dense, high-plex data</li>
</ul>
<p>Please refer to <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/segmentation-error-evaluation/" target="_blank">earlier post</a> and the <a href="https://nanostring-biostats.github.io/FastReseg/articles/tutorial.html" target="_blank">package tutorial</a> on how to use <code>FastReseg</code> to evaluate segmentation performance and further perform refinement.</p>
<section id="fastreseg-custom-module-in-atomx" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="fastreseg-custom-module-in-atomx"><span class="header-section-number">3.3.1</span> FastReseg Custom Module in AtoMx</h3>
<p>For AtoMx users (version 2.0.1 or later), here we provide a <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/fastReseg-custom-module" target="_blank">custom module</a> designed to perform FastReseg analysis on CosMx RNA studies hosted on the AtoMx SIP platform.</p>
<p>This module conducts segmentation evaluation on pre-segmented data and introduces a new cell metadata column, <code>lrtest_nlog10P</code>, which quantifies the degree of spatial dependency observed within existing cells. It also enables the removal of flagged transcripts from current cell segments. When the module is executed a second time with the same configuration and <code>overwrite_RNA_soma = TRUE</code>, it allows downstream AtoMx analysis to proceed using the trimmed RNA data. Currently, the FastReseg custom module supports transcript cleanup through trimming only, as this is the primary error mode encountered in thin tissue sections.</p>
</section>
</section>
<section id="ficture-segmentation-free-spatial-transcript-analysis" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="ficture-segmentation-free-spatial-transcript-analysis"><span class="header-section-number">3.4</span> FICTURE: Segmentation-Free Spatial Transcript Analysis</h2>
<p><a href="https://github.com/seqscope/ficture" target="_blank">FICTURE</a> <span class="citation" data-cites="si2024ficture">(Si et al. 2024)</span> is a segmentation-free spatial factorization method. It models spatial transcript patterns using statistical models to extract biologically meaningful regions and interactions.</p>
<p><strong>Pros</strong></p>
<ul>
<li>No reliance on image or segmentation</li>
<li>Ideal for spatial transcriptomics data of submicron-resolution (e.g., Seq-Scope, CosMx)</li>
<li>Avoids biases of segmentation methods</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>Works on 2D transcript data only</li>
<li>Doesn’t yield per-cell outputs (i.e., no cell boundaries)</li>
<li>Interpretation can be abstract for some users</li>
</ul>
<section id="install-ficture" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="install-ficture"><span class="header-section-number">3.4.1</span> Install FICTURE</h3>
<p><code>FICTURE</code> relies on <code>bgzip</code> and <code>tabix</code> for file processing and one could install those libraries as part of <code>htslib</code> installation. For an AWS EC2 instance, one should first log into the instance as admin (see Baysor installation above Section&nbsp;3.1.1 for details) and then do the following.</p>
<ol type="1">
<li>Install <code>htslib</code>C library (<a href="https://www.htslib.org/download/" target="_blank">latest release</a>).</li>
</ol>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>install C dependencies of FICTURE</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># download and unzip the release version</span></span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> https://github.com/samtools/htslib/releases/download/1.20/htslib-1.20.tar.bz2</span>
<span id="cb15-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tar</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-xvjf</span> htslib-1.20.tar.bz2</span>
<span id="cb15-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> htslib-1.20</span>
<span id="cb15-5"></span>
<span id="cb15-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># setup location to install, typically under /usr/local/ for all users</span></span>
<span id="cb15-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">./configure</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--prefix</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>/usr/local/</span>
<span id="cb15-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> make</span>
<span id="cb15-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> make install</span>
<span id="cb15-10"></span>
<span id="cb15-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test installation</span></span>
<span id="cb15-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">htsfile</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--version</span></span></code></pre></div>
</div>
</div>
<p>If the installation location is not under <code>/usr/local/</code>, one would need to add the installation path to <code>PATH</code> system environment variable when login as non-admin user.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>update PATH</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">PATH</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>/where/to/install/bin/:<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$PATH</span></span>
<span id="cb16-2"></span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test installation</span></span>
<span id="cb16-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">bgzip</span></span>
<span id="cb16-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">tabix</span></span></code></pre></div>
</div>
</div>
<ol start="2" type="1">
<li>Set up python virtual environment and install <code>FICTURE</code> package via pip.</li>
</ol>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>create env and install FICTURE</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Create a virtual environment</span></span>
<span id="cb17-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">VENV</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>/path/to/venv/name   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## replace it with your desired path</span></span>
<span id="cb17-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${VENV}</span></span>
<span id="cb17-4"></span>
<span id="cb17-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Activate the virtual environment</span></span>
<span id="cb17-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${VENV}</span>/bin/activate</span>
<span id="cb17-7"></span>
<span id="cb17-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Clone the GitHub repository</span></span>
<span id="cb17-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone https://github.com/seqscope/ficture.git</span>
<span id="cb17-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> ficture</span>
<span id="cb17-11"></span>
<span id="cb17-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Install the required packages</span></span>
<span id="cb17-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span>
<span id="cb17-14"></span>
<span id="cb17-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Install FICTURE locally</span></span>
<span id="cb17-16"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-e</span> .</span></code></pre></div>
</div>
</div>
</section>
<section id="run-ficture" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="run-ficture"><span class="header-section-number">3.4.2</span> Run FICTURE</h3>
<p>A full description on how to run FICTURE could be found <a href="https://seqscope.github.io/ficture/localrun/" target="_blank">here</a>. More information regarding how to submit FICTURE jobs to SLURM cluster is described in FICTURE’s <a href="https://seqscope.github.io/ficture/run/" target="_blank">documents</a>.</p>
<p><strong>Prepare Inputs</strong></p>
<p>Below is an example command that prepares AtoMx-exported transcript file (e.g.&nbsp;<code>Pancreas_tx_file.csv</code>) for FICTURE processing using its utility function. See <a href="https://seqscope.github.io/ficture/format_input/cosmx/" target="_blank">here</a> for more details.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>prepare CosMx Tx file for FICTURE</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># path to input transcript file, working for .csv.gz file too </span></span>
<span id="cb18-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">inputFile</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>/path/to/input/Pancreas_tx_file.csv</span>
<span id="cb18-3"></span>
<span id="cb18-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## set up output folder and identifier </span></span>
<span id="cb18-5"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outDir</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>/path/to/preprocess_data</span>
<span id="cb18-6"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">iden</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>pancreas</span>
<span id="cb18-7"></span>
<span id="cb18-8"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">filteredFile</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${outDir}</span>/filtered.matrix.<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${iden}</span>.tsv</span>
<span id="cb18-9"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">featureFile</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${outDir}</span>/feature.clean.<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${iden}</span>.tsv</span>
<span id="cb18-10"></span>
<span id="cb18-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># navigate to the root folder of FICTURE package to use its utilities function</span></span>
<span id="cb18-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> ficture </span>
<span id="cb18-13"></span>
<span id="cb18-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate transcript file (required) and gene list (optional)</span></span>
<span id="cb18-15"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> misc/format_cosmx.py <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb18-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--input</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${inputFile}</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb18-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--output</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${filteredFile}</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb18-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--gcol</span> target <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb18-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--feature</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${featureFile}</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb18-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--dummy_genes</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Negative|SystemControl'</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb18-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--px_to_um</span> 0.12028 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb18-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--precision</span> 2 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb18-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--annotation</span> cell fov</span>
<span id="cb18-24"></span>
<span id="cb18-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sort the filtered transcript files based on coordinate columns (first 2) and then zip it</span></span>
<span id="cb18-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-k2,2g</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-k1,1g</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${filteredFile}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gzip</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${filteredFile}</span>.gz</span>
<span id="cb18-27"></span>
<span id="cb18-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove the unsorted unzip version</span></span>
<span id="cb18-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${filteredFile}</span></span></code></pre></div>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>preprocess outputs</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">preprocess_data/</span></span>
<span id="cb19-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> coordinate_minmax.tsv</span>
<span id="cb19-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> feature.clean.pancreas.tsv</span>
<span id="cb19-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">└──</span> filtered.matrix.pancreas.tsv.gz</span></code></pre></div>
</div>
</div>
<p><strong>Run Command</strong></p>
<p>Below is an example command that perform the complete FICTURE pipeline with 2 different hexagon flat-to-flat widths <code>train-width</code>, 12 and 18 micron, at same time.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>run FICTURE</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># setup pipeline output folder</span></span>
<span id="cb20-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outDir2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>/path/to/ficture_outputs</span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate transcript file and gene list (optional)</span></span>
<span id="cb20-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ficture</span> run together <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--in-tsv</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${filteredFile}</span>.gz <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb20-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--in-minmax</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${outDir}</span>/coordinate_minmax.tsv <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb20-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--in-feature</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${featureFile}</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb20-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--out-dir</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${outDir2}</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb20-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--train-width</span> 12,18 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb20-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--n-factor</span> 12 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb20-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--n-jobs</span> 4<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb20-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--plot-each-factor</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb20-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--all</span></span></code></pre></div>
</div>
</div>
<p>If the installation path for <code>bgzip</code> and <code>tabix</code> is not under <code>/usr/local/bin/</code>, pass the installation location to the <code>ficture</code> command as well: <code>--bgzip /where/to/install/bin/bgzip --tabix /where/to/install/bin/tabix</code>.</p>
<p><strong>Outputs</strong></p>
<p>By default, <code>ficture run together</code> command generates the following outputs when setting number of expression factors <code>n-factor</code> to 12 with 2 different <code>train-width</code> values. A detailed description on the output files are described in FICTURE’s <a href="https://seqscope.github.io/ficture/localrun/#output" target="_blank">documents</a>.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>FICTURE outputs</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ficture_outputs</span></span>
<span id="cb21-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> analysis</span>
<span id="cb21-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   ├── nF12.d_12</span>
<span id="cb21-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── figure</span>
<span id="cb21-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │   ├── nF12.d_12.cbar.png</span>
<span id="cb21-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │   ├── nF12.d_12.coarse.png</span>
<span id="cb21-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │   ├── nF12.d_12.coarse.top.png</span>
<span id="cb21-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │   ├── nF12.d_12.decode.prj_12.r_4_5.pixel.png</span>
<span id="cb21-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │   ├── nF12.d_12.rgb.tsv</span>
<span id="cb21-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │   └── sub</span>
<span id="cb21-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       ├── nF12.d_12.decode.prj_12.r_4_5.pixel.F_0.png</span>
<span id="cb21-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       ├── nF12.d_12.decode.prj_12.r_4_5.pixel.F_10.png</span>
<span id="cb21-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       ├── nF12.d_12.decode.prj_12.r_4_5.pixel.F_11.png</span>
<span id="cb21-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       ├── nF12.d_12.decode.prj_12.r_4_5.pixel.F_1.png</span>
<span id="cb21-15"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       ├── nF12.d_12.decode.prj_12.r_4_5.pixel.F_2.png</span>
<span id="cb21-16"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       ├── nF12.d_12.decode.prj_12.r_4_5.pixel.F_3.png</span>
<span id="cb21-17"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       ├── nF12.d_12.decode.prj_12.r_4_5.pixel.F_4.png</span>
<span id="cb21-18"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       ├── nF12.d_12.decode.prj_12.r_4_5.pixel.F_5.png</span>
<span id="cb21-19"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       ├── nF12.d_12.decode.prj_12.r_4_5.pixel.F_6.png</span>
<span id="cb21-20"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       ├── nF12.d_12.decode.prj_12.r_4_5.pixel.F_7.png</span>
<span id="cb21-21"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       ├── nF12.d_12.decode.prj_12.r_4_5.pixel.F_8.png</span>
<span id="cb21-22"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   │       └── nF12.d_12.decode.prj_12.r_4_5.pixel.F_9.png</span>
<span id="cb21-23"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.coherence.tsv</span>
<span id="cb21-24"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.decode.prj_12.r_4_5.anchor.tsv.gz</span>
<span id="cb21-25"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.decode.prj_12.r_4_5.bulk_chisq.tsv</span>
<span id="cb21-26"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.decode.prj_12.r_4_5.done</span>
<span id="cb21-27"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.decode.prj_12.r_4_5.factor.info.html</span>
<span id="cb21-28"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.decode.prj_12.r_4_5.factor.info.tsv</span>
<span id="cb21-29"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.decode.prj_12.r_4_5.pixel.sorted.tsv.gz</span>
<span id="cb21-30"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.decode.prj_12.r_4_5.pixel.sorted.tsv.gz.tbi</span>
<span id="cb21-31"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.decode.prj_12.r_4_5.posterior.count.tsv.gz</span>
<span id="cb21-32"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.done</span>
<span id="cb21-33"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.fit_result.tsv.gz</span>
<span id="cb21-34"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.model_matrix.tsv.gz</span>
<span id="cb21-35"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.model.p</span>
<span id="cb21-36"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.model_selection_candidates.p</span>
<span id="cb21-37"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.posterior.count.tsv.gz</span>
<span id="cb21-38"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   ├── nF12.d_12.prj_12.r_4.fit_result.tsv.gz</span>
<span id="cb21-39"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   │   └── nF12.d_12.prj_12.r_4.posterior.count.tsv.gz</span>
<span id="cb21-40"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>   └── nF12.d_18</span>
<span id="cb21-41"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── figure</span>
<span id="cb21-42"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │   ├── nF12.d_18.cbar.png</span>
<span id="cb21-43"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │   ├── nF12.d_18.coarse.png</span>
<span id="cb21-44"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │   ├── nF12.d_18.coarse.top.png</span>
<span id="cb21-45"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │   ├── nF12.d_18.decode.prj_18.r_4_5.pixel.png</span>
<span id="cb21-46"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │   ├── nF12.d_18.rgb.tsv</span>
<span id="cb21-47"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │   └── sub</span>
<span id="cb21-48"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.F_0.png</span>
<span id="cb21-49"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.F_10.png</span>
<span id="cb21-50"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.F_11.png</span>
<span id="cb21-51"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.F_1.png</span>
<span id="cb21-52"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.F_2.png</span>
<span id="cb21-53"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.F_3.png</span>
<span id="cb21-54"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.F_4.png</span>
<span id="cb21-55"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.F_5.png</span>
<span id="cb21-56"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.F_6.png</span>
<span id="cb21-57"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.F_7.png</span>
<span id="cb21-58"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.F_8.png</span>
<span id="cb21-59"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       │       └── nF12.d_18.decode.prj_18.r_4_5.pixel.F_9.png</span>
<span id="cb21-60"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.coherence.tsv</span>
<span id="cb21-61"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.decode.prj_18.r_4_5.anchor.tsv.gz</span>
<span id="cb21-62"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.decode.prj_18.r_4_5.bulk_chisq.tsv</span>
<span id="cb21-63"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.decode.prj_18.r_4_5.done</span>
<span id="cb21-64"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.decode.prj_18.r_4_5.factor.info.html</span>
<span id="cb21-65"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.decode.prj_18.r_4_5.factor.info.tsv</span>
<span id="cb21-66"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.sorted.tsv.gz</span>
<span id="cb21-67"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.decode.prj_18.r_4_5.pixel.sorted.tsv.gz.tbi</span>
<span id="cb21-68"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.decode.prj_18.r_4_5.posterior.count.tsv.gz</span>
<span id="cb21-69"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.done</span>
<span id="cb21-70"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.fit_result.tsv.gz</span>
<span id="cb21-71"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.model_matrix.tsv.gz</span>
<span id="cb21-72"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.model.p</span>
<span id="cb21-73"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.model_selection_candidates.p</span>
<span id="cb21-74"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.posterior.count.tsv.gz</span>
<span id="cb21-75"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       ├── nF12.d_18.prj_18.r_4.fit_result.tsv.gz</span>
<span id="cb21-76"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">│</span>       └── nF12.d_18.prj_18.r_4.posterior.count.tsv.gz</span>
<span id="cb21-77"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> batched.matrix.tsv.gz</span>
<span id="cb21-78"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> hexagon.d_12.tsv.gz</span>
<span id="cb21-79"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> hexagon.d_18.tsv.gz</span>
<span id="cb21-80"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> Makefile</span>
<span id="cb21-81"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">└──</span> sort_decode.sh</span></code></pre></div>
</div>
</div>



</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-jones2025cell" class="csl-entry">
Jones, D. C., A. E. Elz, A. Hadadianpour, et al. 2025. <span>“Cell Simulation as Cell Segmentation.”</span> <em>Nature Methods</em>. <a href="https://doi.org/10.1038/s41592-025-02697-0">https://doi.org/10.1038/s41592-025-02697-0</a>.
</div>
<div id="ref-petukhov2021cell" class="csl-entry">
Petukhov, Vladimir, Rui J. Xu, Ruslan A. Soldatov, Pietro Cadinu, Konstantin Khodosevich, Jeffrey R. Moffitt, and Peter V. Kharchenko. 2021. <span>“Cell Segmentation in Imaging-Based Spatial Transcriptomics.”</span> <em>Nature Biotechnology</em>. <a href="https://doi.org/10.1038/s41587-021-01044-w">https://doi.org/10.1038/s41587-021-01044-w</a>.
</div>
<div id="ref-si2024ficture" class="csl-entry">
Si, Yichen, ChangHee Lee, Yongha Hwang, Jeong H. Yun, Weiqiu Cheng, Chun-Seok Cho, Miguel Quiros, et al. 2024. <span>“FICTURE: Scalable Segmentation-Free Analysis of Submicron-Resolution Spatial Transcriptomics.”</span> <em>Nature Methods</em> 21 (10): 1843–54. <a href="https://doi.org/10.1038/s41592-024-02415-2">https://doi.org/10.1038/s41592-024-02415-2</a>.
</div>
<div id="ref-Wu2025FastReseg" class="csl-entry">
Wu, Lidan, Joseph M. Beechem, and Patrick Danaher. 2025. <span>“Using Transcripts to Refine Image Based Cell Segmentation with FastReseg.”</span> <em>Scientific Reports</em> 15 (1): 30508. <a href="https://doi.org/10.1038/s41598-025-08733-5">https://doi.org/10.1038/s41598-025-08733-5</a>.
</div>
</div></section></div> ]]></description>
  <category>segmentation</category>
  <category>algorithms</category>
  <category>CosMx 2.0</category>
  <category>how-tos</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/transcript-segmentation/</guid>
  <pubDate>Tue, 15 Jul 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/transcript-segmentation/figures/Fig1-transcript-segmentation.png" medium="image" type="image/png" height="98" width="144"/>
</item>
<item>
  <title>Recommendations for batch correction</title>
  <dc:creator>Dan McGuire</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/batchcorrection/</link>
  <description><![CDATA[ 





<section id="abstract" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Abstract</h1>
<p>This post discusses batch effects in CosMx; how they impact analyses, how to detect them, and how to correct them. We recommend Harmony <span class="citation" data-cites="harmony">(Korsunsky et al. 2019)</span> as a useful method for correcting batch effects in dimension reduction embeddings such as PCA, and demonstrate an example of how to use the software package.</p>
<p>For those in a hurry to ‘just see the code’, feel free to jump ahead to the Harmony Analysis section of this post.</p>
</section>
<section id="introduction" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Introduction</h1>
<p>When analyzing multiple samples or ‘batches’ of data collected under different technologies or sample conditions, we may need to harmonize the data in a way that preserves biological variation while minimizing technical variation.</p>
<p>For example, suppose I were interested in analyzing multiple breast cancer tissue samples, but these samples were processed in different labs, by different scientists, or with different sample prep protocols. These technical differences could subtly effect gene detection efficiency in ways that may influence or confound an analysis. In particular, PCA, which responds quickly to small systematic changes impacting large numbers of variables, is highly sensitive to batch effects. This sensitivity then cascades down to analyses depending on PCA, e.g.&nbsp;UMAP and the Leiden and Louvain algorithms.</p>
<p>To check for presence of batch effects and whether correction is required, we recommend plotting the ‘batch’ on a UMAP plot or in principal component (PC) space (link to example figure). In the presence of batch effects, we may observe that cells cluster together by batch more distinctly than they do by their biological cell type.</p>
<p>For dimension reduction and clustering analyses, there is a multitude of existing research on batch correction methodology <span class="citation" data-cites="luecken2019current">(Luecken and Theis 2019)</span>. The Harmony method <span class="citation" data-cites="harmony">(Korsunsky et al. 2019)</span> has been recommended as a best-in-class approach in several studies which benchmarked different batch correction methodology for scRNAseq <span class="citation" data-cites="tran2020benchmark">(Tran et al. 2020)</span> <span class="citation" data-cites="emmanuel2024batch">(Emmanúel Antonsson and Melsted 2024)</span> . Harmony takes as input a low-dimensional cell embedding such as PCA, and projects cells onto a new unsupervised joint embedding that groups cells by biological cell type rather than dataset-specific conditions. This Harmony embedding can be used as an input to downstream dimension reduction and clustering algorithms like UMAP<span class="citation" data-cites="umap">(Ghojogh et al. 2021)</span> and Leiden<span class="citation" data-cites="leiden">(Traag, Waltman, and Van Eck 2019)</span>.</p>
<p>For some other downstream analyses, batch effects can be explicitly handled or may be less of a concern. In the case of differential expression (DE) analysis, we could account for the technical effects by specifying ‘batch’ as a covariate in our DE models. Supervised or semi-supervised cell typing analyses that are independent of PCA dimension reductions (i.e., InSituType <span class="citation" data-cites="Danaher2022">(Danaher et al. 2022)</span>), may be less affected by batch effects. If we were to observe batch effects in this setting, one useful approach would be to perform the cell typing separately by batch before aggregating the cell type annotations.</p>
<p>In this post, we demonstrate using Harmony for batch effect correction on two 6k-plex tonsil tissue datasets; one dataset generated with CosMx 1.5, while the other generated with CosMx 2.0. The recent CosMx 2.0 release offers noticeable increases in sensitivity; often obtaining 1.5-2x the transcripts compared to the same sample processed with previous CosMx 1.5 software. In case we want to analyze a v1.5 and v2.0 dataset in the same analysis, we might consider treating this variable as a batch effect.</p>
</section>
<section id="initial-look-at-the-data" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Initial Look at the data</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggrepel)</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Seurat.object.assay.version =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v3"</span>)  </span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### Make a combined Seurat Object</span></span>
<span id="cb1-8">sem_v20 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sem_v20.tiss_a.rds"</span>) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## tonsil dataset A with CosMx v2.0</span></span>
<span id="cb1-9">sem_v15 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sem_v15.tiss_b.rds"</span>) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## tonsil dataset B with CosMx v1.5</span></span></code></pre></div>
</div>
<section id="plot-the-two-batches" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="plot-the-two-batches"><span class="header-section-number">3.1</span> Plot the two batches</h2>
<p>Let’s take a quick peek at these two tissues, where unsupervised clustering has been performed independently on each:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">xyplot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> (cluster_column, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_slide_mm"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_slide_mm"</span>, </span>
<span id="cb2-2">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cls =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clusters =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, metadata, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ptsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plotfirst =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb2-3">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alphasize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>){</span>
<span id="cb2-4">  pd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data.table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy</span>(data.table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(metadata))</span>
<span id="cb2-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(clusters)) </span>
<span id="cb2-6">    clusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(pd[[cluster_column]])</span>
<span id="cb2-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(plotfirst)) {</span>
<span id="cb2-8">    plotfirst <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(clusters, plotfirst)</span>
<span id="cb2-9">    notplotfirst <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(clusters, plotfirst)</span>
<span id="cb2-10">    p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(pd[pd[[cluster_column]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> plotfirst], </span>
<span id="cb2-11">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(.data[[x_column]], .data[[y_column]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> .data[[cluster_column]])) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb2-12">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> ptsize)</span>
<span id="cb2-13">    p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> pd[pd[[cluster_column]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> </span>
<span id="cb2-14">                                    notplotfirst], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(.data[[x_column]], .data[[y_column]], </span>
<span id="cb2-15">                                                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> .data[[cluster_column]]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> ptsize, </span>
<span id="cb2-16">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> alphasize) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()</span>
<span id="cb2-17">  }</span>
<span id="cb2-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb2-19">    p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(pd[pd[[cluster_column]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> clusters], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(.data[[x_column]], </span>
<span id="cb2-20">                                                            .data[[y_column]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> .data[[cluster_column]])) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb2-21">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> ptsize, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> alphasize) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()</span>
<span id="cb2-22">  }</span>
<span id="cb2-23">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(cls)) {</span>
<span id="cb2-24">    cls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(pals<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alphabet</span>()), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb2-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">suppressWarnings</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(clusters)))))) {</span>
<span id="cb2-26">      clnames <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(clusters)</span>
<span id="cb2-27">    }</span>
<span id="cb2-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb2-29">      clnames <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(clusters)))</span>
<span id="cb2-30">    }</span>
<span id="cb2-31">    cls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cls[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(clusters)]</span>
<span id="cb2-32">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(cls) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> clnames</span>
<span id="cb2-33">    p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> cls, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, </span>
<span id="cb2-34">                                                                                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb2-35">  }</span>
<span id="cb2-36">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb2-37">    p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> cls, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, </span>
<span id="cb2-38">                                                                                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb2-39">  }</span>
<span id="cb2-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(p)</span>
<span id="cb2-41">}</span>
<span id="cb2-42"></span>
<span id="cb2-43">xyp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb2-44">cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_grid</span>(</span>
<span id="cb2-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xyplot</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seurat_clusters"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span>  sem_v20<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ptsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" v2.0"</span>)</span>
<span id="cb2-46">  ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xyplot</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seurat_clusters"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span>  sem_v15<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ptsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v1.5"</span>)</span>
<span id="cb2-47">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-48">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb2-49">  cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">remove=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span></code></pre></div>
</details>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/batchcorrection/figures/xyplot_v15_v20.png" alt="Wide Image"></p>
</div>
</section>
<section id="differences-in-sensitivity-between-batches" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="differences-in-sensitivity-between-batches"><span class="header-section-number">3.2</span> Differences in sensitivity between batches</h2>
<p>Here, we can compute a few high-level summary stats like transcripts per cell and signal to noise ratio (SNR) for each batch.</p>
<p>We see ~2x increase in transcripts per cell with the v2.0 dataset, and higher signal to noise ratio (snr).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Comparing counts/cell</span></span>
<span id="cb3-2"></span>
<span id="cb3-3">cts_cell_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(sem_v15[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>counts))</span>
<span id="cb3-4">cts_cell_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(sem_v20[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>counts))</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Comparing SNR</span></span>
<span id="cb3-7">snr_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(sem_v15[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>counts)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(sem_v15[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"negprobes"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>counts)) </span>
<span id="cb3-8">snr_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(sem_v20[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>counts)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(sem_v20[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"negprobes"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>counts))</span>
<span id="cb3-9"></span>
<span id="cb3-10">summary_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb3-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">transcripts_per_cell =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(cts_cell_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span>, cts_cell_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb3-12">           ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">snr =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(snr_1<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span>, snr_2<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.0</span>)</span>
<span id="cb3-13">           ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">version =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v1.5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v2.0"</span>))[]</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(summary_stats[])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   transcripts_per_cell      snr version
                  &lt;num&gt;    &lt;num&gt;  &lt;char&gt;
1:             448.3808 3.770205    v1.5
2:            1026.5255 6.043639    v2.0</code></pre>
</div>
</div>
</section>
</section>
<section id="combining-the-data" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Combining the data</h1>
<p>Here we’ll combine the two datasets and prepare to harmonize them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Get overlapping genes (all the genes in this case) to combine the two datasets</span></span>
<span id="cb6-2">overlapping_genes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(sem_v20), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(sem_v15))</span>
<span id="cb6-3">combined_metadata <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data.table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbindlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb6-4">  sem_v20<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data</span>
<span id="cb6-5">  ,sem_v15<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data</span>
<span id="cb6-6">  )</span>
<span id="cb6-7">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use.names=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb6-8">combined_metadata[cell_ID <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(sem_v15),batchid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v1.5"</span>]</span>
<span id="cb6-9">combined_metadata[cell_ID <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(sem_v20),batchid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v2.0"</span>]</span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Create a combined seurat object</span></span>
<span id="cb6-12">sem_comb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb6-13">Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CreateSeuratObject</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(sem_v20[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[overlapping_genes,]</span>
<span id="cb6-14">                                          ,sem_v15[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[overlapping_genes,])</span>
<span id="cb6-15">                           ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta.data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(combined_metadata</span>
<span id="cb6-16">                                                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row.names =</span> combined_metadata<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_ID)</span>
<span id="cb6-17">                           )</span>
<span id="cb6-18"></span>
<span id="cb6-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### offset the x-coordinate of v1.5 to </span></span>
<span id="cb6-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### more easily plot both tissues side-by-side</span></span>
<span id="cb6-21">x_offset <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>x_slide_mm[sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>batchid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v2.0"</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-22">sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>x_slide_mm[sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>batchid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v1.5"</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>x_slide_mm[sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>batchid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v1.5"</span>]  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x_offset</span></code></pre></div>
</div>
</section>
<section id="tldr" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Harmony Analysis</h1>
<p>With our combined dataset containing all batches, we’ll perform a few standard tertiary analysis steps using the <code>Seurat</code> package. After principal component analysis, we will pass the PC embeddings to Harmony for batch correction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Normalize, Scale, and Run PCA on the combined dataset </span></span>
<span id="cb7-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### (standard data analysis steps so far)</span></span>
<span id="cb7-3">sem_comb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindVariableFeatures</span>(sem_comb)</span>
<span id="cb7-4">normed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LogNormalize</span>(sem_comb[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts</span>
<span id="cb7-5">                                 ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale.factor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(sem_comb[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts))</span>
<span id="cb7-6">                                 )</span>
<span id="cb7-7">sem_comb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SetAssayData</span>(sem_comb, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">layer=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new.data =</span> normed)</span>
<span id="cb7-8">sem_comb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ScaleData</span>(sem_comb)</span>
<span id="cb7-9">sem_comb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RunPCA</span>(sem_comb)</span></code></pre></div>
</div>
<p>Now we run harmony with our PCA embeddings, specifying <code>"batchid"</code> as our variable to adjust for (our indicator for v1.5 and v2.0).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">harmony_embeddings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> harmony<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RunHarmony</span>(sem_comb[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pca"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings</span>
<span id="cb8-2">                                          ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta_data =</span> sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data</span>
<span id="cb8-3">                                          ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vars_use =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"batchid"</span></span>
<span id="cb8-4">                                          )</span></code></pre></div>
</div>
<p>The <code>harmony_embeddings</code> returned are a <code>cells</code> <img src="https://latex.codecogs.com/png.latex?%5Ctimes"> <code># of pc's</code> dimension matrix, with the same structure as the PCA embeddings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(harmony_embeddings)</span>
<span id="cb9-2">harmony_embeddings[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> num [1:405690, 1:50] -0.6465 2.4765 -0.8616 -0.0705 1.3351 ...
 - attr(*, "dimnames")=List of 2
  ..$ : chr [1:405690] "c_1_204_1008" "c_1_204_1026" "c_1_204_1032" "c_1_204_1037" ...
  ..$ : chr [1:50] "PC_1" "PC_2" "PC_3" "PC_4" ...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                    PC_1       PC_2       PC_3       PC_4       PC_5
c_1_204_1008 -0.64646187 -0.2827039 -2.8347802  1.6610461  2.2474144
c_1_204_1026  2.47653185  0.5783416 -0.4183124  0.9130872 -1.6640251
c_1_204_1032 -0.86158008 -3.1340938 -7.1958762 -3.2585168  1.8184731
c_1_204_1037 -0.07046239  0.8755237 -1.8787555  0.8000141  2.5718387
c_1_204_1046  1.33506948  1.1483278 -1.8171200  1.0649917  3.6876637
c_1_204_1051  2.10865793  1.8783302 -0.9869917  1.3061003  5.2610306
c_1_204_1068 -0.12255521 -1.0006297 -3.8287685  0.2517314  2.7422425
c_1_204_1099 -0.09401621 -0.3220125  0.3505044 -0.5086164  4.4133441
c_1_204_1100  1.21582681  1.8189899  0.1252721 -0.4560591  4.1331302
c_1_204_1110  2.92880860  1.4376377 -1.6135393  2.6411662 -0.4019986</code></pre>
</div>
</div>
<p>Here are what the original PCA embeddings look like for comparison:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(sem_comb[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pca"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings)</span>
<span id="cb12-2">sem_comb[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pca"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> num [1:405690, 1:50] -1.117 1.994 -1.456 -0.476 0.869 ...
 - attr(*, "dimnames")=List of 2
  ..$ : chr [1:405690] "c_1_204_1008" "c_1_204_1026" "c_1_204_1032" "c_1_204_1037" ...
  ..$ : chr [1:50] "PC_1" "PC_2" "PC_3" "PC_4" ...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                   PC_1       PC_2       PC_3       PC_4       PC_5
c_1_204_1008 -1.1173966 -0.6867905 -2.8949895  1.6105015  2.9180760
c_1_204_1026  1.9937914  0.2274147 -0.3855459  0.8213885 -1.0934278
c_1_204_1032 -1.4558828 -3.6307548 -7.3110656 -3.5378910  2.5581377
c_1_204_1037 -0.4759800  0.5822518 -1.8031810  0.6380289  3.0891367
c_1_204_1046  0.8686478  0.7673256 -1.8542354  0.9790450  4.3717053
c_1_204_1051  1.7701286  1.6232100 -0.9709824  1.1699966  6.0201625
c_1_204_1068 -0.6146554 -1.4230712 -3.9015371  0.1792131  3.4066027
c_1_204_1099 -0.5735693 -0.6600411  0.3747940 -0.6467651  4.9810832
c_1_204_1100  0.8734515  1.5610131  0.1432252 -0.5936082  4.8778765
c_1_204_1110  2.4355067  1.0686404 -1.6010894  2.5582519  0.1892688</code></pre>
</div>
</div>
</section>
<section id="umap-and-clustering-with-harmony" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> UMAP and clustering with harmony</h1>
<p>Let’s continue the analysis. We’ll use the Harmony embeddings rather than PCA embeddings to generate a UMAP and perform unsupervised clustering on the combined dataset.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## (minor side-note), this helper function `make_umap` calls the same package </span></span>
<span id="cb15-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## and function as Seurat::RunUMAP, but also returns the </span></span>
<span id="cb15-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 'nearest-neighbor graph' used in the UMAP algorithm.</span></span>
<span id="cb15-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Using the same nearest neighbor graph for clustering and UMAP, </span></span>
<span id="cb15-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## can give better concordance between UMAP and unsupervised clusters.</span></span>
<span id="cb15-6"></span>
<span id="cb15-7">make_umap <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(pcaobj, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_dist=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_neighbors=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cosine"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key =</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMAP_"</span> ){</span>
<span id="cb15-8">  ump <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb15-9">    uwot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">umap</span>(pcaobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>reduction.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings</span>
<span id="cb15-10">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_neighbors =</span> n_neighbors</span>
<span id="cb15-11">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nn_method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"annoy"</span></span>
<span id="cb15-12">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> metric</span>
<span id="cb15-13">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_dist =</span> min_dist</span>
<span id="cb15-14">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ret_extra =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fgraph"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nn"</span>)</span>
<span id="cb15-15">               ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb15-16">  </span>
<span id="cb15-17">  umpgraph <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ump<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fgraph</span>
<span id="cb15-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dimnames</span>(umpgraph) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(ump<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>idx), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(ump<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>idx))</span>
<span id="cb15-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(ump<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>embedding) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(key, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) </span>
<span id="cb15-20">  ump <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CreateDimReducObject</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">embeddings =</span> ump<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>embedding, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key =</span> key)</span>
<span id="cb15-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grph =</span> umpgraph</span>
<span id="cb15-22">              ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ump =</span> ump))</span>
<span id="cb15-23">}</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##### Run helper function to make a umap and return the </span></span>
<span id="cb16-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##### nearest-neighbors graph used for unsupervised clustering.</span></span>
<span id="cb16-3">umapharmony <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_umap</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pcaobj =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb16-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction.data =</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CreateDimReducObject</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">embeddings =</span> harmony_embeddings)</span>
<span id="cb16-5">  ))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">sem_comb[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"umapharmony"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> umapharmony<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ump</span>
<span id="cb17-2">sem_comb[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"umapharmonygrph"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Graph</span>(umapharmony<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grph)</span>
<span id="cb17-3">sem_comb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindClusters</span>(sem_comb, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">graph.name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"umapharmonygrph"</span>)</span>
<span id="cb17-4">sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clusters_unsup_harmony <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seurat_clusters</span></code></pre></div>
</div>
<p>Here’s another look at the tissues, with clustering results generated downstream of the Harmony embeddings.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">xyp_harmony <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xyplot</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clusters_unsup_harmony"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ptsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb18-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"After integration: v2.0 (left) and v1.5 (right)"</span>)</span>
<span id="cb18-4"></span>
<span id="cb18-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(xyp_harmony)</span></code></pre></div>
</details>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/batchcorrection/figures/xyplotharmony_v15_v20.png" alt="Wide Image"></p>
</div>
</section>
<section id="umap-and-clustering-without-harmony" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> UMAP and clustering without harmony</h1>
<p>Here we can re-make the UMAP and cluster without batch correction for sake of comparison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##### Run helper function to make a umap and return the nearest-neighbors graph.</span></span>
<span id="cb19-2">pcaobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sem_comb[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pca"</span>]]</span>
<span id="cb19-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(pcaobj)</span>
<span id="cb19-4">umapobj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_umap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reduction.data =</span> pcaobj))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">sem_comb[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"umap"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> umapobj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ump</span>
<span id="cb20-2">sem_comb[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"umapgrph"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Graph</span>(umapobj[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grph"</span>]])</span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Unsupervised clustering</span></span>
<span id="cb20-5">sem_comb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindClusters</span>(sem_comb, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">graph.name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"umapgrph"</span>)</span>
<span id="cb20-6">sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clusters_unsup_unintegrated <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>seurat_clusters</span></code></pre></div>
</div>
</section>
<section id="pcplotbatch" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Comparison with and without integration</h1>
<p>Plotting the first two PC’s, colored by <code>batchid</code>, it looks like the v1.5 data may span a more similar domain of PC1 and PC2 space after Harmony, indicating better integration.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb21-2">shuffle_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(harmony_embeddings)) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## shuffle cell order for plotting</span></span>
<span id="cb21-3">cls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1f77b4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#ff7f0e"</span>)</span>
<span id="cb21-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(cls) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v2.0"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v1.5"</span>)</span>
<span id="cb21-5"></span>
<span id="cb21-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all.equal</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(harmony_embeddings), sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cell_ID)</span>
<span id="cb21-7">pc1vs2_harmony <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb21-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)[,.(cell_ID, batchid, x_slide_mm, y_slide_mm)]</span>
<span id="cb21-9">      ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(harmony_embeddings))</span>
<span id="cb21-10"></span>
<span id="cb21-11">harmony_plt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb21-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(pc1vs2_harmony[shuffle_order], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> PC_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> PC_2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>batchid)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb21-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> cls) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb21-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb21-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb21-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb21-17"></span>
<span id="cb21-18">pc1vs2_regular <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb21-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)[,.(cell_ID, batchid, x_slide_mm, y_slide_mm)]</span>
<span id="cb21-20">      ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>reductions<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pca<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings))</span>
<span id="cb21-21"></span>
<span id="cb21-22">regular_pca_plt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb21-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(pc1vs2_regular[shuffle_order], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> PC_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> PC_2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>batchid)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb21-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> cls) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb21-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb21-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb21-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb21-28"></span>
<span id="cb21-29">pc_comparison_plt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb21-30">cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_grid</span>(harmony_plt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"integrated using harmony"</span>)</span>
<span id="cb21-31">                   ,regular_pca_plt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"un-integrated"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb21-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb21-33">  cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">remove=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span>
<span id="cb21-34"></span>
<span id="cb21-35"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(pc_comparison_plt)</span></code></pre></div>
</details>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/batchcorrection/figures/pc_comparison_plot.png" alt="Wide Image"></p>
</div>
<p>Plotting the UMAP, colored by <code>batchid</code>, there doesn’t appear to be an enourmous difference (which is not a bad thing), but it does look like there may be areas of the UMAP better covered by both datasets (less batch-specific) after Harmony integration.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">umap_harmony <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb22-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)[,.(cell_ID, batchid, x_slide_mm, y_slide_mm)]</span>
<span id="cb22-3">      ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>reductions<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>umapharmony<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings))</span>
<span id="cb22-4"></span>
<span id="cb22-5">harmony_plt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb22-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(umap_harmony[shuffle_order], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> UMAP_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> UMAP_2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>batchid)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> cls) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb22-11"></span>
<span id="cb22-12">umap_regular <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb22-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)[,.(cell_ID, batchid, x_slide_mm, y_slide_mm)]</span>
<span id="cb22-14">      ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>reductions<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>umap<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings))</span>
<span id="cb22-15"></span>
<span id="cb22-16">regular_umap_plt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb22-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(umap_regular[shuffle_order], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> umap_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> umap_2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>batchid)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> cls) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb22-22"></span>
<span id="cb22-23">umap_comparison_plt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb22-24">cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_grid</span>(harmony_plt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"integrated using harmony"</span>)</span>
<span id="cb22-25">                   ,regular_umap_plt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"un-integrated"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb22-27">  cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">remove=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span>
<span id="cb22-28"></span>
<span id="cb22-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(umap_comparison_plt)</span></code></pre></div>
</details>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/batchcorrection/figures/umap_comparison_plot.png" alt="Wide Image"></p>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">umap_harmony_clusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb23-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)[,.(cell_ID, clusters_unsup_harmony, x_slide_mm, y_slide_mm)]</span>
<span id="cb23-3">      ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>reductions<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>umapharmony<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings))</span>
<span id="cb23-4"></span>
<span id="cb23-5">harmony_plt_clusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb23-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(umap_harmony_clusters, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> UMAP_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> UMAP_2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>clusters_unsup_harmony)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(pals<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alphabet</span>())) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb23-11"></span>
<span id="cb23-12">umap_regular_clusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb23-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)[,.(cell_ID, clusters_unsup_unintegrated, x_slide_mm, y_slide_mm)]</span>
<span id="cb23-14">      ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem_comb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>reductions<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>umap<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>cell.embeddings))</span>
<span id="cb23-15"></span>
<span id="cb23-16">regular_umap_plt_clusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb23-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(umap_regular_clusters, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> umap_1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> umap_2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>clusters_unsup_unintegrated)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(pals<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alphabet</span>())) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb23-22"></span>
<span id="cb23-23">umap_comparison_plt_clusters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb23-24">cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_grid</span>(harmony_plt_clusters <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"integrated using harmony"</span>)</span>
<span id="cb23-25">                   ,regular_umap_plt_clusters <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"un-integrated"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb23-27">  cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">remove=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span>
<span id="cb23-28"></span>
<span id="cb23-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(umap_comparison_plt_clusters)</span></code></pre></div>
</details>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/batchcorrection/figures/umap_comparison_plot_clusters.png" alt="Wide Image"></p>
</div>
</section>
<section id="conclusion" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Conclusion</h1>
<p>In this post we demonstrated applying the batch effect correction technique ‘Harmony’ to two 6K-plex tonsil tissue datasets generated with very different sensitivity performance. In general, the impact of batch effects may depend on the severity of the technical artifact, as well as the scope and depth of the analysis. In the event that one wishes to analyze multiple samples together which were generated under different technical conditions, we recommend plotting the technical batch variable in UMAP or PC space as a qualitative diagnostic, and inspecting whether cells are clustered by ‘batch’. For this example, the batch effect between our two datasets was visually noticeable when plotted on a UMAP and the first two principal components. Cells were visually less segregated by batch after the correction was applied.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-Danaher2022" class="csl-entry">
Danaher, Patrick, Edward Zhao, Zhi Yang, David Ross, Mark Gregory, Zach Reitz, Tae K. Kim, et al. 2022. <span>“Insitutype: Likelihood-Based Cell Typing for Single Cell Spatial Transcriptomics.”</span> <em>bioRxiv</em>. <a href="https://doi.org/10.1101/2022.10.19.512902">https://doi.org/10.1101/2022.10.19.512902</a>.
</div>
<div id="ref-emmanuel2024batch" class="csl-entry">
Emmanúel Antonsson, Sindri, and Páll Melsted. 2024. <span>“Batch Correction Methods Used in Single Cell RNA-Sequencing Analyses Are Often Poorly Calibrated.”</span> <em>bioRxiv</em>, 2024–03.
</div>
<div id="ref-umap" class="csl-entry">
Ghojogh, Benyamin, Ali Ghodsi, Fakhri Karray, and Mark Crowley. 2021. <span>“Uniform Manifold Approximation and Projection (UMAP) and Its Variants: Tutorial and Survey.”</span> <em>arXiv Preprint arXiv:2109.02508</em>.
</div>
<div id="ref-harmony" class="csl-entry">
Korsunsky, Ilya, Nghia Millard, Jean Fan, Kamil Slowikowski, Fan Zhang, Kevin Wei, Yuriy Baglaenko, Michael Brenner, Po-ru Loh, and Soumya Raychaudhuri. 2019. <span>“Fast, Sensitive and Accurate Integration of Single-Cell Data with Harmony.”</span> <em>Nature Methods</em> 16 (12): 1289–96.
</div>
<div id="ref-luecken2019current" class="csl-entry">
Luecken, Malte D, and Fabian J Theis. 2019. <span>“Current Best Practices in Single-Cell RNA-Seq Analysis: A Tutorial.”</span> <em>Molecular Systems Biology</em> 15 (6): e8746.
</div>
<div id="ref-leiden" class="csl-entry">
Traag, Vincent A, Ludo Waltman, and Nees Jan Van Eck. 2019. <span>“From Louvain to Leiden: Guaranteeing Well-Connected Communities.”</span> <em>Scientific Reports</em> 9 (1): 1–12.
</div>
<div id="ref-tran2020benchmark" class="csl-entry">
Tran, Hoa Thi Nhu, Kok Siong Ang, Marion Chevrier, Xiaomeng Zhang, Nicole Yee Shin Lee, Michelle Goh, and Jinmiao Chen. 2020. <span>“A Benchmark of Batch-Effect Correction Methods for Single-Cell RNA Sequencing Data.”</span> <em>Genome Biology</em> 21: 1–32.
</div>
</div></section></div> ]]></description>
  <category>batch correction</category>
  <category>data integration</category>
  <category>CosMx 2.0</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/batchcorrection/</guid>
  <pubDate>Thu, 10 Jul 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/batchcorrection/figures/thumbnail.png" medium="image" type="image/png" height="72" width="144"/>
</item>
<item>
  <title>Guide to comparing data from different CosMx® panels</title>
  <dc:creator>Patrick Danaher</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/panel-comparison/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Choosing the right panel for a spatial transcriptomics study is not always a trivial exercise. Higher-plex panels have the obvious appeal of more data per cell and a view into a greater scope of biology, while lower-plex panels are lower-cost and faster to run. To help choose a panel, investigators often run the same tissue through multiple panels. Here we recommend analyses for these datasets.</p>
<p>There are a <em>lot</em> of ways to compare two datasets, and a lot of energy is spent comparing metrics like plex, counts per cell, counts per gene per cell, background levels, segmentation accuracy, etc… (Perhaps even more energy is spent arguing about which of these metrics are most important.) What actually matters, of course, isn’t any single metric: it’s the <em>richness of biological insight</em> you are able to extract from a dataset. While data quality is important, its importance lies entirely in how it impacts your ability to extract biological conclusions from your data. To get at the rather broad concept of “biological richness”, we suggest two standard analyses:</p>
<ol type="1">
<li>How deep and clean are the cell typing results?</li>
<li>How much do you learn from a differential expression analysis?</li>
</ol>
<p>We suggest these comparisons because they capture the two key phases of most analyses. You begin with cell typing, characterizing the basic layout of your tissue. Then, perhaps after exploratory analyses, you ask a specific biological question. Very often, this question takes the form of a differential expression analysis. For example, “How do tumor cells respond when proximal to T-cells?”, “How do microglia react to amyloid beta plaques?”, or “How do intratumoral macrophages differ in responders vs.&nbsp;non-responders?” Thus by performing a relevant differential expression analysis, we can get a sense of the richness of results produced by two panels.</p>
<p>To demonstrate this approach, compare CosMx Human 6k Discovery Panel results and CosMx Human Whole Transcriptome Panel results collected from serial sections from a colorectal tumor. Use the code below as a template for running similar comparisons in your own data (after QC, normalization, etc…).</p>
</section>
<section id="cell-typing" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Cell typing</h1>
<section id="gaining-a-gestalt-of-cell-type-resolution" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="gaining-a-gestalt-of-cell-type-resolution"><span class="header-section-number">2.1</span> Gaining a gestalt of cell type resolution</h2>
<p>First, we’ll ask a simple, high-level question: how many cell types can be detected, and how well-resolved are they? Our goal here is not to carefully validate every cell type call; rather, we just want to get a sense of how rich and crisp the cell typing results are. Our usual expectation is that a given tissue has 10-20 highly distinct cell types, and that most panels are sufficient to resolve them.</p>
<p>(Beyond broad cell types, we may wish for more nuanced dissection of cell states. We will get at this ability with an analysis of T-cell subtyping accuracy, and with differential expression analysis, which characterizes changes within a cell type across space.)</p>
<p>To get at a general sense of the cell type granularity you can see with each panel, we’ll simply run unsupervised clustering and UMAP. Below is code to quickly perform these steps beginning with a Seurat object exported from AtoMx<sup>®</sup> SIP:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get hvgs, scale and run PCA:</span></span>
<span id="cb1-2">seu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">NormalizeData</span>(seu) </span>
<span id="cb1-3">seu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindVariableFeatures</span>(seu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">selection.method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"vst"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nfeatures =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span>)</span>
<span id="cb1-4">seu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ScaleData</span>(seu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VariableFeatures</span>(seu))</span>
<span id="cb1-5">seu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RunPCA</span>(seu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">features =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">VariableFeatures</span>(seu))</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># cluster:</span></span>
<span id="cb1-8">seu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FindClusters</span>(seu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resolution =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># umap:</span></span>
<span id="cb1-11">seu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RunUMAP</span>(seu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n.neighbors =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cosine"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min.dist =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">spread =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot umap and cell types:</span></span>
<span id="cb1-14">distinct_colors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb1-15">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#e6194b"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#3cb44b"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#ffe119"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#0082c8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#f58231"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#911eb4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#46f0f0"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#f032e6"</span>,</span>
<span id="cb1-16">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#d2f53c"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#fabebe"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#008080"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#e6beff"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#aa6e28"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#fffac8"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#800000"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#aaffc3"</span>,</span>
<span id="cb1-17">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#808000"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#ffd8b1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#000080"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#808080"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFFFFF"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#000000"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#a9a9a9"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#DC143C"</span>,</span>
<span id="cb1-18">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#00FFFF"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#7FFF00"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF7F50"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#6495ED"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#DC143C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#00CED1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFD700"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#ADFF2F"</span>,</span>
<span id="cb1-19">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#4B0082"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF69B4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#CD5C5C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#20B2AA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#9370DB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#3CB371"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF4500"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#DA70D6"</span>,</span>
<span id="cb1-20">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#7B68EE"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#00FA9A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#B22222"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#5F9EA0"</span></span>
<span id="cb1-21">)</span>
<span id="cb1-22"></span>
<span id="cb1-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DimPlot</span>(seu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(distinct_colors, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">NoLegend</span>()</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/panel-comparison/figures/umaps.png" class="img-fluid figure-img" width="614"></p>
</figure>
</div>
</div>
</div>
<p>While the UMAP plots appear quite different at first, we see on closer examination that the broad structure is similar in both cases, with the same islands and bridges and largely the same clustering results in both datasets. If we were inclined to do so, modifying the UMAP parameters could probably make either dataset more strongly resemble the other. So in this example, our check for cell type resolution comes in reassuringly as a tie.</p>
<p>For a more thorough evaluation of cell typing quality, consider the following additional analyses:</p>
<ul>
<li>Plot cell types in physical space and confirm biological sanity</li>
<li>Run a marker ID heatmap and confirm that markers for distinct cell types concentrate in different clusters.</li>
</ul>
</section>
<section id="evaluating-accuracy-of-fine-grained-cell-typing" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="evaluating-accuracy-of-fine-grained-cell-typing"><span class="header-section-number">2.2</span> Evaluating accuracy of fine-grained cell typing</h2>
<p>We also want to assess the quality of cell typing. For this comparison, we’ll focus on immune cells, which are convenient because there is widespread agreement about their marker genes and because they appear in most tissues. If your tissue in question has very few immune cells (say, &lt;2000), you may want to assess cell typing accuracy with other cell types.</p>
<p>For immune cell typing, we recommend our newly-released method <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/" target="_blank">HieraType</a>.</p>
<p>Use the below code to quickly identify and subtype immune cells, then produce a heatmap of marker genes. This code picks up where the previous left off. Specifically, it assumes we have a Seurat object, including UMAP results. See the HieraType package documentation for how to run outside the Seurat ecosystem.</p>
<p>Note: to prevent background counts from confusing the evaluation of marker heatmaps, we’ll subtract background from each cluster’s mean expression profile prior to plotting. A cluster’s mean negprobe counts gives us a fairly accurate estimate of the level of background in its marker genes counts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install HieraType:</span></span>
<span id="cb2-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) {</span>
<span id="cb2-3">  remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nanostring-Biostats/CosMx-Analysis-Scratch-Space"</span>, </span>
<span id="cb2-4">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subdir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_code/HieraType"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Main"</span>)</span>
<span id="cb2-5">}</span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load package:</span></span>
<span id="cb2-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(HieraType)</span>
<span id="cb2-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define a pipeline to automatically call broad cell types then proceed through fine T-cell subtypes:</span></span>
<span id="cb2-11">ct_pipeline <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_pipeline</span>(</span>
<span id="cb2-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">markerslists =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l1"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieroType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_l1,</span>
<span id="cb2-13">                      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieroType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_immunemajor,</span>
<span id="cb2-14">                      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieroType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_tcellmajor,</span>
<span id="cb2-15">                      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt4"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieroType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd4tminor,</span>
<span id="cb2-16">                      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt8"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieroType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd8tminor</span>
<span id="cb2-17">  ),</span>
<span id="cb2-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l1"</span>,</span>
<span id="cb2-19">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span>,</span>
<span id="cb2-20">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt4"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span>,</span>
<span id="cb2-21">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt8"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span></span>
<span id="cb2-22">  ),</span>
<span id="cb2-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors_category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"immune"</span>,</span>
<span id="cb2-24">                         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tcell"</span>,</span>
<span id="cb2-25">                         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt4"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4t"</span>,</span>
<span id="cb2-26">                         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt8"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8t"</span></span>
<span id="cb2-27">  )</span>
<span id="cb2-28">)</span>
<span id="cb2-29"></span>
<span id="cb2-30">htres <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  HieroType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_pipeline</span>(</span>
<span id="cb2-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pipeline =</span> ct_pipeline,</span>
<span id="cb2-32">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(seu[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts),</span>
<span id="cb2-33">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as</span>(seu<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>graphs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>umapgrph, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dgCMatrix"</span>)</span>
<span id="cb2-34">)</span>
<span id="cb2-35"></span>
<span id="cb2-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># primary result: the cell type calls and posterior probabilities:</span></span>
<span id="cb2-37">probdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> htres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l1</span>
<span id="cb2-38"></span>
<span id="cb2-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## prepare data for marker gene heatmap:</span></span>
<span id="cb2-40">fc_subclus_ctl_gran <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts =</span> seu[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts,</span>
<span id="cb2-41">                                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> htres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]],</span>
<span id="cb2-42">                                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_granular"</span></span>
<span id="cb2-43">)</span>
<span id="cb2-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subtract background from the mean per-cluster expression profiles:</span></span>
<span id="cb2-45"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(htres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_granular)) {</span>
<span id="cb2-46">  isthiscelltype <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> htres<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_granular <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> name</span>
<span id="cb2-47">  meannegthiscelltype <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(seu<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>assays<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>negprobes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>counts[, isthiscelltype])</span>
<span id="cb2-48">  </span>
<span id="cb2-49">  fc_subclus_ctl_gran<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cluster_expr[fc_subclus_ctl_gran<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cluster <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> name] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb2-50">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(fc_subclus_ctl_gran<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cluster_expr[fc_subclus_ctl_gran<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cluster <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> name] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> meannegthiscelltype, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-51">}</span>
<span id="cb2-52"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create the heatmap:</span></span>
<span id="cb2-53">hm_unsup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_heatmap</span>(fc_subclus_ctl_gran,</span>
<span id="cb2-54">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extras =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FOXP3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8A"</span>)</span>
<span id="cb2-55">)</span>
<span id="cb2-56"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(hm_unsup)</span></code></pre></div>
</div>
<p>The marker heatmaps from both datasets are below, first 6k, then WTX:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/panel-comparison/figures/marker_heatmap_sixk.png" class="img-fluid figure-img" width="1950"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/panel-comparison/figures/marker_heatmap_wtx.png" class="img-fluid figure-img" width="1950"></p>
</figure>
</div>
</div>
</div>
<p>For most purposes, we won’t care about small differences between these heatmaps; rather, we just want to check that both sets of cell typing results are sane at an equivalently granular level. Comparing the marker gene heatmaps from both datasets, we see basic sanity in both cases, and cleaner marker profiles in the WTX data, suggesting either more accurate cell typing or better cell segmentation.</p>
<p>We’ll also want to look at our cell type calls in space as a final sanity check.</p>
</section>
</section>
<section id="differential-expression-analysis" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Differential expression analysis</h1>
<p>Spatial analyses often culminate in a differential expression analysis investigating how a cell type changes based on its spatial context. Below we give an easily-modifiable framework for such an analysis. The below code is designed to be simple and quick. For optimal DE analyses, see the R package smiDE, described <a href="https://www.biorxiv.org/content/10.1101/2024.08.02.606405v2.abstract" target="_blank">here</a>.</p>
<p>In our example, we’ll look at how macrophages vary based on proximity to vasculature, which we detect as endothelial cells.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example DE question: </span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># How does cell type 1 change in response to neighboring cells of cell type 2?</span></span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># designate which cells are cell type 1 and 2:</span></span>
<span id="cb3-5">is1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> probdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_granular <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"macrophage"</span></span>
<span id="cb3-6">is2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> probdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>celltype_granular <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endothelial"</span></span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Special case: for a cell type where we care about structures, e.g. blood vessels</span></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># or epithelial walls, we can discard lonely cells to focus on distance to structures. </span></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The below function winnows down a set of cells to only those belonging to decent-sized</span></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># groups in space. </span></span>
<span id="cb3-12">inastructure <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(xy, inds, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minPts =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) {</span>
<span id="cb3-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' xy: matrix of xy positions</span></span>
<span id="cb3-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' inds: logical vector saying which elements of xy are the cell type in question</span></span>
<span id="cb3-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' eps: radius argument in dbscan</span></span>
<span id="cb3-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' minPts: minimum cluster size to keep</span></span>
<span id="cb3-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#' returns a logical vector like inds, but reporting membership in spatial clusters of size &gt;= minPts</span></span>
<span id="cb3-18">  </span>
<span id="cb3-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># run dbscan clustering of positions:</span></span>
<span id="cb3-20">  db <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dbscan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dbscan</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> xy[inds, ], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> eps, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minPts =</span> minPts)</span>
<span id="cb3-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># report all positions that are part of a cluster:</span></span>
<span id="cb3-22">  keep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> inds</span>
<span id="cb3-23">  keep[inds][db<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cluster <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb3-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(keep)</span>
<span id="cb3-25">}</span>
<span id="cb3-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only keep cell type 2 cells that fall in a structure of at least 5 cells:</span></span>
<span id="cb3-27">is2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inastructure</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xy =</span> xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inds =</span> is2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minPts =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb3-28"></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot their layouts:</span></span>
<span id="cb3-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> is1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> is2],</span>
<span id="cb3-31">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (is1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> is2), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/panel-comparison/figures/example layout.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
<p>We see macrophages spread throughout the tissue, and endothelial cells at the border of the colon epithelium.</p>
<p>There are a number of ways to quantify proximity to a cell type. We can:</p>
<ul>
<li>Count how many of the cell type falls in each cell’s neighborhood</li>
<li>Measure each cell’s distance to the nearest member of the cell type</li>
<li>Treat the above variables as continuous, dichotomize them into high/low, or break them into discrete bins.</li>
</ul>
<p>All the above approaches are valid. Below we’ll demonstrate calculation of all approaches, then run DE using continuous number of endothelial neighbors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get distance to nearest cell of cell type 2:</span></span>
<span id="cb4-2">neighbors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> FNN<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get.knnx</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> xy[is2, ], </span>
<span id="cb4-3">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">query =</span> xy, </span>
<span id="cb4-4">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># record various metrics of proximity:</span></span>
<span id="cb4-6">proxdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb4-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dist_to_celltype =</span> neighbors<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.dist[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb4-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">neighbor_count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(neighbors<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nn.dist <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>)</span>
<span id="cb4-9">)</span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># log-transformed distance:</span></span>
<span id="cb4-11">proxdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>log2_dist <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> proxdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dist_to_celltype)</span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># example of binned distance:</span></span>
<span id="cb4-13">proxdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>distance_bin <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(proxdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dist_to_celltype, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>))</span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># example of dichotomous distance:</span></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># examine the distances:</span></span>
<span id="cb4-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> proxdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dist_to_celltype[is1]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use to choose a breakpoint</span></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bin the distances:</span></span>
<span id="cb4-18">proxdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>is_close <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> disttocelltype2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb4-19"></span>
<span id="cb4-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># selected variable for DE analysis:</span></span>
<span id="cb4-21">varforDE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> proxdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>neighbor_count</span></code></pre></div>
</div>
<p>One more step remains before running DE: we need to choose which genes to analyze for our cell type. The intuition here is that if a gene is 1. barely expressed in your cell type, and 2. highly expressed in neighbors of that cell type, then a large share of that gene’s counts in your cell type will be misassignments from neighboring cells. Such a gene will be prone to bias in DE analyses, and should often be excluded from analyses of your cell type. See <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/segmentation-error/" target="_blank">our post on segmentation error in DE</a> for why segmentation error must be considered in DE analyses, see the smiDE paper linked earlier for countermeasures we recommend, and see <a href="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/cell-typing-strategies/cell-typing-strategies.html" target="_blank">this post on advanced cell typing strategies</a> for other relevant tools.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># identify genes with minimal bias from segmentation errors in this cell type</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (see https://www.biorxiv.org/content/10.1101/2024.08.02.606405v2.abstract for details)</span></span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">url</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/refs/heads/Main/_code/cell-typing-advanced-strategies/getSubtypingGenes.R"</span>))</span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get genes safe from contamination:</span></span>
<span id="cb5-5">contamfilter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">findSafeGenes</span>(</span>
<span id="cb5-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(seu[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note we're entering info for all cells           </span></span>
<span id="cb5-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xy =</span> xy,                            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># again entering info for all cells</span></span>
<span id="cb5-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ismycelltype =</span> is1,                 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># logical indicating the cell type to be run in DE</span></span>
<span id="cb5-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tissue =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,                      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># specify if tissues have xy overlap</span></span>
<span id="cb5-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">self_vs_neighbor_threshold =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># min ratio of expression in the cell type vs. in its neighbors</span></span>
<span id="cb5-11">)</span>
<span id="cb5-12">safegenes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> contamfilter<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>safegenes</span></code></pre></div>
</div>
<p>This final vector “safegenes” is our effective plex for analyzing our chosen cell type, the genes useful for analysis within that cell type. Comparing this across panels can also be informative.</p>
<p>Now we’ll run a DE analysis using simple linear models. For proper DE analyses, we recommend using the full smiDE toolkit. The below code is adequate for the purposes of comparing panels, and it runs very quickly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normalized counts:</span></span>
<span id="cb6-2">scaling_factors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(seu[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts) </span>
<span id="cb6-3">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Diagonal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> scaling_factors[is1]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(seu[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[, is1]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(scaling_factors)</span>
<span id="cb6-4">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y)</span>
<span id="cb6-5">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[, safegenes]</span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># design matrix:</span></span>
<span id="cb6-8">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">distvar =</span> varforDE[is1])</span>
<span id="cb6-9"></span>
<span id="cb6-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## run DE:</span></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract predictor and response</span></span>
<span id="cb6-12">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb6-13">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(x)</span>
<span id="cb6-14"></span>
<span id="cb6-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Center x for numerical stability</span></span>
<span id="cb6-16">x_centered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(x)</span>
<span id="cb6-17"></span>
<span id="cb6-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Design matrix: intercept and centered predictor</span></span>
<span id="cb6-19">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, x_centered)</span>
<span id="cb6-20">XtX_inv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> X)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (X'X)^-1 for SEs</span></span>
<span id="cb6-21"></span>
<span id="cb6-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit model: β = (X'X)^-1 X'Y</span></span>
<span id="cb6-23">betas <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> XtX_inv <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> y  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2 x G matrix: row 1 = intercepts, row 2 = slopes</span></span>
<span id="cb6-24"></span>
<span id="cb6-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Residuals</span></span>
<span id="cb6-26">fitted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> betas</span>
<span id="cb6-27">resid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> fitted</span>
<span id="cb6-28"></span>
<span id="cb6-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Residual variance per gene</span></span>
<span id="cb6-30">sigma2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(resid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb6-31"></span>
<span id="cb6-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Standard error of slope estimates</span></span>
<span id="cb6-33">se_beta1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(sigma2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> XtX_inv[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># scalar * vector</span></span>
<span id="cb6-34"></span>
<span id="cb6-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># T-statistics for slope (row 2 of beta matrix)</span></span>
<span id="cb6-36">t_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> betas[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, ] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> se_beta1</span>
<span id="cb6-37"></span>
<span id="cb6-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Two-sided p-values</span></span>
<span id="cb6-39">pvals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pt</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(t_stats), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb6-40"></span>
<span id="cb6-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output</span></span>
<span id="cb6-42">results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb6-43">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slope =</span> betas[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, ],</span>
<span id="cb6-44">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pval =</span> pvals</span>
<span id="cb6-45">)</span>
<span id="cb6-46">results<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>padj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">p.adjust</span>(results<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pval)</span></code></pre></div>
</div>
<p>A simple volcano plot suffices to convey the richness of the DE results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(betas[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, ], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log10</span>(pvals), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>), </span>
<span id="cb7-2">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>),</span>
<span id="cb7-3">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Log2 fold-change per additional neighbor of cell type 2"</span>,</span>
<span id="cb7-4">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-log10(p-value)"</span>,</span>
<span id="cb7-5">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex.lab =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.25</span>)</span>
<span id="cb7-6">showgenes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(results)[results<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>padj <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>]</span>
<span id="cb7-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">h =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log10</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(results<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pval[results<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>padj <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>])), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>)</span>
<span id="cb7-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">h =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log10</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(results<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pval[results<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>padj <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>])), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>)</span>
<span id="cb7-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottomright"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb7-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adjusted p = "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" ("</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(results<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>padj <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(results<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>padj <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" genes)"</span>))</span>
<span id="cb7-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(results[showgenes, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"slope"</span>],</span>
<span id="cb7-12">     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log10</span>(results[showgenes, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pval"</span>]), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>), </span>
<span id="cb7-13">     showgenes,</span>
<span id="cb7-14">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>)</span></code></pre></div>
</div>
<p>The resulting volcano plots are below (note the different y-axis scales):</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/panel-comparison/figures/volcano plots.png" class="img-fluid figure-img" width="608"></p>
</figure>
</div>
</div>
</div>
<p>We find that the WTX panel has more than double the significant (adjusted p-value &lt; 0.05) genes. Reassuringly, shared genes tend to be significant in the same direction in both datasets. From this figure, we would conclude (unsurprisingly) that the larger panel yields a richer set of results from the same differential expression analysis.</p>


</section>

 ]]></description>
  <category>quality control</category>
  <category>differential expression</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/panel-comparison/</guid>
  <pubDate>Mon, 23 Jun 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/panel-comparison/figures/thumbnail.png" medium="image" type="image/png" height="139" width="144"/>
</item>
<item>
  <title>Using marker gene driven metagene scores for granular hierarchical cell typing.</title>
  <dc:creator>Dan McGuire</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/</link>
  <description><![CDATA[ 





<section id="abstract" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Abstract</h1>
<p>This post showcases a hierarchical cell typing method (HieraType) optimized for detection and sub-clustering of immune cells. HieraType:</p>
<ul>
<li>Is organized around canonical marker genes, but harnesses cells’ complete expression profiles.</li>
<li>Can be adapted to any arbitrary cell type hierarchy.</li>
</ul>
<p>Code for the method and utility functions used in this post can be found in the R package <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/HieraType">HieraType</a>. The package contains carefully designed pipelines for:</p>
<ul>
<li>Subclassifying T-cells into 12 categories</li>
<li>Classifying a whole dataset into broad categories (epithelial, fibroblast, immune, endothelial), then subclassifying immune cells into 9 categories</li>
<li>Classifying native brain cells</li>
</ul>
<p>It is also possible to assemble pipelines for custom applications, e.g.&nbsp;focused on a specific tissue type.</p>
<p>In this post, we use a 6K-plex colon-cancer dataset to demonstrate two common use cases for the method:</p>
<ol type="1">
<li>Subtyping T cells</li>
<li>Broad immune cell typing.</li>
</ol>
</section>
<section id="quick-links-to-the-code" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Quick links to the code</h1>
<p>For those in a hurry to ‘just see the code’, they can jump ahead to the “Just The Code” sections for Example 1, or Example 2.</p>
</section>
<section id="introduction" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Introduction</h1>
<p>Often (particularly with immune cells), we may want our cell type calls to be guided by specific sets of marker genes.<br>
In some spatially-resolved transcriptomics (SRT) datasets, directly using marker gene expression for determining cell type may be a challenge due to data sparsity, background, or segmentation ambiguity. These challenges together can make marker genes noisy individual data points.</p>
<p>However, marker genes remain a strong organizing principle for differentiating cell types. To overcome the intrinsic noise of single marker genes, the cell typing method we describe here captures information from both (a) similar cells and (b) biologically relevant genes, in order to construct metagenes that more stably estimate true marker expression. These marker metagene scores are then used for probabilistic cell type assignment. The method takes as input predefined ‘marker lists’ for each cell type, which make it easy to enforce prior biological assumptions about the marker genes and expression profiles we expect to see in our cell types. By not requiring any training data or an explicit reference profile, we expect the method to be robust to platform or batch effects that may otherwise challenge cell type labeling from pre-trained models or external reference data.</p>
<p>The basic framework for the method can be described in a few basic steps (we’ll describe each of these steps in more detail throughout our examples.)</p>
<ol type="1">
<li>First, for each cell type, we define a set of genes we expect may be ‘marker genes’ or highly expressed based on prior data or biology (either the literature, a reference dataset, or some combination of both).</li>
<li>Next, we construct metagene scores from our data for each cell type based on the genes specified in (1).</li>
<li>Finally, we model the metagene scores, where the model estimates a posterior probability that each cell belongs to any of the possible cell types.</li>
</ol>
<p>We’ll use an internally generated colon cancer dataset profiled with the CosMx Human 6K Discovery Panel comprised of about 112k cells, and work through two common cell typing scenarios in which we envision this methodology can be useful:</p>
<ol type="1">
<li>Subclustering an existing set of cell types:</li>
</ol>
<ul>
<li>In this first case, we’ll assume we’ve already done some basic clustering, but don’t quite have the level of cell type granularity we’d like. We’ll take a ‘T cell’ cluster and sub-classify those cells into CD8-T and CD4-T, followed by more granular T cell subcategories.</li>
</ul>
<ol start="2" type="1">
<li>Top down hierarchical cell typing with focus on immune cells:</li>
</ol>
<ul>
<li>Here we’ll start from scratch; first assigning cells into major categories and identifying immune cells, then classifying those immune cells into various sub classifications of myeloid and lymphocyte cell types.</li>
</ul>
</section>
<section id="initial-look-at-our-dataset" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Initial look at our dataset</h1>
<p>Let’s start by taking an initial look at our data, then walk through some cell typing scenarios. First, we can load in our data and take a look at some unsupervised leiden clustering we’ve already performed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggrepel)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(HieraType)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Note, using a v3-style Seurat Object below, i.e., `sem[["RNA"]]@counts`</span></span>
<span id="cb2-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## For v5-style, the syntax would be like `sem[["RNA"]]$counts`</span></span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Seurat.object.assay.version =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v3"</span>)  </span>
<span id="cb2-4"></span>
<span id="cb2-5">sem <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"colon_seurat.rds"</span>)</span>
<span id="cb2-6">normed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">totalcount_norm</span>(Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts))</span>
<span id="cb2-7">sem <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Seurat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SetAssayData</span>(sem, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">layer =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new.data =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(normed))</span></code></pre></div>
</div>
<p><strong>Spatial plot of initial clusters</strong></p>
<p>Here’s a spatial plot of our leiden clusters. At first glance, we see that some of these unsupervised clusters (i.e., 3, 0, 1, 2, and 7 for example) have distinct spatial patterns; it definitely looks like some meaningful biological structure in these tissue were captured by unsupervised clustering.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>portion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"part_a"</span></span>
<span id="cb3-2">sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>portion[sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fov <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">73</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"part_b"</span></span>
<span id="cb3-3">xyplist <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"portion"</span>), <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(xx){</span>
<span id="cb3-5">  HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xyplot</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clusters_unsup"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> xx,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ptsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>()</span>
<span id="cb3-6">})</span>
<span id="cb3-7">xypl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb3-8">cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_grid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plotlist=</span>xyplist, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-10">  cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">remove=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span>
<span id="cb3-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(xypl)</span></code></pre></div>
</details>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/xyp_unsup.png" alt="Wide Image"></p>
</div>
<p><strong>Heatmap of initial clusters </strong></p>
<p>We can make a marker gene heatmap to identify some of the top marker genes for each cluster and see if we recognize any of the celltypes represented by the unsupervised clusters. Here we can use a couple of convenience functions provided in the R package <code>HieraType</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## calculate fold change, average expression, and other summary metrics </span></span>
<span id="cb4-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## for each gene and each cluster compared to other clusters</span></span>
<span id="cb4-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## This is the data underlying the marker heatmap.</span></span>
<span id="cb4-4">fctbl_unsup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb4-5">HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normed  =</span> sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>data</span>
<span id="cb4-6">                                          ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data</span>
<span id="cb4-7">                                          ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"clusters_unsup"</span></span>
<span id="cb4-8">                                          )</span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## make a marker heatmap</span></span>
<span id="cb4-11">hm_unsup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_heatmap</span>(fctbl_unsup</span>
<span id="cb4-12">                           ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extras =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FOXP3"</span></span>
<span id="cb4-13">                                       , <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8A"</span>)</span>
<span id="cb4-14">                           )</span>
<span id="cb4-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(hm_unsup)</span></code></pre></div>
</details>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/hm_unsup_annotated.PNG" alt="Wide Image"></p>
</div>
<p>Let’s suppose for sake of demonstration that I recognize (and am comfortable enough) to label these clusters with cell type names based on the marker genes shown in the heatmap.</p>
<p>However, there are one or a few of my immune clusters I’ve identified where I desire more granularity. In this case, I’m particularly interested in my T cells; in the bottom-left hand corner of the heatmap plot above, I see that ‘cluster 6’ is capturing T-cells, showing enrichment in some key marker genes like CD3 (CD3D, CD3E) as well as other markers like CD2, IL7R, and ITK.</p>
<p>I’d like to split these cells further into at least a few meaningful T-cell subtypes, at minimum: “CD8+”, “CD4+”, and “Treg”.</p>
</section>
<section id="ex1" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Example case 1: Subclustering T cells</h1>
<section id="tldr" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="tldr"><span class="header-section-number">5.1</span> ‘Just The Code’</h2>
<p>Here’s the code for classifying leiden cluster ‘6’ into <code>cd8t</code> and <code>cd4t</code> cell types , followed by more granular T cell subtyping. We use the R package <code>HieraType</code> with a prespecified <code>tcell_pipeline</code>, and corresponding lists of marker genes included as package datasets. A <code>pipeline</code> specifies the hierarchical order we want to do our cell typing, and which cell types go in each level of the hierarchy. Each cell type has a list of associated marker genes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pipeline_tcell"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(pipeline_tcell, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.level =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ markerslists   :List of 3
  ..$ tmajor :List of 2
  .. ..- attr(*, "class")= chr [1:2] "list" "markerslist"
  ..$ t4minor:List of 7
  .. ..- attr(*, "class")= chr [1:2] "list" "markerslist"
  ..$ t8minor:List of 5
  .. ..- attr(*, "class")= chr [1:2] "list" "markerslist"
 $ priors         :List of 2
  ..$ t4minor: chr "tmajor"
  ..$ t8minor: chr "tmajor"
 $ priors_category:List of 2
  ..$ t4minor: chr "cd4t"
  ..$ t8minor: chr "cd8t"
 - attr(*, "class")= chr [1:2] "list" "pipeline"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(pipeline_tcell<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>markerslists<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmajor)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cd8t" "cd4t"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(pipeline_tcell<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>markerslists<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t4minor)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cd4_naive" "cd4_tem"   "cd4_tcm"   "cd4_th1"   "cd4_th2"   "cd4_th17" 
[7] "cd4_treg" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(pipeline_tcell<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>markerslists<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t8minor)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cd8_naive"     "cd8_tem"       "cd8_tcm"       "cd8_cytotoxic"
[5] "cd8_exhausted"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### these are cells I want to subcluster</span></span>
<span id="cb14-2">tcell_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data[sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clusters_unsup<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span>]</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Run a 'tcell'-typing pipeline, which </span></span>
<span id="cb14-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### first classifies into T8/T4 categories (using the `tmajor` markerslist), </span></span>
<span id="cb14-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### then runs subclassification for T4 and T8 using the t4minor and t8minor markerslists.</span></span>
<span id="cb14-7">tcell_typing <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb14-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_pipeline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pipeline =</span> pipeline_tcell</span>
<span id="cb14-9">             ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[,tcell_ids])</span>
<span id="cb14-10">             ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as</span>(sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>graphs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>umapgrph</span>
<span id="cb14-11">                                    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CsparseMatrix"</span>)[tcell_ids,tcell_ids]</span>
<span id="cb14-12">             ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">celltype_call_threshold =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb14-13">             )</span></code></pre></div>
</div>
<p>The data table <code>post_probs</code> in our <code>tcell_typing</code> object holds the high-level cell typing results; the <code>celltype_thresh</code> column shows the <em>most granular</em> cell type call where posterior probability is <img src="https://latex.codecogs.com/png.latex?%3E%200.5"> (our <code>celltype_call_threshold</code>). We can see the posterior probablity for the <code>celltype_thresh</code> category in <code>best_score_thresh</code>.<br>
The best granular cell type call (regardless of score) is given by the <code>celltype_granular</code> column, with <code>best_score_granular</code> indicating the corresponding posterior probability.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(tcell_typing, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.level =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ post_probs     :List of 1
  ..$ tmajor:Classes 'data.table' and 'data.frame': 7356 obs. of  5 variables:
  .. ..- attr(*, ".internal.selfref")=&lt;externalptr&gt; 
  .. ..- attr(*, "sorted")= chr "cell_ID"
 $ models         :List of 3
  ..$ tmajor :List of 3
  ..$ t4minor:List of 3
  ..$ t8minor:List of 3
 $ metagene_scores:List of 3
  ..$ tmajor :List of 2
  ..$ t4minor:List of 7
  ..$ t8minor:List of 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">tcell_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmajor[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>][]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;cell_ID&gt;
        cell_ID celltype_thresh celltype_granular best_score_granular
         &lt;char&gt;          &lt;char&gt;            &lt;char&gt;               &lt;num&gt;
 1: c_1_12_1014            cd8t     cd8_exhausted           0.4691963
 2: c_1_12_1066            cd4t           cd4_th1           0.3352265
 3: c_1_12_1091         cd4_th2           cd4_th2           0.9683195
 4: c_1_12_1175   cd8_cytotoxic     cd8_cytotoxic           0.8777777
 5: c_1_12_1270         cd8_tem           cd8_tem           0.5882417
 6: c_1_12_1286        cd4_treg          cd4_treg           0.9909980
 7: c_1_12_1325            cd4t           cd4_tcm           0.4647576
 8: c_1_12_1346        cd4_treg          cd4_treg           0.8298557
 9: c_1_12_1349            cd8t           cd8_tem           0.3939835
10: c_1_12_1394   cd8_cytotoxic     cd8_cytotoxic           0.9587283
    best_score_thresh
                &lt;num&gt;
 1:         0.9999999
 2:         0.6751557
 3:         0.9683195
 4:         0.8777777
 5:         0.5882417
 6:         0.9909980
 7:         0.9984388
 8:         0.8298557
 9:         0.9999814
10:         0.9587283</code></pre>
</div>
</div>
<p>Now lets take a closer look at the details and describe the methodology for each step.</p>
</section>
<section id="detailed-walkthrough" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="detailed-walkthrough"><span class="header-section-number">5.2</span> Detailed walkthrough</h2>
<section id="part-1-specifying-genes-associated-with-my-cell-types-based-on-prior-biology" class="level3" data-number="5.2.1">
<h3 data-number="5.2.1" class="anchored" data-anchor-id="part-1-specifying-genes-associated-with-my-cell-types-based-on-prior-biology"><span class="header-section-number">5.2.1</span> Part 1: Specifying genes associated with my cell types based on prior biology</h3>
<p>We’ll describe the first level of cell type classification from our example above to illustrate the method, where we suppose we want to classify <code>cd4t</code> vs.&nbsp;<code>cd8t</code>. Creating a marker list, by specifying genes I expect <strong>might</strong> be associated with my cell types is the first step of this algorithm. For each of my cell types, <code>cd4t</code> and <code>cd8t</code>, I specify</p>
<ul>
<li>a set of primary defining markers or “index genes” (these are genes that should be fairly exclusive to the cell type if possible)</li>
<li>a set of other marker genes which I expect could be expressed as “predictors”</li>
</ul>
<p>In this case, we’ll use [CD4], and [CD8A, CD8B], as “index genes” for <code>cd4t</code> and <code>cd8t</code> respectively. The other genes we’ll specify as predictors are based on the literature. For example, FOXP3 is often associated with cd4t ‘Treg’ cells, so we include it as a predictor here for <code>cd4t</code>. In general, it’s okay to include a gene as a “predictor” even if we only expect to see it in a subset of cells (like FOXP3 in this example, which we expect to be present in a ‘Treg’ subtype, but not all <code>cd4t</code> cells).</p>
<p>It’s okay to include markers in multiple cell types if that fits our mental model. For example, CD3D, CD3E, and CD3G are general T cell markers, and so are included as predictors for both subtypes, as are other genes like IL7R, CD27, SELL which could be seen in either <code>cd4t</code> or <code>cd8t</code> cells. When manually creating a marker list, consider “more predictors is better” as a general rule of thumb; a larger number of predictor genes can help build more accurate metagene models for celltype index markers.</p>
<p>We can create our marker list manually like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">markerslist_tcellmajor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb19-2">HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_markerslist</span>(</span>
<span id="cb19-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">index_marker =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb19-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8t"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8A"</span>)</span>
<span id="cb19-5">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4t"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD4"</span>)</span>
<span id="cb19-6">  )</span>
<span id="cb19-7">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">predictors =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb19-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8t"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3E"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3G"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL7R"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD27"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELL"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCR7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TCF7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LEF1"</span>, </span>
<span id="cb19-9">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FOXP1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BACH2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KLF2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD28"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ICOS"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"STAT3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"STAT5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RUNX3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BATF"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EOMES"</span>, </span>
<span id="cb19-10">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TBX21"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PRDM1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PDCD1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAG3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TIGIT"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HAVCR2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GZMK"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GZMA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GZMB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PRF1"</span>, </span>
<span id="cb19-11">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GNLY"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KLRG1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KLRD1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IFNG"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCL5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CX3CR1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NKG7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FAS"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FASLG"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD244"</span>, </span>
<span id="cb19-12">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CXCR3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KLRB1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TOX"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NR4A2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BCL6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CXCL13"</span>)</span>
<span id="cb19-13">    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4t"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3E"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3G"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL7R"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD27"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELL"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCR7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TCF7"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LEF1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FOXP1"</span>, </span>
<span id="cb19-14">                     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BACH2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KLF2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD28"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ICOS"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD40LG"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"STAT3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"STAT5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RUNX1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RUNX3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BATF"</span>, </span>
<span id="cb19-15">                     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GATA3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TBX21"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RORC"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FOXP3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL2RA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CTLA4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PDCD1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAG3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TIGIT"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HAVCR2"</span>, </span>
<span id="cb19-16">                     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IFNG"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL13"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL17A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL17F"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL10"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCL5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CXCR3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CCR6"</span>, </span>
<span id="cb19-17">                     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CXCR5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PRDM1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BCL6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"EOMES"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CXCL13"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TOX"</span>)</span>
<span id="cb19-18">  )</span>
<span id="cb19-19">)</span></code></pre></div>
</div>
<p>The object created looks like this below</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(markerslist_tcellmajor)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ cd8t:List of 3
  ..$ index_marker                               : chr [1:2] "CD8B" "CD8A"
  ..$ predictors                                 : chr [1:48] "CD3D" "CD3E" "CD3G" "CD8A" ...
  ..$ use_offclass_markers_as_negative_predictors: logi TRUE
 $ cd4t:List of 3
  ..$ index_marker                               : chr "CD4"
  ..$ predictors                                 : chr [1:48] "CD3D" "CD3E" "CD3G" "CD4" ...
  ..$ use_offclass_markers_as_negative_predictors: logi TRUE
 - attr(*, "class")= chr [1:2] "list" "markerslist"</code></pre>
</div>
</div>
<p>In practice, we can save and reuse our marker lists for different cell types. While it should be easy to create/modify a custom list from the literature, this particular list is included as a package dataset <code>markerslist_tcellmajor</code> to facilitate ease of use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"markerslist_tcellmajor"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(markerslist_tcellmajor)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ cd8t:List of 3
  ..$ index_marker                               : chr [1:2] "CD8B" "CD8A"
  ..$ predictors                                 : chr [1:48] "CD3D" "CD3E" "CD3G" "CD8A" ...
  ..$ use_offclass_markers_as_negative_predictors: logi TRUE
 $ cd4t:List of 3
  ..$ index_marker                               : chr "CD4"
  ..$ predictors                                 : chr [1:48] "CD3D" "CD3E" "CD3G" "CD4" ...
  ..$ use_offclass_markers_as_negative_predictors: logi TRUE
 - attr(*, "class")= chr [1:2] "list" "markerslist"</code></pre>
</div>
</div>
</section>
<section id="part-2-estimating-a-metagene-score-for-each-cell-type" class="level3" data-number="5.2.2">
<h3 data-number="5.2.2" class="anchored" data-anchor-id="part-2-estimating-a-metagene-score-for-each-cell-type"><span class="header-section-number">5.2.2</span> Part 2: Estimating a metagene score for each cell type</h3>
<p>Because single count values marker genes can be noisy, we seek to derive variables that more stably estimate marker expression. To do so, we’ll exploit biologically relevant genes (e.g.&nbsp;CD8A expression is predictive of CD8B expression), and cells with similar expression patterns. To do so, we fit a model for each cell type, using the primary index marker as the response variable and covariates derived from the predictor genes. The predicted values of the primary index marker for this model make a continuous “metagene score” that will later be used for probabilistic cell type assignment. You can think of each metagene score as estimating the canonical marker gene’s expression for a single cell type; e.g.&nbsp;we will produce a FOXP3-estimating metagene to capture Treg’s, a CD68-estimating metagene to capture macrophages, etc…</p>
<p>We fit our models for each cell type class using the <code>fit_metagene_scores</code> function. This function uses ‘smoothing’ (averaging over a set of similar cells), as well as our prior biology / assumptions about which markers are associated with each celltype to predict the pearson residuals of the index gene.</p>
<p>The default regression model setup looks like this: <img src="https://latex.codecogs.com/png.latex?Y%20=%20WY%5Ceta%20%20+%20WX%5Cbeta%20+%20X%5Cgamma%20+%20%5Cepsilon%20"> where</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?Y:="> pearson residuals of the index marker (our response variable)</li>
<li><img src="https://latex.codecogs.com/png.latex?X:="> (totalcount-normalized) matrix of predictor genes</li>
<li><img src="https://latex.codecogs.com/png.latex?W:="> a cells <img src="https://latex.codecogs.com/png.latex?%5Ctimes"> cells neighborhood matrix, denoting cells with similar expression profiles.</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Ceta">, <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, and <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> are the regression coefficients associated with the ‘neighbor-averaged’ index gene, ‘neighbor-averaged’ predictor genes, and predictor genes within the cell respectively.</li>
</ul>
<p>One way to think about this model specification could be as an implementation of a ‘smoothing model’, which leverages information across multiple dimensions:</p>
<ul>
<li>the index gene’s mean expression in similar cells (<img src="https://latex.codecogs.com/png.latex?WY">) (roughly, neighbors in UMAP space)</li>
<li>expression of other expected marker genes (<img src="https://latex.codecogs.com/png.latex?X">) (our predictor genes defined from biological knowledge)</li>
<li>expression of other expected marker genes in similar cells (<img src="https://latex.codecogs.com/png.latex?WX">)</li>
</ul>
<p>We use a non-negative least squares <span class="citation" data-cites="nnlsref">(Slawski and Hein 2013)</span> (NNLS) regression to estimate our models. The NNLS model enforces that all of the covariates based on predictor genes we specified must have positive regression coefficients (in practice we’ll observe that a number of regression coefficients may shrink to zero).</p>
<p>By specifying <code>use_offclass_markers_as_negative_predictors = TRUE</code> in the section above, we further assume that predictors for <em>other celltypes</em> that we haven’t listed can be used as <em>negative</em> predictors of our index gene. For example, genes like like “GZMA” and “GZMB”, which are markers associated with <code>cd8t</code>, will be assumed to be <em>negative</em> predictors of the other classes (<code>cd4t</code>) where they are not listed. This argument should in general be set to TRUE, as it’s useful to specify which genes we <em>don’t</em> expect to see in a celltype. If your markers list has extensive genes expected to be enriched in multiple cell types, and those genes are for some reason omitted from many of the other cell types, then a user might consider specifying this argument as FALSE; e.g.&nbsp;if many genes like CD3E are specified in markers lists for some T cell subtypes but not all (despite being ubiquitously expressed).</p>
<p>Estimating this model from the dataset at hand rather than using a reference model could make this framework more robust to platform effects or batch effects compared to pre-trained models or reference profiles which used different technology or data with slightly different biology.</p>
<p>Genes not included in the marker gene lists will not be considered in assigning cell types. Because the model is only using genes we’ve specified in our ‘markers list’, we have complete control over which genes influence the metadata scores, reducing the chance that noisy or irrelevant genes can have an impact on our cell type classifications. Furthermore, by estimating the metagenes directly from the dataset at hand, we are not reliant on reference datasets or pre-trained models influenced by different technology (example: scRNA-seq) or underlying biology (example: different tissue type or disease status, etc).</p>
<p>Here I call the <code>fit_metagene_scores</code> function to estimate these models for cells corresponding to the unsupervised cluster I’ve identified to be T cells.<br>
For the cells <img src="https://latex.codecogs.com/png.latex?%5Ctimes"> cells <code>adjacency_matrix</code>, I’ve used the nearest neighbor matrix in my Seurat object. This is the same graph that was used to generate my UMAP and my unsupervised leiden clusters. After fitting our regression models for each cell type, we’ll use the predicted scores as ‘metagenes’ that can be clustered in the next step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1">tcell_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data[sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>clusters_unsup<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span>]</span>
<span id="cb25-2">metagenes_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb25-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_metagene_scores</span>(</span>
<span id="cb25-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">markerslist =</span> markerslist_tcellmajor</span>
<span id="cb25-5">    ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[,tcell_ids])</span>
<span id="cb25-6">    ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as</span>(sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>graphs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>umapgrph</span>
<span id="cb25-7">                           ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CsparseMatrix"</span>)[tcell_ids,tcell_ids]</span>
<span id="cb25-8">  )</span></code></pre></div>
</div>
<p>The <code>metagenes_t</code> object we’ve created has an element for each celltype, including the regression coefficients (<code>bhat</code>), and predicted values we’ll use for clustering (<code>yhat</code>) for each index marker gene for cell type.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(metagenes_t,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.level =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ cd8t:List of 7
  ..$ CD8B   :List of 5
  ..$ CD8A   :List of 5
  ..$ yhat   : Named num [1:7356] 0.593 1.32 2.959 1.375 2.478 ...
  .. ..- attr(*, "names")= chr [1:7356] "c_1_12_1066" "c_1_12_1175" "c_1_12_1270" "c_1_12_1349" ...
  ..$ y      : Named num [1:7356] -0.208 -0.178 2.047 -0.207 -0.242 ...
  .. ..- attr(*, "names")= chr [1:7356] "c_1_12_1066" "c_1_12_1175" "c_1_12_1270" "c_1_12_1349" ...
  ..$ ypost  : Named num [1:7356] -0.1796 -0.0223 1.5179 -0.0269 0.1805 ...
  .. ..- attr(*, "names")= chr [1:7356] "c_1_12_1066" "c_1_12_1175" "c_1_12_1270" "c_1_12_1349" ...
  ..$ bhat   : num [1:125, 1:2] 0.1904 0.1342 0.1113 0.1057 0.0912 ...
  .. ..- attr(*, "dimnames")=List of 2
  ..$ nnpcfit:List of 7
  .. ..- attr(*, "class")= chr [1:2] "nsprcomp" "prcomp"
 $ cd4t:List of 6
  ..$ CD4    :List of 5
  ..$ yhat   : Named num [1:7356] 0.29 -1.426 -0.968 -0.692 -1.945 ...
  .. ..- attr(*, "names")= chr [1:7356] "c_1_12_1066" "c_1_12_1175" "c_1_12_1270" "c_1_12_1349" ...
  ..$ y      : Named num [1:7356] -0.271 -0.235 -0.418 -0.27 -0.312 ...
  .. ..- attr(*, "names")= chr [1:7356] "c_1_12_1066" "c_1_12_1175" "c_1_12_1270" "c_1_12_1349" ...
  ..$ ypost  : Named num [1:7356] -0.294 -0.366 -0.469 -0.321 -0.507 ...
  .. ..- attr(*, "names")= chr [1:7356] "c_1_12_1066" "c_1_12_1175" "c_1_12_1270" "c_1_12_1349" ...
  ..$ bhat   : num [1:125, 1] 0.3763 0.2525 0.1551 0.1283 0.0749 ...
  .. ..- attr(*, "dimnames")=List of 2
  ..$ nnpcfit:List of 7
  .. ..- attr(*, "class")= chr [1:2] "nsprcomp" "prcomp"</code></pre>
</div>
</div>
<p>For cell types using multiple ‘index marker genes’, like <code>cd8t</code> here (using CD8A and CD8B), metagene scores are combined together using non-negative sparse pca (implemented in the <code>nsprcomp</code> R package) <span class="citation" data-cites="nonnegpca">(Sigg and Buhmann 2008)</span>. This allows for summarizing an overall cell type metagene score, using a constrained non-negative combination of individual index-gene scores that explains maximal variation across individual index gene scores. Below, we see the PCA rotation representing the individual weights given to CD8A and CD8B metagene scores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">metagenes_t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cd8t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nnpcfit</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Standard deviations (1, .., p=1):
[1] 1.020128

Rotation (n x k) = (2 x 1):
           PC1
CD8B 0.6578375
CD8A 0.7531599</code></pre>
</div>
</div>
<p>We can get a better understanding of the metagene model outputs by looking at a few diagnostics plots. In the below, we plot the regression coefficients for each model, ordering them on the x-axis by their ranking. For each cell type, the positive <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cbeta%7D"> correspond to genes we specified as predictors, and negative <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cbeta%7D"> were predictors for either of the other two cell types.<br>
A lot of the covariates which have the largest magnitudes have “<em>lag.</em>” in their name indicating they correspond to a smoothed (or neighbor-averaged) covariate for that gene.</p>
<p>We also see that many genes end up with weights of 0. These genes failed to be predictive in the direction our biological priors expected.</p>
<p>For <code>cd4t</code>, we see that smoothed CD4 (indicated by ‘<em>lag.y.CD4</em>’ in the plot) is the strongest predictor of observed ‘CD4’. For <code>cd8t</code>, ‘<em>lag.y.CD8A</em>’ and ‘<em>lag.y.CD8B</em>’ (indicating smoothed CD8A and CD8B) are also among the strongest predictors, but not first in rank.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1">coefplots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metagene_coefficients_plot</span>(metagenes_t)</span>
<span id="cb30-2">coefplots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(coefplots, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x){x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>))</span>
<span id="cb30-3">  }) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## just make the text bigger and bold</span></span>
<span id="cb30-4">cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_grid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plotlist =</span> coefplots, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</details>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/coefplots_tcells.png" alt="Wide Image"></p>
</div>
<p>A pairsplot can show us how well the metagene scores we’ve created are distinct from each other. Ideally, if our cell type classes are mutually exclusive, we’d want to not see too many cells which are ‘positive’ for multiple cell types at the same time.</p>
<p>Here, we see that <code>cd4t</code> and <code>cd8t</code> metagene scores are negatively correlated with each other, which is good to see.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metagene_pairsplot</span>(metagenes_t, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yhat"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/yhatpairs_tcells.png" class="img-fluid figure-img" width="1918"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="part-3-assigning-cell-types-based-on-metagene-scores" class="level3" data-number="5.2.3">
<h3 data-number="5.2.3" class="anchored" data-anchor-id="part-3-assigning-cell-types-based-on-metagene-scores"><span class="header-section-number">5.2.3</span> Part 3: Assigning cell types based on metagene scores</h3>
<p>Now we use the metagene scores to classify cell types. To do so, we estimate the multivariate distribution of metagene scores that characterize each cell type. This allows us to compute the likelihoods for a cell belonging to any of these types, and infer a posterior probability of T-cell subtype for each cell. The <code>cluster_metagenes</code> function we run below estimates a mixture of overfitted multivariate gaussian mixture models <span class="citation" data-cites="aragam2020identifiability">(Aragam et al. 2020)</span> to estimate the distribution of metagene scores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">model_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb32-2">HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cluster_metagenes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metagenes =</span> metagenes_t)</span></code></pre></div>
</div>
<p>At a high level, the <code>cluster_metagenes()</code> function first identifies all cells with positive metagene scores for a particular cell type. We might loosely interpret these cells as ‘anchor cells’. The data may look like this for example, where here I have subset my original data to cells which have positive scores for my celltype <code>cd8t</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1">yh <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_scores_matrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metagenes =</span> metagenes_t, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yhat"</span>)</span>
<span id="cb33-2">yh[yh[,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8t"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,]</span></code></pre></div>
</div>
<p>Then, a mixture model is fit to these (2-dimensional) scores, by default using 6 components. The estimates corresponding to the individual mixture models for each cell type are found in the <code>models</code> list, with the means (<code>mu_hat</code>), covariance matrices (<code>sigma_hat</code>), and prior probability (<code>pihat</code>) corresponding to each mixture component.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(model_t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>models, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.level =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ cd8t:List of 6
  ..$ post_probs  :Classes 'data.table' and 'data.frame':   2528 obs. of  9 variables:
  .. ..- attr(*, ".internal.selfref")=&lt;externalptr&gt; 
  ..$ pihat       : Named num [1:6] 0.2785 0.103 0.0437 0.3024 0.0747 ...
  .. ..- attr(*, "names")= chr [1:6] "k1" "k2" "k3" "k4" ...
  ..$ llmat       : num [1:2528, 1:6] -2.97 -2.87 -2.95 -3.42 -2.43 ...
  .. ..- attr(*, "dimnames")=List of 2
  ..$ mu_hat      : num [1:6, 1:2] 2.136 0.136 2.966 1.196 0.645 ...
  .. ..- attr(*, "dimnames")=List of 2
  ..$ sigma_hat   :List of 6
  ..$ loglik_iters: num [1:262] -4920 -4891 -4883 -4879 -4876 ...
 $ cd4t:List of 6
  ..$ post_probs  :Classes 'data.table' and 'data.frame':   2623 obs. of  9 variables:
  .. ..- attr(*, ".internal.selfref")=&lt;externalptr&gt; 
  ..$ pihat       : Named num [1:6] 0.1544 0.1398 0.2798 0.0414 0.0677 ...
  .. ..- attr(*, "names")= chr [1:6] "k1" "k2" "k3" "k4" ...
  ..$ llmat       : num [1:2623, 1:6] -2.03 -56.28 -126.91 -3.61 -5.12 ...
  .. ..- attr(*, "dimnames")=List of 2
  ..$ mu_hat      : num [1:6, 1:2] -1.074 -0.779 -1.13 -1.796 -1.429 ...
  .. ..- attr(*, "dimnames")=List of 2
  ..$ sigma_hat   :List of 6
  ..$ loglik_iters: num [1:173] -5230 -5189 -5167 -5155 -5147 ...</code></pre>
</div>
</div>
<p>Typically we shouldn’t need to interact with this part of the output. After the mixture models for each cell type are fitted, we can score all cells, and get an overall posterior probability that a cell belongs to any of the two major classes using Bayes rule.</p>
<p>Let <img src="https://latex.codecogs.com/png.latex?y_c"> be the cell type category for cell <img src="https://latex.codecogs.com/png.latex?c">, <img src="https://latex.codecogs.com/png.latex?scores_c"> the corresponding metagene scores, and <img src="https://latex.codecogs.com/png.latex?t"> denoting a possible cell ‘type’ or category (for <img src="https://latex.codecogs.com/png.latex?t%20=%201,...,T">).</p>
<p>We compute the overall posterior probability that <img src="https://latex.codecogs.com/png.latex?y_c"> is a particular type <img src="https://latex.codecogs.com/png.latex?t">, as</p>
<p><img src="https://latex.codecogs.com/png.latex?P(y_c%20=%20t%20%7C%20scores_c)%20=%20%5Cfrac%7BP(scores_c%20%7C%20y_c%20=%20t)P(y_c%20=%20t)%7D%7B%5Csum_%7Bl=1%7D%5ET%20P(scores_c%20%7C%20y_c%20=%20l)P(y_c%20=%20l)%7D"></p>
<p>Using the individual mixture models for a particular cell type with <img src="https://latex.codecogs.com/png.latex?K"> mixture components, we have <img src="https://latex.codecogs.com/png.latex?P(scores_c%20%7C%20y_c%20=%20t)%20=%20%5Csum_%7Bj=1%7D%5EK%20P(scores_c%20%7C%20k=j,%20y_c%20=%20t)%20P(k=j%20%7C%20y_c%20=%20t)"></p>
<p>The prior probability for a particular cell type class <img src="https://latex.codecogs.com/png.latex?t"> can be estimated by counting the number of cells used to estimate the mixture model in each cell type, and computing a proportion amongst all possible cell type classes, i.e., <img src="https://latex.codecogs.com/png.latex?P(y_c%20=%20t)%20=%20%5Cfrac%7B%5Csum_%7Bc=1%7D%5EC%20I(scores_%7Bc,t%7D%20%3E%200)%7D%7B%5Csum_%7Bl=1%7D%5ET%20%5Csum_%7Bc=1%7D%5EC%20I(scores_%7Bc,l%7D%20%3E%200)%7D"> These probabilities are in the <code>post_probs</code> data.table object of the model. The “best class” column gives each cell’s best-fitting cell type.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">model_t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>][]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        cell_ID best_class best_score        cd8t         cd4t
         &lt;char&gt;     &lt;char&gt;      &lt;num&gt;       &lt;num&gt;        &lt;num&gt;
 1: c_1_12_1066       cd4t  0.6751557 0.324844253 6.751557e-01
 2: c_1_12_1175       cd8t  0.9999986 0.999998637 1.363123e-06
 3: c_1_12_1270       cd8t  0.9999989 0.999998939 1.060938e-06
 4: c_1_12_1349       cd8t  0.9999814 0.999981384 1.861648e-05
 5: c_1_12_1394       cd8t  1.0000000 0.999999986 1.438074e-08
 6:  c_1_12_172       cd4t  0.9979380 0.002061995 9.979380e-01
 7:  c_1_12_228       cd4t  0.9955272 0.004472831 9.955272e-01
 8:  c_1_12_246       cd4t  0.9933210 0.006679029 9.933210e-01
 9:  c_1_12_285       cd4t  0.9986854 0.001314640 9.986854e-01
10:  c_1_12_511       cd4t  0.9911673 0.008832705 9.911673e-01</code></pre>
</div>
</div>
</section>
<section id="granular-hierarchical-subtyping-and-using-a-pipeline" class="level3" data-number="5.2.4">
<h3 data-number="5.2.4" class="anchored" data-anchor-id="granular-hierarchical-subtyping-and-using-a-pipeline"><span class="header-section-number">5.2.4</span> Granular hierarchical subtyping and using a <code>pipeline</code></h3>
<p>These posterior-probability scores can be passed directly to subtyping models for <code>cd4t</code> and <code>cd8t</code>, via the <code>prior_level_weights</code> arguments. For example, if I wanted to go ahead and cluster the <code>cd4t</code> cells into subtypes, I could follow the same process, passing in the prior probability of the cell being <code>cd4t</code> as a weight.</p>
<p>In the example below, the probability of <code>cd4t</code> is used as a weight in the NNLS regression fitting (akin to weighted least squares) when constructing metagene scores. Cells with high probability of <code>cd4t</code> are emphasized, while cells with lower probability of <code>cd4t</code> have less influence on the regression coefficients used to generate metagene scores.</p>
<p>In the clustering stage, probability of <code>cd4t</code> is again used as a weight (or prior probability), that factors into the expectation step of the EM algorithm. Letting <code>s(t)</code> denote the <em>subtype</em> of <code>cd4t</code>, then we have the below, where <img src="https://latex.codecogs.com/png.latex?P(y_c%20=%20t)"> would be the probability of <code>cd4t</code> from the previous stage of modeling.</p>
<p>The final returned probability for each <code>cd4t</code> subtype is a <em>joint</em> probability of both being the subtype <img src="https://latex.codecogs.com/png.latex?s(t)"> and the major celltype <img src="https://latex.codecogs.com/png.latex?t">.</p>
<p><img src="https://latex.codecogs.com/png.latex?P(y_c%20=%20s(t)%20%5Ccap%20y_c%20=%20t%20%20%7C%20scores_c)%20=%20P(y_c%20=%20s(t)%20%7C%20scores_c,%20y_c%20=%20t)P(y_c%20=%20t)"></p>
<p>Below is an example of this syntax using the <code>cd4t</code> subtypes in the package dataset “<code>markerslist_cd4tminor</code>”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd4tminor, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.level=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>List of 7
 $ cd4_naive:List of 3
  ..$ index_marker                               : chr [1:4] "TCF7" "LEF1" "SELL" "CCR7"
  ..$ predictors                                 : chr [1:30] "CD3D" "CD3E" "CD3G" "CD4" ...
  ..$ use_offclass_markers_as_negative_predictors: logi TRUE
 $ cd4_tem  :List of 3
  ..$ index_marker                               : chr [1:4] "CD44" "CCR6" "CXCR3" "IL7R"
  ..$ predictors                                 : chr [1:35] "CD3D" "CD3E" "CD3G" "CD4" ...
  ..$ use_offclass_markers_as_negative_predictors: logi TRUE
 $ cd4_tcm  :List of 3
  ..$ index_marker                               : chr [1:3] "CCR7" "IL7R" "SELL"
  ..$ predictors                                 : chr [1:27] "CD3D" "CD3E" "CD3G" "CD4" ...
  ..$ use_offclass_markers_as_negative_predictors: logi TRUE
 $ cd4_th1  :List of 3
  ..$ index_marker                               : chr [1:4] "TBX21" "IFNG" "CXCR3" "STAT4"
  ..$ predictors                                 : chr [1:30] "CD3D" "CD3E" "CD3G" "CD4" ...
  ..$ use_offclass_markers_as_negative_predictors: logi TRUE
 $ cd4_th2  :List of 3
  ..$ index_marker                               : chr [1:5] "GATA3" "IL4" "IL5" "IL13" ...
  ..$ predictors                                 : chr [1:30] "CD3D" "CD3E" "CD3G" "CD4" ...
  ..$ use_offclass_markers_as_negative_predictors: logi TRUE
 $ cd4_th17 :List of 3
  ..$ index_marker                               : chr [1:4] "RORC" "IL17A" "IL17F" "IL23R"
  ..$ predictors                                 : chr [1:28] "CD3D" "CD3E" "CD3G" "CD4" ...
  ..$ use_offclass_markers_as_negative_predictors: logi TRUE
 $ cd4_treg :List of 3
  ..$ index_marker                               : chr [1:4] "FOXP3" "IL2RA" "CTLA4" "TNFRSF18"
  ..$ predictors                                 : chr [1:29] "CD3D" "CD3E" "CD3G" "CD4" ...
  ..$ use_offclass_markers_as_negative_predictors: logi TRUE
 - attr(*, "class")= chr [1:2] "list" "markerslist"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### Classify cd4t subtypes</span></span>
<span id="cb40-2">metagenes_t4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb40-3">  HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_metagene_scores</span>(</span>
<span id="cb40-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">markerslist =</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd4tminor</span>
<span id="cb40-5">    ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[,tcell_ids])</span>
<span id="cb40-6">    ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as</span>(sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>graphs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>umapgrph</span>
<span id="cb40-7">                           ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CsparseMatrix"</span>)[tcell_ids,tcell_ids]</span>
<span id="cb40-8">    ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior_level_weights =</span> model_t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cd4t <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## prior probability of cd4t</span></span>
<span id="cb40-9">  )</span>
<span id="cb40-10">model_t4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb40-11">HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cluster_metagenes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metagenes =</span> metagenes_t4, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior_prob_level =</span> model_t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cd4t)</span></code></pre></div>
</div>
<p>A convenient way to simplify this process with minimal code is to use a <code>pipeline</code> object. A custom hierarchical cell typing pipeline could be created like this below, where</p>
<ul>
<li><code>markerslists</code> is a named list, with a <code>markerslist</code> for each stage of cell typing. “tmajor” will classify <code>cd8t</code> vs.&nbsp;<code>cd4t</code>, while “t8minor” and “t4minor” will subclassify those cell types respectively.</li>
<li><code>priors</code>, a list specifying ‘parent’ celltyping stage. Here , <code>t4minor</code> and <code>t8minor</code> both need to run after “tmajor”, as they will use the estimated probabilities of “<code>cd4t</code>” and “<code>cd8t</code>” as inputs.<br>
“tmajor” runs first, and does not have prior probability inputs.</li>
<li><code>priors_category</code>, a list specifying ‘parent’ / major categories of each celltype. Here , <code>t4minor</code> is a subset of <code>"cd4t"</code>. “tmajor” runs first, and does not have a prior.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1">pipeline_tcell <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb41-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_pipeline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">markerslists =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tmajor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_tcellmajor</span>
<span id="cb41-3">                    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t4minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd4tminor</span>
<span id="cb41-4">                    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t8minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd8tminor</span>
<span id="cb41-5">                    )</span>
<span id="cb41-6">                 ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t4minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tmajor"</span></span>
<span id="cb41-7">                               ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t8minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tmajor"</span>)</span>
<span id="cb41-8">                 ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors_category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t4minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4t"</span></span>
<span id="cb41-9">                                         ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t8minor"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8t"</span></span>
<span id="cb41-10">                                         )</span>
<span id="cb41-11">    )</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(pipeline_tcell)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list"     "pipeline"</code></pre>
</div>
</div>
<p>This particular pipeline is also saved as a package dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>pipeline_tcell, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.level=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ markerslists   :List of 3
  ..$ tmajor :List of 2
  .. ..- attr(*, "class")= chr [1:2] "list" "markerslist"
  ..$ t4minor:List of 7
  .. ..- attr(*, "class")= chr [1:2] "list" "markerslist"
  ..$ t8minor:List of 5
  .. ..- attr(*, "class")= chr [1:2] "list" "markerslist"
 $ priors         :List of 2
  ..$ t4minor: chr "tmajor"
  ..$ t8minor: chr "tmajor"
 $ priors_category:List of 2
  ..$ t4minor: chr "cd4t"
  ..$ t8minor: chr "cd8t"
 - attr(*, "class")= chr [1:2] "list" "pipeline"</code></pre>
</div>
</div>
<p>The code to run the pipeline is shown below. Additional arguments to be passed to <code>fit_metagene_scores</code> or <code>cluster_metagenes</code> functions can be passed as additional arguments to <code>run_pipeline()</code> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Run a 'tcell'-typing pipeline, which </span></span>
<span id="cb46-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### first classifies into T8/T4 categories (using the `tmajor` markerslist), </span></span>
<span id="cb46-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### then runs subclassification for T4 and T8 using the t4minor and t8minor markerslists.</span></span>
<span id="cb46-4">tcell_typing <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb46-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_pipeline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pipeline =</span> pipeline_tcell</span>
<span id="cb46-6">    ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[,tcell_ids])</span>
<span id="cb46-7">    ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as</span>(sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>graphs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>umapgrph</span>
<span id="cb46-8">                           ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CsparseMatrix"</span>)[tcell_ids,tcell_ids]</span>
<span id="cb46-9">    ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">celltype_call_threshold =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb46-10">    ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">return_all_columns_postprobs =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb46-11">    )</span></code></pre></div>
</div>
<p>We could take a look at individual <code>models</code> and <code>metagenes</code> objects if needed within our <code>tcell_typing</code> result. Below, we show that the outputted objects are the same in the pipeline format, as if we had ran them individually like in the method demonstration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all.equal</span>(model_t, tcell_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>models<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmajor)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all.equal</span>(metagenes_t, tcell_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>metagene_scores<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmajor)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>By default, two possible cell type classifications are returned in the overall <code>post_probs</code> data.table object from our pipeline. Below, <code>celltype_granular</code> shows the most granular classification for each cell, carrying the ‘best possible’ classification at each stage of the pipeline. For example, the first cell below was first identified as <code>cd8t</code> being the best category. The best subcategory of <code>cd8t</code> was <code>cd8_exhausted</code>, and the posterior probability score for <code>cd8t_exhausted</code> was ~0.47.</p>
<p>We set the the cutoff <code>celltype_call_threshold=0.5</code> when we ran the pipeline, so that the <code>celltype_thresh</code> classification shows the most granular cell type with probability scores <em>at least</em> this threshold. The first cell below has <code>cd8_exhausted</code> score ~0.47 (less than 0.5), and so takes the higher level category of <code>cd8t</code>, which is above the threshold at ~0.99999.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1">tcell_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tmajor"</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;cell_ID&gt;
        cell_ID celltype_thresh celltype_granular best_score_granular
         &lt;char&gt;          &lt;char&gt;            &lt;char&gt;               &lt;num&gt;
 1: c_1_12_1014            cd8t     cd8_exhausted           0.4691963
 2: c_1_12_1066            cd4t           cd4_th1           0.3352265
 3: c_1_12_1091         cd4_th2           cd4_th2           0.9683195
 4: c_1_12_1175   cd8_cytotoxic     cd8_cytotoxic           0.8777777
 5: c_1_12_1270         cd8_tem           cd8_tem           0.5882417
 6: c_1_12_1286        cd4_treg          cd4_treg           0.9909980
 7: c_1_12_1325            cd4t           cd4_tcm           0.4647576
 8: c_1_12_1346        cd4_treg          cd4_treg           0.8298557
 9: c_1_12_1349            cd8t           cd8_tem           0.3939835
10: c_1_12_1394   cd8_cytotoxic     cd8_cytotoxic           0.9587283
    best_score_thresh
                &lt;num&gt;
 1:         0.9999999
 2:         0.6751557
 3:         0.9683195
 4:         0.8777777
 5:         0.5882417
 6:         0.9909980
 7:         0.9984388
 8:         0.8298557
 9:         0.9999814
10:         0.9587283</code></pre>
</div>
</div>
<p>We can remake this table with a different cutoff in mind as needed, depending on how conservative / aggressive we are comfortable being with the cell type call, using the <code>combine_postprob_tables</code> function.</p>
<p>As demonstration, we can look at the output if we were to raise our threshold from 0.5 to 0.8.<br>
We can “<code>return_all_columns</code>” to show a more verbose result, with individual columns showing the joint probability scores for all possible cell type categories in each cell.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1">HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">combine_postprob_tables</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pipeline =</span> pipeline_tcell</span>
<span id="cb53-2">                                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">models =</span> tcell_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>models</span>
<span id="cb53-3">                                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">celltype_call_threshold =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span></span>
<span id="cb53-4">                                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">return_all_columns =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tmajor"</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>        cell_ID best_class_tmajor best_score_tmajor        cd8t         cd4t
         &lt;char&gt;            &lt;char&gt;             &lt;num&gt;       &lt;num&gt;        &lt;num&gt;
 1: c_1_12_1014              cd8t         0.9999999 0.999999904 9.619835e-08
 2: c_1_12_1066              cd4t         0.6751557 0.324844253 6.751557e-01
 3: c_1_12_1091              cd4t         0.9988244 0.001175604 9.988244e-01
 4: c_1_12_1175              cd8t         0.9999986 0.999998637 1.363123e-06
 5: c_1_12_1270              cd8t         0.9999989 0.999998939 1.060938e-06
 6: c_1_12_1286              cd4t         0.9981013 0.001898693 9.981013e-01
 7: c_1_12_1325              cd4t         0.9984388 0.001561222 9.984388e-01
 8: c_1_12_1346              cd4t         0.9982395 0.001760536 9.982395e-01
 9: c_1_12_1349              cd8t         0.9999814 0.999981384 1.861648e-05
10: c_1_12_1394              cd8t         1.0000000 0.999999986 1.438074e-08
    celltype_thresh celltype_granular best_score_granular best_score_thresh
             &lt;char&gt;            &lt;char&gt;               &lt;num&gt;             &lt;num&gt;
 1:            cd8t     cd8_exhausted           0.4691963         0.9999999
 2:          tmajor           cd4_th1           0.3352265         0.6751557
 3:         cd4_th2           cd4_th2           0.9683195         0.9683195
 4:   cd8_cytotoxic     cd8_cytotoxic           0.8777777         0.8777777
 5:            cd8t           cd8_tem           0.5882417         0.9999989
 6:        cd4_treg          cd4_treg           0.9909980         0.9909980
 7:            cd4t           cd4_tcm           0.4647576         0.9984388
 8:        cd4_treg          cd4_treg           0.8298557         0.8298557
 9:            cd8t           cd8_tem           0.3939835         0.9999814
10:   cd8_cytotoxic     cd8_cytotoxic           0.9587283         0.9587283
    best_class_t4minor best_score_t4minor    cd4_naive      cd4_tem
                &lt;char&gt;              &lt;num&gt;        &lt;num&gt;        &lt;num&gt;
 1:            cd4_tem       7.408648e-08 1.251116e-10 7.408648e-08
 2:            cd4_th1       3.352265e-01 7.836058e-05 2.443358e-01
 3:            cd4_th2       9.683195e-01 1.152001e-03 7.841427e-05
 4:           cd4_treg       1.262446e-06 3.588638e-09 1.405697e-11
 5:            cd4_th1       6.094740e-07 1.213471e-09 2.245479e-07
 6:           cd4_treg       9.909980e-01 1.289310e-06 8.622134e-08
 7:            cd4_tcm       4.647576e-01 1.677040e-01 1.226034e-02
 8:           cd4_treg       8.298557e-01 3.002300e-07 1.581774e-01
 9:           cd4_treg       1.092955e-05 4.486025e-09 8.873803e-09
10:           cd4_treg       6.985845e-09 1.273443e-10 5.957512e-09
         cd4_tcm      cd4_th1      cd4_th2     cd4_th17     cd4_treg
           &lt;num&gt;        &lt;num&gt;        &lt;num&gt;        &lt;num&gt;        &lt;num&gt;
 1: 1.195101e-11 2.129543e-08 4.029363e-15 7.197487e-13 6.786477e-10
 2: 1.867806e-04 3.352265e-01 6.040219e-03 1.158038e-02 7.770771e-02
 3: 1.148814e-02 9.695413e-03 9.683195e-01 2.286910e-11 8.090952e-03
 4: 5.892169e-10 6.060104e-08 3.049262e-08 5.391101e-09 1.262446e-06
 5: 9.412377e-10 6.094740e-07 7.486703e-10 1.940035e-07 3.000945e-08
 6: 1.653479e-08 1.018626e-08 7.094111e-03 7.843421e-06 9.909980e-01
 7: 4.647576e-01 7.313584e-04 2.508449e-01 9.533710e-02 6.803462e-03
 8: 1.020607e-02 6.923060e-14 1.491775e-13 6.882974e-12 8.298557e-01
 9: 6.009531e-08 8.601937e-07 6.614330e-06 1.389513e-07 1.092955e-05
10: 1.844918e-10 1.378047e-10 9.658852e-10 2.186144e-11 6.985845e-09
    best_class_t8minor best_score_t8minor    cd8_naive      cd8_tem
                &lt;char&gt;              &lt;num&gt;        &lt;num&gt;        &lt;num&gt;
 1:      cd8_exhausted       0.4691962886 6.011871e-05 1.860347e-01
 2:      cd8_cytotoxic       0.1649358419 3.833792e-06 1.311043e-01
 3:            cd8_tcm       0.0005912820 4.489162e-04 2.336174e-08
 4:      cd8_cytotoxic       0.8777776850 2.319425e-06 3.868444e-07
 5:            cd8_tem       0.5882416885 1.162076e-05 5.882417e-01
 6:      cd8_exhausted       0.0018765126 1.183680e-06 1.782040e-06
 7:          cd8_naive       0.0009770069 9.770069e-04 2.507600e-05
 8:      cd8_exhausted       0.0017514060 1.019562e-06 1.789781e-07
 9:            cd8_tem       0.3939834697 2.279564e-04 3.939835e-01
10:      cd8_cytotoxic       0.9587282579 5.255921e-06 3.696543e-02
         cd8_tcm cd8_cytotoxic cd8_exhausted
           &lt;num&gt;         &lt;num&gt;         &lt;num&gt;
 1: 2.514628e-12  3.447088e-01  4.691963e-01
 2: 1.210775e-11  1.649358e-01  2.880030e-02
 3: 5.912820e-04  1.352937e-04  8.823050e-08
 4: 9.247577e-09  8.777777e-01  1.222182e-01
 5: 1.619476e-14  2.342515e-01  1.774941e-01
 6: 1.656608e-07  1.904865e-05  1.876513e-03
 7: 3.768608e-04  5.270201e-05  1.295761e-04
 8: 1.001439e-07  7.830808e-06  1.751406e-03
 9: 1.169891e-06  2.354990e-01  3.702698e-01
10: 7.792592e-09  9.587283e-01  4.301033e-03</code></pre>
</div>
</div>
</section>
<section id="examining-and-validating-clustering-results" class="level3" data-number="5.2.5">
<h3 data-number="5.2.5" class="anchored" data-anchor-id="examining-and-validating-clustering-results"><span class="header-section-number">5.2.5</span> Examining and validating clustering results</h3>
<p>Now we can evaluate the cell typing performance. In particular, we want to check that the genes we specified as the index marker and predictors are in fact marker genes in the corresponding cell types.</p>
<p>First, we can look at a marker gene heatmap made with just the t-cells, and show the genes we specified as the most important ‘index genes’ for each of the <code>cd8t</code> and <code>cd4t</code> subtypes. Looking closely, we see that CD8A and CD8B are much higher in <code>cd8_</code> compared to <code>cd4_</code> types. Similarly, CD4 is higher expressed in <code>cd4_</code> subtypes compared to <code>cd8_</code> subtypes. Looking at the specific index markers for each subtype, we see good agreement between marker gene specified for each subtype reflected in our heatmap.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1">fct <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts =</span> sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts[,tcell_ids]</span>
<span id="cb55-2">                                      ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> tcell_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tmajor"</span>]]</span>
<span id="cb55-3">                                      ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_granular"</span>)</span>
<span id="cb55-4">idxs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd4tminor, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[["</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index_marker"</span>))</span>
<span id="cb55-5">               ,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd8tminor, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[["</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index_marker"</span>)))))</span>
<span id="cb55-6"></span>
<span id="cb55-7">nms <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4t"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd4tminor), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8t"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd8tminor))</span>
<span id="cb55-8">hmsubtype <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_heatmap</span>(fct, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">featsuse =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD4"</span>, idxs), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clusterorder =</span> nms, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">orient_diagonal =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb55-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(hmsubtype)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### The key index markers for cd4 subtypes</span></span>
<span id="cb56-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd4tminor, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[["</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index_marker"</span>)</span>
<span id="cb56-3"></span>
<span id="cb56-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### The key index markers for cd8 subtypes</span></span>
<span id="cb56-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_cd8tminor, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[["</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index_marker"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$cd4_naive
[1] "TCF7" "LEF1" "SELL" "CCR7"

$cd4_tem
[1] "CD44"  "CCR6"  "CXCR3" "IL7R" 

$cd4_tcm
[1] "CCR7" "IL7R" "SELL"

$cd4_th1
[1] "TBX21" "IFNG"  "CXCR3" "STAT4"

$cd4_th2
[1] "GATA3" "IL4"   "IL5"   "IL13"  "CCR4" 

$cd4_th17
[1] "RORC"  "IL17A" "IL17F" "IL23R"

$cd4_treg
[1] "FOXP3"    "IL2RA"    "CTLA4"    "TNFRSF18"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$cd8_naive
[1] "TCF7" "LEF1" "CCR7" "SELL" "IL7R"

$cd8_tem
[1] "GZMK"  "GZMA"  "CXCR3" "CD69"  "IL7R" 

$cd8_tcm
[1] "CCR7" "IL7R" "SELL"

$cd8_cytotoxic
[1] "GZMB"  "PRF1"  "GNLY"  "KLRD1" "IFNG" 

$cd8_exhausted
[1] "PDCD1"  "LAG3"   "TIGIT"  "HAVCR2" "TOX"   </code></pre>
</div>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/hm_tsubtype.png" alt="Wide Image"></p>
</div>
<p>Here we can attach our T-cell annotations back onto our metadata, and remake our marker heatmap.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1">met <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb59-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data), tcell_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tmajor"</span>]][,.(cell_ID, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">celltype =</span> celltype_granular, best_score_granular)]</span>
<span id="cb59-3">      ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">all.x=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb59-4">met[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(celltype),celltype<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span>clusters_unsup]</span>
<span id="cb59-5"></span>
<span id="cb59-6">fc_t_all <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb59-7">HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normed =</span> sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>data</span>
<span id="cb59-8">                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> met</span>
<span id="cb59-9">                   ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype"</span></span>
<span id="cb59-10">                   )</span>
<span id="cb59-11"></span>
<span id="cb59-12">hm_tcell <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_heatmap</span>(fc_t_all</span>
<span id="cb59-13">                           ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extras =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8B"</span>)</span>
<span id="cb59-14">                          )</span>
<span id="cb59-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(hm_tcell)</span></code></pre></div>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/hm_tcell_annotated.png" alt="Wide Image"></p>
</div>
<p>Treating the ‘posterior probability’ as a confidence that the cell belongs to the corresponding cluster, we can show that the proportion of cells that express the expected marker genes generally increases with higher confidence.</p>
<p>In the figure below, we compare the major <code>cd4t</code> and <code>cd8t</code> T cell types in terms of some of their marker genes which are specific to each. We see that CD8A and CD8B increase in <code>cd8t</code> cells as we gain confidence in the cell type call, along with other <code>cd8t</code> specific markers (GZMB, GNLY, PRF1).<br>
Similarly, we see that CD4 increases in <code>cd4t</code> calls with higher posterior probability scores, along with <code>cd4t</code> subtype-specific markers like FOXP3, CTLA4, TIGIT (<code>cd4_treg</code> marker genes), IL17A and IL17F (<code>cd4_th17</code> markers) and GATA3 (<code>cd4_th2</code> marker).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb60-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_threshold_plot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normed =</span> sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>data</span>
<span id="cb60-3">                      ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> tcell_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>models<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tmajor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs</span>
<span id="cb60-4">                      ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clusters =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4t"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8t"</span>)</span>
<span id="cb60-5">                      ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">markers =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL17A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL17F"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GATA3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FOXP3"</span>,  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IL2RA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CTLA4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TIGIT"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GNLY"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GZMB"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PRF1"</span>)</span>
<span id="cb60-6">                      ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">thresholds =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.995</span>)</span>
<span id="cb60-7">                      ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">score_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"best_score"</span></span>
<span id="cb60-8">                      ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"best_class"</span></span>
<span id="cb60-9">                      )</span>
<span id="cb60-10"></span>
<span id="cb60-11">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb60-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion of cells expressing marker gene increases with </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">posterior probability confidence scores"</span>)</span>
<span id="cb60-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(p)</span></code></pre></div>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/markerbarplot_tcells_major.png" alt="Wide Image"></p>
</div>
<p>Here’s another look at the pairsplot for our metagene scores,this time coloring the cells based on their classification.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metagene_pairsplot</span>(metagenes_t, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yhat"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obs =</span> model_t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs[,.(cell_ID, best_class)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colorvar =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"best_class"</span>)</span></code></pre></div>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/pairshat_colored.png" alt="Wide Image"></p>
</div>
</section>
</section>
</section>
<section id="ex2" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Example 2: Broad immune cell classification</h1>
<p>For the second example, we wish to ignore the unsupervised clustering and infer all cell types based entirely on the framework motivated here.</p>
<p>Using the full dataset, we can create a pipeline to first infer amongst 5 major cell type categories [<code>immune</code>, <code>epithelial</code>, <code>endothelial</code>, <code>fibroblast</code>, <code>plasma</code>] in a similar fashion as described in our first example.<br>
Then, we’ll infer subtypes of the immune cell labels with categories including [<code>tcell</code>,<code>bcell</code>,<code>macrophage</code>,<code>neutrophil</code>,<code>mast</code>,<code>monocyte</code>,<code>cDC</code>,<code>pDC</code>]. Finally, we’ll do some basic subclassification of the <code>tcells</code> into [<code>cd4t</code>,<code>cd8t</code>].</p>
<section id="tldr2" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="tldr2"><span class="header-section-number">6.1</span> ‘Just The Code’</h2>
<p>Here’s the code to produce the set of cell types. The next section will cover the details and discuss a few choices that were made.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### Pipeline, with </span></span>
<span id="cb62-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### level-1 ('l1') being major categorization </span></span>
<span id="cb62-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### level-2 ('l2') being classification of major immune cell categories</span></span>
<span id="cb62-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### level-t ('lt') being T8/T4 classification</span></span>
<span id="cb62-5"></span>
<span id="cb62-6">pipeline_io <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_pipeline</span>(</span>
<span id="cb62-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">markerslists =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l1"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_l1</span>
<span id="cb62-8">                      ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_immunemajor</span>
<span id="cb62-9">                      ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_tcellmajor)</span>
<span id="cb62-10">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span></span>
<span id="cb62-11">                 ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l1"</span>) </span>
<span id="cb62-12">  ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">priors_category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lt"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tcell"</span></span>
<span id="cb62-13">                          ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"immune"</span>)</span>
<span id="cb62-14">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### run my pipeline (using all cells)</span></span>
<span id="cb63-2">immune_typing <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb63-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_pipeline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pipeline =</span> pipeline_io</span>
<span id="cb63-4">             ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">counts_matrix =</span> Matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>counts)</span>
<span id="cb63-5">             ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjacency_matrix =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as</span>(sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>graphs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>umapgrph</span>
<span id="cb63-6">                                    ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CsparseMatrix"</span>)</span>
<span id="cb63-7">             ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">celltype_call_threshold =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb63-8">             ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">return_all_columns_postprobs =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb63-9">             )</span></code></pre></div>
</div>
</section>
<section id="evaluation" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="evaluation"><span class="header-section-number">6.2</span> Evaluation</h2>
<p>Like previously, this <code>pipeline</code>, and the corresponding <code>markerslists</code> are saved as package datasets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>pipeline_io,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.level=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ markerslists   :List of 3
  ..$ l1:List of 6
  .. ..$ epithelial   :List of 3
  .. .. ..$ index_marker                               : chr [1:4] "EPCAM" "KRT18" "KRT19" "CDH1"
  .. .. ..$ predictors                                 : chr [1:167] "EPCAM" "KRT18" "KRT8" "KRT19" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ endothelial  :List of 3
  .. .. ..$ index_marker                               : chr [1:3] "PECAM1" "VWF" "CDH5"
  .. .. ..$ predictors                                 : chr [1:129] "PECAM1" "VWF" "CDH5" "CLDN5" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ fibroblast   :List of 3
  .. .. ..$ index_marker                               : chr [1:3] "COL1A1" "DCN" "PDGFRA"
  .. .. ..$ predictors                                 : chr [1:131] "COL1A2" "VIM" "S100A4" "PDGFRB" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ plasma       :List of 3
  .. .. ..$ index_marker                               : chr [1:5] "IGHG1" "IGHG1/2" "IGHA1" "MZB1" ...
  .. .. ..$ predictors                                 : chr [1:29] "IGHG1" "IGHG1/2" "IGHA1" "MZB1" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ immune       :List of 3
  .. .. ..$ index_marker                               : chr [1:6] "PTPRC" "ITGB2" "SPI1" "CD52" ...
  .. .. ..$ predictors                                 : chr [1:142] "PTPRC" "CD3E" "CD3D" "CD4" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ smooth_muscle:List of 3
  .. .. ..$ index_marker                               : chr [1:4] "MYH11" "ACTA2" "TAGLN" "DES"
  .. .. ..$ predictors                                 : chr [1:64] "MYH11" "ACTA2" "TAGLN" "DES" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..- attr(*, "class")= chr [1:2] "list" "markerslist"
  ..$ l2:List of 7
  .. ..$ tcell     :List of 3
  .. .. ..$ index_marker                               : chr [1:6] "CD3D" "CD3G" "CD3E" "IL7R" ...
  .. .. ..$ predictors                                 : chr [1:117] "CD3D" "CD3E" "CD3G" "CD8A" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ bcell     :List of 3
  .. .. ..$ index_marker                               : chr [1:4] "CD19" "MS4A1" "CD79A" "CD79B"
  .. .. ..$ predictors                                 : chr [1:84] "CD19" "MS4A1" "CD79A" "CD79B" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ macrophage:List of 3
  .. .. ..$ index_marker                               : chr [1:4] "CD163" "CD68" "MARCO" "CSF1R"
  .. .. ..$ predictors                                 : chr [1:100] "CD68" "CD163" "MARCO" "CSF1R" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ neutrophil:List of 3
  .. .. ..$ index_marker                               : chr [1:4] "MPO" "FCGR3B" "S100A8" "S100A9"
  .. .. ..$ predictors                                 : chr [1:100] "MPO" "FCGR3B" "S100A8" "S100A9" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ mast      :List of 3
  .. .. ..$ index_marker                               : chr [1:5] "KIT" "TPSAB1" "TPSB2" "TPSAB1/2" ...
  .. .. ..$ predictors                                 : chr [1:92] "KIT" "TPSAB1" "CPA3" "TPSB2" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ monocyte  :List of 3
  .. .. ..$ index_marker                               : chr [1:4] "CD14" "FCGR3A" "CCR2" "LYZ"
  .. .. ..$ predictors                                 : chr [1:130] "CD14" "FCGR3A" "CCR2" "LYZ" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ dendritic :List of 3
  .. .. ..$ index_marker                               : chr [1:5] "ITGAX" "CLEC9A" "FLT3" "XCR1" ...
  .. .. ..$ predictors                                 : chr [1:103] "ITGAX" "CLEC9A" "FLT3" "XCR1" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..- attr(*, "class")= chr [1:2] "list" "markerslist"
  ..$ lt:List of 2
  .. ..$ cd8t:List of 3
  .. .. ..$ index_marker                               : chr [1:2] "CD8B" "CD8A"
  .. .. ..$ predictors                                 : chr [1:48] "CD3D" "CD3E" "CD3G" "CD8A" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..$ cd4t:List of 3
  .. .. ..$ index_marker                               : chr "CD4"
  .. .. ..$ predictors                                 : chr [1:48] "CD3D" "CD3E" "CD3G" "CD4" ...
  .. .. ..$ use_offclass_markers_as_negative_predictors: logi TRUE
  .. ..- attr(*, "class")= chr [1:2] "list" "markerslist"
 $ priors         :List of 2
  ..$ lt: chr "l2"
  ..$ l2: chr "l1"
 $ priors_category:List of 2
  ..$ lt: chr "tcell"
  ..$ l2: chr "immune"
 - attr(*, "class")= chr [1:2] "list" "pipeline"</code></pre>
</div>
</div>
<p>We can look at a heatmap showing the marker genes for our cell types to check whether the algorithm produced sensible results. Because I have a lot of cell type categories, and some of them are not totally exclusive (for example, macrophage/monocyte are very similar and share many markers), I don’t necessarily expect all my cells to have very high confidence scores for every cell type; I’m okay here with taking the most granular cell type calls and running with them.</p>
<p>These clusters show more granularity in a first pass than my original set of unsupervised clusters. The heatmap below also shows very sane-looking results, with marker genes corresponding to many of the genes I specified in <code>markerslists</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1">fc_l1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb66-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clusterwise_foldchange_metrics</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normed =</span> sem[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>data</span>
<span id="cb66-3">                     ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span>immune_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb66-4">                     ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_granular"</span></span>
<span id="cb66-5">  )</span>
<span id="cb66-6">hm_l1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">marker_heatmap</span>(fc_l1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">extras =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD3D"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CD8B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FOXP3"</span>))</span>
<span id="cb66-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(hm_l1)</span></code></pre></div>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/hm_l1.png" alt="Wide Image"></p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>markerslist_immunemajor, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[["</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index_marker"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$tcell
[1] "CD3D"  "CD3G"  "CD3E"  "IL7R"  "TRBC1" "CD2"  

$bcell
[1] "CD19"  "MS4A1" "CD79A" "CD79B"

$macrophage
[1] "CD163" "CD68"  "MARCO" "CSF1R"

$neutrophil
[1] "MPO"    "FCGR3B" "S100A8" "S100A9"

$mast
[1] "KIT"      "TPSAB1"   "TPSB2"    "TPSAB1/2" "CPA3"    

$monocyte
[1] "CD14"   "FCGR3A" "CCR2"   "LYZ"   

$dendritic
[1] "ITGAX"  "CLEC9A" "FLT3"   "XCR1"   "CD1C"  </code></pre>
</div>
</div>
<p>Here’s a spatial plot of the cell types we’ve called so far. We could stop here, or continue in the same manner for subclassifying any other cell types.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1">met <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.table</span>(sem<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>meta.data)</span>
<span id="cb69-2">             ,immune_typing<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>post_probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>l1[,.(cell_ID, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">celltype_supervised =</span> celltype_granular)]</span>
<span id="cb69-3">             ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_ID"</span>)</span>
<span id="cb69-4"></span>
<span id="cb69-5">colorpal <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#F0A0FF'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#E0FF66'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#C20088'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#00998F'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#426600'</span></span>
<span id="cb69-6">              , <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#4C005C"</span> </span>
<span id="cb69-7">              ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#191919'</span></span>
<span id="cb69-8">              ,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#003380'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#005C31'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#94FFB5'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#990000'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#0075DC'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#FFA405'</span>)</span>
<span id="cb69-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(colorpal) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(met[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_supervised"</span>]]))</span>
<span id="cb69-10"></span>
<span id="cb69-11">xyplist_sup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb69-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span>(met, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"portion"</span>), <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(xx){</span>
<span id="cb69-13">    HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xyplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_supervised"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> xx</span>
<span id="cb69-14">                       , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ptsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cls =</span> colorpal</span>
<span id="cb69-15">                       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#,clusters = c("cd4t", "cd8t", "bcell")</span></span>
<span id="cb69-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#                       , ptsize = 0.01, cls = colorpal</span></span>
<span id="cb69-17">                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plotfirst =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"epithelial"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endothelial"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fibroblast"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"smooth_muscle"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plasma"</span>)</span>
<span id="cb69-18">                       ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>()</span>
<span id="cb69-19">  })  </span>
<span id="cb69-20">xyplot_sup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb69-21">cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_grid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plotlist =</span> xyplist_sup,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb69-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb69-23">  cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">remove=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span>
<span id="cb69-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(xyplot_sup)</span></code></pre></div>
</details>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/xyplot_sup.png" alt="Wide Image"></p>
</div>
<p>Below, we notice several interesting things about the spatial distribution of <code>cd8t</code>, <code>cd4t</code>, and <code>bcell</code> types. The <code>cd4t</code> cells tend to show higher colocalization with <code>bcell</code>s in tertiary lymphoid type structures, while <code>cd8t</code> spatial distribution are more dispersed throughout the tissue. This reflects the role of <code>cd8t</code> cells in seeking out and killing tumor cells, compared to the role of <code>cd4t</code> cells in local antigen presentation.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1">xyplist_lymph <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb70-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span>(met, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"portion"</span>), <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(xx){</span>
<span id="cb70-3">    HieraType<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xyplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_column =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"celltype_supervised"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metadata =</span> xx</span>
<span id="cb70-4">                       , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ptsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cls =</span> colorpal</span>
<span id="cb70-5">                       ,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clusters =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd4t"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cd8t"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bcell"</span>)</span>
<span id="cb70-6">                       ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>()</span>
<span id="cb70-7">  })</span>
<span id="cb70-8"></span>
<span id="cb70-9">lymphplot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb70-10">cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_grid</span>(</span>
<span id="cb70-11">xyplist_lymph[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb70-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>celltype_supervised) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ggdark<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dark_theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>))</span>
<span id="cb70-13">,xyplist_lymph[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb70-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>celltype_supervised) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ggdark<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dark_theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>))</span>
<span id="cb70-15">,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb70-16">,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rel_heights  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb70-17">)  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb70-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb70-19">  cowplot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">panel_border</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">remove=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span>
<span id="cb70-20"></span>
<span id="cb70-21"></span>
<span id="cb70-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(lymphplot)</span></code></pre></div>
</details>
</div>
<div class="wider-image">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/lymphxyplot.png" alt="Wide Image"></p>
</div>
</section>
</section>
<section id="conclusion" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Conclusion</h1>
<p>We’ve discussed a method for cell typing that uses predefined sets of marker genes to build cell type specific metagene scores, which are probabilistically clustered into cell types.</p>
<p>Using a predefined set of marker genes has several advantages. For one, this allows users to prespecify the network of genes which are expected to have positive covariance within the cell type, and restricts any undesired influence of non-informative or noisy genes. Because no assumption is made regarding the average expression or level of covariance between any pair of genes, we suspect that in some cases this approach may be more flexible and robust in the presence of batch effects or platform effects compared to using pre-trained models, data transfer, or reference profiles which may have been trained using different sample conditions or technologies.</p>
<p>The NNLS regression framework for estimating celltype metagenes allows for improved prediction power by incorporating information from similar cells through an adjacency network. By restricting the direction of the regression coefficients, we’ve implicitly imposed an assumption of positive covariance between these markers within the corresponding cell type class. Sign constraints have been shown to be as effective in some cases as explicit regularization <span class="citation" data-cites="nnlsref">(Slawski and Hein 2013)</span>.</p>
<p>We use a mixture of overfitted multivariate gaussian mixture models for probabilistic cell type classification. This approach is effectively a non-parametric mixture model, where we assume that the distribution of metagene scores for each cell type can be approximated by a ‘large-enough’ mixture of multivariate gaussians <span class="citation" data-cites="aragam2020identifiability">(Aragam et al. 2020)</span>. The simple selection of anchor cells based on score positivity, and ability to fine tune cell typing by controlling behavior of double positivity should allow for easy user control and flexibility.</p>
<p>While we envision the method to be useful for many cell typing applications, there are several caveats and limitations users should keep in mind. One primary assumption is that the user has a sense of the tissue type they are working with and the cell types that are likely to be present. If the user were to run a “tcell typing pipeline” on myeloid cells, they may see unexpected or poor results. Similarly, the “io pipeline” we used in Example 2, may not perform well in a very different tissue type, like brain for example. If we wanted to apply this method to a tissue type like ‘brain’, we may need to generate a new pipeline, with <code>markerslists</code> for brain specific cell types like <code>neurons</code> and <code>oligodendrocytes</code>. For cases where a major cell type exists in a dataset but does not have a <code>markerslists</code> to be modeled, that cell type could manifest as cells which have “low posterior probability” for all of the other cell type classes included in the pipeline.</p>
<p>There are several future improvements for this method we plan to work on. Simultaneous estimation of metagene scores and clustering (perhaps through a regression-based mixture model) might enhance the power of metagene scores and classification by optimizing the cell allocations to the correct cluster simultaneously during model-fitting. Exploring other frameworks outside of NNLS regression could potentially capture more flexible model structures with interaction and non-linearity.<br>
The ability or freedom to learn additional marker genes from the data, and an extension to a semi-supervised framework where cell types where marker genes are unknown a priori would also be useful.</p>
<p>We’ve implemented the tools presented here in the R package <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/HieraType">HieraType</a>.</p>
</section>
<section id="quick-summary-of-package-functions-used-in-this-post" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Quick summary of package functions used in this post</h1>
<p>Below we call out a short list of <code>HieraType</code> package functions which were used throughout this post. Please see the examples throughout the rest of this document for more context on their usage.</p>
<p><em>Model Fitting and Clustering</em></p>
<ul>
<li><p><code>make_markerlist()</code> - Used to create a custom list of cell type markers.</p></li>
<li><p><code>make_pipeline()</code> - Used to create a pipeline, or recipe for hierarchical cell typing.</p></li>
<li><p><code>run_pipeline()</code> - Used to run a hierarchical cell typing pipeline.</p></li>
<li><p><code>fit_metagene_scores()</code> - This function fits cell type metagene scores. Called as a standalone function or automatically within <code>run_pipeline</code>,</p></li>
<li><p><code>cluster_metagenes()</code> - This function clusters cell type metagene scores using overfitted-gaussian mixture models. Also called within <code>run_pipeline</code>.</p></li>
</ul>
<p><em>Plotting and Diagnostics</em></p>
<ul>
<li><p><code>xyplot()</code> - A utility function for plotting cell types in x/y space.</p></li>
<li><p><code>metagene_pairsplot()</code> - Plot pairwise distributions of metagene scores.</p></li>
<li><p><code>metagene_coefficients_plot()</code> - Plot for which genes contribute most to cell type metagene scores.</p></li>
<li><p><code>marker_threshold_plot()</code> - Model diagnostics plot, show specific marker genes and the proportion of cells that express them by cluster, for increasing posterior probability thresholds.</p></li>
<li><p><code>clusterwise_foldchange_metrics()</code> - Computes the fold change, average expression, proportion of cells with at least 1 count for each gene and each cluster. This is the data used as input to a marker gene heatmap.</p></li>
<li><p><code>marker_heatmap()</code> - Makes a bubble-style heatmap plot (clusters x marker genes) showing the proportion of cells with at least one count (bubble size) and relative average expression (bubble color). Easy to add and control the genes shown in the heatmap, and can specify a fixed order for comparing multiple heatmaps.</p></li>
</ul>


<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-aragam2020identifiability" class="csl-entry">
Aragam, Bryon, Chen Dan, Eric P. Xing, and Pradeep Ravikumar. 2020. <span>“<span class="nocase">Identifiability of nonparametric mixture models and Bayes optimal clustering</span>.”</span> <em>The Annals of Statistics</em> 48 (4): 2277–2302. <a href="https://doi.org/10.1214/19-AOS1887">https://doi.org/10.1214/19-AOS1887</a>.
</div>
<div id="ref-nonnegpca" class="csl-entry">
Sigg, Christian D., and Joachim M. Buhmann. 2008. <span>“Expectation-Maximization for Sparse and Non-Negative PCA.”</span> In <em>Proceedings of the 25th International Conference on Machine Learning</em>, 960–67. ICML ’08. New York, NY, USA: Association for Computing Machinery. <a href="https://doi.org/10.1145/1390156.1390277">https://doi.org/10.1145/1390156.1390277</a>.
</div>
<div id="ref-nnlsref" class="csl-entry">
Slawski, Martin, and Matthias Hein. 2013. <span>“<span class="nocase">Non-negative least squares for high-dimensional linear models: Consistency and sparse recovery without regularization</span>.”</span> <em>Electronic Journal of Statistics</em> 7 (none): 3004–56. <a href="https://doi.org/10.1214/13-EJS868">https://doi.org/10.1214/13-EJS868</a>.
</div>
</div></section></div> ]]></description>
  <category>cell typing</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/</guid>
  <pubDate>Fri, 20 Jun 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/immune-cell-typing-smooth/figures/hm_tsubtype.png" medium="image" type="image/png" height="56" width="144"/>
</item>
<item>
  <title>smiDE: an open-source package for differential expression analysis with spatially correlated data</title>
  <dc:creator>Dan McGuire</dc:creator>
  <link>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/</link>
  <description><![CDATA[ 





<section id="differential-expression-analysis-with-spatially-correlated-data" class="level1">
<h1>Differential Expression Analysis With Spatially Correlated Data</h1>
<p>Spatially-resolved transcriptomic (SRT) data offers unprecedented insights into gene expression patterns, but analyzing this data requires specialized approaches. Traditional differential expression (DE) methods often falter when applied to spatially correlated data, leading to unreliable results and significant rates of false discovery. To address this challenge, <span class="citation" data-cites="Vasconcelos2024">(Vasconcelos et al. 2024)</span> present a comprehensive analysis of DE methodologies in their preprint, <a href="https://www.biorxiv.org/content/10.1101/2024.08.02.606405v1.full" target="_blank">“Differential Expression Analysis for Spatially Correlated Data”</a> . This work systematically evaluates the performance of various modeling strategies, providing clear recommendations for researchers.</p>
<p>The rest of this post aims to summarize some of the key findings from the paper and provide practical guidance on how to conduct robust DE analysis with spatial data. The accompanying <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/smiDE" target="_blank">smiDE</a> R package offers readily accessible tools for implementing these recommendations.</p>
<section id="opportunities" class="level2">
<h2 class="anchored" data-anchor-id="opportunities">Opportunities</h2>
<p>While DE analysis has long been a core component of gene expression studies, SRT data presents new opportunities for addressing fundamental questions regarding how cells respond to their local environment and interact with other cell types.</p>
<p>As a motivating example, suppose I have annotated cell type and spatial context in my dataset; I might be broadly interested in T cells, cancer cells, and how they behave within different spatial contexts.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/figures/fig1_ab.PNG" class="img-fluid figure-img" width="506"></p>
</figure>
</div>
</div>
</div>
<p>Tons of interesting questions along these lines can be phrased as DE problems, for example</p>
<ul>
<li>How does the expression of genes in T cells differ when located in stroma vs.&nbsp;tumor bed? (Left panel, blue vs.&nbsp;purple points)</li>
<li>How does expression of genes in cancer cells in the tumor bed differ based on distance to the nearest T-cell? (middle panel, cancer cells with arrow drawn to nearest T cell and colored by distance)</li>
<li>How is gene expression for T-cells in stroma modulated by distance to the tumor bed? (Right panel, rings highlight benchmarks of “distance from tumor bed”)</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/figures/fig1_thumbnail.PNG" class="img-fluid figure-img" width="790"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="unique-challenges-for-de-analyis-with-srt-data" class="level2">
<h2 class="anchored" data-anchor-id="unique-challenges-for-de-analyis-with-srt-data">Unique challenges for DE analyis with SRT data</h2>
<p>While the types of questions we can tackle with DE are limitless, there are unique challenges associated with SRT technologies that can lead to false discoveries when not properly addressed.</p>
<p>Two primary issues include:</p>
<ul>
<li>segmentation errors<br>
</li>
<li>unmodeled auto-correlation in expression amongst spatially neighboring cells</li>
</ul>
<p>Below, we’ll give a very brief overview of how these problems can lead to biased effects estimates and incorrect inferences in DE.</p>
<section id="segmentation-error" class="level4">
<h4 class="anchored" data-anchor-id="segmentation-error">Segmentation error</h4>
<p>Even minor segmentation errors can distort DE results if the analysis doesn’t properly account for them. For example, suppose I want to analyze the behavior of macrophage cells, and how gene expression differs for macrophages in tumor-infiltrated regions of tissue.</p>
<p>The picture below shows KRT17 transcripts from neighboring epithelial (cancer) cells falsely assigned to the macrophage cell inside a tumor region.</p>
<p>A naiive DE analysis may identify KRT17 as DE in the tumor, while an experienced bioinformatician may immediately recognize that this gene should not be expressed in the macrophage cell type at all (the very presence of the gene would challenge the cell type identity).</p>
<!-- The picture below shows KRT17 transcripts from neighboring epithelial cells falsely assigned to the <span style="color: DeepPink;"> macrophage cell </span>inside a tumor region. -->
<p>The picture below shows KRT17 transcripts from neighboring cancer cells falsely assigned to the macrophage cell inside a tumor region.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/figures/napari_contam_example.png" class="img-fluid figure-img" width="1102"></p>
</figure>
</div>
</div>
</div>
<p>Even if the number of falsely assigned transcripts is small, these errors are correlated with our DE question in a way that confounds the analysis. Namely, the false positive KRT17 transcripts are more likely than not to occur in tumor regions compared to elsewhere because they come from the cancer cells!</p>
<p>We could describe this dilemma for a DE analysis through a directed-acyclic graph, where the neighboring KRT17 expression in cancer cells acts as a confounder.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/figures/contam_example_dag.png" class="img-fluid figure-img" width="250"></p>
</figure>
</div>
</div>
</div>
<p>In the paper, we propose two approaches to deal with this issue.</p>
<ol type="1">
<li><p>A ‘overlapping cells metric’: Used to identify genes which may be expressed within specific cell types due primarily due to overlapping cells / segmentation errors , and exclude them from cell-type specific DE analysis. The metric computes the average expression in “macrophage cells”, and the average expression in <em>spatial neighbors</em> of macrophage cells among all non-macrophage cell types. The ratio of these two average expression vectors is a quick and useful way to discard implausible genes.</p></li>
<li><p>Covariate adjustment: We can compute the total expression of ‘KRT17’ in the spatial neighbors of macrophage cells among all non-macrophage neighbors, and include this as a control variable in the regression model.</p></li>
</ol>
<p>Below is a side-by-side summary of volcano plots before and after implementing these approaches, where genes are colored by their plausible cell type annotation from the Human Protein Atlas, and marked by whether or not the gene passes the overlapping cells metric.</p>
<p>On the left, a number of implausible brown genes which should be “Not detected in immune cells” are falsely identified as being upregulated in macrophages in the tumor region. Nearly all of these genes could be pre-filtered before DE is conducted, by nature of “failing the filter” metric.<br>
On the right-hand side, we see the significance and fold change for a large number of genes is largely attenuated if we employ the covariate-adjustment approach; controlling for expression in neighboring cells of other cell types.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/figures/contamination_volcano.png" class="img-fluid figure-img" width="1452"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="spatial-correlation" class="level4">
<h4 class="anchored" data-anchor-id="spatial-correlation">Spatial Correlation</h4>
<p>Spatial auto-correlation is another way in which gene expression could inflate statistical significance in DE. Intuitively, neighboring cells may have more similar gene expression profiles compared to cells located at greater distances, due to factors which may be unrelated to our covariate of interest. A solution we propose is to include a spatially correlated random effect (SRE) in the DE model, which can account for the un-modeled spatial correlations in expression.</p>
<p>For example, suppose I am working with a colon-cancer dataset, and am interested in researching how gene expression changes in B cells as they approach the center of tertiary lymphoid structures.</p>
<p>I may count the number of immune cells neighboring the B-cells as a continuous measurement of how close the B cell is to the center of the TLS.</p>
<p>Below, the left hand plot highlights two densely packed clusters of B cells in TLS regions, and on the right, these B cells are annotated by the covariate (# of immune cell neighbors).</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/figures/colon_cancer_sre.png" class="img-fluid figure-img" width="1888"></p>
</figure>
</div>
</div>
</div>
<p>Below, we show how inference can change from a naiive DE analysis (left), to a ‘segmentation-aware’ analysis (middle), to a DE analysis which also includes the spatial random effect (right). The model with SRE identifies a set of 9 high-confidence DE genes with up-regulated expression in TLS interior, down from 141 DE genes identified through the naiive approach.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/figures/colon_cancer_volcanos.png" class="img-fluid figure-img" width="1976"></p>
</figure>
</div>
</div>
</div>
<p>The ability to visually assess the behavior of the random effects can provide further context for the analysis. For example, CD79A retains significance in the SRE model, showing several concentrated regions of high expression captured by the random effect. For WNT7A, numerous small regions of autocorrelated expression reduce the significance of the gene when taken into context of the model.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/figures/visual_sre.png" class="img-fluid figure-img" width="1444"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>Here we’ve discussed opportunities for DE analysis with SRT datasets, along with unique challenges this data type poses. All of the analysis tools described here are implemented in the <a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/smiDE" target="_blank">smiDE R package</a>, with syntax examples and vignettes which can be found on the github page. We hope the reader will also check out the <a href="https://www.biorxiv.org/content/10.1101/2024.08.02.606405v1.full" target="_blank">preprint</a> for more thorough detail on the our study of DE with spatially correlated data.</p>
</section>
<section id="resources" class="level1">
<h1>Resources</h1>
<ul>
<li><a href="https://www.biorxiv.org/content/10.1101/2024.08.02.606405v1.full" target="_blank">preprint</a></li>
<li><a href="https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/smiDE" target="_blank">smiDE R package</a></li>
</ul>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-Vasconcelos2024" class="csl-entry">
Vasconcelos, Ana Gabriela, Daniel McGuire, Noah Simon, Patrick Danaher, and Ali Shojaie. 2024. <span>“Differential Expression Analysis for Spatially Correlated Data.”</span> <em>bioRxiv</em>. <a href="https://doi.org/10.1101/2024.08.02.606405">https://doi.org/10.1101/2024.08.02.606405</a>.
</div>
</div></section></div> ]]></description>
  <category>differential expression</category>
  <category>DE</category>
  <guid>https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/</guid>
  <pubDate>Wed, 21 May 2025 00:00:00 GMT</pubDate>
  <media:content url="https://nanostring-biostats.github.io/CosMx-Analysis-Scratch-Space/posts/smiDE/figures/fig1_thumbnail.PNG" medium="image"/>
</item>
</channel>
</rss>
